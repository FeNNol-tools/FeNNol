<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 14.4.0"/>
    <title>fennol.models.preprocessing API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../models.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;fennol.models</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#GraphGenerator">GraphGenerator</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#GraphGenerator.__init__">GraphGenerator</a>
                        </li>
                        <li>
                                <a class="variable" href="#GraphGenerator.cutoff">cutoff</a>
                        </li>
                        <li>
                                <a class="variable" href="#GraphGenerator.graph_key">graph_key</a>
                        </li>
                        <li>
                                <a class="variable" href="#GraphGenerator.switch_params">switch_params</a>
                        </li>
                        <li>
                                <a class="variable" href="#GraphGenerator.kmax">kmax</a>
                        </li>
                        <li>
                                <a class="variable" href="#GraphGenerator.kthr">kthr</a>
                        </li>
                        <li>
                                <a class="variable" href="#GraphGenerator.k_space">k_space</a>
                        </li>
                        <li>
                                <a class="variable" href="#GraphGenerator.mult_size">mult_size</a>
                        </li>
                        <li>
                                <a class="function" href="#GraphGenerator.init">init</a>
                        </li>
                        <li>
                                <a class="function" href="#GraphGenerator.get_processor">get_processor</a>
                        </li>
                        <li>
                                <a class="function" href="#GraphGenerator.get_graph_properties">get_graph_properties</a>
                        </li>
                        <li>
                                <a class="function" href="#GraphGenerator.check_reallocate">check_reallocate</a>
                        </li>
                        <li>
                                <a class="function" href="#GraphGenerator.process">process</a>
                        </li>
                        <li>
                                <a class="function" href="#GraphGenerator.update_skin">update_skin</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#GraphProcessor">GraphProcessor</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#GraphProcessor.__init__">GraphProcessor</a>
                        </li>
                        <li>
                                <a class="variable" href="#GraphProcessor.cutoff">cutoff</a>
                        </li>
                        <li>
                                <a class="variable" href="#GraphProcessor.graph_key">graph_key</a>
                        </li>
                        <li>
                                <a class="variable" href="#GraphProcessor.switch_params">switch_params</a>
                        </li>
                        <li>
                                <a class="variable" href="#GraphProcessor.parent">parent</a>
                        </li>
                        <li>
                                <a class="variable" href="#GraphProcessor.name">name</a>
                        </li>
                        <li>
                                <a class="variable" href="#GraphProcessor.scope">scope</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#GraphFilter">GraphFilter</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#GraphFilter.__init__">GraphFilter</a>
                        </li>
                        <li>
                                <a class="variable" href="#GraphFilter.cutoff">cutoff</a>
                        </li>
                        <li>
                                <a class="variable" href="#GraphFilter.parent_graph">parent_graph</a>
                        </li>
                        <li>
                                <a class="variable" href="#GraphFilter.graph_key">graph_key</a>
                        </li>
                        <li>
                                <a class="variable" href="#GraphFilter.remove_hydrogens">remove_hydrogens</a>
                        </li>
                        <li>
                                <a class="variable" href="#GraphFilter.switch_params">switch_params</a>
                        </li>
                        <li>
                                <a class="variable" href="#GraphFilter.k_space">k_space</a>
                        </li>
                        <li>
                                <a class="variable" href="#GraphFilter.kmax">kmax</a>
                        </li>
                        <li>
                                <a class="variable" href="#GraphFilter.kthr">kthr</a>
                        </li>
                        <li>
                                <a class="variable" href="#GraphFilter.mult_size">mult_size</a>
                        </li>
                        <li>
                                <a class="function" href="#GraphFilter.init">init</a>
                        </li>
                        <li>
                                <a class="function" href="#GraphFilter.get_processor">get_processor</a>
                        </li>
                        <li>
                                <a class="function" href="#GraphFilter.get_graph_properties">get_graph_properties</a>
                        </li>
                        <li>
                                <a class="function" href="#GraphFilter.check_reallocate">check_reallocate</a>
                        </li>
                        <li>
                                <a class="function" href="#GraphFilter.process">process</a>
                        </li>
                        <li>
                                <a class="function" href="#GraphFilter.update_skin">update_skin</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#GraphFilterProcessor">GraphFilterProcessor</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#GraphFilterProcessor.__init__">GraphFilterProcessor</a>
                        </li>
                        <li>
                                <a class="variable" href="#GraphFilterProcessor.cutoff">cutoff</a>
                        </li>
                        <li>
                                <a class="variable" href="#GraphFilterProcessor.graph_key">graph_key</a>
                        </li>
                        <li>
                                <a class="variable" href="#GraphFilterProcessor.parent_graph">parent_graph</a>
                        </li>
                        <li>
                                <a class="variable" href="#GraphFilterProcessor.switch_params">switch_params</a>
                        </li>
                        <li>
                                <a class="variable" href="#GraphFilterProcessor.parent">parent</a>
                        </li>
                        <li>
                                <a class="variable" href="#GraphFilterProcessor.name">name</a>
                        </li>
                        <li>
                                <a class="variable" href="#GraphFilterProcessor.scope">scope</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#GraphAngularExtension">GraphAngularExtension</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#GraphAngularExtension.__init__">GraphAngularExtension</a>
                        </li>
                        <li>
                                <a class="variable" href="#GraphAngularExtension.mult_size">mult_size</a>
                        </li>
                        <li>
                                <a class="variable" href="#GraphAngularExtension.add_neigh">add_neigh</a>
                        </li>
                        <li>
                                <a class="variable" href="#GraphAngularExtension.graph_key">graph_key</a>
                        </li>
                        <li>
                                <a class="function" href="#GraphAngularExtension.init">init</a>
                        </li>
                        <li>
                                <a class="function" href="#GraphAngularExtension.get_processor">get_processor</a>
                        </li>
                        <li>
                                <a class="function" href="#GraphAngularExtension.get_graph_properties">get_graph_properties</a>
                        </li>
                        <li>
                                <a class="function" href="#GraphAngularExtension.check_reallocate">check_reallocate</a>
                        </li>
                        <li>
                                <a class="function" href="#GraphAngularExtension.process">process</a>
                        </li>
                        <li>
                                <a class="function" href="#GraphAngularExtension.update_skin">update_skin</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#GraphAngleProcessor">GraphAngleProcessor</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#GraphAngleProcessor.__init__">GraphAngleProcessor</a>
                        </li>
                        <li>
                                <a class="variable" href="#GraphAngleProcessor.graph_key">graph_key</a>
                        </li>
                        <li>
                                <a class="variable" href="#GraphAngleProcessor.parent">parent</a>
                        </li>
                        <li>
                                <a class="variable" href="#GraphAngleProcessor.name">name</a>
                        </li>
                        <li>
                                <a class="variable" href="#GraphAngleProcessor.scope">scope</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#SpeciesIndexer">SpeciesIndexer</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#SpeciesIndexer.__init__">SpeciesIndexer</a>
                        </li>
                        <li>
                                <a class="variable" href="#SpeciesIndexer.output_key">output_key</a>
                        </li>
                        <li>
                                <a class="variable" href="#SpeciesIndexer.species_order">species_order</a>
                        </li>
                        <li>
                                <a class="variable" href="#SpeciesIndexer.add_atoms">add_atoms</a>
                        </li>
                        <li>
                                <a class="function" href="#SpeciesIndexer.init">init</a>
                        </li>
                        <li>
                                <a class="function" href="#SpeciesIndexer.check_reallocate">check_reallocate</a>
                        </li>
                        <li>
                                <a class="function" href="#SpeciesIndexer.process">process</a>
                        </li>
                        <li>
                                <a class="function" href="#SpeciesIndexer.update_skin">update_skin</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#AtomPadding">AtomPadding</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#AtomPadding.__init__">AtomPadding</a>
                        </li>
                        <li>
                                <a class="variable" href="#AtomPadding.mult_size">mult_size</a>
                        </li>
                        <li>
                                <a class="function" href="#AtomPadding.init">init</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="function" href="#atom_unpadding">atom_unpadding</a>
            </li>
            <li>
                    <a class="function" href="#check_input">check_input</a>
            </li>
            <li>
                    <a class="function" href="#convert_to_jax">convert_to_jax</a>
            </li>
            <li>
                    <a class="class" href="#JaxConverter">JaxConverter</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#JaxConverter.__init__">JaxConverter</a>
                        </li>
                        <li>
                                <a class="variable" href="#JaxConverter.parent">parent</a>
                        </li>
                        <li>
                                <a class="variable" href="#JaxConverter.name">name</a>
                        </li>
                        <li>
                                <a class="variable" href="#JaxConverter.scope">scope</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#PreprocessingChain">PreprocessingChain</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#PreprocessingChain.__init__">PreprocessingChain</a>
                        </li>
                        <li>
                                <a class="variable" href="#PreprocessingChain.layers">layers</a>
                        </li>
                        <li>
                                <a class="variable" href="#PreprocessingChain.use_atom_padding">use_atom_padding</a>
                        </li>
                        <li>
                                <a class="variable" href="#PreprocessingChain.atom_padder">atom_padder</a>
                        </li>
                        <li>
                                <a class="function" href="#PreprocessingChain.check_reallocate">check_reallocate</a>
                        </li>
                        <li>
                                <a class="function" href="#PreprocessingChain.process">process</a>
                        </li>
                        <li>
                                <a class="function" href="#PreprocessingChain.update_skin">update_skin</a>
                        </li>
                        <li>
                                <a class="function" href="#PreprocessingChain.init">init</a>
                        </li>
                        <li>
                                <a class="function" href="#PreprocessingChain.init_with_output">init_with_output</a>
                        </li>
                        <li>
                                <a class="function" href="#PreprocessingChain.get_processors">get_processors</a>
                        </li>
                        <li>
                                <a class="function" href="#PreprocessingChain.get_graphs_properties">get_graphs_properties</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="variable" href="#PREPROCESSING">PREPROCESSING</a>
            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../../fennol.html">fennol</a><wbr>.<a href="./../models.html">models</a><wbr>.preprocessing    </h1>

                
                        <input id="mod-preprocessing-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-preprocessing-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">   1</span></a><span class="kn">import</span> <span class="nn">flax.linen</span> <span class="k">as</span> <span class="nn">nn</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">   2</span></a><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">   3</span></a><span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">   4</span></a><span class="kn">import</span> <span class="nn">jax</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">   5</span></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">   6</span></a><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">   7</span></a><span class="kn">import</span> <span class="nn">numba</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">   8</span></a><span class="kn">import</span> <span class="nn">dataclasses</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">   9</span></a><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos">  10</span></a>
</span><span id="L-11"><a href="#L-11"><span class="linenos">  11</span></a><span class="kn">from</span> <span class="nn">flax.core.frozen_dict</span> <span class="kn">import</span> <span class="n">FrozenDict</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos">  12</span></a>
</span><span id="L-13"><a href="#L-13"><span class="linenos">  13</span></a>
</span><span id="L-14"><a href="#L-14"><span class="linenos">  14</span></a><span class="kn">from</span> <span class="nn">..utils.activations</span> <span class="kn">import</span> <span class="n">chain</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos">  15</span></a><span class="kn">from</span> <span class="nn">..utils</span> <span class="kn">import</span> <span class="n">deep_update</span><span class="p">,</span> <span class="n">mask_filter_1d</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos">  16</span></a><span class="kn">from</span> <span class="nn">..utils.kspace</span> <span class="kn">import</span> <span class="n">get_reciprocal_space_parameters</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos">  17</span></a><span class="kn">from</span> <span class="nn">.modules</span> <span class="kn">import</span> <span class="n">FENNIXModules</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos">  18</span></a><span class="kn">from</span> <span class="nn">.misc.misc</span> <span class="kn">import</span> <span class="n">SwitchFunction</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos">  19</span></a><span class="kn">from</span> <span class="nn">..utils.periodic_table</span> <span class="kn">import</span> <span class="n">PERIODIC_TABLE</span><span class="p">,</span> <span class="n">PERIODIC_TABLE_REV_IDX</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos">  20</span></a>
</span><span id="L-21"><a href="#L-21"><span class="linenos">  21</span></a>
</span><span id="L-22"><a href="#L-22"><span class="linenos">  22</span></a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos">  23</span></a><span class="k">class</span> <span class="nc">GraphGenerator</span><span class="p">:</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos">  24</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a graph from a set of coordinates</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos">  25</span></a>
</span><span id="L-26"><a href="#L-26"><span class="linenos">  26</span></a><span class="sd">    For now, we generate all pairs of atoms and filter based on cutoff.</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos">  27</span></a><span class="sd">    If a `nblist_skin` is present in the state, we generate a second graph with a larger cutoff that includes all pairs within the cutoff+skin. This graph is then reused by the `update_skin` method to update the original graph without recomputing the full nblist.</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos">  28</span></a>
</span><span id="L-29"><a href="#L-29"><span class="linenos">  29</span></a><span class="sd">    Parameters</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos">  30</span></a><span class="sd">    ----------</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos">  31</span></a><span class="sd">    cutoff : float</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos">  32</span></a><span class="sd">        Cutoff distance for the graph.</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos">  33</span></a><span class="sd">    graph_key : str, default=&quot;graph&quot;</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos">  34</span></a><span class="sd">        Key of the graph in the outputs.</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos">  35</span></a><span class="sd">    switch_params : dict, default={}</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos">  36</span></a><span class="sd">        Parameters for the switching function.</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos">  37</span></a><span class="sd">    k_space : bool, default=False</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos">  38</span></a><span class="sd">        Generate k-space information for the graph.</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos">  39</span></a><span class="sd">    kmax : int, default=30</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos">  40</span></a><span class="sd">        Maximum number of k-points to consider.</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos">  41</span></a><span class="sd">    kthr : float, default=1e-6</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos">  42</span></a><span class="sd">        Threshold for k-point filtering.</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos">  43</span></a><span class="sd">    mult_size : float, default=1.05</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos">  44</span></a><span class="sd">        Multiplicative factor for resizing the nblist.</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos">  45</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos">  46</span></a>
</span><span id="L-47"><a href="#L-47"><span class="linenos">  47</span></a>    <span class="n">cutoff</span><span class="p">:</span> <span class="nb">float</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos">  48</span></a>    <span class="n">graph_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;graph&quot;</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos">  49</span></a>    <span class="n">switch_params</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos">  50</span></a>    <span class="n">kmax</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos">  51</span></a>    <span class="n">kthr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-6</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos">  52</span></a>    <span class="n">k_space</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos">  53</span></a>    <span class="n">mult_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.05</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos">  54</span></a>    <span class="c1"># covalent_cutoff: bool = False</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos">  55</span></a>
</span><span id="L-56"><a href="#L-56"><span class="linenos">  56</span></a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos">  57</span></a>        <span class="k">return</span> <span class="n">FrozenDict</span><span class="p">(</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos">  58</span></a>            <span class="p">{</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos">  59</span></a>                <span class="s2">&quot;max_nat&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos">  60</span></a>                <span class="s2">&quot;npairs&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos">  61</span></a>                <span class="s2">&quot;nblist_mult_size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mult_size</span><span class="p">,</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos">  62</span></a>            <span class="p">}</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos">  63</span></a>        <span class="p">)</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos">  64</span></a>
</span><span id="L-65"><a href="#L-65"><span class="linenos">  65</span></a>    <span class="k">def</span> <span class="nf">get_processor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]:</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos">  66</span></a>        <span class="k">return</span> <span class="n">GraphProcessor</span><span class="p">,</span> <span class="p">{</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos">  67</span></a>            <span class="s2">&quot;cutoff&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">,</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos">  68</span></a>            <span class="s2">&quot;graph_key&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">,</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos">  69</span></a>            <span class="s2">&quot;switch_params&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">switch_params</span><span class="p">,</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos">  70</span></a>            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="si">}</span><span class="s2">_Processor&quot;</span><span class="p">,</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos">  71</span></a>        <span class="p">}</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos">  72</span></a>
</span><span id="L-73"><a href="#L-73"><span class="linenos">  73</span></a>    <span class="k">def</span> <span class="nf">get_graph_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos">  74</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos">  75</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">:</span> <span class="p">{</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos">  76</span></a>                <span class="s2">&quot;cutoff&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">,</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos">  77</span></a>                <span class="s2">&quot;directed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos">  78</span></a>            <span class="p">}</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos">  79</span></a>        <span class="p">}</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos">  80</span></a>
</span><span id="L-81"><a href="#L-81"><span class="linenos">  81</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">return_state_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_margin</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos">  82</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;build a nblist on cpu with numpy and dynamic shapes + store max shapes&quot;&quot;&quot;</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos">  83</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos">  84</span></a>            <span class="n">graph</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">]</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos">  85</span></a>            <span class="k">if</span> <span class="s2">&quot;keep_graph&quot;</span> <span class="ow">in</span> <span class="n">graph</span><span class="p">:</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos">  86</span></a>                <span class="k">return</span> <span class="n">state</span><span class="p">,</span><span class="n">inputs</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos">  87</span></a>            
</span><span id="L-88"><a href="#L-88"><span class="linenos">  88</span></a>        <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;coordinates&quot;</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos">  89</span></a>        <span class="n">natoms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;natoms&quot;</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos">  90</span></a>        <span class="n">batch_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;batch_index&quot;</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos">  91</span></a>
</span><span id="L-92"><a href="#L-92"><span class="linenos">  92</span></a>        <span class="n">new_state</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">state</span><span class="p">}</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos">  93</span></a>        <span class="n">state_up</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos">  94</span></a>
</span><span id="L-95"><a href="#L-95"><span class="linenos">  95</span></a>        <span class="n">max_nat</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_nat&quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">natoms</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos">  96</span></a>        <span class="n">true_max_nat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">natoms</span><span class="p">)</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos">  97</span></a>        <span class="k">if</span> <span class="n">true_max_nat</span> <span class="o">&gt;</span> <span class="n">max_nat</span><span class="p">:</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos">  98</span></a>            <span class="n">state_up</span><span class="p">[</span><span class="s2">&quot;max_nat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">true_max_nat</span><span class="p">,</span> <span class="n">max_nat</span><span class="p">)</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos">  99</span></a>            <span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;max_nat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">true_max_nat</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos"> 100</span></a>
</span><span id="L-101"><a href="#L-101"><span class="linenos"> 101</span></a>        <span class="n">cutoff_skin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span> <span class="o">+</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nblist_skin&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos"> 102</span></a>
</span><span id="L-103"><a href="#L-103"><span class="linenos"> 103</span></a>        <span class="c1">### compute indices of all pairs</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos"> 104</span></a>        <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">triu_indices</span><span class="p">(</span><span class="n">true_max_nat</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos"> 105</span></a>        <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">p1</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">p2</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos"> 106</span></a>        <span class="n">pbc_shifts</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos"> 107</span></a>        <span class="k">if</span> <span class="n">natoms</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos"> 108</span></a>            <span class="c1">## batching =&gt; mask irrelevant pairs</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos"> 109</span></a>            <span class="n">mask_p12</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos"> 110</span></a>                <span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&lt;</span> <span class="n">natoms</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">p2</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&lt;</span> <span class="n">natoms</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos"> 111</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos"> 112</span></a>            <span class="n">shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos"> 113</span></a>                <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">natoms</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos"> 114</span></a>            <span class="p">)</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos"> 115</span></a>            <span class="n">p1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_p12</span><span class="p">,</span> <span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">shift</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos"> 116</span></a>            <span class="n">p2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_p12</span><span class="p">,</span> <span class="p">(</span><span class="n">p2</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">shift</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos"> 117</span></a>
</span><span id="L-118"><a href="#L-118"><span class="linenos"> 118</span></a>        <span class="n">apply_pbc</span> <span class="o">=</span> <span class="s2">&quot;cells&quot;</span> <span class="ow">in</span> <span class="n">inputs</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos"> 119</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">apply_pbc</span><span class="p">:</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos"> 120</span></a>            <span class="c1">### NO PBC</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos"> 121</span></a>            <span class="n">vec</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">p2</span><span class="p">]</span> <span class="o">-</span> <span class="n">coords</span><span class="p">[</span><span class="n">p1</span><span class="p">]</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos"> 122</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos"> 123</span></a>            <span class="n">cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;cells&quot;</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos"> 124</span></a>            <span class="n">reciprocal_cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;reciprocal_cells&quot;</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos"> 125</span></a>            <span class="n">minimage</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;minimum_image&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos"> 126</span></a>            <span class="k">if</span> <span class="n">minimage</span><span class="p">:</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos"> 127</span></a>                <span class="c1">## MINIMUM IMAGE CONVENTION</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos"> 128</span></a>                <span class="n">vec</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">p2</span><span class="p">]</span> <span class="o">-</span> <span class="n">coords</span><span class="p">[</span><span class="n">p1</span><span class="p">]</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos"> 129</span></a>                <span class="k">if</span> <span class="n">cells</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos"> 130</span></a>                    <span class="n">vecpbc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">reciprocal_cells</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos"> 131</span></a>                    <span class="n">pbc_shifts</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">vecpbc</span><span class="p">)</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos"> 132</span></a>                    <span class="n">vec</span> <span class="o">=</span> <span class="n">vec</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pbc_shifts</span><span class="p">,</span> <span class="n">cells</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos"> 133</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos"> 134</span></a>                    <span class="n">vecpbc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;aj,aji-&gt;ai&quot;</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="n">reciprocal_cells</span><span class="p">[</span><span class="n">batch_index_vec</span><span class="p">])</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos"> 135</span></a>                    <span class="n">pbc_shifts</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">vecpbc</span><span class="p">)</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos"> 136</span></a>                    <span class="n">vec</span> <span class="o">=</span> <span class="n">vec</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;aj,aji-&gt;ai&quot;</span><span class="p">,</span> <span class="n">pbc_shifts</span><span class="p">,</span> <span class="n">cells</span><span class="p">[</span><span class="n">batch_index_vec</span><span class="p">])</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos"> 137</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos"> 138</span></a>                <span class="c1">### GENERAL PBC</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos"> 139</span></a>                <span class="c1">## put all atoms in central box</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos"> 140</span></a>                <span class="k">if</span> <span class="n">cells</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos"> 141</span></a>                    <span class="n">coords_pbc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">reciprocal_cells</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos"> 142</span></a>                    <span class="n">at_shifts</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">coords_pbc</span><span class="p">)</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos"> 143</span></a>                    <span class="n">coords_pbc</span> <span class="o">=</span> <span class="n">coords</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">at_shifts</span><span class="p">,</span> <span class="n">cells</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos"> 144</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos"> 145</span></a>                    <span class="n">coords_pbc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;aj,aji-&gt;ai&quot;</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">reciprocal_cells</span><span class="p">[</span><span class="n">batch_index</span><span class="p">])</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos"> 146</span></a>                    <span class="n">at_shifts</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">coords_pbc</span><span class="p">)</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos"> 147</span></a>                    <span class="n">coords_pbc</span> <span class="o">=</span> <span class="n">coords</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;aj,aji-&gt;ai&quot;</span><span class="p">,</span> <span class="n">at_shifts</span><span class="p">,</span> <span class="n">cells</span><span class="p">[</span><span class="n">batch_index</span><span class="p">])</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos"> 148</span></a>
</span><span id="L-149"><a href="#L-149"><span class="linenos"> 149</span></a>                <span class="c1">## compute maximum number of repeats</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos"> 150</span></a>                <span class="n">inv_distances</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">reciprocal_cells</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span> <span class="o">**</span> <span class="mf">0.5</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos"> 151</span></a>                <span class="n">num_repeats_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">cutoff_skin</span> <span class="o">*</span> <span class="n">inv_distances</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos"> 152</span></a>                <span class="n">num_repeats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">num_repeats_all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos"> 153</span></a>                <span class="n">num_repeats_prev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;num_repeats_pbc&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos"> 154</span></a>                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">num_repeats</span> <span class="o">&gt;</span> <span class="n">num_repeats_prev</span><span class="p">):</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos"> 155</span></a>                    <span class="n">num_repeats_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">num_repeats</span><span class="p">,</span> <span class="n">num_repeats_prev</span><span class="p">)</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos"> 156</span></a>                    <span class="n">state_up</span><span class="p">[</span><span class="s2">&quot;num_repeats_pbc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos"> 157</span></a>                        <span class="nb">tuple</span><span class="p">(</span><span class="n">num_repeats_new</span><span class="p">),</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos"> 158</span></a>                        <span class="nb">tuple</span><span class="p">(</span><span class="n">num_repeats_prev</span><span class="p">),</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos"> 159</span></a>                    <span class="p">)</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos"> 160</span></a>                    <span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;num_repeats_pbc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">num_repeats_new</span><span class="p">)</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos"> 161</span></a>                <span class="c1">## build all possible shifts</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos"> 162</span></a>                <span class="n">cell_shift_pbc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos"> 163</span></a>                    <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">num_repeats</span><span class="p">])</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos"> 164</span></a>                <span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos"> 165</span></a>                <span class="c1">## shift applied to vectors</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos"> 166</span></a>                <span class="k">if</span> <span class="n">cells</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos"> 167</span></a>                    <span class="n">dvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cell_shift_pbc</span><span class="p">,</span> <span class="n">cells</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos"> 168</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos"> 169</span></a>                    <span class="n">batch_index_vec</span> <span class="o">=</span> <span class="n">batch_index</span><span class="p">[</span><span class="n">p1</span><span class="p">]</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos"> 170</span></a>                    <span class="n">dvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;bj,sji-&gt;sbi&quot;</span><span class="p">,</span> <span class="n">cell_shift_pbc</span><span class="p">,</span><span class="n">cells</span><span class="p">)[</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos"> 171</span></a>                        <span class="n">batch_index_vec</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos"> 172</span></a>                    <span class="p">]</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos"> 173</span></a>                <span class="c1">## compute vectors</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos"> 174</span></a>                <span class="n">vec</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos"> 175</span></a>                    <span class="n">coords_pbc</span><span class="p">[</span><span class="n">p2</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">coords_pbc</span><span class="p">[</span><span class="n">p1</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">dvec</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos"> 176</span></a>                <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos"> 177</span></a>                <span class="n">pbc_shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos"> 178</span></a>                    <span class="n">cell_shift_pbc</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos"> 179</span></a>                    <span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cell_shift_pbc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">),</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos"> 180</span></a>                <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos"> 181</span></a>                <span class="n">p1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos"> 182</span></a>                    <span class="n">p1</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cell_shift_pbc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos"> 183</span></a>                <span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos"> 184</span></a>                <span class="n">p2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos"> 185</span></a>                    <span class="n">p2</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="p">(</span><span class="n">p2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cell_shift_pbc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos"> 186</span></a>                <span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos"> 187</span></a>                <span class="k">if</span> <span class="n">natoms</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos"> 188</span></a>                    <span class="n">mask_p12</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos"> 189</span></a>                        <span class="n">mask_p12</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="p">(</span><span class="n">mask_p12</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cell_shift_pbc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos"> 190</span></a>                    <span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos"> 191</span></a>
</span><span id="L-192"><a href="#L-192"><span class="linenos"> 192</span></a>        <span class="c1">## compute distances</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos"> 193</span></a>        <span class="n">d12</span> <span class="o">=</span> <span class="p">(</span><span class="n">vec</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos"> 194</span></a>        <span class="k">if</span> <span class="n">natoms</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos"> 195</span></a>            <span class="n">d12</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_p12</span><span class="p">,</span> <span class="n">d12</span><span class="p">,</span> <span class="n">cutoff_skin</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos"> 196</span></a>
</span><span id="L-197"><a href="#L-197"><span class="linenos"> 197</span></a>        <span class="c1">## filter pairs</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos"> 198</span></a>        <span class="n">max_pairs</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;npairs&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos"> 199</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">d12</span> <span class="o">&lt;</span> <span class="n">cutoff_skin</span><span class="o">**</span><span class="mi">2</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos"> 200</span></a>        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">mask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos"> 201</span></a>        <span class="n">npairs</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos"> 202</span></a>        <span class="k">if</span> <span class="n">npairs</span> <span class="o">&gt;</span> <span class="n">max_pairs</span> <span class="ow">or</span> <span class="n">add_margin</span><span class="p">:</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos"> 203</span></a>            <span class="n">mult_size</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nblist_mult_size&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mult_size</span><span class="p">)</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos"> 204</span></a>            <span class="n">prev_max_pairs</span> <span class="o">=</span> <span class="n">max_pairs</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos"> 205</span></a>            <span class="n">max_pairs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mult_size</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">npairs</span><span class="p">,</span> <span class="n">max_pairs</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos"> 206</span></a>            <span class="n">state_up</span><span class="p">[</span><span class="s2">&quot;npairs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_pairs</span><span class="p">,</span> <span class="n">prev_max_pairs</span><span class="p">)</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos"> 207</span></a>            <span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;npairs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_pairs</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos"> 208</span></a>
</span><span id="L-209"><a href="#L-209"><span class="linenos"> 209</span></a>        <span class="n">nat</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos"> 210</span></a>        <span class="n">edge_src</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">max_pairs</span><span class="p">,</span> <span class="n">nat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos"> 211</span></a>        <span class="n">edge_dst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">max_pairs</span><span class="p">,</span> <span class="n">nat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos"> 212</span></a>        <span class="n">d12_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">max_pairs</span><span class="p">,</span> <span class="n">cutoff_skin</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos"> 213</span></a>        <span class="n">edge_src</span><span class="p">[:</span><span class="n">npairs</span><span class="p">]</span> <span class="o">=</span> <span class="n">p1</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos"> 214</span></a>        <span class="n">edge_dst</span><span class="p">[:</span><span class="n">npairs</span><span class="p">]</span> <span class="o">=</span> <span class="n">p2</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos"> 215</span></a>        <span class="n">d12_</span><span class="p">[:</span><span class="n">npairs</span><span class="p">]</span> <span class="o">=</span> <span class="n">d12</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos"> 216</span></a>        <span class="n">d12</span> <span class="o">=</span> <span class="n">d12_</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos"> 217</span></a>
</span><span id="L-218"><a href="#L-218"><span class="linenos"> 218</span></a>        <span class="k">if</span> <span class="n">apply_pbc</span><span class="p">:</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos"> 219</span></a>            <span class="n">pbc_shifts_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">max_pairs</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos"> 220</span></a>            <span class="n">pbc_shifts_</span><span class="p">[:</span><span class="n">npairs</span><span class="p">]</span> <span class="o">=</span> <span class="n">pbc_shifts</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos"> 221</span></a>            <span class="n">pbc_shifts</span> <span class="o">=</span> <span class="n">pbc_shifts_</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos"> 222</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">minimage</span><span class="p">:</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos"> 223</span></a>                <span class="n">pbc_shifts</span><span class="p">[:</span><span class="n">npairs</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos"> 224</span></a>                    <span class="n">pbc_shifts</span><span class="p">[:</span><span class="n">npairs</span><span class="p">]</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos"> 225</span></a>                    <span class="o">+</span> <span class="n">at_shifts</span><span class="p">[</span><span class="n">edge_dst</span><span class="p">[:</span><span class="n">npairs</span><span class="p">]]</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos"> 226</span></a>                    <span class="o">-</span> <span class="n">at_shifts</span><span class="p">[</span><span class="n">edge_src</span><span class="p">[:</span><span class="n">npairs</span><span class="p">]]</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos"> 227</span></a>                <span class="p">)</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos"> 228</span></a>
</span><span id="L-229"><a href="#L-229"><span class="linenos"> 229</span></a>        <span class="k">if</span> <span class="s2">&quot;nblist_skin&quot;</span> <span class="ow">in</span> <span class="n">state</span><span class="p">:</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos"> 230</span></a>            <span class="n">edge_src_skin</span> <span class="o">=</span> <span class="n">edge_src</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos"> 231</span></a>            <span class="n">edge_dst_skin</span> <span class="o">=</span> <span class="n">edge_dst</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos"> 232</span></a>            <span class="k">if</span> <span class="n">apply_pbc</span><span class="p">:</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos"> 233</span></a>                <span class="n">pbc_shifts_skin</span> <span class="o">=</span> <span class="n">pbc_shifts</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos"> 234</span></a>            <span class="n">max_pairs_skin</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;npairs_skin&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos"> 235</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="n">d12</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="o">**</span><span class="mi">2</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos"> 236</span></a>            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">mask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos"> 237</span></a>            <span class="n">npairs_skin</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos"> 238</span></a>            <span class="k">if</span> <span class="n">npairs_skin</span> <span class="o">&gt;</span> <span class="n">max_pairs_skin</span> <span class="ow">or</span> <span class="n">add_margin</span><span class="p">:</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos"> 239</span></a>                <span class="n">mult_size</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nblist_mult_size&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mult_size</span><span class="p">)</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos"> 240</span></a>                <span class="n">prev_max_pairs_skin</span> <span class="o">=</span> <span class="n">max_pairs_skin</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos"> 241</span></a>                <span class="n">max_pairs_skin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mult_size</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">npairs_skin</span><span class="p">,</span> <span class="n">max_pairs_skin</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos"> 242</span></a>                <span class="n">state_up</span><span class="p">[</span><span class="s2">&quot;npairs_skin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_pairs_skin</span><span class="p">,</span> <span class="n">prev_max_pairs_skin</span><span class="p">)</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos"> 243</span></a>                <span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;npairs_skin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_pairs_skin</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos"> 244</span></a>            <span class="n">edge_src</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">max_pairs_skin</span><span class="p">,</span> <span class="n">nat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos"> 245</span></a>            <span class="n">edge_dst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">max_pairs_skin</span><span class="p">,</span> <span class="n">nat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos"> 246</span></a>            <span class="n">d12_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">max_pairs_skin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos"> 247</span></a>            <span class="n">edge_src</span><span class="p">[:</span><span class="n">npairs_skin</span><span class="p">]</span> <span class="o">=</span> <span class="n">edge_src_skin</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos"> 248</span></a>            <span class="n">edge_dst</span><span class="p">[:</span><span class="n">npairs_skin</span><span class="p">]</span> <span class="o">=</span> <span class="n">edge_dst_skin</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos"> 249</span></a>            <span class="n">d12_</span><span class="p">[:</span><span class="n">npairs_skin</span><span class="p">]</span> <span class="o">=</span> <span class="n">d12</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos"> 250</span></a>            <span class="n">d12</span> <span class="o">=</span> <span class="n">d12_</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos"> 251</span></a>            <span class="k">if</span> <span class="n">apply_pbc</span><span class="p">:</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos"> 252</span></a>                <span class="n">pbc_shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">max_pairs_skin</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">)</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos"> 253</span></a>                <span class="n">pbc_shifts</span><span class="p">[:</span><span class="n">npairs_skin</span><span class="p">]</span> <span class="o">=</span> <span class="n">pbc_shifts_skin</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos"> 254</span></a>
</span><span id="L-255"><a href="#L-255"><span class="linenos"> 255</span></a>        <span class="c1">## symmetrize</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos"> 256</span></a>        <span class="n">edge_src</span><span class="p">,</span> <span class="n">edge_dst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">edge_src</span><span class="p">,</span> <span class="n">edge_dst</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos"> 257</span></a>            <span class="p">(</span><span class="n">edge_dst</span><span class="p">,</span> <span class="n">edge_src</span><span class="p">)</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos"> 258</span></a>        <span class="p">)</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos"> 259</span></a>        <span class="n">d12</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">d12</span><span class="p">,</span> <span class="n">d12</span><span class="p">))</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos"> 260</span></a>        <span class="k">if</span> <span class="n">apply_pbc</span><span class="p">:</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos"> 261</span></a>            <span class="n">pbc_shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">pbc_shifts</span><span class="p">,</span> <span class="o">-</span><span class="n">pbc_shifts</span><span class="p">))</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos"> 262</span></a>
</span><span id="L-263"><a href="#L-263"><span class="linenos"> 263</span></a>        <span class="n">graph</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos"> 264</span></a>        <span class="n">graph_out</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos"> 265</span></a>            <span class="o">**</span><span class="n">graph</span><span class="p">,</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos"> 266</span></a>            <span class="s2">&quot;edge_src&quot;</span><span class="p">:</span> <span class="n">edge_src</span><span class="p">,</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos"> 267</span></a>            <span class="s2">&quot;edge_dst&quot;</span><span class="p">:</span> <span class="n">edge_dst</span><span class="p">,</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos"> 268</span></a>            <span class="s2">&quot;d12&quot;</span><span class="p">:</span> <span class="n">d12</span><span class="p">,</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos"> 269</span></a>            <span class="s2">&quot;overflow&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos"> 270</span></a>            <span class="s2">&quot;pbc_shifts&quot;</span><span class="p">:</span> <span class="n">pbc_shifts</span><span class="p">,</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos"> 271</span></a>        <span class="p">}</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos"> 272</span></a>        <span class="k">if</span> <span class="s2">&quot;nblist_skin&quot;</span> <span class="ow">in</span> <span class="n">state</span><span class="p">:</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos"> 273</span></a>            <span class="n">graph_out</span><span class="p">[</span><span class="s2">&quot;edge_src_skin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">edge_src_skin</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos"> 274</span></a>            <span class="n">graph_out</span><span class="p">[</span><span class="s2">&quot;edge_dst_skin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">edge_dst_skin</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos"> 275</span></a>            <span class="k">if</span> <span class="n">apply_pbc</span><span class="p">:</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos"> 276</span></a>                <span class="n">graph_out</span><span class="p">[</span><span class="s2">&quot;pbc_shifts_skin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pbc_shifts_skin</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos"> 277</span></a>
</span><span id="L-278"><a href="#L-278"><span class="linenos"> 278</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_space</span> <span class="ow">and</span> <span class="n">apply_pbc</span><span class="p">:</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos"> 279</span></a>            <span class="k">if</span> <span class="s2">&quot;k_points&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">graph</span><span class="p">:</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos"> 280</span></a>                <span class="n">ks</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">bewald</span> <span class="o">=</span> <span class="n">get_reciprocal_space_parameters</span><span class="p">(</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos"> 281</span></a>                    <span class="n">reciprocal_cells</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kthr</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos"> 282</span></a>                <span class="p">)</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos"> 283</span></a>            <span class="n">graph_out</span><span class="p">[</span><span class="s2">&quot;k_points&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ks</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos"> 284</span></a>            <span class="n">graph_out</span><span class="p">[</span><span class="s2">&quot;b_ewald&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bewald</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos"> 285</span></a>
</span><span id="L-286"><a href="#L-286"><span class="linenos"> 286</span></a>        <span class="n">output</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">:</span> <span class="n">graph_out</span><span class="p">}</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos"> 287</span></a>
</span><span id="L-288"><a href="#L-288"><span class="linenos"> 288</span></a>        <span class="k">if</span> <span class="n">return_state_update</span><span class="p">:</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos"> 289</span></a>            <span class="k">return</span> <span class="n">FrozenDict</span><span class="p">(</span><span class="n">new_state</span><span class="p">),</span> <span class="n">output</span><span class="p">,</span> <span class="n">state_up</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos"> 290</span></a>        <span class="k">return</span> <span class="n">FrozenDict</span><span class="p">(</span><span class="n">new_state</span><span class="p">),</span> <span class="n">output</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos"> 291</span></a>
</span><span id="L-292"><a href="#L-292"><span class="linenos"> 292</span></a>    <span class="k">def</span> <span class="nf">check_reallocate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">parent_overflow</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos"> 293</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;check for overflow and reallocate nblist if necessary&quot;&quot;&quot;</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos"> 294</span></a>        <span class="n">overflow</span> <span class="o">=</span> <span class="n">parent_overflow</span> <span class="ow">or</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;overflow&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos"> 295</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">overflow</span><span class="p">:</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos"> 296</span></a>            <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="p">{},</span> <span class="n">inputs</span><span class="p">,</span> <span class="kc">False</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos"> 297</span></a>
</span><span id="L-298"><a href="#L-298"><span class="linenos"> 298</span></a>        <span class="n">add_margin</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;overflow&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos"> 299</span></a>        <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">state_up</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos"> 300</span></a>            <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">return_state_update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">add_margin</span><span class="o">=</span><span class="n">add_margin</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos"> 301</span></a>        <span class="p">)</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos"> 302</span></a>        <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="n">state_up</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="kc">True</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos"> 303</span></a>
</span><span id="L-304"><a href="#L-304"><span class="linenos"> 304</span></a>    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos"> 305</span></a>    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos"> 306</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;build a nblist on accelerator with jax and precomputed shapes&quot;&quot;&quot;</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos"> 307</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos"> 308</span></a>            <span class="n">graph</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">]</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos"> 309</span></a>            <span class="k">if</span> <span class="s2">&quot;keep_graph&quot;</span> <span class="ow">in</span> <span class="n">graph</span><span class="p">:</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos"> 310</span></a>                <span class="k">return</span> <span class="n">inputs</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos"> 311</span></a>        <span class="n">coords</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;coordinates&quot;</span><span class="p">]</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos"> 312</span></a>        <span class="n">natoms</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;natoms&quot;</span><span class="p">]</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos"> 313</span></a>        <span class="n">batch_index</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;batch_index&quot;</span><span class="p">]</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos"> 314</span></a>
</span><span id="L-315"><a href="#L-315"><span class="linenos"> 315</span></a>        <span class="n">max_nat</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_nat&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">natoms</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos"> 316</span></a>
</span><span id="L-317"><a href="#L-317"><span class="linenos"> 317</span></a>        <span class="c1">### compute indices of all pairs</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos"> 318</span></a>        <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">triu_indices</span><span class="p">(</span><span class="n">max_nat</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos"> 319</span></a>        <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">p1</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">p2</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos"> 320</span></a>        <span class="n">pbc_shifts</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos"> 321</span></a>        <span class="k">if</span> <span class="n">natoms</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos"> 322</span></a>            <span class="c1">## batching =&gt; mask irrelevant pairs</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos"> 323</span></a>            <span class="n">mask_p12</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos"> 324</span></a>                <span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&lt;</span> <span class="n">natoms</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">p2</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&lt;</span> <span class="n">natoms</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos"> 325</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos"> 326</span></a>            <span class="n">shift</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos"> 327</span></a>                <span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">natoms</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos"> 328</span></a>            <span class="p">)</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos"> 329</span></a>            <span class="n">p1</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_p12</span><span class="p">,</span> <span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">shift</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos"> 330</span></a>            <span class="n">p2</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_p12</span><span class="p">,</span> <span class="p">(</span><span class="n">p2</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">shift</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos"> 331</span></a>
</span><span id="L-332"><a href="#L-332"><span class="linenos"> 332</span></a>        <span class="c1">## compute vectors</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos"> 333</span></a>        <span class="k">if</span> <span class="s2">&quot;cells&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos"> 334</span></a>            <span class="n">vec</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">p2</span><span class="p">]</span> <span class="o">-</span> <span class="n">coords</span><span class="p">[</span><span class="n">p1</span><span class="p">]</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos"> 335</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos"> 336</span></a>            <span class="n">cells</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;cells&quot;</span><span class="p">]</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos"> 337</span></a>            <span class="n">reciprocal_cells</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;reciprocal_cells&quot;</span><span class="p">]</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos"> 338</span></a>            <span class="n">minimage</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;minimum_image&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos"> 339</span></a>
</span><span id="L-340"><a href="#L-340"><span class="linenos"> 340</span></a>            <span class="k">def</span> <span class="nf">compute_pbc</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">reciprocal_cell</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;round&quot;</span><span class="p">):</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos"> 341</span></a>                <span class="n">vecpbc</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">reciprocal_cell</span><span class="p">)</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos"> 342</span></a>                <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;round&quot;</span><span class="p">:</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos"> 343</span></a>                    <span class="n">pbc_shifts</span> <span class="o">=</span> <span class="o">-</span><span class="n">jnp</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">vecpbc</span><span class="p">)</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos"> 344</span></a>                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;floor&quot;</span><span class="p">:</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos"> 345</span></a>                    <span class="n">pbc_shifts</span> <span class="o">=</span> <span class="o">-</span><span class="n">jnp</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">vecpbc</span><span class="p">)</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos"> 346</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos"> 347</span></a>                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown mode </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2"> for compute_pbc.&quot;</span><span class="p">)</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos"> 348</span></a>                <span class="k">return</span> <span class="n">vec</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pbc_shifts</span><span class="p">,</span> <span class="n">cell</span><span class="p">),</span> <span class="n">pbc_shifts</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos"> 349</span></a>
</span><span id="L-350"><a href="#L-350"><span class="linenos"> 350</span></a>            <span class="k">if</span> <span class="n">minimage</span><span class="p">:</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos"> 351</span></a>                <span class="c1">## minimum image convention</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos"> 352</span></a>                <span class="n">vec</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">p2</span><span class="p">]</span> <span class="o">-</span> <span class="n">coords</span><span class="p">[</span><span class="n">p1</span><span class="p">]</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos"> 353</span></a>
</span><span id="L-354"><a href="#L-354"><span class="linenos"> 354</span></a>                <span class="k">if</span> <span class="n">cells</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos"> 355</span></a>                    <span class="n">vec</span><span class="p">,</span> <span class="n">pbc_shifts</span> <span class="o">=</span> <span class="n">compute_pbc</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">reciprocal_cells</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cells</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos"> 356</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos"> 357</span></a>                    <span class="n">batch_index_vec</span> <span class="o">=</span> <span class="n">batch_index</span><span class="p">[</span><span class="n">p1</span><span class="p">]</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos"> 358</span></a>                    <span class="n">vec</span><span class="p">,</span> <span class="n">pbc_shifts</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="n">compute_pbc</span><span class="p">)(</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos"> 359</span></a>                        <span class="n">vec</span><span class="p">,</span> <span class="n">reciprocal_cells</span><span class="p">[</span><span class="n">batch_index_vec</span><span class="p">],</span> <span class="n">cells</span><span class="p">[</span><span class="n">batch_index_vec</span><span class="p">]</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos"> 360</span></a>                    <span class="p">)</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos"> 361</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos"> 362</span></a>                <span class="c1">### general PBC only for single cell yet</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos"> 363</span></a>                <span class="k">if</span> <span class="n">cells</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos"> 364</span></a>                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos"> 365</span></a>                        <span class="s2">&quot;General PBC not implemented for batches on accelerator.&quot;</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos"> 366</span></a>                    <span class="p">)</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos"> 367</span></a>                <span class="n">cell</span> <span class="o">=</span> <span class="n">cells</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos"> 368</span></a>                <span class="n">reciprocal_cell</span> <span class="o">=</span> <span class="n">reciprocal_cells</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos"> 369</span></a>
</span><span id="L-370"><a href="#L-370"><span class="linenos"> 370</span></a>                <span class="c1">## put all atoms in central box</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos"> 371</span></a>                <span class="n">coords_pbc</span><span class="p">,</span> <span class="n">at_shifts</span> <span class="o">=</span> <span class="n">compute_pbc</span><span class="p">(</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos"> 372</span></a>                    <span class="n">coords</span><span class="p">,</span> <span class="n">reciprocal_cell</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;floor&quot;</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos"> 373</span></a>                <span class="p">)</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos"> 374</span></a>                <span class="n">num_repeats</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;num_repeats_pbc&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos"> 375</span></a>                <span class="k">if</span> <span class="n">num_repeats</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos"> 376</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos"> 377</span></a>                        <span class="s2">&quot;num_repeats_pbc should be provided for general PBC on accelerator. Call the numpy routine (self.__call__) first.&quot;</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos"> 378</span></a>                    <span class="p">)</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos"> 379</span></a>                <span class="n">cell_shift_pbc</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos"> 380</span></a>                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos"> 381</span></a>                        <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">num_repeats</span><span class="p">]),</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos"> 382</span></a>                        <span class="n">dtype</span><span class="o">=</span><span class="n">cell</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos"> 383</span></a>                    <span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos"> 384</span></a>                <span class="p">)</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos"> 385</span></a>                <span class="n">vec</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos"> 386</span></a>                    <span class="n">coords_pbc</span><span class="p">[</span><span class="n">p2</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos"> 387</span></a>                    <span class="o">-</span> <span class="n">coords_pbc</span><span class="p">[</span><span class="n">p1</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos"> 388</span></a>                    <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cell_shift_pbc</span><span class="p">,</span> <span class="n">cell</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos"> 389</span></a>                <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos"> 390</span></a>                <span class="n">pbc_shifts</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos"> 391</span></a>                    <span class="n">cell_shift_pbc</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos"> 392</span></a>                    <span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cell_shift_pbc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">),</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos"> 393</span></a>                <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos"> 394</span></a>                <span class="n">p1</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos"> 395</span></a>                    <span class="n">p1</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cell_shift_pbc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos"> 396</span></a>                <span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos"> 397</span></a>                <span class="n">p2</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos"> 398</span></a>                    <span class="n">p2</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="p">(</span><span class="n">p2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cell_shift_pbc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos"> 399</span></a>                <span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos"> 400</span></a>                <span class="k">if</span> <span class="n">natoms</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos"> 401</span></a>                    <span class="n">mask_p12</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos"> 402</span></a>                        <span class="n">mask_p12</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="p">(</span><span class="n">mask_p12</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cell_shift_pbc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos"> 403</span></a>                    <span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos"> 404</span></a>
</span><span id="L-405"><a href="#L-405"><span class="linenos"> 405</span></a>        <span class="c1">## compute distances</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos"> 406</span></a>        <span class="n">cutoff_skin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span> <span class="o">+</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nblist_skin&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos"> 407</span></a>        <span class="n">d12</span> <span class="o">=</span> <span class="p">(</span><span class="n">vec</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos"> 408</span></a>        <span class="k">if</span> <span class="n">natoms</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos"> 409</span></a>            <span class="n">d12</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_p12</span><span class="p">,</span> <span class="n">d12</span><span class="p">,</span> <span class="n">cutoff_skin</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos"> 410</span></a>
</span><span id="L-411"><a href="#L-411"><span class="linenos"> 411</span></a>        <span class="c1">## filter pairs</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos"> 412</span></a>        <span class="n">max_pairs</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;npairs&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos"> 413</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">d12</span> <span class="o">&lt;</span> <span class="n">cutoff_skin</span><span class="o">**</span><span class="mi">2</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos"> 414</span></a>        <span class="p">(</span><span class="n">edge_src</span><span class="p">,</span> <span class="n">edge_dst</span><span class="p">,</span> <span class="n">d12</span><span class="p">),</span> <span class="n">scatter_idx</span><span class="p">,</span> <span class="n">npairs</span> <span class="o">=</span> <span class="n">mask_filter_1d</span><span class="p">(</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos"> 415</span></a>            <span class="n">mask</span><span class="p">,</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos"> 416</span></a>            <span class="n">max_pairs</span><span class="p">,</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos"> 417</span></a>            <span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos"> 418</span></a>            <span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">p2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos"> 419</span></a>            <span class="p">(</span><span class="n">d12</span><span class="p">,</span> <span class="n">cutoff_skin</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos"> 420</span></a>        <span class="p">)</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos"> 421</span></a>        <span class="k">if</span> <span class="s2">&quot;cells&quot;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos"> 422</span></a>            <span class="n">pbc_shifts</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos"> 423</span></a>                <span class="n">jnp</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">max_pairs</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">pbc_shifts</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos"> 424</span></a>                <span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">scatter_idx</span><span class="p">]</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos"> 425</span></a>                <span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">pbc_shifts</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;drop&quot;</span><span class="p">)</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos"> 426</span></a>            <span class="p">)</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos"> 427</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">minimage</span><span class="p">:</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos"> 428</span></a>                <span class="n">pbc_shifts</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos"> 429</span></a>                    <span class="n">pbc_shifts</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos"> 430</span></a>                    <span class="o">+</span> <span class="n">at_shifts</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">edge_dst</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fill_value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos"> 431</span></a>                    <span class="o">-</span> <span class="n">at_shifts</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">edge_src</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fill_value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos"> 432</span></a>                <span class="p">)</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos"> 433</span></a>
</span><span id="L-434"><a href="#L-434"><span class="linenos"> 434</span></a>        <span class="c1">## check for overflow</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos"> 435</span></a>        <span class="k">if</span> <span class="n">natoms</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos"> 436</span></a>            <span class="n">true_max_nat</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos"> 437</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos"> 438</span></a>            <span class="n">true_max_nat</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">natoms</span><span class="p">)</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos"> 439</span></a>        <span class="n">overflow_count</span> <span class="o">=</span> <span class="n">npairs</span> <span class="o">&gt;</span> <span class="n">max_pairs</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos"> 440</span></a>        <span class="n">overflow_at</span> <span class="o">=</span> <span class="n">true_max_nat</span> <span class="o">&gt;</span> <span class="n">max_nat</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos"> 441</span></a>        <span class="n">overflow</span> <span class="o">=</span> <span class="n">overflow_count</span> <span class="o">|</span> <span class="n">overflow_at</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos"> 442</span></a>
</span><span id="L-443"><a href="#L-443"><span class="linenos"> 443</span></a>        <span class="k">if</span> <span class="s2">&quot;nblist_skin&quot;</span> <span class="ow">in</span> <span class="n">state</span><span class="p">:</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos"> 444</span></a>            <span class="c1"># edge_mask_skin = edge_mask</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos"> 445</span></a>            <span class="n">edge_src_skin</span> <span class="o">=</span> <span class="n">edge_src</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos"> 446</span></a>            <span class="n">edge_dst_skin</span> <span class="o">=</span> <span class="n">edge_dst</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos"> 447</span></a>            <span class="k">if</span> <span class="s2">&quot;cells&quot;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos"> 448</span></a>                <span class="n">pbc_shifts_skin</span> <span class="o">=</span> <span class="n">pbc_shifts</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos"> 449</span></a>            <span class="n">max_pairs_skin</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;npairs_skin&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos"> 450</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="n">d12</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="o">**</span><span class="mi">2</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos"> 451</span></a>            <span class="p">(</span><span class="n">edge_src</span><span class="p">,</span> <span class="n">edge_dst</span><span class="p">,</span> <span class="n">d12</span><span class="p">),</span> <span class="n">scatter_idx</span><span class="p">,</span> <span class="n">npairs_skin</span> <span class="o">=</span> <span class="n">mask_filter_1d</span><span class="p">(</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos"> 452</span></a>                <span class="n">mask</span><span class="p">,</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos"> 453</span></a>                <span class="n">max_pairs_skin</span><span class="p">,</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos"> 454</span></a>                <span class="p">(</span><span class="n">edge_src</span><span class="p">,</span> <span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos"> 455</span></a>                <span class="p">(</span><span class="n">edge_dst</span><span class="p">,</span> <span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos"> 456</span></a>                <span class="p">(</span><span class="n">d12</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos"> 457</span></a>            <span class="p">)</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos"> 458</span></a>            <span class="k">if</span> <span class="s2">&quot;cells&quot;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos"> 459</span></a>                <span class="n">pbc_shifts</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos"> 460</span></a>                    <span class="n">jnp</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">max_pairs_skin</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">pbc_shifts</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos"> 461</span></a>                    <span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">scatter_idx</span><span class="p">]</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos"> 462</span></a>                    <span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">pbc_shifts</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;drop&quot;</span><span class="p">)</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos"> 463</span></a>                <span class="p">)</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos"> 464</span></a>            <span class="n">overflow</span> <span class="o">=</span> <span class="n">overflow</span> <span class="o">|</span> <span class="p">(</span><span class="n">npairs_skin</span> <span class="o">&gt;</span> <span class="n">max_pairs_skin</span><span class="p">)</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos"> 465</span></a>
</span><span id="L-466"><a href="#L-466"><span class="linenos"> 466</span></a>        <span class="c1">## symmetrize</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos"> 467</span></a>        <span class="n">edge_src</span><span class="p">,</span> <span class="n">edge_dst</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">edge_src</span><span class="p">,</span> <span class="n">edge_dst</span><span class="p">)),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos"> 468</span></a>            <span class="p">(</span><span class="n">edge_dst</span><span class="p">,</span> <span class="n">edge_src</span><span class="p">)</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos"> 469</span></a>        <span class="p">)</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos"> 470</span></a>        <span class="n">d12</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">d12</span><span class="p">,</span> <span class="n">d12</span><span class="p">))</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos"> 471</span></a>        <span class="k">if</span> <span class="s2">&quot;cells&quot;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos"> 472</span></a>            <span class="n">pbc_shifts</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">pbc_shifts</span><span class="p">,</span> <span class="o">-</span><span class="n">pbc_shifts</span><span class="p">))</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos"> 473</span></a>
</span><span id="L-474"><a href="#L-474"><span class="linenos"> 474</span></a>        <span class="n">graph</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span> <span class="ow">in</span> <span class="n">inputs</span> <span class="k">else</span> <span class="p">{}</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos"> 475</span></a>        <span class="n">graph_out</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos"> 476</span></a>            <span class="o">**</span><span class="n">graph</span><span class="p">,</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos"> 477</span></a>            <span class="s2">&quot;edge_src&quot;</span><span class="p">:</span> <span class="n">edge_src</span><span class="p">,</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos"> 478</span></a>            <span class="s2">&quot;edge_dst&quot;</span><span class="p">:</span> <span class="n">edge_dst</span><span class="p">,</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos"> 479</span></a>            <span class="s2">&quot;d12&quot;</span><span class="p">:</span> <span class="n">d12</span><span class="p">,</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos"> 480</span></a>            <span class="s2">&quot;overflow&quot;</span><span class="p">:</span> <span class="n">overflow</span><span class="p">,</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos"> 481</span></a>            <span class="s2">&quot;pbc_shifts&quot;</span><span class="p">:</span> <span class="n">pbc_shifts</span><span class="p">,</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos"> 482</span></a>        <span class="p">}</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos"> 483</span></a>        <span class="k">if</span> <span class="s2">&quot;nblist_skin&quot;</span> <span class="ow">in</span> <span class="n">state</span><span class="p">:</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos"> 484</span></a>            <span class="n">graph_out</span><span class="p">[</span><span class="s2">&quot;edge_src_skin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">edge_src_skin</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos"> 485</span></a>            <span class="n">graph_out</span><span class="p">[</span><span class="s2">&quot;edge_dst_skin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">edge_dst_skin</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos"> 486</span></a>            <span class="k">if</span> <span class="s2">&quot;cells&quot;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos"> 487</span></a>                <span class="n">graph_out</span><span class="p">[</span><span class="s2">&quot;pbc_shifts_skin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pbc_shifts_skin</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos"> 488</span></a>
</span><span id="L-489"><a href="#L-489"><span class="linenos"> 489</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_space</span> <span class="ow">and</span> <span class="s2">&quot;cells&quot;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos"> 490</span></a>            <span class="k">if</span> <span class="s2">&quot;k_points&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">graph</span><span class="p">:</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos"> 491</span></a>                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos"> 492</span></a>                    <span class="s2">&quot;k_space generation not implemented on accelerator. Call the numpy routine (self.__call__) first.&quot;</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos"> 493</span></a>                <span class="p">)</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos"> 494</span></a>        <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">:</span> <span class="n">graph_out</span><span class="p">}</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos"> 495</span></a>
</span><span id="L-496"><a href="#L-496"><span class="linenos"> 496</span></a>    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos"> 497</span></a>    <span class="k">def</span> <span class="nf">update_skin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos"> 498</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;update the nblist without recomputing the full nblist&quot;&quot;&quot;</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos"> 499</span></a>        <span class="n">graph</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">]</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos"> 500</span></a>
</span><span id="L-501"><a href="#L-501"><span class="linenos"> 501</span></a>        <span class="n">edge_src_skin</span> <span class="o">=</span> <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;edge_src_skin&quot;</span><span class="p">]</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos"> 502</span></a>        <span class="n">edge_dst_skin</span> <span class="o">=</span> <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;edge_dst_skin&quot;</span><span class="p">]</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos"> 503</span></a>        <span class="n">coords</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;coordinates&quot;</span><span class="p">]</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos"> 504</span></a>        <span class="n">vec</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">edge_dst_skin</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos"> 505</span></a>            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos"> 506</span></a>        <span class="p">)</span> <span class="o">-</span> <span class="n">coords</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">edge_src_skin</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos"> 507</span></a>
</span><span id="L-508"><a href="#L-508"><span class="linenos"> 508</span></a>        <span class="k">if</span> <span class="s2">&quot;cells&quot;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos"> 509</span></a>            <span class="n">pbc_shifts_skin</span> <span class="o">=</span> <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;pbc_shifts_skin&quot;</span><span class="p">]</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos"> 510</span></a>            <span class="n">cells</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;cells&quot;</span><span class="p">]</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos"> 511</span></a>            <span class="k">if</span> <span class="n">cells</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos"> 512</span></a>                <span class="n">vec</span> <span class="o">=</span> <span class="n">vec</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pbc_shifts_skin</span><span class="p">,</span> <span class="n">cells</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos"> 513</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos"> 514</span></a>                <span class="n">batch_index_vec</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;batch_index&quot;</span><span class="p">][</span><span class="n">edge_src_skin</span><span class="p">]</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos"> 515</span></a>                <span class="n">vec</span> <span class="o">=</span> <span class="n">vec</span> <span class="o">+</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">)(</span><span class="n">pbc_shifts_skin</span><span class="p">,</span> <span class="n">cells</span><span class="p">[</span><span class="n">batch_index_vec</span><span class="p">])</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos"> 516</span></a>
</span><span id="L-517"><a href="#L-517"><span class="linenos"> 517</span></a>        <span class="n">nat</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos"> 518</span></a>        <span class="n">d12</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">vec</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos"> 519</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">d12</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="o">**</span><span class="mi">2</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos"> 520</span></a>        <span class="n">max_pairs</span> <span class="o">=</span> <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;edge_src&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos"> 521</span></a>        <span class="p">(</span><span class="n">edge_src</span><span class="p">,</span> <span class="n">edge_dst</span><span class="p">,</span> <span class="n">d12</span><span class="p">),</span> <span class="n">scatter_idx</span><span class="p">,</span> <span class="n">npairs</span> <span class="o">=</span> <span class="n">mask_filter_1d</span><span class="p">(</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos"> 522</span></a>            <span class="n">mask</span><span class="p">,</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos"> 523</span></a>            <span class="n">max_pairs</span><span class="p">,</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos"> 524</span></a>            <span class="p">(</span><span class="n">edge_src_skin</span><span class="p">,</span> <span class="n">nat</span><span class="p">),</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos"> 525</span></a>            <span class="p">(</span><span class="n">edge_dst_skin</span><span class="p">,</span> <span class="n">nat</span><span class="p">),</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos"> 526</span></a>            <span class="p">(</span><span class="n">d12</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos"> 527</span></a>        <span class="p">)</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos"> 528</span></a>        <span class="k">if</span> <span class="s2">&quot;cells&quot;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos"> 529</span></a>            <span class="n">pbc_shifts</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos"> 530</span></a>                <span class="n">jnp</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">max_pairs</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">pbc_shifts_skin</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos"> 531</span></a>                <span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">scatter_idx</span><span class="p">]</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos"> 532</span></a>                <span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">pbc_shifts_skin</span><span class="p">)</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos"> 533</span></a>            <span class="p">)</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos"> 534</span></a>
</span><span id="L-535"><a href="#L-535"><span class="linenos"> 535</span></a>        <span class="n">overflow</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;overflow&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">npairs</span> <span class="o">&gt;</span> <span class="n">max_pairs</span><span class="p">)</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos"> 536</span></a>        <span class="n">graph_out</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos"> 537</span></a>            <span class="o">**</span><span class="n">graph</span><span class="p">,</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos"> 538</span></a>            <span class="s2">&quot;edge_src&quot;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">edge_src</span><span class="p">,</span> <span class="n">edge_dst</span><span class="p">)),</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos"> 539</span></a>            <span class="s2">&quot;edge_dst&quot;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">edge_dst</span><span class="p">,</span> <span class="n">edge_src</span><span class="p">)),</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos"> 540</span></a>            <span class="s2">&quot;d12&quot;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">d12</span><span class="p">,</span> <span class="n">d12</span><span class="p">)),</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos"> 541</span></a>            <span class="s2">&quot;overflow&quot;</span><span class="p">:</span> <span class="n">overflow</span><span class="p">,</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos"> 542</span></a>        <span class="p">}</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos"> 543</span></a>        <span class="k">if</span> <span class="s2">&quot;cells&quot;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos"> 544</span></a>            <span class="n">graph_out</span><span class="p">[</span><span class="s2">&quot;pbc_shifts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">pbc_shifts</span><span class="p">,</span> <span class="o">-</span><span class="n">pbc_shifts</span><span class="p">))</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos"> 545</span></a>
</span><span id="L-546"><a href="#L-546"><span class="linenos"> 546</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_space</span> <span class="ow">and</span> <span class="s2">&quot;cells&quot;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos"> 547</span></a>            <span class="k">if</span> <span class="s2">&quot;k_points&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">graph</span><span class="p">:</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos"> 548</span></a>                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos"> 549</span></a>                    <span class="s2">&quot;k_space generation not implemented on accelerator. Call the numpy routine (self.__call__) first.&quot;</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos"> 550</span></a>                <span class="p">)</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos"> 551</span></a>
</span><span id="L-552"><a href="#L-552"><span class="linenos"> 552</span></a>        <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">:</span> <span class="n">graph_out</span><span class="p">}</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos"> 553</span></a>
</span><span id="L-554"><a href="#L-554"><span class="linenos"> 554</span></a>
</span><span id="L-555"><a href="#L-555"><span class="linenos"> 555</span></a><span class="k">class</span> <span class="nc">GraphProcessor</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos"> 556</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Process a pre-generated graph</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos"> 557</span></a>
</span><span id="L-558"><a href="#L-558"><span class="linenos"> 558</span></a><span class="sd">    The pre-generated graph should contain the following keys:</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos"> 559</span></a><span class="sd">    - edge_src: source indices of the edges</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos"> 560</span></a><span class="sd">    - edge_dst: destination indices of the edges</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos"> 561</span></a><span class="sd">    - pbcs_shifts: pbc shifts for the edges (only if `cells` are present in the inputs)</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos"> 562</span></a>
</span><span id="L-563"><a href="#L-563"><span class="linenos"> 563</span></a><span class="sd">    This module is automatically added to a FENNIX model when a GraphGenerator is used.</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos"> 564</span></a>
</span><span id="L-565"><a href="#L-565"><span class="linenos"> 565</span></a><span class="sd">    Parameters</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos"> 566</span></a><span class="sd">    ----------</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos"> 567</span></a><span class="sd">    cutoff : float</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos"> 568</span></a><span class="sd">        Cutoff distance for the graph.</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos"> 569</span></a><span class="sd">    graph_key : str</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos"> 570</span></a><span class="sd">        Key of the graph in the inputs.</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos"> 571</span></a><span class="sd">    switch_params : dict, default={}</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos"> 572</span></a><span class="sd">        Parameters for the switching function.</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos"> 573</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos"> 574</span></a>
</span><span id="L-575"><a href="#L-575"><span class="linenos"> 575</span></a>    <span class="n">cutoff</span><span class="p">:</span> <span class="nb">float</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos"> 576</span></a>    <span class="n">graph_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;graph&quot;</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos"> 577</span></a>    <span class="n">switch_params</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos"> 578</span></a>
</span><span id="L-579"><a href="#L-579"><span class="linenos"> 579</span></a>    <span class="nd">@nn</span><span class="o">.</span><span class="n">compact</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos"> 580</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]]):</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos"> 581</span></a>        <span class="n">graph</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">]</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos"> 582</span></a>        <span class="n">coords</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;coordinates&quot;</span><span class="p">]</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos"> 583</span></a>        <span class="n">edge_src</span><span class="p">,</span> <span class="n">edge_dst</span> <span class="o">=</span> <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;edge_src&quot;</span><span class="p">],</span> <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;edge_dst&quot;</span><span class="p">]</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos"> 584</span></a>        <span class="c1"># edge_mask = edge_src &lt; coords.shape[0]</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos"> 585</span></a>        <span class="n">vec</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">edge_dst</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">)</span> <span class="o">-</span> <span class="n">coords</span><span class="o">.</span><span class="n">at</span><span class="p">[</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos"> 586</span></a>            <span class="n">edge_src</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos"> 587</span></a>        <span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos"> 588</span></a>        <span class="k">if</span> <span class="s2">&quot;cells&quot;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos"> 589</span></a>            <span class="n">cells</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;cells&quot;</span><span class="p">]</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos"> 590</span></a>            <span class="k">if</span> <span class="n">cells</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos"> 591</span></a>                <span class="n">vec</span> <span class="o">=</span> <span class="n">vec</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">graph</span><span class="p">[</span><span class="s2">&quot;pbc_shifts&quot;</span><span class="p">],</span> <span class="n">cells</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos"> 592</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos"> 593</span></a>                <span class="n">batch_index_vec</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;batch_index&quot;</span><span class="p">][</span><span class="n">edge_src</span><span class="p">]</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos"> 594</span></a>                <span class="n">vec</span> <span class="o">=</span> <span class="n">vec</span> <span class="o">+</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">)(</span><span class="n">graph</span><span class="p">[</span><span class="s2">&quot;pbc_shifts&quot;</span><span class="p">],</span> <span class="n">cells</span><span class="p">[</span><span class="n">batch_index_vec</span><span class="p">])</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos"> 595</span></a>
</span><span id="L-596"><a href="#L-596"><span class="linenos"> 596</span></a>        <span class="n">distances</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos"> 597</span></a>        <span class="n">edge_mask</span> <span class="o">=</span> <span class="n">distances</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos"> 598</span></a>
</span><span id="L-599"><a href="#L-599"><span class="linenos"> 599</span></a>        <span class="n">switch</span> <span class="o">=</span> <span class="n">SwitchFunction</span><span class="p">(</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos"> 600</span></a>            <span class="o">**</span><span class="p">{</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">switch_params</span><span class="p">,</span> <span class="s2">&quot;cutoff&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">,</span> <span class="s2">&quot;graph_key&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos"> 601</span></a>        <span class="p">)((</span><span class="n">distances</span><span class="p">,</span> <span class="n">edge_mask</span><span class="p">))</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos"> 602</span></a>
</span><span id="L-603"><a href="#L-603"><span class="linenos"> 603</span></a>        <span class="n">graph_out</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos"> 604</span></a>            <span class="o">**</span><span class="n">graph</span><span class="p">,</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos"> 605</span></a>            <span class="s2">&quot;vec&quot;</span><span class="p">:</span> <span class="n">vec</span><span class="p">,</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos"> 606</span></a>            <span class="s2">&quot;distances&quot;</span><span class="p">:</span> <span class="n">distances</span><span class="p">,</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos"> 607</span></a>            <span class="s2">&quot;switch&quot;</span><span class="p">:</span> <span class="n">switch</span><span class="p">,</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos"> 608</span></a>            <span class="s2">&quot;edge_mask&quot;</span><span class="p">:</span> <span class="n">edge_mask</span><span class="p">,</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos"> 609</span></a>        <span class="p">}</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos"> 610</span></a>        <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">:</span> <span class="n">graph_out</span><span class="p">}</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos"> 611</span></a>
</span><span id="L-612"><a href="#L-612"><span class="linenos"> 612</span></a>
</span><span id="L-613"><a href="#L-613"><span class="linenos"> 613</span></a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos"> 614</span></a><span class="k">class</span> <span class="nc">GraphFilter</span><span class="p">:</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos"> 615</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Filter a graph based on a cutoff distance</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos"> 616</span></a>
</span><span id="L-617"><a href="#L-617"><span class="linenos"> 617</span></a><span class="sd">    Parameters</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos"> 618</span></a><span class="sd">    ----------</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos"> 619</span></a><span class="sd">    cutoff : float</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos"> 620</span></a><span class="sd">        Cutoff distance for the filtering.</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos"> 621</span></a><span class="sd">    parent_graph : str</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos"> 622</span></a><span class="sd">        Key of the parent graph in the inputs.</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos"> 623</span></a><span class="sd">    graph_key : str</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos"> 624</span></a><span class="sd">        Key of the filtered graph in the outputs.</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos"> 625</span></a><span class="sd">    remove_hydrogens : bool, default=False</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos"> 626</span></a><span class="sd">        Remove hydrogen atoms from the graph.</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos"> 627</span></a><span class="sd">    switch_params : dict, default={}</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos"> 628</span></a><span class="sd">        Parameters for the switching function.</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos"> 629</span></a><span class="sd">    k_space : bool, default=False</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos"> 630</span></a><span class="sd">        Generate k-space information for the graph.</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos"> 631</span></a><span class="sd">    kmax : int, default=30</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos"> 632</span></a><span class="sd">        Maximum number of k-points to consider.</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos"> 633</span></a><span class="sd">    kthr : float, default=1e-6</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos"> 634</span></a><span class="sd">        Threshold for k-point filtering.</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos"> 635</span></a><span class="sd">    mult_size : float, default=1.05</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos"> 636</span></a><span class="sd">        Multiplicative factor for resizing the nblist.</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos"> 637</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos"> 638</span></a>
</span><span id="L-639"><a href="#L-639"><span class="linenos"> 639</span></a>    <span class="n">cutoff</span><span class="p">:</span> <span class="nb">float</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos"> 640</span></a>    <span class="n">parent_graph</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos"> 641</span></a>    <span class="n">graph_key</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos"> 642</span></a>    <span class="n">remove_hydrogens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos"> 643</span></a>    <span class="n">switch_params</span><span class="p">:</span> <span class="n">FrozenDict</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">FrozenDict</span><span class="p">)</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos"> 644</span></a>    <span class="n">k_space</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos"> 645</span></a>    <span class="n">kmax</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos"> 646</span></a>    <span class="n">kthr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-6</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos"> 647</span></a>    <span class="n">mult_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.05</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos"> 648</span></a>
</span><span id="L-649"><a href="#L-649"><span class="linenos"> 649</span></a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos"> 650</span></a>        <span class="k">return</span> <span class="n">FrozenDict</span><span class="p">(</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos"> 651</span></a>            <span class="p">{</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos"> 652</span></a>                <span class="s2">&quot;npairs&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos"> 653</span></a>                <span class="s2">&quot;nblist_mult_size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mult_size</span><span class="p">,</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos"> 654</span></a>            <span class="p">}</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos"> 655</span></a>        <span class="p">)</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos"> 656</span></a>
</span><span id="L-657"><a href="#L-657"><span class="linenos"> 657</span></a>    <span class="k">def</span> <span class="nf">get_processor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]:</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos"> 658</span></a>        <span class="k">return</span> <span class="n">GraphFilterProcessor</span><span class="p">,</span> <span class="p">{</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos"> 659</span></a>            <span class="s2">&quot;cutoff&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">,</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos"> 660</span></a>            <span class="s2">&quot;graph_key&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">,</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos"> 661</span></a>            <span class="s2">&quot;parent_graph&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_graph</span><span class="p">,</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos"> 662</span></a>            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="si">}</span><span class="s2">_Filter_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_graph</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos"> 663</span></a>            <span class="s2">&quot;switch_params&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">switch_params</span><span class="p">,</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos"> 664</span></a>        <span class="p">}</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos"> 665</span></a>
</span><span id="L-666"><a href="#L-666"><span class="linenos"> 666</span></a>    <span class="k">def</span> <span class="nf">get_graph_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos"> 667</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos"> 668</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">:</span> <span class="p">{</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos"> 669</span></a>                <span class="s2">&quot;cutoff&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">,</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos"> 670</span></a>                <span class="s2">&quot;directed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos"> 671</span></a>                <span class="s2">&quot;parent_graph&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_graph</span><span class="p">,</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos"> 672</span></a>            <span class="p">}</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos"> 673</span></a>        <span class="p">}</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos"> 674</span></a>
</span><span id="L-675"><a href="#L-675"><span class="linenos"> 675</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">return_state_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_margin</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos"> 676</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;filter a nblist on cpu with numpy and dynamic shapes + store max shapes&quot;&quot;&quot;</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos"> 677</span></a>        <span class="n">graph_in</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_graph</span><span class="p">]</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos"> 678</span></a>        <span class="n">nat</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos"> 679</span></a>
</span><span id="L-680"><a href="#L-680"><span class="linenos"> 680</span></a>        <span class="n">new_state</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">state</span><span class="p">}</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos"> 681</span></a>        <span class="n">state_up</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos"> 682</span></a>
</span><span id="L-683"><a href="#L-683"><span class="linenos"> 683</span></a>        <span class="n">edge_src</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">graph_in</span><span class="p">[</span><span class="s2">&quot;edge_src&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos"> 684</span></a>        <span class="n">d12</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">graph_in</span><span class="p">[</span><span class="s2">&quot;d12&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos"> 685</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_hydrogens</span><span class="p">:</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos"> 686</span></a>            <span class="n">species</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">]</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos"> 687</span></a>            <span class="n">src_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">edge_src</span> <span class="o">&lt;</span> <span class="n">nat</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos"> 688</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">edge_src</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos"> 689</span></a>            <span class="n">mask</span><span class="p">[</span><span class="n">src_idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">species</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)[</span><span class="n">edge_src</span><span class="p">[</span><span class="n">src_idx</span><span class="p">]]</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos"> 690</span></a>            <span class="n">d12</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">d12</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos"> 691</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">d12</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="o">**</span><span class="mi">2</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos"> 692</span></a>
</span><span id="L-693"><a href="#L-693"><span class="linenos"> 693</span></a>        <span class="n">max_pairs</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;npairs&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos"> 694</span></a>        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">mask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos"> 695</span></a>        <span class="n">npairs</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos"> 696</span></a>        <span class="k">if</span> <span class="n">npairs</span> <span class="o">&gt;</span> <span class="n">max_pairs</span> <span class="ow">or</span> <span class="n">add_margin</span><span class="p">:</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos"> 697</span></a>            <span class="n">mult_size</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nblist_mult_size&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mult_size</span><span class="p">)</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos"> 698</span></a>            <span class="n">prev_max_pairs</span> <span class="o">=</span> <span class="n">max_pairs</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos"> 699</span></a>            <span class="n">max_pairs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mult_size</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">npairs</span><span class="p">,</span> <span class="n">max_pairs</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos"> 700</span></a>            <span class="n">state_up</span><span class="p">[</span><span class="s2">&quot;npairs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_pairs</span><span class="p">,</span> <span class="n">prev_max_pairs</span><span class="p">)</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos"> 701</span></a>            <span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;npairs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_pairs</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos"> 702</span></a>
</span><span id="L-703"><a href="#L-703"><span class="linenos"> 703</span></a>        <span class="n">filter_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">max_pairs</span><span class="p">,</span> <span class="n">edge_src</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos"> 704</span></a>        <span class="n">edge_src</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">max_pairs</span><span class="p">,</span> <span class="n">nat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos"> 705</span></a>        <span class="n">edge_dst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">max_pairs</span><span class="p">,</span> <span class="n">nat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos"> 706</span></a>        <span class="n">d12_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">max_pairs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos"> 707</span></a>        <span class="n">filter_indices</span><span class="p">[:</span><span class="n">npairs</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos"> 708</span></a>        <span class="n">edge_src</span><span class="p">[:</span><span class="n">npairs</span><span class="p">]</span> <span class="o">=</span> <span class="n">graph_in</span><span class="p">[</span><span class="s2">&quot;edge_src&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos"> 709</span></a>        <span class="n">edge_dst</span><span class="p">[:</span><span class="n">npairs</span><span class="p">]</span> <span class="o">=</span> <span class="n">graph_in</span><span class="p">[</span><span class="s2">&quot;edge_dst&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos"> 710</span></a>        <span class="n">d12_</span><span class="p">[:</span><span class="n">npairs</span><span class="p">]</span> <span class="o">=</span> <span class="n">d12</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos"> 711</span></a>        <span class="n">d12</span> <span class="o">=</span> <span class="n">d12_</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos"> 712</span></a>
</span><span id="L-713"><a href="#L-713"><span class="linenos"> 713</span></a>        <span class="n">graph</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span> <span class="ow">in</span> <span class="n">inputs</span> <span class="k">else</span> <span class="p">{}</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos"> 714</span></a>        <span class="n">graph_out</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos"> 715</span></a>            <span class="o">**</span><span class="n">graph</span><span class="p">,</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos"> 716</span></a>            <span class="s2">&quot;edge_src&quot;</span><span class="p">:</span> <span class="n">edge_src</span><span class="p">,</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos"> 717</span></a>            <span class="s2">&quot;edge_dst&quot;</span><span class="p">:</span> <span class="n">edge_dst</span><span class="p">,</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos"> 718</span></a>            <span class="s2">&quot;filter_indices&quot;</span><span class="p">:</span> <span class="n">filter_indices</span><span class="p">,</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos"> 719</span></a>            <span class="s2">&quot;d12&quot;</span><span class="p">:</span> <span class="n">d12</span><span class="p">,</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos"> 720</span></a>            <span class="s2">&quot;overflow&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos"> 721</span></a>        <span class="p">}</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos"> 722</span></a>
</span><span id="L-723"><a href="#L-723"><span class="linenos"> 723</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_space</span> <span class="ow">and</span> <span class="s2">&quot;cells&quot;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos"> 724</span></a>            <span class="k">if</span> <span class="s2">&quot;k_points&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">graph</span><span class="p">:</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos"> 725</span></a>                <span class="n">ks</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">bewald</span> <span class="o">=</span> <span class="n">get_reciprocal_space_parameters</span><span class="p">(</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos"> 726</span></a>                    <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;reciprocal_cells&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kthr</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos"> 727</span></a>                <span class="p">)</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos"> 728</span></a>            <span class="n">graph_out</span><span class="p">[</span><span class="s2">&quot;k_points&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ks</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos"> 729</span></a>            <span class="n">graph_out</span><span class="p">[</span><span class="s2">&quot;b_ewald&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bewald</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos"> 730</span></a>
</span><span id="L-731"><a href="#L-731"><span class="linenos"> 731</span></a>        <span class="n">output</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">:</span> <span class="n">graph_out</span><span class="p">}</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos"> 732</span></a>        <span class="k">if</span> <span class="n">return_state_update</span><span class="p">:</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos"> 733</span></a>            <span class="k">return</span> <span class="n">FrozenDict</span><span class="p">(</span><span class="n">new_state</span><span class="p">),</span> <span class="n">output</span><span class="p">,</span> <span class="n">state_up</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos"> 734</span></a>        <span class="k">return</span> <span class="n">FrozenDict</span><span class="p">(</span><span class="n">new_state</span><span class="p">),</span> <span class="n">output</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos"> 735</span></a>
</span><span id="L-736"><a href="#L-736"><span class="linenos"> 736</span></a>    <span class="k">def</span> <span class="nf">check_reallocate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">parent_overflow</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos"> 737</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;check for overflow and reallocate nblist if necessary&quot;&quot;&quot;</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos"> 738</span></a>        <span class="n">overflow</span> <span class="o">=</span> <span class="n">parent_overflow</span> <span class="ow">or</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;overflow&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos"> 739</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">overflow</span><span class="p">:</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos"> 740</span></a>            <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="p">{},</span> <span class="n">inputs</span><span class="p">,</span> <span class="kc">False</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos"> 741</span></a>
</span><span id="L-742"><a href="#L-742"><span class="linenos"> 742</span></a>        <span class="n">add_margin</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;overflow&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos"> 743</span></a>        <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">state_up</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos"> 744</span></a>            <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">return_state_update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">add_margin</span><span class="o">=</span><span class="n">add_margin</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos"> 745</span></a>        <span class="p">)</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos"> 746</span></a>        <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="n">state_up</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="kc">True</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos"> 747</span></a>
</span><span id="L-748"><a href="#L-748"><span class="linenos"> 748</span></a>    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos"> 749</span></a>    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos"> 750</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;filter a nblist on accelerator with jax and precomputed shapes&quot;&quot;&quot;</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos"> 751</span></a>        <span class="n">graph_in</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_graph</span><span class="p">]</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos"> 752</span></a>        <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos"> 753</span></a>            <span class="c1"># skin update mode</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos"> 754</span></a>            <span class="n">graph</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">]</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos"> 755</span></a>            <span class="n">max_pairs</span> <span class="o">=</span> <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;edge_src&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos"> 756</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos"> 757</span></a>            <span class="n">max_pairs</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;npairs&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos"> 758</span></a>
</span><span id="L-759"><a href="#L-759"><span class="linenos"> 759</span></a>        <span class="n">max_pairs_in</span> <span class="o">=</span> <span class="n">graph_in</span><span class="p">[</span><span class="s2">&quot;edge_src&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos"> 760</span></a>        <span class="n">nat</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos"> 761</span></a>
</span><span id="L-762"><a href="#L-762"><span class="linenos"> 762</span></a>        <span class="n">edge_src</span> <span class="o">=</span> <span class="n">graph_in</span><span class="p">[</span><span class="s2">&quot;edge_src&quot;</span><span class="p">]</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos"> 763</span></a>        <span class="n">d12</span> <span class="o">=</span> <span class="n">graph_in</span><span class="p">[</span><span class="s2">&quot;d12&quot;</span><span class="p">]</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos"> 764</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_hydrogens</span><span class="p">:</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos"> 765</span></a>            <span class="n">species</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">]</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos"> 766</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">species</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)[</span><span class="n">edge_src</span><span class="p">]</span>
</span><span id="L-767"><a href="#L-767"><span class="linenos"> 767</span></a>            <span class="n">d12</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">d12</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos"> 768</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">d12</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="o">**</span><span class="mi">2</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos"> 769</span></a>
</span><span id="L-770"><a href="#L-770"><span class="linenos"> 770</span></a>        <span class="p">(</span><span class="n">edge_src</span><span class="p">,</span> <span class="n">edge_dst</span><span class="p">,</span> <span class="n">d12</span><span class="p">,</span> <span class="n">filter_indices</span><span class="p">),</span> <span class="n">_</span><span class="p">,</span> <span class="n">npairs</span> <span class="o">=</span> <span class="n">mask_filter_1d</span><span class="p">(</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos"> 771</span></a>            <span class="n">mask</span><span class="p">,</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos"> 772</span></a>            <span class="n">max_pairs</span><span class="p">,</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos"> 773</span></a>            <span class="p">(</span><span class="n">edge_src</span><span class="p">,</span> <span class="n">nat</span><span class="p">),</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos"> 774</span></a>            <span class="p">(</span><span class="n">graph_in</span><span class="p">[</span><span class="s2">&quot;edge_dst&quot;</span><span class="p">],</span> <span class="n">nat</span><span class="p">),</span>
</span><span id="L-775"><a href="#L-775"><span class="linenos"> 775</span></a>            <span class="p">(</span><span class="n">d12</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos"> 776</span></a>            <span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">max_pairs_in</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">max_pairs_in</span><span class="p">),</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos"> 777</span></a>        <span class="p">)</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos"> 778</span></a>
</span><span id="L-779"><a href="#L-779"><span class="linenos"> 779</span></a>        <span class="n">graph</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span> <span class="ow">in</span> <span class="n">inputs</span> <span class="k">else</span> <span class="p">{}</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos"> 780</span></a>        <span class="n">overflow</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;overflow&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">npairs</span> <span class="o">&gt;</span> <span class="n">max_pairs</span><span class="p">)</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos"> 781</span></a>        <span class="n">graph_out</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos"> 782</span></a>            <span class="o">**</span><span class="n">graph</span><span class="p">,</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos"> 783</span></a>            <span class="s2">&quot;edge_src&quot;</span><span class="p">:</span> <span class="n">edge_src</span><span class="p">,</span>
</span><span id="L-784"><a href="#L-784"><span class="linenos"> 784</span></a>            <span class="s2">&quot;edge_dst&quot;</span><span class="p">:</span> <span class="n">edge_dst</span><span class="p">,</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos"> 785</span></a>            <span class="s2">&quot;filter_indices&quot;</span><span class="p">:</span> <span class="n">filter_indices</span><span class="p">,</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos"> 786</span></a>            <span class="s2">&quot;d12&quot;</span><span class="p">:</span> <span class="n">d12</span><span class="p">,</span>
</span><span id="L-787"><a href="#L-787"><span class="linenos"> 787</span></a>            <span class="s2">&quot;overflow&quot;</span><span class="p">:</span> <span class="n">overflow</span><span class="p">,</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos"> 788</span></a>        <span class="p">}</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos"> 789</span></a>
</span><span id="L-790"><a href="#L-790"><span class="linenos"> 790</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_space</span> <span class="ow">and</span> <span class="s2">&quot;cells&quot;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos"> 791</span></a>            <span class="k">if</span> <span class="s2">&quot;k_points&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">graph</span><span class="p">:</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos"> 792</span></a>                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
</span><span id="L-793"><a href="#L-793"><span class="linenos"> 793</span></a>                    <span class="s2">&quot;k_space generation not implemented on accelerator. Call the numpy routine (self.__call__) first.&quot;</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos"> 794</span></a>                <span class="p">)</span>
</span><span id="L-795"><a href="#L-795"><span class="linenos"> 795</span></a>
</span><span id="L-796"><a href="#L-796"><span class="linenos"> 796</span></a>        <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">:</span> <span class="n">graph_out</span><span class="p">}</span>
</span><span id="L-797"><a href="#L-797"><span class="linenos"> 797</span></a>
</span><span id="L-798"><a href="#L-798"><span class="linenos"> 798</span></a>    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
</span><span id="L-799"><a href="#L-799"><span class="linenos"> 799</span></a>    <span class="k">def</span> <span class="nf">update_skin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
</span><span id="L-800"><a href="#L-800"><span class="linenos"> 800</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>
</span><span id="L-801"><a href="#L-801"><span class="linenos"> 801</span></a>
</span><span id="L-802"><a href="#L-802"><span class="linenos"> 802</span></a>
</span><span id="L-803"><a href="#L-803"><span class="linenos"> 803</span></a><span class="k">class</span> <span class="nc">GraphFilterProcessor</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="L-804"><a href="#L-804"><span class="linenos"> 804</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Filter processing for a pre-generated graph</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos"> 805</span></a>
</span><span id="L-806"><a href="#L-806"><span class="linenos"> 806</span></a><span class="sd">    This module is automatically added to a FENNIX model when a GraphFilter is used.</span>
</span><span id="L-807"><a href="#L-807"><span class="linenos"> 807</span></a>
</span><span id="L-808"><a href="#L-808"><span class="linenos"> 808</span></a><span class="sd">    Parameters</span>
</span><span id="L-809"><a href="#L-809"><span class="linenos"> 809</span></a><span class="sd">    ----------</span>
</span><span id="L-810"><a href="#L-810"><span class="linenos"> 810</span></a><span class="sd">    cutoff : float</span>
</span><span id="L-811"><a href="#L-811"><span class="linenos"> 811</span></a><span class="sd">        Cutoff distance for the filtering.</span>
</span><span id="L-812"><a href="#L-812"><span class="linenos"> 812</span></a><span class="sd">    graph_key : str</span>
</span><span id="L-813"><a href="#L-813"><span class="linenos"> 813</span></a><span class="sd">        Key of the filtered graph in the inputs.</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos"> 814</span></a><span class="sd">    parent_graph : str</span>
</span><span id="L-815"><a href="#L-815"><span class="linenos"> 815</span></a><span class="sd">        Key of the parent graph in the inputs.</span>
</span><span id="L-816"><a href="#L-816"><span class="linenos"> 816</span></a><span class="sd">    switch_params : dict, default={}</span>
</span><span id="L-817"><a href="#L-817"><span class="linenos"> 817</span></a><span class="sd">        Parameters for the switching function.</span>
</span><span id="L-818"><a href="#L-818"><span class="linenos"> 818</span></a>
</span><span id="L-819"><a href="#L-819"><span class="linenos"> 819</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos"> 820</span></a>
</span><span id="L-821"><a href="#L-821"><span class="linenos"> 821</span></a>    <span class="n">cutoff</span><span class="p">:</span> <span class="nb">float</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos"> 822</span></a>    <span class="n">graph_key</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="L-823"><a href="#L-823"><span class="linenos"> 823</span></a>    <span class="n">parent_graph</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos"> 824</span></a>    <span class="n">switch_params</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
</span><span id="L-825"><a href="#L-825"><span class="linenos"> 825</span></a>
</span><span id="L-826"><a href="#L-826"><span class="linenos"> 826</span></a>    <span class="nd">@nn</span><span class="o">.</span><span class="n">compact</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos"> 827</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]]):</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos"> 828</span></a>        <span class="n">graph_in</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_graph</span><span class="p">]</span>
</span><span id="L-829"><a href="#L-829"><span class="linenos"> 829</span></a>        <span class="n">graph</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">]</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos"> 830</span></a>
</span><span id="L-831"><a href="#L-831"><span class="linenos"> 831</span></a>        <span class="k">if</span> <span class="n">graph_in</span><span class="p">[</span><span class="s2">&quot;vec&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-832"><a href="#L-832"><span class="linenos"> 832</span></a>            <span class="n">vec</span> <span class="o">=</span> <span class="n">graph_in</span><span class="p">[</span><span class="s2">&quot;vec&quot;</span><span class="p">]</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos"> 833</span></a>            <span class="n">distances</span> <span class="o">=</span> <span class="n">graph_in</span><span class="p">[</span><span class="s2">&quot;distances&quot;</span><span class="p">]</span>
</span><span id="L-834"><a href="#L-834"><span class="linenos"> 834</span></a>            <span class="n">filter_indices</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos"> 835</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-836"><a href="#L-836"><span class="linenos"> 836</span></a>            <span class="n">filter_indices</span> <span class="o">=</span> <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;filter_indices&quot;</span><span class="p">]</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos"> 837</span></a>            <span class="n">vec</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-838"><a href="#L-838"><span class="linenos"> 838</span></a>                <span class="n">graph_in</span><span class="p">[</span><span class="s2">&quot;vec&quot;</span><span class="p">]</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos"> 839</span></a>                <span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">filter_indices</span><span class="p">]</span>
</span><span id="L-840"><a href="#L-840"><span class="linenos"> 840</span></a>                <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">)</span>
</span><span id="L-841"><a href="#L-841"><span class="linenos"> 841</span></a>            <span class="p">)</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos"> 842</span></a>            <span class="n">distances</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos"> 843</span></a>                <span class="n">graph_in</span><span class="p">[</span><span class="s2">&quot;distances&quot;</span><span class="p">]</span>
</span><span id="L-844"><a href="#L-844"><span class="linenos"> 844</span></a>                <span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">filter_indices</span><span class="p">]</span>
</span><span id="L-845"><a href="#L-845"><span class="linenos"> 845</span></a>                <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">)</span>
</span><span id="L-846"><a href="#L-846"><span class="linenos"> 846</span></a>            <span class="p">)</span>
</span><span id="L-847"><a href="#L-847"><span class="linenos"> 847</span></a>
</span><span id="L-848"><a href="#L-848"><span class="linenos"> 848</span></a>        <span class="n">edge_mask</span> <span class="o">=</span> <span class="n">distances</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos"> 849</span></a>        <span class="n">switch</span> <span class="o">=</span> <span class="n">SwitchFunction</span><span class="p">(</span>
</span><span id="L-850"><a href="#L-850"><span class="linenos"> 850</span></a>            <span class="o">**</span><span class="p">{</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">switch_params</span><span class="p">,</span> <span class="s2">&quot;cutoff&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">,</span> <span class="s2">&quot;graph_key&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
</span><span id="L-851"><a href="#L-851"><span class="linenos"> 851</span></a>        <span class="p">)((</span><span class="n">distances</span><span class="p">,</span> <span class="n">edge_mask</span><span class="p">))</span>
</span><span id="L-852"><a href="#L-852"><span class="linenos"> 852</span></a>
</span><span id="L-853"><a href="#L-853"><span class="linenos"> 853</span></a>        <span class="n">graph_out</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-854"><a href="#L-854"><span class="linenos"> 854</span></a>            <span class="o">**</span><span class="n">graph</span><span class="p">,</span>
</span><span id="L-855"><a href="#L-855"><span class="linenos"> 855</span></a>            <span class="s2">&quot;vec&quot;</span><span class="p">:</span> <span class="n">vec</span><span class="p">,</span>
</span><span id="L-856"><a href="#L-856"><span class="linenos"> 856</span></a>            <span class="s2">&quot;distances&quot;</span><span class="p">:</span> <span class="n">distances</span><span class="p">,</span>
</span><span id="L-857"><a href="#L-857"><span class="linenos"> 857</span></a>            <span class="s2">&quot;switch&quot;</span><span class="p">:</span> <span class="n">switch</span><span class="p">,</span>
</span><span id="L-858"><a href="#L-858"><span class="linenos"> 858</span></a>            <span class="s2">&quot;filter_indices&quot;</span><span class="p">:</span> <span class="n">filter_indices</span><span class="p">,</span>
</span><span id="L-859"><a href="#L-859"><span class="linenos"> 859</span></a>            <span class="s2">&quot;edge_mask&quot;</span><span class="p">:</span> <span class="n">edge_mask</span><span class="p">,</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos"> 860</span></a>        <span class="p">}</span>
</span><span id="L-861"><a href="#L-861"><span class="linenos"> 861</span></a>        <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">:</span> <span class="n">graph_out</span><span class="p">}</span>
</span><span id="L-862"><a href="#L-862"><span class="linenos"> 862</span></a>
</span><span id="L-863"><a href="#L-863"><span class="linenos"> 863</span></a>
</span><span id="L-864"><a href="#L-864"><span class="linenos"> 864</span></a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-865"><a href="#L-865"><span class="linenos"> 865</span></a><span class="k">class</span> <span class="nc">GraphAngularExtension</span><span class="p">:</span>
</span><span id="L-866"><a href="#L-866"><span class="linenos"> 866</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Add angles list to a graph</span>
</span><span id="L-867"><a href="#L-867"><span class="linenos"> 867</span></a>
</span><span id="L-868"><a href="#L-868"><span class="linenos"> 868</span></a><span class="sd">    Parameters</span>
</span><span id="L-869"><a href="#L-869"><span class="linenos"> 869</span></a><span class="sd">    ----------</span>
</span><span id="L-870"><a href="#L-870"><span class="linenos"> 870</span></a><span class="sd">    mult_size : float, default=1.05</span>
</span><span id="L-871"><a href="#L-871"><span class="linenos"> 871</span></a><span class="sd">        Multiplicative factor for resizing the nblist.</span>
</span><span id="L-872"><a href="#L-872"><span class="linenos"> 872</span></a><span class="sd">    add_neigh : int, default=5</span>
</span><span id="L-873"><a href="#L-873"><span class="linenos"> 873</span></a><span class="sd">        Additional neighbors to add to the nblist when resizing.</span>
</span><span id="L-874"><a href="#L-874"><span class="linenos"> 874</span></a><span class="sd">    graph_key : str, default=&quot;graph&quot;</span>
</span><span id="L-875"><a href="#L-875"><span class="linenos"> 875</span></a><span class="sd">        Key of the graph in the inputs.</span>
</span><span id="L-876"><a href="#L-876"><span class="linenos"> 876</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-877"><a href="#L-877"><span class="linenos"> 877</span></a>
</span><span id="L-878"><a href="#L-878"><span class="linenos"> 878</span></a>    <span class="n">mult_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.05</span>
</span><span id="L-879"><a href="#L-879"><span class="linenos"> 879</span></a>    <span class="n">add_neigh</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span>
</span><span id="L-880"><a href="#L-880"><span class="linenos"> 880</span></a>    <span class="n">graph_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;graph&quot;</span>
</span><span id="L-881"><a href="#L-881"><span class="linenos"> 881</span></a>
</span><span id="L-882"><a href="#L-882"><span class="linenos"> 882</span></a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-883"><a href="#L-883"><span class="linenos"> 883</span></a>        <span class="k">return</span> <span class="n">FrozenDict</span><span class="p">(</span>
</span><span id="L-884"><a href="#L-884"><span class="linenos"> 884</span></a>            <span class="p">{</span>
</span><span id="L-885"><a href="#L-885"><span class="linenos"> 885</span></a>                <span class="s2">&quot;nangles&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="L-886"><a href="#L-886"><span class="linenos"> 886</span></a>                <span class="s2">&quot;nblist_mult_size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mult_size</span><span class="p">,</span>
</span><span id="L-887"><a href="#L-887"><span class="linenos"> 887</span></a>                <span class="s2">&quot;max_neigh&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_neigh</span><span class="p">,</span>
</span><span id="L-888"><a href="#L-888"><span class="linenos"> 888</span></a>                <span class="s2">&quot;add_neigh&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_neigh</span><span class="p">,</span>
</span><span id="L-889"><a href="#L-889"><span class="linenos"> 889</span></a>            <span class="p">}</span>
</span><span id="L-890"><a href="#L-890"><span class="linenos"> 890</span></a>        <span class="p">)</span>
</span><span id="L-891"><a href="#L-891"><span class="linenos"> 891</span></a>
</span><span id="L-892"><a href="#L-892"><span class="linenos"> 892</span></a>    <span class="k">def</span> <span class="nf">get_processor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]:</span>
</span><span id="L-893"><a href="#L-893"><span class="linenos"> 893</span></a>        <span class="k">return</span> <span class="n">GraphAngleProcessor</span><span class="p">,</span> <span class="p">{</span>
</span><span id="L-894"><a href="#L-894"><span class="linenos"> 894</span></a>            <span class="s2">&quot;graph_key&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">,</span>
</span><span id="L-895"><a href="#L-895"><span class="linenos"> 895</span></a>            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="si">}</span><span class="s2">_AngleProcessor&quot;</span><span class="p">,</span>
</span><span id="L-896"><a href="#L-896"><span class="linenos"> 896</span></a>        <span class="p">}</span>
</span><span id="L-897"><a href="#L-897"><span class="linenos"> 897</span></a>
</span><span id="L-898"><a href="#L-898"><span class="linenos"> 898</span></a>    <span class="k">def</span> <span class="nf">get_graph_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-899"><a href="#L-899"><span class="linenos"> 899</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="L-900"><a href="#L-900"><span class="linenos"> 900</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">:</span> <span class="p">{</span>
</span><span id="L-901"><a href="#L-901"><span class="linenos"> 901</span></a>                <span class="s2">&quot;has_angles&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-902"><a href="#L-902"><span class="linenos"> 902</span></a>            <span class="p">}</span>
</span><span id="L-903"><a href="#L-903"><span class="linenos"> 903</span></a>        <span class="p">}</span>
</span><span id="L-904"><a href="#L-904"><span class="linenos"> 904</span></a>
</span><span id="L-905"><a href="#L-905"><span class="linenos"> 905</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">return_state_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_margin</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-906"><a href="#L-906"><span class="linenos"> 906</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;build angle nblist on cpu with numpy and dynamic shapes + store max shapes&quot;&quot;&quot;</span>
</span><span id="L-907"><a href="#L-907"><span class="linenos"> 907</span></a>        <span class="n">graph</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">]</span>
</span><span id="L-908"><a href="#L-908"><span class="linenos"> 908</span></a>        <span class="n">edge_src</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">graph</span><span class="p">[</span><span class="s2">&quot;edge_src&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="L-909"><a href="#L-909"><span class="linenos"> 909</span></a>
</span><span id="L-910"><a href="#L-910"><span class="linenos"> 910</span></a>        <span class="n">new_state</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">state</span><span class="p">}</span>
</span><span id="L-911"><a href="#L-911"><span class="linenos"> 911</span></a>        <span class="n">state_up</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-912"><a href="#L-912"><span class="linenos"> 912</span></a>
</span><span id="L-913"><a href="#L-913"><span class="linenos"> 913</span></a>        <span class="c1">### count number of neighbors</span>
</span><span id="L-914"><a href="#L-914"><span class="linenos"> 914</span></a>        <span class="n">nat</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-915"><a href="#L-915"><span class="linenos"> 915</span></a>        <span class="n">count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nat</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="L-916"><a href="#L-916"><span class="linenos"> 916</span></a>        <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">edge_src</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-917"><a href="#L-917"><span class="linenos"> 917</span></a>        <span class="n">max_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">count</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-918"><a href="#L-918"><span class="linenos"> 918</span></a>
</span><span id="L-919"><a href="#L-919"><span class="linenos"> 919</span></a>        <span class="c1">### get sizes</span>
</span><span id="L-920"><a href="#L-920"><span class="linenos"> 920</span></a>        <span class="n">max_neigh</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_neigh&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_neigh</span><span class="p">)</span>
</span><span id="L-921"><a href="#L-921"><span class="linenos"> 921</span></a>        <span class="n">nedge</span> <span class="o">=</span> <span class="n">edge_src</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-922"><a href="#L-922"><span class="linenos"> 922</span></a>        <span class="k">if</span> <span class="n">max_count</span> <span class="o">&gt;</span> <span class="n">max_neigh</span> <span class="ow">or</span> <span class="n">add_margin</span><span class="p">:</span>
</span><span id="L-923"><a href="#L-923"><span class="linenos"> 923</span></a>            <span class="n">prev_max_neigh</span> <span class="o">=</span> <span class="n">max_neigh</span>
</span><span id="L-924"><a href="#L-924"><span class="linenos"> 924</span></a>            <span class="n">max_neigh</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_count</span><span class="p">,</span> <span class="n">max_neigh</span><span class="p">)</span> <span class="o">+</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span id="L-925"><a href="#L-925"><span class="linenos"> 925</span></a>                <span class="s2">&quot;add_neigh&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_neigh</span>
</span><span id="L-926"><a href="#L-926"><span class="linenos"> 926</span></a>            <span class="p">)</span>
</span><span id="L-927"><a href="#L-927"><span class="linenos"> 927</span></a>            <span class="n">state_up</span><span class="p">[</span><span class="s2">&quot;max_neigh&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_neigh</span><span class="p">,</span> <span class="n">prev_max_neigh</span><span class="p">)</span>
</span><span id="L-928"><a href="#L-928"><span class="linenos"> 928</span></a>            <span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;max_neigh&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_neigh</span>
</span><span id="L-929"><a href="#L-929"><span class="linenos"> 929</span></a>
</span><span id="L-930"><a href="#L-930"><span class="linenos"> 930</span></a>        <span class="n">max_neigh_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">max_neigh</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
</span><span id="L-931"><a href="#L-931"><span class="linenos"> 931</span></a>
</span><span id="L-932"><a href="#L-932"><span class="linenos"> 932</span></a>        <span class="n">nedge</span> <span class="o">=</span> <span class="n">edge_src</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-933"><a href="#L-933"><span class="linenos"> 933</span></a>
</span><span id="L-934"><a href="#L-934"><span class="linenos"> 934</span></a>        <span class="c1">### sort edge_src</span>
</span><span id="L-935"><a href="#L-935"><span class="linenos"> 935</span></a>        <span class="n">idx_sort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">edge_src</span><span class="p">)</span>
</span><span id="L-936"><a href="#L-936"><span class="linenos"> 936</span></a>        <span class="n">edge_src_sorted</span> <span class="o">=</span> <span class="n">edge_src</span><span class="p">[</span><span class="n">idx_sort</span><span class="p">]</span>
</span><span id="L-937"><a href="#L-937"><span class="linenos"> 937</span></a>
</span><span id="L-938"><a href="#L-938"><span class="linenos"> 938</span></a>        <span class="c1">### map sparse to dense nblist</span>
</span><span id="L-939"><a href="#L-939"><span class="linenos"> 939</span></a>        <span class="n">offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">max_count</span><span class="p">),</span> <span class="n">nat</span><span class="p">)</span>
</span><span id="L-940"><a href="#L-940"><span class="linenos"> 940</span></a>        <span class="k">if</span> <span class="n">max_count</span> <span class="o">*</span> <span class="n">nat</span> <span class="o">&gt;=</span> <span class="n">nedge</span><span class="p">:</span>
</span><span id="L-941"><a href="#L-941"><span class="linenos"> 941</span></a>            <span class="n">offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">max_count</span><span class="p">),</span> <span class="n">nat</span><span class="p">)[:</span><span class="n">nedge</span><span class="p">]</span>
</span><span id="L-942"><a href="#L-942"><span class="linenos"> 942</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-943"><a href="#L-943"><span class="linenos"> 943</span></a>            <span class="n">offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nedge</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="L-944"><a href="#L-944"><span class="linenos"> 944</span></a>            <span class="n">offset</span><span class="p">[:</span> <span class="n">max_count</span> <span class="o">*</span> <span class="n">nat</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">max_count</span><span class="p">),</span> <span class="n">nat</span><span class="p">)</span>
</span><span id="L-945"><a href="#L-945"><span class="linenos"> 945</span></a>
</span><span id="L-946"><a href="#L-946"><span class="linenos"> 946</span></a>        <span class="c1"># offset = jnp.where(edge_src_sorted &lt; nat, offset, 0)</span>
</span><span id="L-947"><a href="#L-947"><span class="linenos"> 947</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">edge_src_sorted</span> <span class="o">&lt;</span> <span class="n">nat</span>
</span><span id="L-948"><a href="#L-948"><span class="linenos"> 948</span></a>        <span class="n">indices</span> <span class="o">=</span> <span class="n">edge_src_sorted</span> <span class="o">*</span> <span class="n">max_count</span> <span class="o">+</span> <span class="n">offset</span>
</span><span id="L-949"><a href="#L-949"><span class="linenos"> 949</span></a>        <span class="n">indices</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
</span><span id="L-950"><a href="#L-950"><span class="linenos"> 950</span></a>        <span class="n">idx_sort</span> <span class="o">=</span> <span class="n">idx_sort</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
</span><span id="L-951"><a href="#L-951"><span class="linenos"> 951</span></a>        <span class="n">edge_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">nat</span> <span class="o">*</span> <span class="n">max_count</span><span class="p">,</span> <span class="n">nedge</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="L-952"><a href="#L-952"><span class="linenos"> 952</span></a>        <span class="n">edge_idx</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx_sort</span>
</span><span id="L-953"><a href="#L-953"><span class="linenos"> 953</span></a>        <span class="n">edge_idx</span> <span class="o">=</span> <span class="n">edge_idx</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nat</span><span class="p">,</span> <span class="n">max_count</span><span class="p">)</span>
</span><span id="L-954"><a href="#L-954"><span class="linenos"> 954</span></a>
</span><span id="L-955"><a href="#L-955"><span class="linenos"> 955</span></a>        <span class="c1">### find all triplet for each atom center</span>
</span><span id="L-956"><a href="#L-956"><span class="linenos"> 956</span></a>        <span class="n">local_src</span><span class="p">,</span> <span class="n">local_dst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">triu_indices</span><span class="p">(</span><span class="n">max_count</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-957"><a href="#L-957"><span class="linenos"> 957</span></a>        <span class="n">angle_src</span> <span class="o">=</span> <span class="n">edge_idx</span><span class="p">[:,</span> <span class="n">local_src</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="L-958"><a href="#L-958"><span class="linenos"> 958</span></a>        <span class="n">angle_dst</span> <span class="o">=</span> <span class="n">edge_idx</span><span class="p">[:,</span> <span class="n">local_dst</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="L-959"><a href="#L-959"><span class="linenos"> 959</span></a>
</span><span id="L-960"><a href="#L-960"><span class="linenos"> 960</span></a>        <span class="c1">### mask for valid angles</span>
</span><span id="L-961"><a href="#L-961"><span class="linenos"> 961</span></a>        <span class="n">mask1</span> <span class="o">=</span> <span class="n">angle_src</span> <span class="o">&lt;</span> <span class="n">nedge</span>
</span><span id="L-962"><a href="#L-962"><span class="linenos"> 962</span></a>        <span class="n">mask2</span> <span class="o">=</span> <span class="n">angle_dst</span> <span class="o">&lt;</span> <span class="n">nedge</span>
</span><span id="L-963"><a href="#L-963"><span class="linenos"> 963</span></a>        <span class="n">angle_mask</span> <span class="o">=</span> <span class="n">mask1</span> <span class="o">&amp;</span> <span class="n">mask2</span>
</span><span id="L-964"><a href="#L-964"><span class="linenos"> 964</span></a>
</span><span id="L-965"><a href="#L-965"><span class="linenos"> 965</span></a>        <span class="n">max_angles</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nangles&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-966"><a href="#L-966"><span class="linenos"> 966</span></a>        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">angle_mask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-967"><a href="#L-967"><span class="linenos"> 967</span></a>        <span class="n">nangles</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-968"><a href="#L-968"><span class="linenos"> 968</span></a>        <span class="k">if</span> <span class="n">nangles</span> <span class="o">&gt;</span> <span class="n">max_angles</span> <span class="ow">or</span> <span class="n">add_margin</span><span class="p">:</span>
</span><span id="L-969"><a href="#L-969"><span class="linenos"> 969</span></a>            <span class="n">mult_size</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nblist_mult_size&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mult_size</span><span class="p">)</span>
</span><span id="L-970"><a href="#L-970"><span class="linenos"> 970</span></a>            <span class="n">max_angles_prev</span> <span class="o">=</span> <span class="n">max_angles</span>
</span><span id="L-971"><a href="#L-971"><span class="linenos"> 971</span></a>            <span class="n">max_angles</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mult_size</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">nangles</span><span class="p">,</span> <span class="n">max_angles</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="L-972"><a href="#L-972"><span class="linenos"> 972</span></a>            <span class="n">state_up</span><span class="p">[</span><span class="s2">&quot;nangles&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_angles</span><span class="p">,</span> <span class="n">max_angles_prev</span><span class="p">)</span>
</span><span id="L-973"><a href="#L-973"><span class="linenos"> 973</span></a>            <span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;nangles&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_angles</span>
</span><span id="L-974"><a href="#L-974"><span class="linenos"> 974</span></a>
</span><span id="L-975"><a href="#L-975"><span class="linenos"> 975</span></a>        <span class="c1">## filter angles to sparse representation</span>
</span><span id="L-976"><a href="#L-976"><span class="linenos"> 976</span></a>        <span class="n">angle_src_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">max_angles</span><span class="p">,</span> <span class="n">nedge</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="L-977"><a href="#L-977"><span class="linenos"> 977</span></a>        <span class="n">angle_dst_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">max_angles</span><span class="p">,</span> <span class="n">nedge</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="L-978"><a href="#L-978"><span class="linenos"> 978</span></a>        <span class="n">angle_src_</span><span class="p">[:</span><span class="n">nangles</span><span class="p">]</span> <span class="o">=</span> <span class="n">angle_src</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="L-979"><a href="#L-979"><span class="linenos"> 979</span></a>        <span class="n">angle_dst_</span><span class="p">[:</span><span class="n">nangles</span><span class="p">]</span> <span class="o">=</span> <span class="n">angle_dst</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="L-980"><a href="#L-980"><span class="linenos"> 980</span></a>
</span><span id="L-981"><a href="#L-981"><span class="linenos"> 981</span></a>        <span class="n">central_atom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">max_angles</span><span class="p">,</span> <span class="n">nat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="L-982"><a href="#L-982"><span class="linenos"> 982</span></a>        <span class="n">central_atom</span><span class="p">[:</span><span class="n">nangles</span><span class="p">]</span> <span class="o">=</span> <span class="n">edge_src</span><span class="p">[</span><span class="n">angle_src_</span><span class="p">[:</span><span class="n">nangles</span><span class="p">]]</span>
</span><span id="L-983"><a href="#L-983"><span class="linenos"> 983</span></a>
</span><span id="L-984"><a href="#L-984"><span class="linenos"> 984</span></a>        <span class="c1">## update graph</span>
</span><span id="L-985"><a href="#L-985"><span class="linenos"> 985</span></a>        <span class="n">output</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-986"><a href="#L-986"><span class="linenos"> 986</span></a>            <span class="o">**</span><span class="n">inputs</span><span class="p">,</span>
</span><span id="L-987"><a href="#L-987"><span class="linenos"> 987</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">:</span> <span class="p">{</span>
</span><span id="L-988"><a href="#L-988"><span class="linenos"> 988</span></a>                <span class="o">**</span><span class="n">graph</span><span class="p">,</span>
</span><span id="L-989"><a href="#L-989"><span class="linenos"> 989</span></a>                <span class="s2">&quot;angle_src&quot;</span><span class="p">:</span> <span class="n">angle_src_</span><span class="p">,</span>
</span><span id="L-990"><a href="#L-990"><span class="linenos"> 990</span></a>                <span class="s2">&quot;angle_dst&quot;</span><span class="p">:</span> <span class="n">angle_dst_</span><span class="p">,</span>
</span><span id="L-991"><a href="#L-991"><span class="linenos"> 991</span></a>                <span class="s2">&quot;central_atom&quot;</span><span class="p">:</span> <span class="n">central_atom</span><span class="p">,</span>
</span><span id="L-992"><a href="#L-992"><span class="linenos"> 992</span></a>                <span class="s2">&quot;angle_overflow&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-993"><a href="#L-993"><span class="linenos"> 993</span></a>                <span class="s2">&quot;max_neigh&quot;</span><span class="p">:</span> <span class="n">max_neigh</span><span class="p">,</span>
</span><span id="L-994"><a href="#L-994"><span class="linenos"> 994</span></a>                <span class="s2">&quot;__max_neigh_array&quot;</span><span class="p">:</span> <span class="n">max_neigh_arr</span><span class="p">,</span>
</span><span id="L-995"><a href="#L-995"><span class="linenos"> 995</span></a>            <span class="p">},</span>
</span><span id="L-996"><a href="#L-996"><span class="linenos"> 996</span></a>        <span class="p">}</span>
</span><span id="L-997"><a href="#L-997"><span class="linenos"> 997</span></a>
</span><span id="L-998"><a href="#L-998"><span class="linenos"> 998</span></a>        <span class="k">if</span> <span class="n">return_state_update</span><span class="p">:</span>
</span><span id="L-999"><a href="#L-999"><span class="linenos"> 999</span></a>            <span class="k">return</span> <span class="n">FrozenDict</span><span class="p">(</span><span class="n">new_state</span><span class="p">),</span> <span class="n">output</span><span class="p">,</span> <span class="n">state_up</span>
</span><span id="L-1000"><a href="#L-1000"><span class="linenos">1000</span></a>        <span class="k">return</span> <span class="n">FrozenDict</span><span class="p">(</span><span class="n">new_state</span><span class="p">),</span> <span class="n">output</span>
</span><span id="L-1001"><a href="#L-1001"><span class="linenos">1001</span></a>
</span><span id="L-1002"><a href="#L-1002"><span class="linenos">1002</span></a>    <span class="k">def</span> <span class="nf">check_reallocate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">parent_overflow</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-1003"><a href="#L-1003"><span class="linenos">1003</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;check for overflow and reallocate nblist if necessary&quot;&quot;&quot;</span>
</span><span id="L-1004"><a href="#L-1004"><span class="linenos">1004</span></a>        <span class="n">overflow</span> <span class="o">=</span> <span class="n">parent_overflow</span> <span class="ow">or</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">][</span><span class="s2">&quot;angle_overflow&quot;</span><span class="p">]</span>
</span><span id="L-1005"><a href="#L-1005"><span class="linenos">1005</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">overflow</span><span class="p">:</span>
</span><span id="L-1006"><a href="#L-1006"><span class="linenos">1006</span></a>            <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="p">{},</span> <span class="n">inputs</span><span class="p">,</span> <span class="kc">False</span>
</span><span id="L-1007"><a href="#L-1007"><span class="linenos">1007</span></a>
</span><span id="L-1008"><a href="#L-1008"><span class="linenos">1008</span></a>        <span class="n">add_margin</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">][</span><span class="s2">&quot;angle_overflow&quot;</span><span class="p">]</span>
</span><span id="L-1009"><a href="#L-1009"><span class="linenos">1009</span></a>        <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">state_up</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span>
</span><span id="L-1010"><a href="#L-1010"><span class="linenos">1010</span></a>            <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">return_state_update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">add_margin</span><span class="o">=</span><span class="n">add_margin</span>
</span><span id="L-1011"><a href="#L-1011"><span class="linenos">1011</span></a>        <span class="p">)</span>
</span><span id="L-1012"><a href="#L-1012"><span class="linenos">1012</span></a>        <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="n">state_up</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="kc">True</span>
</span><span id="L-1013"><a href="#L-1013"><span class="linenos">1013</span></a>
</span><span id="L-1014"><a href="#L-1014"><span class="linenos">1014</span></a>    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="L-1015"><a href="#L-1015"><span class="linenos">1015</span></a>    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
</span><span id="L-1016"><a href="#L-1016"><span class="linenos">1016</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;build angle nblist on accelerator with jax and precomputed shapes&quot;&quot;&quot;</span>
</span><span id="L-1017"><a href="#L-1017"><span class="linenos">1017</span></a>        <span class="n">graph</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">]</span>
</span><span id="L-1018"><a href="#L-1018"><span class="linenos">1018</span></a>        <span class="n">edge_src</span> <span class="o">=</span> <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;edge_src&quot;</span><span class="p">]</span>
</span><span id="L-1019"><a href="#L-1019"><span class="linenos">1019</span></a>
</span><span id="L-1020"><a href="#L-1020"><span class="linenos">1020</span></a>        <span class="c1">### count number of neighbors</span>
</span><span id="L-1021"><a href="#L-1021"><span class="linenos">1021</span></a>        <span class="n">nat</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1022"><a href="#L-1022"><span class="linenos">1022</span></a>        <span class="n">count</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">edge_src</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;drop&quot;</span><span class="p">)</span>
</span><span id="L-1023"><a href="#L-1023"><span class="linenos">1023</span></a>        <span class="n">max_count</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
</span><span id="L-1024"><a href="#L-1024"><span class="linenos">1024</span></a>
</span><span id="L-1025"><a href="#L-1025"><span class="linenos">1025</span></a>        <span class="c1">### get sizes</span>
</span><span id="L-1026"><a href="#L-1026"><span class="linenos">1026</span></a>        <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1027"><a href="#L-1027"><span class="linenos">1027</span></a>            <span class="n">max_neigh_arr</span> <span class="o">=</span> <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;__max_neigh_array&quot;</span><span class="p">]</span>
</span><span id="L-1028"><a href="#L-1028"><span class="linenos">1028</span></a>            <span class="n">max_neigh</span> <span class="o">=</span> <span class="n">max_neigh_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1029"><a href="#L-1029"><span class="linenos">1029</span></a>            <span class="n">prev_nangles</span> <span class="o">=</span> <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;angle_src&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1030"><a href="#L-1030"><span class="linenos">1030</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1031"><a href="#L-1031"><span class="linenos">1031</span></a>            <span class="n">max_neigh</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_neigh&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_neigh</span><span class="p">)</span>
</span><span id="L-1032"><a href="#L-1032"><span class="linenos">1032</span></a>            <span class="n">max_neigh_arr</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">max_neigh</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
</span><span id="L-1033"><a href="#L-1033"><span class="linenos">1033</span></a>            <span class="n">prev_nangles</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nangles&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-1034"><a href="#L-1034"><span class="linenos">1034</span></a>
</span><span id="L-1035"><a href="#L-1035"><span class="linenos">1035</span></a>        <span class="n">nedge</span> <span class="o">=</span> <span class="n">edge_src</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1036"><a href="#L-1036"><span class="linenos">1036</span></a>
</span><span id="L-1037"><a href="#L-1037"><span class="linenos">1037</span></a>        <span class="c1">### sort edge_src</span>
</span><span id="L-1038"><a href="#L-1038"><span class="linenos">1038</span></a>        <span class="n">idx_sort</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">edge_src</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="L-1039"><a href="#L-1039"><span class="linenos">1039</span></a>        <span class="n">edge_src_sorted</span> <span class="o">=</span> <span class="n">edge_src</span><span class="p">[</span><span class="n">idx_sort</span><span class="p">]</span>
</span><span id="L-1040"><a href="#L-1040"><span class="linenos">1040</span></a>
</span><span id="L-1041"><a href="#L-1041"><span class="linenos">1041</span></a>        <span class="c1">### map sparse to dense nblist</span>
</span><span id="L-1042"><a href="#L-1042"><span class="linenos">1042</span></a>        <span class="k">if</span> <span class="n">max_neigh</span> <span class="o">*</span> <span class="n">nat</span> <span class="o">&lt;</span> <span class="n">nedge</span><span class="p">:</span>
</span><span id="L-1043"><a href="#L-1043"><span class="linenos">1043</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Found max_neigh*nat &lt; nedge. This should not happen.&quot;</span><span class="p">)</span>
</span><span id="L-1044"><a href="#L-1044"><span class="linenos">1044</span></a>        <span class="n">offset</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">max_neigh</span><span class="p">),</span> <span class="n">nat</span><span class="p">)[:</span><span class="n">nedge</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="L-1045"><a href="#L-1045"><span class="linenos">1045</span></a>        <span class="c1"># offset = jnp.where(edge_src_sorted &lt; nat, offset, 0)</span>
</span><span id="L-1046"><a href="#L-1046"><span class="linenos">1046</span></a>        <span class="n">indices</span> <span class="o">=</span> <span class="n">edge_src_sorted</span> <span class="o">*</span> <span class="n">max_neigh</span> <span class="o">+</span> <span class="n">offset</span>
</span><span id="L-1047"><a href="#L-1047"><span class="linenos">1047</span></a>        <span class="n">edge_idx</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-1048"><a href="#L-1048"><span class="linenos">1048</span></a>            <span class="n">jnp</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">nat</span> <span class="o">*</span> <span class="n">max_neigh</span><span class="p">,</span> <span class="n">nedge</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="L-1049"><a href="#L-1049"><span class="linenos">1049</span></a>            <span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
</span><span id="L-1050"><a href="#L-1050"><span class="linenos">1050</span></a>            <span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">idx_sort</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;drop&quot;</span><span class="p">)</span>
</span><span id="L-1051"><a href="#L-1051"><span class="linenos">1051</span></a>            <span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nat</span><span class="p">,</span> <span class="n">max_neigh</span><span class="p">)</span>
</span><span id="L-1052"><a href="#L-1052"><span class="linenos">1052</span></a>        <span class="p">)</span>
</span><span id="L-1053"><a href="#L-1053"><span class="linenos">1053</span></a>
</span><span id="L-1054"><a href="#L-1054"><span class="linenos">1054</span></a>        <span class="c1">### find all triplet for each atom center</span>
</span><span id="L-1055"><a href="#L-1055"><span class="linenos">1055</span></a>        <span class="n">local_src</span><span class="p">,</span> <span class="n">local_dst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">triu_indices</span><span class="p">(</span><span class="n">max_neigh</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-1056"><a href="#L-1056"><span class="linenos">1056</span></a>        <span class="n">angle_src</span> <span class="o">=</span> <span class="n">edge_idx</span><span class="p">[:,</span> <span class="n">local_src</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="L-1057"><a href="#L-1057"><span class="linenos">1057</span></a>        <span class="n">angle_dst</span> <span class="o">=</span> <span class="n">edge_idx</span><span class="p">[:,</span> <span class="n">local_dst</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="L-1058"><a href="#L-1058"><span class="linenos">1058</span></a>
</span><span id="L-1059"><a href="#L-1059"><span class="linenos">1059</span></a>        <span class="c1">### mask for valid angles</span>
</span><span id="L-1060"><a href="#L-1060"><span class="linenos">1060</span></a>        <span class="n">mask1</span> <span class="o">=</span> <span class="n">angle_src</span> <span class="o">&lt;</span> <span class="n">nedge</span>
</span><span id="L-1061"><a href="#L-1061"><span class="linenos">1061</span></a>        <span class="n">mask2</span> <span class="o">=</span> <span class="n">angle_dst</span> <span class="o">&lt;</span> <span class="n">nedge</span>
</span><span id="L-1062"><a href="#L-1062"><span class="linenos">1062</span></a>        <span class="n">angle_mask</span> <span class="o">=</span> <span class="n">mask1</span> <span class="o">&amp;</span> <span class="n">mask2</span>
</span><span id="L-1063"><a href="#L-1063"><span class="linenos">1063</span></a>
</span><span id="L-1064"><a href="#L-1064"><span class="linenos">1064</span></a>        <span class="c1">## filter angles to sparse representation</span>
</span><span id="L-1065"><a href="#L-1065"><span class="linenos">1065</span></a>        <span class="p">(</span><span class="n">angle_src</span><span class="p">,</span> <span class="n">angle_dst</span><span class="p">),</span> <span class="n">_</span><span class="p">,</span> <span class="n">nangles</span> <span class="o">=</span> <span class="n">mask_filter_1d</span><span class="p">(</span>
</span><span id="L-1066"><a href="#L-1066"><span class="linenos">1066</span></a>            <span class="n">angle_mask</span><span class="p">,</span>
</span><span id="L-1067"><a href="#L-1067"><span class="linenos">1067</span></a>            <span class="n">prev_nangles</span><span class="p">,</span>
</span><span id="L-1068"><a href="#L-1068"><span class="linenos">1068</span></a>            <span class="p">(</span><span class="n">angle_src</span><span class="p">,</span> <span class="n">nedge</span><span class="p">),</span>
</span><span id="L-1069"><a href="#L-1069"><span class="linenos">1069</span></a>            <span class="p">(</span><span class="n">angle_dst</span><span class="p">,</span> <span class="n">nedge</span><span class="p">),</span>
</span><span id="L-1070"><a href="#L-1070"><span class="linenos">1070</span></a>        <span class="p">)</span>
</span><span id="L-1071"><a href="#L-1071"><span class="linenos">1071</span></a>        <span class="c1">## find central atom</span>
</span><span id="L-1072"><a href="#L-1072"><span class="linenos">1072</span></a>        <span class="n">central_atom</span> <span class="o">=</span> <span class="n">edge_src</span><span class="p">[</span><span class="n">angle_src</span><span class="p">]</span>
</span><span id="L-1073"><a href="#L-1073"><span class="linenos">1073</span></a>
</span><span id="L-1074"><a href="#L-1074"><span class="linenos">1074</span></a>        <span class="c1">## check for overflow</span>
</span><span id="L-1075"><a href="#L-1075"><span class="linenos">1075</span></a>        <span class="n">angle_overflow</span> <span class="o">=</span> <span class="n">nangles</span> <span class="o">&gt;</span> <span class="n">prev_nangles</span>
</span><span id="L-1076"><a href="#L-1076"><span class="linenos">1076</span></a>        <span class="n">neigh_overflow</span> <span class="o">=</span> <span class="n">max_count</span> <span class="o">&gt;</span> <span class="n">max_neigh</span>
</span><span id="L-1077"><a href="#L-1077"><span class="linenos">1077</span></a>        <span class="n">overflow</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;angle_overflow&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="o">|</span> <span class="n">angle_overflow</span> <span class="o">|</span> <span class="n">neigh_overflow</span>
</span><span id="L-1078"><a href="#L-1078"><span class="linenos">1078</span></a>
</span><span id="L-1079"><a href="#L-1079"><span class="linenos">1079</span></a>        <span class="c1">## update graph</span>
</span><span id="L-1080"><a href="#L-1080"><span class="linenos">1080</span></a>        <span class="n">output</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-1081"><a href="#L-1081"><span class="linenos">1081</span></a>            <span class="o">**</span><span class="n">inputs</span><span class="p">,</span>
</span><span id="L-1082"><a href="#L-1082"><span class="linenos">1082</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">:</span> <span class="p">{</span>
</span><span id="L-1083"><a href="#L-1083"><span class="linenos">1083</span></a>                <span class="o">**</span><span class="n">graph</span><span class="p">,</span>
</span><span id="L-1084"><a href="#L-1084"><span class="linenos">1084</span></a>                <span class="s2">&quot;angle_src&quot;</span><span class="p">:</span> <span class="n">angle_src</span><span class="p">,</span>
</span><span id="L-1085"><a href="#L-1085"><span class="linenos">1085</span></a>                <span class="s2">&quot;angle_dst&quot;</span><span class="p">:</span> <span class="n">angle_dst</span><span class="p">,</span>
</span><span id="L-1086"><a href="#L-1086"><span class="linenos">1086</span></a>                <span class="s2">&quot;central_atom&quot;</span><span class="p">:</span> <span class="n">central_atom</span><span class="p">,</span>
</span><span id="L-1087"><a href="#L-1087"><span class="linenos">1087</span></a>                <span class="s2">&quot;angle_overflow&quot;</span><span class="p">:</span> <span class="n">overflow</span><span class="p">,</span>
</span><span id="L-1088"><a href="#L-1088"><span class="linenos">1088</span></a>                <span class="c1"># &quot;max_neigh&quot;: max_neigh,</span>
</span><span id="L-1089"><a href="#L-1089"><span class="linenos">1089</span></a>                <span class="s2">&quot;__max_neigh_array&quot;</span><span class="p">:</span> <span class="n">max_neigh_arr</span><span class="p">,</span>
</span><span id="L-1090"><a href="#L-1090"><span class="linenos">1090</span></a>            <span class="p">},</span>
</span><span id="L-1091"><a href="#L-1091"><span class="linenos">1091</span></a>        <span class="p">}</span>
</span><span id="L-1092"><a href="#L-1092"><span class="linenos">1092</span></a>
</span><span id="L-1093"><a href="#L-1093"><span class="linenos">1093</span></a>        <span class="k">return</span> <span class="n">output</span>
</span><span id="L-1094"><a href="#L-1094"><span class="linenos">1094</span></a>
</span><span id="L-1095"><a href="#L-1095"><span class="linenos">1095</span></a>    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
</span><span id="L-1096"><a href="#L-1096"><span class="linenos">1096</span></a>    <span class="k">def</span> <span class="nf">update_skin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
</span><span id="L-1097"><a href="#L-1097"><span class="linenos">1097</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>
</span><span id="L-1098"><a href="#L-1098"><span class="linenos">1098</span></a>
</span><span id="L-1099"><a href="#L-1099"><span class="linenos">1099</span></a>
</span><span id="L-1100"><a href="#L-1100"><span class="linenos">1100</span></a><span class="k">class</span> <span class="nc">GraphAngleProcessor</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="L-1101"><a href="#L-1101"><span class="linenos">1101</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Process a pre-generated graph to compute angles</span>
</span><span id="L-1102"><a href="#L-1102"><span class="linenos">1102</span></a>
</span><span id="L-1103"><a href="#L-1103"><span class="linenos">1103</span></a><span class="sd">    This module is automatically added to a FENNIX model when a GraphAngularExtension is used.</span>
</span><span id="L-1104"><a href="#L-1104"><span class="linenos">1104</span></a>
</span><span id="L-1105"><a href="#L-1105"><span class="linenos">1105</span></a><span class="sd">    Parameters</span>
</span><span id="L-1106"><a href="#L-1106"><span class="linenos">1106</span></a><span class="sd">    ----------</span>
</span><span id="L-1107"><a href="#L-1107"><span class="linenos">1107</span></a><span class="sd">    graph_key : str</span>
</span><span id="L-1108"><a href="#L-1108"><span class="linenos">1108</span></a><span class="sd">        Key of the graph in the inputs.</span>
</span><span id="L-1109"><a href="#L-1109"><span class="linenos">1109</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1110"><a href="#L-1110"><span class="linenos">1110</span></a>
</span><span id="L-1111"><a href="#L-1111"><span class="linenos">1111</span></a>    <span class="n">graph_key</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="L-1112"><a href="#L-1112"><span class="linenos">1112</span></a>
</span><span id="L-1113"><a href="#L-1113"><span class="linenos">1113</span></a>    <span class="nd">@nn</span><span class="o">.</span><span class="n">compact</span>
</span><span id="L-1114"><a href="#L-1114"><span class="linenos">1114</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]]):</span>
</span><span id="L-1115"><a href="#L-1115"><span class="linenos">1115</span></a>        <span class="n">graph</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">]</span>
</span><span id="L-1116"><a href="#L-1116"><span class="linenos">1116</span></a>        <span class="n">distances</span> <span class="o">=</span> <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;distances&quot;</span><span class="p">]</span>
</span><span id="L-1117"><a href="#L-1117"><span class="linenos">1117</span></a>        <span class="n">vec</span> <span class="o">=</span> <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;vec&quot;</span><span class="p">]</span>
</span><span id="L-1118"><a href="#L-1118"><span class="linenos">1118</span></a>        <span class="n">angle_src</span> <span class="o">=</span> <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;angle_src&quot;</span><span class="p">]</span>
</span><span id="L-1119"><a href="#L-1119"><span class="linenos">1119</span></a>        <span class="n">angle_dst</span> <span class="o">=</span> <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;angle_dst&quot;</span><span class="p">]</span>
</span><span id="L-1120"><a href="#L-1120"><span class="linenos">1120</span></a>
</span><span id="L-1121"><a href="#L-1121"><span class="linenos">1121</span></a>        <span class="n">d1</span> <span class="o">=</span> <span class="n">distances</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">angle_src</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
</span><span id="L-1122"><a href="#L-1122"><span class="linenos">1122</span></a>        <span class="n">d2</span> <span class="o">=</span> <span class="n">distances</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">angle_dst</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
</span><span id="L-1123"><a href="#L-1123"><span class="linenos">1123</span></a>        <span class="n">vec1</span> <span class="o">=</span> <span class="n">vec</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">angle_src</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
</span><span id="L-1124"><a href="#L-1124"><span class="linenos">1124</span></a>        <span class="n">vec2</span> <span class="o">=</span> <span class="n">vec</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">angle_dst</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
</span><span id="L-1125"><a href="#L-1125"><span class="linenos">1125</span></a>
</span><span id="L-1126"><a href="#L-1126"><span class="linenos">1126</span></a>        <span class="n">cos_angles</span> <span class="o">=</span> <span class="p">(</span><span class="n">vec1</span> <span class="o">*</span> <span class="n">vec2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">d1</span> <span class="o">*</span> <span class="n">d2</span><span class="p">,</span> <span class="n">a_min</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">)</span>
</span><span id="L-1127"><a href="#L-1127"><span class="linenos">1127</span></a>        <span class="n">angles</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="mf">0.95</span> <span class="o">*</span> <span class="n">cos_angles</span><span class="p">)</span>
</span><span id="L-1128"><a href="#L-1128"><span class="linenos">1128</span></a>
</span><span id="L-1129"><a href="#L-1129"><span class="linenos">1129</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="L-1130"><a href="#L-1130"><span class="linenos">1130</span></a>            <span class="o">**</span><span class="n">inputs</span><span class="p">,</span>
</span><span id="L-1131"><a href="#L-1131"><span class="linenos">1131</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">:</span> <span class="p">{</span>
</span><span id="L-1132"><a href="#L-1132"><span class="linenos">1132</span></a>                <span class="o">**</span><span class="n">graph</span><span class="p">,</span>
</span><span id="L-1133"><a href="#L-1133"><span class="linenos">1133</span></a>                <span class="c1"># &quot;cos_angles&quot;: cos_angles,</span>
</span><span id="L-1134"><a href="#L-1134"><span class="linenos">1134</span></a>                <span class="s2">&quot;angles&quot;</span><span class="p">:</span> <span class="n">angles</span><span class="p">,</span>
</span><span id="L-1135"><a href="#L-1135"><span class="linenos">1135</span></a>                <span class="c1"># &quot;angle_mask&quot;: angle_mask,</span>
</span><span id="L-1136"><a href="#L-1136"><span class="linenos">1136</span></a>            <span class="p">},</span>
</span><span id="L-1137"><a href="#L-1137"><span class="linenos">1137</span></a>        <span class="p">}</span>
</span><span id="L-1138"><a href="#L-1138"><span class="linenos">1138</span></a>
</span><span id="L-1139"><a href="#L-1139"><span class="linenos">1139</span></a>
</span><span id="L-1140"><a href="#L-1140"><span class="linenos">1140</span></a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1141"><a href="#L-1141"><span class="linenos">1141</span></a><span class="k">class</span> <span class="nc">SpeciesIndexer</span><span class="p">:</span>
</span><span id="L-1142"><a href="#L-1142"><span class="linenos">1142</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Build an index that splits atomic arrays by species.</span>
</span><span id="L-1143"><a href="#L-1143"><span class="linenos">1143</span></a>
</span><span id="L-1144"><a href="#L-1144"><span class="linenos">1144</span></a><span class="sd">    If `species_order` is specified, the output will be a dense array with size (len(species_order), max_size) that can directly index atomic arrays.</span>
</span><span id="L-1145"><a href="#L-1145"><span class="linenos">1145</span></a><span class="sd">    If `species_order` is None, the output will be a dictionary with species as keys and an index to filter atomic arrays for that species as values.</span>
</span><span id="L-1146"><a href="#L-1146"><span class="linenos">1146</span></a>
</span><span id="L-1147"><a href="#L-1147"><span class="linenos">1147</span></a><span class="sd">    Parameters</span>
</span><span id="L-1148"><a href="#L-1148"><span class="linenos">1148</span></a><span class="sd">    ----------</span>
</span><span id="L-1149"><a href="#L-1149"><span class="linenos">1149</span></a><span class="sd">    output_key : str, default=&quot;species_index&quot;</span>
</span><span id="L-1150"><a href="#L-1150"><span class="linenos">1150</span></a><span class="sd">        Key for the output dictionary.</span>
</span><span id="L-1151"><a href="#L-1151"><span class="linenos">1151</span></a><span class="sd">    species_order : str, default=None</span>
</span><span id="L-1152"><a href="#L-1152"><span class="linenos">1152</span></a><span class="sd">        Comma separated list of species in the order they should be indexed.</span>
</span><span id="L-1153"><a href="#L-1153"><span class="linenos">1153</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1154"><a href="#L-1154"><span class="linenos">1154</span></a>
</span><span id="L-1155"><a href="#L-1155"><span class="linenos">1155</span></a>    <span class="n">output_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;species_index&quot;</span>
</span><span id="L-1156"><a href="#L-1156"><span class="linenos">1156</span></a>    <span class="n">species_order</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1157"><a href="#L-1157"><span class="linenos">1157</span></a>    <span class="n">add_atoms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1158"><a href="#L-1158"><span class="linenos">1158</span></a>
</span><span id="L-1159"><a href="#L-1159"><span class="linenos">1159</span></a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1160"><a href="#L-1160"><span class="linenos">1160</span></a>        <span class="k">return</span> <span class="n">FrozenDict</span><span class="p">(</span>
</span><span id="L-1161"><a href="#L-1161"><span class="linenos">1161</span></a>            <span class="p">{</span>
</span><span id="L-1162"><a href="#L-1162"><span class="linenos">1162</span></a>                <span class="s2">&quot;sizes&quot;</span><span class="p">:</span> <span class="p">{},</span>
</span><span id="L-1163"><a href="#L-1163"><span class="linenos">1163</span></a>            <span class="p">}</span>
</span><span id="L-1164"><a href="#L-1164"><span class="linenos">1164</span></a>        <span class="p">)</span>
</span><span id="L-1165"><a href="#L-1165"><span class="linenos">1165</span></a>
</span><span id="L-1166"><a href="#L-1166"><span class="linenos">1166</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">return_state_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_margin</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-1167"><a href="#L-1167"><span class="linenos">1167</span></a>        <span class="n">species</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="L-1168"><a href="#L-1168"><span class="linenos">1168</span></a>        <span class="n">nat</span> <span class="o">=</span> <span class="n">species</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1169"><a href="#L-1169"><span class="linenos">1169</span></a>        <span class="n">set_species</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">species</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1170"><a href="#L-1170"><span class="linenos">1170</span></a>
</span><span id="L-1171"><a href="#L-1171"><span class="linenos">1171</span></a>        <span class="n">new_state</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">state</span><span class="p">}</span>
</span><span id="L-1172"><a href="#L-1172"><span class="linenos">1172</span></a>        <span class="n">state_up</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-1173"><a href="#L-1173"><span class="linenos">1173</span></a>
</span><span id="L-1174"><a href="#L-1174"><span class="linenos">1174</span></a>        <span class="n">sizes</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sizes&quot;</span><span class="p">,</span> <span class="n">FrozenDict</span><span class="p">({}))</span>
</span><span id="L-1175"><a href="#L-1175"><span class="linenos">1175</span></a>        <span class="n">new_sizes</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">sizes</span><span class="p">}</span>
</span><span id="L-1176"><a href="#L-1176"><span class="linenos">1176</span></a>        <span class="n">up_sizes</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-1177"><a href="#L-1177"><span class="linenos">1177</span></a>        <span class="n">counts_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-1178"><a href="#L-1178"><span class="linenos">1178</span></a>        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">set_species</span><span class="p">,</span> <span class="n">counts</span><span class="p">):</span>
</span><span id="L-1179"><a href="#L-1179"><span class="linenos">1179</span></a>            <span class="k">if</span> <span class="n">s</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1180"><a href="#L-1180"><span class="linenos">1180</span></a>                <span class="k">continue</span>
</span><span id="L-1181"><a href="#L-1181"><span class="linenos">1181</span></a>            <span class="n">counts_dict</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span>
</span><span id="L-1182"><a href="#L-1182"><span class="linenos">1182</span></a>            <span class="k">if</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="n">sizes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
</span><span id="L-1183"><a href="#L-1183"><span class="linenos">1183</span></a>                <span class="n">up_sizes</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-1184"><a href="#L-1184"><span class="linenos">1184</span></a>                <span class="n">new_sizes</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span> <span class="o">+</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;add_atoms&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_atoms</span><span class="p">)</span>
</span><span id="L-1185"><a href="#L-1185"><span class="linenos">1185</span></a>
</span><span id="L-1186"><a href="#L-1186"><span class="linenos">1186</span></a>        <span class="n">new_sizes</span> <span class="o">=</span> <span class="n">FrozenDict</span><span class="p">(</span><span class="n">new_sizes</span><span class="p">)</span>
</span><span id="L-1187"><a href="#L-1187"><span class="linenos">1187</span></a>        <span class="k">if</span> <span class="n">up_sizes</span><span class="p">:</span>
</span><span id="L-1188"><a href="#L-1188"><span class="linenos">1188</span></a>            <span class="n">state_up</span><span class="p">[</span><span class="s2">&quot;sizes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_sizes</span><span class="p">,</span> <span class="n">sizes</span><span class="p">)</span>
</span><span id="L-1189"><a href="#L-1189"><span class="linenos">1189</span></a>            <span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;sizes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_sizes</span>
</span><span id="L-1190"><a href="#L-1190"><span class="linenos">1190</span></a>
</span><span id="L-1191"><a href="#L-1191"><span class="linenos">1191</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_order</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1192"><a href="#L-1192"><span class="linenos">1192</span></a>            <span class="n">species_order</span> <span class="o">=</span> <span class="p">[</span><span class="n">el</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_order</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>
</span><span id="L-1193"><a href="#L-1193"><span class="linenos">1193</span></a>            <span class="n">max_size_prev</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_size&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-1194"><a href="#L-1194"><span class="linenos">1194</span></a>            <span class="n">max_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">new_sizes</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span><span id="L-1195"><a href="#L-1195"><span class="linenos">1195</span></a>            <span class="k">if</span> <span class="n">max_size</span> <span class="o">&gt;</span> <span class="n">max_size_prev</span><span class="p">:</span>
</span><span id="L-1196"><a href="#L-1196"><span class="linenos">1196</span></a>                <span class="n">state_up</span><span class="p">[</span><span class="s2">&quot;max_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_size</span><span class="p">,</span> <span class="n">max_size_prev</span><span class="p">)</span>
</span><span id="L-1197"><a href="#L-1197"><span class="linenos">1197</span></a>                <span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;max_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_size</span>
</span><span id="L-1198"><a href="#L-1198"><span class="linenos">1198</span></a>                <span class="n">max_size_prev</span> <span class="o">=</span> <span class="n">max_size</span>
</span><span id="L-1199"><a href="#L-1199"><span class="linenos">1199</span></a>
</span><span id="L-1200"><a href="#L-1200"><span class="linenos">1200</span></a>            <span class="n">species_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">species_order</span><span class="p">),</span> <span class="n">max_size</span><span class="p">),</span> <span class="n">nat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="L-1201"><a href="#L-1201"><span class="linenos">1201</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">el</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">species_order</span><span class="p">):</span>
</span><span id="L-1202"><a href="#L-1202"><span class="linenos">1202</span></a>                <span class="n">s</span> <span class="o">=</span> <span class="n">PERIODIC_TABLE_REV_IDX</span><span class="p">[</span><span class="n">el</span><span class="p">]</span>
</span><span id="L-1203"><a href="#L-1203"><span class="linenos">1203</span></a>                <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">counts_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-1204"><a href="#L-1204"><span class="linenos">1204</span></a>                    <span class="n">species_index</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:</span> <span class="n">counts_dict</span><span class="p">[</span><span class="n">s</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">species</span> <span class="o">==</span> <span class="n">s</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1205"><a href="#L-1205"><span class="linenos">1205</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1206"><a href="#L-1206"><span class="linenos">1206</span></a>            <span class="n">species_index</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-1207"><a href="#L-1207"><span class="linenos">1207</span></a>                <span class="n">PERIODIC_TABLE</span><span class="p">[</span><span class="n">s</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">nat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="L-1208"><a href="#L-1208"><span class="linenos">1208</span></a>                <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">new_sizes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="L-1209"><a href="#L-1209"><span class="linenos">1209</span></a>            <span class="p">}</span>
</span><span id="L-1210"><a href="#L-1210"><span class="linenos">1210</span></a>            <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">set_species</span><span class="p">,</span> <span class="n">counts</span><span class="p">):</span>
</span><span id="L-1211"><a href="#L-1211"><span class="linenos">1211</span></a>                <span class="k">if</span> <span class="n">s</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1212"><a href="#L-1212"><span class="linenos">1212</span></a>                    <span class="k">continue</span>
</span><span id="L-1213"><a href="#L-1213"><span class="linenos">1213</span></a>                <span class="n">species_index</span><span class="p">[</span><span class="n">PERIODIC_TABLE</span><span class="p">[</span><span class="n">s</span><span class="p">]][:</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">species</span> <span class="o">==</span> <span class="n">s</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1214"><a href="#L-1214"><span class="linenos">1214</span></a>
</span><span id="L-1215"><a href="#L-1215"><span class="linenos">1215</span></a>        <span class="n">output</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-1216"><a href="#L-1216"><span class="linenos">1216</span></a>            <span class="o">**</span><span class="n">inputs</span><span class="p">,</span>
</span><span id="L-1217"><a href="#L-1217"><span class="linenos">1217</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">output_key</span><span class="p">:</span> <span class="n">species_index</span><span class="p">,</span>
</span><span id="L-1218"><a href="#L-1218"><span class="linenos">1218</span></a>        <span class="p">}</span>
</span><span id="L-1219"><a href="#L-1219"><span class="linenos">1219</span></a>
</span><span id="L-1220"><a href="#L-1220"><span class="linenos">1220</span></a>        <span class="k">if</span> <span class="n">return_state_update</span><span class="p">:</span>
</span><span id="L-1221"><a href="#L-1221"><span class="linenos">1221</span></a>            <span class="k">return</span> <span class="n">FrozenDict</span><span class="p">(</span><span class="n">new_state</span><span class="p">),</span> <span class="n">output</span><span class="p">,</span> <span class="n">state_up</span>
</span><span id="L-1222"><a href="#L-1222"><span class="linenos">1222</span></a>        <span class="k">return</span> <span class="n">FrozenDict</span><span class="p">(</span><span class="n">new_state</span><span class="p">),</span> <span class="n">output</span>
</span><span id="L-1223"><a href="#L-1223"><span class="linenos">1223</span></a>
</span><span id="L-1224"><a href="#L-1224"><span class="linenos">1224</span></a>    <span class="k">def</span> <span class="nf">check_reallocate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">parent_overflow</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-1225"><a href="#L-1225"><span class="linenos">1225</span></a>        <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="p">{},</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">parent_overflow</span>
</span><span id="L-1226"><a href="#L-1226"><span class="linenos">1226</span></a>
</span><span id="L-1227"><a href="#L-1227"><span class="linenos">1227</span></a>    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="L-1228"><a href="#L-1228"><span class="linenos">1228</span></a>    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
</span><span id="L-1229"><a href="#L-1229"><span class="linenos">1229</span></a>        <span class="k">assert</span> <span class="p">(</span>
</span><span id="L-1230"><a href="#L-1230"><span class="linenos">1230</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">output_key</span> <span class="ow">in</span> <span class="n">inputs</span>
</span><span id="L-1231"><a href="#L-1231"><span class="linenos">1231</span></a>        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Species Index </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output_key</span><span class="si">}</span><span class="s2"> must be provided on accelerator. Call the numpy routine (self.__call__) first.&quot;</span>
</span><span id="L-1232"><a href="#L-1232"><span class="linenos">1232</span></a>
</span><span id="L-1233"><a href="#L-1233"><span class="linenos">1233</span></a>        <span class="k">return</span> <span class="n">inputs</span>
</span><span id="L-1234"><a href="#L-1234"><span class="linenos">1234</span></a>
</span><span id="L-1235"><a href="#L-1235"><span class="linenos">1235</span></a>    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
</span><span id="L-1236"><a href="#L-1236"><span class="linenos">1236</span></a>    <span class="k">def</span> <span class="nf">update_skin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
</span><span id="L-1237"><a href="#L-1237"><span class="linenos">1237</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>
</span><span id="L-1238"><a href="#L-1238"><span class="linenos">1238</span></a>
</span><span id="L-1239"><a href="#L-1239"><span class="linenos">1239</span></a>
</span><span id="L-1240"><a href="#L-1240"><span class="linenos">1240</span></a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1241"><a href="#L-1241"><span class="linenos">1241</span></a><span class="k">class</span> <span class="nc">AtomPadding</span><span class="p">:</span>
</span><span id="L-1242"><a href="#L-1242"><span class="linenos">1242</span></a>    <span class="n">mult_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.2</span>
</span><span id="L-1243"><a href="#L-1243"><span class="linenos">1243</span></a>
</span><span id="L-1244"><a href="#L-1244"><span class="linenos">1244</span></a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1245"><a href="#L-1245"><span class="linenos">1245</span></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;prev_nat&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
</span><span id="L-1246"><a href="#L-1246"><span class="linenos">1246</span></a>
</span><span id="L-1247"><a href="#L-1247"><span class="linenos">1247</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">]:</span>
</span><span id="L-1248"><a href="#L-1248"><span class="linenos">1248</span></a>        <span class="n">species</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">]</span>
</span><span id="L-1249"><a href="#L-1249"><span class="linenos">1249</span></a>        <span class="n">nat</span> <span class="o">=</span> <span class="n">species</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1250"><a href="#L-1250"><span class="linenos">1250</span></a>
</span><span id="L-1251"><a href="#L-1251"><span class="linenos">1251</span></a>        <span class="n">prev_nat</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prev_nat&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-1252"><a href="#L-1252"><span class="linenos">1252</span></a>        <span class="n">prev_nat_</span> <span class="o">=</span> <span class="n">prev_nat</span>
</span><span id="L-1253"><a href="#L-1253"><span class="linenos">1253</span></a>        <span class="k">if</span> <span class="n">nat</span> <span class="o">&gt;</span> <span class="n">prev_nat_</span><span class="p">:</span>
</span><span id="L-1254"><a href="#L-1254"><span class="linenos">1254</span></a>            <span class="n">prev_nat_</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mult_size</span> <span class="o">*</span> <span class="n">nat</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="L-1255"><a href="#L-1255"><span class="linenos">1255</span></a>
</span><span id="L-1256"><a href="#L-1256"><span class="linenos">1256</span></a>        <span class="n">nsys</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;natoms&quot;</span><span class="p">])</span>
</span><span id="L-1257"><a href="#L-1257"><span class="linenos">1257</span></a>
</span><span id="L-1258"><a href="#L-1258"><span class="linenos">1258</span></a>        <span class="n">add_atoms</span> <span class="o">=</span> <span class="n">prev_nat_</span> <span class="o">-</span> <span class="n">nat</span>
</span><span id="L-1259"><a href="#L-1259"><span class="linenos">1259</span></a>        <span class="n">output</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">inputs</span><span class="p">}</span>
</span><span id="L-1260"><a href="#L-1260"><span class="linenos">1260</span></a>        <span class="k">if</span> <span class="n">add_atoms</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1261"><a href="#L-1261"><span class="linenos">1261</span></a>            <span class="n">batch_index</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;batch_index&quot;</span><span class="p">]</span>
</span><span id="L-1262"><a href="#L-1262"><span class="linenos">1262</span></a>            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-1263"><a href="#L-1263"><span class="linenos">1263</span></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
</span><span id="L-1264"><a href="#L-1264"><span class="linenos">1264</span></a>                    <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">nat</span><span class="p">:</span>
</span><span id="L-1265"><a href="#L-1265"><span class="linenos">1265</span></a>                        <span class="n">output</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-1266"><a href="#L-1266"><span class="linenos">1266</span></a>                            <span class="n">v</span><span class="p">,</span>
</span><span id="L-1267"><a href="#L-1267"><span class="linenos">1267</span></a>                            <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">add_atoms</span><span class="p">,</span> <span class="o">*</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
</span><span id="L-1268"><a href="#L-1268"><span class="linenos">1268</span></a>                            <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="L-1269"><a href="#L-1269"><span class="linenos">1269</span></a>                        <span class="p">)</span>
</span><span id="L-1270"><a href="#L-1270"><span class="linenos">1270</span></a>                    <span class="k">elif</span> <span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">nsys</span><span class="p">:</span>
</span><span id="L-1271"><a href="#L-1271"><span class="linenos">1271</span></a>                        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;cells&quot;</span><span class="p">:</span>
</span><span id="L-1272"><a href="#L-1272"><span class="linenos">1272</span></a>                            <span class="n">output</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-1273"><a href="#L-1273"><span class="linenos">1273</span></a>                                <span class="n">v</span><span class="p">,</span>
</span><span id="L-1274"><a href="#L-1274"><span class="linenos">1274</span></a>                                <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">dtype</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span>
</span><span id="L-1275"><a href="#L-1275"><span class="linenos">1275</span></a>                                <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="L-1276"><a href="#L-1276"><span class="linenos">1276</span></a>                            <span class="p">)</span>
</span><span id="L-1277"><a href="#L-1277"><span class="linenos">1277</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1278"><a href="#L-1278"><span class="linenos">1278</span></a>                            <span class="n">output</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-1279"><a href="#L-1279"><span class="linenos">1279</span></a>                                <span class="n">v</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
</span><span id="L-1280"><a href="#L-1280"><span class="linenos">1280</span></a>                            <span class="p">)</span>
</span><span id="L-1281"><a href="#L-1281"><span class="linenos">1281</span></a>            <span class="n">output</span><span class="p">[</span><span class="s2">&quot;natoms&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;natoms&quot;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-1282"><a href="#L-1282"><span class="linenos">1282</span></a>            <span class="n">output</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-1283"><a href="#L-1283"><span class="linenos">1283</span></a>                <span class="n">species</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">add_atoms</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">species</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="L-1284"><a href="#L-1284"><span class="linenos">1284</span></a>            <span class="p">)</span>
</span><span id="L-1285"><a href="#L-1285"><span class="linenos">1285</span></a>            <span class="n">output</span><span class="p">[</span><span class="s2">&quot;batch_index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-1286"><a href="#L-1286"><span class="linenos">1286</span></a>                <span class="n">batch_index</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">nsys</span><span class="p">]</span> <span class="o">*</span> <span class="n">add_atoms</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">batch_index</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="L-1287"><a href="#L-1287"><span class="linenos">1287</span></a>            <span class="p">)</span>
</span><span id="L-1288"><a href="#L-1288"><span class="linenos">1288</span></a>
</span><span id="L-1289"><a href="#L-1289"><span class="linenos">1289</span></a>        <span class="n">output</span><span class="p">[</span><span class="s2">&quot;true_atoms&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span id="L-1290"><a href="#L-1290"><span class="linenos">1290</span></a>        <span class="n">output</span><span class="p">[</span><span class="s2">&quot;true_sys&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s2">&quot;natoms&quot;</span><span class="p">]))</span> <span class="o">&lt;</span> <span class="n">nsys</span>
</span><span id="L-1291"><a href="#L-1291"><span class="linenos">1291</span></a>
</span><span id="L-1292"><a href="#L-1292"><span class="linenos">1292</span></a>        <span class="n">state</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">state</span><span class="p">,</span> <span class="s2">&quot;prev_nat&quot;</span><span class="p">:</span> <span class="n">prev_nat_</span><span class="p">}</span>
</span><span id="L-1293"><a href="#L-1293"><span class="linenos">1293</span></a>
</span><span id="L-1294"><a href="#L-1294"><span class="linenos">1294</span></a>        <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="n">output</span>
</span><span id="L-1295"><a href="#L-1295"><span class="linenos">1295</span></a>
</span><span id="L-1296"><a href="#L-1296"><span class="linenos">1296</span></a>
</span><span id="L-1297"><a href="#L-1297"><span class="linenos">1297</span></a><span class="k">def</span> <span class="nf">atom_unpadding</span><span class="p">(</span><span class="n">inputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="L-1298"><a href="#L-1298"><span class="linenos">1298</span></a>    <span class="k">if</span> <span class="s2">&quot;true_atoms&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
</span><span id="L-1299"><a href="#L-1299"><span class="linenos">1299</span></a>        <span class="k">return</span> <span class="n">inputs</span>
</span><span id="L-1300"><a href="#L-1300"><span class="linenos">1300</span></a>
</span><span id="L-1301"><a href="#L-1301"><span class="linenos">1301</span></a>    <span class="n">species</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">]</span>
</span><span id="L-1302"><a href="#L-1302"><span class="linenos">1302</span></a>    <span class="n">true_atoms</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;true_atoms&quot;</span><span class="p">]</span>
</span><span id="L-1303"><a href="#L-1303"><span class="linenos">1303</span></a>    <span class="n">true_sys</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;true_sys&quot;</span><span class="p">]</span>
</span><span id="L-1304"><a href="#L-1304"><span class="linenos">1304</span></a>    <span class="n">natall</span> <span class="o">=</span> <span class="n">species</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1305"><a href="#L-1305"><span class="linenos">1305</span></a>    <span class="n">nat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">species</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-1306"><a href="#L-1306"><span class="linenos">1306</span></a>    <span class="k">if</span> <span class="n">nat</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1307"><a href="#L-1307"><span class="linenos">1307</span></a>        <span class="k">return</span> <span class="n">inputs</span>
</span><span id="L-1308"><a href="#L-1308"><span class="linenos">1308</span></a>
</span><span id="L-1309"><a href="#L-1309"><span class="linenos">1309</span></a>    <span class="n">natoms</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;natoms&quot;</span><span class="p">]</span>
</span><span id="L-1310"><a href="#L-1310"><span class="linenos">1310</span></a>    <span class="n">nsysall</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">natoms</span><span class="p">)</span>
</span><span id="L-1311"><a href="#L-1311"><span class="linenos">1311</span></a>
</span><span id="L-1312"><a href="#L-1312"><span class="linenos">1312</span></a>    <span class="n">output</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">inputs</span><span class="p">}</span>
</span><span id="L-1313"><a href="#L-1313"><span class="linenos">1313</span></a>    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-1314"><a href="#L-1314"><span class="linenos">1314</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
</span><span id="L-1315"><a href="#L-1315"><span class="linenos">1315</span></a>            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1316"><a href="#L-1316"><span class="linenos">1316</span></a>                <span class="k">continue</span>
</span><span id="L-1317"><a href="#L-1317"><span class="linenos">1317</span></a>            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">natall</span><span class="p">:</span>
</span><span id="L-1318"><a href="#L-1318"><span class="linenos">1318</span></a>                <span class="n">output</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">true_atoms</span><span class="p">]</span>
</span><span id="L-1319"><a href="#L-1319"><span class="linenos">1319</span></a>            <span class="k">elif</span> <span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">nsysall</span><span class="p">:</span>
</span><span id="L-1320"><a href="#L-1320"><span class="linenos">1320</span></a>                <span class="n">output</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">true_sys</span><span class="p">]</span>
</span><span id="L-1321"><a href="#L-1321"><span class="linenos">1321</span></a>    <span class="k">del</span> <span class="n">output</span><span class="p">[</span><span class="s2">&quot;true_sys&quot;</span><span class="p">]</span>
</span><span id="L-1322"><a href="#L-1322"><span class="linenos">1322</span></a>    <span class="k">del</span> <span class="n">output</span><span class="p">[</span><span class="s2">&quot;true_atoms&quot;</span><span class="p">]</span>
</span><span id="L-1323"><a href="#L-1323"><span class="linenos">1323</span></a>    <span class="k">return</span> <span class="n">output</span>
</span><span id="L-1324"><a href="#L-1324"><span class="linenos">1324</span></a>
</span><span id="L-1325"><a href="#L-1325"><span class="linenos">1325</span></a>
</span><span id="L-1326"><a href="#L-1326"><span class="linenos">1326</span></a><span class="k">def</span> <span class="nf">check_input</span><span class="p">(</span><span class="n">inputs</span><span class="p">):</span>
</span><span id="L-1327"><a href="#L-1327"><span class="linenos">1327</span></a>    <span class="k">assert</span> <span class="s2">&quot;species&quot;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">,</span> <span class="s2">&quot;species must be provided&quot;</span>
</span><span id="L-1328"><a href="#L-1328"><span class="linenos">1328</span></a>    <span class="k">assert</span> <span class="s2">&quot;coordinates&quot;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">,</span> <span class="s2">&quot;coordinates must be provided&quot;</span>
</span><span id="L-1329"><a href="#L-1329"><span class="linenos">1329</span></a>    <span class="n">species</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="L-1330"><a href="#L-1330"><span class="linenos">1330</span></a>    <span class="n">ifake</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">species</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-1331"><a href="#L-1331"><span class="linenos">1331</span></a>    <span class="k">if</span> <span class="n">ifake</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1332"><a href="#L-1332"><span class="linenos">1332</span></a>        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">species</span><span class="p">[:</span><span class="n">ifake</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;species must be positive&quot;</span>
</span><span id="L-1333"><a href="#L-1333"><span class="linenos">1333</span></a>    <span class="n">nat</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1334"><a href="#L-1334"><span class="linenos">1334</span></a>
</span><span id="L-1335"><a href="#L-1335"><span class="linenos">1335</span></a>    <span class="n">natoms</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;natoms&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">nat</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="L-1336"><a href="#L-1336"><span class="linenos">1336</span></a>    <span class="n">batch_index</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span id="L-1337"><a href="#L-1337"><span class="linenos">1337</span></a>        <span class="s2">&quot;batch_index&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">natoms</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">natoms</span><span class="p">)</span>
</span><span id="L-1338"><a href="#L-1338"><span class="linenos">1338</span></a>    <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="L-1339"><a href="#L-1339"><span class="linenos">1339</span></a>    <span class="n">output</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="s2">&quot;natoms&quot;</span><span class="p">:</span> <span class="n">natoms</span><span class="p">,</span> <span class="s2">&quot;batch_index&quot;</span><span class="p">:</span> <span class="n">batch_index</span><span class="p">}</span>
</span><span id="L-1340"><a href="#L-1340"><span class="linenos">1340</span></a>    <span class="k">if</span> <span class="s2">&quot;cells&quot;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
</span><span id="L-1341"><a href="#L-1341"><span class="linenos">1341</span></a>        <span class="n">cells</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;cells&quot;</span><span class="p">]</span>
</span><span id="L-1342"><a href="#L-1342"><span class="linenos">1342</span></a>        <span class="k">if</span> <span class="s2">&quot;reciprocal_cells&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
</span><span id="L-1343"><a href="#L-1343"><span class="linenos">1343</span></a>            <span class="n">reciprocal_cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cells</span><span class="p">)</span>
</span><span id="L-1344"><a href="#L-1344"><span class="linenos">1344</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1345"><a href="#L-1345"><span class="linenos">1345</span></a>            <span class="n">reciprocal_cells</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;reciprocal_cells&quot;</span><span class="p">]</span>
</span><span id="L-1346"><a href="#L-1346"><span class="linenos">1346</span></a>        <span class="k">if</span> <span class="n">cells</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-1347"><a href="#L-1347"><span class="linenos">1347</span></a>            <span class="n">cells</span> <span class="o">=</span> <span class="n">cells</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
</span><span id="L-1348"><a href="#L-1348"><span class="linenos">1348</span></a>        <span class="k">if</span> <span class="n">reciprocal_cells</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-1349"><a href="#L-1349"><span class="linenos">1349</span></a>            <span class="n">reciprocal_cells</span> <span class="o">=</span> <span class="n">reciprocal_cells</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
</span><span id="L-1350"><a href="#L-1350"><span class="linenos">1350</span></a>        <span class="n">output</span><span class="p">[</span><span class="s2">&quot;cells&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cells</span>
</span><span id="L-1351"><a href="#L-1351"><span class="linenos">1351</span></a>        <span class="n">output</span><span class="p">[</span><span class="s2">&quot;reciprocal_cells&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reciprocal_cells</span>
</span><span id="L-1352"><a href="#L-1352"><span class="linenos">1352</span></a>
</span><span id="L-1353"><a href="#L-1353"><span class="linenos">1353</span></a>    <span class="k">return</span> <span class="n">output</span>
</span><span id="L-1354"><a href="#L-1354"><span class="linenos">1354</span></a>
</span><span id="L-1355"><a href="#L-1355"><span class="linenos">1355</span></a>
</span><span id="L-1356"><a href="#L-1356"><span class="linenos">1356</span></a><span class="k">def</span> <span class="nf">convert_to_jax</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
</span><span id="L-1357"><a href="#L-1357"><span class="linenos">1357</span></a>    <span class="k">def</span> <span class="nf">convert</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span id="L-1358"><a href="#L-1358"><span class="linenos">1358</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
</span><span id="L-1359"><a href="#L-1359"><span class="linenos">1359</span></a>            <span class="c1"># if x.dtype == np.float64:</span>
</span><span id="L-1360"><a href="#L-1360"><span class="linenos">1360</span></a>            <span class="c1">#     return jnp.asarray(x, dtype=jnp.float32)</span>
</span><span id="L-1361"><a href="#L-1361"><span class="linenos">1361</span></a>            <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="L-1362"><a href="#L-1362"><span class="linenos">1362</span></a>        <span class="k">return</span> <span class="n">x</span>
</span><span id="L-1363"><a href="#L-1363"><span class="linenos">1363</span></a>
</span><span id="L-1364"><a href="#L-1364"><span class="linenos">1364</span></a>    <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">tree_util</span><span class="o">.</span><span class="n">tree_map</span><span class="p">(</span><span class="n">convert</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span><span id="L-1365"><a href="#L-1365"><span class="linenos">1365</span></a>
</span><span id="L-1366"><a href="#L-1366"><span class="linenos">1366</span></a>
</span><span id="L-1367"><a href="#L-1367"><span class="linenos">1367</span></a><span class="k">class</span> <span class="nc">JaxConverter</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="L-1368"><a href="#L-1368"><span class="linenos">1368</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span><span id="L-1369"><a href="#L-1369"><span class="linenos">1369</span></a>        <span class="k">return</span> <span class="n">convert_to_jax</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="L-1370"><a href="#L-1370"><span class="linenos">1370</span></a>
</span><span id="L-1371"><a href="#L-1371"><span class="linenos">1371</span></a>
</span><span id="L-1372"><a href="#L-1372"><span class="linenos">1372</span></a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1373"><a href="#L-1373"><span class="linenos">1373</span></a><span class="k">class</span> <span class="nc">PreprocessingChain</span><span class="p">:</span>
</span><span id="L-1374"><a href="#L-1374"><span class="linenos">1374</span></a>    <span class="n">layers</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span>
</span><span id="L-1375"><a href="#L-1375"><span class="linenos">1375</span></a>    <span class="n">use_atom_padding</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-1376"><a href="#L-1376"><span class="linenos">1376</span></a>    <span class="n">atom_padder</span><span class="p">:</span> <span class="n">AtomPadding</span> <span class="o">=</span> <span class="n">AtomPadding</span><span class="p">()</span>
</span><span id="L-1377"><a href="#L-1377"><span class="linenos">1377</span></a>
</span><span id="L-1378"><a href="#L-1378"><span class="linenos">1378</span></a>    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1379"><a href="#L-1379"><span class="linenos">1379</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">):</span>
</span><span id="L-1380"><a href="#L-1380"><span class="linenos">1380</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-1381"><a href="#L-1381"><span class="linenos">1381</span></a>                <span class="sa">f</span><span class="s2">&quot;&#39;layers&#39; must be a sequence, got &#39;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
</span><span id="L-1382"><a href="#L-1382"><span class="linenos">1382</span></a>            <span class="p">)</span>
</span><span id="L-1383"><a href="#L-1383"><span class="linenos">1383</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
</span><span id="L-1384"><a href="#L-1384"><span class="linenos">1384</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: no Preprocessing layers were provided.&quot;</span><span class="p">)</span>
</span><span id="L-1385"><a href="#L-1385"><span class="linenos">1385</span></a>
</span><span id="L-1386"><a href="#L-1386"><span class="linenos">1386</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="L-1387"><a href="#L-1387"><span class="linenos">1387</span></a>        <span class="n">do_check_input</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;check_input&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="L-1388"><a href="#L-1388"><span class="linenos">1388</span></a>        <span class="k">if</span> <span class="n">do_check_input</span><span class="p">:</span>
</span><span id="L-1389"><a href="#L-1389"><span class="linenos">1389</span></a>            <span class="n">inputs</span> <span class="o">=</span> <span class="n">check_input</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
</span><span id="L-1390"><a href="#L-1390"><span class="linenos">1390</span></a>        <span class="n">new_state</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1391"><a href="#L-1391"><span class="linenos">1391</span></a>        <span class="n">layer_state</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;layers_state&quot;</span><span class="p">]</span>
</span><span id="L-1392"><a href="#L-1392"><span class="linenos">1392</span></a>        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1393"><a href="#L-1393"><span class="linenos">1393</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_atom_padding</span><span class="p">:</span>
</span><span id="L-1394"><a href="#L-1394"><span class="linenos">1394</span></a>            <span class="n">s</span><span class="p">,</span> <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom_padder</span><span class="p">(</span><span class="n">layer_state</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">inputs</span><span class="p">)</span>
</span><span id="L-1395"><a href="#L-1395"><span class="linenos">1395</span></a>            <span class="n">new_state</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span><span id="L-1396"><a href="#L-1396"><span class="linenos">1396</span></a>            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-1397"><a href="#L-1397"><span class="linenos">1397</span></a>        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
</span><span id="L-1398"><a href="#L-1398"><span class="linenos">1398</span></a>            <span class="n">s</span><span class="p">,</span> <span class="n">inputs</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">layer_state</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">return_state_update</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1399"><a href="#L-1399"><span class="linenos">1399</span></a>            <span class="n">new_state</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span><span id="L-1400"><a href="#L-1400"><span class="linenos">1400</span></a>            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-1401"><a href="#L-1401"><span class="linenos">1401</span></a>        <span class="k">return</span> <span class="n">FrozenDict</span><span class="p">({</span><span class="o">**</span><span class="n">state</span><span class="p">,</span> <span class="s2">&quot;layers_state&quot;</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">new_state</span><span class="p">)}),</span> <span class="n">convert_to_jax</span><span class="p">(</span>
</span><span id="L-1402"><a href="#L-1402"><span class="linenos">1402</span></a>            <span class="n">inputs</span>
</span><span id="L-1403"><a href="#L-1403"><span class="linenos">1403</span></a>        <span class="p">)</span>
</span><span id="L-1404"><a href="#L-1404"><span class="linenos">1404</span></a>
</span><span id="L-1405"><a href="#L-1405"><span class="linenos">1405</span></a>    <span class="k">def</span> <span class="nf">check_reallocate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
</span><span id="L-1406"><a href="#L-1406"><span class="linenos">1406</span></a>        <span class="n">new_state</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1407"><a href="#L-1407"><span class="linenos">1407</span></a>        <span class="n">state_up</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1408"><a href="#L-1408"><span class="linenos">1408</span></a>        <span class="n">layer_state</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;layers_state&quot;</span><span class="p">]</span>
</span><span id="L-1409"><a href="#L-1409"><span class="linenos">1409</span></a>        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1410"><a href="#L-1410"><span class="linenos">1410</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_atom_padding</span><span class="p">:</span>
</span><span id="L-1411"><a href="#L-1411"><span class="linenos">1411</span></a>            <span class="n">new_state</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer_state</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1412"><a href="#L-1412"><span class="linenos">1412</span></a>            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-1413"><a href="#L-1413"><span class="linenos">1413</span></a>        <span class="n">parent_overflow</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-1414"><a href="#L-1414"><span class="linenos">1414</span></a>        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
</span><span id="L-1415"><a href="#L-1415"><span class="linenos">1415</span></a>            <span class="n">s</span><span class="p">,</span> <span class="n">s_up</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">parent_overflow</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">check_reallocate</span><span class="p">(</span>
</span><span id="L-1416"><a href="#L-1416"><span class="linenos">1416</span></a>                <span class="n">layer_state</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">parent_overflow</span>
</span><span id="L-1417"><a href="#L-1417"><span class="linenos">1417</span></a>            <span class="p">)</span>
</span><span id="L-1418"><a href="#L-1418"><span class="linenos">1418</span></a>            <span class="n">new_state</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span><span id="L-1419"><a href="#L-1419"><span class="linenos">1419</span></a>            <span class="n">state_up</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s_up</span><span class="p">)</span>
</span><span id="L-1420"><a href="#L-1420"><span class="linenos">1420</span></a>            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-1421"><a href="#L-1421"><span class="linenos">1421</span></a>
</span><span id="L-1422"><a href="#L-1422"><span class="linenos">1422</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">parent_overflow</span><span class="p">:</span>
</span><span id="L-1423"><a href="#L-1423"><span class="linenos">1423</span></a>            <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="p">{},</span> <span class="n">inputs</span><span class="p">,</span> <span class="kc">False</span>
</span><span id="L-1424"><a href="#L-1424"><span class="linenos">1424</span></a>        <span class="k">return</span> <span class="p">(</span>
</span><span id="L-1425"><a href="#L-1425"><span class="linenos">1425</span></a>            <span class="n">FrozenDict</span><span class="p">({</span><span class="o">**</span><span class="n">state</span><span class="p">,</span> <span class="s2">&quot;layers_state&quot;</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">new_state</span><span class="p">)}),</span>
</span><span id="L-1426"><a href="#L-1426"><span class="linenos">1426</span></a>            <span class="n">state_up</span><span class="p">,</span>
</span><span id="L-1427"><a href="#L-1427"><span class="linenos">1427</span></a>            <span class="n">inputs</span><span class="p">,</span>
</span><span id="L-1428"><a href="#L-1428"><span class="linenos">1428</span></a>            <span class="kc">True</span><span class="p">,</span>
</span><span id="L-1429"><a href="#L-1429"><span class="linenos">1429</span></a>        <span class="p">)</span>
</span><span id="L-1430"><a href="#L-1430"><span class="linenos">1430</span></a>
</span><span id="L-1431"><a href="#L-1431"><span class="linenos">1431</span></a>    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="L-1432"><a href="#L-1432"><span class="linenos">1432</span></a>    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
</span><span id="L-1433"><a href="#L-1433"><span class="linenos">1433</span></a>        <span class="n">layer_state</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;layers_state&quot;</span><span class="p">]</span>
</span><span id="L-1434"><a href="#L-1434"><span class="linenos">1434</span></a>        <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_atom_padding</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="L-1435"><a href="#L-1435"><span class="linenos">1435</span></a>        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
</span><span id="L-1436"><a href="#L-1436"><span class="linenos">1436</span></a>            <span class="n">inputs</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">layer_state</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">inputs</span><span class="p">)</span>
</span><span id="L-1437"><a href="#L-1437"><span class="linenos">1437</span></a>            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-1438"><a href="#L-1438"><span class="linenos">1438</span></a>        <span class="k">return</span> <span class="n">inputs</span>
</span><span id="L-1439"><a href="#L-1439"><span class="linenos">1439</span></a>
</span><span id="L-1440"><a href="#L-1440"><span class="linenos">1440</span></a>    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
</span><span id="L-1441"><a href="#L-1441"><span class="linenos">1441</span></a>    <span class="k">def</span> <span class="nf">update_skin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
</span><span id="L-1442"><a href="#L-1442"><span class="linenos">1442</span></a>        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
</span><span id="L-1443"><a href="#L-1443"><span class="linenos">1443</span></a>            <span class="n">inputs</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">update_skin</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
</span><span id="L-1444"><a href="#L-1444"><span class="linenos">1444</span></a>        <span class="k">return</span> <span class="n">inputs</span>
</span><span id="L-1445"><a href="#L-1445"><span class="linenos">1445</span></a>
</span><span id="L-1446"><a href="#L-1446"><span class="linenos">1446</span></a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1447"><a href="#L-1447"><span class="linenos">1447</span></a>        <span class="n">state</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1448"><a href="#L-1448"><span class="linenos">1448</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_atom_padding</span><span class="p">:</span>
</span><span id="L-1449"><a href="#L-1449"><span class="linenos">1449</span></a>            <span class="n">state</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atom_padder</span><span class="o">.</span><span class="n">init</span><span class="p">())</span>
</span><span id="L-1450"><a href="#L-1450"><span class="linenos">1450</span></a>        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
</span><span id="L-1451"><a href="#L-1451"><span class="linenos">1451</span></a>            <span class="n">state</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">init</span><span class="p">())</span>
</span><span id="L-1452"><a href="#L-1452"><span class="linenos">1452</span></a>        <span class="k">return</span> <span class="n">FrozenDict</span><span class="p">({</span><span class="s2">&quot;check_input&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;layers_state&quot;</span><span class="p">:</span> <span class="n">state</span><span class="p">})</span>
</span><span id="L-1453"><a href="#L-1453"><span class="linenos">1453</span></a>
</span><span id="L-1454"><a href="#L-1454"><span class="linenos">1454</span></a>    <span class="k">def</span> <span class="nf">init_with_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
</span><span id="L-1455"><a href="#L-1455"><span class="linenos">1455</span></a>        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
</span><span id="L-1456"><a href="#L-1456"><span class="linenos">1456</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>
</span><span id="L-1457"><a href="#L-1457"><span class="linenos">1457</span></a>
</span><span id="L-1458"><a href="#L-1458"><span class="linenos">1458</span></a>    <span class="k">def</span> <span class="nf">get_processors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">return_list</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-1459"><a href="#L-1459"><span class="linenos">1459</span></a>        <span class="n">processors</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1460"><a href="#L-1460"><span class="linenos">1460</span></a>        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
</span><span id="L-1461"><a href="#L-1461"><span class="linenos">1461</span></a>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="s2">&quot;get_processor&quot;</span><span class="p">):</span>
</span><span id="L-1462"><a href="#L-1462"><span class="linenos">1462</span></a>                <span class="n">processors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">get_processor</span><span class="p">())</span>
</span><span id="L-1463"><a href="#L-1463"><span class="linenos">1463</span></a>        <span class="k">if</span> <span class="n">return_list</span><span class="p">:</span>
</span><span id="L-1464"><a href="#L-1464"><span class="linenos">1464</span></a>            <span class="k">return</span> <span class="n">processors</span>
</span><span id="L-1465"><a href="#L-1465"><span class="linenos">1465</span></a>        <span class="k">return</span> <span class="n">FENNIXModules</span><span class="p">(</span><span class="n">processors</span><span class="p">)</span>
</span><span id="L-1466"><a href="#L-1466"><span class="linenos">1466</span></a>
</span><span id="L-1467"><a href="#L-1467"><span class="linenos">1467</span></a>    <span class="k">def</span> <span class="nf">get_graphs_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1468"><a href="#L-1468"><span class="linenos">1468</span></a>        <span class="n">properties</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-1469"><a href="#L-1469"><span class="linenos">1469</span></a>        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
</span><span id="L-1470"><a href="#L-1470"><span class="linenos">1470</span></a>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="s2">&quot;get_graph_properties&quot;</span><span class="p">):</span>
</span><span id="L-1471"><a href="#L-1471"><span class="linenos">1471</span></a>                <span class="n">properties</span> <span class="o">=</span> <span class="n">deep_update</span><span class="p">(</span><span class="n">properties</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">get_graph_properties</span><span class="p">())</span>
</span><span id="L-1472"><a href="#L-1472"><span class="linenos">1472</span></a>        <span class="k">return</span> <span class="n">properties</span>
</span><span id="L-1473"><a href="#L-1473"><span class="linenos">1473</span></a>
</span><span id="L-1474"><a href="#L-1474"><span class="linenos">1474</span></a>
</span><span id="L-1475"><a href="#L-1475"><span class="linenos">1475</span></a><span class="n">PREPROCESSING</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-1476"><a href="#L-1476"><span class="linenos">1476</span></a>    <span class="s2">&quot;GRAPH&quot;</span><span class="p">:</span> <span class="n">GraphGenerator</span><span class="p">,</span>
</span><span id="L-1477"><a href="#L-1477"><span class="linenos">1477</span></a>    <span class="c1"># &quot;GRAPH_FIXED&quot;: GraphGeneratorFixed,</span>
</span><span id="L-1478"><a href="#L-1478"><span class="linenos">1478</span></a>    <span class="s2">&quot;GRAPH_FILTER&quot;</span><span class="p">:</span> <span class="n">GraphFilter</span><span class="p">,</span>
</span><span id="L-1479"><a href="#L-1479"><span class="linenos">1479</span></a>    <span class="s2">&quot;GRAPH_ANGULAR_EXTENSION&quot;</span><span class="p">:</span> <span class="n">GraphAngularExtension</span><span class="p">,</span>
</span><span id="L-1480"><a href="#L-1480"><span class="linenos">1480</span></a>    <span class="c1"># &quot;GRAPH_DENSE_EXTENSION&quot;: GraphDenseExtension,</span>
</span><span id="L-1481"><a href="#L-1481"><span class="linenos">1481</span></a>    <span class="s2">&quot;SPECIES_INDEXER&quot;</span><span class="p">:</span> <span class="n">SpeciesIndexer</span><span class="p">,</span>
</span><span id="L-1482"><a href="#L-1482"><span class="linenos">1482</span></a><span class="p">}</span>
</span></pre></div>


            </section>
                <section id="GraphGenerator">
                            <input id="GraphGenerator-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
                    <div class="decorator">@dataclasses.dataclass(frozen=True)</div>

    <span class="def">class</span>
    <span class="name">GraphGenerator</span>:

                <label class="view-source-button" for="GraphGenerator-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GraphGenerator"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GraphGenerator-23"><a href="#GraphGenerator-23"><span class="linenos"> 23</span></a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="GraphGenerator-24"><a href="#GraphGenerator-24"><span class="linenos"> 24</span></a><span class="k">class</span> <span class="nc">GraphGenerator</span><span class="p">:</span>
</span><span id="GraphGenerator-25"><a href="#GraphGenerator-25"><span class="linenos"> 25</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a graph from a set of coordinates</span>
</span><span id="GraphGenerator-26"><a href="#GraphGenerator-26"><span class="linenos"> 26</span></a>
</span><span id="GraphGenerator-27"><a href="#GraphGenerator-27"><span class="linenos"> 27</span></a><span class="sd">    For now, we generate all pairs of atoms and filter based on cutoff.</span>
</span><span id="GraphGenerator-28"><a href="#GraphGenerator-28"><span class="linenos"> 28</span></a><span class="sd">    If a `nblist_skin` is present in the state, we generate a second graph with a larger cutoff that includes all pairs within the cutoff+skin. This graph is then reused by the `update_skin` method to update the original graph without recomputing the full nblist.</span>
</span><span id="GraphGenerator-29"><a href="#GraphGenerator-29"><span class="linenos"> 29</span></a>
</span><span id="GraphGenerator-30"><a href="#GraphGenerator-30"><span class="linenos"> 30</span></a><span class="sd">    Parameters</span>
</span><span id="GraphGenerator-31"><a href="#GraphGenerator-31"><span class="linenos"> 31</span></a><span class="sd">    ----------</span>
</span><span id="GraphGenerator-32"><a href="#GraphGenerator-32"><span class="linenos"> 32</span></a><span class="sd">    cutoff : float</span>
</span><span id="GraphGenerator-33"><a href="#GraphGenerator-33"><span class="linenos"> 33</span></a><span class="sd">        Cutoff distance for the graph.</span>
</span><span id="GraphGenerator-34"><a href="#GraphGenerator-34"><span class="linenos"> 34</span></a><span class="sd">    graph_key : str, default=&quot;graph&quot;</span>
</span><span id="GraphGenerator-35"><a href="#GraphGenerator-35"><span class="linenos"> 35</span></a><span class="sd">        Key of the graph in the outputs.</span>
</span><span id="GraphGenerator-36"><a href="#GraphGenerator-36"><span class="linenos"> 36</span></a><span class="sd">    switch_params : dict, default={}</span>
</span><span id="GraphGenerator-37"><a href="#GraphGenerator-37"><span class="linenos"> 37</span></a><span class="sd">        Parameters for the switching function.</span>
</span><span id="GraphGenerator-38"><a href="#GraphGenerator-38"><span class="linenos"> 38</span></a><span class="sd">    k_space : bool, default=False</span>
</span><span id="GraphGenerator-39"><a href="#GraphGenerator-39"><span class="linenos"> 39</span></a><span class="sd">        Generate k-space information for the graph.</span>
</span><span id="GraphGenerator-40"><a href="#GraphGenerator-40"><span class="linenos"> 40</span></a><span class="sd">    kmax : int, default=30</span>
</span><span id="GraphGenerator-41"><a href="#GraphGenerator-41"><span class="linenos"> 41</span></a><span class="sd">        Maximum number of k-points to consider.</span>
</span><span id="GraphGenerator-42"><a href="#GraphGenerator-42"><span class="linenos"> 42</span></a><span class="sd">    kthr : float, default=1e-6</span>
</span><span id="GraphGenerator-43"><a href="#GraphGenerator-43"><span class="linenos"> 43</span></a><span class="sd">        Threshold for k-point filtering.</span>
</span><span id="GraphGenerator-44"><a href="#GraphGenerator-44"><span class="linenos"> 44</span></a><span class="sd">    mult_size : float, default=1.05</span>
</span><span id="GraphGenerator-45"><a href="#GraphGenerator-45"><span class="linenos"> 45</span></a><span class="sd">        Multiplicative factor for resizing the nblist.</span>
</span><span id="GraphGenerator-46"><a href="#GraphGenerator-46"><span class="linenos"> 46</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="GraphGenerator-47"><a href="#GraphGenerator-47"><span class="linenos"> 47</span></a>
</span><span id="GraphGenerator-48"><a href="#GraphGenerator-48"><span class="linenos"> 48</span></a>    <span class="n">cutoff</span><span class="p">:</span> <span class="nb">float</span>
</span><span id="GraphGenerator-49"><a href="#GraphGenerator-49"><span class="linenos"> 49</span></a>    <span class="n">graph_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;graph&quot;</span>
</span><span id="GraphGenerator-50"><a href="#GraphGenerator-50"><span class="linenos"> 50</span></a>    <span class="n">switch_params</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="GraphGenerator-51"><a href="#GraphGenerator-51"><span class="linenos"> 51</span></a>    <span class="n">kmax</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span>
</span><span id="GraphGenerator-52"><a href="#GraphGenerator-52"><span class="linenos"> 52</span></a>    <span class="n">kthr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-6</span>
</span><span id="GraphGenerator-53"><a href="#GraphGenerator-53"><span class="linenos"> 53</span></a>    <span class="n">k_space</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="GraphGenerator-54"><a href="#GraphGenerator-54"><span class="linenos"> 54</span></a>    <span class="n">mult_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.05</span>
</span><span id="GraphGenerator-55"><a href="#GraphGenerator-55"><span class="linenos"> 55</span></a>    <span class="c1"># covalent_cutoff: bool = False</span>
</span><span id="GraphGenerator-56"><a href="#GraphGenerator-56"><span class="linenos"> 56</span></a>
</span><span id="GraphGenerator-57"><a href="#GraphGenerator-57"><span class="linenos"> 57</span></a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="GraphGenerator-58"><a href="#GraphGenerator-58"><span class="linenos"> 58</span></a>        <span class="k">return</span> <span class="n">FrozenDict</span><span class="p">(</span>
</span><span id="GraphGenerator-59"><a href="#GraphGenerator-59"><span class="linenos"> 59</span></a>            <span class="p">{</span>
</span><span id="GraphGenerator-60"><a href="#GraphGenerator-60"><span class="linenos"> 60</span></a>                <span class="s2">&quot;max_nat&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="GraphGenerator-61"><a href="#GraphGenerator-61"><span class="linenos"> 61</span></a>                <span class="s2">&quot;npairs&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="GraphGenerator-62"><a href="#GraphGenerator-62"><span class="linenos"> 62</span></a>                <span class="s2">&quot;nblist_mult_size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mult_size</span><span class="p">,</span>
</span><span id="GraphGenerator-63"><a href="#GraphGenerator-63"><span class="linenos"> 63</span></a>            <span class="p">}</span>
</span><span id="GraphGenerator-64"><a href="#GraphGenerator-64"><span class="linenos"> 64</span></a>        <span class="p">)</span>
</span><span id="GraphGenerator-65"><a href="#GraphGenerator-65"><span class="linenos"> 65</span></a>
</span><span id="GraphGenerator-66"><a href="#GraphGenerator-66"><span class="linenos"> 66</span></a>    <span class="k">def</span> <span class="nf">get_processor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]:</span>
</span><span id="GraphGenerator-67"><a href="#GraphGenerator-67"><span class="linenos"> 67</span></a>        <span class="k">return</span> <span class="n">GraphProcessor</span><span class="p">,</span> <span class="p">{</span>
</span><span id="GraphGenerator-68"><a href="#GraphGenerator-68"><span class="linenos"> 68</span></a>            <span class="s2">&quot;cutoff&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">,</span>
</span><span id="GraphGenerator-69"><a href="#GraphGenerator-69"><span class="linenos"> 69</span></a>            <span class="s2">&quot;graph_key&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">,</span>
</span><span id="GraphGenerator-70"><a href="#GraphGenerator-70"><span class="linenos"> 70</span></a>            <span class="s2">&quot;switch_params&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">switch_params</span><span class="p">,</span>
</span><span id="GraphGenerator-71"><a href="#GraphGenerator-71"><span class="linenos"> 71</span></a>            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="si">}</span><span class="s2">_Processor&quot;</span><span class="p">,</span>
</span><span id="GraphGenerator-72"><a href="#GraphGenerator-72"><span class="linenos"> 72</span></a>        <span class="p">}</span>
</span><span id="GraphGenerator-73"><a href="#GraphGenerator-73"><span class="linenos"> 73</span></a>
</span><span id="GraphGenerator-74"><a href="#GraphGenerator-74"><span class="linenos"> 74</span></a>    <span class="k">def</span> <span class="nf">get_graph_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="GraphGenerator-75"><a href="#GraphGenerator-75"><span class="linenos"> 75</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="GraphGenerator-76"><a href="#GraphGenerator-76"><span class="linenos"> 76</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">:</span> <span class="p">{</span>
</span><span id="GraphGenerator-77"><a href="#GraphGenerator-77"><span class="linenos"> 77</span></a>                <span class="s2">&quot;cutoff&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">,</span>
</span><span id="GraphGenerator-78"><a href="#GraphGenerator-78"><span class="linenos"> 78</span></a>                <span class="s2">&quot;directed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="GraphGenerator-79"><a href="#GraphGenerator-79"><span class="linenos"> 79</span></a>            <span class="p">}</span>
</span><span id="GraphGenerator-80"><a href="#GraphGenerator-80"><span class="linenos"> 80</span></a>        <span class="p">}</span>
</span><span id="GraphGenerator-81"><a href="#GraphGenerator-81"><span class="linenos"> 81</span></a>
</span><span id="GraphGenerator-82"><a href="#GraphGenerator-82"><span class="linenos"> 82</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">return_state_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_margin</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="GraphGenerator-83"><a href="#GraphGenerator-83"><span class="linenos"> 83</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;build a nblist on cpu with numpy and dynamic shapes + store max shapes&quot;&quot;&quot;</span>
</span><span id="GraphGenerator-84"><a href="#GraphGenerator-84"><span class="linenos"> 84</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
</span><span id="GraphGenerator-85"><a href="#GraphGenerator-85"><span class="linenos"> 85</span></a>            <span class="n">graph</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">]</span>
</span><span id="GraphGenerator-86"><a href="#GraphGenerator-86"><span class="linenos"> 86</span></a>            <span class="k">if</span> <span class="s2">&quot;keep_graph&quot;</span> <span class="ow">in</span> <span class="n">graph</span><span class="p">:</span>
</span><span id="GraphGenerator-87"><a href="#GraphGenerator-87"><span class="linenos"> 87</span></a>                <span class="k">return</span> <span class="n">state</span><span class="p">,</span><span class="n">inputs</span>
</span><span id="GraphGenerator-88"><a href="#GraphGenerator-88"><span class="linenos"> 88</span></a>            
</span><span id="GraphGenerator-89"><a href="#GraphGenerator-89"><span class="linenos"> 89</span></a>        <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;coordinates&quot;</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="GraphGenerator-90"><a href="#GraphGenerator-90"><span class="linenos"> 90</span></a>        <span class="n">natoms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;natoms&quot;</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="GraphGenerator-91"><a href="#GraphGenerator-91"><span class="linenos"> 91</span></a>        <span class="n">batch_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;batch_index&quot;</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="GraphGenerator-92"><a href="#GraphGenerator-92"><span class="linenos"> 92</span></a>
</span><span id="GraphGenerator-93"><a href="#GraphGenerator-93"><span class="linenos"> 93</span></a>        <span class="n">new_state</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">state</span><span class="p">}</span>
</span><span id="GraphGenerator-94"><a href="#GraphGenerator-94"><span class="linenos"> 94</span></a>        <span class="n">state_up</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="GraphGenerator-95"><a href="#GraphGenerator-95"><span class="linenos"> 95</span></a>
</span><span id="GraphGenerator-96"><a href="#GraphGenerator-96"><span class="linenos"> 96</span></a>        <span class="n">max_nat</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_nat&quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">natoms</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span id="GraphGenerator-97"><a href="#GraphGenerator-97"><span class="linenos"> 97</span></a>        <span class="n">true_max_nat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">natoms</span><span class="p">)</span>
</span><span id="GraphGenerator-98"><a href="#GraphGenerator-98"><span class="linenos"> 98</span></a>        <span class="k">if</span> <span class="n">true_max_nat</span> <span class="o">&gt;</span> <span class="n">max_nat</span><span class="p">:</span>
</span><span id="GraphGenerator-99"><a href="#GraphGenerator-99"><span class="linenos"> 99</span></a>            <span class="n">state_up</span><span class="p">[</span><span class="s2">&quot;max_nat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">true_max_nat</span><span class="p">,</span> <span class="n">max_nat</span><span class="p">)</span>
</span><span id="GraphGenerator-100"><a href="#GraphGenerator-100"><span class="linenos">100</span></a>            <span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;max_nat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">true_max_nat</span>
</span><span id="GraphGenerator-101"><a href="#GraphGenerator-101"><span class="linenos">101</span></a>
</span><span id="GraphGenerator-102"><a href="#GraphGenerator-102"><span class="linenos">102</span></a>        <span class="n">cutoff_skin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span> <span class="o">+</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nblist_skin&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
</span><span id="GraphGenerator-103"><a href="#GraphGenerator-103"><span class="linenos">103</span></a>
</span><span id="GraphGenerator-104"><a href="#GraphGenerator-104"><span class="linenos">104</span></a>        <span class="c1">### compute indices of all pairs</span>
</span><span id="GraphGenerator-105"><a href="#GraphGenerator-105"><span class="linenos">105</span></a>        <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">triu_indices</span><span class="p">(</span><span class="n">true_max_nat</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="GraphGenerator-106"><a href="#GraphGenerator-106"><span class="linenos">106</span></a>        <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">p1</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">p2</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="GraphGenerator-107"><a href="#GraphGenerator-107"><span class="linenos">107</span></a>        <span class="n">pbc_shifts</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="GraphGenerator-108"><a href="#GraphGenerator-108"><span class="linenos">108</span></a>        <span class="k">if</span> <span class="n">natoms</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="GraphGenerator-109"><a href="#GraphGenerator-109"><span class="linenos">109</span></a>            <span class="c1">## batching =&gt; mask irrelevant pairs</span>
</span><span id="GraphGenerator-110"><a href="#GraphGenerator-110"><span class="linenos">110</span></a>            <span class="n">mask_p12</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="GraphGenerator-111"><a href="#GraphGenerator-111"><span class="linenos">111</span></a>                <span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&lt;</span> <span class="n">natoms</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">p2</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&lt;</span> <span class="n">natoms</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span>
</span><span id="GraphGenerator-112"><a href="#GraphGenerator-112"><span class="linenos">112</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="GraphGenerator-113"><a href="#GraphGenerator-113"><span class="linenos">113</span></a>            <span class="n">shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
</span><span id="GraphGenerator-114"><a href="#GraphGenerator-114"><span class="linenos">114</span></a>                <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">natoms</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>
</span><span id="GraphGenerator-115"><a href="#GraphGenerator-115"><span class="linenos">115</span></a>            <span class="p">)</span>
</span><span id="GraphGenerator-116"><a href="#GraphGenerator-116"><span class="linenos">116</span></a>            <span class="n">p1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_p12</span><span class="p">,</span> <span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">shift</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="GraphGenerator-117"><a href="#GraphGenerator-117"><span class="linenos">117</span></a>            <span class="n">p2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_p12</span><span class="p">,</span> <span class="p">(</span><span class="n">p2</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">shift</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="GraphGenerator-118"><a href="#GraphGenerator-118"><span class="linenos">118</span></a>
</span><span id="GraphGenerator-119"><a href="#GraphGenerator-119"><span class="linenos">119</span></a>        <span class="n">apply_pbc</span> <span class="o">=</span> <span class="s2">&quot;cells&quot;</span> <span class="ow">in</span> <span class="n">inputs</span>
</span><span id="GraphGenerator-120"><a href="#GraphGenerator-120"><span class="linenos">120</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">apply_pbc</span><span class="p">:</span>
</span><span id="GraphGenerator-121"><a href="#GraphGenerator-121"><span class="linenos">121</span></a>            <span class="c1">### NO PBC</span>
</span><span id="GraphGenerator-122"><a href="#GraphGenerator-122"><span class="linenos">122</span></a>            <span class="n">vec</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">p2</span><span class="p">]</span> <span class="o">-</span> <span class="n">coords</span><span class="p">[</span><span class="n">p1</span><span class="p">]</span>
</span><span id="GraphGenerator-123"><a href="#GraphGenerator-123"><span class="linenos">123</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="GraphGenerator-124"><a href="#GraphGenerator-124"><span class="linenos">124</span></a>            <span class="n">cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;cells&quot;</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="GraphGenerator-125"><a href="#GraphGenerator-125"><span class="linenos">125</span></a>            <span class="n">reciprocal_cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;reciprocal_cells&quot;</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="GraphGenerator-126"><a href="#GraphGenerator-126"><span class="linenos">126</span></a>            <span class="n">minimage</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;minimum_image&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="GraphGenerator-127"><a href="#GraphGenerator-127"><span class="linenos">127</span></a>            <span class="k">if</span> <span class="n">minimage</span><span class="p">:</span>
</span><span id="GraphGenerator-128"><a href="#GraphGenerator-128"><span class="linenos">128</span></a>                <span class="c1">## MINIMUM IMAGE CONVENTION</span>
</span><span id="GraphGenerator-129"><a href="#GraphGenerator-129"><span class="linenos">129</span></a>                <span class="n">vec</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">p2</span><span class="p">]</span> <span class="o">-</span> <span class="n">coords</span><span class="p">[</span><span class="n">p1</span><span class="p">]</span>
</span><span id="GraphGenerator-130"><a href="#GraphGenerator-130"><span class="linenos">130</span></a>                <span class="k">if</span> <span class="n">cells</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="GraphGenerator-131"><a href="#GraphGenerator-131"><span class="linenos">131</span></a>                    <span class="n">vecpbc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">reciprocal_cells</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="GraphGenerator-132"><a href="#GraphGenerator-132"><span class="linenos">132</span></a>                    <span class="n">pbc_shifts</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">vecpbc</span><span class="p">)</span>
</span><span id="GraphGenerator-133"><a href="#GraphGenerator-133"><span class="linenos">133</span></a>                    <span class="n">vec</span> <span class="o">=</span> <span class="n">vec</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pbc_shifts</span><span class="p">,</span> <span class="n">cells</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="GraphGenerator-134"><a href="#GraphGenerator-134"><span class="linenos">134</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="GraphGenerator-135"><a href="#GraphGenerator-135"><span class="linenos">135</span></a>                    <span class="n">vecpbc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;aj,aji-&gt;ai&quot;</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="n">reciprocal_cells</span><span class="p">[</span><span class="n">batch_index_vec</span><span class="p">])</span>
</span><span id="GraphGenerator-136"><a href="#GraphGenerator-136"><span class="linenos">136</span></a>                    <span class="n">pbc_shifts</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">vecpbc</span><span class="p">)</span>
</span><span id="GraphGenerator-137"><a href="#GraphGenerator-137"><span class="linenos">137</span></a>                    <span class="n">vec</span> <span class="o">=</span> <span class="n">vec</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;aj,aji-&gt;ai&quot;</span><span class="p">,</span> <span class="n">pbc_shifts</span><span class="p">,</span> <span class="n">cells</span><span class="p">[</span><span class="n">batch_index_vec</span><span class="p">])</span>
</span><span id="GraphGenerator-138"><a href="#GraphGenerator-138"><span class="linenos">138</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="GraphGenerator-139"><a href="#GraphGenerator-139"><span class="linenos">139</span></a>                <span class="c1">### GENERAL PBC</span>
</span><span id="GraphGenerator-140"><a href="#GraphGenerator-140"><span class="linenos">140</span></a>                <span class="c1">## put all atoms in central box</span>
</span><span id="GraphGenerator-141"><a href="#GraphGenerator-141"><span class="linenos">141</span></a>                <span class="k">if</span> <span class="n">cells</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="GraphGenerator-142"><a href="#GraphGenerator-142"><span class="linenos">142</span></a>                    <span class="n">coords_pbc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">reciprocal_cells</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="GraphGenerator-143"><a href="#GraphGenerator-143"><span class="linenos">143</span></a>                    <span class="n">at_shifts</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">coords_pbc</span><span class="p">)</span>
</span><span id="GraphGenerator-144"><a href="#GraphGenerator-144"><span class="linenos">144</span></a>                    <span class="n">coords_pbc</span> <span class="o">=</span> <span class="n">coords</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">at_shifts</span><span class="p">,</span> <span class="n">cells</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="GraphGenerator-145"><a href="#GraphGenerator-145"><span class="linenos">145</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="GraphGenerator-146"><a href="#GraphGenerator-146"><span class="linenos">146</span></a>                    <span class="n">coords_pbc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;aj,aji-&gt;ai&quot;</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">reciprocal_cells</span><span class="p">[</span><span class="n">batch_index</span><span class="p">])</span>
</span><span id="GraphGenerator-147"><a href="#GraphGenerator-147"><span class="linenos">147</span></a>                    <span class="n">at_shifts</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">coords_pbc</span><span class="p">)</span>
</span><span id="GraphGenerator-148"><a href="#GraphGenerator-148"><span class="linenos">148</span></a>                    <span class="n">coords_pbc</span> <span class="o">=</span> <span class="n">coords</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;aj,aji-&gt;ai&quot;</span><span class="p">,</span> <span class="n">at_shifts</span><span class="p">,</span> <span class="n">cells</span><span class="p">[</span><span class="n">batch_index</span><span class="p">])</span>
</span><span id="GraphGenerator-149"><a href="#GraphGenerator-149"><span class="linenos">149</span></a>
</span><span id="GraphGenerator-150"><a href="#GraphGenerator-150"><span class="linenos">150</span></a>                <span class="c1">## compute maximum number of repeats</span>
</span><span id="GraphGenerator-151"><a href="#GraphGenerator-151"><span class="linenos">151</span></a>                <span class="n">inv_distances</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">reciprocal_cells</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span> <span class="o">**</span> <span class="mf">0.5</span>
</span><span id="GraphGenerator-152"><a href="#GraphGenerator-152"><span class="linenos">152</span></a>                <span class="n">num_repeats_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">cutoff_skin</span> <span class="o">*</span> <span class="n">inv_distances</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="GraphGenerator-153"><a href="#GraphGenerator-153"><span class="linenos">153</span></a>                <span class="n">num_repeats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">num_repeats_all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="GraphGenerator-154"><a href="#GraphGenerator-154"><span class="linenos">154</span></a>                <span class="n">num_repeats_prev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;num_repeats_pbc&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>
</span><span id="GraphGenerator-155"><a href="#GraphGenerator-155"><span class="linenos">155</span></a>                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">num_repeats</span> <span class="o">&gt;</span> <span class="n">num_repeats_prev</span><span class="p">):</span>
</span><span id="GraphGenerator-156"><a href="#GraphGenerator-156"><span class="linenos">156</span></a>                    <span class="n">num_repeats_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">num_repeats</span><span class="p">,</span> <span class="n">num_repeats_prev</span><span class="p">)</span>
</span><span id="GraphGenerator-157"><a href="#GraphGenerator-157"><span class="linenos">157</span></a>                    <span class="n">state_up</span><span class="p">[</span><span class="s2">&quot;num_repeats_pbc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="GraphGenerator-158"><a href="#GraphGenerator-158"><span class="linenos">158</span></a>                        <span class="nb">tuple</span><span class="p">(</span><span class="n">num_repeats_new</span><span class="p">),</span>
</span><span id="GraphGenerator-159"><a href="#GraphGenerator-159"><span class="linenos">159</span></a>                        <span class="nb">tuple</span><span class="p">(</span><span class="n">num_repeats_prev</span><span class="p">),</span>
</span><span id="GraphGenerator-160"><a href="#GraphGenerator-160"><span class="linenos">160</span></a>                    <span class="p">)</span>
</span><span id="GraphGenerator-161"><a href="#GraphGenerator-161"><span class="linenos">161</span></a>                    <span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;num_repeats_pbc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">num_repeats_new</span><span class="p">)</span>
</span><span id="GraphGenerator-162"><a href="#GraphGenerator-162"><span class="linenos">162</span></a>                <span class="c1">## build all possible shifts</span>
</span><span id="GraphGenerator-163"><a href="#GraphGenerator-163"><span class="linenos">163</span></a>                <span class="n">cell_shift_pbc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
</span><span id="GraphGenerator-164"><a href="#GraphGenerator-164"><span class="linenos">164</span></a>                    <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">num_repeats</span><span class="p">])</span>
</span><span id="GraphGenerator-165"><a href="#GraphGenerator-165"><span class="linenos">165</span></a>                <span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="GraphGenerator-166"><a href="#GraphGenerator-166"><span class="linenos">166</span></a>                <span class="c1">## shift applied to vectors</span>
</span><span id="GraphGenerator-167"><a href="#GraphGenerator-167"><span class="linenos">167</span></a>                <span class="k">if</span> <span class="n">cells</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="GraphGenerator-168"><a href="#GraphGenerator-168"><span class="linenos">168</span></a>                    <span class="n">dvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cell_shift_pbc</span><span class="p">,</span> <span class="n">cells</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
</span><span id="GraphGenerator-169"><a href="#GraphGenerator-169"><span class="linenos">169</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="GraphGenerator-170"><a href="#GraphGenerator-170"><span class="linenos">170</span></a>                    <span class="n">batch_index_vec</span> <span class="o">=</span> <span class="n">batch_index</span><span class="p">[</span><span class="n">p1</span><span class="p">]</span>
</span><span id="GraphGenerator-171"><a href="#GraphGenerator-171"><span class="linenos">171</span></a>                    <span class="n">dvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;bj,sji-&gt;sbi&quot;</span><span class="p">,</span> <span class="n">cell_shift_pbc</span><span class="p">,</span><span class="n">cells</span><span class="p">)[</span>
</span><span id="GraphGenerator-172"><a href="#GraphGenerator-172"><span class="linenos">172</span></a>                        <span class="n">batch_index_vec</span>
</span><span id="GraphGenerator-173"><a href="#GraphGenerator-173"><span class="linenos">173</span></a>                    <span class="p">]</span>
</span><span id="GraphGenerator-174"><a href="#GraphGenerator-174"><span class="linenos">174</span></a>                <span class="c1">## compute vectors</span>
</span><span id="GraphGenerator-175"><a href="#GraphGenerator-175"><span class="linenos">175</span></a>                <span class="n">vec</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="GraphGenerator-176"><a href="#GraphGenerator-176"><span class="linenos">176</span></a>                    <span class="n">coords_pbc</span><span class="p">[</span><span class="n">p2</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">coords_pbc</span><span class="p">[</span><span class="n">p1</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">dvec</span>
</span><span id="GraphGenerator-177"><a href="#GraphGenerator-177"><span class="linenos">177</span></a>                <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="GraphGenerator-178"><a href="#GraphGenerator-178"><span class="linenos">178</span></a>                <span class="n">pbc_shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span>
</span><span id="GraphGenerator-179"><a href="#GraphGenerator-179"><span class="linenos">179</span></a>                    <span class="n">cell_shift_pbc</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span>
</span><span id="GraphGenerator-180"><a href="#GraphGenerator-180"><span class="linenos">180</span></a>                    <span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cell_shift_pbc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">),</span>
</span><span id="GraphGenerator-181"><a href="#GraphGenerator-181"><span class="linenos">181</span></a>                <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="GraphGenerator-182"><a href="#GraphGenerator-182"><span class="linenos">182</span></a>                <span class="n">p1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span>
</span><span id="GraphGenerator-183"><a href="#GraphGenerator-183"><span class="linenos">183</span></a>                    <span class="n">p1</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cell_shift_pbc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="GraphGenerator-184"><a href="#GraphGenerator-184"><span class="linenos">184</span></a>                <span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="GraphGenerator-185"><a href="#GraphGenerator-185"><span class="linenos">185</span></a>                <span class="n">p2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span>
</span><span id="GraphGenerator-186"><a href="#GraphGenerator-186"><span class="linenos">186</span></a>                    <span class="n">p2</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="p">(</span><span class="n">p2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cell_shift_pbc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="GraphGenerator-187"><a href="#GraphGenerator-187"><span class="linenos">187</span></a>                <span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="GraphGenerator-188"><a href="#GraphGenerator-188"><span class="linenos">188</span></a>                <span class="k">if</span> <span class="n">natoms</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="GraphGenerator-189"><a href="#GraphGenerator-189"><span class="linenos">189</span></a>                    <span class="n">mask_p12</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span>
</span><span id="GraphGenerator-190"><a href="#GraphGenerator-190"><span class="linenos">190</span></a>                        <span class="n">mask_p12</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="p">(</span><span class="n">mask_p12</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cell_shift_pbc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="GraphGenerator-191"><a href="#GraphGenerator-191"><span class="linenos">191</span></a>                    <span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="GraphGenerator-192"><a href="#GraphGenerator-192"><span class="linenos">192</span></a>
</span><span id="GraphGenerator-193"><a href="#GraphGenerator-193"><span class="linenos">193</span></a>        <span class="c1">## compute distances</span>
</span><span id="GraphGenerator-194"><a href="#GraphGenerator-194"><span class="linenos">194</span></a>        <span class="n">d12</span> <span class="o">=</span> <span class="p">(</span><span class="n">vec</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="GraphGenerator-195"><a href="#GraphGenerator-195"><span class="linenos">195</span></a>        <span class="k">if</span> <span class="n">natoms</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="GraphGenerator-196"><a href="#GraphGenerator-196"><span class="linenos">196</span></a>            <span class="n">d12</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_p12</span><span class="p">,</span> <span class="n">d12</span><span class="p">,</span> <span class="n">cutoff_skin</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="GraphGenerator-197"><a href="#GraphGenerator-197"><span class="linenos">197</span></a>
</span><span id="GraphGenerator-198"><a href="#GraphGenerator-198"><span class="linenos">198</span></a>        <span class="c1">## filter pairs</span>
</span><span id="GraphGenerator-199"><a href="#GraphGenerator-199"><span class="linenos">199</span></a>        <span class="n">max_pairs</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;npairs&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="GraphGenerator-200"><a href="#GraphGenerator-200"><span class="linenos">200</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">d12</span> <span class="o">&lt;</span> <span class="n">cutoff_skin</span><span class="o">**</span><span class="mi">2</span>
</span><span id="GraphGenerator-201"><a href="#GraphGenerator-201"><span class="linenos">201</span></a>        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">mask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="GraphGenerator-202"><a href="#GraphGenerator-202"><span class="linenos">202</span></a>        <span class="n">npairs</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="GraphGenerator-203"><a href="#GraphGenerator-203"><span class="linenos">203</span></a>        <span class="k">if</span> <span class="n">npairs</span> <span class="o">&gt;</span> <span class="n">max_pairs</span> <span class="ow">or</span> <span class="n">add_margin</span><span class="p">:</span>
</span><span id="GraphGenerator-204"><a href="#GraphGenerator-204"><span class="linenos">204</span></a>            <span class="n">mult_size</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nblist_mult_size&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mult_size</span><span class="p">)</span>
</span><span id="GraphGenerator-205"><a href="#GraphGenerator-205"><span class="linenos">205</span></a>            <span class="n">prev_max_pairs</span> <span class="o">=</span> <span class="n">max_pairs</span>
</span><span id="GraphGenerator-206"><a href="#GraphGenerator-206"><span class="linenos">206</span></a>            <span class="n">max_pairs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mult_size</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">npairs</span><span class="p">,</span> <span class="n">max_pairs</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="GraphGenerator-207"><a href="#GraphGenerator-207"><span class="linenos">207</span></a>            <span class="n">state_up</span><span class="p">[</span><span class="s2">&quot;npairs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_pairs</span><span class="p">,</span> <span class="n">prev_max_pairs</span><span class="p">)</span>
</span><span id="GraphGenerator-208"><a href="#GraphGenerator-208"><span class="linenos">208</span></a>            <span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;npairs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_pairs</span>
</span><span id="GraphGenerator-209"><a href="#GraphGenerator-209"><span class="linenos">209</span></a>
</span><span id="GraphGenerator-210"><a href="#GraphGenerator-210"><span class="linenos">210</span></a>        <span class="n">nat</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="GraphGenerator-211"><a href="#GraphGenerator-211"><span class="linenos">211</span></a>        <span class="n">edge_src</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">max_pairs</span><span class="p">,</span> <span class="n">nat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="GraphGenerator-212"><a href="#GraphGenerator-212"><span class="linenos">212</span></a>        <span class="n">edge_dst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">max_pairs</span><span class="p">,</span> <span class="n">nat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="GraphGenerator-213"><a href="#GraphGenerator-213"><span class="linenos">213</span></a>        <span class="n">d12_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">max_pairs</span><span class="p">,</span> <span class="n">cutoff_skin</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="GraphGenerator-214"><a href="#GraphGenerator-214"><span class="linenos">214</span></a>        <span class="n">edge_src</span><span class="p">[:</span><span class="n">npairs</span><span class="p">]</span> <span class="o">=</span> <span class="n">p1</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="GraphGenerator-215"><a href="#GraphGenerator-215"><span class="linenos">215</span></a>        <span class="n">edge_dst</span><span class="p">[:</span><span class="n">npairs</span><span class="p">]</span> <span class="o">=</span> <span class="n">p2</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="GraphGenerator-216"><a href="#GraphGenerator-216"><span class="linenos">216</span></a>        <span class="n">d12_</span><span class="p">[:</span><span class="n">npairs</span><span class="p">]</span> <span class="o">=</span> <span class="n">d12</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="GraphGenerator-217"><a href="#GraphGenerator-217"><span class="linenos">217</span></a>        <span class="n">d12</span> <span class="o">=</span> <span class="n">d12_</span>
</span><span id="GraphGenerator-218"><a href="#GraphGenerator-218"><span class="linenos">218</span></a>
</span><span id="GraphGenerator-219"><a href="#GraphGenerator-219"><span class="linenos">219</span></a>        <span class="k">if</span> <span class="n">apply_pbc</span><span class="p">:</span>
</span><span id="GraphGenerator-220"><a href="#GraphGenerator-220"><span class="linenos">220</span></a>            <span class="n">pbc_shifts_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">max_pairs</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
</span><span id="GraphGenerator-221"><a href="#GraphGenerator-221"><span class="linenos">221</span></a>            <span class="n">pbc_shifts_</span><span class="p">[:</span><span class="n">npairs</span><span class="p">]</span> <span class="o">=</span> <span class="n">pbc_shifts</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="GraphGenerator-222"><a href="#GraphGenerator-222"><span class="linenos">222</span></a>            <span class="n">pbc_shifts</span> <span class="o">=</span> <span class="n">pbc_shifts_</span>
</span><span id="GraphGenerator-223"><a href="#GraphGenerator-223"><span class="linenos">223</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">minimage</span><span class="p">:</span>
</span><span id="GraphGenerator-224"><a href="#GraphGenerator-224"><span class="linenos">224</span></a>                <span class="n">pbc_shifts</span><span class="p">[:</span><span class="n">npairs</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="GraphGenerator-225"><a href="#GraphGenerator-225"><span class="linenos">225</span></a>                    <span class="n">pbc_shifts</span><span class="p">[:</span><span class="n">npairs</span><span class="p">]</span>
</span><span id="GraphGenerator-226"><a href="#GraphGenerator-226"><span class="linenos">226</span></a>                    <span class="o">+</span> <span class="n">at_shifts</span><span class="p">[</span><span class="n">edge_dst</span><span class="p">[:</span><span class="n">npairs</span><span class="p">]]</span>
</span><span id="GraphGenerator-227"><a href="#GraphGenerator-227"><span class="linenos">227</span></a>                    <span class="o">-</span> <span class="n">at_shifts</span><span class="p">[</span><span class="n">edge_src</span><span class="p">[:</span><span class="n">npairs</span><span class="p">]]</span>
</span><span id="GraphGenerator-228"><a href="#GraphGenerator-228"><span class="linenos">228</span></a>                <span class="p">)</span>
</span><span id="GraphGenerator-229"><a href="#GraphGenerator-229"><span class="linenos">229</span></a>
</span><span id="GraphGenerator-230"><a href="#GraphGenerator-230"><span class="linenos">230</span></a>        <span class="k">if</span> <span class="s2">&quot;nblist_skin&quot;</span> <span class="ow">in</span> <span class="n">state</span><span class="p">:</span>
</span><span id="GraphGenerator-231"><a href="#GraphGenerator-231"><span class="linenos">231</span></a>            <span class="n">edge_src_skin</span> <span class="o">=</span> <span class="n">edge_src</span>
</span><span id="GraphGenerator-232"><a href="#GraphGenerator-232"><span class="linenos">232</span></a>            <span class="n">edge_dst_skin</span> <span class="o">=</span> <span class="n">edge_dst</span>
</span><span id="GraphGenerator-233"><a href="#GraphGenerator-233"><span class="linenos">233</span></a>            <span class="k">if</span> <span class="n">apply_pbc</span><span class="p">:</span>
</span><span id="GraphGenerator-234"><a href="#GraphGenerator-234"><span class="linenos">234</span></a>                <span class="n">pbc_shifts_skin</span> <span class="o">=</span> <span class="n">pbc_shifts</span>
</span><span id="GraphGenerator-235"><a href="#GraphGenerator-235"><span class="linenos">235</span></a>            <span class="n">max_pairs_skin</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;npairs_skin&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="GraphGenerator-236"><a href="#GraphGenerator-236"><span class="linenos">236</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="n">d12</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="o">**</span><span class="mi">2</span>
</span><span id="GraphGenerator-237"><a href="#GraphGenerator-237"><span class="linenos">237</span></a>            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">mask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="GraphGenerator-238"><a href="#GraphGenerator-238"><span class="linenos">238</span></a>            <span class="n">npairs_skin</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="GraphGenerator-239"><a href="#GraphGenerator-239"><span class="linenos">239</span></a>            <span class="k">if</span> <span class="n">npairs_skin</span> <span class="o">&gt;</span> <span class="n">max_pairs_skin</span> <span class="ow">or</span> <span class="n">add_margin</span><span class="p">:</span>
</span><span id="GraphGenerator-240"><a href="#GraphGenerator-240"><span class="linenos">240</span></a>                <span class="n">mult_size</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nblist_mult_size&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mult_size</span><span class="p">)</span>
</span><span id="GraphGenerator-241"><a href="#GraphGenerator-241"><span class="linenos">241</span></a>                <span class="n">prev_max_pairs_skin</span> <span class="o">=</span> <span class="n">max_pairs_skin</span>
</span><span id="GraphGenerator-242"><a href="#GraphGenerator-242"><span class="linenos">242</span></a>                <span class="n">max_pairs_skin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mult_size</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">npairs_skin</span><span class="p">,</span> <span class="n">max_pairs_skin</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="GraphGenerator-243"><a href="#GraphGenerator-243"><span class="linenos">243</span></a>                <span class="n">state_up</span><span class="p">[</span><span class="s2">&quot;npairs_skin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_pairs_skin</span><span class="p">,</span> <span class="n">prev_max_pairs_skin</span><span class="p">)</span>
</span><span id="GraphGenerator-244"><a href="#GraphGenerator-244"><span class="linenos">244</span></a>                <span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;npairs_skin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_pairs_skin</span>
</span><span id="GraphGenerator-245"><a href="#GraphGenerator-245"><span class="linenos">245</span></a>            <span class="n">edge_src</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">max_pairs_skin</span><span class="p">,</span> <span class="n">nat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="GraphGenerator-246"><a href="#GraphGenerator-246"><span class="linenos">246</span></a>            <span class="n">edge_dst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">max_pairs_skin</span><span class="p">,</span> <span class="n">nat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="GraphGenerator-247"><a href="#GraphGenerator-247"><span class="linenos">247</span></a>            <span class="n">d12_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">max_pairs_skin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="GraphGenerator-248"><a href="#GraphGenerator-248"><span class="linenos">248</span></a>            <span class="n">edge_src</span><span class="p">[:</span><span class="n">npairs_skin</span><span class="p">]</span> <span class="o">=</span> <span class="n">edge_src_skin</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="GraphGenerator-249"><a href="#GraphGenerator-249"><span class="linenos">249</span></a>            <span class="n">edge_dst</span><span class="p">[:</span><span class="n">npairs_skin</span><span class="p">]</span> <span class="o">=</span> <span class="n">edge_dst_skin</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="GraphGenerator-250"><a href="#GraphGenerator-250"><span class="linenos">250</span></a>            <span class="n">d12_</span><span class="p">[:</span><span class="n">npairs_skin</span><span class="p">]</span> <span class="o">=</span> <span class="n">d12</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="GraphGenerator-251"><a href="#GraphGenerator-251"><span class="linenos">251</span></a>            <span class="n">d12</span> <span class="o">=</span> <span class="n">d12_</span>
</span><span id="GraphGenerator-252"><a href="#GraphGenerator-252"><span class="linenos">252</span></a>            <span class="k">if</span> <span class="n">apply_pbc</span><span class="p">:</span>
</span><span id="GraphGenerator-253"><a href="#GraphGenerator-253"><span class="linenos">253</span></a>                <span class="n">pbc_shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">max_pairs_skin</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">)</span>
</span><span id="GraphGenerator-254"><a href="#GraphGenerator-254"><span class="linenos">254</span></a>                <span class="n">pbc_shifts</span><span class="p">[:</span><span class="n">npairs_skin</span><span class="p">]</span> <span class="o">=</span> <span class="n">pbc_shifts_skin</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="GraphGenerator-255"><a href="#GraphGenerator-255"><span class="linenos">255</span></a>
</span><span id="GraphGenerator-256"><a href="#GraphGenerator-256"><span class="linenos">256</span></a>        <span class="c1">## symmetrize</span>
</span><span id="GraphGenerator-257"><a href="#GraphGenerator-257"><span class="linenos">257</span></a>        <span class="n">edge_src</span><span class="p">,</span> <span class="n">edge_dst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">edge_src</span><span class="p">,</span> <span class="n">edge_dst</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
</span><span id="GraphGenerator-258"><a href="#GraphGenerator-258"><span class="linenos">258</span></a>            <span class="p">(</span><span class="n">edge_dst</span><span class="p">,</span> <span class="n">edge_src</span><span class="p">)</span>
</span><span id="GraphGenerator-259"><a href="#GraphGenerator-259"><span class="linenos">259</span></a>        <span class="p">)</span>
</span><span id="GraphGenerator-260"><a href="#GraphGenerator-260"><span class="linenos">260</span></a>        <span class="n">d12</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">d12</span><span class="p">,</span> <span class="n">d12</span><span class="p">))</span>
</span><span id="GraphGenerator-261"><a href="#GraphGenerator-261"><span class="linenos">261</span></a>        <span class="k">if</span> <span class="n">apply_pbc</span><span class="p">:</span>
</span><span id="GraphGenerator-262"><a href="#GraphGenerator-262"><span class="linenos">262</span></a>            <span class="n">pbc_shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">pbc_shifts</span><span class="p">,</span> <span class="o">-</span><span class="n">pbc_shifts</span><span class="p">))</span>
</span><span id="GraphGenerator-263"><a href="#GraphGenerator-263"><span class="linenos">263</span></a>
</span><span id="GraphGenerator-264"><a href="#GraphGenerator-264"><span class="linenos">264</span></a>        <span class="n">graph</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="GraphGenerator-265"><a href="#GraphGenerator-265"><span class="linenos">265</span></a>        <span class="n">graph_out</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="GraphGenerator-266"><a href="#GraphGenerator-266"><span class="linenos">266</span></a>            <span class="o">**</span><span class="n">graph</span><span class="p">,</span>
</span><span id="GraphGenerator-267"><a href="#GraphGenerator-267"><span class="linenos">267</span></a>            <span class="s2">&quot;edge_src&quot;</span><span class="p">:</span> <span class="n">edge_src</span><span class="p">,</span>
</span><span id="GraphGenerator-268"><a href="#GraphGenerator-268"><span class="linenos">268</span></a>            <span class="s2">&quot;edge_dst&quot;</span><span class="p">:</span> <span class="n">edge_dst</span><span class="p">,</span>
</span><span id="GraphGenerator-269"><a href="#GraphGenerator-269"><span class="linenos">269</span></a>            <span class="s2">&quot;d12&quot;</span><span class="p">:</span> <span class="n">d12</span><span class="p">,</span>
</span><span id="GraphGenerator-270"><a href="#GraphGenerator-270"><span class="linenos">270</span></a>            <span class="s2">&quot;overflow&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="GraphGenerator-271"><a href="#GraphGenerator-271"><span class="linenos">271</span></a>            <span class="s2">&quot;pbc_shifts&quot;</span><span class="p">:</span> <span class="n">pbc_shifts</span><span class="p">,</span>
</span><span id="GraphGenerator-272"><a href="#GraphGenerator-272"><span class="linenos">272</span></a>        <span class="p">}</span>
</span><span id="GraphGenerator-273"><a href="#GraphGenerator-273"><span class="linenos">273</span></a>        <span class="k">if</span> <span class="s2">&quot;nblist_skin&quot;</span> <span class="ow">in</span> <span class="n">state</span><span class="p">:</span>
</span><span id="GraphGenerator-274"><a href="#GraphGenerator-274"><span class="linenos">274</span></a>            <span class="n">graph_out</span><span class="p">[</span><span class="s2">&quot;edge_src_skin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">edge_src_skin</span>
</span><span id="GraphGenerator-275"><a href="#GraphGenerator-275"><span class="linenos">275</span></a>            <span class="n">graph_out</span><span class="p">[</span><span class="s2">&quot;edge_dst_skin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">edge_dst_skin</span>
</span><span id="GraphGenerator-276"><a href="#GraphGenerator-276"><span class="linenos">276</span></a>            <span class="k">if</span> <span class="n">apply_pbc</span><span class="p">:</span>
</span><span id="GraphGenerator-277"><a href="#GraphGenerator-277"><span class="linenos">277</span></a>                <span class="n">graph_out</span><span class="p">[</span><span class="s2">&quot;pbc_shifts_skin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pbc_shifts_skin</span>
</span><span id="GraphGenerator-278"><a href="#GraphGenerator-278"><span class="linenos">278</span></a>
</span><span id="GraphGenerator-279"><a href="#GraphGenerator-279"><span class="linenos">279</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_space</span> <span class="ow">and</span> <span class="n">apply_pbc</span><span class="p">:</span>
</span><span id="GraphGenerator-280"><a href="#GraphGenerator-280"><span class="linenos">280</span></a>            <span class="k">if</span> <span class="s2">&quot;k_points&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">graph</span><span class="p">:</span>
</span><span id="GraphGenerator-281"><a href="#GraphGenerator-281"><span class="linenos">281</span></a>                <span class="n">ks</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">bewald</span> <span class="o">=</span> <span class="n">get_reciprocal_space_parameters</span><span class="p">(</span>
</span><span id="GraphGenerator-282"><a href="#GraphGenerator-282"><span class="linenos">282</span></a>                    <span class="n">reciprocal_cells</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kthr</span>
</span><span id="GraphGenerator-283"><a href="#GraphGenerator-283"><span class="linenos">283</span></a>                <span class="p">)</span>
</span><span id="GraphGenerator-284"><a href="#GraphGenerator-284"><span class="linenos">284</span></a>            <span class="n">graph_out</span><span class="p">[</span><span class="s2">&quot;k_points&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ks</span>
</span><span id="GraphGenerator-285"><a href="#GraphGenerator-285"><span class="linenos">285</span></a>            <span class="n">graph_out</span><span class="p">[</span><span class="s2">&quot;b_ewald&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bewald</span>
</span><span id="GraphGenerator-286"><a href="#GraphGenerator-286"><span class="linenos">286</span></a>
</span><span id="GraphGenerator-287"><a href="#GraphGenerator-287"><span class="linenos">287</span></a>        <span class="n">output</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">:</span> <span class="n">graph_out</span><span class="p">}</span>
</span><span id="GraphGenerator-288"><a href="#GraphGenerator-288"><span class="linenos">288</span></a>
</span><span id="GraphGenerator-289"><a href="#GraphGenerator-289"><span class="linenos">289</span></a>        <span class="k">if</span> <span class="n">return_state_update</span><span class="p">:</span>
</span><span id="GraphGenerator-290"><a href="#GraphGenerator-290"><span class="linenos">290</span></a>            <span class="k">return</span> <span class="n">FrozenDict</span><span class="p">(</span><span class="n">new_state</span><span class="p">),</span> <span class="n">output</span><span class="p">,</span> <span class="n">state_up</span>
</span><span id="GraphGenerator-291"><a href="#GraphGenerator-291"><span class="linenos">291</span></a>        <span class="k">return</span> <span class="n">FrozenDict</span><span class="p">(</span><span class="n">new_state</span><span class="p">),</span> <span class="n">output</span>
</span><span id="GraphGenerator-292"><a href="#GraphGenerator-292"><span class="linenos">292</span></a>
</span><span id="GraphGenerator-293"><a href="#GraphGenerator-293"><span class="linenos">293</span></a>    <span class="k">def</span> <span class="nf">check_reallocate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">parent_overflow</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="GraphGenerator-294"><a href="#GraphGenerator-294"><span class="linenos">294</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;check for overflow and reallocate nblist if necessary&quot;&quot;&quot;</span>
</span><span id="GraphGenerator-295"><a href="#GraphGenerator-295"><span class="linenos">295</span></a>        <span class="n">overflow</span> <span class="o">=</span> <span class="n">parent_overflow</span> <span class="ow">or</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;overflow&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="GraphGenerator-296"><a href="#GraphGenerator-296"><span class="linenos">296</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">overflow</span><span class="p">:</span>
</span><span id="GraphGenerator-297"><a href="#GraphGenerator-297"><span class="linenos">297</span></a>            <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="p">{},</span> <span class="n">inputs</span><span class="p">,</span> <span class="kc">False</span>
</span><span id="GraphGenerator-298"><a href="#GraphGenerator-298"><span class="linenos">298</span></a>
</span><span id="GraphGenerator-299"><a href="#GraphGenerator-299"><span class="linenos">299</span></a>        <span class="n">add_margin</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;overflow&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="GraphGenerator-300"><a href="#GraphGenerator-300"><span class="linenos">300</span></a>        <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">state_up</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span>
</span><span id="GraphGenerator-301"><a href="#GraphGenerator-301"><span class="linenos">301</span></a>            <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">return_state_update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">add_margin</span><span class="o">=</span><span class="n">add_margin</span>
</span><span id="GraphGenerator-302"><a href="#GraphGenerator-302"><span class="linenos">302</span></a>        <span class="p">)</span>
</span><span id="GraphGenerator-303"><a href="#GraphGenerator-303"><span class="linenos">303</span></a>        <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="n">state_up</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="kc">True</span>
</span><span id="GraphGenerator-304"><a href="#GraphGenerator-304"><span class="linenos">304</span></a>
</span><span id="GraphGenerator-305"><a href="#GraphGenerator-305"><span class="linenos">305</span></a>    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="GraphGenerator-306"><a href="#GraphGenerator-306"><span class="linenos">306</span></a>    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
</span><span id="GraphGenerator-307"><a href="#GraphGenerator-307"><span class="linenos">307</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;build a nblist on accelerator with jax and precomputed shapes&quot;&quot;&quot;</span>
</span><span id="GraphGenerator-308"><a href="#GraphGenerator-308"><span class="linenos">308</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
</span><span id="GraphGenerator-309"><a href="#GraphGenerator-309"><span class="linenos">309</span></a>            <span class="n">graph</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">]</span>
</span><span id="GraphGenerator-310"><a href="#GraphGenerator-310"><span class="linenos">310</span></a>            <span class="k">if</span> <span class="s2">&quot;keep_graph&quot;</span> <span class="ow">in</span> <span class="n">graph</span><span class="p">:</span>
</span><span id="GraphGenerator-311"><a href="#GraphGenerator-311"><span class="linenos">311</span></a>                <span class="k">return</span> <span class="n">inputs</span>
</span><span id="GraphGenerator-312"><a href="#GraphGenerator-312"><span class="linenos">312</span></a>        <span class="n">coords</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;coordinates&quot;</span><span class="p">]</span>
</span><span id="GraphGenerator-313"><a href="#GraphGenerator-313"><span class="linenos">313</span></a>        <span class="n">natoms</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;natoms&quot;</span><span class="p">]</span>
</span><span id="GraphGenerator-314"><a href="#GraphGenerator-314"><span class="linenos">314</span></a>        <span class="n">batch_index</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;batch_index&quot;</span><span class="p">]</span>
</span><span id="GraphGenerator-315"><a href="#GraphGenerator-315"><span class="linenos">315</span></a>
</span><span id="GraphGenerator-316"><a href="#GraphGenerator-316"><span class="linenos">316</span></a>        <span class="n">max_nat</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_nat&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">natoms</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
</span><span id="GraphGenerator-317"><a href="#GraphGenerator-317"><span class="linenos">317</span></a>
</span><span id="GraphGenerator-318"><a href="#GraphGenerator-318"><span class="linenos">318</span></a>        <span class="c1">### compute indices of all pairs</span>
</span><span id="GraphGenerator-319"><a href="#GraphGenerator-319"><span class="linenos">319</span></a>        <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">triu_indices</span><span class="p">(</span><span class="n">max_nat</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="GraphGenerator-320"><a href="#GraphGenerator-320"><span class="linenos">320</span></a>        <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">p1</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">p2</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="GraphGenerator-321"><a href="#GraphGenerator-321"><span class="linenos">321</span></a>        <span class="n">pbc_shifts</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="GraphGenerator-322"><a href="#GraphGenerator-322"><span class="linenos">322</span></a>        <span class="k">if</span> <span class="n">natoms</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="GraphGenerator-323"><a href="#GraphGenerator-323"><span class="linenos">323</span></a>            <span class="c1">## batching =&gt; mask irrelevant pairs</span>
</span><span id="GraphGenerator-324"><a href="#GraphGenerator-324"><span class="linenos">324</span></a>            <span class="n">mask_p12</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="GraphGenerator-325"><a href="#GraphGenerator-325"><span class="linenos">325</span></a>                <span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&lt;</span> <span class="n">natoms</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">p2</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&lt;</span> <span class="n">natoms</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span>
</span><span id="GraphGenerator-326"><a href="#GraphGenerator-326"><span class="linenos">326</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="GraphGenerator-327"><a href="#GraphGenerator-327"><span class="linenos">327</span></a>            <span class="n">shift</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
</span><span id="GraphGenerator-328"><a href="#GraphGenerator-328"><span class="linenos">328</span></a>                <span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">natoms</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
</span><span id="GraphGenerator-329"><a href="#GraphGenerator-329"><span class="linenos">329</span></a>            <span class="p">)</span>
</span><span id="GraphGenerator-330"><a href="#GraphGenerator-330"><span class="linenos">330</span></a>            <span class="n">p1</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_p12</span><span class="p">,</span> <span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">shift</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="GraphGenerator-331"><a href="#GraphGenerator-331"><span class="linenos">331</span></a>            <span class="n">p2</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_p12</span><span class="p">,</span> <span class="p">(</span><span class="n">p2</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">shift</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="GraphGenerator-332"><a href="#GraphGenerator-332"><span class="linenos">332</span></a>
</span><span id="GraphGenerator-333"><a href="#GraphGenerator-333"><span class="linenos">333</span></a>        <span class="c1">## compute vectors</span>
</span><span id="GraphGenerator-334"><a href="#GraphGenerator-334"><span class="linenos">334</span></a>        <span class="k">if</span> <span class="s2">&quot;cells&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
</span><span id="GraphGenerator-335"><a href="#GraphGenerator-335"><span class="linenos">335</span></a>            <span class="n">vec</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">p2</span><span class="p">]</span> <span class="o">-</span> <span class="n">coords</span><span class="p">[</span><span class="n">p1</span><span class="p">]</span>
</span><span id="GraphGenerator-336"><a href="#GraphGenerator-336"><span class="linenos">336</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="GraphGenerator-337"><a href="#GraphGenerator-337"><span class="linenos">337</span></a>            <span class="n">cells</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;cells&quot;</span><span class="p">]</span>
</span><span id="GraphGenerator-338"><a href="#GraphGenerator-338"><span class="linenos">338</span></a>            <span class="n">reciprocal_cells</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;reciprocal_cells&quot;</span><span class="p">]</span>
</span><span id="GraphGenerator-339"><a href="#GraphGenerator-339"><span class="linenos">339</span></a>            <span class="n">minimage</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;minimum_image&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="GraphGenerator-340"><a href="#GraphGenerator-340"><span class="linenos">340</span></a>
</span><span id="GraphGenerator-341"><a href="#GraphGenerator-341"><span class="linenos">341</span></a>            <span class="k">def</span> <span class="nf">compute_pbc</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">reciprocal_cell</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;round&quot;</span><span class="p">):</span>
</span><span id="GraphGenerator-342"><a href="#GraphGenerator-342"><span class="linenos">342</span></a>                <span class="n">vecpbc</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">reciprocal_cell</span><span class="p">)</span>
</span><span id="GraphGenerator-343"><a href="#GraphGenerator-343"><span class="linenos">343</span></a>                <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;round&quot;</span><span class="p">:</span>
</span><span id="GraphGenerator-344"><a href="#GraphGenerator-344"><span class="linenos">344</span></a>                    <span class="n">pbc_shifts</span> <span class="o">=</span> <span class="o">-</span><span class="n">jnp</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">vecpbc</span><span class="p">)</span>
</span><span id="GraphGenerator-345"><a href="#GraphGenerator-345"><span class="linenos">345</span></a>                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;floor&quot;</span><span class="p">:</span>
</span><span id="GraphGenerator-346"><a href="#GraphGenerator-346"><span class="linenos">346</span></a>                    <span class="n">pbc_shifts</span> <span class="o">=</span> <span class="o">-</span><span class="n">jnp</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">vecpbc</span><span class="p">)</span>
</span><span id="GraphGenerator-347"><a href="#GraphGenerator-347"><span class="linenos">347</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="GraphGenerator-348"><a href="#GraphGenerator-348"><span class="linenos">348</span></a>                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown mode </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2"> for compute_pbc.&quot;</span><span class="p">)</span>
</span><span id="GraphGenerator-349"><a href="#GraphGenerator-349"><span class="linenos">349</span></a>                <span class="k">return</span> <span class="n">vec</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pbc_shifts</span><span class="p">,</span> <span class="n">cell</span><span class="p">),</span> <span class="n">pbc_shifts</span>
</span><span id="GraphGenerator-350"><a href="#GraphGenerator-350"><span class="linenos">350</span></a>
</span><span id="GraphGenerator-351"><a href="#GraphGenerator-351"><span class="linenos">351</span></a>            <span class="k">if</span> <span class="n">minimage</span><span class="p">:</span>
</span><span id="GraphGenerator-352"><a href="#GraphGenerator-352"><span class="linenos">352</span></a>                <span class="c1">## minimum image convention</span>
</span><span id="GraphGenerator-353"><a href="#GraphGenerator-353"><span class="linenos">353</span></a>                <span class="n">vec</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">p2</span><span class="p">]</span> <span class="o">-</span> <span class="n">coords</span><span class="p">[</span><span class="n">p1</span><span class="p">]</span>
</span><span id="GraphGenerator-354"><a href="#GraphGenerator-354"><span class="linenos">354</span></a>
</span><span id="GraphGenerator-355"><a href="#GraphGenerator-355"><span class="linenos">355</span></a>                <span class="k">if</span> <span class="n">cells</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="GraphGenerator-356"><a href="#GraphGenerator-356"><span class="linenos">356</span></a>                    <span class="n">vec</span><span class="p">,</span> <span class="n">pbc_shifts</span> <span class="o">=</span> <span class="n">compute_pbc</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">reciprocal_cells</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cells</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="GraphGenerator-357"><a href="#GraphGenerator-357"><span class="linenos">357</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="GraphGenerator-358"><a href="#GraphGenerator-358"><span class="linenos">358</span></a>                    <span class="n">batch_index_vec</span> <span class="o">=</span> <span class="n">batch_index</span><span class="p">[</span><span class="n">p1</span><span class="p">]</span>
</span><span id="GraphGenerator-359"><a href="#GraphGenerator-359"><span class="linenos">359</span></a>                    <span class="n">vec</span><span class="p">,</span> <span class="n">pbc_shifts</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="n">compute_pbc</span><span class="p">)(</span>
</span><span id="GraphGenerator-360"><a href="#GraphGenerator-360"><span class="linenos">360</span></a>                        <span class="n">vec</span><span class="p">,</span> <span class="n">reciprocal_cells</span><span class="p">[</span><span class="n">batch_index_vec</span><span class="p">],</span> <span class="n">cells</span><span class="p">[</span><span class="n">batch_index_vec</span><span class="p">]</span>
</span><span id="GraphGenerator-361"><a href="#GraphGenerator-361"><span class="linenos">361</span></a>                    <span class="p">)</span>
</span><span id="GraphGenerator-362"><a href="#GraphGenerator-362"><span class="linenos">362</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="GraphGenerator-363"><a href="#GraphGenerator-363"><span class="linenos">363</span></a>                <span class="c1">### general PBC only for single cell yet</span>
</span><span id="GraphGenerator-364"><a href="#GraphGenerator-364"><span class="linenos">364</span></a>                <span class="k">if</span> <span class="n">cells</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="GraphGenerator-365"><a href="#GraphGenerator-365"><span class="linenos">365</span></a>                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
</span><span id="GraphGenerator-366"><a href="#GraphGenerator-366"><span class="linenos">366</span></a>                        <span class="s2">&quot;General PBC not implemented for batches on accelerator.&quot;</span>
</span><span id="GraphGenerator-367"><a href="#GraphGenerator-367"><span class="linenos">367</span></a>                    <span class="p">)</span>
</span><span id="GraphGenerator-368"><a href="#GraphGenerator-368"><span class="linenos">368</span></a>                <span class="n">cell</span> <span class="o">=</span> <span class="n">cells</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="GraphGenerator-369"><a href="#GraphGenerator-369"><span class="linenos">369</span></a>                <span class="n">reciprocal_cell</span> <span class="o">=</span> <span class="n">reciprocal_cells</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="GraphGenerator-370"><a href="#GraphGenerator-370"><span class="linenos">370</span></a>
</span><span id="GraphGenerator-371"><a href="#GraphGenerator-371"><span class="linenos">371</span></a>                <span class="c1">## put all atoms in central box</span>
</span><span id="GraphGenerator-372"><a href="#GraphGenerator-372"><span class="linenos">372</span></a>                <span class="n">coords_pbc</span><span class="p">,</span> <span class="n">at_shifts</span> <span class="o">=</span> <span class="n">compute_pbc</span><span class="p">(</span>
</span><span id="GraphGenerator-373"><a href="#GraphGenerator-373"><span class="linenos">373</span></a>                    <span class="n">coords</span><span class="p">,</span> <span class="n">reciprocal_cell</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;floor&quot;</span>
</span><span id="GraphGenerator-374"><a href="#GraphGenerator-374"><span class="linenos">374</span></a>                <span class="p">)</span>
</span><span id="GraphGenerator-375"><a href="#GraphGenerator-375"><span class="linenos">375</span></a>                <span class="n">num_repeats</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;num_repeats_pbc&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="GraphGenerator-376"><a href="#GraphGenerator-376"><span class="linenos">376</span></a>                <span class="k">if</span> <span class="n">num_repeats</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="GraphGenerator-377"><a href="#GraphGenerator-377"><span class="linenos">377</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="GraphGenerator-378"><a href="#GraphGenerator-378"><span class="linenos">378</span></a>                        <span class="s2">&quot;num_repeats_pbc should be provided for general PBC on accelerator. Call the numpy routine (self.__call__) first.&quot;</span>
</span><span id="GraphGenerator-379"><a href="#GraphGenerator-379"><span class="linenos">379</span></a>                    <span class="p">)</span>
</span><span id="GraphGenerator-380"><a href="#GraphGenerator-380"><span class="linenos">380</span></a>                <span class="n">cell_shift_pbc</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
</span><span id="GraphGenerator-381"><a href="#GraphGenerator-381"><span class="linenos">381</span></a>                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
</span><span id="GraphGenerator-382"><a href="#GraphGenerator-382"><span class="linenos">382</span></a>                        <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">num_repeats</span><span class="p">]),</span>
</span><span id="GraphGenerator-383"><a href="#GraphGenerator-383"><span class="linenos">383</span></a>                        <span class="n">dtype</span><span class="o">=</span><span class="n">cell</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
</span><span id="GraphGenerator-384"><a href="#GraphGenerator-384"><span class="linenos">384</span></a>                    <span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="GraphGenerator-385"><a href="#GraphGenerator-385"><span class="linenos">385</span></a>                <span class="p">)</span>
</span><span id="GraphGenerator-386"><a href="#GraphGenerator-386"><span class="linenos">386</span></a>                <span class="n">vec</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="GraphGenerator-387"><a href="#GraphGenerator-387"><span class="linenos">387</span></a>                    <span class="n">coords_pbc</span><span class="p">[</span><span class="n">p2</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="GraphGenerator-388"><a href="#GraphGenerator-388"><span class="linenos">388</span></a>                    <span class="o">-</span> <span class="n">coords_pbc</span><span class="p">[</span><span class="n">p1</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="GraphGenerator-389"><a href="#GraphGenerator-389"><span class="linenos">389</span></a>                    <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cell_shift_pbc</span><span class="p">,</span> <span class="n">cell</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
</span><span id="GraphGenerator-390"><a href="#GraphGenerator-390"><span class="linenos">390</span></a>                <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="GraphGenerator-391"><a href="#GraphGenerator-391"><span class="linenos">391</span></a>                <span class="n">pbc_shifts</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span>
</span><span id="GraphGenerator-392"><a href="#GraphGenerator-392"><span class="linenos">392</span></a>                    <span class="n">cell_shift_pbc</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span>
</span><span id="GraphGenerator-393"><a href="#GraphGenerator-393"><span class="linenos">393</span></a>                    <span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cell_shift_pbc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">),</span>
</span><span id="GraphGenerator-394"><a href="#GraphGenerator-394"><span class="linenos">394</span></a>                <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="GraphGenerator-395"><a href="#GraphGenerator-395"><span class="linenos">395</span></a>                <span class="n">p1</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span>
</span><span id="GraphGenerator-396"><a href="#GraphGenerator-396"><span class="linenos">396</span></a>                    <span class="n">p1</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cell_shift_pbc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="GraphGenerator-397"><a href="#GraphGenerator-397"><span class="linenos">397</span></a>                <span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="GraphGenerator-398"><a href="#GraphGenerator-398"><span class="linenos">398</span></a>                <span class="n">p2</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span>
</span><span id="GraphGenerator-399"><a href="#GraphGenerator-399"><span class="linenos">399</span></a>                    <span class="n">p2</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="p">(</span><span class="n">p2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cell_shift_pbc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="GraphGenerator-400"><a href="#GraphGenerator-400"><span class="linenos">400</span></a>                <span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="GraphGenerator-401"><a href="#GraphGenerator-401"><span class="linenos">401</span></a>                <span class="k">if</span> <span class="n">natoms</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="GraphGenerator-402"><a href="#GraphGenerator-402"><span class="linenos">402</span></a>                    <span class="n">mask_p12</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span>
</span><span id="GraphGenerator-403"><a href="#GraphGenerator-403"><span class="linenos">403</span></a>                        <span class="n">mask_p12</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="p">(</span><span class="n">mask_p12</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cell_shift_pbc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="GraphGenerator-404"><a href="#GraphGenerator-404"><span class="linenos">404</span></a>                    <span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="GraphGenerator-405"><a href="#GraphGenerator-405"><span class="linenos">405</span></a>
</span><span id="GraphGenerator-406"><a href="#GraphGenerator-406"><span class="linenos">406</span></a>        <span class="c1">## compute distances</span>
</span><span id="GraphGenerator-407"><a href="#GraphGenerator-407"><span class="linenos">407</span></a>        <span class="n">cutoff_skin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span> <span class="o">+</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nblist_skin&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
</span><span id="GraphGenerator-408"><a href="#GraphGenerator-408"><span class="linenos">408</span></a>        <span class="n">d12</span> <span class="o">=</span> <span class="p">(</span><span class="n">vec</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="GraphGenerator-409"><a href="#GraphGenerator-409"><span class="linenos">409</span></a>        <span class="k">if</span> <span class="n">natoms</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="GraphGenerator-410"><a href="#GraphGenerator-410"><span class="linenos">410</span></a>            <span class="n">d12</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_p12</span><span class="p">,</span> <span class="n">d12</span><span class="p">,</span> <span class="n">cutoff_skin</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="GraphGenerator-411"><a href="#GraphGenerator-411"><span class="linenos">411</span></a>
</span><span id="GraphGenerator-412"><a href="#GraphGenerator-412"><span class="linenos">412</span></a>        <span class="c1">## filter pairs</span>
</span><span id="GraphGenerator-413"><a href="#GraphGenerator-413"><span class="linenos">413</span></a>        <span class="n">max_pairs</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;npairs&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="GraphGenerator-414"><a href="#GraphGenerator-414"><span class="linenos">414</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">d12</span> <span class="o">&lt;</span> <span class="n">cutoff_skin</span><span class="o">**</span><span class="mi">2</span>
</span><span id="GraphGenerator-415"><a href="#GraphGenerator-415"><span class="linenos">415</span></a>        <span class="p">(</span><span class="n">edge_src</span><span class="p">,</span> <span class="n">edge_dst</span><span class="p">,</span> <span class="n">d12</span><span class="p">),</span> <span class="n">scatter_idx</span><span class="p">,</span> <span class="n">npairs</span> <span class="o">=</span> <span class="n">mask_filter_1d</span><span class="p">(</span>
</span><span id="GraphGenerator-416"><a href="#GraphGenerator-416"><span class="linenos">416</span></a>            <span class="n">mask</span><span class="p">,</span>
</span><span id="GraphGenerator-417"><a href="#GraphGenerator-417"><span class="linenos">417</span></a>            <span class="n">max_pairs</span><span class="p">,</span>
</span><span id="GraphGenerator-418"><a href="#GraphGenerator-418"><span class="linenos">418</span></a>            <span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span id="GraphGenerator-419"><a href="#GraphGenerator-419"><span class="linenos">419</span></a>            <span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">p2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span id="GraphGenerator-420"><a href="#GraphGenerator-420"><span class="linenos">420</span></a>            <span class="p">(</span><span class="n">d12</span><span class="p">,</span> <span class="n">cutoff_skin</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>
</span><span id="GraphGenerator-421"><a href="#GraphGenerator-421"><span class="linenos">421</span></a>        <span class="p">)</span>
</span><span id="GraphGenerator-422"><a href="#GraphGenerator-422"><span class="linenos">422</span></a>        <span class="k">if</span> <span class="s2">&quot;cells&quot;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
</span><span id="GraphGenerator-423"><a href="#GraphGenerator-423"><span class="linenos">423</span></a>            <span class="n">pbc_shifts</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="GraphGenerator-424"><a href="#GraphGenerator-424"><span class="linenos">424</span></a>                <span class="n">jnp</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">max_pairs</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">pbc_shifts</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="GraphGenerator-425"><a href="#GraphGenerator-425"><span class="linenos">425</span></a>                <span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">scatter_idx</span><span class="p">]</span>
</span><span id="GraphGenerator-426"><a href="#GraphGenerator-426"><span class="linenos">426</span></a>                <span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">pbc_shifts</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;drop&quot;</span><span class="p">)</span>
</span><span id="GraphGenerator-427"><a href="#GraphGenerator-427"><span class="linenos">427</span></a>            <span class="p">)</span>
</span><span id="GraphGenerator-428"><a href="#GraphGenerator-428"><span class="linenos">428</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">minimage</span><span class="p">:</span>
</span><span id="GraphGenerator-429"><a href="#GraphGenerator-429"><span class="linenos">429</span></a>                <span class="n">pbc_shifts</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="GraphGenerator-430"><a href="#GraphGenerator-430"><span class="linenos">430</span></a>                    <span class="n">pbc_shifts</span>
</span><span id="GraphGenerator-431"><a href="#GraphGenerator-431"><span class="linenos">431</span></a>                    <span class="o">+</span> <span class="n">at_shifts</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">edge_dst</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fill_value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
</span><span id="GraphGenerator-432"><a href="#GraphGenerator-432"><span class="linenos">432</span></a>                    <span class="o">-</span> <span class="n">at_shifts</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">edge_src</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fill_value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
</span><span id="GraphGenerator-433"><a href="#GraphGenerator-433"><span class="linenos">433</span></a>                <span class="p">)</span>
</span><span id="GraphGenerator-434"><a href="#GraphGenerator-434"><span class="linenos">434</span></a>
</span><span id="GraphGenerator-435"><a href="#GraphGenerator-435"><span class="linenos">435</span></a>        <span class="c1">## check for overflow</span>
</span><span id="GraphGenerator-436"><a href="#GraphGenerator-436"><span class="linenos">436</span></a>        <span class="k">if</span> <span class="n">natoms</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="GraphGenerator-437"><a href="#GraphGenerator-437"><span class="linenos">437</span></a>            <span class="n">true_max_nat</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="GraphGenerator-438"><a href="#GraphGenerator-438"><span class="linenos">438</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="GraphGenerator-439"><a href="#GraphGenerator-439"><span class="linenos">439</span></a>            <span class="n">true_max_nat</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">natoms</span><span class="p">)</span>
</span><span id="GraphGenerator-440"><a href="#GraphGenerator-440"><span class="linenos">440</span></a>        <span class="n">overflow_count</span> <span class="o">=</span> <span class="n">npairs</span> <span class="o">&gt;</span> <span class="n">max_pairs</span>
</span><span id="GraphGenerator-441"><a href="#GraphGenerator-441"><span class="linenos">441</span></a>        <span class="n">overflow_at</span> <span class="o">=</span> <span class="n">true_max_nat</span> <span class="o">&gt;</span> <span class="n">max_nat</span>
</span><span id="GraphGenerator-442"><a href="#GraphGenerator-442"><span class="linenos">442</span></a>        <span class="n">overflow</span> <span class="o">=</span> <span class="n">overflow_count</span> <span class="o">|</span> <span class="n">overflow_at</span>
</span><span id="GraphGenerator-443"><a href="#GraphGenerator-443"><span class="linenos">443</span></a>
</span><span id="GraphGenerator-444"><a href="#GraphGenerator-444"><span class="linenos">444</span></a>        <span class="k">if</span> <span class="s2">&quot;nblist_skin&quot;</span> <span class="ow">in</span> <span class="n">state</span><span class="p">:</span>
</span><span id="GraphGenerator-445"><a href="#GraphGenerator-445"><span class="linenos">445</span></a>            <span class="c1"># edge_mask_skin = edge_mask</span>
</span><span id="GraphGenerator-446"><a href="#GraphGenerator-446"><span class="linenos">446</span></a>            <span class="n">edge_src_skin</span> <span class="o">=</span> <span class="n">edge_src</span>
</span><span id="GraphGenerator-447"><a href="#GraphGenerator-447"><span class="linenos">447</span></a>            <span class="n">edge_dst_skin</span> <span class="o">=</span> <span class="n">edge_dst</span>
</span><span id="GraphGenerator-448"><a href="#GraphGenerator-448"><span class="linenos">448</span></a>            <span class="k">if</span> <span class="s2">&quot;cells&quot;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
</span><span id="GraphGenerator-449"><a href="#GraphGenerator-449"><span class="linenos">449</span></a>                <span class="n">pbc_shifts_skin</span> <span class="o">=</span> <span class="n">pbc_shifts</span>
</span><span id="GraphGenerator-450"><a href="#GraphGenerator-450"><span class="linenos">450</span></a>            <span class="n">max_pairs_skin</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;npairs_skin&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="GraphGenerator-451"><a href="#GraphGenerator-451"><span class="linenos">451</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="n">d12</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="o">**</span><span class="mi">2</span>
</span><span id="GraphGenerator-452"><a href="#GraphGenerator-452"><span class="linenos">452</span></a>            <span class="p">(</span><span class="n">edge_src</span><span class="p">,</span> <span class="n">edge_dst</span><span class="p">,</span> <span class="n">d12</span><span class="p">),</span> <span class="n">scatter_idx</span><span class="p">,</span> <span class="n">npairs_skin</span> <span class="o">=</span> <span class="n">mask_filter_1d</span><span class="p">(</span>
</span><span id="GraphGenerator-453"><a href="#GraphGenerator-453"><span class="linenos">453</span></a>                <span class="n">mask</span><span class="p">,</span>
</span><span id="GraphGenerator-454"><a href="#GraphGenerator-454"><span class="linenos">454</span></a>                <span class="n">max_pairs_skin</span><span class="p">,</span>
</span><span id="GraphGenerator-455"><a href="#GraphGenerator-455"><span class="linenos">455</span></a>                <span class="p">(</span><span class="n">edge_src</span><span class="p">,</span> <span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span id="GraphGenerator-456"><a href="#GraphGenerator-456"><span class="linenos">456</span></a>                <span class="p">(</span><span class="n">edge_dst</span><span class="p">,</span> <span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span id="GraphGenerator-457"><a href="#GraphGenerator-457"><span class="linenos">457</span></a>                <span class="p">(</span><span class="n">d12</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>
</span><span id="GraphGenerator-458"><a href="#GraphGenerator-458"><span class="linenos">458</span></a>            <span class="p">)</span>
</span><span id="GraphGenerator-459"><a href="#GraphGenerator-459"><span class="linenos">459</span></a>            <span class="k">if</span> <span class="s2">&quot;cells&quot;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
</span><span id="GraphGenerator-460"><a href="#GraphGenerator-460"><span class="linenos">460</span></a>                <span class="n">pbc_shifts</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="GraphGenerator-461"><a href="#GraphGenerator-461"><span class="linenos">461</span></a>                    <span class="n">jnp</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">max_pairs_skin</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">pbc_shifts</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="GraphGenerator-462"><a href="#GraphGenerator-462"><span class="linenos">462</span></a>                    <span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">scatter_idx</span><span class="p">]</span>
</span><span id="GraphGenerator-463"><a href="#GraphGenerator-463"><span class="linenos">463</span></a>                    <span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">pbc_shifts</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;drop&quot;</span><span class="p">)</span>
</span><span id="GraphGenerator-464"><a href="#GraphGenerator-464"><span class="linenos">464</span></a>                <span class="p">)</span>
</span><span id="GraphGenerator-465"><a href="#GraphGenerator-465"><span class="linenos">465</span></a>            <span class="n">overflow</span> <span class="o">=</span> <span class="n">overflow</span> <span class="o">|</span> <span class="p">(</span><span class="n">npairs_skin</span> <span class="o">&gt;</span> <span class="n">max_pairs_skin</span><span class="p">)</span>
</span><span id="GraphGenerator-466"><a href="#GraphGenerator-466"><span class="linenos">466</span></a>
</span><span id="GraphGenerator-467"><a href="#GraphGenerator-467"><span class="linenos">467</span></a>        <span class="c1">## symmetrize</span>
</span><span id="GraphGenerator-468"><a href="#GraphGenerator-468"><span class="linenos">468</span></a>        <span class="n">edge_src</span><span class="p">,</span> <span class="n">edge_dst</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">edge_src</span><span class="p">,</span> <span class="n">edge_dst</span><span class="p">)),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
</span><span id="GraphGenerator-469"><a href="#GraphGenerator-469"><span class="linenos">469</span></a>            <span class="p">(</span><span class="n">edge_dst</span><span class="p">,</span> <span class="n">edge_src</span><span class="p">)</span>
</span><span id="GraphGenerator-470"><a href="#GraphGenerator-470"><span class="linenos">470</span></a>        <span class="p">)</span>
</span><span id="GraphGenerator-471"><a href="#GraphGenerator-471"><span class="linenos">471</span></a>        <span class="n">d12</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">d12</span><span class="p">,</span> <span class="n">d12</span><span class="p">))</span>
</span><span id="GraphGenerator-472"><a href="#GraphGenerator-472"><span class="linenos">472</span></a>        <span class="k">if</span> <span class="s2">&quot;cells&quot;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
</span><span id="GraphGenerator-473"><a href="#GraphGenerator-473"><span class="linenos">473</span></a>            <span class="n">pbc_shifts</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">pbc_shifts</span><span class="p">,</span> <span class="o">-</span><span class="n">pbc_shifts</span><span class="p">))</span>
</span><span id="GraphGenerator-474"><a href="#GraphGenerator-474"><span class="linenos">474</span></a>
</span><span id="GraphGenerator-475"><a href="#GraphGenerator-475"><span class="linenos">475</span></a>        <span class="n">graph</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span> <span class="ow">in</span> <span class="n">inputs</span> <span class="k">else</span> <span class="p">{}</span>
</span><span id="GraphGenerator-476"><a href="#GraphGenerator-476"><span class="linenos">476</span></a>        <span class="n">graph_out</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="GraphGenerator-477"><a href="#GraphGenerator-477"><span class="linenos">477</span></a>            <span class="o">**</span><span class="n">graph</span><span class="p">,</span>
</span><span id="GraphGenerator-478"><a href="#GraphGenerator-478"><span class="linenos">478</span></a>            <span class="s2">&quot;edge_src&quot;</span><span class="p">:</span> <span class="n">edge_src</span><span class="p">,</span>
</span><span id="GraphGenerator-479"><a href="#GraphGenerator-479"><span class="linenos">479</span></a>            <span class="s2">&quot;edge_dst&quot;</span><span class="p">:</span> <span class="n">edge_dst</span><span class="p">,</span>
</span><span id="GraphGenerator-480"><a href="#GraphGenerator-480"><span class="linenos">480</span></a>            <span class="s2">&quot;d12&quot;</span><span class="p">:</span> <span class="n">d12</span><span class="p">,</span>
</span><span id="GraphGenerator-481"><a href="#GraphGenerator-481"><span class="linenos">481</span></a>            <span class="s2">&quot;overflow&quot;</span><span class="p">:</span> <span class="n">overflow</span><span class="p">,</span>
</span><span id="GraphGenerator-482"><a href="#GraphGenerator-482"><span class="linenos">482</span></a>            <span class="s2">&quot;pbc_shifts&quot;</span><span class="p">:</span> <span class="n">pbc_shifts</span><span class="p">,</span>
</span><span id="GraphGenerator-483"><a href="#GraphGenerator-483"><span class="linenos">483</span></a>        <span class="p">}</span>
</span><span id="GraphGenerator-484"><a href="#GraphGenerator-484"><span class="linenos">484</span></a>        <span class="k">if</span> <span class="s2">&quot;nblist_skin&quot;</span> <span class="ow">in</span> <span class="n">state</span><span class="p">:</span>
</span><span id="GraphGenerator-485"><a href="#GraphGenerator-485"><span class="linenos">485</span></a>            <span class="n">graph_out</span><span class="p">[</span><span class="s2">&quot;edge_src_skin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">edge_src_skin</span>
</span><span id="GraphGenerator-486"><a href="#GraphGenerator-486"><span class="linenos">486</span></a>            <span class="n">graph_out</span><span class="p">[</span><span class="s2">&quot;edge_dst_skin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">edge_dst_skin</span>
</span><span id="GraphGenerator-487"><a href="#GraphGenerator-487"><span class="linenos">487</span></a>            <span class="k">if</span> <span class="s2">&quot;cells&quot;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
</span><span id="GraphGenerator-488"><a href="#GraphGenerator-488"><span class="linenos">488</span></a>                <span class="n">graph_out</span><span class="p">[</span><span class="s2">&quot;pbc_shifts_skin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pbc_shifts_skin</span>
</span><span id="GraphGenerator-489"><a href="#GraphGenerator-489"><span class="linenos">489</span></a>
</span><span id="GraphGenerator-490"><a href="#GraphGenerator-490"><span class="linenos">490</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_space</span> <span class="ow">and</span> <span class="s2">&quot;cells&quot;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
</span><span id="GraphGenerator-491"><a href="#GraphGenerator-491"><span class="linenos">491</span></a>            <span class="k">if</span> <span class="s2">&quot;k_points&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">graph</span><span class="p">:</span>
</span><span id="GraphGenerator-492"><a href="#GraphGenerator-492"><span class="linenos">492</span></a>                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
</span><span id="GraphGenerator-493"><a href="#GraphGenerator-493"><span class="linenos">493</span></a>                    <span class="s2">&quot;k_space generation not implemented on accelerator. Call the numpy routine (self.__call__) first.&quot;</span>
</span><span id="GraphGenerator-494"><a href="#GraphGenerator-494"><span class="linenos">494</span></a>                <span class="p">)</span>
</span><span id="GraphGenerator-495"><a href="#GraphGenerator-495"><span class="linenos">495</span></a>        <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">:</span> <span class="n">graph_out</span><span class="p">}</span>
</span><span id="GraphGenerator-496"><a href="#GraphGenerator-496"><span class="linenos">496</span></a>
</span><span id="GraphGenerator-497"><a href="#GraphGenerator-497"><span class="linenos">497</span></a>    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
</span><span id="GraphGenerator-498"><a href="#GraphGenerator-498"><span class="linenos">498</span></a>    <span class="k">def</span> <span class="nf">update_skin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
</span><span id="GraphGenerator-499"><a href="#GraphGenerator-499"><span class="linenos">499</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;update the nblist without recomputing the full nblist&quot;&quot;&quot;</span>
</span><span id="GraphGenerator-500"><a href="#GraphGenerator-500"><span class="linenos">500</span></a>        <span class="n">graph</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">]</span>
</span><span id="GraphGenerator-501"><a href="#GraphGenerator-501"><span class="linenos">501</span></a>
</span><span id="GraphGenerator-502"><a href="#GraphGenerator-502"><span class="linenos">502</span></a>        <span class="n">edge_src_skin</span> <span class="o">=</span> <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;edge_src_skin&quot;</span><span class="p">]</span>
</span><span id="GraphGenerator-503"><a href="#GraphGenerator-503"><span class="linenos">503</span></a>        <span class="n">edge_dst_skin</span> <span class="o">=</span> <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;edge_dst_skin&quot;</span><span class="p">]</span>
</span><span id="GraphGenerator-504"><a href="#GraphGenerator-504"><span class="linenos">504</span></a>        <span class="n">coords</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;coordinates&quot;</span><span class="p">]</span>
</span><span id="GraphGenerator-505"><a href="#GraphGenerator-505"><span class="linenos">505</span></a>        <span class="n">vec</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">edge_dst_skin</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span id="GraphGenerator-506"><a href="#GraphGenerator-506"><span class="linenos">506</span></a>            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span>
</span><span id="GraphGenerator-507"><a href="#GraphGenerator-507"><span class="linenos">507</span></a>        <span class="p">)</span> <span class="o">-</span> <span class="n">coords</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">edge_src_skin</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
</span><span id="GraphGenerator-508"><a href="#GraphGenerator-508"><span class="linenos">508</span></a>
</span><span id="GraphGenerator-509"><a href="#GraphGenerator-509"><span class="linenos">509</span></a>        <span class="k">if</span> <span class="s2">&quot;cells&quot;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
</span><span id="GraphGenerator-510"><a href="#GraphGenerator-510"><span class="linenos">510</span></a>            <span class="n">pbc_shifts_skin</span> <span class="o">=</span> <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;pbc_shifts_skin&quot;</span><span class="p">]</span>
</span><span id="GraphGenerator-511"><a href="#GraphGenerator-511"><span class="linenos">511</span></a>            <span class="n">cells</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;cells&quot;</span><span class="p">]</span>
</span><span id="GraphGenerator-512"><a href="#GraphGenerator-512"><span class="linenos">512</span></a>            <span class="k">if</span> <span class="n">cells</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="GraphGenerator-513"><a href="#GraphGenerator-513"><span class="linenos">513</span></a>                <span class="n">vec</span> <span class="o">=</span> <span class="n">vec</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pbc_shifts_skin</span><span class="p">,</span> <span class="n">cells</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="GraphGenerator-514"><a href="#GraphGenerator-514"><span class="linenos">514</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="GraphGenerator-515"><a href="#GraphGenerator-515"><span class="linenos">515</span></a>                <span class="n">batch_index_vec</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;batch_index&quot;</span><span class="p">][</span><span class="n">edge_src_skin</span><span class="p">]</span>
</span><span id="GraphGenerator-516"><a href="#GraphGenerator-516"><span class="linenos">516</span></a>                <span class="n">vec</span> <span class="o">=</span> <span class="n">vec</span> <span class="o">+</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">)(</span><span class="n">pbc_shifts_skin</span><span class="p">,</span> <span class="n">cells</span><span class="p">[</span><span class="n">batch_index_vec</span><span class="p">])</span>
</span><span id="GraphGenerator-517"><a href="#GraphGenerator-517"><span class="linenos">517</span></a>
</span><span id="GraphGenerator-518"><a href="#GraphGenerator-518"><span class="linenos">518</span></a>        <span class="n">nat</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="GraphGenerator-519"><a href="#GraphGenerator-519"><span class="linenos">519</span></a>        <span class="n">d12</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">vec</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="GraphGenerator-520"><a href="#GraphGenerator-520"><span class="linenos">520</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">d12</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="o">**</span><span class="mi">2</span>
</span><span id="GraphGenerator-521"><a href="#GraphGenerator-521"><span class="linenos">521</span></a>        <span class="n">max_pairs</span> <span class="o">=</span> <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;edge_src&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="GraphGenerator-522"><a href="#GraphGenerator-522"><span class="linenos">522</span></a>        <span class="p">(</span><span class="n">edge_src</span><span class="p">,</span> <span class="n">edge_dst</span><span class="p">,</span> <span class="n">d12</span><span class="p">),</span> <span class="n">scatter_idx</span><span class="p">,</span> <span class="n">npairs</span> <span class="o">=</span> <span class="n">mask_filter_1d</span><span class="p">(</span>
</span><span id="GraphGenerator-523"><a href="#GraphGenerator-523"><span class="linenos">523</span></a>            <span class="n">mask</span><span class="p">,</span>
</span><span id="GraphGenerator-524"><a href="#GraphGenerator-524"><span class="linenos">524</span></a>            <span class="n">max_pairs</span><span class="p">,</span>
</span><span id="GraphGenerator-525"><a href="#GraphGenerator-525"><span class="linenos">525</span></a>            <span class="p">(</span><span class="n">edge_src_skin</span><span class="p">,</span> <span class="n">nat</span><span class="p">),</span>
</span><span id="GraphGenerator-526"><a href="#GraphGenerator-526"><span class="linenos">526</span></a>            <span class="p">(</span><span class="n">edge_dst_skin</span><span class="p">,</span> <span class="n">nat</span><span class="p">),</span>
</span><span id="GraphGenerator-527"><a href="#GraphGenerator-527"><span class="linenos">527</span></a>            <span class="p">(</span><span class="n">d12</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>
</span><span id="GraphGenerator-528"><a href="#GraphGenerator-528"><span class="linenos">528</span></a>        <span class="p">)</span>
</span><span id="GraphGenerator-529"><a href="#GraphGenerator-529"><span class="linenos">529</span></a>        <span class="k">if</span> <span class="s2">&quot;cells&quot;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
</span><span id="GraphGenerator-530"><a href="#GraphGenerator-530"><span class="linenos">530</span></a>            <span class="n">pbc_shifts</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="GraphGenerator-531"><a href="#GraphGenerator-531"><span class="linenos">531</span></a>                <span class="n">jnp</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">max_pairs</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">pbc_shifts_skin</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="GraphGenerator-532"><a href="#GraphGenerator-532"><span class="linenos">532</span></a>                <span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">scatter_idx</span><span class="p">]</span>
</span><span id="GraphGenerator-533"><a href="#GraphGenerator-533"><span class="linenos">533</span></a>                <span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">pbc_shifts_skin</span><span class="p">)</span>
</span><span id="GraphGenerator-534"><a href="#GraphGenerator-534"><span class="linenos">534</span></a>            <span class="p">)</span>
</span><span id="GraphGenerator-535"><a href="#GraphGenerator-535"><span class="linenos">535</span></a>
</span><span id="GraphGenerator-536"><a href="#GraphGenerator-536"><span class="linenos">536</span></a>        <span class="n">overflow</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;overflow&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">npairs</span> <span class="o">&gt;</span> <span class="n">max_pairs</span><span class="p">)</span>
</span><span id="GraphGenerator-537"><a href="#GraphGenerator-537"><span class="linenos">537</span></a>        <span class="n">graph_out</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="GraphGenerator-538"><a href="#GraphGenerator-538"><span class="linenos">538</span></a>            <span class="o">**</span><span class="n">graph</span><span class="p">,</span>
</span><span id="GraphGenerator-539"><a href="#GraphGenerator-539"><span class="linenos">539</span></a>            <span class="s2">&quot;edge_src&quot;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">edge_src</span><span class="p">,</span> <span class="n">edge_dst</span><span class="p">)),</span>
</span><span id="GraphGenerator-540"><a href="#GraphGenerator-540"><span class="linenos">540</span></a>            <span class="s2">&quot;edge_dst&quot;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">edge_dst</span><span class="p">,</span> <span class="n">edge_src</span><span class="p">)),</span>
</span><span id="GraphGenerator-541"><a href="#GraphGenerator-541"><span class="linenos">541</span></a>            <span class="s2">&quot;d12&quot;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">d12</span><span class="p">,</span> <span class="n">d12</span><span class="p">)),</span>
</span><span id="GraphGenerator-542"><a href="#GraphGenerator-542"><span class="linenos">542</span></a>            <span class="s2">&quot;overflow&quot;</span><span class="p">:</span> <span class="n">overflow</span><span class="p">,</span>
</span><span id="GraphGenerator-543"><a href="#GraphGenerator-543"><span class="linenos">543</span></a>        <span class="p">}</span>
</span><span id="GraphGenerator-544"><a href="#GraphGenerator-544"><span class="linenos">544</span></a>        <span class="k">if</span> <span class="s2">&quot;cells&quot;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
</span><span id="GraphGenerator-545"><a href="#GraphGenerator-545"><span class="linenos">545</span></a>            <span class="n">graph_out</span><span class="p">[</span><span class="s2">&quot;pbc_shifts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">pbc_shifts</span><span class="p">,</span> <span class="o">-</span><span class="n">pbc_shifts</span><span class="p">))</span>
</span><span id="GraphGenerator-546"><a href="#GraphGenerator-546"><span class="linenos">546</span></a>
</span><span id="GraphGenerator-547"><a href="#GraphGenerator-547"><span class="linenos">547</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_space</span> <span class="ow">and</span> <span class="s2">&quot;cells&quot;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
</span><span id="GraphGenerator-548"><a href="#GraphGenerator-548"><span class="linenos">548</span></a>            <span class="k">if</span> <span class="s2">&quot;k_points&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">graph</span><span class="p">:</span>
</span><span id="GraphGenerator-549"><a href="#GraphGenerator-549"><span class="linenos">549</span></a>                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
</span><span id="GraphGenerator-550"><a href="#GraphGenerator-550"><span class="linenos">550</span></a>                    <span class="s2">&quot;k_space generation not implemented on accelerator. Call the numpy routine (self.__call__) first.&quot;</span>
</span><span id="GraphGenerator-551"><a href="#GraphGenerator-551"><span class="linenos">551</span></a>                <span class="p">)</span>
</span><span id="GraphGenerator-552"><a href="#GraphGenerator-552"><span class="linenos">552</span></a>
</span><span id="GraphGenerator-553"><a href="#GraphGenerator-553"><span class="linenos">553</span></a>        <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">:</span> <span class="n">graph_out</span><span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>Generate a graph from a set of coordinates</p>

<p>For now, we generate all pairs of atoms and filter based on cutoff.
If a <code>nblist_skin</code> is present in the state, we generate a second graph with a larger cutoff that includes all pairs within the cutoff+skin. This graph is then reused by the <code><a href="#GraphGenerator.update_skin">update_skin</a></code> method to update the original graph without recomputing the full nblist.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>cutoff</strong> (float):
Cutoff distance for the graph.</li>
<li><strong>graph_key</strong> (str, default="graph"):
Key of the graph in the outputs.</li>
<li><strong>switch_params</strong> (dict, default={}):
Parameters for the switching function.</li>
<li><strong>k_space</strong> (bool, default=False):
Generate k-space information for the graph.</li>
<li><strong>kmax</strong> (int, default=30):
Maximum number of k-points to consider.</li>
<li><strong>kthr</strong> (float, default=1e-6):
Threshold for k-point filtering.</li>
<li><strong>mult_size</strong> (float, default=1.05):
Multiplicative factor for resizing the nblist.</li>
</ul>
</div>


                            <div id="GraphGenerator.__init__" class="classattr">
                                <div class="attr function">
            
        <span class="name">GraphGenerator</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">cutoff</span><span class="p">:</span> <span class="nb">float</span>,</span><span class="param">	<span class="n">graph_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;graph&#39;</span>,</span><span class="param">	<span class="n">switch_params</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">factory</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">kmax</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span>,</span><span class="param">	<span class="n">kthr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-06</span>,</span><span class="param">	<span class="n">k_space</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">mult_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.05</span></span>)</span>

        
    </div>
    <a class="headerlink" href="#GraphGenerator.__init__"></a>
    
    

                            </div>
                            <div id="GraphGenerator.cutoff" class="classattr">
                                <div class="attr variable">
            <span class="name">cutoff</span><span class="annotation">: float</span>

        
    </div>
    <a class="headerlink" href="#GraphGenerator.cutoff"></a>
    
    

                            </div>
                            <div id="GraphGenerator.graph_key" class="classattr">
                                <div class="attr variable">
            <span class="name">graph_key</span><span class="annotation">: str</span>        =
<span class="default_value">&#39;graph&#39;</span>

        
    </div>
    <a class="headerlink" href="#GraphGenerator.graph_key"></a>
    
    

                            </div>
                            <div id="GraphGenerator.switch_params" class="classattr">
                                <div class="attr variable">
            <span class="name">switch_params</span><span class="annotation">: dict</span>

        
    </div>
    <a class="headerlink" href="#GraphGenerator.switch_params"></a>
    
    

                            </div>
                            <div id="GraphGenerator.kmax" class="classattr">
                                <div class="attr variable">
            <span class="name">kmax</span><span class="annotation">: int</span>        =
<span class="default_value">30</span>

        
    </div>
    <a class="headerlink" href="#GraphGenerator.kmax"></a>
    
    

                            </div>
                            <div id="GraphGenerator.kthr" class="classattr">
                                <div class="attr variable">
            <span class="name">kthr</span><span class="annotation">: float</span>        =
<span class="default_value">1e-06</span>

        
    </div>
    <a class="headerlink" href="#GraphGenerator.kthr"></a>
    
    

                            </div>
                            <div id="GraphGenerator.k_space" class="classattr">
                                <div class="attr variable">
            <span class="name">k_space</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#GraphGenerator.k_space"></a>
    
    

                            </div>
                            <div id="GraphGenerator.mult_size" class="classattr">
                                <div class="attr variable">
            <span class="name">mult_size</span><span class="annotation">: float</span>        =
<span class="default_value">1.05</span>

        
    </div>
    <a class="headerlink" href="#GraphGenerator.mult_size"></a>
    
    

                            </div>
                            <div id="GraphGenerator.init" class="classattr">
                                        <input id="GraphGenerator.init-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">init</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="GraphGenerator.init-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GraphGenerator.init"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GraphGenerator.init-57"><a href="#GraphGenerator.init-57"><span class="linenos">57</span></a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="GraphGenerator.init-58"><a href="#GraphGenerator.init-58"><span class="linenos">58</span></a>        <span class="k">return</span> <span class="n">FrozenDict</span><span class="p">(</span>
</span><span id="GraphGenerator.init-59"><a href="#GraphGenerator.init-59"><span class="linenos">59</span></a>            <span class="p">{</span>
</span><span id="GraphGenerator.init-60"><a href="#GraphGenerator.init-60"><span class="linenos">60</span></a>                <span class="s2">&quot;max_nat&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="GraphGenerator.init-61"><a href="#GraphGenerator.init-61"><span class="linenos">61</span></a>                <span class="s2">&quot;npairs&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="GraphGenerator.init-62"><a href="#GraphGenerator.init-62"><span class="linenos">62</span></a>                <span class="s2">&quot;nblist_mult_size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mult_size</span><span class="p">,</span>
</span><span id="GraphGenerator.init-63"><a href="#GraphGenerator.init-63"><span class="linenos">63</span></a>            <span class="p">}</span>
</span><span id="GraphGenerator.init-64"><a href="#GraphGenerator.init-64"><span class="linenos">64</span></a>        <span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="GraphGenerator.get_processor" class="classattr">
                                        <input id="GraphGenerator.get_processor-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_processor</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">Tuple</span><span class="p">[</span><span class="n">flax</span><span class="o">.</span><span class="n">linen</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="GraphGenerator.get_processor-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GraphGenerator.get_processor"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GraphGenerator.get_processor-66"><a href="#GraphGenerator.get_processor-66"><span class="linenos">66</span></a>    <span class="k">def</span> <span class="nf">get_processor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]:</span>
</span><span id="GraphGenerator.get_processor-67"><a href="#GraphGenerator.get_processor-67"><span class="linenos">67</span></a>        <span class="k">return</span> <span class="n">GraphProcessor</span><span class="p">,</span> <span class="p">{</span>
</span><span id="GraphGenerator.get_processor-68"><a href="#GraphGenerator.get_processor-68"><span class="linenos">68</span></a>            <span class="s2">&quot;cutoff&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">,</span>
</span><span id="GraphGenerator.get_processor-69"><a href="#GraphGenerator.get_processor-69"><span class="linenos">69</span></a>            <span class="s2">&quot;graph_key&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">,</span>
</span><span id="GraphGenerator.get_processor-70"><a href="#GraphGenerator.get_processor-70"><span class="linenos">70</span></a>            <span class="s2">&quot;switch_params&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">switch_params</span><span class="p">,</span>
</span><span id="GraphGenerator.get_processor-71"><a href="#GraphGenerator.get_processor-71"><span class="linenos">71</span></a>            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="si">}</span><span class="s2">_Processor&quot;</span><span class="p">,</span>
</span><span id="GraphGenerator.get_processor-72"><a href="#GraphGenerator.get_processor-72"><span class="linenos">72</span></a>        <span class="p">}</span>
</span></pre></div>


    

                            </div>
                            <div id="GraphGenerator.get_graph_properties" class="classattr">
                                        <input id="GraphGenerator.get_graph_properties-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_graph_properties</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="GraphGenerator.get_graph_properties-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GraphGenerator.get_graph_properties"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GraphGenerator.get_graph_properties-74"><a href="#GraphGenerator.get_graph_properties-74"><span class="linenos">74</span></a>    <span class="k">def</span> <span class="nf">get_graph_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="GraphGenerator.get_graph_properties-75"><a href="#GraphGenerator.get_graph_properties-75"><span class="linenos">75</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="GraphGenerator.get_graph_properties-76"><a href="#GraphGenerator.get_graph_properties-76"><span class="linenos">76</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">:</span> <span class="p">{</span>
</span><span id="GraphGenerator.get_graph_properties-77"><a href="#GraphGenerator.get_graph_properties-77"><span class="linenos">77</span></a>                <span class="s2">&quot;cutoff&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">,</span>
</span><span id="GraphGenerator.get_graph_properties-78"><a href="#GraphGenerator.get_graph_properties-78"><span class="linenos">78</span></a>                <span class="s2">&quot;directed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="GraphGenerator.get_graph_properties-79"><a href="#GraphGenerator.get_graph_properties-79"><span class="linenos">79</span></a>            <span class="p">}</span>
</span><span id="GraphGenerator.get_graph_properties-80"><a href="#GraphGenerator.get_graph_properties-80"><span class="linenos">80</span></a>        <span class="p">}</span>
</span></pre></div>


    

                            </div>
                            <div id="GraphGenerator.check_reallocate" class="classattr">
                                        <input id="GraphGenerator.check_reallocate-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">check_reallocate</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">state</span>, </span><span class="param"><span class="n">inputs</span>, </span><span class="param"><span class="n">parent_overflow</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="GraphGenerator.check_reallocate-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GraphGenerator.check_reallocate"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GraphGenerator.check_reallocate-293"><a href="#GraphGenerator.check_reallocate-293"><span class="linenos">293</span></a>    <span class="k">def</span> <span class="nf">check_reallocate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">parent_overflow</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="GraphGenerator.check_reallocate-294"><a href="#GraphGenerator.check_reallocate-294"><span class="linenos">294</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;check for overflow and reallocate nblist if necessary&quot;&quot;&quot;</span>
</span><span id="GraphGenerator.check_reallocate-295"><a href="#GraphGenerator.check_reallocate-295"><span class="linenos">295</span></a>        <span class="n">overflow</span> <span class="o">=</span> <span class="n">parent_overflow</span> <span class="ow">or</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;overflow&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="GraphGenerator.check_reallocate-296"><a href="#GraphGenerator.check_reallocate-296"><span class="linenos">296</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">overflow</span><span class="p">:</span>
</span><span id="GraphGenerator.check_reallocate-297"><a href="#GraphGenerator.check_reallocate-297"><span class="linenos">297</span></a>            <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="p">{},</span> <span class="n">inputs</span><span class="p">,</span> <span class="kc">False</span>
</span><span id="GraphGenerator.check_reallocate-298"><a href="#GraphGenerator.check_reallocate-298"><span class="linenos">298</span></a>
</span><span id="GraphGenerator.check_reallocate-299"><a href="#GraphGenerator.check_reallocate-299"><span class="linenos">299</span></a>        <span class="n">add_margin</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;overflow&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="GraphGenerator.check_reallocate-300"><a href="#GraphGenerator.check_reallocate-300"><span class="linenos">300</span></a>        <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">state_up</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span>
</span><span id="GraphGenerator.check_reallocate-301"><a href="#GraphGenerator.check_reallocate-301"><span class="linenos">301</span></a>            <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">return_state_update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">add_margin</span><span class="o">=</span><span class="n">add_margin</span>
</span><span id="GraphGenerator.check_reallocate-302"><a href="#GraphGenerator.check_reallocate-302"><span class="linenos">302</span></a>        <span class="p">)</span>
</span><span id="GraphGenerator.check_reallocate-303"><a href="#GraphGenerator.check_reallocate-303"><span class="linenos">303</span></a>        <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="n">state_up</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="kc">True</span>
</span></pre></div>


            <div class="docstring"><p>check for overflow and reallocate nblist if necessary</p>
</div>


                            </div>
                            <div id="GraphGenerator.process" class="classattr">
                                        <input id="GraphGenerator.process-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@partial(jax.jit, static_argnums=(0, 1))</div>

        <span class="def">def</span>
        <span class="name">process</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">state</span>, </span><span class="param"><span class="n">inputs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="GraphGenerator.process-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GraphGenerator.process"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GraphGenerator.process-305"><a href="#GraphGenerator.process-305"><span class="linenos">305</span></a>    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="GraphGenerator.process-306"><a href="#GraphGenerator.process-306"><span class="linenos">306</span></a>    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
</span><span id="GraphGenerator.process-307"><a href="#GraphGenerator.process-307"><span class="linenos">307</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;build a nblist on accelerator with jax and precomputed shapes&quot;&quot;&quot;</span>
</span><span id="GraphGenerator.process-308"><a href="#GraphGenerator.process-308"><span class="linenos">308</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
</span><span id="GraphGenerator.process-309"><a href="#GraphGenerator.process-309"><span class="linenos">309</span></a>            <span class="n">graph</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">]</span>
</span><span id="GraphGenerator.process-310"><a href="#GraphGenerator.process-310"><span class="linenos">310</span></a>            <span class="k">if</span> <span class="s2">&quot;keep_graph&quot;</span> <span class="ow">in</span> <span class="n">graph</span><span class="p">:</span>
</span><span id="GraphGenerator.process-311"><a href="#GraphGenerator.process-311"><span class="linenos">311</span></a>                <span class="k">return</span> <span class="n">inputs</span>
</span><span id="GraphGenerator.process-312"><a href="#GraphGenerator.process-312"><span class="linenos">312</span></a>        <span class="n">coords</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;coordinates&quot;</span><span class="p">]</span>
</span><span id="GraphGenerator.process-313"><a href="#GraphGenerator.process-313"><span class="linenos">313</span></a>        <span class="n">natoms</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;natoms&quot;</span><span class="p">]</span>
</span><span id="GraphGenerator.process-314"><a href="#GraphGenerator.process-314"><span class="linenos">314</span></a>        <span class="n">batch_index</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;batch_index&quot;</span><span class="p">]</span>
</span><span id="GraphGenerator.process-315"><a href="#GraphGenerator.process-315"><span class="linenos">315</span></a>
</span><span id="GraphGenerator.process-316"><a href="#GraphGenerator.process-316"><span class="linenos">316</span></a>        <span class="n">max_nat</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_nat&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">natoms</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
</span><span id="GraphGenerator.process-317"><a href="#GraphGenerator.process-317"><span class="linenos">317</span></a>
</span><span id="GraphGenerator.process-318"><a href="#GraphGenerator.process-318"><span class="linenos">318</span></a>        <span class="c1">### compute indices of all pairs</span>
</span><span id="GraphGenerator.process-319"><a href="#GraphGenerator.process-319"><span class="linenos">319</span></a>        <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">triu_indices</span><span class="p">(</span><span class="n">max_nat</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="GraphGenerator.process-320"><a href="#GraphGenerator.process-320"><span class="linenos">320</span></a>        <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">p1</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">p2</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="GraphGenerator.process-321"><a href="#GraphGenerator.process-321"><span class="linenos">321</span></a>        <span class="n">pbc_shifts</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="GraphGenerator.process-322"><a href="#GraphGenerator.process-322"><span class="linenos">322</span></a>        <span class="k">if</span> <span class="n">natoms</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="GraphGenerator.process-323"><a href="#GraphGenerator.process-323"><span class="linenos">323</span></a>            <span class="c1">## batching =&gt; mask irrelevant pairs</span>
</span><span id="GraphGenerator.process-324"><a href="#GraphGenerator.process-324"><span class="linenos">324</span></a>            <span class="n">mask_p12</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="GraphGenerator.process-325"><a href="#GraphGenerator.process-325"><span class="linenos">325</span></a>                <span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&lt;</span> <span class="n">natoms</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">p2</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&lt;</span> <span class="n">natoms</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span>
</span><span id="GraphGenerator.process-326"><a href="#GraphGenerator.process-326"><span class="linenos">326</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="GraphGenerator.process-327"><a href="#GraphGenerator.process-327"><span class="linenos">327</span></a>            <span class="n">shift</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
</span><span id="GraphGenerator.process-328"><a href="#GraphGenerator.process-328"><span class="linenos">328</span></a>                <span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">natoms</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
</span><span id="GraphGenerator.process-329"><a href="#GraphGenerator.process-329"><span class="linenos">329</span></a>            <span class="p">)</span>
</span><span id="GraphGenerator.process-330"><a href="#GraphGenerator.process-330"><span class="linenos">330</span></a>            <span class="n">p1</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_p12</span><span class="p">,</span> <span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">shift</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="GraphGenerator.process-331"><a href="#GraphGenerator.process-331"><span class="linenos">331</span></a>            <span class="n">p2</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_p12</span><span class="p">,</span> <span class="p">(</span><span class="n">p2</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">shift</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="GraphGenerator.process-332"><a href="#GraphGenerator.process-332"><span class="linenos">332</span></a>
</span><span id="GraphGenerator.process-333"><a href="#GraphGenerator.process-333"><span class="linenos">333</span></a>        <span class="c1">## compute vectors</span>
</span><span id="GraphGenerator.process-334"><a href="#GraphGenerator.process-334"><span class="linenos">334</span></a>        <span class="k">if</span> <span class="s2">&quot;cells&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
</span><span id="GraphGenerator.process-335"><a href="#GraphGenerator.process-335"><span class="linenos">335</span></a>            <span class="n">vec</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">p2</span><span class="p">]</span> <span class="o">-</span> <span class="n">coords</span><span class="p">[</span><span class="n">p1</span><span class="p">]</span>
</span><span id="GraphGenerator.process-336"><a href="#GraphGenerator.process-336"><span class="linenos">336</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="GraphGenerator.process-337"><a href="#GraphGenerator.process-337"><span class="linenos">337</span></a>            <span class="n">cells</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;cells&quot;</span><span class="p">]</span>
</span><span id="GraphGenerator.process-338"><a href="#GraphGenerator.process-338"><span class="linenos">338</span></a>            <span class="n">reciprocal_cells</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;reciprocal_cells&quot;</span><span class="p">]</span>
</span><span id="GraphGenerator.process-339"><a href="#GraphGenerator.process-339"><span class="linenos">339</span></a>            <span class="n">minimage</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;minimum_image&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="GraphGenerator.process-340"><a href="#GraphGenerator.process-340"><span class="linenos">340</span></a>
</span><span id="GraphGenerator.process-341"><a href="#GraphGenerator.process-341"><span class="linenos">341</span></a>            <span class="k">def</span> <span class="nf">compute_pbc</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">reciprocal_cell</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;round&quot;</span><span class="p">):</span>
</span><span id="GraphGenerator.process-342"><a href="#GraphGenerator.process-342"><span class="linenos">342</span></a>                <span class="n">vecpbc</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">reciprocal_cell</span><span class="p">)</span>
</span><span id="GraphGenerator.process-343"><a href="#GraphGenerator.process-343"><span class="linenos">343</span></a>                <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;round&quot;</span><span class="p">:</span>
</span><span id="GraphGenerator.process-344"><a href="#GraphGenerator.process-344"><span class="linenos">344</span></a>                    <span class="n">pbc_shifts</span> <span class="o">=</span> <span class="o">-</span><span class="n">jnp</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">vecpbc</span><span class="p">)</span>
</span><span id="GraphGenerator.process-345"><a href="#GraphGenerator.process-345"><span class="linenos">345</span></a>                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;floor&quot;</span><span class="p">:</span>
</span><span id="GraphGenerator.process-346"><a href="#GraphGenerator.process-346"><span class="linenos">346</span></a>                    <span class="n">pbc_shifts</span> <span class="o">=</span> <span class="o">-</span><span class="n">jnp</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">vecpbc</span><span class="p">)</span>
</span><span id="GraphGenerator.process-347"><a href="#GraphGenerator.process-347"><span class="linenos">347</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="GraphGenerator.process-348"><a href="#GraphGenerator.process-348"><span class="linenos">348</span></a>                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown mode </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2"> for compute_pbc.&quot;</span><span class="p">)</span>
</span><span id="GraphGenerator.process-349"><a href="#GraphGenerator.process-349"><span class="linenos">349</span></a>                <span class="k">return</span> <span class="n">vec</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pbc_shifts</span><span class="p">,</span> <span class="n">cell</span><span class="p">),</span> <span class="n">pbc_shifts</span>
</span><span id="GraphGenerator.process-350"><a href="#GraphGenerator.process-350"><span class="linenos">350</span></a>
</span><span id="GraphGenerator.process-351"><a href="#GraphGenerator.process-351"><span class="linenos">351</span></a>            <span class="k">if</span> <span class="n">minimage</span><span class="p">:</span>
</span><span id="GraphGenerator.process-352"><a href="#GraphGenerator.process-352"><span class="linenos">352</span></a>                <span class="c1">## minimum image convention</span>
</span><span id="GraphGenerator.process-353"><a href="#GraphGenerator.process-353"><span class="linenos">353</span></a>                <span class="n">vec</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">p2</span><span class="p">]</span> <span class="o">-</span> <span class="n">coords</span><span class="p">[</span><span class="n">p1</span><span class="p">]</span>
</span><span id="GraphGenerator.process-354"><a href="#GraphGenerator.process-354"><span class="linenos">354</span></a>
</span><span id="GraphGenerator.process-355"><a href="#GraphGenerator.process-355"><span class="linenos">355</span></a>                <span class="k">if</span> <span class="n">cells</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="GraphGenerator.process-356"><a href="#GraphGenerator.process-356"><span class="linenos">356</span></a>                    <span class="n">vec</span><span class="p">,</span> <span class="n">pbc_shifts</span> <span class="o">=</span> <span class="n">compute_pbc</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">reciprocal_cells</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cells</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="GraphGenerator.process-357"><a href="#GraphGenerator.process-357"><span class="linenos">357</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="GraphGenerator.process-358"><a href="#GraphGenerator.process-358"><span class="linenos">358</span></a>                    <span class="n">batch_index_vec</span> <span class="o">=</span> <span class="n">batch_index</span><span class="p">[</span><span class="n">p1</span><span class="p">]</span>
</span><span id="GraphGenerator.process-359"><a href="#GraphGenerator.process-359"><span class="linenos">359</span></a>                    <span class="n">vec</span><span class="p">,</span> <span class="n">pbc_shifts</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="n">compute_pbc</span><span class="p">)(</span>
</span><span id="GraphGenerator.process-360"><a href="#GraphGenerator.process-360"><span class="linenos">360</span></a>                        <span class="n">vec</span><span class="p">,</span> <span class="n">reciprocal_cells</span><span class="p">[</span><span class="n">batch_index_vec</span><span class="p">],</span> <span class="n">cells</span><span class="p">[</span><span class="n">batch_index_vec</span><span class="p">]</span>
</span><span id="GraphGenerator.process-361"><a href="#GraphGenerator.process-361"><span class="linenos">361</span></a>                    <span class="p">)</span>
</span><span id="GraphGenerator.process-362"><a href="#GraphGenerator.process-362"><span class="linenos">362</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="GraphGenerator.process-363"><a href="#GraphGenerator.process-363"><span class="linenos">363</span></a>                <span class="c1">### general PBC only for single cell yet</span>
</span><span id="GraphGenerator.process-364"><a href="#GraphGenerator.process-364"><span class="linenos">364</span></a>                <span class="k">if</span> <span class="n">cells</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="GraphGenerator.process-365"><a href="#GraphGenerator.process-365"><span class="linenos">365</span></a>                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
</span><span id="GraphGenerator.process-366"><a href="#GraphGenerator.process-366"><span class="linenos">366</span></a>                        <span class="s2">&quot;General PBC not implemented for batches on accelerator.&quot;</span>
</span><span id="GraphGenerator.process-367"><a href="#GraphGenerator.process-367"><span class="linenos">367</span></a>                    <span class="p">)</span>
</span><span id="GraphGenerator.process-368"><a href="#GraphGenerator.process-368"><span class="linenos">368</span></a>                <span class="n">cell</span> <span class="o">=</span> <span class="n">cells</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="GraphGenerator.process-369"><a href="#GraphGenerator.process-369"><span class="linenos">369</span></a>                <span class="n">reciprocal_cell</span> <span class="o">=</span> <span class="n">reciprocal_cells</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="GraphGenerator.process-370"><a href="#GraphGenerator.process-370"><span class="linenos">370</span></a>
</span><span id="GraphGenerator.process-371"><a href="#GraphGenerator.process-371"><span class="linenos">371</span></a>                <span class="c1">## put all atoms in central box</span>
</span><span id="GraphGenerator.process-372"><a href="#GraphGenerator.process-372"><span class="linenos">372</span></a>                <span class="n">coords_pbc</span><span class="p">,</span> <span class="n">at_shifts</span> <span class="o">=</span> <span class="n">compute_pbc</span><span class="p">(</span>
</span><span id="GraphGenerator.process-373"><a href="#GraphGenerator.process-373"><span class="linenos">373</span></a>                    <span class="n">coords</span><span class="p">,</span> <span class="n">reciprocal_cell</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;floor&quot;</span>
</span><span id="GraphGenerator.process-374"><a href="#GraphGenerator.process-374"><span class="linenos">374</span></a>                <span class="p">)</span>
</span><span id="GraphGenerator.process-375"><a href="#GraphGenerator.process-375"><span class="linenos">375</span></a>                <span class="n">num_repeats</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;num_repeats_pbc&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="GraphGenerator.process-376"><a href="#GraphGenerator.process-376"><span class="linenos">376</span></a>                <span class="k">if</span> <span class="n">num_repeats</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="GraphGenerator.process-377"><a href="#GraphGenerator.process-377"><span class="linenos">377</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="GraphGenerator.process-378"><a href="#GraphGenerator.process-378"><span class="linenos">378</span></a>                        <span class="s2">&quot;num_repeats_pbc should be provided for general PBC on accelerator. Call the numpy routine (self.__call__) first.&quot;</span>
</span><span id="GraphGenerator.process-379"><a href="#GraphGenerator.process-379"><span class="linenos">379</span></a>                    <span class="p">)</span>
</span><span id="GraphGenerator.process-380"><a href="#GraphGenerator.process-380"><span class="linenos">380</span></a>                <span class="n">cell_shift_pbc</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
</span><span id="GraphGenerator.process-381"><a href="#GraphGenerator.process-381"><span class="linenos">381</span></a>                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
</span><span id="GraphGenerator.process-382"><a href="#GraphGenerator.process-382"><span class="linenos">382</span></a>                        <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">num_repeats</span><span class="p">]),</span>
</span><span id="GraphGenerator.process-383"><a href="#GraphGenerator.process-383"><span class="linenos">383</span></a>                        <span class="n">dtype</span><span class="o">=</span><span class="n">cell</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
</span><span id="GraphGenerator.process-384"><a href="#GraphGenerator.process-384"><span class="linenos">384</span></a>                    <span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="GraphGenerator.process-385"><a href="#GraphGenerator.process-385"><span class="linenos">385</span></a>                <span class="p">)</span>
</span><span id="GraphGenerator.process-386"><a href="#GraphGenerator.process-386"><span class="linenos">386</span></a>                <span class="n">vec</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="GraphGenerator.process-387"><a href="#GraphGenerator.process-387"><span class="linenos">387</span></a>                    <span class="n">coords_pbc</span><span class="p">[</span><span class="n">p2</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="GraphGenerator.process-388"><a href="#GraphGenerator.process-388"><span class="linenos">388</span></a>                    <span class="o">-</span> <span class="n">coords_pbc</span><span class="p">[</span><span class="n">p1</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="GraphGenerator.process-389"><a href="#GraphGenerator.process-389"><span class="linenos">389</span></a>                    <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cell_shift_pbc</span><span class="p">,</span> <span class="n">cell</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
</span><span id="GraphGenerator.process-390"><a href="#GraphGenerator.process-390"><span class="linenos">390</span></a>                <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="GraphGenerator.process-391"><a href="#GraphGenerator.process-391"><span class="linenos">391</span></a>                <span class="n">pbc_shifts</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span>
</span><span id="GraphGenerator.process-392"><a href="#GraphGenerator.process-392"><span class="linenos">392</span></a>                    <span class="n">cell_shift_pbc</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span>
</span><span id="GraphGenerator.process-393"><a href="#GraphGenerator.process-393"><span class="linenos">393</span></a>                    <span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cell_shift_pbc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">),</span>
</span><span id="GraphGenerator.process-394"><a href="#GraphGenerator.process-394"><span class="linenos">394</span></a>                <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="GraphGenerator.process-395"><a href="#GraphGenerator.process-395"><span class="linenos">395</span></a>                <span class="n">p1</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span>
</span><span id="GraphGenerator.process-396"><a href="#GraphGenerator.process-396"><span class="linenos">396</span></a>                    <span class="n">p1</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cell_shift_pbc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="GraphGenerator.process-397"><a href="#GraphGenerator.process-397"><span class="linenos">397</span></a>                <span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="GraphGenerator.process-398"><a href="#GraphGenerator.process-398"><span class="linenos">398</span></a>                <span class="n">p2</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span>
</span><span id="GraphGenerator.process-399"><a href="#GraphGenerator.process-399"><span class="linenos">399</span></a>                    <span class="n">p2</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="p">(</span><span class="n">p2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cell_shift_pbc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="GraphGenerator.process-400"><a href="#GraphGenerator.process-400"><span class="linenos">400</span></a>                <span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="GraphGenerator.process-401"><a href="#GraphGenerator.process-401"><span class="linenos">401</span></a>                <span class="k">if</span> <span class="n">natoms</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="GraphGenerator.process-402"><a href="#GraphGenerator.process-402"><span class="linenos">402</span></a>                    <span class="n">mask_p12</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span>
</span><span id="GraphGenerator.process-403"><a href="#GraphGenerator.process-403"><span class="linenos">403</span></a>                        <span class="n">mask_p12</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="p">(</span><span class="n">mask_p12</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cell_shift_pbc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="GraphGenerator.process-404"><a href="#GraphGenerator.process-404"><span class="linenos">404</span></a>                    <span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="GraphGenerator.process-405"><a href="#GraphGenerator.process-405"><span class="linenos">405</span></a>
</span><span id="GraphGenerator.process-406"><a href="#GraphGenerator.process-406"><span class="linenos">406</span></a>        <span class="c1">## compute distances</span>
</span><span id="GraphGenerator.process-407"><a href="#GraphGenerator.process-407"><span class="linenos">407</span></a>        <span class="n">cutoff_skin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span> <span class="o">+</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nblist_skin&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
</span><span id="GraphGenerator.process-408"><a href="#GraphGenerator.process-408"><span class="linenos">408</span></a>        <span class="n">d12</span> <span class="o">=</span> <span class="p">(</span><span class="n">vec</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="GraphGenerator.process-409"><a href="#GraphGenerator.process-409"><span class="linenos">409</span></a>        <span class="k">if</span> <span class="n">natoms</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="GraphGenerator.process-410"><a href="#GraphGenerator.process-410"><span class="linenos">410</span></a>            <span class="n">d12</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_p12</span><span class="p">,</span> <span class="n">d12</span><span class="p">,</span> <span class="n">cutoff_skin</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="GraphGenerator.process-411"><a href="#GraphGenerator.process-411"><span class="linenos">411</span></a>
</span><span id="GraphGenerator.process-412"><a href="#GraphGenerator.process-412"><span class="linenos">412</span></a>        <span class="c1">## filter pairs</span>
</span><span id="GraphGenerator.process-413"><a href="#GraphGenerator.process-413"><span class="linenos">413</span></a>        <span class="n">max_pairs</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;npairs&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="GraphGenerator.process-414"><a href="#GraphGenerator.process-414"><span class="linenos">414</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">d12</span> <span class="o">&lt;</span> <span class="n">cutoff_skin</span><span class="o">**</span><span class="mi">2</span>
</span><span id="GraphGenerator.process-415"><a href="#GraphGenerator.process-415"><span class="linenos">415</span></a>        <span class="p">(</span><span class="n">edge_src</span><span class="p">,</span> <span class="n">edge_dst</span><span class="p">,</span> <span class="n">d12</span><span class="p">),</span> <span class="n">scatter_idx</span><span class="p">,</span> <span class="n">npairs</span> <span class="o">=</span> <span class="n">mask_filter_1d</span><span class="p">(</span>
</span><span id="GraphGenerator.process-416"><a href="#GraphGenerator.process-416"><span class="linenos">416</span></a>            <span class="n">mask</span><span class="p">,</span>
</span><span id="GraphGenerator.process-417"><a href="#GraphGenerator.process-417"><span class="linenos">417</span></a>            <span class="n">max_pairs</span><span class="p">,</span>
</span><span id="GraphGenerator.process-418"><a href="#GraphGenerator.process-418"><span class="linenos">418</span></a>            <span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span id="GraphGenerator.process-419"><a href="#GraphGenerator.process-419"><span class="linenos">419</span></a>            <span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">p2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span id="GraphGenerator.process-420"><a href="#GraphGenerator.process-420"><span class="linenos">420</span></a>            <span class="p">(</span><span class="n">d12</span><span class="p">,</span> <span class="n">cutoff_skin</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>
</span><span id="GraphGenerator.process-421"><a href="#GraphGenerator.process-421"><span class="linenos">421</span></a>        <span class="p">)</span>
</span><span id="GraphGenerator.process-422"><a href="#GraphGenerator.process-422"><span class="linenos">422</span></a>        <span class="k">if</span> <span class="s2">&quot;cells&quot;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
</span><span id="GraphGenerator.process-423"><a href="#GraphGenerator.process-423"><span class="linenos">423</span></a>            <span class="n">pbc_shifts</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="GraphGenerator.process-424"><a href="#GraphGenerator.process-424"><span class="linenos">424</span></a>                <span class="n">jnp</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">max_pairs</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">pbc_shifts</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="GraphGenerator.process-425"><a href="#GraphGenerator.process-425"><span class="linenos">425</span></a>                <span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">scatter_idx</span><span class="p">]</span>
</span><span id="GraphGenerator.process-426"><a href="#GraphGenerator.process-426"><span class="linenos">426</span></a>                <span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">pbc_shifts</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;drop&quot;</span><span class="p">)</span>
</span><span id="GraphGenerator.process-427"><a href="#GraphGenerator.process-427"><span class="linenos">427</span></a>            <span class="p">)</span>
</span><span id="GraphGenerator.process-428"><a href="#GraphGenerator.process-428"><span class="linenos">428</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">minimage</span><span class="p">:</span>
</span><span id="GraphGenerator.process-429"><a href="#GraphGenerator.process-429"><span class="linenos">429</span></a>                <span class="n">pbc_shifts</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="GraphGenerator.process-430"><a href="#GraphGenerator.process-430"><span class="linenos">430</span></a>                    <span class="n">pbc_shifts</span>
</span><span id="GraphGenerator.process-431"><a href="#GraphGenerator.process-431"><span class="linenos">431</span></a>                    <span class="o">+</span> <span class="n">at_shifts</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">edge_dst</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fill_value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
</span><span id="GraphGenerator.process-432"><a href="#GraphGenerator.process-432"><span class="linenos">432</span></a>                    <span class="o">-</span> <span class="n">at_shifts</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">edge_src</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fill_value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
</span><span id="GraphGenerator.process-433"><a href="#GraphGenerator.process-433"><span class="linenos">433</span></a>                <span class="p">)</span>
</span><span id="GraphGenerator.process-434"><a href="#GraphGenerator.process-434"><span class="linenos">434</span></a>
</span><span id="GraphGenerator.process-435"><a href="#GraphGenerator.process-435"><span class="linenos">435</span></a>        <span class="c1">## check for overflow</span>
</span><span id="GraphGenerator.process-436"><a href="#GraphGenerator.process-436"><span class="linenos">436</span></a>        <span class="k">if</span> <span class="n">natoms</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="GraphGenerator.process-437"><a href="#GraphGenerator.process-437"><span class="linenos">437</span></a>            <span class="n">true_max_nat</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="GraphGenerator.process-438"><a href="#GraphGenerator.process-438"><span class="linenos">438</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="GraphGenerator.process-439"><a href="#GraphGenerator.process-439"><span class="linenos">439</span></a>            <span class="n">true_max_nat</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">natoms</span><span class="p">)</span>
</span><span id="GraphGenerator.process-440"><a href="#GraphGenerator.process-440"><span class="linenos">440</span></a>        <span class="n">overflow_count</span> <span class="o">=</span> <span class="n">npairs</span> <span class="o">&gt;</span> <span class="n">max_pairs</span>
</span><span id="GraphGenerator.process-441"><a href="#GraphGenerator.process-441"><span class="linenos">441</span></a>        <span class="n">overflow_at</span> <span class="o">=</span> <span class="n">true_max_nat</span> <span class="o">&gt;</span> <span class="n">max_nat</span>
</span><span id="GraphGenerator.process-442"><a href="#GraphGenerator.process-442"><span class="linenos">442</span></a>        <span class="n">overflow</span> <span class="o">=</span> <span class="n">overflow_count</span> <span class="o">|</span> <span class="n">overflow_at</span>
</span><span id="GraphGenerator.process-443"><a href="#GraphGenerator.process-443"><span class="linenos">443</span></a>
</span><span id="GraphGenerator.process-444"><a href="#GraphGenerator.process-444"><span class="linenos">444</span></a>        <span class="k">if</span> <span class="s2">&quot;nblist_skin&quot;</span> <span class="ow">in</span> <span class="n">state</span><span class="p">:</span>
</span><span id="GraphGenerator.process-445"><a href="#GraphGenerator.process-445"><span class="linenos">445</span></a>            <span class="c1"># edge_mask_skin = edge_mask</span>
</span><span id="GraphGenerator.process-446"><a href="#GraphGenerator.process-446"><span class="linenos">446</span></a>            <span class="n">edge_src_skin</span> <span class="o">=</span> <span class="n">edge_src</span>
</span><span id="GraphGenerator.process-447"><a href="#GraphGenerator.process-447"><span class="linenos">447</span></a>            <span class="n">edge_dst_skin</span> <span class="o">=</span> <span class="n">edge_dst</span>
</span><span id="GraphGenerator.process-448"><a href="#GraphGenerator.process-448"><span class="linenos">448</span></a>            <span class="k">if</span> <span class="s2">&quot;cells&quot;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
</span><span id="GraphGenerator.process-449"><a href="#GraphGenerator.process-449"><span class="linenos">449</span></a>                <span class="n">pbc_shifts_skin</span> <span class="o">=</span> <span class="n">pbc_shifts</span>
</span><span id="GraphGenerator.process-450"><a href="#GraphGenerator.process-450"><span class="linenos">450</span></a>            <span class="n">max_pairs_skin</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;npairs_skin&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="GraphGenerator.process-451"><a href="#GraphGenerator.process-451"><span class="linenos">451</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="n">d12</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="o">**</span><span class="mi">2</span>
</span><span id="GraphGenerator.process-452"><a href="#GraphGenerator.process-452"><span class="linenos">452</span></a>            <span class="p">(</span><span class="n">edge_src</span><span class="p">,</span> <span class="n">edge_dst</span><span class="p">,</span> <span class="n">d12</span><span class="p">),</span> <span class="n">scatter_idx</span><span class="p">,</span> <span class="n">npairs_skin</span> <span class="o">=</span> <span class="n">mask_filter_1d</span><span class="p">(</span>
</span><span id="GraphGenerator.process-453"><a href="#GraphGenerator.process-453"><span class="linenos">453</span></a>                <span class="n">mask</span><span class="p">,</span>
</span><span id="GraphGenerator.process-454"><a href="#GraphGenerator.process-454"><span class="linenos">454</span></a>                <span class="n">max_pairs_skin</span><span class="p">,</span>
</span><span id="GraphGenerator.process-455"><a href="#GraphGenerator.process-455"><span class="linenos">455</span></a>                <span class="p">(</span><span class="n">edge_src</span><span class="p">,</span> <span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span id="GraphGenerator.process-456"><a href="#GraphGenerator.process-456"><span class="linenos">456</span></a>                <span class="p">(</span><span class="n">edge_dst</span><span class="p">,</span> <span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span id="GraphGenerator.process-457"><a href="#GraphGenerator.process-457"><span class="linenos">457</span></a>                <span class="p">(</span><span class="n">d12</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>
</span><span id="GraphGenerator.process-458"><a href="#GraphGenerator.process-458"><span class="linenos">458</span></a>            <span class="p">)</span>
</span><span id="GraphGenerator.process-459"><a href="#GraphGenerator.process-459"><span class="linenos">459</span></a>            <span class="k">if</span> <span class="s2">&quot;cells&quot;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
</span><span id="GraphGenerator.process-460"><a href="#GraphGenerator.process-460"><span class="linenos">460</span></a>                <span class="n">pbc_shifts</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="GraphGenerator.process-461"><a href="#GraphGenerator.process-461"><span class="linenos">461</span></a>                    <span class="n">jnp</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">max_pairs_skin</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">pbc_shifts</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="GraphGenerator.process-462"><a href="#GraphGenerator.process-462"><span class="linenos">462</span></a>                    <span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">scatter_idx</span><span class="p">]</span>
</span><span id="GraphGenerator.process-463"><a href="#GraphGenerator.process-463"><span class="linenos">463</span></a>                    <span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">pbc_shifts</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;drop&quot;</span><span class="p">)</span>
</span><span id="GraphGenerator.process-464"><a href="#GraphGenerator.process-464"><span class="linenos">464</span></a>                <span class="p">)</span>
</span><span id="GraphGenerator.process-465"><a href="#GraphGenerator.process-465"><span class="linenos">465</span></a>            <span class="n">overflow</span> <span class="o">=</span> <span class="n">overflow</span> <span class="o">|</span> <span class="p">(</span><span class="n">npairs_skin</span> <span class="o">&gt;</span> <span class="n">max_pairs_skin</span><span class="p">)</span>
</span><span id="GraphGenerator.process-466"><a href="#GraphGenerator.process-466"><span class="linenos">466</span></a>
</span><span id="GraphGenerator.process-467"><a href="#GraphGenerator.process-467"><span class="linenos">467</span></a>        <span class="c1">## symmetrize</span>
</span><span id="GraphGenerator.process-468"><a href="#GraphGenerator.process-468"><span class="linenos">468</span></a>        <span class="n">edge_src</span><span class="p">,</span> <span class="n">edge_dst</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">edge_src</span><span class="p">,</span> <span class="n">edge_dst</span><span class="p">)),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
</span><span id="GraphGenerator.process-469"><a href="#GraphGenerator.process-469"><span class="linenos">469</span></a>            <span class="p">(</span><span class="n">edge_dst</span><span class="p">,</span> <span class="n">edge_src</span><span class="p">)</span>
</span><span id="GraphGenerator.process-470"><a href="#GraphGenerator.process-470"><span class="linenos">470</span></a>        <span class="p">)</span>
</span><span id="GraphGenerator.process-471"><a href="#GraphGenerator.process-471"><span class="linenos">471</span></a>        <span class="n">d12</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">d12</span><span class="p">,</span> <span class="n">d12</span><span class="p">))</span>
</span><span id="GraphGenerator.process-472"><a href="#GraphGenerator.process-472"><span class="linenos">472</span></a>        <span class="k">if</span> <span class="s2">&quot;cells&quot;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
</span><span id="GraphGenerator.process-473"><a href="#GraphGenerator.process-473"><span class="linenos">473</span></a>            <span class="n">pbc_shifts</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">pbc_shifts</span><span class="p">,</span> <span class="o">-</span><span class="n">pbc_shifts</span><span class="p">))</span>
</span><span id="GraphGenerator.process-474"><a href="#GraphGenerator.process-474"><span class="linenos">474</span></a>
</span><span id="GraphGenerator.process-475"><a href="#GraphGenerator.process-475"><span class="linenos">475</span></a>        <span class="n">graph</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span> <span class="ow">in</span> <span class="n">inputs</span> <span class="k">else</span> <span class="p">{}</span>
</span><span id="GraphGenerator.process-476"><a href="#GraphGenerator.process-476"><span class="linenos">476</span></a>        <span class="n">graph_out</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="GraphGenerator.process-477"><a href="#GraphGenerator.process-477"><span class="linenos">477</span></a>            <span class="o">**</span><span class="n">graph</span><span class="p">,</span>
</span><span id="GraphGenerator.process-478"><a href="#GraphGenerator.process-478"><span class="linenos">478</span></a>            <span class="s2">&quot;edge_src&quot;</span><span class="p">:</span> <span class="n">edge_src</span><span class="p">,</span>
</span><span id="GraphGenerator.process-479"><a href="#GraphGenerator.process-479"><span class="linenos">479</span></a>            <span class="s2">&quot;edge_dst&quot;</span><span class="p">:</span> <span class="n">edge_dst</span><span class="p">,</span>
</span><span id="GraphGenerator.process-480"><a href="#GraphGenerator.process-480"><span class="linenos">480</span></a>            <span class="s2">&quot;d12&quot;</span><span class="p">:</span> <span class="n">d12</span><span class="p">,</span>
</span><span id="GraphGenerator.process-481"><a href="#GraphGenerator.process-481"><span class="linenos">481</span></a>            <span class="s2">&quot;overflow&quot;</span><span class="p">:</span> <span class="n">overflow</span><span class="p">,</span>
</span><span id="GraphGenerator.process-482"><a href="#GraphGenerator.process-482"><span class="linenos">482</span></a>            <span class="s2">&quot;pbc_shifts&quot;</span><span class="p">:</span> <span class="n">pbc_shifts</span><span class="p">,</span>
</span><span id="GraphGenerator.process-483"><a href="#GraphGenerator.process-483"><span class="linenos">483</span></a>        <span class="p">}</span>
</span><span id="GraphGenerator.process-484"><a href="#GraphGenerator.process-484"><span class="linenos">484</span></a>        <span class="k">if</span> <span class="s2">&quot;nblist_skin&quot;</span> <span class="ow">in</span> <span class="n">state</span><span class="p">:</span>
</span><span id="GraphGenerator.process-485"><a href="#GraphGenerator.process-485"><span class="linenos">485</span></a>            <span class="n">graph_out</span><span class="p">[</span><span class="s2">&quot;edge_src_skin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">edge_src_skin</span>
</span><span id="GraphGenerator.process-486"><a href="#GraphGenerator.process-486"><span class="linenos">486</span></a>            <span class="n">graph_out</span><span class="p">[</span><span class="s2">&quot;edge_dst_skin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">edge_dst_skin</span>
</span><span id="GraphGenerator.process-487"><a href="#GraphGenerator.process-487"><span class="linenos">487</span></a>            <span class="k">if</span> <span class="s2">&quot;cells&quot;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
</span><span id="GraphGenerator.process-488"><a href="#GraphGenerator.process-488"><span class="linenos">488</span></a>                <span class="n">graph_out</span><span class="p">[</span><span class="s2">&quot;pbc_shifts_skin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pbc_shifts_skin</span>
</span><span id="GraphGenerator.process-489"><a href="#GraphGenerator.process-489"><span class="linenos">489</span></a>
</span><span id="GraphGenerator.process-490"><a href="#GraphGenerator.process-490"><span class="linenos">490</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_space</span> <span class="ow">and</span> <span class="s2">&quot;cells&quot;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
</span><span id="GraphGenerator.process-491"><a href="#GraphGenerator.process-491"><span class="linenos">491</span></a>            <span class="k">if</span> <span class="s2">&quot;k_points&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">graph</span><span class="p">:</span>
</span><span id="GraphGenerator.process-492"><a href="#GraphGenerator.process-492"><span class="linenos">492</span></a>                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
</span><span id="GraphGenerator.process-493"><a href="#GraphGenerator.process-493"><span class="linenos">493</span></a>                    <span class="s2">&quot;k_space generation not implemented on accelerator. Call the numpy routine (self.__call__) first.&quot;</span>
</span><span id="GraphGenerator.process-494"><a href="#GraphGenerator.process-494"><span class="linenos">494</span></a>                <span class="p">)</span>
</span><span id="GraphGenerator.process-495"><a href="#GraphGenerator.process-495"><span class="linenos">495</span></a>        <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">:</span> <span class="n">graph_out</span><span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>build a nblist on accelerator with jax and precomputed shapes</p>
</div>


                            </div>
                            <div id="GraphGenerator.update_skin" class="classattr">
                                        <input id="GraphGenerator.update_skin-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@partial(jax.jit, static_argnums=(0,))</div>

        <span class="def">def</span>
        <span class="name">update_skin</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">inputs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="GraphGenerator.update_skin-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GraphGenerator.update_skin"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GraphGenerator.update_skin-497"><a href="#GraphGenerator.update_skin-497"><span class="linenos">497</span></a>    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
</span><span id="GraphGenerator.update_skin-498"><a href="#GraphGenerator.update_skin-498"><span class="linenos">498</span></a>    <span class="k">def</span> <span class="nf">update_skin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
</span><span id="GraphGenerator.update_skin-499"><a href="#GraphGenerator.update_skin-499"><span class="linenos">499</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;update the nblist without recomputing the full nblist&quot;&quot;&quot;</span>
</span><span id="GraphGenerator.update_skin-500"><a href="#GraphGenerator.update_skin-500"><span class="linenos">500</span></a>        <span class="n">graph</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">]</span>
</span><span id="GraphGenerator.update_skin-501"><a href="#GraphGenerator.update_skin-501"><span class="linenos">501</span></a>
</span><span id="GraphGenerator.update_skin-502"><a href="#GraphGenerator.update_skin-502"><span class="linenos">502</span></a>        <span class="n">edge_src_skin</span> <span class="o">=</span> <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;edge_src_skin&quot;</span><span class="p">]</span>
</span><span id="GraphGenerator.update_skin-503"><a href="#GraphGenerator.update_skin-503"><span class="linenos">503</span></a>        <span class="n">edge_dst_skin</span> <span class="o">=</span> <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;edge_dst_skin&quot;</span><span class="p">]</span>
</span><span id="GraphGenerator.update_skin-504"><a href="#GraphGenerator.update_skin-504"><span class="linenos">504</span></a>        <span class="n">coords</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;coordinates&quot;</span><span class="p">]</span>
</span><span id="GraphGenerator.update_skin-505"><a href="#GraphGenerator.update_skin-505"><span class="linenos">505</span></a>        <span class="n">vec</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">edge_dst_skin</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span id="GraphGenerator.update_skin-506"><a href="#GraphGenerator.update_skin-506"><span class="linenos">506</span></a>            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span>
</span><span id="GraphGenerator.update_skin-507"><a href="#GraphGenerator.update_skin-507"><span class="linenos">507</span></a>        <span class="p">)</span> <span class="o">-</span> <span class="n">coords</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">edge_src_skin</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
</span><span id="GraphGenerator.update_skin-508"><a href="#GraphGenerator.update_skin-508"><span class="linenos">508</span></a>
</span><span id="GraphGenerator.update_skin-509"><a href="#GraphGenerator.update_skin-509"><span class="linenos">509</span></a>        <span class="k">if</span> <span class="s2">&quot;cells&quot;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
</span><span id="GraphGenerator.update_skin-510"><a href="#GraphGenerator.update_skin-510"><span class="linenos">510</span></a>            <span class="n">pbc_shifts_skin</span> <span class="o">=</span> <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;pbc_shifts_skin&quot;</span><span class="p">]</span>
</span><span id="GraphGenerator.update_skin-511"><a href="#GraphGenerator.update_skin-511"><span class="linenos">511</span></a>            <span class="n">cells</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;cells&quot;</span><span class="p">]</span>
</span><span id="GraphGenerator.update_skin-512"><a href="#GraphGenerator.update_skin-512"><span class="linenos">512</span></a>            <span class="k">if</span> <span class="n">cells</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="GraphGenerator.update_skin-513"><a href="#GraphGenerator.update_skin-513"><span class="linenos">513</span></a>                <span class="n">vec</span> <span class="o">=</span> <span class="n">vec</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pbc_shifts_skin</span><span class="p">,</span> <span class="n">cells</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="GraphGenerator.update_skin-514"><a href="#GraphGenerator.update_skin-514"><span class="linenos">514</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="GraphGenerator.update_skin-515"><a href="#GraphGenerator.update_skin-515"><span class="linenos">515</span></a>                <span class="n">batch_index_vec</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;batch_index&quot;</span><span class="p">][</span><span class="n">edge_src_skin</span><span class="p">]</span>
</span><span id="GraphGenerator.update_skin-516"><a href="#GraphGenerator.update_skin-516"><span class="linenos">516</span></a>                <span class="n">vec</span> <span class="o">=</span> <span class="n">vec</span> <span class="o">+</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">)(</span><span class="n">pbc_shifts_skin</span><span class="p">,</span> <span class="n">cells</span><span class="p">[</span><span class="n">batch_index_vec</span><span class="p">])</span>
</span><span id="GraphGenerator.update_skin-517"><a href="#GraphGenerator.update_skin-517"><span class="linenos">517</span></a>
</span><span id="GraphGenerator.update_skin-518"><a href="#GraphGenerator.update_skin-518"><span class="linenos">518</span></a>        <span class="n">nat</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="GraphGenerator.update_skin-519"><a href="#GraphGenerator.update_skin-519"><span class="linenos">519</span></a>        <span class="n">d12</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">vec</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="GraphGenerator.update_skin-520"><a href="#GraphGenerator.update_skin-520"><span class="linenos">520</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">d12</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="o">**</span><span class="mi">2</span>
</span><span id="GraphGenerator.update_skin-521"><a href="#GraphGenerator.update_skin-521"><span class="linenos">521</span></a>        <span class="n">max_pairs</span> <span class="o">=</span> <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;edge_src&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="GraphGenerator.update_skin-522"><a href="#GraphGenerator.update_skin-522"><span class="linenos">522</span></a>        <span class="p">(</span><span class="n">edge_src</span><span class="p">,</span> <span class="n">edge_dst</span><span class="p">,</span> <span class="n">d12</span><span class="p">),</span> <span class="n">scatter_idx</span><span class="p">,</span> <span class="n">npairs</span> <span class="o">=</span> <span class="n">mask_filter_1d</span><span class="p">(</span>
</span><span id="GraphGenerator.update_skin-523"><a href="#GraphGenerator.update_skin-523"><span class="linenos">523</span></a>            <span class="n">mask</span><span class="p">,</span>
</span><span id="GraphGenerator.update_skin-524"><a href="#GraphGenerator.update_skin-524"><span class="linenos">524</span></a>            <span class="n">max_pairs</span><span class="p">,</span>
</span><span id="GraphGenerator.update_skin-525"><a href="#GraphGenerator.update_skin-525"><span class="linenos">525</span></a>            <span class="p">(</span><span class="n">edge_src_skin</span><span class="p">,</span> <span class="n">nat</span><span class="p">),</span>
</span><span id="GraphGenerator.update_skin-526"><a href="#GraphGenerator.update_skin-526"><span class="linenos">526</span></a>            <span class="p">(</span><span class="n">edge_dst_skin</span><span class="p">,</span> <span class="n">nat</span><span class="p">),</span>
</span><span id="GraphGenerator.update_skin-527"><a href="#GraphGenerator.update_skin-527"><span class="linenos">527</span></a>            <span class="p">(</span><span class="n">d12</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>
</span><span id="GraphGenerator.update_skin-528"><a href="#GraphGenerator.update_skin-528"><span class="linenos">528</span></a>        <span class="p">)</span>
</span><span id="GraphGenerator.update_skin-529"><a href="#GraphGenerator.update_skin-529"><span class="linenos">529</span></a>        <span class="k">if</span> <span class="s2">&quot;cells&quot;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
</span><span id="GraphGenerator.update_skin-530"><a href="#GraphGenerator.update_skin-530"><span class="linenos">530</span></a>            <span class="n">pbc_shifts</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="GraphGenerator.update_skin-531"><a href="#GraphGenerator.update_skin-531"><span class="linenos">531</span></a>                <span class="n">jnp</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">max_pairs</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">pbc_shifts_skin</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="GraphGenerator.update_skin-532"><a href="#GraphGenerator.update_skin-532"><span class="linenos">532</span></a>                <span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">scatter_idx</span><span class="p">]</span>
</span><span id="GraphGenerator.update_skin-533"><a href="#GraphGenerator.update_skin-533"><span class="linenos">533</span></a>                <span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">pbc_shifts_skin</span><span class="p">)</span>
</span><span id="GraphGenerator.update_skin-534"><a href="#GraphGenerator.update_skin-534"><span class="linenos">534</span></a>            <span class="p">)</span>
</span><span id="GraphGenerator.update_skin-535"><a href="#GraphGenerator.update_skin-535"><span class="linenos">535</span></a>
</span><span id="GraphGenerator.update_skin-536"><a href="#GraphGenerator.update_skin-536"><span class="linenos">536</span></a>        <span class="n">overflow</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;overflow&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">npairs</span> <span class="o">&gt;</span> <span class="n">max_pairs</span><span class="p">)</span>
</span><span id="GraphGenerator.update_skin-537"><a href="#GraphGenerator.update_skin-537"><span class="linenos">537</span></a>        <span class="n">graph_out</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="GraphGenerator.update_skin-538"><a href="#GraphGenerator.update_skin-538"><span class="linenos">538</span></a>            <span class="o">**</span><span class="n">graph</span><span class="p">,</span>
</span><span id="GraphGenerator.update_skin-539"><a href="#GraphGenerator.update_skin-539"><span class="linenos">539</span></a>            <span class="s2">&quot;edge_src&quot;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">edge_src</span><span class="p">,</span> <span class="n">edge_dst</span><span class="p">)),</span>
</span><span id="GraphGenerator.update_skin-540"><a href="#GraphGenerator.update_skin-540"><span class="linenos">540</span></a>            <span class="s2">&quot;edge_dst&quot;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">edge_dst</span><span class="p">,</span> <span class="n">edge_src</span><span class="p">)),</span>
</span><span id="GraphGenerator.update_skin-541"><a href="#GraphGenerator.update_skin-541"><span class="linenos">541</span></a>            <span class="s2">&quot;d12&quot;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">d12</span><span class="p">,</span> <span class="n">d12</span><span class="p">)),</span>
</span><span id="GraphGenerator.update_skin-542"><a href="#GraphGenerator.update_skin-542"><span class="linenos">542</span></a>            <span class="s2">&quot;overflow&quot;</span><span class="p">:</span> <span class="n">overflow</span><span class="p">,</span>
</span><span id="GraphGenerator.update_skin-543"><a href="#GraphGenerator.update_skin-543"><span class="linenos">543</span></a>        <span class="p">}</span>
</span><span id="GraphGenerator.update_skin-544"><a href="#GraphGenerator.update_skin-544"><span class="linenos">544</span></a>        <span class="k">if</span> <span class="s2">&quot;cells&quot;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
</span><span id="GraphGenerator.update_skin-545"><a href="#GraphGenerator.update_skin-545"><span class="linenos">545</span></a>            <span class="n">graph_out</span><span class="p">[</span><span class="s2">&quot;pbc_shifts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">pbc_shifts</span><span class="p">,</span> <span class="o">-</span><span class="n">pbc_shifts</span><span class="p">))</span>
</span><span id="GraphGenerator.update_skin-546"><a href="#GraphGenerator.update_skin-546"><span class="linenos">546</span></a>
</span><span id="GraphGenerator.update_skin-547"><a href="#GraphGenerator.update_skin-547"><span class="linenos">547</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_space</span> <span class="ow">and</span> <span class="s2">&quot;cells&quot;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
</span><span id="GraphGenerator.update_skin-548"><a href="#GraphGenerator.update_skin-548"><span class="linenos">548</span></a>            <span class="k">if</span> <span class="s2">&quot;k_points&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">graph</span><span class="p">:</span>
</span><span id="GraphGenerator.update_skin-549"><a href="#GraphGenerator.update_skin-549"><span class="linenos">549</span></a>                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
</span><span id="GraphGenerator.update_skin-550"><a href="#GraphGenerator.update_skin-550"><span class="linenos">550</span></a>                    <span class="s2">&quot;k_space generation not implemented on accelerator. Call the numpy routine (self.__call__) first.&quot;</span>
</span><span id="GraphGenerator.update_skin-551"><a href="#GraphGenerator.update_skin-551"><span class="linenos">551</span></a>                <span class="p">)</span>
</span><span id="GraphGenerator.update_skin-552"><a href="#GraphGenerator.update_skin-552"><span class="linenos">552</span></a>
</span><span id="GraphGenerator.update_skin-553"><a href="#GraphGenerator.update_skin-553"><span class="linenos">553</span></a>        <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">:</span> <span class="n">graph_out</span><span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>update the nblist without recomputing the full nblist</p>
</div>


                            </div>
                </section>
                <section id="GraphProcessor">
                            <input id="GraphProcessor-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">GraphProcessor</span><wbr>(<span class="base">flax.linen.module.Module</span>):

                <label class="view-source-button" for="GraphProcessor-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GraphProcessor"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GraphProcessor-556"><a href="#GraphProcessor-556"><span class="linenos">556</span></a><span class="k">class</span> <span class="nc">GraphProcessor</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="GraphProcessor-557"><a href="#GraphProcessor-557"><span class="linenos">557</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Process a pre-generated graph</span>
</span><span id="GraphProcessor-558"><a href="#GraphProcessor-558"><span class="linenos">558</span></a>
</span><span id="GraphProcessor-559"><a href="#GraphProcessor-559"><span class="linenos">559</span></a><span class="sd">    The pre-generated graph should contain the following keys:</span>
</span><span id="GraphProcessor-560"><a href="#GraphProcessor-560"><span class="linenos">560</span></a><span class="sd">    - edge_src: source indices of the edges</span>
</span><span id="GraphProcessor-561"><a href="#GraphProcessor-561"><span class="linenos">561</span></a><span class="sd">    - edge_dst: destination indices of the edges</span>
</span><span id="GraphProcessor-562"><a href="#GraphProcessor-562"><span class="linenos">562</span></a><span class="sd">    - pbcs_shifts: pbc shifts for the edges (only if `cells` are present in the inputs)</span>
</span><span id="GraphProcessor-563"><a href="#GraphProcessor-563"><span class="linenos">563</span></a>
</span><span id="GraphProcessor-564"><a href="#GraphProcessor-564"><span class="linenos">564</span></a><span class="sd">    This module is automatically added to a FENNIX model when a GraphGenerator is used.</span>
</span><span id="GraphProcessor-565"><a href="#GraphProcessor-565"><span class="linenos">565</span></a>
</span><span id="GraphProcessor-566"><a href="#GraphProcessor-566"><span class="linenos">566</span></a><span class="sd">    Parameters</span>
</span><span id="GraphProcessor-567"><a href="#GraphProcessor-567"><span class="linenos">567</span></a><span class="sd">    ----------</span>
</span><span id="GraphProcessor-568"><a href="#GraphProcessor-568"><span class="linenos">568</span></a><span class="sd">    cutoff : float</span>
</span><span id="GraphProcessor-569"><a href="#GraphProcessor-569"><span class="linenos">569</span></a><span class="sd">        Cutoff distance for the graph.</span>
</span><span id="GraphProcessor-570"><a href="#GraphProcessor-570"><span class="linenos">570</span></a><span class="sd">    graph_key : str</span>
</span><span id="GraphProcessor-571"><a href="#GraphProcessor-571"><span class="linenos">571</span></a><span class="sd">        Key of the graph in the inputs.</span>
</span><span id="GraphProcessor-572"><a href="#GraphProcessor-572"><span class="linenos">572</span></a><span class="sd">    switch_params : dict, default={}</span>
</span><span id="GraphProcessor-573"><a href="#GraphProcessor-573"><span class="linenos">573</span></a><span class="sd">        Parameters for the switching function.</span>
</span><span id="GraphProcessor-574"><a href="#GraphProcessor-574"><span class="linenos">574</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="GraphProcessor-575"><a href="#GraphProcessor-575"><span class="linenos">575</span></a>
</span><span id="GraphProcessor-576"><a href="#GraphProcessor-576"><span class="linenos">576</span></a>    <span class="n">cutoff</span><span class="p">:</span> <span class="nb">float</span>
</span><span id="GraphProcessor-577"><a href="#GraphProcessor-577"><span class="linenos">577</span></a>    <span class="n">graph_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;graph&quot;</span>
</span><span id="GraphProcessor-578"><a href="#GraphProcessor-578"><span class="linenos">578</span></a>    <span class="n">switch_params</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
</span><span id="GraphProcessor-579"><a href="#GraphProcessor-579"><span class="linenos">579</span></a>
</span><span id="GraphProcessor-580"><a href="#GraphProcessor-580"><span class="linenos">580</span></a>    <span class="nd">@nn</span><span class="o">.</span><span class="n">compact</span>
</span><span id="GraphProcessor-581"><a href="#GraphProcessor-581"><span class="linenos">581</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]]):</span>
</span><span id="GraphProcessor-582"><a href="#GraphProcessor-582"><span class="linenos">582</span></a>        <span class="n">graph</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">]</span>
</span><span id="GraphProcessor-583"><a href="#GraphProcessor-583"><span class="linenos">583</span></a>        <span class="n">coords</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;coordinates&quot;</span><span class="p">]</span>
</span><span id="GraphProcessor-584"><a href="#GraphProcessor-584"><span class="linenos">584</span></a>        <span class="n">edge_src</span><span class="p">,</span> <span class="n">edge_dst</span> <span class="o">=</span> <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;edge_src&quot;</span><span class="p">],</span> <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;edge_dst&quot;</span><span class="p">]</span>
</span><span id="GraphProcessor-585"><a href="#GraphProcessor-585"><span class="linenos">585</span></a>        <span class="c1"># edge_mask = edge_src &lt; coords.shape[0]</span>
</span><span id="GraphProcessor-586"><a href="#GraphProcessor-586"><span class="linenos">586</span></a>        <span class="n">vec</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">edge_dst</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">)</span> <span class="o">-</span> <span class="n">coords</span><span class="o">.</span><span class="n">at</span><span class="p">[</span>
</span><span id="GraphProcessor-587"><a href="#GraphProcessor-587"><span class="linenos">587</span></a>            <span class="n">edge_src</span>
</span><span id="GraphProcessor-588"><a href="#GraphProcessor-588"><span class="linenos">588</span></a>        <span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
</span><span id="GraphProcessor-589"><a href="#GraphProcessor-589"><span class="linenos">589</span></a>        <span class="k">if</span> <span class="s2">&quot;cells&quot;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
</span><span id="GraphProcessor-590"><a href="#GraphProcessor-590"><span class="linenos">590</span></a>            <span class="n">cells</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;cells&quot;</span><span class="p">]</span>
</span><span id="GraphProcessor-591"><a href="#GraphProcessor-591"><span class="linenos">591</span></a>            <span class="k">if</span> <span class="n">cells</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="GraphProcessor-592"><a href="#GraphProcessor-592"><span class="linenos">592</span></a>                <span class="n">vec</span> <span class="o">=</span> <span class="n">vec</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">graph</span><span class="p">[</span><span class="s2">&quot;pbc_shifts&quot;</span><span class="p">],</span> <span class="n">cells</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="GraphProcessor-593"><a href="#GraphProcessor-593"><span class="linenos">593</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="GraphProcessor-594"><a href="#GraphProcessor-594"><span class="linenos">594</span></a>                <span class="n">batch_index_vec</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;batch_index&quot;</span><span class="p">][</span><span class="n">edge_src</span><span class="p">]</span>
</span><span id="GraphProcessor-595"><a href="#GraphProcessor-595"><span class="linenos">595</span></a>                <span class="n">vec</span> <span class="o">=</span> <span class="n">vec</span> <span class="o">+</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">)(</span><span class="n">graph</span><span class="p">[</span><span class="s2">&quot;pbc_shifts&quot;</span><span class="p">],</span> <span class="n">cells</span><span class="p">[</span><span class="n">batch_index_vec</span><span class="p">])</span>
</span><span id="GraphProcessor-596"><a href="#GraphProcessor-596"><span class="linenos">596</span></a>
</span><span id="GraphProcessor-597"><a href="#GraphProcessor-597"><span class="linenos">597</span></a>        <span class="n">distances</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="GraphProcessor-598"><a href="#GraphProcessor-598"><span class="linenos">598</span></a>        <span class="n">edge_mask</span> <span class="o">=</span> <span class="n">distances</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span>
</span><span id="GraphProcessor-599"><a href="#GraphProcessor-599"><span class="linenos">599</span></a>
</span><span id="GraphProcessor-600"><a href="#GraphProcessor-600"><span class="linenos">600</span></a>        <span class="n">switch</span> <span class="o">=</span> <span class="n">SwitchFunction</span><span class="p">(</span>
</span><span id="GraphProcessor-601"><a href="#GraphProcessor-601"><span class="linenos">601</span></a>            <span class="o">**</span><span class="p">{</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">switch_params</span><span class="p">,</span> <span class="s2">&quot;cutoff&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">,</span> <span class="s2">&quot;graph_key&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
</span><span id="GraphProcessor-602"><a href="#GraphProcessor-602"><span class="linenos">602</span></a>        <span class="p">)((</span><span class="n">distances</span><span class="p">,</span> <span class="n">edge_mask</span><span class="p">))</span>
</span><span id="GraphProcessor-603"><a href="#GraphProcessor-603"><span class="linenos">603</span></a>
</span><span id="GraphProcessor-604"><a href="#GraphProcessor-604"><span class="linenos">604</span></a>        <span class="n">graph_out</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="GraphProcessor-605"><a href="#GraphProcessor-605"><span class="linenos">605</span></a>            <span class="o">**</span><span class="n">graph</span><span class="p">,</span>
</span><span id="GraphProcessor-606"><a href="#GraphProcessor-606"><span class="linenos">606</span></a>            <span class="s2">&quot;vec&quot;</span><span class="p">:</span> <span class="n">vec</span><span class="p">,</span>
</span><span id="GraphProcessor-607"><a href="#GraphProcessor-607"><span class="linenos">607</span></a>            <span class="s2">&quot;distances&quot;</span><span class="p">:</span> <span class="n">distances</span><span class="p">,</span>
</span><span id="GraphProcessor-608"><a href="#GraphProcessor-608"><span class="linenos">608</span></a>            <span class="s2">&quot;switch&quot;</span><span class="p">:</span> <span class="n">switch</span><span class="p">,</span>
</span><span id="GraphProcessor-609"><a href="#GraphProcessor-609"><span class="linenos">609</span></a>            <span class="s2">&quot;edge_mask&quot;</span><span class="p">:</span> <span class="n">edge_mask</span><span class="p">,</span>
</span><span id="GraphProcessor-610"><a href="#GraphProcessor-610"><span class="linenos">610</span></a>        <span class="p">}</span>
</span><span id="GraphProcessor-611"><a href="#GraphProcessor-611"><span class="linenos">611</span></a>        <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">:</span> <span class="n">graph_out</span><span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>Process a pre-generated graph</p>

<p>The pre-generated graph should contain the following keys:</p>

<ul>
<li>edge_src: source indices of the edges</li>
<li>edge_dst: destination indices of the edges</li>
<li>pbcs_shifts: pbc shifts for the edges (only if <code>cells</code> are present in the inputs)</li>
</ul>

<p>This module is automatically added to a FENNIX model when a GraphGenerator is used.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>cutoff</strong> (float):
Cutoff distance for the graph.</li>
<li><strong>graph_key</strong> (str):
Key of the graph in the inputs.</li>
<li><strong>switch_params</strong> (dict, default={}):
Parameters for the switching function.</li>
</ul>
</div>


                            <div id="GraphProcessor.__init__" class="classattr">
                                <div class="attr function">
            
        <span class="name">GraphProcessor</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">cutoff</span><span class="p">:</span> <span class="nb">float</span>,</span><span class="param">	<span class="n">graph_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;graph&#39;</span>,</span><span class="param">	<span class="n">switch_params</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">factory</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">parent</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">flax</span><span class="o">.</span><span class="n">linen</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">Module</span><span class="p">],</span> <span class="n">flax</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">Scope</span><span class="p">,</span> <span class="n">Type</span><span class="p">[</span><span class="n">flax</span><span class="o">.</span><span class="n">linen</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">_Sentinel</span><span class="p">],</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">flax</span><span class="o">.</span><span class="n">linen</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">_Sentinel</span> <span class="nb">object</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

        
    </div>
    <a class="headerlink" href="#GraphProcessor.__init__"></a>
    
    

                            </div>
                            <div id="GraphProcessor.cutoff" class="classattr">
                                <div class="attr variable">
            <span class="name">cutoff</span><span class="annotation">: float</span>

        
    </div>
    <a class="headerlink" href="#GraphProcessor.cutoff"></a>
    
    

                            </div>
                            <div id="GraphProcessor.graph_key" class="classattr">
                                <div class="attr variable">
            <span class="name">graph_key</span><span class="annotation">: str</span>        =
<span class="default_value">&#39;graph&#39;</span>

        
    </div>
    <a class="headerlink" href="#GraphProcessor.graph_key"></a>
    
    

                            </div>
                            <div id="GraphProcessor.switch_params" class="classattr">
                                <div class="attr variable">
            <span class="name">switch_params</span><span class="annotation">: dict</span>

        
    </div>
    <a class="headerlink" href="#GraphProcessor.switch_params"></a>
    
    

                            </div>
                            <div id="GraphProcessor.parent" class="classattr">
                                <div class="attr variable">
            <span class="name">parent</span><span class="annotation">: Union[Type[flax.linen.module.Module], flax.core.scope.Scope, Type[flax.linen.module._Sentinel], NoneType]</span>

        
    </div>
    <a class="headerlink" href="#GraphProcessor.parent"></a>
    
            <div class="docstring"><p>Wraps parent module references in weak refs.</p>

<p>This prevents reference cycles from forming via parent links which can lead
to accidental OOMs in eager mode due to slow garbage collection as well as
spurious tracer leaks during jit compilation.</p>

<p>Note: "descriptors" are the underlying python mechanism for implementing
dynamic @property decorators.  We need to use a raw descriptor instead of the
more common decorator in order to force that the appropriate getter/setter
logic applies in subclasses even after various dataclass transforms.</p>
</div>


                            </div>
                            <div id="GraphProcessor.name" class="classattr">
                                <div class="attr variable">
            <span class="name">name</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#GraphProcessor.name"></a>
    
    

                            </div>
                            <div id="GraphProcessor.scope" class="classattr">
                                <div class="attr variable">
            <span class="name">scope</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#GraphProcessor.scope"></a>
    
    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>flax.linen.module.Module</dt>
                                <dd id="GraphProcessor.setup" class="function">setup</dd>
                <dd id="GraphProcessor.path" class="variable">path</dd>
                <dd id="GraphProcessor.clone" class="function">clone</dd>
                <dd id="GraphProcessor.copy" class="function">copy</dd>
                <dd id="GraphProcessor.variable" class="function">variable</dd>
                <dd id="GraphProcessor.param" class="function">param</dd>
                <dd id="GraphProcessor.has_variable" class="function">has_variable</dd>
                <dd id="GraphProcessor.is_mutable_collection" class="function">is_mutable_collection</dd>
                <dd id="GraphProcessor.has_rng" class="function">has_rng</dd>
                <dd id="GraphProcessor.make_rng" class="function">make_rng</dd>
                <dd id="GraphProcessor.is_initializing" class="function">is_initializing</dd>
                <dd id="GraphProcessor.bind" class="function">bind</dd>
                <dd id="GraphProcessor.unbind" class="function">unbind</dd>
                <dd id="GraphProcessor.apply" class="function">apply</dd>
                <dd id="GraphProcessor.init_with_output" class="function">init_with_output</dd>
                <dd id="GraphProcessor.init" class="function">init</dd>
                <dd id="GraphProcessor.lazy_init" class="function">lazy_init</dd>
                <dd id="GraphProcessor.variables" class="variable">variables</dd>
                <dd id="GraphProcessor.get_variable" class="function">get_variable</dd>
                <dd id="GraphProcessor.put_variable" class="function">put_variable</dd>
                <dd id="GraphProcessor.sow" class="function">sow</dd>
                <dd id="GraphProcessor.perturb" class="function">perturb</dd>
                <dd id="GraphProcessor.tabulate" class="function">tabulate</dd>
                <dd id="GraphProcessor.module_paths" class="function">module_paths</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="GraphFilter">
                            <input id="GraphFilter-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
                    <div class="decorator">@dataclasses.dataclass(frozen=True)</div>

    <span class="def">class</span>
    <span class="name">GraphFilter</span>:

                <label class="view-source-button" for="GraphFilter-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GraphFilter"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GraphFilter-614"><a href="#GraphFilter-614"><span class="linenos">614</span></a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="GraphFilter-615"><a href="#GraphFilter-615"><span class="linenos">615</span></a><span class="k">class</span> <span class="nc">GraphFilter</span><span class="p">:</span>
</span><span id="GraphFilter-616"><a href="#GraphFilter-616"><span class="linenos">616</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Filter a graph based on a cutoff distance</span>
</span><span id="GraphFilter-617"><a href="#GraphFilter-617"><span class="linenos">617</span></a>
</span><span id="GraphFilter-618"><a href="#GraphFilter-618"><span class="linenos">618</span></a><span class="sd">    Parameters</span>
</span><span id="GraphFilter-619"><a href="#GraphFilter-619"><span class="linenos">619</span></a><span class="sd">    ----------</span>
</span><span id="GraphFilter-620"><a href="#GraphFilter-620"><span class="linenos">620</span></a><span class="sd">    cutoff : float</span>
</span><span id="GraphFilter-621"><a href="#GraphFilter-621"><span class="linenos">621</span></a><span class="sd">        Cutoff distance for the filtering.</span>
</span><span id="GraphFilter-622"><a href="#GraphFilter-622"><span class="linenos">622</span></a><span class="sd">    parent_graph : str</span>
</span><span id="GraphFilter-623"><a href="#GraphFilter-623"><span class="linenos">623</span></a><span class="sd">        Key of the parent graph in the inputs.</span>
</span><span id="GraphFilter-624"><a href="#GraphFilter-624"><span class="linenos">624</span></a><span class="sd">    graph_key : str</span>
</span><span id="GraphFilter-625"><a href="#GraphFilter-625"><span class="linenos">625</span></a><span class="sd">        Key of the filtered graph in the outputs.</span>
</span><span id="GraphFilter-626"><a href="#GraphFilter-626"><span class="linenos">626</span></a><span class="sd">    remove_hydrogens : bool, default=False</span>
</span><span id="GraphFilter-627"><a href="#GraphFilter-627"><span class="linenos">627</span></a><span class="sd">        Remove hydrogen atoms from the graph.</span>
</span><span id="GraphFilter-628"><a href="#GraphFilter-628"><span class="linenos">628</span></a><span class="sd">    switch_params : dict, default={}</span>
</span><span id="GraphFilter-629"><a href="#GraphFilter-629"><span class="linenos">629</span></a><span class="sd">        Parameters for the switching function.</span>
</span><span id="GraphFilter-630"><a href="#GraphFilter-630"><span class="linenos">630</span></a><span class="sd">    k_space : bool, default=False</span>
</span><span id="GraphFilter-631"><a href="#GraphFilter-631"><span class="linenos">631</span></a><span class="sd">        Generate k-space information for the graph.</span>
</span><span id="GraphFilter-632"><a href="#GraphFilter-632"><span class="linenos">632</span></a><span class="sd">    kmax : int, default=30</span>
</span><span id="GraphFilter-633"><a href="#GraphFilter-633"><span class="linenos">633</span></a><span class="sd">        Maximum number of k-points to consider.</span>
</span><span id="GraphFilter-634"><a href="#GraphFilter-634"><span class="linenos">634</span></a><span class="sd">    kthr : float, default=1e-6</span>
</span><span id="GraphFilter-635"><a href="#GraphFilter-635"><span class="linenos">635</span></a><span class="sd">        Threshold for k-point filtering.</span>
</span><span id="GraphFilter-636"><a href="#GraphFilter-636"><span class="linenos">636</span></a><span class="sd">    mult_size : float, default=1.05</span>
</span><span id="GraphFilter-637"><a href="#GraphFilter-637"><span class="linenos">637</span></a><span class="sd">        Multiplicative factor for resizing the nblist.</span>
</span><span id="GraphFilter-638"><a href="#GraphFilter-638"><span class="linenos">638</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="GraphFilter-639"><a href="#GraphFilter-639"><span class="linenos">639</span></a>
</span><span id="GraphFilter-640"><a href="#GraphFilter-640"><span class="linenos">640</span></a>    <span class="n">cutoff</span><span class="p">:</span> <span class="nb">float</span>
</span><span id="GraphFilter-641"><a href="#GraphFilter-641"><span class="linenos">641</span></a>    <span class="n">parent_graph</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="GraphFilter-642"><a href="#GraphFilter-642"><span class="linenos">642</span></a>    <span class="n">graph_key</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="GraphFilter-643"><a href="#GraphFilter-643"><span class="linenos">643</span></a>    <span class="n">remove_hydrogens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="GraphFilter-644"><a href="#GraphFilter-644"><span class="linenos">644</span></a>    <span class="n">switch_params</span><span class="p">:</span> <span class="n">FrozenDict</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">FrozenDict</span><span class="p">)</span>
</span><span id="GraphFilter-645"><a href="#GraphFilter-645"><span class="linenos">645</span></a>    <span class="n">k_space</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="GraphFilter-646"><a href="#GraphFilter-646"><span class="linenos">646</span></a>    <span class="n">kmax</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span>
</span><span id="GraphFilter-647"><a href="#GraphFilter-647"><span class="linenos">647</span></a>    <span class="n">kthr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-6</span>
</span><span id="GraphFilter-648"><a href="#GraphFilter-648"><span class="linenos">648</span></a>    <span class="n">mult_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.05</span>
</span><span id="GraphFilter-649"><a href="#GraphFilter-649"><span class="linenos">649</span></a>
</span><span id="GraphFilter-650"><a href="#GraphFilter-650"><span class="linenos">650</span></a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="GraphFilter-651"><a href="#GraphFilter-651"><span class="linenos">651</span></a>        <span class="k">return</span> <span class="n">FrozenDict</span><span class="p">(</span>
</span><span id="GraphFilter-652"><a href="#GraphFilter-652"><span class="linenos">652</span></a>            <span class="p">{</span>
</span><span id="GraphFilter-653"><a href="#GraphFilter-653"><span class="linenos">653</span></a>                <span class="s2">&quot;npairs&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="GraphFilter-654"><a href="#GraphFilter-654"><span class="linenos">654</span></a>                <span class="s2">&quot;nblist_mult_size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mult_size</span><span class="p">,</span>
</span><span id="GraphFilter-655"><a href="#GraphFilter-655"><span class="linenos">655</span></a>            <span class="p">}</span>
</span><span id="GraphFilter-656"><a href="#GraphFilter-656"><span class="linenos">656</span></a>        <span class="p">)</span>
</span><span id="GraphFilter-657"><a href="#GraphFilter-657"><span class="linenos">657</span></a>
</span><span id="GraphFilter-658"><a href="#GraphFilter-658"><span class="linenos">658</span></a>    <span class="k">def</span> <span class="nf">get_processor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]:</span>
</span><span id="GraphFilter-659"><a href="#GraphFilter-659"><span class="linenos">659</span></a>        <span class="k">return</span> <span class="n">GraphFilterProcessor</span><span class="p">,</span> <span class="p">{</span>
</span><span id="GraphFilter-660"><a href="#GraphFilter-660"><span class="linenos">660</span></a>            <span class="s2">&quot;cutoff&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">,</span>
</span><span id="GraphFilter-661"><a href="#GraphFilter-661"><span class="linenos">661</span></a>            <span class="s2">&quot;graph_key&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">,</span>
</span><span id="GraphFilter-662"><a href="#GraphFilter-662"><span class="linenos">662</span></a>            <span class="s2">&quot;parent_graph&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_graph</span><span class="p">,</span>
</span><span id="GraphFilter-663"><a href="#GraphFilter-663"><span class="linenos">663</span></a>            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="si">}</span><span class="s2">_Filter_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_graph</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="GraphFilter-664"><a href="#GraphFilter-664"><span class="linenos">664</span></a>            <span class="s2">&quot;switch_params&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">switch_params</span><span class="p">,</span>
</span><span id="GraphFilter-665"><a href="#GraphFilter-665"><span class="linenos">665</span></a>        <span class="p">}</span>
</span><span id="GraphFilter-666"><a href="#GraphFilter-666"><span class="linenos">666</span></a>
</span><span id="GraphFilter-667"><a href="#GraphFilter-667"><span class="linenos">667</span></a>    <span class="k">def</span> <span class="nf">get_graph_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="GraphFilter-668"><a href="#GraphFilter-668"><span class="linenos">668</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="GraphFilter-669"><a href="#GraphFilter-669"><span class="linenos">669</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">:</span> <span class="p">{</span>
</span><span id="GraphFilter-670"><a href="#GraphFilter-670"><span class="linenos">670</span></a>                <span class="s2">&quot;cutoff&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">,</span>
</span><span id="GraphFilter-671"><a href="#GraphFilter-671"><span class="linenos">671</span></a>                <span class="s2">&quot;directed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="GraphFilter-672"><a href="#GraphFilter-672"><span class="linenos">672</span></a>                <span class="s2">&quot;parent_graph&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_graph</span><span class="p">,</span>
</span><span id="GraphFilter-673"><a href="#GraphFilter-673"><span class="linenos">673</span></a>            <span class="p">}</span>
</span><span id="GraphFilter-674"><a href="#GraphFilter-674"><span class="linenos">674</span></a>        <span class="p">}</span>
</span><span id="GraphFilter-675"><a href="#GraphFilter-675"><span class="linenos">675</span></a>
</span><span id="GraphFilter-676"><a href="#GraphFilter-676"><span class="linenos">676</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">return_state_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_margin</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="GraphFilter-677"><a href="#GraphFilter-677"><span class="linenos">677</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;filter a nblist on cpu with numpy and dynamic shapes + store max shapes&quot;&quot;&quot;</span>
</span><span id="GraphFilter-678"><a href="#GraphFilter-678"><span class="linenos">678</span></a>        <span class="n">graph_in</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_graph</span><span class="p">]</span>
</span><span id="GraphFilter-679"><a href="#GraphFilter-679"><span class="linenos">679</span></a>        <span class="n">nat</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="GraphFilter-680"><a href="#GraphFilter-680"><span class="linenos">680</span></a>
</span><span id="GraphFilter-681"><a href="#GraphFilter-681"><span class="linenos">681</span></a>        <span class="n">new_state</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">state</span><span class="p">}</span>
</span><span id="GraphFilter-682"><a href="#GraphFilter-682"><span class="linenos">682</span></a>        <span class="n">state_up</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="GraphFilter-683"><a href="#GraphFilter-683"><span class="linenos">683</span></a>
</span><span id="GraphFilter-684"><a href="#GraphFilter-684"><span class="linenos">684</span></a>        <span class="n">edge_src</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">graph_in</span><span class="p">[</span><span class="s2">&quot;edge_src&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="GraphFilter-685"><a href="#GraphFilter-685"><span class="linenos">685</span></a>        <span class="n">d12</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">graph_in</span><span class="p">[</span><span class="s2">&quot;d12&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="GraphFilter-686"><a href="#GraphFilter-686"><span class="linenos">686</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_hydrogens</span><span class="p">:</span>
</span><span id="GraphFilter-687"><a href="#GraphFilter-687"><span class="linenos">687</span></a>            <span class="n">species</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">]</span>
</span><span id="GraphFilter-688"><a href="#GraphFilter-688"><span class="linenos">688</span></a>            <span class="n">src_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">edge_src</span> <span class="o">&lt;</span> <span class="n">nat</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="GraphFilter-689"><a href="#GraphFilter-689"><span class="linenos">689</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">edge_src</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
</span><span id="GraphFilter-690"><a href="#GraphFilter-690"><span class="linenos">690</span></a>            <span class="n">mask</span><span class="p">[</span><span class="n">src_idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">species</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)[</span><span class="n">edge_src</span><span class="p">[</span><span class="n">src_idx</span><span class="p">]]</span>
</span><span id="GraphFilter-691"><a href="#GraphFilter-691"><span class="linenos">691</span></a>            <span class="n">d12</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">d12</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="GraphFilter-692"><a href="#GraphFilter-692"><span class="linenos">692</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">d12</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="o">**</span><span class="mi">2</span>
</span><span id="GraphFilter-693"><a href="#GraphFilter-693"><span class="linenos">693</span></a>
</span><span id="GraphFilter-694"><a href="#GraphFilter-694"><span class="linenos">694</span></a>        <span class="n">max_pairs</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;npairs&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="GraphFilter-695"><a href="#GraphFilter-695"><span class="linenos">695</span></a>        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">mask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="GraphFilter-696"><a href="#GraphFilter-696"><span class="linenos">696</span></a>        <span class="n">npairs</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="GraphFilter-697"><a href="#GraphFilter-697"><span class="linenos">697</span></a>        <span class="k">if</span> <span class="n">npairs</span> <span class="o">&gt;</span> <span class="n">max_pairs</span> <span class="ow">or</span> <span class="n">add_margin</span><span class="p">:</span>
</span><span id="GraphFilter-698"><a href="#GraphFilter-698"><span class="linenos">698</span></a>            <span class="n">mult_size</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nblist_mult_size&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mult_size</span><span class="p">)</span>
</span><span id="GraphFilter-699"><a href="#GraphFilter-699"><span class="linenos">699</span></a>            <span class="n">prev_max_pairs</span> <span class="o">=</span> <span class="n">max_pairs</span>
</span><span id="GraphFilter-700"><a href="#GraphFilter-700"><span class="linenos">700</span></a>            <span class="n">max_pairs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mult_size</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">npairs</span><span class="p">,</span> <span class="n">max_pairs</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="GraphFilter-701"><a href="#GraphFilter-701"><span class="linenos">701</span></a>            <span class="n">state_up</span><span class="p">[</span><span class="s2">&quot;npairs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_pairs</span><span class="p">,</span> <span class="n">prev_max_pairs</span><span class="p">)</span>
</span><span id="GraphFilter-702"><a href="#GraphFilter-702"><span class="linenos">702</span></a>            <span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;npairs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_pairs</span>
</span><span id="GraphFilter-703"><a href="#GraphFilter-703"><span class="linenos">703</span></a>
</span><span id="GraphFilter-704"><a href="#GraphFilter-704"><span class="linenos">704</span></a>        <span class="n">filter_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">max_pairs</span><span class="p">,</span> <span class="n">edge_src</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="GraphFilter-705"><a href="#GraphFilter-705"><span class="linenos">705</span></a>        <span class="n">edge_src</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">max_pairs</span><span class="p">,</span> <span class="n">nat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="GraphFilter-706"><a href="#GraphFilter-706"><span class="linenos">706</span></a>        <span class="n">edge_dst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">max_pairs</span><span class="p">,</span> <span class="n">nat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="GraphFilter-707"><a href="#GraphFilter-707"><span class="linenos">707</span></a>        <span class="n">d12_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">max_pairs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="GraphFilter-708"><a href="#GraphFilter-708"><span class="linenos">708</span></a>        <span class="n">filter_indices</span><span class="p">[:</span><span class="n">npairs</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span>
</span><span id="GraphFilter-709"><a href="#GraphFilter-709"><span class="linenos">709</span></a>        <span class="n">edge_src</span><span class="p">[:</span><span class="n">npairs</span><span class="p">]</span> <span class="o">=</span> <span class="n">graph_in</span><span class="p">[</span><span class="s2">&quot;edge_src&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
</span><span id="GraphFilter-710"><a href="#GraphFilter-710"><span class="linenos">710</span></a>        <span class="n">edge_dst</span><span class="p">[:</span><span class="n">npairs</span><span class="p">]</span> <span class="o">=</span> <span class="n">graph_in</span><span class="p">[</span><span class="s2">&quot;edge_dst&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
</span><span id="GraphFilter-711"><a href="#GraphFilter-711"><span class="linenos">711</span></a>        <span class="n">d12_</span><span class="p">[:</span><span class="n">npairs</span><span class="p">]</span> <span class="o">=</span> <span class="n">d12</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="GraphFilter-712"><a href="#GraphFilter-712"><span class="linenos">712</span></a>        <span class="n">d12</span> <span class="o">=</span> <span class="n">d12_</span>
</span><span id="GraphFilter-713"><a href="#GraphFilter-713"><span class="linenos">713</span></a>
</span><span id="GraphFilter-714"><a href="#GraphFilter-714"><span class="linenos">714</span></a>        <span class="n">graph</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span> <span class="ow">in</span> <span class="n">inputs</span> <span class="k">else</span> <span class="p">{}</span>
</span><span id="GraphFilter-715"><a href="#GraphFilter-715"><span class="linenos">715</span></a>        <span class="n">graph_out</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="GraphFilter-716"><a href="#GraphFilter-716"><span class="linenos">716</span></a>            <span class="o">**</span><span class="n">graph</span><span class="p">,</span>
</span><span id="GraphFilter-717"><a href="#GraphFilter-717"><span class="linenos">717</span></a>            <span class="s2">&quot;edge_src&quot;</span><span class="p">:</span> <span class="n">edge_src</span><span class="p">,</span>
</span><span id="GraphFilter-718"><a href="#GraphFilter-718"><span class="linenos">718</span></a>            <span class="s2">&quot;edge_dst&quot;</span><span class="p">:</span> <span class="n">edge_dst</span><span class="p">,</span>
</span><span id="GraphFilter-719"><a href="#GraphFilter-719"><span class="linenos">719</span></a>            <span class="s2">&quot;filter_indices&quot;</span><span class="p">:</span> <span class="n">filter_indices</span><span class="p">,</span>
</span><span id="GraphFilter-720"><a href="#GraphFilter-720"><span class="linenos">720</span></a>            <span class="s2">&quot;d12&quot;</span><span class="p">:</span> <span class="n">d12</span><span class="p">,</span>
</span><span id="GraphFilter-721"><a href="#GraphFilter-721"><span class="linenos">721</span></a>            <span class="s2">&quot;overflow&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="GraphFilter-722"><a href="#GraphFilter-722"><span class="linenos">722</span></a>        <span class="p">}</span>
</span><span id="GraphFilter-723"><a href="#GraphFilter-723"><span class="linenos">723</span></a>
</span><span id="GraphFilter-724"><a href="#GraphFilter-724"><span class="linenos">724</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_space</span> <span class="ow">and</span> <span class="s2">&quot;cells&quot;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
</span><span id="GraphFilter-725"><a href="#GraphFilter-725"><span class="linenos">725</span></a>            <span class="k">if</span> <span class="s2">&quot;k_points&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">graph</span><span class="p">:</span>
</span><span id="GraphFilter-726"><a href="#GraphFilter-726"><span class="linenos">726</span></a>                <span class="n">ks</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">bewald</span> <span class="o">=</span> <span class="n">get_reciprocal_space_parameters</span><span class="p">(</span>
</span><span id="GraphFilter-727"><a href="#GraphFilter-727"><span class="linenos">727</span></a>                    <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;reciprocal_cells&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kthr</span>
</span><span id="GraphFilter-728"><a href="#GraphFilter-728"><span class="linenos">728</span></a>                <span class="p">)</span>
</span><span id="GraphFilter-729"><a href="#GraphFilter-729"><span class="linenos">729</span></a>            <span class="n">graph_out</span><span class="p">[</span><span class="s2">&quot;k_points&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ks</span>
</span><span id="GraphFilter-730"><a href="#GraphFilter-730"><span class="linenos">730</span></a>            <span class="n">graph_out</span><span class="p">[</span><span class="s2">&quot;b_ewald&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bewald</span>
</span><span id="GraphFilter-731"><a href="#GraphFilter-731"><span class="linenos">731</span></a>
</span><span id="GraphFilter-732"><a href="#GraphFilter-732"><span class="linenos">732</span></a>        <span class="n">output</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">:</span> <span class="n">graph_out</span><span class="p">}</span>
</span><span id="GraphFilter-733"><a href="#GraphFilter-733"><span class="linenos">733</span></a>        <span class="k">if</span> <span class="n">return_state_update</span><span class="p">:</span>
</span><span id="GraphFilter-734"><a href="#GraphFilter-734"><span class="linenos">734</span></a>            <span class="k">return</span> <span class="n">FrozenDict</span><span class="p">(</span><span class="n">new_state</span><span class="p">),</span> <span class="n">output</span><span class="p">,</span> <span class="n">state_up</span>
</span><span id="GraphFilter-735"><a href="#GraphFilter-735"><span class="linenos">735</span></a>        <span class="k">return</span> <span class="n">FrozenDict</span><span class="p">(</span><span class="n">new_state</span><span class="p">),</span> <span class="n">output</span>
</span><span id="GraphFilter-736"><a href="#GraphFilter-736"><span class="linenos">736</span></a>
</span><span id="GraphFilter-737"><a href="#GraphFilter-737"><span class="linenos">737</span></a>    <span class="k">def</span> <span class="nf">check_reallocate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">parent_overflow</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="GraphFilter-738"><a href="#GraphFilter-738"><span class="linenos">738</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;check for overflow and reallocate nblist if necessary&quot;&quot;&quot;</span>
</span><span id="GraphFilter-739"><a href="#GraphFilter-739"><span class="linenos">739</span></a>        <span class="n">overflow</span> <span class="o">=</span> <span class="n">parent_overflow</span> <span class="ow">or</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;overflow&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="GraphFilter-740"><a href="#GraphFilter-740"><span class="linenos">740</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">overflow</span><span class="p">:</span>
</span><span id="GraphFilter-741"><a href="#GraphFilter-741"><span class="linenos">741</span></a>            <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="p">{},</span> <span class="n">inputs</span><span class="p">,</span> <span class="kc">False</span>
</span><span id="GraphFilter-742"><a href="#GraphFilter-742"><span class="linenos">742</span></a>
</span><span id="GraphFilter-743"><a href="#GraphFilter-743"><span class="linenos">743</span></a>        <span class="n">add_margin</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;overflow&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="GraphFilter-744"><a href="#GraphFilter-744"><span class="linenos">744</span></a>        <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">state_up</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span>
</span><span id="GraphFilter-745"><a href="#GraphFilter-745"><span class="linenos">745</span></a>            <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">return_state_update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">add_margin</span><span class="o">=</span><span class="n">add_margin</span>
</span><span id="GraphFilter-746"><a href="#GraphFilter-746"><span class="linenos">746</span></a>        <span class="p">)</span>
</span><span id="GraphFilter-747"><a href="#GraphFilter-747"><span class="linenos">747</span></a>        <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="n">state_up</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="kc">True</span>
</span><span id="GraphFilter-748"><a href="#GraphFilter-748"><span class="linenos">748</span></a>
</span><span id="GraphFilter-749"><a href="#GraphFilter-749"><span class="linenos">749</span></a>    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="GraphFilter-750"><a href="#GraphFilter-750"><span class="linenos">750</span></a>    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
</span><span id="GraphFilter-751"><a href="#GraphFilter-751"><span class="linenos">751</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;filter a nblist on accelerator with jax and precomputed shapes&quot;&quot;&quot;</span>
</span><span id="GraphFilter-752"><a href="#GraphFilter-752"><span class="linenos">752</span></a>        <span class="n">graph_in</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_graph</span><span class="p">]</span>
</span><span id="GraphFilter-753"><a href="#GraphFilter-753"><span class="linenos">753</span></a>        <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="GraphFilter-754"><a href="#GraphFilter-754"><span class="linenos">754</span></a>            <span class="c1"># skin update mode</span>
</span><span id="GraphFilter-755"><a href="#GraphFilter-755"><span class="linenos">755</span></a>            <span class="n">graph</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">]</span>
</span><span id="GraphFilter-756"><a href="#GraphFilter-756"><span class="linenos">756</span></a>            <span class="n">max_pairs</span> <span class="o">=</span> <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;edge_src&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="GraphFilter-757"><a href="#GraphFilter-757"><span class="linenos">757</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="GraphFilter-758"><a href="#GraphFilter-758"><span class="linenos">758</span></a>            <span class="n">max_pairs</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;npairs&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="GraphFilter-759"><a href="#GraphFilter-759"><span class="linenos">759</span></a>
</span><span id="GraphFilter-760"><a href="#GraphFilter-760"><span class="linenos">760</span></a>        <span class="n">max_pairs_in</span> <span class="o">=</span> <span class="n">graph_in</span><span class="p">[</span><span class="s2">&quot;edge_src&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="GraphFilter-761"><a href="#GraphFilter-761"><span class="linenos">761</span></a>        <span class="n">nat</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="GraphFilter-762"><a href="#GraphFilter-762"><span class="linenos">762</span></a>
</span><span id="GraphFilter-763"><a href="#GraphFilter-763"><span class="linenos">763</span></a>        <span class="n">edge_src</span> <span class="o">=</span> <span class="n">graph_in</span><span class="p">[</span><span class="s2">&quot;edge_src&quot;</span><span class="p">]</span>
</span><span id="GraphFilter-764"><a href="#GraphFilter-764"><span class="linenos">764</span></a>        <span class="n">d12</span> <span class="o">=</span> <span class="n">graph_in</span><span class="p">[</span><span class="s2">&quot;d12&quot;</span><span class="p">]</span>
</span><span id="GraphFilter-765"><a href="#GraphFilter-765"><span class="linenos">765</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_hydrogens</span><span class="p">:</span>
</span><span id="GraphFilter-766"><a href="#GraphFilter-766"><span class="linenos">766</span></a>            <span class="n">species</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">]</span>
</span><span id="GraphFilter-767"><a href="#GraphFilter-767"><span class="linenos">767</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">species</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)[</span><span class="n">edge_src</span><span class="p">]</span>
</span><span id="GraphFilter-768"><a href="#GraphFilter-768"><span class="linenos">768</span></a>            <span class="n">d12</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">d12</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="GraphFilter-769"><a href="#GraphFilter-769"><span class="linenos">769</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">d12</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="o">**</span><span class="mi">2</span>
</span><span id="GraphFilter-770"><a href="#GraphFilter-770"><span class="linenos">770</span></a>
</span><span id="GraphFilter-771"><a href="#GraphFilter-771"><span class="linenos">771</span></a>        <span class="p">(</span><span class="n">edge_src</span><span class="p">,</span> <span class="n">edge_dst</span><span class="p">,</span> <span class="n">d12</span><span class="p">,</span> <span class="n">filter_indices</span><span class="p">),</span> <span class="n">_</span><span class="p">,</span> <span class="n">npairs</span> <span class="o">=</span> <span class="n">mask_filter_1d</span><span class="p">(</span>
</span><span id="GraphFilter-772"><a href="#GraphFilter-772"><span class="linenos">772</span></a>            <span class="n">mask</span><span class="p">,</span>
</span><span id="GraphFilter-773"><a href="#GraphFilter-773"><span class="linenos">773</span></a>            <span class="n">max_pairs</span><span class="p">,</span>
</span><span id="GraphFilter-774"><a href="#GraphFilter-774"><span class="linenos">774</span></a>            <span class="p">(</span><span class="n">edge_src</span><span class="p">,</span> <span class="n">nat</span><span class="p">),</span>
</span><span id="GraphFilter-775"><a href="#GraphFilter-775"><span class="linenos">775</span></a>            <span class="p">(</span><span class="n">graph_in</span><span class="p">[</span><span class="s2">&quot;edge_dst&quot;</span><span class="p">],</span> <span class="n">nat</span><span class="p">),</span>
</span><span id="GraphFilter-776"><a href="#GraphFilter-776"><span class="linenos">776</span></a>            <span class="p">(</span><span class="n">d12</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>
</span><span id="GraphFilter-777"><a href="#GraphFilter-777"><span class="linenos">777</span></a>            <span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">max_pairs_in</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">max_pairs_in</span><span class="p">),</span>
</span><span id="GraphFilter-778"><a href="#GraphFilter-778"><span class="linenos">778</span></a>        <span class="p">)</span>
</span><span id="GraphFilter-779"><a href="#GraphFilter-779"><span class="linenos">779</span></a>
</span><span id="GraphFilter-780"><a href="#GraphFilter-780"><span class="linenos">780</span></a>        <span class="n">graph</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span> <span class="ow">in</span> <span class="n">inputs</span> <span class="k">else</span> <span class="p">{}</span>
</span><span id="GraphFilter-781"><a href="#GraphFilter-781"><span class="linenos">781</span></a>        <span class="n">overflow</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;overflow&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">npairs</span> <span class="o">&gt;</span> <span class="n">max_pairs</span><span class="p">)</span>
</span><span id="GraphFilter-782"><a href="#GraphFilter-782"><span class="linenos">782</span></a>        <span class="n">graph_out</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="GraphFilter-783"><a href="#GraphFilter-783"><span class="linenos">783</span></a>            <span class="o">**</span><span class="n">graph</span><span class="p">,</span>
</span><span id="GraphFilter-784"><a href="#GraphFilter-784"><span class="linenos">784</span></a>            <span class="s2">&quot;edge_src&quot;</span><span class="p">:</span> <span class="n">edge_src</span><span class="p">,</span>
</span><span id="GraphFilter-785"><a href="#GraphFilter-785"><span class="linenos">785</span></a>            <span class="s2">&quot;edge_dst&quot;</span><span class="p">:</span> <span class="n">edge_dst</span><span class="p">,</span>
</span><span id="GraphFilter-786"><a href="#GraphFilter-786"><span class="linenos">786</span></a>            <span class="s2">&quot;filter_indices&quot;</span><span class="p">:</span> <span class="n">filter_indices</span><span class="p">,</span>
</span><span id="GraphFilter-787"><a href="#GraphFilter-787"><span class="linenos">787</span></a>            <span class="s2">&quot;d12&quot;</span><span class="p">:</span> <span class="n">d12</span><span class="p">,</span>
</span><span id="GraphFilter-788"><a href="#GraphFilter-788"><span class="linenos">788</span></a>            <span class="s2">&quot;overflow&quot;</span><span class="p">:</span> <span class="n">overflow</span><span class="p">,</span>
</span><span id="GraphFilter-789"><a href="#GraphFilter-789"><span class="linenos">789</span></a>        <span class="p">}</span>
</span><span id="GraphFilter-790"><a href="#GraphFilter-790"><span class="linenos">790</span></a>
</span><span id="GraphFilter-791"><a href="#GraphFilter-791"><span class="linenos">791</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_space</span> <span class="ow">and</span> <span class="s2">&quot;cells&quot;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
</span><span id="GraphFilter-792"><a href="#GraphFilter-792"><span class="linenos">792</span></a>            <span class="k">if</span> <span class="s2">&quot;k_points&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">graph</span><span class="p">:</span>
</span><span id="GraphFilter-793"><a href="#GraphFilter-793"><span class="linenos">793</span></a>                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
</span><span id="GraphFilter-794"><a href="#GraphFilter-794"><span class="linenos">794</span></a>                    <span class="s2">&quot;k_space generation not implemented on accelerator. Call the numpy routine (self.__call__) first.&quot;</span>
</span><span id="GraphFilter-795"><a href="#GraphFilter-795"><span class="linenos">795</span></a>                <span class="p">)</span>
</span><span id="GraphFilter-796"><a href="#GraphFilter-796"><span class="linenos">796</span></a>
</span><span id="GraphFilter-797"><a href="#GraphFilter-797"><span class="linenos">797</span></a>        <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">:</span> <span class="n">graph_out</span><span class="p">}</span>
</span><span id="GraphFilter-798"><a href="#GraphFilter-798"><span class="linenos">798</span></a>
</span><span id="GraphFilter-799"><a href="#GraphFilter-799"><span class="linenos">799</span></a>    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
</span><span id="GraphFilter-800"><a href="#GraphFilter-800"><span class="linenos">800</span></a>    <span class="k">def</span> <span class="nf">update_skin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
</span><span id="GraphFilter-801"><a href="#GraphFilter-801"><span class="linenos">801</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Filter a graph based on a cutoff distance</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>cutoff</strong> (float):
Cutoff distance for the filtering.</li>
<li><strong>parent_graph</strong> (str):
Key of the parent graph in the inputs.</li>
<li><strong>graph_key</strong> (str):
Key of the filtered graph in the outputs.</li>
<li><strong>remove_hydrogens</strong> (bool, default=False):
Remove hydrogen atoms from the graph.</li>
<li><strong>switch_params</strong> (dict, default={}):
Parameters for the switching function.</li>
<li><strong>k_space</strong> (bool, default=False):
Generate k-space information for the graph.</li>
<li><strong>kmax</strong> (int, default=30):
Maximum number of k-points to consider.</li>
<li><strong>kthr</strong> (float, default=1e-6):
Threshold for k-point filtering.</li>
<li><strong>mult_size</strong> (float, default=1.05):
Multiplicative factor for resizing the nblist.</li>
</ul>
</div>


                            <div id="GraphFilter.__init__" class="classattr">
                                <div class="attr function">
            
        <span class="name">GraphFilter</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">cutoff</span><span class="p">:</span> <span class="nb">float</span>,</span><span class="param">	<span class="n">parent_graph</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">graph_key</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">remove_hydrogens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">switch_params</span><span class="p">:</span> <span class="n">flax</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frozen_dict</span><span class="o">.</span><span class="n">FrozenDict</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">factory</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">k_space</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">kmax</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span>,</span><span class="param">	<span class="n">kthr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-06</span>,</span><span class="param">	<span class="n">mult_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.05</span></span>)</span>

        
    </div>
    <a class="headerlink" href="#GraphFilter.__init__"></a>
    
    

                            </div>
                            <div id="GraphFilter.cutoff" class="classattr">
                                <div class="attr variable">
            <span class="name">cutoff</span><span class="annotation">: float</span>

        
    </div>
    <a class="headerlink" href="#GraphFilter.cutoff"></a>
    
    

                            </div>
                            <div id="GraphFilter.parent_graph" class="classattr">
                                <div class="attr variable">
            <span class="name">parent_graph</span><span class="annotation">: str</span>

        
    </div>
    <a class="headerlink" href="#GraphFilter.parent_graph"></a>
    
    

                            </div>
                            <div id="GraphFilter.graph_key" class="classattr">
                                <div class="attr variable">
            <span class="name">graph_key</span><span class="annotation">: str</span>

        
    </div>
    <a class="headerlink" href="#GraphFilter.graph_key"></a>
    
    

                            </div>
                            <div id="GraphFilter.remove_hydrogens" class="classattr">
                                <div class="attr variable">
            <span class="name">remove_hydrogens</span><span class="annotation">: int</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#GraphFilter.remove_hydrogens"></a>
    
    

                            </div>
                            <div id="GraphFilter.switch_params" class="classattr">
                                <div class="attr variable">
            <span class="name">switch_params</span><span class="annotation">: flax.core.frozen_dict.FrozenDict</span>

        
    </div>
    <a class="headerlink" href="#GraphFilter.switch_params"></a>
    
    

                            </div>
                            <div id="GraphFilter.k_space" class="classattr">
                                <div class="attr variable">
            <span class="name">k_space</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#GraphFilter.k_space"></a>
    
    

                            </div>
                            <div id="GraphFilter.kmax" class="classattr">
                                <div class="attr variable">
            <span class="name">kmax</span><span class="annotation">: int</span>        =
<span class="default_value">30</span>

        
    </div>
    <a class="headerlink" href="#GraphFilter.kmax"></a>
    
    

                            </div>
                            <div id="GraphFilter.kthr" class="classattr">
                                <div class="attr variable">
            <span class="name">kthr</span><span class="annotation">: float</span>        =
<span class="default_value">1e-06</span>

        
    </div>
    <a class="headerlink" href="#GraphFilter.kthr"></a>
    
    

                            </div>
                            <div id="GraphFilter.mult_size" class="classattr">
                                <div class="attr variable">
            <span class="name">mult_size</span><span class="annotation">: float</span>        =
<span class="default_value">1.05</span>

        
    </div>
    <a class="headerlink" href="#GraphFilter.mult_size"></a>
    
    

                            </div>
                            <div id="GraphFilter.init" class="classattr">
                                        <input id="GraphFilter.init-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">init</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="GraphFilter.init-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GraphFilter.init"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GraphFilter.init-650"><a href="#GraphFilter.init-650"><span class="linenos">650</span></a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="GraphFilter.init-651"><a href="#GraphFilter.init-651"><span class="linenos">651</span></a>        <span class="k">return</span> <span class="n">FrozenDict</span><span class="p">(</span>
</span><span id="GraphFilter.init-652"><a href="#GraphFilter.init-652"><span class="linenos">652</span></a>            <span class="p">{</span>
</span><span id="GraphFilter.init-653"><a href="#GraphFilter.init-653"><span class="linenos">653</span></a>                <span class="s2">&quot;npairs&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="GraphFilter.init-654"><a href="#GraphFilter.init-654"><span class="linenos">654</span></a>                <span class="s2">&quot;nblist_mult_size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mult_size</span><span class="p">,</span>
</span><span id="GraphFilter.init-655"><a href="#GraphFilter.init-655"><span class="linenos">655</span></a>            <span class="p">}</span>
</span><span id="GraphFilter.init-656"><a href="#GraphFilter.init-656"><span class="linenos">656</span></a>        <span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="GraphFilter.get_processor" class="classattr">
                                        <input id="GraphFilter.get_processor-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_processor</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">Tuple</span><span class="p">[</span><span class="n">flax</span><span class="o">.</span><span class="n">linen</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="GraphFilter.get_processor-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GraphFilter.get_processor"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GraphFilter.get_processor-658"><a href="#GraphFilter.get_processor-658"><span class="linenos">658</span></a>    <span class="k">def</span> <span class="nf">get_processor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]:</span>
</span><span id="GraphFilter.get_processor-659"><a href="#GraphFilter.get_processor-659"><span class="linenos">659</span></a>        <span class="k">return</span> <span class="n">GraphFilterProcessor</span><span class="p">,</span> <span class="p">{</span>
</span><span id="GraphFilter.get_processor-660"><a href="#GraphFilter.get_processor-660"><span class="linenos">660</span></a>            <span class="s2">&quot;cutoff&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">,</span>
</span><span id="GraphFilter.get_processor-661"><a href="#GraphFilter.get_processor-661"><span class="linenos">661</span></a>            <span class="s2">&quot;graph_key&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">,</span>
</span><span id="GraphFilter.get_processor-662"><a href="#GraphFilter.get_processor-662"><span class="linenos">662</span></a>            <span class="s2">&quot;parent_graph&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_graph</span><span class="p">,</span>
</span><span id="GraphFilter.get_processor-663"><a href="#GraphFilter.get_processor-663"><span class="linenos">663</span></a>            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="si">}</span><span class="s2">_Filter_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_graph</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="GraphFilter.get_processor-664"><a href="#GraphFilter.get_processor-664"><span class="linenos">664</span></a>            <span class="s2">&quot;switch_params&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">switch_params</span><span class="p">,</span>
</span><span id="GraphFilter.get_processor-665"><a href="#GraphFilter.get_processor-665"><span class="linenos">665</span></a>        <span class="p">}</span>
</span></pre></div>


    

                            </div>
                            <div id="GraphFilter.get_graph_properties" class="classattr">
                                        <input id="GraphFilter.get_graph_properties-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_graph_properties</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="GraphFilter.get_graph_properties-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GraphFilter.get_graph_properties"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GraphFilter.get_graph_properties-667"><a href="#GraphFilter.get_graph_properties-667"><span class="linenos">667</span></a>    <span class="k">def</span> <span class="nf">get_graph_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="GraphFilter.get_graph_properties-668"><a href="#GraphFilter.get_graph_properties-668"><span class="linenos">668</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="GraphFilter.get_graph_properties-669"><a href="#GraphFilter.get_graph_properties-669"><span class="linenos">669</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">:</span> <span class="p">{</span>
</span><span id="GraphFilter.get_graph_properties-670"><a href="#GraphFilter.get_graph_properties-670"><span class="linenos">670</span></a>                <span class="s2">&quot;cutoff&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">,</span>
</span><span id="GraphFilter.get_graph_properties-671"><a href="#GraphFilter.get_graph_properties-671"><span class="linenos">671</span></a>                <span class="s2">&quot;directed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="GraphFilter.get_graph_properties-672"><a href="#GraphFilter.get_graph_properties-672"><span class="linenos">672</span></a>                <span class="s2">&quot;parent_graph&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_graph</span><span class="p">,</span>
</span><span id="GraphFilter.get_graph_properties-673"><a href="#GraphFilter.get_graph_properties-673"><span class="linenos">673</span></a>            <span class="p">}</span>
</span><span id="GraphFilter.get_graph_properties-674"><a href="#GraphFilter.get_graph_properties-674"><span class="linenos">674</span></a>        <span class="p">}</span>
</span></pre></div>


    

                            </div>
                            <div id="GraphFilter.check_reallocate" class="classattr">
                                        <input id="GraphFilter.check_reallocate-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">check_reallocate</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">state</span>, </span><span class="param"><span class="n">inputs</span>, </span><span class="param"><span class="n">parent_overflow</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="GraphFilter.check_reallocate-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GraphFilter.check_reallocate"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GraphFilter.check_reallocate-737"><a href="#GraphFilter.check_reallocate-737"><span class="linenos">737</span></a>    <span class="k">def</span> <span class="nf">check_reallocate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">parent_overflow</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="GraphFilter.check_reallocate-738"><a href="#GraphFilter.check_reallocate-738"><span class="linenos">738</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;check for overflow and reallocate nblist if necessary&quot;&quot;&quot;</span>
</span><span id="GraphFilter.check_reallocate-739"><a href="#GraphFilter.check_reallocate-739"><span class="linenos">739</span></a>        <span class="n">overflow</span> <span class="o">=</span> <span class="n">parent_overflow</span> <span class="ow">or</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;overflow&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="GraphFilter.check_reallocate-740"><a href="#GraphFilter.check_reallocate-740"><span class="linenos">740</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">overflow</span><span class="p">:</span>
</span><span id="GraphFilter.check_reallocate-741"><a href="#GraphFilter.check_reallocate-741"><span class="linenos">741</span></a>            <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="p">{},</span> <span class="n">inputs</span><span class="p">,</span> <span class="kc">False</span>
</span><span id="GraphFilter.check_reallocate-742"><a href="#GraphFilter.check_reallocate-742"><span class="linenos">742</span></a>
</span><span id="GraphFilter.check_reallocate-743"><a href="#GraphFilter.check_reallocate-743"><span class="linenos">743</span></a>        <span class="n">add_margin</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;overflow&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="GraphFilter.check_reallocate-744"><a href="#GraphFilter.check_reallocate-744"><span class="linenos">744</span></a>        <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">state_up</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span>
</span><span id="GraphFilter.check_reallocate-745"><a href="#GraphFilter.check_reallocate-745"><span class="linenos">745</span></a>            <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">return_state_update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">add_margin</span><span class="o">=</span><span class="n">add_margin</span>
</span><span id="GraphFilter.check_reallocate-746"><a href="#GraphFilter.check_reallocate-746"><span class="linenos">746</span></a>        <span class="p">)</span>
</span><span id="GraphFilter.check_reallocate-747"><a href="#GraphFilter.check_reallocate-747"><span class="linenos">747</span></a>        <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="n">state_up</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="kc">True</span>
</span></pre></div>


            <div class="docstring"><p>check for overflow and reallocate nblist if necessary</p>
</div>


                            </div>
                            <div id="GraphFilter.process" class="classattr">
                                        <input id="GraphFilter.process-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@partial(jax.jit, static_argnums=(0, 1))</div>

        <span class="def">def</span>
        <span class="name">process</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">state</span>, </span><span class="param"><span class="n">inputs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="GraphFilter.process-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GraphFilter.process"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GraphFilter.process-749"><a href="#GraphFilter.process-749"><span class="linenos">749</span></a>    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="GraphFilter.process-750"><a href="#GraphFilter.process-750"><span class="linenos">750</span></a>    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
</span><span id="GraphFilter.process-751"><a href="#GraphFilter.process-751"><span class="linenos">751</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;filter a nblist on accelerator with jax and precomputed shapes&quot;&quot;&quot;</span>
</span><span id="GraphFilter.process-752"><a href="#GraphFilter.process-752"><span class="linenos">752</span></a>        <span class="n">graph_in</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_graph</span><span class="p">]</span>
</span><span id="GraphFilter.process-753"><a href="#GraphFilter.process-753"><span class="linenos">753</span></a>        <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="GraphFilter.process-754"><a href="#GraphFilter.process-754"><span class="linenos">754</span></a>            <span class="c1"># skin update mode</span>
</span><span id="GraphFilter.process-755"><a href="#GraphFilter.process-755"><span class="linenos">755</span></a>            <span class="n">graph</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">]</span>
</span><span id="GraphFilter.process-756"><a href="#GraphFilter.process-756"><span class="linenos">756</span></a>            <span class="n">max_pairs</span> <span class="o">=</span> <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;edge_src&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="GraphFilter.process-757"><a href="#GraphFilter.process-757"><span class="linenos">757</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="GraphFilter.process-758"><a href="#GraphFilter.process-758"><span class="linenos">758</span></a>            <span class="n">max_pairs</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;npairs&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="GraphFilter.process-759"><a href="#GraphFilter.process-759"><span class="linenos">759</span></a>
</span><span id="GraphFilter.process-760"><a href="#GraphFilter.process-760"><span class="linenos">760</span></a>        <span class="n">max_pairs_in</span> <span class="o">=</span> <span class="n">graph_in</span><span class="p">[</span><span class="s2">&quot;edge_src&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="GraphFilter.process-761"><a href="#GraphFilter.process-761"><span class="linenos">761</span></a>        <span class="n">nat</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="GraphFilter.process-762"><a href="#GraphFilter.process-762"><span class="linenos">762</span></a>
</span><span id="GraphFilter.process-763"><a href="#GraphFilter.process-763"><span class="linenos">763</span></a>        <span class="n">edge_src</span> <span class="o">=</span> <span class="n">graph_in</span><span class="p">[</span><span class="s2">&quot;edge_src&quot;</span><span class="p">]</span>
</span><span id="GraphFilter.process-764"><a href="#GraphFilter.process-764"><span class="linenos">764</span></a>        <span class="n">d12</span> <span class="o">=</span> <span class="n">graph_in</span><span class="p">[</span><span class="s2">&quot;d12&quot;</span><span class="p">]</span>
</span><span id="GraphFilter.process-765"><a href="#GraphFilter.process-765"><span class="linenos">765</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_hydrogens</span><span class="p">:</span>
</span><span id="GraphFilter.process-766"><a href="#GraphFilter.process-766"><span class="linenos">766</span></a>            <span class="n">species</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">]</span>
</span><span id="GraphFilter.process-767"><a href="#GraphFilter.process-767"><span class="linenos">767</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">species</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)[</span><span class="n">edge_src</span><span class="p">]</span>
</span><span id="GraphFilter.process-768"><a href="#GraphFilter.process-768"><span class="linenos">768</span></a>            <span class="n">d12</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">d12</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="GraphFilter.process-769"><a href="#GraphFilter.process-769"><span class="linenos">769</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">d12</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="o">**</span><span class="mi">2</span>
</span><span id="GraphFilter.process-770"><a href="#GraphFilter.process-770"><span class="linenos">770</span></a>
</span><span id="GraphFilter.process-771"><a href="#GraphFilter.process-771"><span class="linenos">771</span></a>        <span class="p">(</span><span class="n">edge_src</span><span class="p">,</span> <span class="n">edge_dst</span><span class="p">,</span> <span class="n">d12</span><span class="p">,</span> <span class="n">filter_indices</span><span class="p">),</span> <span class="n">_</span><span class="p">,</span> <span class="n">npairs</span> <span class="o">=</span> <span class="n">mask_filter_1d</span><span class="p">(</span>
</span><span id="GraphFilter.process-772"><a href="#GraphFilter.process-772"><span class="linenos">772</span></a>            <span class="n">mask</span><span class="p">,</span>
</span><span id="GraphFilter.process-773"><a href="#GraphFilter.process-773"><span class="linenos">773</span></a>            <span class="n">max_pairs</span><span class="p">,</span>
</span><span id="GraphFilter.process-774"><a href="#GraphFilter.process-774"><span class="linenos">774</span></a>            <span class="p">(</span><span class="n">edge_src</span><span class="p">,</span> <span class="n">nat</span><span class="p">),</span>
</span><span id="GraphFilter.process-775"><a href="#GraphFilter.process-775"><span class="linenos">775</span></a>            <span class="p">(</span><span class="n">graph_in</span><span class="p">[</span><span class="s2">&quot;edge_dst&quot;</span><span class="p">],</span> <span class="n">nat</span><span class="p">),</span>
</span><span id="GraphFilter.process-776"><a href="#GraphFilter.process-776"><span class="linenos">776</span></a>            <span class="p">(</span><span class="n">d12</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>
</span><span id="GraphFilter.process-777"><a href="#GraphFilter.process-777"><span class="linenos">777</span></a>            <span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">max_pairs_in</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">max_pairs_in</span><span class="p">),</span>
</span><span id="GraphFilter.process-778"><a href="#GraphFilter.process-778"><span class="linenos">778</span></a>        <span class="p">)</span>
</span><span id="GraphFilter.process-779"><a href="#GraphFilter.process-779"><span class="linenos">779</span></a>
</span><span id="GraphFilter.process-780"><a href="#GraphFilter.process-780"><span class="linenos">780</span></a>        <span class="n">graph</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span> <span class="ow">in</span> <span class="n">inputs</span> <span class="k">else</span> <span class="p">{}</span>
</span><span id="GraphFilter.process-781"><a href="#GraphFilter.process-781"><span class="linenos">781</span></a>        <span class="n">overflow</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;overflow&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">npairs</span> <span class="o">&gt;</span> <span class="n">max_pairs</span><span class="p">)</span>
</span><span id="GraphFilter.process-782"><a href="#GraphFilter.process-782"><span class="linenos">782</span></a>        <span class="n">graph_out</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="GraphFilter.process-783"><a href="#GraphFilter.process-783"><span class="linenos">783</span></a>            <span class="o">**</span><span class="n">graph</span><span class="p">,</span>
</span><span id="GraphFilter.process-784"><a href="#GraphFilter.process-784"><span class="linenos">784</span></a>            <span class="s2">&quot;edge_src&quot;</span><span class="p">:</span> <span class="n">edge_src</span><span class="p">,</span>
</span><span id="GraphFilter.process-785"><a href="#GraphFilter.process-785"><span class="linenos">785</span></a>            <span class="s2">&quot;edge_dst&quot;</span><span class="p">:</span> <span class="n">edge_dst</span><span class="p">,</span>
</span><span id="GraphFilter.process-786"><a href="#GraphFilter.process-786"><span class="linenos">786</span></a>            <span class="s2">&quot;filter_indices&quot;</span><span class="p">:</span> <span class="n">filter_indices</span><span class="p">,</span>
</span><span id="GraphFilter.process-787"><a href="#GraphFilter.process-787"><span class="linenos">787</span></a>            <span class="s2">&quot;d12&quot;</span><span class="p">:</span> <span class="n">d12</span><span class="p">,</span>
</span><span id="GraphFilter.process-788"><a href="#GraphFilter.process-788"><span class="linenos">788</span></a>            <span class="s2">&quot;overflow&quot;</span><span class="p">:</span> <span class="n">overflow</span><span class="p">,</span>
</span><span id="GraphFilter.process-789"><a href="#GraphFilter.process-789"><span class="linenos">789</span></a>        <span class="p">}</span>
</span><span id="GraphFilter.process-790"><a href="#GraphFilter.process-790"><span class="linenos">790</span></a>
</span><span id="GraphFilter.process-791"><a href="#GraphFilter.process-791"><span class="linenos">791</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_space</span> <span class="ow">and</span> <span class="s2">&quot;cells&quot;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
</span><span id="GraphFilter.process-792"><a href="#GraphFilter.process-792"><span class="linenos">792</span></a>            <span class="k">if</span> <span class="s2">&quot;k_points&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">graph</span><span class="p">:</span>
</span><span id="GraphFilter.process-793"><a href="#GraphFilter.process-793"><span class="linenos">793</span></a>                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
</span><span id="GraphFilter.process-794"><a href="#GraphFilter.process-794"><span class="linenos">794</span></a>                    <span class="s2">&quot;k_space generation not implemented on accelerator. Call the numpy routine (self.__call__) first.&quot;</span>
</span><span id="GraphFilter.process-795"><a href="#GraphFilter.process-795"><span class="linenos">795</span></a>                <span class="p">)</span>
</span><span id="GraphFilter.process-796"><a href="#GraphFilter.process-796"><span class="linenos">796</span></a>
</span><span id="GraphFilter.process-797"><a href="#GraphFilter.process-797"><span class="linenos">797</span></a>        <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">:</span> <span class="n">graph_out</span><span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>filter a nblist on accelerator with jax and precomputed shapes</p>
</div>


                            </div>
                            <div id="GraphFilter.update_skin" class="classattr">
                                        <input id="GraphFilter.update_skin-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@partial(jax.jit, static_argnums=(0,))</div>

        <span class="def">def</span>
        <span class="name">update_skin</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">inputs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="GraphFilter.update_skin-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GraphFilter.update_skin"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GraphFilter.update_skin-799"><a href="#GraphFilter.update_skin-799"><span class="linenos">799</span></a>    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
</span><span id="GraphFilter.update_skin-800"><a href="#GraphFilter.update_skin-800"><span class="linenos">800</span></a>    <span class="k">def</span> <span class="nf">update_skin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
</span><span id="GraphFilter.update_skin-801"><a href="#GraphFilter.update_skin-801"><span class="linenos">801</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                </section>
                <section id="GraphFilterProcessor">
                            <input id="GraphFilterProcessor-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">GraphFilterProcessor</span><wbr>(<span class="base">flax.linen.module.Module</span>):

                <label class="view-source-button" for="GraphFilterProcessor-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GraphFilterProcessor"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GraphFilterProcessor-804"><a href="#GraphFilterProcessor-804"><span class="linenos">804</span></a><span class="k">class</span> <span class="nc">GraphFilterProcessor</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="GraphFilterProcessor-805"><a href="#GraphFilterProcessor-805"><span class="linenos">805</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Filter processing for a pre-generated graph</span>
</span><span id="GraphFilterProcessor-806"><a href="#GraphFilterProcessor-806"><span class="linenos">806</span></a>
</span><span id="GraphFilterProcessor-807"><a href="#GraphFilterProcessor-807"><span class="linenos">807</span></a><span class="sd">    This module is automatically added to a FENNIX model when a GraphFilter is used.</span>
</span><span id="GraphFilterProcessor-808"><a href="#GraphFilterProcessor-808"><span class="linenos">808</span></a>
</span><span id="GraphFilterProcessor-809"><a href="#GraphFilterProcessor-809"><span class="linenos">809</span></a><span class="sd">    Parameters</span>
</span><span id="GraphFilterProcessor-810"><a href="#GraphFilterProcessor-810"><span class="linenos">810</span></a><span class="sd">    ----------</span>
</span><span id="GraphFilterProcessor-811"><a href="#GraphFilterProcessor-811"><span class="linenos">811</span></a><span class="sd">    cutoff : float</span>
</span><span id="GraphFilterProcessor-812"><a href="#GraphFilterProcessor-812"><span class="linenos">812</span></a><span class="sd">        Cutoff distance for the filtering.</span>
</span><span id="GraphFilterProcessor-813"><a href="#GraphFilterProcessor-813"><span class="linenos">813</span></a><span class="sd">    graph_key : str</span>
</span><span id="GraphFilterProcessor-814"><a href="#GraphFilterProcessor-814"><span class="linenos">814</span></a><span class="sd">        Key of the filtered graph in the inputs.</span>
</span><span id="GraphFilterProcessor-815"><a href="#GraphFilterProcessor-815"><span class="linenos">815</span></a><span class="sd">    parent_graph : str</span>
</span><span id="GraphFilterProcessor-816"><a href="#GraphFilterProcessor-816"><span class="linenos">816</span></a><span class="sd">        Key of the parent graph in the inputs.</span>
</span><span id="GraphFilterProcessor-817"><a href="#GraphFilterProcessor-817"><span class="linenos">817</span></a><span class="sd">    switch_params : dict, default={}</span>
</span><span id="GraphFilterProcessor-818"><a href="#GraphFilterProcessor-818"><span class="linenos">818</span></a><span class="sd">        Parameters for the switching function.</span>
</span><span id="GraphFilterProcessor-819"><a href="#GraphFilterProcessor-819"><span class="linenos">819</span></a>
</span><span id="GraphFilterProcessor-820"><a href="#GraphFilterProcessor-820"><span class="linenos">820</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="GraphFilterProcessor-821"><a href="#GraphFilterProcessor-821"><span class="linenos">821</span></a>
</span><span id="GraphFilterProcessor-822"><a href="#GraphFilterProcessor-822"><span class="linenos">822</span></a>    <span class="n">cutoff</span><span class="p">:</span> <span class="nb">float</span>
</span><span id="GraphFilterProcessor-823"><a href="#GraphFilterProcessor-823"><span class="linenos">823</span></a>    <span class="n">graph_key</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="GraphFilterProcessor-824"><a href="#GraphFilterProcessor-824"><span class="linenos">824</span></a>    <span class="n">parent_graph</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="GraphFilterProcessor-825"><a href="#GraphFilterProcessor-825"><span class="linenos">825</span></a>    <span class="n">switch_params</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
</span><span id="GraphFilterProcessor-826"><a href="#GraphFilterProcessor-826"><span class="linenos">826</span></a>
</span><span id="GraphFilterProcessor-827"><a href="#GraphFilterProcessor-827"><span class="linenos">827</span></a>    <span class="nd">@nn</span><span class="o">.</span><span class="n">compact</span>
</span><span id="GraphFilterProcessor-828"><a href="#GraphFilterProcessor-828"><span class="linenos">828</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]]):</span>
</span><span id="GraphFilterProcessor-829"><a href="#GraphFilterProcessor-829"><span class="linenos">829</span></a>        <span class="n">graph_in</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_graph</span><span class="p">]</span>
</span><span id="GraphFilterProcessor-830"><a href="#GraphFilterProcessor-830"><span class="linenos">830</span></a>        <span class="n">graph</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">]</span>
</span><span id="GraphFilterProcessor-831"><a href="#GraphFilterProcessor-831"><span class="linenos">831</span></a>
</span><span id="GraphFilterProcessor-832"><a href="#GraphFilterProcessor-832"><span class="linenos">832</span></a>        <span class="k">if</span> <span class="n">graph_in</span><span class="p">[</span><span class="s2">&quot;vec&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="GraphFilterProcessor-833"><a href="#GraphFilterProcessor-833"><span class="linenos">833</span></a>            <span class="n">vec</span> <span class="o">=</span> <span class="n">graph_in</span><span class="p">[</span><span class="s2">&quot;vec&quot;</span><span class="p">]</span>
</span><span id="GraphFilterProcessor-834"><a href="#GraphFilterProcessor-834"><span class="linenos">834</span></a>            <span class="n">distances</span> <span class="o">=</span> <span class="n">graph_in</span><span class="p">[</span><span class="s2">&quot;distances&quot;</span><span class="p">]</span>
</span><span id="GraphFilterProcessor-835"><a href="#GraphFilterProcessor-835"><span class="linenos">835</span></a>            <span class="n">filter_indices</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="GraphFilterProcessor-836"><a href="#GraphFilterProcessor-836"><span class="linenos">836</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="GraphFilterProcessor-837"><a href="#GraphFilterProcessor-837"><span class="linenos">837</span></a>            <span class="n">filter_indices</span> <span class="o">=</span> <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;filter_indices&quot;</span><span class="p">]</span>
</span><span id="GraphFilterProcessor-838"><a href="#GraphFilterProcessor-838"><span class="linenos">838</span></a>            <span class="n">vec</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="GraphFilterProcessor-839"><a href="#GraphFilterProcessor-839"><span class="linenos">839</span></a>                <span class="n">graph_in</span><span class="p">[</span><span class="s2">&quot;vec&quot;</span><span class="p">]</span>
</span><span id="GraphFilterProcessor-840"><a href="#GraphFilterProcessor-840"><span class="linenos">840</span></a>                <span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">filter_indices</span><span class="p">]</span>
</span><span id="GraphFilterProcessor-841"><a href="#GraphFilterProcessor-841"><span class="linenos">841</span></a>                <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">)</span>
</span><span id="GraphFilterProcessor-842"><a href="#GraphFilterProcessor-842"><span class="linenos">842</span></a>            <span class="p">)</span>
</span><span id="GraphFilterProcessor-843"><a href="#GraphFilterProcessor-843"><span class="linenos">843</span></a>            <span class="n">distances</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="GraphFilterProcessor-844"><a href="#GraphFilterProcessor-844"><span class="linenos">844</span></a>                <span class="n">graph_in</span><span class="p">[</span><span class="s2">&quot;distances&quot;</span><span class="p">]</span>
</span><span id="GraphFilterProcessor-845"><a href="#GraphFilterProcessor-845"><span class="linenos">845</span></a>                <span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">filter_indices</span><span class="p">]</span>
</span><span id="GraphFilterProcessor-846"><a href="#GraphFilterProcessor-846"><span class="linenos">846</span></a>                <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">)</span>
</span><span id="GraphFilterProcessor-847"><a href="#GraphFilterProcessor-847"><span class="linenos">847</span></a>            <span class="p">)</span>
</span><span id="GraphFilterProcessor-848"><a href="#GraphFilterProcessor-848"><span class="linenos">848</span></a>
</span><span id="GraphFilterProcessor-849"><a href="#GraphFilterProcessor-849"><span class="linenos">849</span></a>        <span class="n">edge_mask</span> <span class="o">=</span> <span class="n">distances</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span>
</span><span id="GraphFilterProcessor-850"><a href="#GraphFilterProcessor-850"><span class="linenos">850</span></a>        <span class="n">switch</span> <span class="o">=</span> <span class="n">SwitchFunction</span><span class="p">(</span>
</span><span id="GraphFilterProcessor-851"><a href="#GraphFilterProcessor-851"><span class="linenos">851</span></a>            <span class="o">**</span><span class="p">{</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">switch_params</span><span class="p">,</span> <span class="s2">&quot;cutoff&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">,</span> <span class="s2">&quot;graph_key&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
</span><span id="GraphFilterProcessor-852"><a href="#GraphFilterProcessor-852"><span class="linenos">852</span></a>        <span class="p">)((</span><span class="n">distances</span><span class="p">,</span> <span class="n">edge_mask</span><span class="p">))</span>
</span><span id="GraphFilterProcessor-853"><a href="#GraphFilterProcessor-853"><span class="linenos">853</span></a>
</span><span id="GraphFilterProcessor-854"><a href="#GraphFilterProcessor-854"><span class="linenos">854</span></a>        <span class="n">graph_out</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="GraphFilterProcessor-855"><a href="#GraphFilterProcessor-855"><span class="linenos">855</span></a>            <span class="o">**</span><span class="n">graph</span><span class="p">,</span>
</span><span id="GraphFilterProcessor-856"><a href="#GraphFilterProcessor-856"><span class="linenos">856</span></a>            <span class="s2">&quot;vec&quot;</span><span class="p">:</span> <span class="n">vec</span><span class="p">,</span>
</span><span id="GraphFilterProcessor-857"><a href="#GraphFilterProcessor-857"><span class="linenos">857</span></a>            <span class="s2">&quot;distances&quot;</span><span class="p">:</span> <span class="n">distances</span><span class="p">,</span>
</span><span id="GraphFilterProcessor-858"><a href="#GraphFilterProcessor-858"><span class="linenos">858</span></a>            <span class="s2">&quot;switch&quot;</span><span class="p">:</span> <span class="n">switch</span><span class="p">,</span>
</span><span id="GraphFilterProcessor-859"><a href="#GraphFilterProcessor-859"><span class="linenos">859</span></a>            <span class="s2">&quot;filter_indices&quot;</span><span class="p">:</span> <span class="n">filter_indices</span><span class="p">,</span>
</span><span id="GraphFilterProcessor-860"><a href="#GraphFilterProcessor-860"><span class="linenos">860</span></a>            <span class="s2">&quot;edge_mask&quot;</span><span class="p">:</span> <span class="n">edge_mask</span><span class="p">,</span>
</span><span id="GraphFilterProcessor-861"><a href="#GraphFilterProcessor-861"><span class="linenos">861</span></a>        <span class="p">}</span>
</span><span id="GraphFilterProcessor-862"><a href="#GraphFilterProcessor-862"><span class="linenos">862</span></a>        <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">:</span> <span class="n">graph_out</span><span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>Filter processing for a pre-generated graph</p>

<p>This module is automatically added to a FENNIX model when a GraphFilter is used.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>cutoff</strong> (float):
Cutoff distance for the filtering.</li>
<li><strong>graph_key</strong> (str):
Key of the filtered graph in the inputs.</li>
<li><strong>parent_graph</strong> (str):
Key of the parent graph in the inputs.</li>
<li><strong>switch_params</strong> (dict, default={}):
Parameters for the switching function.</li>
</ul>
</div>


                            <div id="GraphFilterProcessor.__init__" class="classattr">
                                <div class="attr function">
            
        <span class="name">GraphFilterProcessor</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">cutoff</span><span class="p">:</span> <span class="nb">float</span>,</span><span class="param">	<span class="n">graph_key</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">parent_graph</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">switch_params</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">factory</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">parent</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">flax</span><span class="o">.</span><span class="n">linen</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">Module</span><span class="p">],</span> <span class="n">flax</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">Scope</span><span class="p">,</span> <span class="n">Type</span><span class="p">[</span><span class="n">flax</span><span class="o">.</span><span class="n">linen</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">_Sentinel</span><span class="p">],</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">flax</span><span class="o">.</span><span class="n">linen</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">_Sentinel</span> <span class="nb">object</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

        
    </div>
    <a class="headerlink" href="#GraphFilterProcessor.__init__"></a>
    
    

                            </div>
                            <div id="GraphFilterProcessor.cutoff" class="classattr">
                                <div class="attr variable">
            <span class="name">cutoff</span><span class="annotation">: float</span>

        
    </div>
    <a class="headerlink" href="#GraphFilterProcessor.cutoff"></a>
    
    

                            </div>
                            <div id="GraphFilterProcessor.graph_key" class="classattr">
                                <div class="attr variable">
            <span class="name">graph_key</span><span class="annotation">: str</span>

        
    </div>
    <a class="headerlink" href="#GraphFilterProcessor.graph_key"></a>
    
    

                            </div>
                            <div id="GraphFilterProcessor.parent_graph" class="classattr">
                                <div class="attr variable">
            <span class="name">parent_graph</span><span class="annotation">: str</span>

        
    </div>
    <a class="headerlink" href="#GraphFilterProcessor.parent_graph"></a>
    
    

                            </div>
                            <div id="GraphFilterProcessor.switch_params" class="classattr">
                                <div class="attr variable">
            <span class="name">switch_params</span><span class="annotation">: dict</span>

        
    </div>
    <a class="headerlink" href="#GraphFilterProcessor.switch_params"></a>
    
    

                            </div>
                            <div id="GraphFilterProcessor.parent" class="classattr">
                                <div class="attr variable">
            <span class="name">parent</span><span class="annotation">: Union[Type[flax.linen.module.Module], flax.core.scope.Scope, Type[flax.linen.module._Sentinel], NoneType]</span>

        
    </div>
    <a class="headerlink" href="#GraphFilterProcessor.parent"></a>
    
            <div class="docstring"><p>Wraps parent module references in weak refs.</p>

<p>This prevents reference cycles from forming via parent links which can lead
to accidental OOMs in eager mode due to slow garbage collection as well as
spurious tracer leaks during jit compilation.</p>

<p>Note: "descriptors" are the underlying python mechanism for implementing
dynamic @property decorators.  We need to use a raw descriptor instead of the
more common decorator in order to force that the appropriate getter/setter
logic applies in subclasses even after various dataclass transforms.</p>
</div>


                            </div>
                            <div id="GraphFilterProcessor.name" class="classattr">
                                <div class="attr variable">
            <span class="name">name</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#GraphFilterProcessor.name"></a>
    
    

                            </div>
                            <div id="GraphFilterProcessor.scope" class="classattr">
                                <div class="attr variable">
            <span class="name">scope</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#GraphFilterProcessor.scope"></a>
    
    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>flax.linen.module.Module</dt>
                                <dd id="GraphFilterProcessor.setup" class="function">setup</dd>
                <dd id="GraphFilterProcessor.path" class="variable">path</dd>
                <dd id="GraphFilterProcessor.clone" class="function">clone</dd>
                <dd id="GraphFilterProcessor.copy" class="function">copy</dd>
                <dd id="GraphFilterProcessor.variable" class="function">variable</dd>
                <dd id="GraphFilterProcessor.param" class="function">param</dd>
                <dd id="GraphFilterProcessor.has_variable" class="function">has_variable</dd>
                <dd id="GraphFilterProcessor.is_mutable_collection" class="function">is_mutable_collection</dd>
                <dd id="GraphFilterProcessor.has_rng" class="function">has_rng</dd>
                <dd id="GraphFilterProcessor.make_rng" class="function">make_rng</dd>
                <dd id="GraphFilterProcessor.is_initializing" class="function">is_initializing</dd>
                <dd id="GraphFilterProcessor.bind" class="function">bind</dd>
                <dd id="GraphFilterProcessor.unbind" class="function">unbind</dd>
                <dd id="GraphFilterProcessor.apply" class="function">apply</dd>
                <dd id="GraphFilterProcessor.init_with_output" class="function">init_with_output</dd>
                <dd id="GraphFilterProcessor.init" class="function">init</dd>
                <dd id="GraphFilterProcessor.lazy_init" class="function">lazy_init</dd>
                <dd id="GraphFilterProcessor.variables" class="variable">variables</dd>
                <dd id="GraphFilterProcessor.get_variable" class="function">get_variable</dd>
                <dd id="GraphFilterProcessor.put_variable" class="function">put_variable</dd>
                <dd id="GraphFilterProcessor.sow" class="function">sow</dd>
                <dd id="GraphFilterProcessor.perturb" class="function">perturb</dd>
                <dd id="GraphFilterProcessor.tabulate" class="function">tabulate</dd>
                <dd id="GraphFilterProcessor.module_paths" class="function">module_paths</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="GraphAngularExtension">
                            <input id="GraphAngularExtension-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
                    <div class="decorator">@dataclasses.dataclass(frozen=True)</div>

    <span class="def">class</span>
    <span class="name">GraphAngularExtension</span>:

                <label class="view-source-button" for="GraphAngularExtension-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GraphAngularExtension"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GraphAngularExtension-865"><a href="#GraphAngularExtension-865"><span class="linenos"> 865</span></a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="GraphAngularExtension-866"><a href="#GraphAngularExtension-866"><span class="linenos"> 866</span></a><span class="k">class</span> <span class="nc">GraphAngularExtension</span><span class="p">:</span>
</span><span id="GraphAngularExtension-867"><a href="#GraphAngularExtension-867"><span class="linenos"> 867</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Add angles list to a graph</span>
</span><span id="GraphAngularExtension-868"><a href="#GraphAngularExtension-868"><span class="linenos"> 868</span></a>
</span><span id="GraphAngularExtension-869"><a href="#GraphAngularExtension-869"><span class="linenos"> 869</span></a><span class="sd">    Parameters</span>
</span><span id="GraphAngularExtension-870"><a href="#GraphAngularExtension-870"><span class="linenos"> 870</span></a><span class="sd">    ----------</span>
</span><span id="GraphAngularExtension-871"><a href="#GraphAngularExtension-871"><span class="linenos"> 871</span></a><span class="sd">    mult_size : float, default=1.05</span>
</span><span id="GraphAngularExtension-872"><a href="#GraphAngularExtension-872"><span class="linenos"> 872</span></a><span class="sd">        Multiplicative factor for resizing the nblist.</span>
</span><span id="GraphAngularExtension-873"><a href="#GraphAngularExtension-873"><span class="linenos"> 873</span></a><span class="sd">    add_neigh : int, default=5</span>
</span><span id="GraphAngularExtension-874"><a href="#GraphAngularExtension-874"><span class="linenos"> 874</span></a><span class="sd">        Additional neighbors to add to the nblist when resizing.</span>
</span><span id="GraphAngularExtension-875"><a href="#GraphAngularExtension-875"><span class="linenos"> 875</span></a><span class="sd">    graph_key : str, default=&quot;graph&quot;</span>
</span><span id="GraphAngularExtension-876"><a href="#GraphAngularExtension-876"><span class="linenos"> 876</span></a><span class="sd">        Key of the graph in the inputs.</span>
</span><span id="GraphAngularExtension-877"><a href="#GraphAngularExtension-877"><span class="linenos"> 877</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="GraphAngularExtension-878"><a href="#GraphAngularExtension-878"><span class="linenos"> 878</span></a>
</span><span id="GraphAngularExtension-879"><a href="#GraphAngularExtension-879"><span class="linenos"> 879</span></a>    <span class="n">mult_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.05</span>
</span><span id="GraphAngularExtension-880"><a href="#GraphAngularExtension-880"><span class="linenos"> 880</span></a>    <span class="n">add_neigh</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span>
</span><span id="GraphAngularExtension-881"><a href="#GraphAngularExtension-881"><span class="linenos"> 881</span></a>    <span class="n">graph_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;graph&quot;</span>
</span><span id="GraphAngularExtension-882"><a href="#GraphAngularExtension-882"><span class="linenos"> 882</span></a>
</span><span id="GraphAngularExtension-883"><a href="#GraphAngularExtension-883"><span class="linenos"> 883</span></a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="GraphAngularExtension-884"><a href="#GraphAngularExtension-884"><span class="linenos"> 884</span></a>        <span class="k">return</span> <span class="n">FrozenDict</span><span class="p">(</span>
</span><span id="GraphAngularExtension-885"><a href="#GraphAngularExtension-885"><span class="linenos"> 885</span></a>            <span class="p">{</span>
</span><span id="GraphAngularExtension-886"><a href="#GraphAngularExtension-886"><span class="linenos"> 886</span></a>                <span class="s2">&quot;nangles&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="GraphAngularExtension-887"><a href="#GraphAngularExtension-887"><span class="linenos"> 887</span></a>                <span class="s2">&quot;nblist_mult_size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mult_size</span><span class="p">,</span>
</span><span id="GraphAngularExtension-888"><a href="#GraphAngularExtension-888"><span class="linenos"> 888</span></a>                <span class="s2">&quot;max_neigh&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_neigh</span><span class="p">,</span>
</span><span id="GraphAngularExtension-889"><a href="#GraphAngularExtension-889"><span class="linenos"> 889</span></a>                <span class="s2">&quot;add_neigh&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_neigh</span><span class="p">,</span>
</span><span id="GraphAngularExtension-890"><a href="#GraphAngularExtension-890"><span class="linenos"> 890</span></a>            <span class="p">}</span>
</span><span id="GraphAngularExtension-891"><a href="#GraphAngularExtension-891"><span class="linenos"> 891</span></a>        <span class="p">)</span>
</span><span id="GraphAngularExtension-892"><a href="#GraphAngularExtension-892"><span class="linenos"> 892</span></a>
</span><span id="GraphAngularExtension-893"><a href="#GraphAngularExtension-893"><span class="linenos"> 893</span></a>    <span class="k">def</span> <span class="nf">get_processor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]:</span>
</span><span id="GraphAngularExtension-894"><a href="#GraphAngularExtension-894"><span class="linenos"> 894</span></a>        <span class="k">return</span> <span class="n">GraphAngleProcessor</span><span class="p">,</span> <span class="p">{</span>
</span><span id="GraphAngularExtension-895"><a href="#GraphAngularExtension-895"><span class="linenos"> 895</span></a>            <span class="s2">&quot;graph_key&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">,</span>
</span><span id="GraphAngularExtension-896"><a href="#GraphAngularExtension-896"><span class="linenos"> 896</span></a>            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="si">}</span><span class="s2">_AngleProcessor&quot;</span><span class="p">,</span>
</span><span id="GraphAngularExtension-897"><a href="#GraphAngularExtension-897"><span class="linenos"> 897</span></a>        <span class="p">}</span>
</span><span id="GraphAngularExtension-898"><a href="#GraphAngularExtension-898"><span class="linenos"> 898</span></a>
</span><span id="GraphAngularExtension-899"><a href="#GraphAngularExtension-899"><span class="linenos"> 899</span></a>    <span class="k">def</span> <span class="nf">get_graph_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="GraphAngularExtension-900"><a href="#GraphAngularExtension-900"><span class="linenos"> 900</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="GraphAngularExtension-901"><a href="#GraphAngularExtension-901"><span class="linenos"> 901</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">:</span> <span class="p">{</span>
</span><span id="GraphAngularExtension-902"><a href="#GraphAngularExtension-902"><span class="linenos"> 902</span></a>                <span class="s2">&quot;has_angles&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="GraphAngularExtension-903"><a href="#GraphAngularExtension-903"><span class="linenos"> 903</span></a>            <span class="p">}</span>
</span><span id="GraphAngularExtension-904"><a href="#GraphAngularExtension-904"><span class="linenos"> 904</span></a>        <span class="p">}</span>
</span><span id="GraphAngularExtension-905"><a href="#GraphAngularExtension-905"><span class="linenos"> 905</span></a>
</span><span id="GraphAngularExtension-906"><a href="#GraphAngularExtension-906"><span class="linenos"> 906</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">return_state_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_margin</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="GraphAngularExtension-907"><a href="#GraphAngularExtension-907"><span class="linenos"> 907</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;build angle nblist on cpu with numpy and dynamic shapes + store max shapes&quot;&quot;&quot;</span>
</span><span id="GraphAngularExtension-908"><a href="#GraphAngularExtension-908"><span class="linenos"> 908</span></a>        <span class="n">graph</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">]</span>
</span><span id="GraphAngularExtension-909"><a href="#GraphAngularExtension-909"><span class="linenos"> 909</span></a>        <span class="n">edge_src</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">graph</span><span class="p">[</span><span class="s2">&quot;edge_src&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="GraphAngularExtension-910"><a href="#GraphAngularExtension-910"><span class="linenos"> 910</span></a>
</span><span id="GraphAngularExtension-911"><a href="#GraphAngularExtension-911"><span class="linenos"> 911</span></a>        <span class="n">new_state</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">state</span><span class="p">}</span>
</span><span id="GraphAngularExtension-912"><a href="#GraphAngularExtension-912"><span class="linenos"> 912</span></a>        <span class="n">state_up</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="GraphAngularExtension-913"><a href="#GraphAngularExtension-913"><span class="linenos"> 913</span></a>
</span><span id="GraphAngularExtension-914"><a href="#GraphAngularExtension-914"><span class="linenos"> 914</span></a>        <span class="c1">### count number of neighbors</span>
</span><span id="GraphAngularExtension-915"><a href="#GraphAngularExtension-915"><span class="linenos"> 915</span></a>        <span class="n">nat</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="GraphAngularExtension-916"><a href="#GraphAngularExtension-916"><span class="linenos"> 916</span></a>        <span class="n">count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nat</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="GraphAngularExtension-917"><a href="#GraphAngularExtension-917"><span class="linenos"> 917</span></a>        <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">edge_src</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="GraphAngularExtension-918"><a href="#GraphAngularExtension-918"><span class="linenos"> 918</span></a>        <span class="n">max_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">count</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="GraphAngularExtension-919"><a href="#GraphAngularExtension-919"><span class="linenos"> 919</span></a>
</span><span id="GraphAngularExtension-920"><a href="#GraphAngularExtension-920"><span class="linenos"> 920</span></a>        <span class="c1">### get sizes</span>
</span><span id="GraphAngularExtension-921"><a href="#GraphAngularExtension-921"><span class="linenos"> 921</span></a>        <span class="n">max_neigh</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_neigh&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_neigh</span><span class="p">)</span>
</span><span id="GraphAngularExtension-922"><a href="#GraphAngularExtension-922"><span class="linenos"> 922</span></a>        <span class="n">nedge</span> <span class="o">=</span> <span class="n">edge_src</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="GraphAngularExtension-923"><a href="#GraphAngularExtension-923"><span class="linenos"> 923</span></a>        <span class="k">if</span> <span class="n">max_count</span> <span class="o">&gt;</span> <span class="n">max_neigh</span> <span class="ow">or</span> <span class="n">add_margin</span><span class="p">:</span>
</span><span id="GraphAngularExtension-924"><a href="#GraphAngularExtension-924"><span class="linenos"> 924</span></a>            <span class="n">prev_max_neigh</span> <span class="o">=</span> <span class="n">max_neigh</span>
</span><span id="GraphAngularExtension-925"><a href="#GraphAngularExtension-925"><span class="linenos"> 925</span></a>            <span class="n">max_neigh</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_count</span><span class="p">,</span> <span class="n">max_neigh</span><span class="p">)</span> <span class="o">+</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span id="GraphAngularExtension-926"><a href="#GraphAngularExtension-926"><span class="linenos"> 926</span></a>                <span class="s2">&quot;add_neigh&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_neigh</span>
</span><span id="GraphAngularExtension-927"><a href="#GraphAngularExtension-927"><span class="linenos"> 927</span></a>            <span class="p">)</span>
</span><span id="GraphAngularExtension-928"><a href="#GraphAngularExtension-928"><span class="linenos"> 928</span></a>            <span class="n">state_up</span><span class="p">[</span><span class="s2">&quot;max_neigh&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_neigh</span><span class="p">,</span> <span class="n">prev_max_neigh</span><span class="p">)</span>
</span><span id="GraphAngularExtension-929"><a href="#GraphAngularExtension-929"><span class="linenos"> 929</span></a>            <span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;max_neigh&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_neigh</span>
</span><span id="GraphAngularExtension-930"><a href="#GraphAngularExtension-930"><span class="linenos"> 930</span></a>
</span><span id="GraphAngularExtension-931"><a href="#GraphAngularExtension-931"><span class="linenos"> 931</span></a>        <span class="n">max_neigh_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">max_neigh</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
</span><span id="GraphAngularExtension-932"><a href="#GraphAngularExtension-932"><span class="linenos"> 932</span></a>
</span><span id="GraphAngularExtension-933"><a href="#GraphAngularExtension-933"><span class="linenos"> 933</span></a>        <span class="n">nedge</span> <span class="o">=</span> <span class="n">edge_src</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="GraphAngularExtension-934"><a href="#GraphAngularExtension-934"><span class="linenos"> 934</span></a>
</span><span id="GraphAngularExtension-935"><a href="#GraphAngularExtension-935"><span class="linenos"> 935</span></a>        <span class="c1">### sort edge_src</span>
</span><span id="GraphAngularExtension-936"><a href="#GraphAngularExtension-936"><span class="linenos"> 936</span></a>        <span class="n">idx_sort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">edge_src</span><span class="p">)</span>
</span><span id="GraphAngularExtension-937"><a href="#GraphAngularExtension-937"><span class="linenos"> 937</span></a>        <span class="n">edge_src_sorted</span> <span class="o">=</span> <span class="n">edge_src</span><span class="p">[</span><span class="n">idx_sort</span><span class="p">]</span>
</span><span id="GraphAngularExtension-938"><a href="#GraphAngularExtension-938"><span class="linenos"> 938</span></a>
</span><span id="GraphAngularExtension-939"><a href="#GraphAngularExtension-939"><span class="linenos"> 939</span></a>        <span class="c1">### map sparse to dense nblist</span>
</span><span id="GraphAngularExtension-940"><a href="#GraphAngularExtension-940"><span class="linenos"> 940</span></a>        <span class="n">offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">max_count</span><span class="p">),</span> <span class="n">nat</span><span class="p">)</span>
</span><span id="GraphAngularExtension-941"><a href="#GraphAngularExtension-941"><span class="linenos"> 941</span></a>        <span class="k">if</span> <span class="n">max_count</span> <span class="o">*</span> <span class="n">nat</span> <span class="o">&gt;=</span> <span class="n">nedge</span><span class="p">:</span>
</span><span id="GraphAngularExtension-942"><a href="#GraphAngularExtension-942"><span class="linenos"> 942</span></a>            <span class="n">offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">max_count</span><span class="p">),</span> <span class="n">nat</span><span class="p">)[:</span><span class="n">nedge</span><span class="p">]</span>
</span><span id="GraphAngularExtension-943"><a href="#GraphAngularExtension-943"><span class="linenos"> 943</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="GraphAngularExtension-944"><a href="#GraphAngularExtension-944"><span class="linenos"> 944</span></a>            <span class="n">offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nedge</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="GraphAngularExtension-945"><a href="#GraphAngularExtension-945"><span class="linenos"> 945</span></a>            <span class="n">offset</span><span class="p">[:</span> <span class="n">max_count</span> <span class="o">*</span> <span class="n">nat</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">max_count</span><span class="p">),</span> <span class="n">nat</span><span class="p">)</span>
</span><span id="GraphAngularExtension-946"><a href="#GraphAngularExtension-946"><span class="linenos"> 946</span></a>
</span><span id="GraphAngularExtension-947"><a href="#GraphAngularExtension-947"><span class="linenos"> 947</span></a>        <span class="c1"># offset = jnp.where(edge_src_sorted &lt; nat, offset, 0)</span>
</span><span id="GraphAngularExtension-948"><a href="#GraphAngularExtension-948"><span class="linenos"> 948</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">edge_src_sorted</span> <span class="o">&lt;</span> <span class="n">nat</span>
</span><span id="GraphAngularExtension-949"><a href="#GraphAngularExtension-949"><span class="linenos"> 949</span></a>        <span class="n">indices</span> <span class="o">=</span> <span class="n">edge_src_sorted</span> <span class="o">*</span> <span class="n">max_count</span> <span class="o">+</span> <span class="n">offset</span>
</span><span id="GraphAngularExtension-950"><a href="#GraphAngularExtension-950"><span class="linenos"> 950</span></a>        <span class="n">indices</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
</span><span id="GraphAngularExtension-951"><a href="#GraphAngularExtension-951"><span class="linenos"> 951</span></a>        <span class="n">idx_sort</span> <span class="o">=</span> <span class="n">idx_sort</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
</span><span id="GraphAngularExtension-952"><a href="#GraphAngularExtension-952"><span class="linenos"> 952</span></a>        <span class="n">edge_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">nat</span> <span class="o">*</span> <span class="n">max_count</span><span class="p">,</span> <span class="n">nedge</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="GraphAngularExtension-953"><a href="#GraphAngularExtension-953"><span class="linenos"> 953</span></a>        <span class="n">edge_idx</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx_sort</span>
</span><span id="GraphAngularExtension-954"><a href="#GraphAngularExtension-954"><span class="linenos"> 954</span></a>        <span class="n">edge_idx</span> <span class="o">=</span> <span class="n">edge_idx</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nat</span><span class="p">,</span> <span class="n">max_count</span><span class="p">)</span>
</span><span id="GraphAngularExtension-955"><a href="#GraphAngularExtension-955"><span class="linenos"> 955</span></a>
</span><span id="GraphAngularExtension-956"><a href="#GraphAngularExtension-956"><span class="linenos"> 956</span></a>        <span class="c1">### find all triplet for each atom center</span>
</span><span id="GraphAngularExtension-957"><a href="#GraphAngularExtension-957"><span class="linenos"> 957</span></a>        <span class="n">local_src</span><span class="p">,</span> <span class="n">local_dst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">triu_indices</span><span class="p">(</span><span class="n">max_count</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="GraphAngularExtension-958"><a href="#GraphAngularExtension-958"><span class="linenos"> 958</span></a>        <span class="n">angle_src</span> <span class="o">=</span> <span class="n">edge_idx</span><span class="p">[:,</span> <span class="n">local_src</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="GraphAngularExtension-959"><a href="#GraphAngularExtension-959"><span class="linenos"> 959</span></a>        <span class="n">angle_dst</span> <span class="o">=</span> <span class="n">edge_idx</span><span class="p">[:,</span> <span class="n">local_dst</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="GraphAngularExtension-960"><a href="#GraphAngularExtension-960"><span class="linenos"> 960</span></a>
</span><span id="GraphAngularExtension-961"><a href="#GraphAngularExtension-961"><span class="linenos"> 961</span></a>        <span class="c1">### mask for valid angles</span>
</span><span id="GraphAngularExtension-962"><a href="#GraphAngularExtension-962"><span class="linenos"> 962</span></a>        <span class="n">mask1</span> <span class="o">=</span> <span class="n">angle_src</span> <span class="o">&lt;</span> <span class="n">nedge</span>
</span><span id="GraphAngularExtension-963"><a href="#GraphAngularExtension-963"><span class="linenos"> 963</span></a>        <span class="n">mask2</span> <span class="o">=</span> <span class="n">angle_dst</span> <span class="o">&lt;</span> <span class="n">nedge</span>
</span><span id="GraphAngularExtension-964"><a href="#GraphAngularExtension-964"><span class="linenos"> 964</span></a>        <span class="n">angle_mask</span> <span class="o">=</span> <span class="n">mask1</span> <span class="o">&amp;</span> <span class="n">mask2</span>
</span><span id="GraphAngularExtension-965"><a href="#GraphAngularExtension-965"><span class="linenos"> 965</span></a>
</span><span id="GraphAngularExtension-966"><a href="#GraphAngularExtension-966"><span class="linenos"> 966</span></a>        <span class="n">max_angles</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nangles&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="GraphAngularExtension-967"><a href="#GraphAngularExtension-967"><span class="linenos"> 967</span></a>        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">angle_mask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="GraphAngularExtension-968"><a href="#GraphAngularExtension-968"><span class="linenos"> 968</span></a>        <span class="n">nangles</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="GraphAngularExtension-969"><a href="#GraphAngularExtension-969"><span class="linenos"> 969</span></a>        <span class="k">if</span> <span class="n">nangles</span> <span class="o">&gt;</span> <span class="n">max_angles</span> <span class="ow">or</span> <span class="n">add_margin</span><span class="p">:</span>
</span><span id="GraphAngularExtension-970"><a href="#GraphAngularExtension-970"><span class="linenos"> 970</span></a>            <span class="n">mult_size</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nblist_mult_size&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mult_size</span><span class="p">)</span>
</span><span id="GraphAngularExtension-971"><a href="#GraphAngularExtension-971"><span class="linenos"> 971</span></a>            <span class="n">max_angles_prev</span> <span class="o">=</span> <span class="n">max_angles</span>
</span><span id="GraphAngularExtension-972"><a href="#GraphAngularExtension-972"><span class="linenos"> 972</span></a>            <span class="n">max_angles</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mult_size</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">nangles</span><span class="p">,</span> <span class="n">max_angles</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="GraphAngularExtension-973"><a href="#GraphAngularExtension-973"><span class="linenos"> 973</span></a>            <span class="n">state_up</span><span class="p">[</span><span class="s2">&quot;nangles&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_angles</span><span class="p">,</span> <span class="n">max_angles_prev</span><span class="p">)</span>
</span><span id="GraphAngularExtension-974"><a href="#GraphAngularExtension-974"><span class="linenos"> 974</span></a>            <span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;nangles&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_angles</span>
</span><span id="GraphAngularExtension-975"><a href="#GraphAngularExtension-975"><span class="linenos"> 975</span></a>
</span><span id="GraphAngularExtension-976"><a href="#GraphAngularExtension-976"><span class="linenos"> 976</span></a>        <span class="c1">## filter angles to sparse representation</span>
</span><span id="GraphAngularExtension-977"><a href="#GraphAngularExtension-977"><span class="linenos"> 977</span></a>        <span class="n">angle_src_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">max_angles</span><span class="p">,</span> <span class="n">nedge</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="GraphAngularExtension-978"><a href="#GraphAngularExtension-978"><span class="linenos"> 978</span></a>        <span class="n">angle_dst_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">max_angles</span><span class="p">,</span> <span class="n">nedge</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="GraphAngularExtension-979"><a href="#GraphAngularExtension-979"><span class="linenos"> 979</span></a>        <span class="n">angle_src_</span><span class="p">[:</span><span class="n">nangles</span><span class="p">]</span> <span class="o">=</span> <span class="n">angle_src</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="GraphAngularExtension-980"><a href="#GraphAngularExtension-980"><span class="linenos"> 980</span></a>        <span class="n">angle_dst_</span><span class="p">[:</span><span class="n">nangles</span><span class="p">]</span> <span class="o">=</span> <span class="n">angle_dst</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="GraphAngularExtension-981"><a href="#GraphAngularExtension-981"><span class="linenos"> 981</span></a>
</span><span id="GraphAngularExtension-982"><a href="#GraphAngularExtension-982"><span class="linenos"> 982</span></a>        <span class="n">central_atom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">max_angles</span><span class="p">,</span> <span class="n">nat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="GraphAngularExtension-983"><a href="#GraphAngularExtension-983"><span class="linenos"> 983</span></a>        <span class="n">central_atom</span><span class="p">[:</span><span class="n">nangles</span><span class="p">]</span> <span class="o">=</span> <span class="n">edge_src</span><span class="p">[</span><span class="n">angle_src_</span><span class="p">[:</span><span class="n">nangles</span><span class="p">]]</span>
</span><span id="GraphAngularExtension-984"><a href="#GraphAngularExtension-984"><span class="linenos"> 984</span></a>
</span><span id="GraphAngularExtension-985"><a href="#GraphAngularExtension-985"><span class="linenos"> 985</span></a>        <span class="c1">## update graph</span>
</span><span id="GraphAngularExtension-986"><a href="#GraphAngularExtension-986"><span class="linenos"> 986</span></a>        <span class="n">output</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="GraphAngularExtension-987"><a href="#GraphAngularExtension-987"><span class="linenos"> 987</span></a>            <span class="o">**</span><span class="n">inputs</span><span class="p">,</span>
</span><span id="GraphAngularExtension-988"><a href="#GraphAngularExtension-988"><span class="linenos"> 988</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">:</span> <span class="p">{</span>
</span><span id="GraphAngularExtension-989"><a href="#GraphAngularExtension-989"><span class="linenos"> 989</span></a>                <span class="o">**</span><span class="n">graph</span><span class="p">,</span>
</span><span id="GraphAngularExtension-990"><a href="#GraphAngularExtension-990"><span class="linenos"> 990</span></a>                <span class="s2">&quot;angle_src&quot;</span><span class="p">:</span> <span class="n">angle_src_</span><span class="p">,</span>
</span><span id="GraphAngularExtension-991"><a href="#GraphAngularExtension-991"><span class="linenos"> 991</span></a>                <span class="s2">&quot;angle_dst&quot;</span><span class="p">:</span> <span class="n">angle_dst_</span><span class="p">,</span>
</span><span id="GraphAngularExtension-992"><a href="#GraphAngularExtension-992"><span class="linenos"> 992</span></a>                <span class="s2">&quot;central_atom&quot;</span><span class="p">:</span> <span class="n">central_atom</span><span class="p">,</span>
</span><span id="GraphAngularExtension-993"><a href="#GraphAngularExtension-993"><span class="linenos"> 993</span></a>                <span class="s2">&quot;angle_overflow&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="GraphAngularExtension-994"><a href="#GraphAngularExtension-994"><span class="linenos"> 994</span></a>                <span class="s2">&quot;max_neigh&quot;</span><span class="p">:</span> <span class="n">max_neigh</span><span class="p">,</span>
</span><span id="GraphAngularExtension-995"><a href="#GraphAngularExtension-995"><span class="linenos"> 995</span></a>                <span class="s2">&quot;__max_neigh_array&quot;</span><span class="p">:</span> <span class="n">max_neigh_arr</span><span class="p">,</span>
</span><span id="GraphAngularExtension-996"><a href="#GraphAngularExtension-996"><span class="linenos"> 996</span></a>            <span class="p">},</span>
</span><span id="GraphAngularExtension-997"><a href="#GraphAngularExtension-997"><span class="linenos"> 997</span></a>        <span class="p">}</span>
</span><span id="GraphAngularExtension-998"><a href="#GraphAngularExtension-998"><span class="linenos"> 998</span></a>
</span><span id="GraphAngularExtension-999"><a href="#GraphAngularExtension-999"><span class="linenos"> 999</span></a>        <span class="k">if</span> <span class="n">return_state_update</span><span class="p">:</span>
</span><span id="GraphAngularExtension-1000"><a href="#GraphAngularExtension-1000"><span class="linenos">1000</span></a>            <span class="k">return</span> <span class="n">FrozenDict</span><span class="p">(</span><span class="n">new_state</span><span class="p">),</span> <span class="n">output</span><span class="p">,</span> <span class="n">state_up</span>
</span><span id="GraphAngularExtension-1001"><a href="#GraphAngularExtension-1001"><span class="linenos">1001</span></a>        <span class="k">return</span> <span class="n">FrozenDict</span><span class="p">(</span><span class="n">new_state</span><span class="p">),</span> <span class="n">output</span>
</span><span id="GraphAngularExtension-1002"><a href="#GraphAngularExtension-1002"><span class="linenos">1002</span></a>
</span><span id="GraphAngularExtension-1003"><a href="#GraphAngularExtension-1003"><span class="linenos">1003</span></a>    <span class="k">def</span> <span class="nf">check_reallocate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">parent_overflow</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="GraphAngularExtension-1004"><a href="#GraphAngularExtension-1004"><span class="linenos">1004</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;check for overflow and reallocate nblist if necessary&quot;&quot;&quot;</span>
</span><span id="GraphAngularExtension-1005"><a href="#GraphAngularExtension-1005"><span class="linenos">1005</span></a>        <span class="n">overflow</span> <span class="o">=</span> <span class="n">parent_overflow</span> <span class="ow">or</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">][</span><span class="s2">&quot;angle_overflow&quot;</span><span class="p">]</span>
</span><span id="GraphAngularExtension-1006"><a href="#GraphAngularExtension-1006"><span class="linenos">1006</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">overflow</span><span class="p">:</span>
</span><span id="GraphAngularExtension-1007"><a href="#GraphAngularExtension-1007"><span class="linenos">1007</span></a>            <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="p">{},</span> <span class="n">inputs</span><span class="p">,</span> <span class="kc">False</span>
</span><span id="GraphAngularExtension-1008"><a href="#GraphAngularExtension-1008"><span class="linenos">1008</span></a>
</span><span id="GraphAngularExtension-1009"><a href="#GraphAngularExtension-1009"><span class="linenos">1009</span></a>        <span class="n">add_margin</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">][</span><span class="s2">&quot;angle_overflow&quot;</span><span class="p">]</span>
</span><span id="GraphAngularExtension-1010"><a href="#GraphAngularExtension-1010"><span class="linenos">1010</span></a>        <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">state_up</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span>
</span><span id="GraphAngularExtension-1011"><a href="#GraphAngularExtension-1011"><span class="linenos">1011</span></a>            <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">return_state_update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">add_margin</span><span class="o">=</span><span class="n">add_margin</span>
</span><span id="GraphAngularExtension-1012"><a href="#GraphAngularExtension-1012"><span class="linenos">1012</span></a>        <span class="p">)</span>
</span><span id="GraphAngularExtension-1013"><a href="#GraphAngularExtension-1013"><span class="linenos">1013</span></a>        <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="n">state_up</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="kc">True</span>
</span><span id="GraphAngularExtension-1014"><a href="#GraphAngularExtension-1014"><span class="linenos">1014</span></a>
</span><span id="GraphAngularExtension-1015"><a href="#GraphAngularExtension-1015"><span class="linenos">1015</span></a>    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="GraphAngularExtension-1016"><a href="#GraphAngularExtension-1016"><span class="linenos">1016</span></a>    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
</span><span id="GraphAngularExtension-1017"><a href="#GraphAngularExtension-1017"><span class="linenos">1017</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;build angle nblist on accelerator with jax and precomputed shapes&quot;&quot;&quot;</span>
</span><span id="GraphAngularExtension-1018"><a href="#GraphAngularExtension-1018"><span class="linenos">1018</span></a>        <span class="n">graph</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">]</span>
</span><span id="GraphAngularExtension-1019"><a href="#GraphAngularExtension-1019"><span class="linenos">1019</span></a>        <span class="n">edge_src</span> <span class="o">=</span> <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;edge_src&quot;</span><span class="p">]</span>
</span><span id="GraphAngularExtension-1020"><a href="#GraphAngularExtension-1020"><span class="linenos">1020</span></a>
</span><span id="GraphAngularExtension-1021"><a href="#GraphAngularExtension-1021"><span class="linenos">1021</span></a>        <span class="c1">### count number of neighbors</span>
</span><span id="GraphAngularExtension-1022"><a href="#GraphAngularExtension-1022"><span class="linenos">1022</span></a>        <span class="n">nat</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="GraphAngularExtension-1023"><a href="#GraphAngularExtension-1023"><span class="linenos">1023</span></a>        <span class="n">count</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">edge_src</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;drop&quot;</span><span class="p">)</span>
</span><span id="GraphAngularExtension-1024"><a href="#GraphAngularExtension-1024"><span class="linenos">1024</span></a>        <span class="n">max_count</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
</span><span id="GraphAngularExtension-1025"><a href="#GraphAngularExtension-1025"><span class="linenos">1025</span></a>
</span><span id="GraphAngularExtension-1026"><a href="#GraphAngularExtension-1026"><span class="linenos">1026</span></a>        <span class="c1">### get sizes</span>
</span><span id="GraphAngularExtension-1027"><a href="#GraphAngularExtension-1027"><span class="linenos">1027</span></a>        <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="GraphAngularExtension-1028"><a href="#GraphAngularExtension-1028"><span class="linenos">1028</span></a>            <span class="n">max_neigh_arr</span> <span class="o">=</span> <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;__max_neigh_array&quot;</span><span class="p">]</span>
</span><span id="GraphAngularExtension-1029"><a href="#GraphAngularExtension-1029"><span class="linenos">1029</span></a>            <span class="n">max_neigh</span> <span class="o">=</span> <span class="n">max_neigh_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="GraphAngularExtension-1030"><a href="#GraphAngularExtension-1030"><span class="linenos">1030</span></a>            <span class="n">prev_nangles</span> <span class="o">=</span> <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;angle_src&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="GraphAngularExtension-1031"><a href="#GraphAngularExtension-1031"><span class="linenos">1031</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="GraphAngularExtension-1032"><a href="#GraphAngularExtension-1032"><span class="linenos">1032</span></a>            <span class="n">max_neigh</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_neigh&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_neigh</span><span class="p">)</span>
</span><span id="GraphAngularExtension-1033"><a href="#GraphAngularExtension-1033"><span class="linenos">1033</span></a>            <span class="n">max_neigh_arr</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">max_neigh</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
</span><span id="GraphAngularExtension-1034"><a href="#GraphAngularExtension-1034"><span class="linenos">1034</span></a>            <span class="n">prev_nangles</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nangles&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="GraphAngularExtension-1035"><a href="#GraphAngularExtension-1035"><span class="linenos">1035</span></a>
</span><span id="GraphAngularExtension-1036"><a href="#GraphAngularExtension-1036"><span class="linenos">1036</span></a>        <span class="n">nedge</span> <span class="o">=</span> <span class="n">edge_src</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="GraphAngularExtension-1037"><a href="#GraphAngularExtension-1037"><span class="linenos">1037</span></a>
</span><span id="GraphAngularExtension-1038"><a href="#GraphAngularExtension-1038"><span class="linenos">1038</span></a>        <span class="c1">### sort edge_src</span>
</span><span id="GraphAngularExtension-1039"><a href="#GraphAngularExtension-1039"><span class="linenos">1039</span></a>        <span class="n">idx_sort</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">edge_src</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="GraphAngularExtension-1040"><a href="#GraphAngularExtension-1040"><span class="linenos">1040</span></a>        <span class="n">edge_src_sorted</span> <span class="o">=</span> <span class="n">edge_src</span><span class="p">[</span><span class="n">idx_sort</span><span class="p">]</span>
</span><span id="GraphAngularExtension-1041"><a href="#GraphAngularExtension-1041"><span class="linenos">1041</span></a>
</span><span id="GraphAngularExtension-1042"><a href="#GraphAngularExtension-1042"><span class="linenos">1042</span></a>        <span class="c1">### map sparse to dense nblist</span>
</span><span id="GraphAngularExtension-1043"><a href="#GraphAngularExtension-1043"><span class="linenos">1043</span></a>        <span class="k">if</span> <span class="n">max_neigh</span> <span class="o">*</span> <span class="n">nat</span> <span class="o">&lt;</span> <span class="n">nedge</span><span class="p">:</span>
</span><span id="GraphAngularExtension-1044"><a href="#GraphAngularExtension-1044"><span class="linenos">1044</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Found max_neigh*nat &lt; nedge. This should not happen.&quot;</span><span class="p">)</span>
</span><span id="GraphAngularExtension-1045"><a href="#GraphAngularExtension-1045"><span class="linenos">1045</span></a>        <span class="n">offset</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">max_neigh</span><span class="p">),</span> <span class="n">nat</span><span class="p">)[:</span><span class="n">nedge</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="GraphAngularExtension-1046"><a href="#GraphAngularExtension-1046"><span class="linenos">1046</span></a>        <span class="c1"># offset = jnp.where(edge_src_sorted &lt; nat, offset, 0)</span>
</span><span id="GraphAngularExtension-1047"><a href="#GraphAngularExtension-1047"><span class="linenos">1047</span></a>        <span class="n">indices</span> <span class="o">=</span> <span class="n">edge_src_sorted</span> <span class="o">*</span> <span class="n">max_neigh</span> <span class="o">+</span> <span class="n">offset</span>
</span><span id="GraphAngularExtension-1048"><a href="#GraphAngularExtension-1048"><span class="linenos">1048</span></a>        <span class="n">edge_idx</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="GraphAngularExtension-1049"><a href="#GraphAngularExtension-1049"><span class="linenos">1049</span></a>            <span class="n">jnp</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">nat</span> <span class="o">*</span> <span class="n">max_neigh</span><span class="p">,</span> <span class="n">nedge</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="GraphAngularExtension-1050"><a href="#GraphAngularExtension-1050"><span class="linenos">1050</span></a>            <span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
</span><span id="GraphAngularExtension-1051"><a href="#GraphAngularExtension-1051"><span class="linenos">1051</span></a>            <span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">idx_sort</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;drop&quot;</span><span class="p">)</span>
</span><span id="GraphAngularExtension-1052"><a href="#GraphAngularExtension-1052"><span class="linenos">1052</span></a>            <span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nat</span><span class="p">,</span> <span class="n">max_neigh</span><span class="p">)</span>
</span><span id="GraphAngularExtension-1053"><a href="#GraphAngularExtension-1053"><span class="linenos">1053</span></a>        <span class="p">)</span>
</span><span id="GraphAngularExtension-1054"><a href="#GraphAngularExtension-1054"><span class="linenos">1054</span></a>
</span><span id="GraphAngularExtension-1055"><a href="#GraphAngularExtension-1055"><span class="linenos">1055</span></a>        <span class="c1">### find all triplet for each atom center</span>
</span><span id="GraphAngularExtension-1056"><a href="#GraphAngularExtension-1056"><span class="linenos">1056</span></a>        <span class="n">local_src</span><span class="p">,</span> <span class="n">local_dst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">triu_indices</span><span class="p">(</span><span class="n">max_neigh</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="GraphAngularExtension-1057"><a href="#GraphAngularExtension-1057"><span class="linenos">1057</span></a>        <span class="n">angle_src</span> <span class="o">=</span> <span class="n">edge_idx</span><span class="p">[:,</span> <span class="n">local_src</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="GraphAngularExtension-1058"><a href="#GraphAngularExtension-1058"><span class="linenos">1058</span></a>        <span class="n">angle_dst</span> <span class="o">=</span> <span class="n">edge_idx</span><span class="p">[:,</span> <span class="n">local_dst</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="GraphAngularExtension-1059"><a href="#GraphAngularExtension-1059"><span class="linenos">1059</span></a>
</span><span id="GraphAngularExtension-1060"><a href="#GraphAngularExtension-1060"><span class="linenos">1060</span></a>        <span class="c1">### mask for valid angles</span>
</span><span id="GraphAngularExtension-1061"><a href="#GraphAngularExtension-1061"><span class="linenos">1061</span></a>        <span class="n">mask1</span> <span class="o">=</span> <span class="n">angle_src</span> <span class="o">&lt;</span> <span class="n">nedge</span>
</span><span id="GraphAngularExtension-1062"><a href="#GraphAngularExtension-1062"><span class="linenos">1062</span></a>        <span class="n">mask2</span> <span class="o">=</span> <span class="n">angle_dst</span> <span class="o">&lt;</span> <span class="n">nedge</span>
</span><span id="GraphAngularExtension-1063"><a href="#GraphAngularExtension-1063"><span class="linenos">1063</span></a>        <span class="n">angle_mask</span> <span class="o">=</span> <span class="n">mask1</span> <span class="o">&amp;</span> <span class="n">mask2</span>
</span><span id="GraphAngularExtension-1064"><a href="#GraphAngularExtension-1064"><span class="linenos">1064</span></a>
</span><span id="GraphAngularExtension-1065"><a href="#GraphAngularExtension-1065"><span class="linenos">1065</span></a>        <span class="c1">## filter angles to sparse representation</span>
</span><span id="GraphAngularExtension-1066"><a href="#GraphAngularExtension-1066"><span class="linenos">1066</span></a>        <span class="p">(</span><span class="n">angle_src</span><span class="p">,</span> <span class="n">angle_dst</span><span class="p">),</span> <span class="n">_</span><span class="p">,</span> <span class="n">nangles</span> <span class="o">=</span> <span class="n">mask_filter_1d</span><span class="p">(</span>
</span><span id="GraphAngularExtension-1067"><a href="#GraphAngularExtension-1067"><span class="linenos">1067</span></a>            <span class="n">angle_mask</span><span class="p">,</span>
</span><span id="GraphAngularExtension-1068"><a href="#GraphAngularExtension-1068"><span class="linenos">1068</span></a>            <span class="n">prev_nangles</span><span class="p">,</span>
</span><span id="GraphAngularExtension-1069"><a href="#GraphAngularExtension-1069"><span class="linenos">1069</span></a>            <span class="p">(</span><span class="n">angle_src</span><span class="p">,</span> <span class="n">nedge</span><span class="p">),</span>
</span><span id="GraphAngularExtension-1070"><a href="#GraphAngularExtension-1070"><span class="linenos">1070</span></a>            <span class="p">(</span><span class="n">angle_dst</span><span class="p">,</span> <span class="n">nedge</span><span class="p">),</span>
</span><span id="GraphAngularExtension-1071"><a href="#GraphAngularExtension-1071"><span class="linenos">1071</span></a>        <span class="p">)</span>
</span><span id="GraphAngularExtension-1072"><a href="#GraphAngularExtension-1072"><span class="linenos">1072</span></a>        <span class="c1">## find central atom</span>
</span><span id="GraphAngularExtension-1073"><a href="#GraphAngularExtension-1073"><span class="linenos">1073</span></a>        <span class="n">central_atom</span> <span class="o">=</span> <span class="n">edge_src</span><span class="p">[</span><span class="n">angle_src</span><span class="p">]</span>
</span><span id="GraphAngularExtension-1074"><a href="#GraphAngularExtension-1074"><span class="linenos">1074</span></a>
</span><span id="GraphAngularExtension-1075"><a href="#GraphAngularExtension-1075"><span class="linenos">1075</span></a>        <span class="c1">## check for overflow</span>
</span><span id="GraphAngularExtension-1076"><a href="#GraphAngularExtension-1076"><span class="linenos">1076</span></a>        <span class="n">angle_overflow</span> <span class="o">=</span> <span class="n">nangles</span> <span class="o">&gt;</span> <span class="n">prev_nangles</span>
</span><span id="GraphAngularExtension-1077"><a href="#GraphAngularExtension-1077"><span class="linenos">1077</span></a>        <span class="n">neigh_overflow</span> <span class="o">=</span> <span class="n">max_count</span> <span class="o">&gt;</span> <span class="n">max_neigh</span>
</span><span id="GraphAngularExtension-1078"><a href="#GraphAngularExtension-1078"><span class="linenos">1078</span></a>        <span class="n">overflow</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;angle_overflow&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="o">|</span> <span class="n">angle_overflow</span> <span class="o">|</span> <span class="n">neigh_overflow</span>
</span><span id="GraphAngularExtension-1079"><a href="#GraphAngularExtension-1079"><span class="linenos">1079</span></a>
</span><span id="GraphAngularExtension-1080"><a href="#GraphAngularExtension-1080"><span class="linenos">1080</span></a>        <span class="c1">## update graph</span>
</span><span id="GraphAngularExtension-1081"><a href="#GraphAngularExtension-1081"><span class="linenos">1081</span></a>        <span class="n">output</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="GraphAngularExtension-1082"><a href="#GraphAngularExtension-1082"><span class="linenos">1082</span></a>            <span class="o">**</span><span class="n">inputs</span><span class="p">,</span>
</span><span id="GraphAngularExtension-1083"><a href="#GraphAngularExtension-1083"><span class="linenos">1083</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">:</span> <span class="p">{</span>
</span><span id="GraphAngularExtension-1084"><a href="#GraphAngularExtension-1084"><span class="linenos">1084</span></a>                <span class="o">**</span><span class="n">graph</span><span class="p">,</span>
</span><span id="GraphAngularExtension-1085"><a href="#GraphAngularExtension-1085"><span class="linenos">1085</span></a>                <span class="s2">&quot;angle_src&quot;</span><span class="p">:</span> <span class="n">angle_src</span><span class="p">,</span>
</span><span id="GraphAngularExtension-1086"><a href="#GraphAngularExtension-1086"><span class="linenos">1086</span></a>                <span class="s2">&quot;angle_dst&quot;</span><span class="p">:</span> <span class="n">angle_dst</span><span class="p">,</span>
</span><span id="GraphAngularExtension-1087"><a href="#GraphAngularExtension-1087"><span class="linenos">1087</span></a>                <span class="s2">&quot;central_atom&quot;</span><span class="p">:</span> <span class="n">central_atom</span><span class="p">,</span>
</span><span id="GraphAngularExtension-1088"><a href="#GraphAngularExtension-1088"><span class="linenos">1088</span></a>                <span class="s2">&quot;angle_overflow&quot;</span><span class="p">:</span> <span class="n">overflow</span><span class="p">,</span>
</span><span id="GraphAngularExtension-1089"><a href="#GraphAngularExtension-1089"><span class="linenos">1089</span></a>                <span class="c1"># &quot;max_neigh&quot;: max_neigh,</span>
</span><span id="GraphAngularExtension-1090"><a href="#GraphAngularExtension-1090"><span class="linenos">1090</span></a>                <span class="s2">&quot;__max_neigh_array&quot;</span><span class="p">:</span> <span class="n">max_neigh_arr</span><span class="p">,</span>
</span><span id="GraphAngularExtension-1091"><a href="#GraphAngularExtension-1091"><span class="linenos">1091</span></a>            <span class="p">},</span>
</span><span id="GraphAngularExtension-1092"><a href="#GraphAngularExtension-1092"><span class="linenos">1092</span></a>        <span class="p">}</span>
</span><span id="GraphAngularExtension-1093"><a href="#GraphAngularExtension-1093"><span class="linenos">1093</span></a>
</span><span id="GraphAngularExtension-1094"><a href="#GraphAngularExtension-1094"><span class="linenos">1094</span></a>        <span class="k">return</span> <span class="n">output</span>
</span><span id="GraphAngularExtension-1095"><a href="#GraphAngularExtension-1095"><span class="linenos">1095</span></a>
</span><span id="GraphAngularExtension-1096"><a href="#GraphAngularExtension-1096"><span class="linenos">1096</span></a>    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
</span><span id="GraphAngularExtension-1097"><a href="#GraphAngularExtension-1097"><span class="linenos">1097</span></a>    <span class="k">def</span> <span class="nf">update_skin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
</span><span id="GraphAngularExtension-1098"><a href="#GraphAngularExtension-1098"><span class="linenos">1098</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Add angles list to a graph</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>mult_size</strong> (float, default=1.05):
Multiplicative factor for resizing the nblist.</li>
<li><strong>add_neigh</strong> (int, default=5):
Additional neighbors to add to the nblist when resizing.</li>
<li><strong>graph_key</strong> (str, default="graph"):
Key of the graph in the inputs.</li>
</ul>
</div>


                            <div id="GraphAngularExtension.__init__" class="classattr">
                                <div class="attr function">
            
        <span class="name">GraphAngularExtension</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">mult_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.05</span>,</span><span class="param">	<span class="n">add_neigh</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span>,</span><span class="param">	<span class="n">graph_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;graph&#39;</span></span>)</span>

        
    </div>
    <a class="headerlink" href="#GraphAngularExtension.__init__"></a>
    
    

                            </div>
                            <div id="GraphAngularExtension.mult_size" class="classattr">
                                <div class="attr variable">
            <span class="name">mult_size</span><span class="annotation">: float</span>        =
<span class="default_value">1.05</span>

        
    </div>
    <a class="headerlink" href="#GraphAngularExtension.mult_size"></a>
    
    

                            </div>
                            <div id="GraphAngularExtension.add_neigh" class="classattr">
                                <div class="attr variable">
            <span class="name">add_neigh</span><span class="annotation">: int</span>        =
<span class="default_value">5</span>

        
    </div>
    <a class="headerlink" href="#GraphAngularExtension.add_neigh"></a>
    
    

                            </div>
                            <div id="GraphAngularExtension.graph_key" class="classattr">
                                <div class="attr variable">
            <span class="name">graph_key</span><span class="annotation">: str</span>        =
<span class="default_value">&#39;graph&#39;</span>

        
    </div>
    <a class="headerlink" href="#GraphAngularExtension.graph_key"></a>
    
    

                            </div>
                            <div id="GraphAngularExtension.init" class="classattr">
                                        <input id="GraphAngularExtension.init-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">init</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="GraphAngularExtension.init-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GraphAngularExtension.init"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GraphAngularExtension.init-883"><a href="#GraphAngularExtension.init-883"><span class="linenos">883</span></a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="GraphAngularExtension.init-884"><a href="#GraphAngularExtension.init-884"><span class="linenos">884</span></a>        <span class="k">return</span> <span class="n">FrozenDict</span><span class="p">(</span>
</span><span id="GraphAngularExtension.init-885"><a href="#GraphAngularExtension.init-885"><span class="linenos">885</span></a>            <span class="p">{</span>
</span><span id="GraphAngularExtension.init-886"><a href="#GraphAngularExtension.init-886"><span class="linenos">886</span></a>                <span class="s2">&quot;nangles&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="GraphAngularExtension.init-887"><a href="#GraphAngularExtension.init-887"><span class="linenos">887</span></a>                <span class="s2">&quot;nblist_mult_size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mult_size</span><span class="p">,</span>
</span><span id="GraphAngularExtension.init-888"><a href="#GraphAngularExtension.init-888"><span class="linenos">888</span></a>                <span class="s2">&quot;max_neigh&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_neigh</span><span class="p">,</span>
</span><span id="GraphAngularExtension.init-889"><a href="#GraphAngularExtension.init-889"><span class="linenos">889</span></a>                <span class="s2">&quot;add_neigh&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_neigh</span><span class="p">,</span>
</span><span id="GraphAngularExtension.init-890"><a href="#GraphAngularExtension.init-890"><span class="linenos">890</span></a>            <span class="p">}</span>
</span><span id="GraphAngularExtension.init-891"><a href="#GraphAngularExtension.init-891"><span class="linenos">891</span></a>        <span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="GraphAngularExtension.get_processor" class="classattr">
                                        <input id="GraphAngularExtension.get_processor-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_processor</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">Tuple</span><span class="p">[</span><span class="n">flax</span><span class="o">.</span><span class="n">linen</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="GraphAngularExtension.get_processor-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GraphAngularExtension.get_processor"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GraphAngularExtension.get_processor-893"><a href="#GraphAngularExtension.get_processor-893"><span class="linenos">893</span></a>    <span class="k">def</span> <span class="nf">get_processor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]:</span>
</span><span id="GraphAngularExtension.get_processor-894"><a href="#GraphAngularExtension.get_processor-894"><span class="linenos">894</span></a>        <span class="k">return</span> <span class="n">GraphAngleProcessor</span><span class="p">,</span> <span class="p">{</span>
</span><span id="GraphAngularExtension.get_processor-895"><a href="#GraphAngularExtension.get_processor-895"><span class="linenos">895</span></a>            <span class="s2">&quot;graph_key&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">,</span>
</span><span id="GraphAngularExtension.get_processor-896"><a href="#GraphAngularExtension.get_processor-896"><span class="linenos">896</span></a>            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="si">}</span><span class="s2">_AngleProcessor&quot;</span><span class="p">,</span>
</span><span id="GraphAngularExtension.get_processor-897"><a href="#GraphAngularExtension.get_processor-897"><span class="linenos">897</span></a>        <span class="p">}</span>
</span></pre></div>


    

                            </div>
                            <div id="GraphAngularExtension.get_graph_properties" class="classattr">
                                        <input id="GraphAngularExtension.get_graph_properties-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_graph_properties</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="GraphAngularExtension.get_graph_properties-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GraphAngularExtension.get_graph_properties"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GraphAngularExtension.get_graph_properties-899"><a href="#GraphAngularExtension.get_graph_properties-899"><span class="linenos">899</span></a>    <span class="k">def</span> <span class="nf">get_graph_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="GraphAngularExtension.get_graph_properties-900"><a href="#GraphAngularExtension.get_graph_properties-900"><span class="linenos">900</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="GraphAngularExtension.get_graph_properties-901"><a href="#GraphAngularExtension.get_graph_properties-901"><span class="linenos">901</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">:</span> <span class="p">{</span>
</span><span id="GraphAngularExtension.get_graph_properties-902"><a href="#GraphAngularExtension.get_graph_properties-902"><span class="linenos">902</span></a>                <span class="s2">&quot;has_angles&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="GraphAngularExtension.get_graph_properties-903"><a href="#GraphAngularExtension.get_graph_properties-903"><span class="linenos">903</span></a>            <span class="p">}</span>
</span><span id="GraphAngularExtension.get_graph_properties-904"><a href="#GraphAngularExtension.get_graph_properties-904"><span class="linenos">904</span></a>        <span class="p">}</span>
</span></pre></div>


    

                            </div>
                            <div id="GraphAngularExtension.check_reallocate" class="classattr">
                                        <input id="GraphAngularExtension.check_reallocate-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">check_reallocate</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">state</span>, </span><span class="param"><span class="n">inputs</span>, </span><span class="param"><span class="n">parent_overflow</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="GraphAngularExtension.check_reallocate-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GraphAngularExtension.check_reallocate"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GraphAngularExtension.check_reallocate-1003"><a href="#GraphAngularExtension.check_reallocate-1003"><span class="linenos">1003</span></a>    <span class="k">def</span> <span class="nf">check_reallocate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">parent_overflow</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="GraphAngularExtension.check_reallocate-1004"><a href="#GraphAngularExtension.check_reallocate-1004"><span class="linenos">1004</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;check for overflow and reallocate nblist if necessary&quot;&quot;&quot;</span>
</span><span id="GraphAngularExtension.check_reallocate-1005"><a href="#GraphAngularExtension.check_reallocate-1005"><span class="linenos">1005</span></a>        <span class="n">overflow</span> <span class="o">=</span> <span class="n">parent_overflow</span> <span class="ow">or</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">][</span><span class="s2">&quot;angle_overflow&quot;</span><span class="p">]</span>
</span><span id="GraphAngularExtension.check_reallocate-1006"><a href="#GraphAngularExtension.check_reallocate-1006"><span class="linenos">1006</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">overflow</span><span class="p">:</span>
</span><span id="GraphAngularExtension.check_reallocate-1007"><a href="#GraphAngularExtension.check_reallocate-1007"><span class="linenos">1007</span></a>            <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="p">{},</span> <span class="n">inputs</span><span class="p">,</span> <span class="kc">False</span>
</span><span id="GraphAngularExtension.check_reallocate-1008"><a href="#GraphAngularExtension.check_reallocate-1008"><span class="linenos">1008</span></a>
</span><span id="GraphAngularExtension.check_reallocate-1009"><a href="#GraphAngularExtension.check_reallocate-1009"><span class="linenos">1009</span></a>        <span class="n">add_margin</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">][</span><span class="s2">&quot;angle_overflow&quot;</span><span class="p">]</span>
</span><span id="GraphAngularExtension.check_reallocate-1010"><a href="#GraphAngularExtension.check_reallocate-1010"><span class="linenos">1010</span></a>        <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">state_up</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span>
</span><span id="GraphAngularExtension.check_reallocate-1011"><a href="#GraphAngularExtension.check_reallocate-1011"><span class="linenos">1011</span></a>            <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">return_state_update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">add_margin</span><span class="o">=</span><span class="n">add_margin</span>
</span><span id="GraphAngularExtension.check_reallocate-1012"><a href="#GraphAngularExtension.check_reallocate-1012"><span class="linenos">1012</span></a>        <span class="p">)</span>
</span><span id="GraphAngularExtension.check_reallocate-1013"><a href="#GraphAngularExtension.check_reallocate-1013"><span class="linenos">1013</span></a>        <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="n">state_up</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="kc">True</span>
</span></pre></div>


            <div class="docstring"><p>check for overflow and reallocate nblist if necessary</p>
</div>


                            </div>
                            <div id="GraphAngularExtension.process" class="classattr">
                                        <input id="GraphAngularExtension.process-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@partial(jax.jit, static_argnums=(0, 1))</div>

        <span class="def">def</span>
        <span class="name">process</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">state</span>, </span><span class="param"><span class="n">inputs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="GraphAngularExtension.process-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GraphAngularExtension.process"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GraphAngularExtension.process-1015"><a href="#GraphAngularExtension.process-1015"><span class="linenos">1015</span></a>    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="GraphAngularExtension.process-1016"><a href="#GraphAngularExtension.process-1016"><span class="linenos">1016</span></a>    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
</span><span id="GraphAngularExtension.process-1017"><a href="#GraphAngularExtension.process-1017"><span class="linenos">1017</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;build angle nblist on accelerator with jax and precomputed shapes&quot;&quot;&quot;</span>
</span><span id="GraphAngularExtension.process-1018"><a href="#GraphAngularExtension.process-1018"><span class="linenos">1018</span></a>        <span class="n">graph</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">]</span>
</span><span id="GraphAngularExtension.process-1019"><a href="#GraphAngularExtension.process-1019"><span class="linenos">1019</span></a>        <span class="n">edge_src</span> <span class="o">=</span> <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;edge_src&quot;</span><span class="p">]</span>
</span><span id="GraphAngularExtension.process-1020"><a href="#GraphAngularExtension.process-1020"><span class="linenos">1020</span></a>
</span><span id="GraphAngularExtension.process-1021"><a href="#GraphAngularExtension.process-1021"><span class="linenos">1021</span></a>        <span class="c1">### count number of neighbors</span>
</span><span id="GraphAngularExtension.process-1022"><a href="#GraphAngularExtension.process-1022"><span class="linenos">1022</span></a>        <span class="n">nat</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="GraphAngularExtension.process-1023"><a href="#GraphAngularExtension.process-1023"><span class="linenos">1023</span></a>        <span class="n">count</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">edge_src</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;drop&quot;</span><span class="p">)</span>
</span><span id="GraphAngularExtension.process-1024"><a href="#GraphAngularExtension.process-1024"><span class="linenos">1024</span></a>        <span class="n">max_count</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
</span><span id="GraphAngularExtension.process-1025"><a href="#GraphAngularExtension.process-1025"><span class="linenos">1025</span></a>
</span><span id="GraphAngularExtension.process-1026"><a href="#GraphAngularExtension.process-1026"><span class="linenos">1026</span></a>        <span class="c1">### get sizes</span>
</span><span id="GraphAngularExtension.process-1027"><a href="#GraphAngularExtension.process-1027"><span class="linenos">1027</span></a>        <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="GraphAngularExtension.process-1028"><a href="#GraphAngularExtension.process-1028"><span class="linenos">1028</span></a>            <span class="n">max_neigh_arr</span> <span class="o">=</span> <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;__max_neigh_array&quot;</span><span class="p">]</span>
</span><span id="GraphAngularExtension.process-1029"><a href="#GraphAngularExtension.process-1029"><span class="linenos">1029</span></a>            <span class="n">max_neigh</span> <span class="o">=</span> <span class="n">max_neigh_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="GraphAngularExtension.process-1030"><a href="#GraphAngularExtension.process-1030"><span class="linenos">1030</span></a>            <span class="n">prev_nangles</span> <span class="o">=</span> <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;angle_src&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="GraphAngularExtension.process-1031"><a href="#GraphAngularExtension.process-1031"><span class="linenos">1031</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="GraphAngularExtension.process-1032"><a href="#GraphAngularExtension.process-1032"><span class="linenos">1032</span></a>            <span class="n">max_neigh</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_neigh&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_neigh</span><span class="p">)</span>
</span><span id="GraphAngularExtension.process-1033"><a href="#GraphAngularExtension.process-1033"><span class="linenos">1033</span></a>            <span class="n">max_neigh_arr</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">max_neigh</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
</span><span id="GraphAngularExtension.process-1034"><a href="#GraphAngularExtension.process-1034"><span class="linenos">1034</span></a>            <span class="n">prev_nangles</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nangles&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="GraphAngularExtension.process-1035"><a href="#GraphAngularExtension.process-1035"><span class="linenos">1035</span></a>
</span><span id="GraphAngularExtension.process-1036"><a href="#GraphAngularExtension.process-1036"><span class="linenos">1036</span></a>        <span class="n">nedge</span> <span class="o">=</span> <span class="n">edge_src</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="GraphAngularExtension.process-1037"><a href="#GraphAngularExtension.process-1037"><span class="linenos">1037</span></a>
</span><span id="GraphAngularExtension.process-1038"><a href="#GraphAngularExtension.process-1038"><span class="linenos">1038</span></a>        <span class="c1">### sort edge_src</span>
</span><span id="GraphAngularExtension.process-1039"><a href="#GraphAngularExtension.process-1039"><span class="linenos">1039</span></a>        <span class="n">idx_sort</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">edge_src</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="GraphAngularExtension.process-1040"><a href="#GraphAngularExtension.process-1040"><span class="linenos">1040</span></a>        <span class="n">edge_src_sorted</span> <span class="o">=</span> <span class="n">edge_src</span><span class="p">[</span><span class="n">idx_sort</span><span class="p">]</span>
</span><span id="GraphAngularExtension.process-1041"><a href="#GraphAngularExtension.process-1041"><span class="linenos">1041</span></a>
</span><span id="GraphAngularExtension.process-1042"><a href="#GraphAngularExtension.process-1042"><span class="linenos">1042</span></a>        <span class="c1">### map sparse to dense nblist</span>
</span><span id="GraphAngularExtension.process-1043"><a href="#GraphAngularExtension.process-1043"><span class="linenos">1043</span></a>        <span class="k">if</span> <span class="n">max_neigh</span> <span class="o">*</span> <span class="n">nat</span> <span class="o">&lt;</span> <span class="n">nedge</span><span class="p">:</span>
</span><span id="GraphAngularExtension.process-1044"><a href="#GraphAngularExtension.process-1044"><span class="linenos">1044</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Found max_neigh*nat &lt; nedge. This should not happen.&quot;</span><span class="p">)</span>
</span><span id="GraphAngularExtension.process-1045"><a href="#GraphAngularExtension.process-1045"><span class="linenos">1045</span></a>        <span class="n">offset</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">max_neigh</span><span class="p">),</span> <span class="n">nat</span><span class="p">)[:</span><span class="n">nedge</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="GraphAngularExtension.process-1046"><a href="#GraphAngularExtension.process-1046"><span class="linenos">1046</span></a>        <span class="c1"># offset = jnp.where(edge_src_sorted &lt; nat, offset, 0)</span>
</span><span id="GraphAngularExtension.process-1047"><a href="#GraphAngularExtension.process-1047"><span class="linenos">1047</span></a>        <span class="n">indices</span> <span class="o">=</span> <span class="n">edge_src_sorted</span> <span class="o">*</span> <span class="n">max_neigh</span> <span class="o">+</span> <span class="n">offset</span>
</span><span id="GraphAngularExtension.process-1048"><a href="#GraphAngularExtension.process-1048"><span class="linenos">1048</span></a>        <span class="n">edge_idx</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="GraphAngularExtension.process-1049"><a href="#GraphAngularExtension.process-1049"><span class="linenos">1049</span></a>            <span class="n">jnp</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">nat</span> <span class="o">*</span> <span class="n">max_neigh</span><span class="p">,</span> <span class="n">nedge</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="GraphAngularExtension.process-1050"><a href="#GraphAngularExtension.process-1050"><span class="linenos">1050</span></a>            <span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
</span><span id="GraphAngularExtension.process-1051"><a href="#GraphAngularExtension.process-1051"><span class="linenos">1051</span></a>            <span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">idx_sort</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;drop&quot;</span><span class="p">)</span>
</span><span id="GraphAngularExtension.process-1052"><a href="#GraphAngularExtension.process-1052"><span class="linenos">1052</span></a>            <span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nat</span><span class="p">,</span> <span class="n">max_neigh</span><span class="p">)</span>
</span><span id="GraphAngularExtension.process-1053"><a href="#GraphAngularExtension.process-1053"><span class="linenos">1053</span></a>        <span class="p">)</span>
</span><span id="GraphAngularExtension.process-1054"><a href="#GraphAngularExtension.process-1054"><span class="linenos">1054</span></a>
</span><span id="GraphAngularExtension.process-1055"><a href="#GraphAngularExtension.process-1055"><span class="linenos">1055</span></a>        <span class="c1">### find all triplet for each atom center</span>
</span><span id="GraphAngularExtension.process-1056"><a href="#GraphAngularExtension.process-1056"><span class="linenos">1056</span></a>        <span class="n">local_src</span><span class="p">,</span> <span class="n">local_dst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">triu_indices</span><span class="p">(</span><span class="n">max_neigh</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="GraphAngularExtension.process-1057"><a href="#GraphAngularExtension.process-1057"><span class="linenos">1057</span></a>        <span class="n">angle_src</span> <span class="o">=</span> <span class="n">edge_idx</span><span class="p">[:,</span> <span class="n">local_src</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="GraphAngularExtension.process-1058"><a href="#GraphAngularExtension.process-1058"><span class="linenos">1058</span></a>        <span class="n">angle_dst</span> <span class="o">=</span> <span class="n">edge_idx</span><span class="p">[:,</span> <span class="n">local_dst</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="GraphAngularExtension.process-1059"><a href="#GraphAngularExtension.process-1059"><span class="linenos">1059</span></a>
</span><span id="GraphAngularExtension.process-1060"><a href="#GraphAngularExtension.process-1060"><span class="linenos">1060</span></a>        <span class="c1">### mask for valid angles</span>
</span><span id="GraphAngularExtension.process-1061"><a href="#GraphAngularExtension.process-1061"><span class="linenos">1061</span></a>        <span class="n">mask1</span> <span class="o">=</span> <span class="n">angle_src</span> <span class="o">&lt;</span> <span class="n">nedge</span>
</span><span id="GraphAngularExtension.process-1062"><a href="#GraphAngularExtension.process-1062"><span class="linenos">1062</span></a>        <span class="n">mask2</span> <span class="o">=</span> <span class="n">angle_dst</span> <span class="o">&lt;</span> <span class="n">nedge</span>
</span><span id="GraphAngularExtension.process-1063"><a href="#GraphAngularExtension.process-1063"><span class="linenos">1063</span></a>        <span class="n">angle_mask</span> <span class="o">=</span> <span class="n">mask1</span> <span class="o">&amp;</span> <span class="n">mask2</span>
</span><span id="GraphAngularExtension.process-1064"><a href="#GraphAngularExtension.process-1064"><span class="linenos">1064</span></a>
</span><span id="GraphAngularExtension.process-1065"><a href="#GraphAngularExtension.process-1065"><span class="linenos">1065</span></a>        <span class="c1">## filter angles to sparse representation</span>
</span><span id="GraphAngularExtension.process-1066"><a href="#GraphAngularExtension.process-1066"><span class="linenos">1066</span></a>        <span class="p">(</span><span class="n">angle_src</span><span class="p">,</span> <span class="n">angle_dst</span><span class="p">),</span> <span class="n">_</span><span class="p">,</span> <span class="n">nangles</span> <span class="o">=</span> <span class="n">mask_filter_1d</span><span class="p">(</span>
</span><span id="GraphAngularExtension.process-1067"><a href="#GraphAngularExtension.process-1067"><span class="linenos">1067</span></a>            <span class="n">angle_mask</span><span class="p">,</span>
</span><span id="GraphAngularExtension.process-1068"><a href="#GraphAngularExtension.process-1068"><span class="linenos">1068</span></a>            <span class="n">prev_nangles</span><span class="p">,</span>
</span><span id="GraphAngularExtension.process-1069"><a href="#GraphAngularExtension.process-1069"><span class="linenos">1069</span></a>            <span class="p">(</span><span class="n">angle_src</span><span class="p">,</span> <span class="n">nedge</span><span class="p">),</span>
</span><span id="GraphAngularExtension.process-1070"><a href="#GraphAngularExtension.process-1070"><span class="linenos">1070</span></a>            <span class="p">(</span><span class="n">angle_dst</span><span class="p">,</span> <span class="n">nedge</span><span class="p">),</span>
</span><span id="GraphAngularExtension.process-1071"><a href="#GraphAngularExtension.process-1071"><span class="linenos">1071</span></a>        <span class="p">)</span>
</span><span id="GraphAngularExtension.process-1072"><a href="#GraphAngularExtension.process-1072"><span class="linenos">1072</span></a>        <span class="c1">## find central atom</span>
</span><span id="GraphAngularExtension.process-1073"><a href="#GraphAngularExtension.process-1073"><span class="linenos">1073</span></a>        <span class="n">central_atom</span> <span class="o">=</span> <span class="n">edge_src</span><span class="p">[</span><span class="n">angle_src</span><span class="p">]</span>
</span><span id="GraphAngularExtension.process-1074"><a href="#GraphAngularExtension.process-1074"><span class="linenos">1074</span></a>
</span><span id="GraphAngularExtension.process-1075"><a href="#GraphAngularExtension.process-1075"><span class="linenos">1075</span></a>        <span class="c1">## check for overflow</span>
</span><span id="GraphAngularExtension.process-1076"><a href="#GraphAngularExtension.process-1076"><span class="linenos">1076</span></a>        <span class="n">angle_overflow</span> <span class="o">=</span> <span class="n">nangles</span> <span class="o">&gt;</span> <span class="n">prev_nangles</span>
</span><span id="GraphAngularExtension.process-1077"><a href="#GraphAngularExtension.process-1077"><span class="linenos">1077</span></a>        <span class="n">neigh_overflow</span> <span class="o">=</span> <span class="n">max_count</span> <span class="o">&gt;</span> <span class="n">max_neigh</span>
</span><span id="GraphAngularExtension.process-1078"><a href="#GraphAngularExtension.process-1078"><span class="linenos">1078</span></a>        <span class="n">overflow</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;angle_overflow&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="o">|</span> <span class="n">angle_overflow</span> <span class="o">|</span> <span class="n">neigh_overflow</span>
</span><span id="GraphAngularExtension.process-1079"><a href="#GraphAngularExtension.process-1079"><span class="linenos">1079</span></a>
</span><span id="GraphAngularExtension.process-1080"><a href="#GraphAngularExtension.process-1080"><span class="linenos">1080</span></a>        <span class="c1">## update graph</span>
</span><span id="GraphAngularExtension.process-1081"><a href="#GraphAngularExtension.process-1081"><span class="linenos">1081</span></a>        <span class="n">output</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="GraphAngularExtension.process-1082"><a href="#GraphAngularExtension.process-1082"><span class="linenos">1082</span></a>            <span class="o">**</span><span class="n">inputs</span><span class="p">,</span>
</span><span id="GraphAngularExtension.process-1083"><a href="#GraphAngularExtension.process-1083"><span class="linenos">1083</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">:</span> <span class="p">{</span>
</span><span id="GraphAngularExtension.process-1084"><a href="#GraphAngularExtension.process-1084"><span class="linenos">1084</span></a>                <span class="o">**</span><span class="n">graph</span><span class="p">,</span>
</span><span id="GraphAngularExtension.process-1085"><a href="#GraphAngularExtension.process-1085"><span class="linenos">1085</span></a>                <span class="s2">&quot;angle_src&quot;</span><span class="p">:</span> <span class="n">angle_src</span><span class="p">,</span>
</span><span id="GraphAngularExtension.process-1086"><a href="#GraphAngularExtension.process-1086"><span class="linenos">1086</span></a>                <span class="s2">&quot;angle_dst&quot;</span><span class="p">:</span> <span class="n">angle_dst</span><span class="p">,</span>
</span><span id="GraphAngularExtension.process-1087"><a href="#GraphAngularExtension.process-1087"><span class="linenos">1087</span></a>                <span class="s2">&quot;central_atom&quot;</span><span class="p">:</span> <span class="n">central_atom</span><span class="p">,</span>
</span><span id="GraphAngularExtension.process-1088"><a href="#GraphAngularExtension.process-1088"><span class="linenos">1088</span></a>                <span class="s2">&quot;angle_overflow&quot;</span><span class="p">:</span> <span class="n">overflow</span><span class="p">,</span>
</span><span id="GraphAngularExtension.process-1089"><a href="#GraphAngularExtension.process-1089"><span class="linenos">1089</span></a>                <span class="c1"># &quot;max_neigh&quot;: max_neigh,</span>
</span><span id="GraphAngularExtension.process-1090"><a href="#GraphAngularExtension.process-1090"><span class="linenos">1090</span></a>                <span class="s2">&quot;__max_neigh_array&quot;</span><span class="p">:</span> <span class="n">max_neigh_arr</span><span class="p">,</span>
</span><span id="GraphAngularExtension.process-1091"><a href="#GraphAngularExtension.process-1091"><span class="linenos">1091</span></a>            <span class="p">},</span>
</span><span id="GraphAngularExtension.process-1092"><a href="#GraphAngularExtension.process-1092"><span class="linenos">1092</span></a>        <span class="p">}</span>
</span><span id="GraphAngularExtension.process-1093"><a href="#GraphAngularExtension.process-1093"><span class="linenos">1093</span></a>
</span><span id="GraphAngularExtension.process-1094"><a href="#GraphAngularExtension.process-1094"><span class="linenos">1094</span></a>        <span class="k">return</span> <span class="n">output</span>
</span></pre></div>


            <div class="docstring"><p>build angle nblist on accelerator with jax and precomputed shapes</p>
</div>


                            </div>
                            <div id="GraphAngularExtension.update_skin" class="classattr">
                                        <input id="GraphAngularExtension.update_skin-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@partial(jax.jit, static_argnums=(0,))</div>

        <span class="def">def</span>
        <span class="name">update_skin</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">inputs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="GraphAngularExtension.update_skin-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GraphAngularExtension.update_skin"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GraphAngularExtension.update_skin-1096"><a href="#GraphAngularExtension.update_skin-1096"><span class="linenos">1096</span></a>    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
</span><span id="GraphAngularExtension.update_skin-1097"><a href="#GraphAngularExtension.update_skin-1097"><span class="linenos">1097</span></a>    <span class="k">def</span> <span class="nf">update_skin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
</span><span id="GraphAngularExtension.update_skin-1098"><a href="#GraphAngularExtension.update_skin-1098"><span class="linenos">1098</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                </section>
                <section id="GraphAngleProcessor">
                            <input id="GraphAngleProcessor-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">GraphAngleProcessor</span><wbr>(<span class="base">flax.linen.module.Module</span>):

                <label class="view-source-button" for="GraphAngleProcessor-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GraphAngleProcessor"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GraphAngleProcessor-1101"><a href="#GraphAngleProcessor-1101"><span class="linenos">1101</span></a><span class="k">class</span> <span class="nc">GraphAngleProcessor</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="GraphAngleProcessor-1102"><a href="#GraphAngleProcessor-1102"><span class="linenos">1102</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Process a pre-generated graph to compute angles</span>
</span><span id="GraphAngleProcessor-1103"><a href="#GraphAngleProcessor-1103"><span class="linenos">1103</span></a>
</span><span id="GraphAngleProcessor-1104"><a href="#GraphAngleProcessor-1104"><span class="linenos">1104</span></a><span class="sd">    This module is automatically added to a FENNIX model when a GraphAngularExtension is used.</span>
</span><span id="GraphAngleProcessor-1105"><a href="#GraphAngleProcessor-1105"><span class="linenos">1105</span></a>
</span><span id="GraphAngleProcessor-1106"><a href="#GraphAngleProcessor-1106"><span class="linenos">1106</span></a><span class="sd">    Parameters</span>
</span><span id="GraphAngleProcessor-1107"><a href="#GraphAngleProcessor-1107"><span class="linenos">1107</span></a><span class="sd">    ----------</span>
</span><span id="GraphAngleProcessor-1108"><a href="#GraphAngleProcessor-1108"><span class="linenos">1108</span></a><span class="sd">    graph_key : str</span>
</span><span id="GraphAngleProcessor-1109"><a href="#GraphAngleProcessor-1109"><span class="linenos">1109</span></a><span class="sd">        Key of the graph in the inputs.</span>
</span><span id="GraphAngleProcessor-1110"><a href="#GraphAngleProcessor-1110"><span class="linenos">1110</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="GraphAngleProcessor-1111"><a href="#GraphAngleProcessor-1111"><span class="linenos">1111</span></a>
</span><span id="GraphAngleProcessor-1112"><a href="#GraphAngleProcessor-1112"><span class="linenos">1112</span></a>    <span class="n">graph_key</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="GraphAngleProcessor-1113"><a href="#GraphAngleProcessor-1113"><span class="linenos">1113</span></a>
</span><span id="GraphAngleProcessor-1114"><a href="#GraphAngleProcessor-1114"><span class="linenos">1114</span></a>    <span class="nd">@nn</span><span class="o">.</span><span class="n">compact</span>
</span><span id="GraphAngleProcessor-1115"><a href="#GraphAngleProcessor-1115"><span class="linenos">1115</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]]):</span>
</span><span id="GraphAngleProcessor-1116"><a href="#GraphAngleProcessor-1116"><span class="linenos">1116</span></a>        <span class="n">graph</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">]</span>
</span><span id="GraphAngleProcessor-1117"><a href="#GraphAngleProcessor-1117"><span class="linenos">1117</span></a>        <span class="n">distances</span> <span class="o">=</span> <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;distances&quot;</span><span class="p">]</span>
</span><span id="GraphAngleProcessor-1118"><a href="#GraphAngleProcessor-1118"><span class="linenos">1118</span></a>        <span class="n">vec</span> <span class="o">=</span> <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;vec&quot;</span><span class="p">]</span>
</span><span id="GraphAngleProcessor-1119"><a href="#GraphAngleProcessor-1119"><span class="linenos">1119</span></a>        <span class="n">angle_src</span> <span class="o">=</span> <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;angle_src&quot;</span><span class="p">]</span>
</span><span id="GraphAngleProcessor-1120"><a href="#GraphAngleProcessor-1120"><span class="linenos">1120</span></a>        <span class="n">angle_dst</span> <span class="o">=</span> <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;angle_dst&quot;</span><span class="p">]</span>
</span><span id="GraphAngleProcessor-1121"><a href="#GraphAngleProcessor-1121"><span class="linenos">1121</span></a>
</span><span id="GraphAngleProcessor-1122"><a href="#GraphAngleProcessor-1122"><span class="linenos">1122</span></a>        <span class="n">d1</span> <span class="o">=</span> <span class="n">distances</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">angle_src</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
</span><span id="GraphAngleProcessor-1123"><a href="#GraphAngleProcessor-1123"><span class="linenos">1123</span></a>        <span class="n">d2</span> <span class="o">=</span> <span class="n">distances</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">angle_dst</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
</span><span id="GraphAngleProcessor-1124"><a href="#GraphAngleProcessor-1124"><span class="linenos">1124</span></a>        <span class="n">vec1</span> <span class="o">=</span> <span class="n">vec</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">angle_src</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
</span><span id="GraphAngleProcessor-1125"><a href="#GraphAngleProcessor-1125"><span class="linenos">1125</span></a>        <span class="n">vec2</span> <span class="o">=</span> <span class="n">vec</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">angle_dst</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
</span><span id="GraphAngleProcessor-1126"><a href="#GraphAngleProcessor-1126"><span class="linenos">1126</span></a>
</span><span id="GraphAngleProcessor-1127"><a href="#GraphAngleProcessor-1127"><span class="linenos">1127</span></a>        <span class="n">cos_angles</span> <span class="o">=</span> <span class="p">(</span><span class="n">vec1</span> <span class="o">*</span> <span class="n">vec2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">d1</span> <span class="o">*</span> <span class="n">d2</span><span class="p">,</span> <span class="n">a_min</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">)</span>
</span><span id="GraphAngleProcessor-1128"><a href="#GraphAngleProcessor-1128"><span class="linenos">1128</span></a>        <span class="n">angles</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="mf">0.95</span> <span class="o">*</span> <span class="n">cos_angles</span><span class="p">)</span>
</span><span id="GraphAngleProcessor-1129"><a href="#GraphAngleProcessor-1129"><span class="linenos">1129</span></a>
</span><span id="GraphAngleProcessor-1130"><a href="#GraphAngleProcessor-1130"><span class="linenos">1130</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="GraphAngleProcessor-1131"><a href="#GraphAngleProcessor-1131"><span class="linenos">1131</span></a>            <span class="o">**</span><span class="n">inputs</span><span class="p">,</span>
</span><span id="GraphAngleProcessor-1132"><a href="#GraphAngleProcessor-1132"><span class="linenos">1132</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">graph_key</span><span class="p">:</span> <span class="p">{</span>
</span><span id="GraphAngleProcessor-1133"><a href="#GraphAngleProcessor-1133"><span class="linenos">1133</span></a>                <span class="o">**</span><span class="n">graph</span><span class="p">,</span>
</span><span id="GraphAngleProcessor-1134"><a href="#GraphAngleProcessor-1134"><span class="linenos">1134</span></a>                <span class="c1"># &quot;cos_angles&quot;: cos_angles,</span>
</span><span id="GraphAngleProcessor-1135"><a href="#GraphAngleProcessor-1135"><span class="linenos">1135</span></a>                <span class="s2">&quot;angles&quot;</span><span class="p">:</span> <span class="n">angles</span><span class="p">,</span>
</span><span id="GraphAngleProcessor-1136"><a href="#GraphAngleProcessor-1136"><span class="linenos">1136</span></a>                <span class="c1"># &quot;angle_mask&quot;: angle_mask,</span>
</span><span id="GraphAngleProcessor-1137"><a href="#GraphAngleProcessor-1137"><span class="linenos">1137</span></a>            <span class="p">},</span>
</span><span id="GraphAngleProcessor-1138"><a href="#GraphAngleProcessor-1138"><span class="linenos">1138</span></a>        <span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>Process a pre-generated graph to compute angles</p>

<p>This module is automatically added to a FENNIX model when a GraphAngularExtension is used.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>graph_key</strong> (str):
Key of the graph in the inputs.</li>
</ul>
</div>


                            <div id="GraphAngleProcessor.__init__" class="classattr">
                                <div class="attr function">
            
        <span class="name">GraphAngleProcessor</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">graph_key</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">parent</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">flax</span><span class="o">.</span><span class="n">linen</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">Module</span><span class="p">],</span> <span class="n">flax</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">Scope</span><span class="p">,</span> <span class="n">Type</span><span class="p">[</span><span class="n">flax</span><span class="o">.</span><span class="n">linen</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">_Sentinel</span><span class="p">],</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">flax</span><span class="o">.</span><span class="n">linen</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">_Sentinel</span> <span class="nb">object</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

        
    </div>
    <a class="headerlink" href="#GraphAngleProcessor.__init__"></a>
    
    

                            </div>
                            <div id="GraphAngleProcessor.graph_key" class="classattr">
                                <div class="attr variable">
            <span class="name">graph_key</span><span class="annotation">: str</span>

        
    </div>
    <a class="headerlink" href="#GraphAngleProcessor.graph_key"></a>
    
    

                            </div>
                            <div id="GraphAngleProcessor.parent" class="classattr">
                                <div class="attr variable">
            <span class="name">parent</span><span class="annotation">: Union[Type[flax.linen.module.Module], flax.core.scope.Scope, Type[flax.linen.module._Sentinel], NoneType]</span>

        
    </div>
    <a class="headerlink" href="#GraphAngleProcessor.parent"></a>
    
            <div class="docstring"><p>Wraps parent module references in weak refs.</p>

<p>This prevents reference cycles from forming via parent links which can lead
to accidental OOMs in eager mode due to slow garbage collection as well as
spurious tracer leaks during jit compilation.</p>

<p>Note: "descriptors" are the underlying python mechanism for implementing
dynamic @property decorators.  We need to use a raw descriptor instead of the
more common decorator in order to force that the appropriate getter/setter
logic applies in subclasses even after various dataclass transforms.</p>
</div>


                            </div>
                            <div id="GraphAngleProcessor.name" class="classattr">
                                <div class="attr variable">
            <span class="name">name</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#GraphAngleProcessor.name"></a>
    
    

                            </div>
                            <div id="GraphAngleProcessor.scope" class="classattr">
                                <div class="attr variable">
            <span class="name">scope</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#GraphAngleProcessor.scope"></a>
    
    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>flax.linen.module.Module</dt>
                                <dd id="GraphAngleProcessor.setup" class="function">setup</dd>
                <dd id="GraphAngleProcessor.path" class="variable">path</dd>
                <dd id="GraphAngleProcessor.clone" class="function">clone</dd>
                <dd id="GraphAngleProcessor.copy" class="function">copy</dd>
                <dd id="GraphAngleProcessor.variable" class="function">variable</dd>
                <dd id="GraphAngleProcessor.param" class="function">param</dd>
                <dd id="GraphAngleProcessor.has_variable" class="function">has_variable</dd>
                <dd id="GraphAngleProcessor.is_mutable_collection" class="function">is_mutable_collection</dd>
                <dd id="GraphAngleProcessor.has_rng" class="function">has_rng</dd>
                <dd id="GraphAngleProcessor.make_rng" class="function">make_rng</dd>
                <dd id="GraphAngleProcessor.is_initializing" class="function">is_initializing</dd>
                <dd id="GraphAngleProcessor.bind" class="function">bind</dd>
                <dd id="GraphAngleProcessor.unbind" class="function">unbind</dd>
                <dd id="GraphAngleProcessor.apply" class="function">apply</dd>
                <dd id="GraphAngleProcessor.init_with_output" class="function">init_with_output</dd>
                <dd id="GraphAngleProcessor.init" class="function">init</dd>
                <dd id="GraphAngleProcessor.lazy_init" class="function">lazy_init</dd>
                <dd id="GraphAngleProcessor.variables" class="variable">variables</dd>
                <dd id="GraphAngleProcessor.get_variable" class="function">get_variable</dd>
                <dd id="GraphAngleProcessor.put_variable" class="function">put_variable</dd>
                <dd id="GraphAngleProcessor.sow" class="function">sow</dd>
                <dd id="GraphAngleProcessor.perturb" class="function">perturb</dd>
                <dd id="GraphAngleProcessor.tabulate" class="function">tabulate</dd>
                <dd id="GraphAngleProcessor.module_paths" class="function">module_paths</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="SpeciesIndexer">
                            <input id="SpeciesIndexer-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
                    <div class="decorator">@dataclasses.dataclass(frozen=True)</div>

    <span class="def">class</span>
    <span class="name">SpeciesIndexer</span>:

                <label class="view-source-button" for="SpeciesIndexer-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SpeciesIndexer"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SpeciesIndexer-1141"><a href="#SpeciesIndexer-1141"><span class="linenos">1141</span></a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="SpeciesIndexer-1142"><a href="#SpeciesIndexer-1142"><span class="linenos">1142</span></a><span class="k">class</span> <span class="nc">SpeciesIndexer</span><span class="p">:</span>
</span><span id="SpeciesIndexer-1143"><a href="#SpeciesIndexer-1143"><span class="linenos">1143</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Build an index that splits atomic arrays by species.</span>
</span><span id="SpeciesIndexer-1144"><a href="#SpeciesIndexer-1144"><span class="linenos">1144</span></a>
</span><span id="SpeciesIndexer-1145"><a href="#SpeciesIndexer-1145"><span class="linenos">1145</span></a><span class="sd">    If `species_order` is specified, the output will be a dense array with size (len(species_order), max_size) that can directly index atomic arrays.</span>
</span><span id="SpeciesIndexer-1146"><a href="#SpeciesIndexer-1146"><span class="linenos">1146</span></a><span class="sd">    If `species_order` is None, the output will be a dictionary with species as keys and an index to filter atomic arrays for that species as values.</span>
</span><span id="SpeciesIndexer-1147"><a href="#SpeciesIndexer-1147"><span class="linenos">1147</span></a>
</span><span id="SpeciesIndexer-1148"><a href="#SpeciesIndexer-1148"><span class="linenos">1148</span></a><span class="sd">    Parameters</span>
</span><span id="SpeciesIndexer-1149"><a href="#SpeciesIndexer-1149"><span class="linenos">1149</span></a><span class="sd">    ----------</span>
</span><span id="SpeciesIndexer-1150"><a href="#SpeciesIndexer-1150"><span class="linenos">1150</span></a><span class="sd">    output_key : str, default=&quot;species_index&quot;</span>
</span><span id="SpeciesIndexer-1151"><a href="#SpeciesIndexer-1151"><span class="linenos">1151</span></a><span class="sd">        Key for the output dictionary.</span>
</span><span id="SpeciesIndexer-1152"><a href="#SpeciesIndexer-1152"><span class="linenos">1152</span></a><span class="sd">    species_order : str, default=None</span>
</span><span id="SpeciesIndexer-1153"><a href="#SpeciesIndexer-1153"><span class="linenos">1153</span></a><span class="sd">        Comma separated list of species in the order they should be indexed.</span>
</span><span id="SpeciesIndexer-1154"><a href="#SpeciesIndexer-1154"><span class="linenos">1154</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="SpeciesIndexer-1155"><a href="#SpeciesIndexer-1155"><span class="linenos">1155</span></a>
</span><span id="SpeciesIndexer-1156"><a href="#SpeciesIndexer-1156"><span class="linenos">1156</span></a>    <span class="n">output_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;species_index&quot;</span>
</span><span id="SpeciesIndexer-1157"><a href="#SpeciesIndexer-1157"><span class="linenos">1157</span></a>    <span class="n">species_order</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SpeciesIndexer-1158"><a href="#SpeciesIndexer-1158"><span class="linenos">1158</span></a>    <span class="n">add_atoms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="SpeciesIndexer-1159"><a href="#SpeciesIndexer-1159"><span class="linenos">1159</span></a>
</span><span id="SpeciesIndexer-1160"><a href="#SpeciesIndexer-1160"><span class="linenos">1160</span></a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="SpeciesIndexer-1161"><a href="#SpeciesIndexer-1161"><span class="linenos">1161</span></a>        <span class="k">return</span> <span class="n">FrozenDict</span><span class="p">(</span>
</span><span id="SpeciesIndexer-1162"><a href="#SpeciesIndexer-1162"><span class="linenos">1162</span></a>            <span class="p">{</span>
</span><span id="SpeciesIndexer-1163"><a href="#SpeciesIndexer-1163"><span class="linenos">1163</span></a>                <span class="s2">&quot;sizes&quot;</span><span class="p">:</span> <span class="p">{},</span>
</span><span id="SpeciesIndexer-1164"><a href="#SpeciesIndexer-1164"><span class="linenos">1164</span></a>            <span class="p">}</span>
</span><span id="SpeciesIndexer-1165"><a href="#SpeciesIndexer-1165"><span class="linenos">1165</span></a>        <span class="p">)</span>
</span><span id="SpeciesIndexer-1166"><a href="#SpeciesIndexer-1166"><span class="linenos">1166</span></a>
</span><span id="SpeciesIndexer-1167"><a href="#SpeciesIndexer-1167"><span class="linenos">1167</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">return_state_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_margin</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="SpeciesIndexer-1168"><a href="#SpeciesIndexer-1168"><span class="linenos">1168</span></a>        <span class="n">species</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="SpeciesIndexer-1169"><a href="#SpeciesIndexer-1169"><span class="linenos">1169</span></a>        <span class="n">nat</span> <span class="o">=</span> <span class="n">species</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="SpeciesIndexer-1170"><a href="#SpeciesIndexer-1170"><span class="linenos">1170</span></a>        <span class="n">set_species</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">species</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="SpeciesIndexer-1171"><a href="#SpeciesIndexer-1171"><span class="linenos">1171</span></a>
</span><span id="SpeciesIndexer-1172"><a href="#SpeciesIndexer-1172"><span class="linenos">1172</span></a>        <span class="n">new_state</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">state</span><span class="p">}</span>
</span><span id="SpeciesIndexer-1173"><a href="#SpeciesIndexer-1173"><span class="linenos">1173</span></a>        <span class="n">state_up</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="SpeciesIndexer-1174"><a href="#SpeciesIndexer-1174"><span class="linenos">1174</span></a>
</span><span id="SpeciesIndexer-1175"><a href="#SpeciesIndexer-1175"><span class="linenos">1175</span></a>        <span class="n">sizes</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sizes&quot;</span><span class="p">,</span> <span class="n">FrozenDict</span><span class="p">({}))</span>
</span><span id="SpeciesIndexer-1176"><a href="#SpeciesIndexer-1176"><span class="linenos">1176</span></a>        <span class="n">new_sizes</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">sizes</span><span class="p">}</span>
</span><span id="SpeciesIndexer-1177"><a href="#SpeciesIndexer-1177"><span class="linenos">1177</span></a>        <span class="n">up_sizes</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="SpeciesIndexer-1178"><a href="#SpeciesIndexer-1178"><span class="linenos">1178</span></a>        <span class="n">counts_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="SpeciesIndexer-1179"><a href="#SpeciesIndexer-1179"><span class="linenos">1179</span></a>        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">set_species</span><span class="p">,</span> <span class="n">counts</span><span class="p">):</span>
</span><span id="SpeciesIndexer-1180"><a href="#SpeciesIndexer-1180"><span class="linenos">1180</span></a>            <span class="k">if</span> <span class="n">s</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="SpeciesIndexer-1181"><a href="#SpeciesIndexer-1181"><span class="linenos">1181</span></a>                <span class="k">continue</span>
</span><span id="SpeciesIndexer-1182"><a href="#SpeciesIndexer-1182"><span class="linenos">1182</span></a>            <span class="n">counts_dict</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span>
</span><span id="SpeciesIndexer-1183"><a href="#SpeciesIndexer-1183"><span class="linenos">1183</span></a>            <span class="k">if</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="n">sizes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
</span><span id="SpeciesIndexer-1184"><a href="#SpeciesIndexer-1184"><span class="linenos">1184</span></a>                <span class="n">up_sizes</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="SpeciesIndexer-1185"><a href="#SpeciesIndexer-1185"><span class="linenos">1185</span></a>                <span class="n">new_sizes</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span> <span class="o">+</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;add_atoms&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_atoms</span><span class="p">)</span>
</span><span id="SpeciesIndexer-1186"><a href="#SpeciesIndexer-1186"><span class="linenos">1186</span></a>
</span><span id="SpeciesIndexer-1187"><a href="#SpeciesIndexer-1187"><span class="linenos">1187</span></a>        <span class="n">new_sizes</span> <span class="o">=</span> <span class="n">FrozenDict</span><span class="p">(</span><span class="n">new_sizes</span><span class="p">)</span>
</span><span id="SpeciesIndexer-1188"><a href="#SpeciesIndexer-1188"><span class="linenos">1188</span></a>        <span class="k">if</span> <span class="n">up_sizes</span><span class="p">:</span>
</span><span id="SpeciesIndexer-1189"><a href="#SpeciesIndexer-1189"><span class="linenos">1189</span></a>            <span class="n">state_up</span><span class="p">[</span><span class="s2">&quot;sizes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_sizes</span><span class="p">,</span> <span class="n">sizes</span><span class="p">)</span>
</span><span id="SpeciesIndexer-1190"><a href="#SpeciesIndexer-1190"><span class="linenos">1190</span></a>            <span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;sizes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_sizes</span>
</span><span id="SpeciesIndexer-1191"><a href="#SpeciesIndexer-1191"><span class="linenos">1191</span></a>
</span><span id="SpeciesIndexer-1192"><a href="#SpeciesIndexer-1192"><span class="linenos">1192</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_order</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SpeciesIndexer-1193"><a href="#SpeciesIndexer-1193"><span class="linenos">1193</span></a>            <span class="n">species_order</span> <span class="o">=</span> <span class="p">[</span><span class="n">el</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_order</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>
</span><span id="SpeciesIndexer-1194"><a href="#SpeciesIndexer-1194"><span class="linenos">1194</span></a>            <span class="n">max_size_prev</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_size&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="SpeciesIndexer-1195"><a href="#SpeciesIndexer-1195"><span class="linenos">1195</span></a>            <span class="n">max_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">new_sizes</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span><span id="SpeciesIndexer-1196"><a href="#SpeciesIndexer-1196"><span class="linenos">1196</span></a>            <span class="k">if</span> <span class="n">max_size</span> <span class="o">&gt;</span> <span class="n">max_size_prev</span><span class="p">:</span>
</span><span id="SpeciesIndexer-1197"><a href="#SpeciesIndexer-1197"><span class="linenos">1197</span></a>                <span class="n">state_up</span><span class="p">[</span><span class="s2">&quot;max_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_size</span><span class="p">,</span> <span class="n">max_size_prev</span><span class="p">)</span>
</span><span id="SpeciesIndexer-1198"><a href="#SpeciesIndexer-1198"><span class="linenos">1198</span></a>                <span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;max_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_size</span>
</span><span id="SpeciesIndexer-1199"><a href="#SpeciesIndexer-1199"><span class="linenos">1199</span></a>                <span class="n">max_size_prev</span> <span class="o">=</span> <span class="n">max_size</span>
</span><span id="SpeciesIndexer-1200"><a href="#SpeciesIndexer-1200"><span class="linenos">1200</span></a>
</span><span id="SpeciesIndexer-1201"><a href="#SpeciesIndexer-1201"><span class="linenos">1201</span></a>            <span class="n">species_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">species_order</span><span class="p">),</span> <span class="n">max_size</span><span class="p">),</span> <span class="n">nat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="SpeciesIndexer-1202"><a href="#SpeciesIndexer-1202"><span class="linenos">1202</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">el</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">species_order</span><span class="p">):</span>
</span><span id="SpeciesIndexer-1203"><a href="#SpeciesIndexer-1203"><span class="linenos">1203</span></a>                <span class="n">s</span> <span class="o">=</span> <span class="n">PERIODIC_TABLE_REV_IDX</span><span class="p">[</span><span class="n">el</span><span class="p">]</span>
</span><span id="SpeciesIndexer-1204"><a href="#SpeciesIndexer-1204"><span class="linenos">1204</span></a>                <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">counts_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="SpeciesIndexer-1205"><a href="#SpeciesIndexer-1205"><span class="linenos">1205</span></a>                    <span class="n">species_index</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:</span> <span class="n">counts_dict</span><span class="p">[</span><span class="n">s</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">species</span> <span class="o">==</span> <span class="n">s</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="SpeciesIndexer-1206"><a href="#SpeciesIndexer-1206"><span class="linenos">1206</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SpeciesIndexer-1207"><a href="#SpeciesIndexer-1207"><span class="linenos">1207</span></a>            <span class="n">species_index</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="SpeciesIndexer-1208"><a href="#SpeciesIndexer-1208"><span class="linenos">1208</span></a>                <span class="n">PERIODIC_TABLE</span><span class="p">[</span><span class="n">s</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">nat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="SpeciesIndexer-1209"><a href="#SpeciesIndexer-1209"><span class="linenos">1209</span></a>                <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">new_sizes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="SpeciesIndexer-1210"><a href="#SpeciesIndexer-1210"><span class="linenos">1210</span></a>            <span class="p">}</span>
</span><span id="SpeciesIndexer-1211"><a href="#SpeciesIndexer-1211"><span class="linenos">1211</span></a>            <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">set_species</span><span class="p">,</span> <span class="n">counts</span><span class="p">):</span>
</span><span id="SpeciesIndexer-1212"><a href="#SpeciesIndexer-1212"><span class="linenos">1212</span></a>                <span class="k">if</span> <span class="n">s</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="SpeciesIndexer-1213"><a href="#SpeciesIndexer-1213"><span class="linenos">1213</span></a>                    <span class="k">continue</span>
</span><span id="SpeciesIndexer-1214"><a href="#SpeciesIndexer-1214"><span class="linenos">1214</span></a>                <span class="n">species_index</span><span class="p">[</span><span class="n">PERIODIC_TABLE</span><span class="p">[</span><span class="n">s</span><span class="p">]][:</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">species</span> <span class="o">==</span> <span class="n">s</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="SpeciesIndexer-1215"><a href="#SpeciesIndexer-1215"><span class="linenos">1215</span></a>
</span><span id="SpeciesIndexer-1216"><a href="#SpeciesIndexer-1216"><span class="linenos">1216</span></a>        <span class="n">output</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="SpeciesIndexer-1217"><a href="#SpeciesIndexer-1217"><span class="linenos">1217</span></a>            <span class="o">**</span><span class="n">inputs</span><span class="p">,</span>
</span><span id="SpeciesIndexer-1218"><a href="#SpeciesIndexer-1218"><span class="linenos">1218</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">output_key</span><span class="p">:</span> <span class="n">species_index</span><span class="p">,</span>
</span><span id="SpeciesIndexer-1219"><a href="#SpeciesIndexer-1219"><span class="linenos">1219</span></a>        <span class="p">}</span>
</span><span id="SpeciesIndexer-1220"><a href="#SpeciesIndexer-1220"><span class="linenos">1220</span></a>
</span><span id="SpeciesIndexer-1221"><a href="#SpeciesIndexer-1221"><span class="linenos">1221</span></a>        <span class="k">if</span> <span class="n">return_state_update</span><span class="p">:</span>
</span><span id="SpeciesIndexer-1222"><a href="#SpeciesIndexer-1222"><span class="linenos">1222</span></a>            <span class="k">return</span> <span class="n">FrozenDict</span><span class="p">(</span><span class="n">new_state</span><span class="p">),</span> <span class="n">output</span><span class="p">,</span> <span class="n">state_up</span>
</span><span id="SpeciesIndexer-1223"><a href="#SpeciesIndexer-1223"><span class="linenos">1223</span></a>        <span class="k">return</span> <span class="n">FrozenDict</span><span class="p">(</span><span class="n">new_state</span><span class="p">),</span> <span class="n">output</span>
</span><span id="SpeciesIndexer-1224"><a href="#SpeciesIndexer-1224"><span class="linenos">1224</span></a>
</span><span id="SpeciesIndexer-1225"><a href="#SpeciesIndexer-1225"><span class="linenos">1225</span></a>    <span class="k">def</span> <span class="nf">check_reallocate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">parent_overflow</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="SpeciesIndexer-1226"><a href="#SpeciesIndexer-1226"><span class="linenos">1226</span></a>        <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="p">{},</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">parent_overflow</span>
</span><span id="SpeciesIndexer-1227"><a href="#SpeciesIndexer-1227"><span class="linenos">1227</span></a>
</span><span id="SpeciesIndexer-1228"><a href="#SpeciesIndexer-1228"><span class="linenos">1228</span></a>    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="SpeciesIndexer-1229"><a href="#SpeciesIndexer-1229"><span class="linenos">1229</span></a>    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
</span><span id="SpeciesIndexer-1230"><a href="#SpeciesIndexer-1230"><span class="linenos">1230</span></a>        <span class="k">assert</span> <span class="p">(</span>
</span><span id="SpeciesIndexer-1231"><a href="#SpeciesIndexer-1231"><span class="linenos">1231</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">output_key</span> <span class="ow">in</span> <span class="n">inputs</span>
</span><span id="SpeciesIndexer-1232"><a href="#SpeciesIndexer-1232"><span class="linenos">1232</span></a>        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Species Index </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output_key</span><span class="si">}</span><span class="s2"> must be provided on accelerator. Call the numpy routine (self.__call__) first.&quot;</span>
</span><span id="SpeciesIndexer-1233"><a href="#SpeciesIndexer-1233"><span class="linenos">1233</span></a>
</span><span id="SpeciesIndexer-1234"><a href="#SpeciesIndexer-1234"><span class="linenos">1234</span></a>        <span class="k">return</span> <span class="n">inputs</span>
</span><span id="SpeciesIndexer-1235"><a href="#SpeciesIndexer-1235"><span class="linenos">1235</span></a>
</span><span id="SpeciesIndexer-1236"><a href="#SpeciesIndexer-1236"><span class="linenos">1236</span></a>    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
</span><span id="SpeciesIndexer-1237"><a href="#SpeciesIndexer-1237"><span class="linenos">1237</span></a>    <span class="k">def</span> <span class="nf">update_skin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
</span><span id="SpeciesIndexer-1238"><a href="#SpeciesIndexer-1238"><span class="linenos">1238</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Build an index that splits atomic arrays by species.</p>

<p>If <code><a href="#SpeciesIndexer.species_order">species_order</a></code> is specified, the output will be a dense array with size (len(species_order), max_size) that can directly index atomic arrays.
If <code><a href="#SpeciesIndexer.species_order">species_order</a></code> is None, the output will be a dictionary with species as keys and an index to filter atomic arrays for that species as values.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>output_key</strong> (str, default="species_index"):
Key for the output dictionary.</li>
<li><strong>species_order</strong> (str, default=None):
Comma separated list of species in the order they should be indexed.</li>
</ul>
</div>


                            <div id="SpeciesIndexer.__init__" class="classattr">
                                <div class="attr function">
            
        <span class="name">SpeciesIndexer</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">output_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;species_index&#39;</span>,</span><span class="param">	<span class="n">species_order</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">add_atoms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span></span>)</span>

        
    </div>
    <a class="headerlink" href="#SpeciesIndexer.__init__"></a>
    
    

                            </div>
                            <div id="SpeciesIndexer.output_key" class="classattr">
                                <div class="attr variable">
            <span class="name">output_key</span><span class="annotation">: str</span>        =
<span class="default_value">&#39;species_index&#39;</span>

        
    </div>
    <a class="headerlink" href="#SpeciesIndexer.output_key"></a>
    
    

                            </div>
                            <div id="SpeciesIndexer.species_order" class="classattr">
                                <div class="attr variable">
            <span class="name">species_order</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#SpeciesIndexer.species_order"></a>
    
    

                            </div>
                            <div id="SpeciesIndexer.add_atoms" class="classattr">
                                <div class="attr variable">
            <span class="name">add_atoms</span><span class="annotation">: int</span>        =
<span class="default_value">0</span>

        
    </div>
    <a class="headerlink" href="#SpeciesIndexer.add_atoms"></a>
    
    

                            </div>
                            <div id="SpeciesIndexer.init" class="classattr">
                                        <input id="SpeciesIndexer.init-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">init</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SpeciesIndexer.init-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SpeciesIndexer.init"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SpeciesIndexer.init-1160"><a href="#SpeciesIndexer.init-1160"><span class="linenos">1160</span></a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="SpeciesIndexer.init-1161"><a href="#SpeciesIndexer.init-1161"><span class="linenos">1161</span></a>        <span class="k">return</span> <span class="n">FrozenDict</span><span class="p">(</span>
</span><span id="SpeciesIndexer.init-1162"><a href="#SpeciesIndexer.init-1162"><span class="linenos">1162</span></a>            <span class="p">{</span>
</span><span id="SpeciesIndexer.init-1163"><a href="#SpeciesIndexer.init-1163"><span class="linenos">1163</span></a>                <span class="s2">&quot;sizes&quot;</span><span class="p">:</span> <span class="p">{},</span>
</span><span id="SpeciesIndexer.init-1164"><a href="#SpeciesIndexer.init-1164"><span class="linenos">1164</span></a>            <span class="p">}</span>
</span><span id="SpeciesIndexer.init-1165"><a href="#SpeciesIndexer.init-1165"><span class="linenos">1165</span></a>        <span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="SpeciesIndexer.check_reallocate" class="classattr">
                                        <input id="SpeciesIndexer.check_reallocate-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">check_reallocate</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">state</span>, </span><span class="param"><span class="n">inputs</span>, </span><span class="param"><span class="n">parent_overflow</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SpeciesIndexer.check_reallocate-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SpeciesIndexer.check_reallocate"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SpeciesIndexer.check_reallocate-1225"><a href="#SpeciesIndexer.check_reallocate-1225"><span class="linenos">1225</span></a>    <span class="k">def</span> <span class="nf">check_reallocate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">parent_overflow</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="SpeciesIndexer.check_reallocate-1226"><a href="#SpeciesIndexer.check_reallocate-1226"><span class="linenos">1226</span></a>        <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="p">{},</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">parent_overflow</span>
</span></pre></div>


    

                            </div>
                            <div id="SpeciesIndexer.process" class="classattr">
                                        <input id="SpeciesIndexer.process-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@partial(jax.jit, static_argnums=(0, 1))</div>

        <span class="def">def</span>
        <span class="name">process</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">state</span>, </span><span class="param"><span class="n">inputs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SpeciesIndexer.process-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SpeciesIndexer.process"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SpeciesIndexer.process-1228"><a href="#SpeciesIndexer.process-1228"><span class="linenos">1228</span></a>    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="SpeciesIndexer.process-1229"><a href="#SpeciesIndexer.process-1229"><span class="linenos">1229</span></a>    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
</span><span id="SpeciesIndexer.process-1230"><a href="#SpeciesIndexer.process-1230"><span class="linenos">1230</span></a>        <span class="k">assert</span> <span class="p">(</span>
</span><span id="SpeciesIndexer.process-1231"><a href="#SpeciesIndexer.process-1231"><span class="linenos">1231</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">output_key</span> <span class="ow">in</span> <span class="n">inputs</span>
</span><span id="SpeciesIndexer.process-1232"><a href="#SpeciesIndexer.process-1232"><span class="linenos">1232</span></a>        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Species Index </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output_key</span><span class="si">}</span><span class="s2"> must be provided on accelerator. Call the numpy routine (self.__call__) first.&quot;</span>
</span><span id="SpeciesIndexer.process-1233"><a href="#SpeciesIndexer.process-1233"><span class="linenos">1233</span></a>
</span><span id="SpeciesIndexer.process-1234"><a href="#SpeciesIndexer.process-1234"><span class="linenos">1234</span></a>        <span class="k">return</span> <span class="n">inputs</span>
</span></pre></div>


    

                            </div>
                            <div id="SpeciesIndexer.update_skin" class="classattr">
                                        <input id="SpeciesIndexer.update_skin-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@partial(jax.jit, static_argnums=(0,))</div>

        <span class="def">def</span>
        <span class="name">update_skin</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">inputs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SpeciesIndexer.update_skin-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SpeciesIndexer.update_skin"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SpeciesIndexer.update_skin-1236"><a href="#SpeciesIndexer.update_skin-1236"><span class="linenos">1236</span></a>    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
</span><span id="SpeciesIndexer.update_skin-1237"><a href="#SpeciesIndexer.update_skin-1237"><span class="linenos">1237</span></a>    <span class="k">def</span> <span class="nf">update_skin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
</span><span id="SpeciesIndexer.update_skin-1238"><a href="#SpeciesIndexer.update_skin-1238"><span class="linenos">1238</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                </section>
                <section id="AtomPadding">
                            <input id="AtomPadding-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
                    <div class="decorator">@dataclasses.dataclass(frozen=True)</div>

    <span class="def">class</span>
    <span class="name">AtomPadding</span>:

                <label class="view-source-button" for="AtomPadding-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AtomPadding"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AtomPadding-1241"><a href="#AtomPadding-1241"><span class="linenos">1241</span></a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="AtomPadding-1242"><a href="#AtomPadding-1242"><span class="linenos">1242</span></a><span class="k">class</span> <span class="nc">AtomPadding</span><span class="p">:</span>
</span><span id="AtomPadding-1243"><a href="#AtomPadding-1243"><span class="linenos">1243</span></a>    <span class="n">mult_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.2</span>
</span><span id="AtomPadding-1244"><a href="#AtomPadding-1244"><span class="linenos">1244</span></a>
</span><span id="AtomPadding-1245"><a href="#AtomPadding-1245"><span class="linenos">1245</span></a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="AtomPadding-1246"><a href="#AtomPadding-1246"><span class="linenos">1246</span></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;prev_nat&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
</span><span id="AtomPadding-1247"><a href="#AtomPadding-1247"><span class="linenos">1247</span></a>
</span><span id="AtomPadding-1248"><a href="#AtomPadding-1248"><span class="linenos">1248</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">]:</span>
</span><span id="AtomPadding-1249"><a href="#AtomPadding-1249"><span class="linenos">1249</span></a>        <span class="n">species</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">]</span>
</span><span id="AtomPadding-1250"><a href="#AtomPadding-1250"><span class="linenos">1250</span></a>        <span class="n">nat</span> <span class="o">=</span> <span class="n">species</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="AtomPadding-1251"><a href="#AtomPadding-1251"><span class="linenos">1251</span></a>
</span><span id="AtomPadding-1252"><a href="#AtomPadding-1252"><span class="linenos">1252</span></a>        <span class="n">prev_nat</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prev_nat&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="AtomPadding-1253"><a href="#AtomPadding-1253"><span class="linenos">1253</span></a>        <span class="n">prev_nat_</span> <span class="o">=</span> <span class="n">prev_nat</span>
</span><span id="AtomPadding-1254"><a href="#AtomPadding-1254"><span class="linenos">1254</span></a>        <span class="k">if</span> <span class="n">nat</span> <span class="o">&gt;</span> <span class="n">prev_nat_</span><span class="p">:</span>
</span><span id="AtomPadding-1255"><a href="#AtomPadding-1255"><span class="linenos">1255</span></a>            <span class="n">prev_nat_</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mult_size</span> <span class="o">*</span> <span class="n">nat</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="AtomPadding-1256"><a href="#AtomPadding-1256"><span class="linenos">1256</span></a>
</span><span id="AtomPadding-1257"><a href="#AtomPadding-1257"><span class="linenos">1257</span></a>        <span class="n">nsys</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;natoms&quot;</span><span class="p">])</span>
</span><span id="AtomPadding-1258"><a href="#AtomPadding-1258"><span class="linenos">1258</span></a>
</span><span id="AtomPadding-1259"><a href="#AtomPadding-1259"><span class="linenos">1259</span></a>        <span class="n">add_atoms</span> <span class="o">=</span> <span class="n">prev_nat_</span> <span class="o">-</span> <span class="n">nat</span>
</span><span id="AtomPadding-1260"><a href="#AtomPadding-1260"><span class="linenos">1260</span></a>        <span class="n">output</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">inputs</span><span class="p">}</span>
</span><span id="AtomPadding-1261"><a href="#AtomPadding-1261"><span class="linenos">1261</span></a>        <span class="k">if</span> <span class="n">add_atoms</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="AtomPadding-1262"><a href="#AtomPadding-1262"><span class="linenos">1262</span></a>            <span class="n">batch_index</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;batch_index&quot;</span><span class="p">]</span>
</span><span id="AtomPadding-1263"><a href="#AtomPadding-1263"><span class="linenos">1263</span></a>            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="AtomPadding-1264"><a href="#AtomPadding-1264"><span class="linenos">1264</span></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
</span><span id="AtomPadding-1265"><a href="#AtomPadding-1265"><span class="linenos">1265</span></a>                    <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">nat</span><span class="p">:</span>
</span><span id="AtomPadding-1266"><a href="#AtomPadding-1266"><span class="linenos">1266</span></a>                        <span class="n">output</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="AtomPadding-1267"><a href="#AtomPadding-1267"><span class="linenos">1267</span></a>                            <span class="n">v</span><span class="p">,</span>
</span><span id="AtomPadding-1268"><a href="#AtomPadding-1268"><span class="linenos">1268</span></a>                            <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">add_atoms</span><span class="p">,</span> <span class="o">*</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
</span><span id="AtomPadding-1269"><a href="#AtomPadding-1269"><span class="linenos">1269</span></a>                            <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="AtomPadding-1270"><a href="#AtomPadding-1270"><span class="linenos">1270</span></a>                        <span class="p">)</span>
</span><span id="AtomPadding-1271"><a href="#AtomPadding-1271"><span class="linenos">1271</span></a>                    <span class="k">elif</span> <span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">nsys</span><span class="p">:</span>
</span><span id="AtomPadding-1272"><a href="#AtomPadding-1272"><span class="linenos">1272</span></a>                        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;cells&quot;</span><span class="p">:</span>
</span><span id="AtomPadding-1273"><a href="#AtomPadding-1273"><span class="linenos">1273</span></a>                            <span class="n">output</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="AtomPadding-1274"><a href="#AtomPadding-1274"><span class="linenos">1274</span></a>                                <span class="n">v</span><span class="p">,</span>
</span><span id="AtomPadding-1275"><a href="#AtomPadding-1275"><span class="linenos">1275</span></a>                                <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">dtype</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span>
</span><span id="AtomPadding-1276"><a href="#AtomPadding-1276"><span class="linenos">1276</span></a>                                <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="AtomPadding-1277"><a href="#AtomPadding-1277"><span class="linenos">1277</span></a>                            <span class="p">)</span>
</span><span id="AtomPadding-1278"><a href="#AtomPadding-1278"><span class="linenos">1278</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="AtomPadding-1279"><a href="#AtomPadding-1279"><span class="linenos">1279</span></a>                            <span class="n">output</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="AtomPadding-1280"><a href="#AtomPadding-1280"><span class="linenos">1280</span></a>                                <span class="n">v</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
</span><span id="AtomPadding-1281"><a href="#AtomPadding-1281"><span class="linenos">1281</span></a>                            <span class="p">)</span>
</span><span id="AtomPadding-1282"><a href="#AtomPadding-1282"><span class="linenos">1282</span></a>            <span class="n">output</span><span class="p">[</span><span class="s2">&quot;natoms&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;natoms&quot;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="AtomPadding-1283"><a href="#AtomPadding-1283"><span class="linenos">1283</span></a>            <span class="n">output</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="AtomPadding-1284"><a href="#AtomPadding-1284"><span class="linenos">1284</span></a>                <span class="n">species</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">add_atoms</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">species</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="AtomPadding-1285"><a href="#AtomPadding-1285"><span class="linenos">1285</span></a>            <span class="p">)</span>
</span><span id="AtomPadding-1286"><a href="#AtomPadding-1286"><span class="linenos">1286</span></a>            <span class="n">output</span><span class="p">[</span><span class="s2">&quot;batch_index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="AtomPadding-1287"><a href="#AtomPadding-1287"><span class="linenos">1287</span></a>                <span class="n">batch_index</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">nsys</span><span class="p">]</span> <span class="o">*</span> <span class="n">add_atoms</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">batch_index</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="AtomPadding-1288"><a href="#AtomPadding-1288"><span class="linenos">1288</span></a>            <span class="p">)</span>
</span><span id="AtomPadding-1289"><a href="#AtomPadding-1289"><span class="linenos">1289</span></a>
</span><span id="AtomPadding-1290"><a href="#AtomPadding-1290"><span class="linenos">1290</span></a>        <span class="n">output</span><span class="p">[</span><span class="s2">&quot;true_atoms&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span id="AtomPadding-1291"><a href="#AtomPadding-1291"><span class="linenos">1291</span></a>        <span class="n">output</span><span class="p">[</span><span class="s2">&quot;true_sys&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s2">&quot;natoms&quot;</span><span class="p">]))</span> <span class="o">&lt;</span> <span class="n">nsys</span>
</span><span id="AtomPadding-1292"><a href="#AtomPadding-1292"><span class="linenos">1292</span></a>
</span><span id="AtomPadding-1293"><a href="#AtomPadding-1293"><span class="linenos">1293</span></a>        <span class="n">state</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">state</span><span class="p">,</span> <span class="s2">&quot;prev_nat&quot;</span><span class="p">:</span> <span class="n">prev_nat_</span><span class="p">}</span>
</span><span id="AtomPadding-1294"><a href="#AtomPadding-1294"><span class="linenos">1294</span></a>
</span><span id="AtomPadding-1295"><a href="#AtomPadding-1295"><span class="linenos">1295</span></a>        <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="n">output</span>
</span></pre></div>


    

                            <div id="AtomPadding.__init__" class="classattr">
                                <div class="attr function">
            
        <span class="name">AtomPadding</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">mult_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.2</span></span>)</span>

        
    </div>
    <a class="headerlink" href="#AtomPadding.__init__"></a>
    
    

                            </div>
                            <div id="AtomPadding.mult_size" class="classattr">
                                <div class="attr variable">
            <span class="name">mult_size</span><span class="annotation">: float</span>        =
<span class="default_value">1.2</span>

        
    </div>
    <a class="headerlink" href="#AtomPadding.mult_size"></a>
    
    

                            </div>
                            <div id="AtomPadding.init" class="classattr">
                                        <input id="AtomPadding.init-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">init</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AtomPadding.init-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AtomPadding.init"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AtomPadding.init-1245"><a href="#AtomPadding.init-1245"><span class="linenos">1245</span></a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="AtomPadding.init-1246"><a href="#AtomPadding.init-1246"><span class="linenos">1246</span></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;prev_nat&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
</span></pre></div>


    

                            </div>
                </section>
                <section id="atom_unpadding">
                            <input id="atom_unpadding-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">atom_unpadding</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">inputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="atom_unpadding-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#atom_unpadding"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="atom_unpadding-1298"><a href="#atom_unpadding-1298"><span class="linenos">1298</span></a><span class="k">def</span> <span class="nf">atom_unpadding</span><span class="p">(</span><span class="n">inputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="atom_unpadding-1299"><a href="#atom_unpadding-1299"><span class="linenos">1299</span></a>    <span class="k">if</span> <span class="s2">&quot;true_atoms&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
</span><span id="atom_unpadding-1300"><a href="#atom_unpadding-1300"><span class="linenos">1300</span></a>        <span class="k">return</span> <span class="n">inputs</span>
</span><span id="atom_unpadding-1301"><a href="#atom_unpadding-1301"><span class="linenos">1301</span></a>
</span><span id="atom_unpadding-1302"><a href="#atom_unpadding-1302"><span class="linenos">1302</span></a>    <span class="n">species</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">]</span>
</span><span id="atom_unpadding-1303"><a href="#atom_unpadding-1303"><span class="linenos">1303</span></a>    <span class="n">true_atoms</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;true_atoms&quot;</span><span class="p">]</span>
</span><span id="atom_unpadding-1304"><a href="#atom_unpadding-1304"><span class="linenos">1304</span></a>    <span class="n">true_sys</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;true_sys&quot;</span><span class="p">]</span>
</span><span id="atom_unpadding-1305"><a href="#atom_unpadding-1305"><span class="linenos">1305</span></a>    <span class="n">natall</span> <span class="o">=</span> <span class="n">species</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="atom_unpadding-1306"><a href="#atom_unpadding-1306"><span class="linenos">1306</span></a>    <span class="n">nat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">species</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="atom_unpadding-1307"><a href="#atom_unpadding-1307"><span class="linenos">1307</span></a>    <span class="k">if</span> <span class="n">nat</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="atom_unpadding-1308"><a href="#atom_unpadding-1308"><span class="linenos">1308</span></a>        <span class="k">return</span> <span class="n">inputs</span>
</span><span id="atom_unpadding-1309"><a href="#atom_unpadding-1309"><span class="linenos">1309</span></a>
</span><span id="atom_unpadding-1310"><a href="#atom_unpadding-1310"><span class="linenos">1310</span></a>    <span class="n">natoms</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;natoms&quot;</span><span class="p">]</span>
</span><span id="atom_unpadding-1311"><a href="#atom_unpadding-1311"><span class="linenos">1311</span></a>    <span class="n">nsysall</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">natoms</span><span class="p">)</span>
</span><span id="atom_unpadding-1312"><a href="#atom_unpadding-1312"><span class="linenos">1312</span></a>
</span><span id="atom_unpadding-1313"><a href="#atom_unpadding-1313"><span class="linenos">1313</span></a>    <span class="n">output</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">inputs</span><span class="p">}</span>
</span><span id="atom_unpadding-1314"><a href="#atom_unpadding-1314"><span class="linenos">1314</span></a>    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="atom_unpadding-1315"><a href="#atom_unpadding-1315"><span class="linenos">1315</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
</span><span id="atom_unpadding-1316"><a href="#atom_unpadding-1316"><span class="linenos">1316</span></a>            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="atom_unpadding-1317"><a href="#atom_unpadding-1317"><span class="linenos">1317</span></a>                <span class="k">continue</span>
</span><span id="atom_unpadding-1318"><a href="#atom_unpadding-1318"><span class="linenos">1318</span></a>            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">natall</span><span class="p">:</span>
</span><span id="atom_unpadding-1319"><a href="#atom_unpadding-1319"><span class="linenos">1319</span></a>                <span class="n">output</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">true_atoms</span><span class="p">]</span>
</span><span id="atom_unpadding-1320"><a href="#atom_unpadding-1320"><span class="linenos">1320</span></a>            <span class="k">elif</span> <span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">nsysall</span><span class="p">:</span>
</span><span id="atom_unpadding-1321"><a href="#atom_unpadding-1321"><span class="linenos">1321</span></a>                <span class="n">output</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">true_sys</span><span class="p">]</span>
</span><span id="atom_unpadding-1322"><a href="#atom_unpadding-1322"><span class="linenos">1322</span></a>    <span class="k">del</span> <span class="n">output</span><span class="p">[</span><span class="s2">&quot;true_sys&quot;</span><span class="p">]</span>
</span><span id="atom_unpadding-1323"><a href="#atom_unpadding-1323"><span class="linenos">1323</span></a>    <span class="k">del</span> <span class="n">output</span><span class="p">[</span><span class="s2">&quot;true_atoms&quot;</span><span class="p">]</span>
</span><span id="atom_unpadding-1324"><a href="#atom_unpadding-1324"><span class="linenos">1324</span></a>    <span class="k">return</span> <span class="n">output</span>
</span></pre></div>


    

                </section>
                <section id="check_input">
                            <input id="check_input-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">check_input</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">inputs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="check_input-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#check_input"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="check_input-1327"><a href="#check_input-1327"><span class="linenos">1327</span></a><span class="k">def</span> <span class="nf">check_input</span><span class="p">(</span><span class="n">inputs</span><span class="p">):</span>
</span><span id="check_input-1328"><a href="#check_input-1328"><span class="linenos">1328</span></a>    <span class="k">assert</span> <span class="s2">&quot;species&quot;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">,</span> <span class="s2">&quot;species must be provided&quot;</span>
</span><span id="check_input-1329"><a href="#check_input-1329"><span class="linenos">1329</span></a>    <span class="k">assert</span> <span class="s2">&quot;coordinates&quot;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">,</span> <span class="s2">&quot;coordinates must be provided&quot;</span>
</span><span id="check_input-1330"><a href="#check_input-1330"><span class="linenos">1330</span></a>    <span class="n">species</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="check_input-1331"><a href="#check_input-1331"><span class="linenos">1331</span></a>    <span class="n">ifake</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">species</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="check_input-1332"><a href="#check_input-1332"><span class="linenos">1332</span></a>    <span class="k">if</span> <span class="n">ifake</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="check_input-1333"><a href="#check_input-1333"><span class="linenos">1333</span></a>        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">species</span><span class="p">[:</span><span class="n">ifake</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;species must be positive&quot;</span>
</span><span id="check_input-1334"><a href="#check_input-1334"><span class="linenos">1334</span></a>    <span class="n">nat</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="check_input-1335"><a href="#check_input-1335"><span class="linenos">1335</span></a>
</span><span id="check_input-1336"><a href="#check_input-1336"><span class="linenos">1336</span></a>    <span class="n">natoms</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;natoms&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">nat</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="check_input-1337"><a href="#check_input-1337"><span class="linenos">1337</span></a>    <span class="n">batch_index</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span id="check_input-1338"><a href="#check_input-1338"><span class="linenos">1338</span></a>        <span class="s2">&quot;batch_index&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">natoms</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">natoms</span><span class="p">)</span>
</span><span id="check_input-1339"><a href="#check_input-1339"><span class="linenos">1339</span></a>    <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="check_input-1340"><a href="#check_input-1340"><span class="linenos">1340</span></a>    <span class="n">output</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="s2">&quot;natoms&quot;</span><span class="p">:</span> <span class="n">natoms</span><span class="p">,</span> <span class="s2">&quot;batch_index&quot;</span><span class="p">:</span> <span class="n">batch_index</span><span class="p">}</span>
</span><span id="check_input-1341"><a href="#check_input-1341"><span class="linenos">1341</span></a>    <span class="k">if</span> <span class="s2">&quot;cells&quot;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
</span><span id="check_input-1342"><a href="#check_input-1342"><span class="linenos">1342</span></a>        <span class="n">cells</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;cells&quot;</span><span class="p">]</span>
</span><span id="check_input-1343"><a href="#check_input-1343"><span class="linenos">1343</span></a>        <span class="k">if</span> <span class="s2">&quot;reciprocal_cells&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
</span><span id="check_input-1344"><a href="#check_input-1344"><span class="linenos">1344</span></a>            <span class="n">reciprocal_cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cells</span><span class="p">)</span>
</span><span id="check_input-1345"><a href="#check_input-1345"><span class="linenos">1345</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="check_input-1346"><a href="#check_input-1346"><span class="linenos">1346</span></a>            <span class="n">reciprocal_cells</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;reciprocal_cells&quot;</span><span class="p">]</span>
</span><span id="check_input-1347"><a href="#check_input-1347"><span class="linenos">1347</span></a>        <span class="k">if</span> <span class="n">cells</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="check_input-1348"><a href="#check_input-1348"><span class="linenos">1348</span></a>            <span class="n">cells</span> <span class="o">=</span> <span class="n">cells</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
</span><span id="check_input-1349"><a href="#check_input-1349"><span class="linenos">1349</span></a>        <span class="k">if</span> <span class="n">reciprocal_cells</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="check_input-1350"><a href="#check_input-1350"><span class="linenos">1350</span></a>            <span class="n">reciprocal_cells</span> <span class="o">=</span> <span class="n">reciprocal_cells</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
</span><span id="check_input-1351"><a href="#check_input-1351"><span class="linenos">1351</span></a>        <span class="n">output</span><span class="p">[</span><span class="s2">&quot;cells&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cells</span>
</span><span id="check_input-1352"><a href="#check_input-1352"><span class="linenos">1352</span></a>        <span class="n">output</span><span class="p">[</span><span class="s2">&quot;reciprocal_cells&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reciprocal_cells</span>
</span><span id="check_input-1353"><a href="#check_input-1353"><span class="linenos">1353</span></a>
</span><span id="check_input-1354"><a href="#check_input-1354"><span class="linenos">1354</span></a>    <span class="k">return</span> <span class="n">output</span>
</span></pre></div>


    

                </section>
                <section id="convert_to_jax">
                            <input id="convert_to_jax-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">convert_to_jax</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">data</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="convert_to_jax-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#convert_to_jax"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="convert_to_jax-1357"><a href="#convert_to_jax-1357"><span class="linenos">1357</span></a><span class="k">def</span> <span class="nf">convert_to_jax</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
</span><span id="convert_to_jax-1358"><a href="#convert_to_jax-1358"><span class="linenos">1358</span></a>    <span class="k">def</span> <span class="nf">convert</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span id="convert_to_jax-1359"><a href="#convert_to_jax-1359"><span class="linenos">1359</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
</span><span id="convert_to_jax-1360"><a href="#convert_to_jax-1360"><span class="linenos">1360</span></a>            <span class="c1"># if x.dtype == np.float64:</span>
</span><span id="convert_to_jax-1361"><a href="#convert_to_jax-1361"><span class="linenos">1361</span></a>            <span class="c1">#     return jnp.asarray(x, dtype=jnp.float32)</span>
</span><span id="convert_to_jax-1362"><a href="#convert_to_jax-1362"><span class="linenos">1362</span></a>            <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="convert_to_jax-1363"><a href="#convert_to_jax-1363"><span class="linenos">1363</span></a>        <span class="k">return</span> <span class="n">x</span>
</span><span id="convert_to_jax-1364"><a href="#convert_to_jax-1364"><span class="linenos">1364</span></a>
</span><span id="convert_to_jax-1365"><a href="#convert_to_jax-1365"><span class="linenos">1365</span></a>    <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">tree_util</span><span class="o">.</span><span class="n">tree_map</span><span class="p">(</span><span class="n">convert</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></pre></div>


    

                </section>
                <section id="JaxConverter">
                            <input id="JaxConverter-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">JaxConverter</span><wbr>(<span class="base">flax.linen.module.Module</span>):

                <label class="view-source-button" for="JaxConverter-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#JaxConverter"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="JaxConverter-1368"><a href="#JaxConverter-1368"><span class="linenos">1368</span></a><span class="k">class</span> <span class="nc">JaxConverter</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="JaxConverter-1369"><a href="#JaxConverter-1369"><span class="linenos">1369</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span><span id="JaxConverter-1370"><a href="#JaxConverter-1370"><span class="linenos">1370</span></a>        <span class="k">return</span> <span class="n">convert_to_jax</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></pre></div>


    

                            <div id="JaxConverter.__init__" class="classattr">
                                <div class="attr function">
            
        <span class="name">JaxConverter</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">parent</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">flax</span><span class="o">.</span><span class="n">linen</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">Module</span><span class="p">],</span> <span class="n">flax</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">Scope</span><span class="p">,</span> <span class="n">Type</span><span class="p">[</span><span class="n">flax</span><span class="o">.</span><span class="n">linen</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">_Sentinel</span><span class="p">],</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">flax</span><span class="o">.</span><span class="n">linen</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">_Sentinel</span> <span class="nb">object</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

        
    </div>
    <a class="headerlink" href="#JaxConverter.__init__"></a>
    
    

                            </div>
                            <div id="JaxConverter.parent" class="classattr">
                                <div class="attr variable">
            <span class="name">parent</span><span class="annotation">: Union[Type[flax.linen.module.Module], flax.core.scope.Scope, Type[flax.linen.module._Sentinel], NoneType]</span>

        
    </div>
    <a class="headerlink" href="#JaxConverter.parent"></a>
    
            <div class="docstring"><p>Wraps parent module references in weak refs.</p>

<p>This prevents reference cycles from forming via parent links which can lead
to accidental OOMs in eager mode due to slow garbage collection as well as
spurious tracer leaks during jit compilation.</p>

<p>Note: "descriptors" are the underlying python mechanism for implementing
dynamic @property decorators.  We need to use a raw descriptor instead of the
more common decorator in order to force that the appropriate getter/setter
logic applies in subclasses even after various dataclass transforms.</p>
</div>


                            </div>
                            <div id="JaxConverter.name" class="classattr">
                                <div class="attr variable">
            <span class="name">name</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#JaxConverter.name"></a>
    
    

                            </div>
                            <div id="JaxConverter.scope" class="classattr">
                                <div class="attr variable">
            <span class="name">scope</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#JaxConverter.scope"></a>
    
    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>flax.linen.module.Module</dt>
                                <dd id="JaxConverter.setup" class="function">setup</dd>
                <dd id="JaxConverter.path" class="variable">path</dd>
                <dd id="JaxConverter.clone" class="function">clone</dd>
                <dd id="JaxConverter.copy" class="function">copy</dd>
                <dd id="JaxConverter.variable" class="function">variable</dd>
                <dd id="JaxConverter.param" class="function">param</dd>
                <dd id="JaxConverter.has_variable" class="function">has_variable</dd>
                <dd id="JaxConverter.is_mutable_collection" class="function">is_mutable_collection</dd>
                <dd id="JaxConverter.has_rng" class="function">has_rng</dd>
                <dd id="JaxConverter.make_rng" class="function">make_rng</dd>
                <dd id="JaxConverter.is_initializing" class="function">is_initializing</dd>
                <dd id="JaxConverter.bind" class="function">bind</dd>
                <dd id="JaxConverter.unbind" class="function">unbind</dd>
                <dd id="JaxConverter.apply" class="function">apply</dd>
                <dd id="JaxConverter.init_with_output" class="function">init_with_output</dd>
                <dd id="JaxConverter.init" class="function">init</dd>
                <dd id="JaxConverter.lazy_init" class="function">lazy_init</dd>
                <dd id="JaxConverter.variables" class="variable">variables</dd>
                <dd id="JaxConverter.get_variable" class="function">get_variable</dd>
                <dd id="JaxConverter.put_variable" class="function">put_variable</dd>
                <dd id="JaxConverter.sow" class="function">sow</dd>
                <dd id="JaxConverter.perturb" class="function">perturb</dd>
                <dd id="JaxConverter.tabulate" class="function">tabulate</dd>
                <dd id="JaxConverter.module_paths" class="function">module_paths</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="PreprocessingChain">
                            <input id="PreprocessingChain-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
                    <div class="decorator">@dataclasses.dataclass(frozen=True)</div>

    <span class="def">class</span>
    <span class="name">PreprocessingChain</span>:

                <label class="view-source-button" for="PreprocessingChain-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PreprocessingChain"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PreprocessingChain-1373"><a href="#PreprocessingChain-1373"><span class="linenos">1373</span></a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PreprocessingChain-1374"><a href="#PreprocessingChain-1374"><span class="linenos">1374</span></a><span class="k">class</span> <span class="nc">PreprocessingChain</span><span class="p">:</span>
</span><span id="PreprocessingChain-1375"><a href="#PreprocessingChain-1375"><span class="linenos">1375</span></a>    <span class="n">layers</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span>
</span><span id="PreprocessingChain-1376"><a href="#PreprocessingChain-1376"><span class="linenos">1376</span></a>    <span class="n">use_atom_padding</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="PreprocessingChain-1377"><a href="#PreprocessingChain-1377"><span class="linenos">1377</span></a>    <span class="n">atom_padder</span><span class="p">:</span> <span class="n">AtomPadding</span> <span class="o">=</span> <span class="n">AtomPadding</span><span class="p">()</span>
</span><span id="PreprocessingChain-1378"><a href="#PreprocessingChain-1378"><span class="linenos">1378</span></a>
</span><span id="PreprocessingChain-1379"><a href="#PreprocessingChain-1379"><span class="linenos">1379</span></a>    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="PreprocessingChain-1380"><a href="#PreprocessingChain-1380"><span class="linenos">1380</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">):</span>
</span><span id="PreprocessingChain-1381"><a href="#PreprocessingChain-1381"><span class="linenos">1381</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="PreprocessingChain-1382"><a href="#PreprocessingChain-1382"><span class="linenos">1382</span></a>                <span class="sa">f</span><span class="s2">&quot;&#39;layers&#39; must be a sequence, got &#39;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
</span><span id="PreprocessingChain-1383"><a href="#PreprocessingChain-1383"><span class="linenos">1383</span></a>            <span class="p">)</span>
</span><span id="PreprocessingChain-1384"><a href="#PreprocessingChain-1384"><span class="linenos">1384</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
</span><span id="PreprocessingChain-1385"><a href="#PreprocessingChain-1385"><span class="linenos">1385</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: no Preprocessing layers were provided.&quot;</span><span class="p">)</span>
</span><span id="PreprocessingChain-1386"><a href="#PreprocessingChain-1386"><span class="linenos">1386</span></a>
</span><span id="PreprocessingChain-1387"><a href="#PreprocessingChain-1387"><span class="linenos">1387</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="PreprocessingChain-1388"><a href="#PreprocessingChain-1388"><span class="linenos">1388</span></a>        <span class="n">do_check_input</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;check_input&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="PreprocessingChain-1389"><a href="#PreprocessingChain-1389"><span class="linenos">1389</span></a>        <span class="k">if</span> <span class="n">do_check_input</span><span class="p">:</span>
</span><span id="PreprocessingChain-1390"><a href="#PreprocessingChain-1390"><span class="linenos">1390</span></a>            <span class="n">inputs</span> <span class="o">=</span> <span class="n">check_input</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
</span><span id="PreprocessingChain-1391"><a href="#PreprocessingChain-1391"><span class="linenos">1391</span></a>        <span class="n">new_state</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="PreprocessingChain-1392"><a href="#PreprocessingChain-1392"><span class="linenos">1392</span></a>        <span class="n">layer_state</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;layers_state&quot;</span><span class="p">]</span>
</span><span id="PreprocessingChain-1393"><a href="#PreprocessingChain-1393"><span class="linenos">1393</span></a>        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="PreprocessingChain-1394"><a href="#PreprocessingChain-1394"><span class="linenos">1394</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_atom_padding</span><span class="p">:</span>
</span><span id="PreprocessingChain-1395"><a href="#PreprocessingChain-1395"><span class="linenos">1395</span></a>            <span class="n">s</span><span class="p">,</span> <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom_padder</span><span class="p">(</span><span class="n">layer_state</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">inputs</span><span class="p">)</span>
</span><span id="PreprocessingChain-1396"><a href="#PreprocessingChain-1396"><span class="linenos">1396</span></a>            <span class="n">new_state</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span><span id="PreprocessingChain-1397"><a href="#PreprocessingChain-1397"><span class="linenos">1397</span></a>            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="PreprocessingChain-1398"><a href="#PreprocessingChain-1398"><span class="linenos">1398</span></a>        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
</span><span id="PreprocessingChain-1399"><a href="#PreprocessingChain-1399"><span class="linenos">1399</span></a>            <span class="n">s</span><span class="p">,</span> <span class="n">inputs</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">layer_state</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">return_state_update</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="PreprocessingChain-1400"><a href="#PreprocessingChain-1400"><span class="linenos">1400</span></a>            <span class="n">new_state</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span><span id="PreprocessingChain-1401"><a href="#PreprocessingChain-1401"><span class="linenos">1401</span></a>            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="PreprocessingChain-1402"><a href="#PreprocessingChain-1402"><span class="linenos">1402</span></a>        <span class="k">return</span> <span class="n">FrozenDict</span><span class="p">({</span><span class="o">**</span><span class="n">state</span><span class="p">,</span> <span class="s2">&quot;layers_state&quot;</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">new_state</span><span class="p">)}),</span> <span class="n">convert_to_jax</span><span class="p">(</span>
</span><span id="PreprocessingChain-1403"><a href="#PreprocessingChain-1403"><span class="linenos">1403</span></a>            <span class="n">inputs</span>
</span><span id="PreprocessingChain-1404"><a href="#PreprocessingChain-1404"><span class="linenos">1404</span></a>        <span class="p">)</span>
</span><span id="PreprocessingChain-1405"><a href="#PreprocessingChain-1405"><span class="linenos">1405</span></a>
</span><span id="PreprocessingChain-1406"><a href="#PreprocessingChain-1406"><span class="linenos">1406</span></a>    <span class="k">def</span> <span class="nf">check_reallocate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
</span><span id="PreprocessingChain-1407"><a href="#PreprocessingChain-1407"><span class="linenos">1407</span></a>        <span class="n">new_state</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="PreprocessingChain-1408"><a href="#PreprocessingChain-1408"><span class="linenos">1408</span></a>        <span class="n">state_up</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="PreprocessingChain-1409"><a href="#PreprocessingChain-1409"><span class="linenos">1409</span></a>        <span class="n">layer_state</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;layers_state&quot;</span><span class="p">]</span>
</span><span id="PreprocessingChain-1410"><a href="#PreprocessingChain-1410"><span class="linenos">1410</span></a>        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="PreprocessingChain-1411"><a href="#PreprocessingChain-1411"><span class="linenos">1411</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_atom_padding</span><span class="p">:</span>
</span><span id="PreprocessingChain-1412"><a href="#PreprocessingChain-1412"><span class="linenos">1412</span></a>            <span class="n">new_state</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer_state</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="PreprocessingChain-1413"><a href="#PreprocessingChain-1413"><span class="linenos">1413</span></a>            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="PreprocessingChain-1414"><a href="#PreprocessingChain-1414"><span class="linenos">1414</span></a>        <span class="n">parent_overflow</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="PreprocessingChain-1415"><a href="#PreprocessingChain-1415"><span class="linenos">1415</span></a>        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
</span><span id="PreprocessingChain-1416"><a href="#PreprocessingChain-1416"><span class="linenos">1416</span></a>            <span class="n">s</span><span class="p">,</span> <span class="n">s_up</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">parent_overflow</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">check_reallocate</span><span class="p">(</span>
</span><span id="PreprocessingChain-1417"><a href="#PreprocessingChain-1417"><span class="linenos">1417</span></a>                <span class="n">layer_state</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">parent_overflow</span>
</span><span id="PreprocessingChain-1418"><a href="#PreprocessingChain-1418"><span class="linenos">1418</span></a>            <span class="p">)</span>
</span><span id="PreprocessingChain-1419"><a href="#PreprocessingChain-1419"><span class="linenos">1419</span></a>            <span class="n">new_state</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span><span id="PreprocessingChain-1420"><a href="#PreprocessingChain-1420"><span class="linenos">1420</span></a>            <span class="n">state_up</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s_up</span><span class="p">)</span>
</span><span id="PreprocessingChain-1421"><a href="#PreprocessingChain-1421"><span class="linenos">1421</span></a>            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="PreprocessingChain-1422"><a href="#PreprocessingChain-1422"><span class="linenos">1422</span></a>
</span><span id="PreprocessingChain-1423"><a href="#PreprocessingChain-1423"><span class="linenos">1423</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">parent_overflow</span><span class="p">:</span>
</span><span id="PreprocessingChain-1424"><a href="#PreprocessingChain-1424"><span class="linenos">1424</span></a>            <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="p">{},</span> <span class="n">inputs</span><span class="p">,</span> <span class="kc">False</span>
</span><span id="PreprocessingChain-1425"><a href="#PreprocessingChain-1425"><span class="linenos">1425</span></a>        <span class="k">return</span> <span class="p">(</span>
</span><span id="PreprocessingChain-1426"><a href="#PreprocessingChain-1426"><span class="linenos">1426</span></a>            <span class="n">FrozenDict</span><span class="p">({</span><span class="o">**</span><span class="n">state</span><span class="p">,</span> <span class="s2">&quot;layers_state&quot;</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">new_state</span><span class="p">)}),</span>
</span><span id="PreprocessingChain-1427"><a href="#PreprocessingChain-1427"><span class="linenos">1427</span></a>            <span class="n">state_up</span><span class="p">,</span>
</span><span id="PreprocessingChain-1428"><a href="#PreprocessingChain-1428"><span class="linenos">1428</span></a>            <span class="n">inputs</span><span class="p">,</span>
</span><span id="PreprocessingChain-1429"><a href="#PreprocessingChain-1429"><span class="linenos">1429</span></a>            <span class="kc">True</span><span class="p">,</span>
</span><span id="PreprocessingChain-1430"><a href="#PreprocessingChain-1430"><span class="linenos">1430</span></a>        <span class="p">)</span>
</span><span id="PreprocessingChain-1431"><a href="#PreprocessingChain-1431"><span class="linenos">1431</span></a>
</span><span id="PreprocessingChain-1432"><a href="#PreprocessingChain-1432"><span class="linenos">1432</span></a>    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="PreprocessingChain-1433"><a href="#PreprocessingChain-1433"><span class="linenos">1433</span></a>    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
</span><span id="PreprocessingChain-1434"><a href="#PreprocessingChain-1434"><span class="linenos">1434</span></a>        <span class="n">layer_state</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;layers_state&quot;</span><span class="p">]</span>
</span><span id="PreprocessingChain-1435"><a href="#PreprocessingChain-1435"><span class="linenos">1435</span></a>        <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_atom_padding</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="PreprocessingChain-1436"><a href="#PreprocessingChain-1436"><span class="linenos">1436</span></a>        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
</span><span id="PreprocessingChain-1437"><a href="#PreprocessingChain-1437"><span class="linenos">1437</span></a>            <span class="n">inputs</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">layer_state</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">inputs</span><span class="p">)</span>
</span><span id="PreprocessingChain-1438"><a href="#PreprocessingChain-1438"><span class="linenos">1438</span></a>            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="PreprocessingChain-1439"><a href="#PreprocessingChain-1439"><span class="linenos">1439</span></a>        <span class="k">return</span> <span class="n">inputs</span>
</span><span id="PreprocessingChain-1440"><a href="#PreprocessingChain-1440"><span class="linenos">1440</span></a>
</span><span id="PreprocessingChain-1441"><a href="#PreprocessingChain-1441"><span class="linenos">1441</span></a>    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
</span><span id="PreprocessingChain-1442"><a href="#PreprocessingChain-1442"><span class="linenos">1442</span></a>    <span class="k">def</span> <span class="nf">update_skin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
</span><span id="PreprocessingChain-1443"><a href="#PreprocessingChain-1443"><span class="linenos">1443</span></a>        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
</span><span id="PreprocessingChain-1444"><a href="#PreprocessingChain-1444"><span class="linenos">1444</span></a>            <span class="n">inputs</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">update_skin</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
</span><span id="PreprocessingChain-1445"><a href="#PreprocessingChain-1445"><span class="linenos">1445</span></a>        <span class="k">return</span> <span class="n">inputs</span>
</span><span id="PreprocessingChain-1446"><a href="#PreprocessingChain-1446"><span class="linenos">1446</span></a>
</span><span id="PreprocessingChain-1447"><a href="#PreprocessingChain-1447"><span class="linenos">1447</span></a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="PreprocessingChain-1448"><a href="#PreprocessingChain-1448"><span class="linenos">1448</span></a>        <span class="n">state</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="PreprocessingChain-1449"><a href="#PreprocessingChain-1449"><span class="linenos">1449</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_atom_padding</span><span class="p">:</span>
</span><span id="PreprocessingChain-1450"><a href="#PreprocessingChain-1450"><span class="linenos">1450</span></a>            <span class="n">state</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atom_padder</span><span class="o">.</span><span class="n">init</span><span class="p">())</span>
</span><span id="PreprocessingChain-1451"><a href="#PreprocessingChain-1451"><span class="linenos">1451</span></a>        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
</span><span id="PreprocessingChain-1452"><a href="#PreprocessingChain-1452"><span class="linenos">1452</span></a>            <span class="n">state</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">init</span><span class="p">())</span>
</span><span id="PreprocessingChain-1453"><a href="#PreprocessingChain-1453"><span class="linenos">1453</span></a>        <span class="k">return</span> <span class="n">FrozenDict</span><span class="p">({</span><span class="s2">&quot;check_input&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;layers_state&quot;</span><span class="p">:</span> <span class="n">state</span><span class="p">})</span>
</span><span id="PreprocessingChain-1454"><a href="#PreprocessingChain-1454"><span class="linenos">1454</span></a>
</span><span id="PreprocessingChain-1455"><a href="#PreprocessingChain-1455"><span class="linenos">1455</span></a>    <span class="k">def</span> <span class="nf">init_with_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
</span><span id="PreprocessingChain-1456"><a href="#PreprocessingChain-1456"><span class="linenos">1456</span></a>        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
</span><span id="PreprocessingChain-1457"><a href="#PreprocessingChain-1457"><span class="linenos">1457</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>
</span><span id="PreprocessingChain-1458"><a href="#PreprocessingChain-1458"><span class="linenos">1458</span></a>
</span><span id="PreprocessingChain-1459"><a href="#PreprocessingChain-1459"><span class="linenos">1459</span></a>    <span class="k">def</span> <span class="nf">get_processors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">return_list</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="PreprocessingChain-1460"><a href="#PreprocessingChain-1460"><span class="linenos">1460</span></a>        <span class="n">processors</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="PreprocessingChain-1461"><a href="#PreprocessingChain-1461"><span class="linenos">1461</span></a>        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
</span><span id="PreprocessingChain-1462"><a href="#PreprocessingChain-1462"><span class="linenos">1462</span></a>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="s2">&quot;get_processor&quot;</span><span class="p">):</span>
</span><span id="PreprocessingChain-1463"><a href="#PreprocessingChain-1463"><span class="linenos">1463</span></a>                <span class="n">processors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">get_processor</span><span class="p">())</span>
</span><span id="PreprocessingChain-1464"><a href="#PreprocessingChain-1464"><span class="linenos">1464</span></a>        <span class="k">if</span> <span class="n">return_list</span><span class="p">:</span>
</span><span id="PreprocessingChain-1465"><a href="#PreprocessingChain-1465"><span class="linenos">1465</span></a>            <span class="k">return</span> <span class="n">processors</span>
</span><span id="PreprocessingChain-1466"><a href="#PreprocessingChain-1466"><span class="linenos">1466</span></a>        <span class="k">return</span> <span class="n">FENNIXModules</span><span class="p">(</span><span class="n">processors</span><span class="p">)</span>
</span><span id="PreprocessingChain-1467"><a href="#PreprocessingChain-1467"><span class="linenos">1467</span></a>
</span><span id="PreprocessingChain-1468"><a href="#PreprocessingChain-1468"><span class="linenos">1468</span></a>    <span class="k">def</span> <span class="nf">get_graphs_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="PreprocessingChain-1469"><a href="#PreprocessingChain-1469"><span class="linenos">1469</span></a>        <span class="n">properties</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="PreprocessingChain-1470"><a href="#PreprocessingChain-1470"><span class="linenos">1470</span></a>        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
</span><span id="PreprocessingChain-1471"><a href="#PreprocessingChain-1471"><span class="linenos">1471</span></a>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="s2">&quot;get_graph_properties&quot;</span><span class="p">):</span>
</span><span id="PreprocessingChain-1472"><a href="#PreprocessingChain-1472"><span class="linenos">1472</span></a>                <span class="n">properties</span> <span class="o">=</span> <span class="n">deep_update</span><span class="p">(</span><span class="n">properties</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">get_graph_properties</span><span class="p">())</span>
</span><span id="PreprocessingChain-1473"><a href="#PreprocessingChain-1473"><span class="linenos">1473</span></a>        <span class="k">return</span> <span class="n">properties</span>
</span></pre></div>


    

                            <div id="PreprocessingChain.__init__" class="classattr">
                                <div class="attr function">
            
        <span class="name">PreprocessingChain</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">layers</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span>,</span><span class="param">	<span class="n">use_atom_padding</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">atom_padder</span><span class="p">:</span> <span class="n"><a href="#AtomPadding">AtomPadding</a></span> <span class="o">=</span> <span class="n">AtomPadding</span><span class="p">(</span><span class="n">mult_size</span><span class="o">=</span><span class="mf">1.2</span><span class="p">)</span></span>)</span>

        
    </div>
    <a class="headerlink" href="#PreprocessingChain.__init__"></a>
    
    

                            </div>
                            <div id="PreprocessingChain.layers" class="classattr">
                                <div class="attr variable">
            <span class="name">layers</span><span class="annotation">: Tuple[Callable[..., Dict[str, Any]]]</span>

        
    </div>
    <a class="headerlink" href="#PreprocessingChain.layers"></a>
    
    

                            </div>
                            <div id="PreprocessingChain.use_atom_padding" class="classattr">
                                <div class="attr variable">
            <span class="name">use_atom_padding</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#PreprocessingChain.use_atom_padding"></a>
    
    

                            </div>
                            <div id="PreprocessingChain.atom_padder" class="classattr">
                                <div class="attr variable">
            <span class="name">atom_padder</span><span class="annotation">: <a href="#AtomPadding">AtomPadding</a></span>        =
<span class="default_value">AtomPadding(mult_size=1.2)</span>

        
    </div>
    <a class="headerlink" href="#PreprocessingChain.atom_padder"></a>
    
    

                            </div>
                            <div id="PreprocessingChain.check_reallocate" class="classattr">
                                        <input id="PreprocessingChain.check_reallocate-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">check_reallocate</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">state</span>, </span><span class="param"><span class="n">inputs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PreprocessingChain.check_reallocate-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PreprocessingChain.check_reallocate"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PreprocessingChain.check_reallocate-1406"><a href="#PreprocessingChain.check_reallocate-1406"><span class="linenos">1406</span></a>    <span class="k">def</span> <span class="nf">check_reallocate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
</span><span id="PreprocessingChain.check_reallocate-1407"><a href="#PreprocessingChain.check_reallocate-1407"><span class="linenos">1407</span></a>        <span class="n">new_state</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="PreprocessingChain.check_reallocate-1408"><a href="#PreprocessingChain.check_reallocate-1408"><span class="linenos">1408</span></a>        <span class="n">state_up</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="PreprocessingChain.check_reallocate-1409"><a href="#PreprocessingChain.check_reallocate-1409"><span class="linenos">1409</span></a>        <span class="n">layer_state</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;layers_state&quot;</span><span class="p">]</span>
</span><span id="PreprocessingChain.check_reallocate-1410"><a href="#PreprocessingChain.check_reallocate-1410"><span class="linenos">1410</span></a>        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="PreprocessingChain.check_reallocate-1411"><a href="#PreprocessingChain.check_reallocate-1411"><span class="linenos">1411</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_atom_padding</span><span class="p">:</span>
</span><span id="PreprocessingChain.check_reallocate-1412"><a href="#PreprocessingChain.check_reallocate-1412"><span class="linenos">1412</span></a>            <span class="n">new_state</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer_state</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="PreprocessingChain.check_reallocate-1413"><a href="#PreprocessingChain.check_reallocate-1413"><span class="linenos">1413</span></a>            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="PreprocessingChain.check_reallocate-1414"><a href="#PreprocessingChain.check_reallocate-1414"><span class="linenos">1414</span></a>        <span class="n">parent_overflow</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="PreprocessingChain.check_reallocate-1415"><a href="#PreprocessingChain.check_reallocate-1415"><span class="linenos">1415</span></a>        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
</span><span id="PreprocessingChain.check_reallocate-1416"><a href="#PreprocessingChain.check_reallocate-1416"><span class="linenos">1416</span></a>            <span class="n">s</span><span class="p">,</span> <span class="n">s_up</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">parent_overflow</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">check_reallocate</span><span class="p">(</span>
</span><span id="PreprocessingChain.check_reallocate-1417"><a href="#PreprocessingChain.check_reallocate-1417"><span class="linenos">1417</span></a>                <span class="n">layer_state</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">parent_overflow</span>
</span><span id="PreprocessingChain.check_reallocate-1418"><a href="#PreprocessingChain.check_reallocate-1418"><span class="linenos">1418</span></a>            <span class="p">)</span>
</span><span id="PreprocessingChain.check_reallocate-1419"><a href="#PreprocessingChain.check_reallocate-1419"><span class="linenos">1419</span></a>            <span class="n">new_state</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span><span id="PreprocessingChain.check_reallocate-1420"><a href="#PreprocessingChain.check_reallocate-1420"><span class="linenos">1420</span></a>            <span class="n">state_up</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s_up</span><span class="p">)</span>
</span><span id="PreprocessingChain.check_reallocate-1421"><a href="#PreprocessingChain.check_reallocate-1421"><span class="linenos">1421</span></a>            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="PreprocessingChain.check_reallocate-1422"><a href="#PreprocessingChain.check_reallocate-1422"><span class="linenos">1422</span></a>
</span><span id="PreprocessingChain.check_reallocate-1423"><a href="#PreprocessingChain.check_reallocate-1423"><span class="linenos">1423</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">parent_overflow</span><span class="p">:</span>
</span><span id="PreprocessingChain.check_reallocate-1424"><a href="#PreprocessingChain.check_reallocate-1424"><span class="linenos">1424</span></a>            <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="p">{},</span> <span class="n">inputs</span><span class="p">,</span> <span class="kc">False</span>
</span><span id="PreprocessingChain.check_reallocate-1425"><a href="#PreprocessingChain.check_reallocate-1425"><span class="linenos">1425</span></a>        <span class="k">return</span> <span class="p">(</span>
</span><span id="PreprocessingChain.check_reallocate-1426"><a href="#PreprocessingChain.check_reallocate-1426"><span class="linenos">1426</span></a>            <span class="n">FrozenDict</span><span class="p">({</span><span class="o">**</span><span class="n">state</span><span class="p">,</span> <span class="s2">&quot;layers_state&quot;</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">new_state</span><span class="p">)}),</span>
</span><span id="PreprocessingChain.check_reallocate-1427"><a href="#PreprocessingChain.check_reallocate-1427"><span class="linenos">1427</span></a>            <span class="n">state_up</span><span class="p">,</span>
</span><span id="PreprocessingChain.check_reallocate-1428"><a href="#PreprocessingChain.check_reallocate-1428"><span class="linenos">1428</span></a>            <span class="n">inputs</span><span class="p">,</span>
</span><span id="PreprocessingChain.check_reallocate-1429"><a href="#PreprocessingChain.check_reallocate-1429"><span class="linenos">1429</span></a>            <span class="kc">True</span><span class="p">,</span>
</span><span id="PreprocessingChain.check_reallocate-1430"><a href="#PreprocessingChain.check_reallocate-1430"><span class="linenos">1430</span></a>        <span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="PreprocessingChain.process" class="classattr">
                                        <input id="PreprocessingChain.process-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@partial(jax.jit, static_argnums=(0, 1))</div>

        <span class="def">def</span>
        <span class="name">process</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">state</span>, </span><span class="param"><span class="n">inputs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PreprocessingChain.process-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PreprocessingChain.process"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PreprocessingChain.process-1432"><a href="#PreprocessingChain.process-1432"><span class="linenos">1432</span></a>    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="PreprocessingChain.process-1433"><a href="#PreprocessingChain.process-1433"><span class="linenos">1433</span></a>    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
</span><span id="PreprocessingChain.process-1434"><a href="#PreprocessingChain.process-1434"><span class="linenos">1434</span></a>        <span class="n">layer_state</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;layers_state&quot;</span><span class="p">]</span>
</span><span id="PreprocessingChain.process-1435"><a href="#PreprocessingChain.process-1435"><span class="linenos">1435</span></a>        <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_atom_padding</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="PreprocessingChain.process-1436"><a href="#PreprocessingChain.process-1436"><span class="linenos">1436</span></a>        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
</span><span id="PreprocessingChain.process-1437"><a href="#PreprocessingChain.process-1437"><span class="linenos">1437</span></a>            <span class="n">inputs</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">layer_state</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">inputs</span><span class="p">)</span>
</span><span id="PreprocessingChain.process-1438"><a href="#PreprocessingChain.process-1438"><span class="linenos">1438</span></a>            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="PreprocessingChain.process-1439"><a href="#PreprocessingChain.process-1439"><span class="linenos">1439</span></a>        <span class="k">return</span> <span class="n">inputs</span>
</span></pre></div>


    

                            </div>
                            <div id="PreprocessingChain.update_skin" class="classattr">
                                        <input id="PreprocessingChain.update_skin-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@partial(jax.jit, static_argnums=0)</div>

        <span class="def">def</span>
        <span class="name">update_skin</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">inputs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PreprocessingChain.update_skin-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PreprocessingChain.update_skin"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PreprocessingChain.update_skin-1441"><a href="#PreprocessingChain.update_skin-1441"><span class="linenos">1441</span></a>    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
</span><span id="PreprocessingChain.update_skin-1442"><a href="#PreprocessingChain.update_skin-1442"><span class="linenos">1442</span></a>    <span class="k">def</span> <span class="nf">update_skin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
</span><span id="PreprocessingChain.update_skin-1443"><a href="#PreprocessingChain.update_skin-1443"><span class="linenos">1443</span></a>        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
</span><span id="PreprocessingChain.update_skin-1444"><a href="#PreprocessingChain.update_skin-1444"><span class="linenos">1444</span></a>            <span class="n">inputs</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">update_skin</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
</span><span id="PreprocessingChain.update_skin-1445"><a href="#PreprocessingChain.update_skin-1445"><span class="linenos">1445</span></a>        <span class="k">return</span> <span class="n">inputs</span>
</span></pre></div>


    

                            </div>
                            <div id="PreprocessingChain.init" class="classattr">
                                        <input id="PreprocessingChain.init-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">init</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PreprocessingChain.init-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PreprocessingChain.init"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PreprocessingChain.init-1447"><a href="#PreprocessingChain.init-1447"><span class="linenos">1447</span></a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="PreprocessingChain.init-1448"><a href="#PreprocessingChain.init-1448"><span class="linenos">1448</span></a>        <span class="n">state</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="PreprocessingChain.init-1449"><a href="#PreprocessingChain.init-1449"><span class="linenos">1449</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_atom_padding</span><span class="p">:</span>
</span><span id="PreprocessingChain.init-1450"><a href="#PreprocessingChain.init-1450"><span class="linenos">1450</span></a>            <span class="n">state</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atom_padder</span><span class="o">.</span><span class="n">init</span><span class="p">())</span>
</span><span id="PreprocessingChain.init-1451"><a href="#PreprocessingChain.init-1451"><span class="linenos">1451</span></a>        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
</span><span id="PreprocessingChain.init-1452"><a href="#PreprocessingChain.init-1452"><span class="linenos">1452</span></a>            <span class="n">state</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">init</span><span class="p">())</span>
</span><span id="PreprocessingChain.init-1453"><a href="#PreprocessingChain.init-1453"><span class="linenos">1453</span></a>        <span class="k">return</span> <span class="n">FrozenDict</span><span class="p">({</span><span class="s2">&quot;check_input&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;layers_state&quot;</span><span class="p">:</span> <span class="n">state</span><span class="p">})</span>
</span></pre></div>


    

                            </div>
                            <div id="PreprocessingChain.init_with_output" class="classattr">
                                        <input id="PreprocessingChain.init_with_output-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">init_with_output</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">inputs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PreprocessingChain.init_with_output-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PreprocessingChain.init_with_output"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PreprocessingChain.init_with_output-1455"><a href="#PreprocessingChain.init_with_output-1455"><span class="linenos">1455</span></a>    <span class="k">def</span> <span class="nf">init_with_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
</span><span id="PreprocessingChain.init_with_output-1456"><a href="#PreprocessingChain.init_with_output-1456"><span class="linenos">1456</span></a>        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
</span><span id="PreprocessingChain.init_with_output-1457"><a href="#PreprocessingChain.init_with_output-1457"><span class="linenos">1457</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="PreprocessingChain.get_processors" class="classattr">
                                        <input id="PreprocessingChain.get_processors-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_processors</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">return_list</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PreprocessingChain.get_processors-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PreprocessingChain.get_processors"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PreprocessingChain.get_processors-1459"><a href="#PreprocessingChain.get_processors-1459"><span class="linenos">1459</span></a>    <span class="k">def</span> <span class="nf">get_processors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">return_list</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="PreprocessingChain.get_processors-1460"><a href="#PreprocessingChain.get_processors-1460"><span class="linenos">1460</span></a>        <span class="n">processors</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="PreprocessingChain.get_processors-1461"><a href="#PreprocessingChain.get_processors-1461"><span class="linenos">1461</span></a>        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
</span><span id="PreprocessingChain.get_processors-1462"><a href="#PreprocessingChain.get_processors-1462"><span class="linenos">1462</span></a>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="s2">&quot;get_processor&quot;</span><span class="p">):</span>
</span><span id="PreprocessingChain.get_processors-1463"><a href="#PreprocessingChain.get_processors-1463"><span class="linenos">1463</span></a>                <span class="n">processors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">get_processor</span><span class="p">())</span>
</span><span id="PreprocessingChain.get_processors-1464"><a href="#PreprocessingChain.get_processors-1464"><span class="linenos">1464</span></a>        <span class="k">if</span> <span class="n">return_list</span><span class="p">:</span>
</span><span id="PreprocessingChain.get_processors-1465"><a href="#PreprocessingChain.get_processors-1465"><span class="linenos">1465</span></a>            <span class="k">return</span> <span class="n">processors</span>
</span><span id="PreprocessingChain.get_processors-1466"><a href="#PreprocessingChain.get_processors-1466"><span class="linenos">1466</span></a>        <span class="k">return</span> <span class="n">FENNIXModules</span><span class="p">(</span><span class="n">processors</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="PreprocessingChain.get_graphs_properties" class="classattr">
                                        <input id="PreprocessingChain.get_graphs_properties-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_graphs_properties</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PreprocessingChain.get_graphs_properties-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PreprocessingChain.get_graphs_properties"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PreprocessingChain.get_graphs_properties-1468"><a href="#PreprocessingChain.get_graphs_properties-1468"><span class="linenos">1468</span></a>    <span class="k">def</span> <span class="nf">get_graphs_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="PreprocessingChain.get_graphs_properties-1469"><a href="#PreprocessingChain.get_graphs_properties-1469"><span class="linenos">1469</span></a>        <span class="n">properties</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="PreprocessingChain.get_graphs_properties-1470"><a href="#PreprocessingChain.get_graphs_properties-1470"><span class="linenos">1470</span></a>        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
</span><span id="PreprocessingChain.get_graphs_properties-1471"><a href="#PreprocessingChain.get_graphs_properties-1471"><span class="linenos">1471</span></a>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="s2">&quot;get_graph_properties&quot;</span><span class="p">):</span>
</span><span id="PreprocessingChain.get_graphs_properties-1472"><a href="#PreprocessingChain.get_graphs_properties-1472"><span class="linenos">1472</span></a>                <span class="n">properties</span> <span class="o">=</span> <span class="n">deep_update</span><span class="p">(</span><span class="n">properties</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">get_graph_properties</span><span class="p">())</span>
</span><span id="PreprocessingChain.get_graphs_properties-1473"><a href="#PreprocessingChain.get_graphs_properties-1473"><span class="linenos">1473</span></a>        <span class="k">return</span> <span class="n">properties</span>
</span></pre></div>


    

                            </div>
                </section>
                <section id="PREPROCESSING">
                    <div class="attr variable">
            <span class="name">PREPROCESSING</span>        =
<input id="PREPROCESSING-view-value" class="view-value-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
            <label class="view-value-button pdoc-button" for="PREPROCESSING-view-value"></label><span class="default_value">{&#39;GRAPH&#39;: &lt;class &#39;<a href="#GraphGenerator">GraphGenerator</a>&#39;&gt;, &#39;GRAPH_FILTER&#39;: &lt;class &#39;<a href="#GraphFilter">GraphFilter</a>&#39;&gt;, &#39;GRAPH_ANGULAR_EXTENSION&#39;: &lt;class &#39;<a href="#GraphAngularExtension">GraphAngularExtension</a>&#39;&gt;, &#39;SPECIES_INDEXER&#39;: &lt;class &#39;<a href="#SpeciesIndexer">SpeciesIndexer</a>&#39;&gt;}</span>

        
    </div>
    <a class="headerlink" href="#PREPROCESSING"></a>
    
    

                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>