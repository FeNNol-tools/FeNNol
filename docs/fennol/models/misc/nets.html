<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 14.4.0"/>
    <title>fennol.models.misc.nets API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../misc.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;fennol.models.misc</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#FullyConnectedNet">FullyConnectedNet</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#FullyConnectedNet.__init__">FullyConnectedNet</a>
                        </li>
                        <li>
                                <a class="variable" href="#FullyConnectedNet.neurons">neurons</a>
                        </li>
                        <li>
                                <a class="function" href="#FullyConnectedNet.activation">activation</a>
                        </li>
                        <li>
                                <a class="variable" href="#FullyConnectedNet.use_bias">use_bias</a>
                        </li>
                        <li>
                                <a class="variable" href="#FullyConnectedNet.input_key">input_key</a>
                        </li>
                        <li>
                                <a class="variable" href="#FullyConnectedNet.output_key">output_key</a>
                        </li>
                        <li>
                                <a class="variable" href="#FullyConnectedNet.squeeze">squeeze</a>
                        </li>
                        <li>
                                <a class="function" href="#FullyConnectedNet.kernel_init">kernel_init</a>
                        </li>
                        <li>
                                <a class="variable" href="#FullyConnectedNet.FID">FID</a>
                        </li>
                        <li>
                                <a class="variable" href="#FullyConnectedNet.parent">parent</a>
                        </li>
                        <li>
                                <a class="variable" href="#FullyConnectedNet.name">name</a>
                        </li>
                        <li>
                                <a class="variable" href="#FullyConnectedNet.scope">scope</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#ResMLP">ResMLP</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ResMLP.__init__">ResMLP</a>
                        </li>
                        <li>
                                <a class="variable" href="#ResMLP.use_bias">use_bias</a>
                        </li>
                        <li>
                                <a class="variable" href="#ResMLP.input_key">input_key</a>
                        </li>
                        <li>
                                <a class="variable" href="#ResMLP.output_key">output_key</a>
                        </li>
                        <li>
                                <a class="function" href="#ResMLP.kernel_init">kernel_init</a>
                        </li>
                        <li>
                                <a class="variable" href="#ResMLP.res_only">res_only</a>
                        </li>
                        <li>
                                <a class="variable" href="#ResMLP.FID">FID</a>
                        </li>
                        <li>
                                <a class="variable" href="#ResMLP.parent">parent</a>
                        </li>
                        <li>
                                <a class="variable" href="#ResMLP.name">name</a>
                        </li>
                        <li>
                                <a class="variable" href="#ResMLP.scope">scope</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#FullyResidualNet">FullyResidualNet</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#FullyResidualNet.__init__">FullyResidualNet</a>
                        </li>
                        <li>
                                <a class="variable" href="#FullyResidualNet.dim">dim</a>
                        </li>
                        <li>
                                <a class="variable" href="#FullyResidualNet.output_dim">output_dim</a>
                        </li>
                        <li>
                                <a class="variable" href="#FullyResidualNet.nlayers">nlayers</a>
                        </li>
                        <li>
                                <a class="function" href="#FullyResidualNet.activation">activation</a>
                        </li>
                        <li>
                                <a class="variable" href="#FullyResidualNet.use_bias">use_bias</a>
                        </li>
                        <li>
                                <a class="variable" href="#FullyResidualNet.input_key">input_key</a>
                        </li>
                        <li>
                                <a class="variable" href="#FullyResidualNet.output_key">output_key</a>
                        </li>
                        <li>
                                <a class="variable" href="#FullyResidualNet.squeeze">squeeze</a>
                        </li>
                        <li>
                                <a class="function" href="#FullyResidualNet.kernel_init">kernel_init</a>
                        </li>
                        <li>
                                <a class="variable" href="#FullyResidualNet.FID">FID</a>
                        </li>
                        <li>
                                <a class="variable" href="#FullyResidualNet.parent">parent</a>
                        </li>
                        <li>
                                <a class="variable" href="#FullyResidualNet.name">name</a>
                        </li>
                        <li>
                                <a class="variable" href="#FullyResidualNet.scope">scope</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#HierarchicalNet">HierarchicalNet</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#HierarchicalNet.__init__">HierarchicalNet</a>
                        </li>
                        <li>
                                <a class="variable" href="#HierarchicalNet.neurons">neurons</a>
                        </li>
                        <li>
                                <a class="function" href="#HierarchicalNet.activation">activation</a>
                        </li>
                        <li>
                                <a class="variable" href="#HierarchicalNet.use_bias">use_bias</a>
                        </li>
                        <li>
                                <a class="variable" href="#HierarchicalNet.input_key">input_key</a>
                        </li>
                        <li>
                                <a class="variable" href="#HierarchicalNet.output_key">output_key</a>
                        </li>
                        <li>
                                <a class="variable" href="#HierarchicalNet.decay">decay</a>
                        </li>
                        <li>
                                <a class="variable" href="#HierarchicalNet.squeeze">squeeze</a>
                        </li>
                        <li>
                                <a class="function" href="#HierarchicalNet.kernel_init">kernel_init</a>
                        </li>
                        <li>
                                <a class="variable" href="#HierarchicalNet.FID">FID</a>
                        </li>
                        <li>
                                <a class="variable" href="#HierarchicalNet.parent">parent</a>
                        </li>
                        <li>
                                <a class="variable" href="#HierarchicalNet.name">name</a>
                        </li>
                        <li>
                                <a class="variable" href="#HierarchicalNet.scope">scope</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#SpeciesIndexNet">SpeciesIndexNet</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#SpeciesIndexNet.__init__">SpeciesIndexNet</a>
                        </li>
                        <li>
                                <a class="variable" href="#SpeciesIndexNet.output_dim">output_dim</a>
                        </li>
                        <li>
                                <a class="variable" href="#SpeciesIndexNet.hidden_neurons">hidden_neurons</a>
                        </li>
                        <li>
                                <a class="variable" href="#SpeciesIndexNet.species_order">species_order</a>
                        </li>
                        <li>
                                <a class="function" href="#SpeciesIndexNet.activation">activation</a>
                        </li>
                        <li>
                                <a class="variable" href="#SpeciesIndexNet.use_bias">use_bias</a>
                        </li>
                        <li>
                                <a class="variable" href="#SpeciesIndexNet.input_key">input_key</a>
                        </li>
                        <li>
                                <a class="variable" href="#SpeciesIndexNet.species_index_key">species_index_key</a>
                        </li>
                        <li>
                                <a class="variable" href="#SpeciesIndexNet.output_key">output_key</a>
                        </li>
                        <li>
                                <a class="variable" href="#SpeciesIndexNet.squeeze">squeeze</a>
                        </li>
                        <li>
                                <a class="function" href="#SpeciesIndexNet.kernel_init">kernel_init</a>
                        </li>
                        <li>
                                <a class="variable" href="#SpeciesIndexNet.FID">FID</a>
                        </li>
                        <li>
                                <a class="function" href="#SpeciesIndexNet.setup">setup</a>
                        </li>
                        <li>
                                <a class="variable" href="#SpeciesIndexNet.parent">parent</a>
                        </li>
                        <li>
                                <a class="variable" href="#SpeciesIndexNet.name">name</a>
                        </li>
                        <li>
                                <a class="variable" href="#SpeciesIndexNet.scope">scope</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#ChemicalNet">ChemicalNet</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ChemicalNet.__init__">ChemicalNet</a>
                        </li>
                        <li>
                                <a class="variable" href="#ChemicalNet.species_order">species_order</a>
                        </li>
                        <li>
                                <a class="variable" href="#ChemicalNet.neurons">neurons</a>
                        </li>
                        <li>
                                <a class="function" href="#ChemicalNet.activation">activation</a>
                        </li>
                        <li>
                                <a class="variable" href="#ChemicalNet.use_bias">use_bias</a>
                        </li>
                        <li>
                                <a class="variable" href="#ChemicalNet.input_key">input_key</a>
                        </li>
                        <li>
                                <a class="variable" href="#ChemicalNet.output_key">output_key</a>
                        </li>
                        <li>
                                <a class="variable" href="#ChemicalNet.squeeze">squeeze</a>
                        </li>
                        <li>
                                <a class="function" href="#ChemicalNet.kernel_init">kernel_init</a>
                        </li>
                        <li>
                                <a class="variable" href="#ChemicalNet.FID">FID</a>
                        </li>
                        <li>
                                <a class="variable" href="#ChemicalNet.parent">parent</a>
                        </li>
                        <li>
                                <a class="variable" href="#ChemicalNet.name">name</a>
                        </li>
                        <li>
                                <a class="variable" href="#ChemicalNet.scope">scope</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#MOENet">MOENet</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#MOENet.__init__">MOENet</a>
                        </li>
                        <li>
                                <a class="variable" href="#MOENet.neurons">neurons</a>
                        </li>
                        <li>
                                <a class="variable" href="#MOENet.num_networks">num_networks</a>
                        </li>
                        <li>
                                <a class="function" href="#MOENet.activation">activation</a>
                        </li>
                        <li>
                                <a class="variable" href="#MOENet.use_bias">use_bias</a>
                        </li>
                        <li>
                                <a class="variable" href="#MOENet.input_key">input_key</a>
                        </li>
                        <li>
                                <a class="variable" href="#MOENet.output_key">output_key</a>
                        </li>
                        <li>
                                <a class="variable" href="#MOENet.squeeze">squeeze</a>
                        </li>
                        <li>
                                <a class="function" href="#MOENet.kernel_init">kernel_init</a>
                        </li>
                        <li>
                                <a class="variable" href="#MOENet.router_key">router_key</a>
                        </li>
                        <li>
                                <a class="variable" href="#MOENet.FID">FID</a>
                        </li>
                        <li>
                                <a class="variable" href="#MOENet.parent">parent</a>
                        </li>
                        <li>
                                <a class="variable" href="#MOENet.name">name</a>
                        </li>
                        <li>
                                <a class="variable" href="#MOENet.scope">scope</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#ChannelNet">ChannelNet</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ChannelNet.__init__">ChannelNet</a>
                        </li>
                        <li>
                                <a class="variable" href="#ChannelNet.neurons">neurons</a>
                        </li>
                        <li>
                                <a class="function" href="#ChannelNet.activation">activation</a>
                        </li>
                        <li>
                                <a class="variable" href="#ChannelNet.use_bias">use_bias</a>
                        </li>
                        <li>
                                <a class="variable" href="#ChannelNet.input_key">input_key</a>
                        </li>
                        <li>
                                <a class="variable" href="#ChannelNet.output_key">output_key</a>
                        </li>
                        <li>
                                <a class="variable" href="#ChannelNet.squeeze">squeeze</a>
                        </li>
                        <li>
                                <a class="function" href="#ChannelNet.kernel_init">kernel_init</a>
                        </li>
                        <li>
                                <a class="variable" href="#ChannelNet.channel_axis">channel_axis</a>
                        </li>
                        <li>
                                <a class="variable" href="#ChannelNet.FID">FID</a>
                        </li>
                        <li>
                                <a class="variable" href="#ChannelNet.parent">parent</a>
                        </li>
                        <li>
                                <a class="variable" href="#ChannelNet.name">name</a>
                        </li>
                        <li>
                                <a class="variable" href="#ChannelNet.scope">scope</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#GatedPerceptron">GatedPerceptron</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#GatedPerceptron.__init__">GatedPerceptron</a>
                        </li>
                        <li>
                                <a class="variable" href="#GatedPerceptron.dim">dim</a>
                        </li>
                        <li>
                                <a class="variable" href="#GatedPerceptron.use_bias">use_bias</a>
                        </li>
                        <li>
                                <a class="function" href="#GatedPerceptron.kernel_init">kernel_init</a>
                        </li>
                        <li>
                                <a class="function" href="#GatedPerceptron.activation">activation</a>
                        </li>
                        <li>
                                <a class="variable" href="#GatedPerceptron.input_key">input_key</a>
                        </li>
                        <li>
                                <a class="variable" href="#GatedPerceptron.output_key">output_key</a>
                        </li>
                        <li>
                                <a class="variable" href="#GatedPerceptron.squeeze">squeeze</a>
                        </li>
                        <li>
                                <a class="variable" href="#GatedPerceptron.FID">FID</a>
                        </li>
                        <li>
                                <a class="variable" href="#GatedPerceptron.parent">parent</a>
                        </li>
                        <li>
                                <a class="variable" href="#GatedPerceptron.name">name</a>
                        </li>
                        <li>
                                <a class="variable" href="#GatedPerceptron.scope">scope</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#ZAcNet">ZAcNet</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ZAcNet.__init__">ZAcNet</a>
                        </li>
                        <li>
                                <a class="variable" href="#ZAcNet.neurons">neurons</a>
                        </li>
                        <li>
                                <a class="variable" href="#ZAcNet.zmax">zmax</a>
                        </li>
                        <li>
                                <a class="function" href="#ZAcNet.activation">activation</a>
                        </li>
                        <li>
                                <a class="variable" href="#ZAcNet.use_bias">use_bias</a>
                        </li>
                        <li>
                                <a class="variable" href="#ZAcNet.input_key">input_key</a>
                        </li>
                        <li>
                                <a class="variable" href="#ZAcNet.output_key">output_key</a>
                        </li>
                        <li>
                                <a class="variable" href="#ZAcNet.squeeze">squeeze</a>
                        </li>
                        <li>
                                <a class="function" href="#ZAcNet.kernel_init">kernel_init</a>
                        </li>
                        <li>
                                <a class="variable" href="#ZAcNet.FID">FID</a>
                        </li>
                        <li>
                                <a class="variable" href="#ZAcNet.parent">parent</a>
                        </li>
                        <li>
                                <a class="variable" href="#ZAcNet.name">name</a>
                        </li>
                        <li>
                                <a class="variable" href="#ZAcNet.scope">scope</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#ZLoRANet">ZLoRANet</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ZLoRANet.__init__">ZLoRANet</a>
                        </li>
                        <li>
                                <a class="variable" href="#ZLoRANet.neurons">neurons</a>
                        </li>
                        <li>
                                <a class="variable" href="#ZLoRANet.ranks">ranks</a>
                        </li>
                        <li>
                                <a class="variable" href="#ZLoRANet.zmax">zmax</a>
                        </li>
                        <li>
                                <a class="function" href="#ZLoRANet.activation">activation</a>
                        </li>
                        <li>
                                <a class="variable" href="#ZLoRANet.use_bias">use_bias</a>
                        </li>
                        <li>
                                <a class="variable" href="#ZLoRANet.input_key">input_key</a>
                        </li>
                        <li>
                                <a class="variable" href="#ZLoRANet.output_key">output_key</a>
                        </li>
                        <li>
                                <a class="variable" href="#ZLoRANet.squeeze">squeeze</a>
                        </li>
                        <li>
                                <a class="function" href="#ZLoRANet.kernel_init">kernel_init</a>
                        </li>
                        <li>
                                <a class="variable" href="#ZLoRANet.FID">FID</a>
                        </li>
                        <li>
                                <a class="variable" href="#ZLoRANet.parent">parent</a>
                        </li>
                        <li>
                                <a class="variable" href="#ZLoRANet.name">name</a>
                        </li>
                        <li>
                                <a class="variable" href="#ZLoRANet.scope">scope</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../../../fennol.html">fennol</a><wbr>.<a href="./../../models.html">models</a><wbr>.<a href="./../misc.html">misc</a><wbr>.nets    </h1>

                
                        <input id="mod-nets-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-nets-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="kn">import</span> <span class="nn">flax.linen</span> <span class="k">as</span> <span class="nn">nn</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Union</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="kn">from</span> <span class="nn">...utils.periodic_table</span> <span class="kn">import</span> <span class="n">PERIODIC_TABLE_REV_IDX</span><span class="p">,</span> <span class="n">PERIODIC_TABLE</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a><span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="kn">import</span> <span class="nn">jax</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="kn">from</span> <span class="nn">...utils.activations</span> <span class="kn">import</span> <span class="n">activation_from_str</span><span class="p">,</span> <span class="n">TrainableSiLU</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a><span class="kn">from</span> <span class="nn">...utils.initializers</span> <span class="kn">import</span> <span class="n">initializer_from_str</span><span class="p">,</span> <span class="n">scaled_orthogonal</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a><span class="kn">from</span> <span class="nn">flax.core</span> <span class="kn">import</span> <span class="n">FrozenDict</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="k">class</span> <span class="nc">FullyConnectedNet</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;A fully connected neural network module.</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a><span class="sd">    Parameters:</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a><span class="sd">        neurons (Sequence[int]): A sequence of integers representing the dimensions of the network.</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a><span class="sd">        activation (Union[Callable, str], optional): The activation function to use. Defaults to nn.silu.</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a><span class="sd">        use_bias (bool, optional): Whether to use bias in the dense layers. Defaults to True.</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a><span class="sd">        input_key (Optional[str], optional): The key to use to access the input tensor. Defaults to None.</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a><span class="sd">        output_key (Optional[str], optional): The key to use to access the output tensor. Defaults to None.</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a><span class="sd">        squeeze (bool, optional): Whether to squeeze the output tensor if its shape is (..., 1). Defaults to False.</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a><span class="sd">        kernel_init (Union[str, Callable], optional): The kernel initialization method to use. Defaults to nn.linear.default_kernel_init.</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a>    <span class="n">neurons</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a>    <span class="n">activation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">silu</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a>    <span class="n">use_bias</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a>    <span class="n">input_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a>    <span class="n">output_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a>    <span class="n">squeeze</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a>    <span class="n">kernel_init</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">default_kernel_init</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a>    <span class="n">FID</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;NEURAL_NET&quot;</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a>    <span class="nd">@nn</span><span class="o">.</span><span class="n">compact</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">]:</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Applies the neural network to the given inputs.</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a><span class="sd">        Args:</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a><span class="sd">            inputs (Union[dict, jax.Array]): If input_key is None, a JAX array containing the inputs to the neural network. Else, a dictionary containing the inputs at the key input_key.</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a><span class="sd">        Returns:</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a><span class="sd">            Union[dict, jax.Array]: If output_key is None, the output tensor of the neural network. Else, a dictionary containing the original inputs and the output tensor at the key output_key.</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a>            <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a>                <span class="n">inputs</span><span class="p">,</span> <span class="nb">dict</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a>            <span class="p">),</span> <span class="s2">&quot;input key must be provided if inputs is a dictionary&quot;</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">inputs</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">input_key</span><span class="p">]</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a>        <span class="n">activation</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a>            <span class="n">activation_from_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">)</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a>            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">activation</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a>        <span class="p">)</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a>        <span class="n">kernel_init</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a>            <span class="n">initializer_from_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_init</span><span class="p">)</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_init</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a>            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel_init</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a>        <span class="p">)</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a>        <span class="c1">############################</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">neurons</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a>                <span class="n">d</span><span class="p">,</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a>                <span class="n">use_bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_bias</span><span class="p">,</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a>                <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Layer_</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a>                <span class="n">kernel_init</span><span class="o">=</span><span class="n">kernel_init</span><span class="p">,</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a>                <span class="c1"># precision=jax.lax.Precision.HIGH,</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a>            <span class="p">)(</span><span class="n">x</span><span class="p">)</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">activation</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">neurons</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a>            <span class="n">use_bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_bias</span><span class="p">,</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a>            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Layer_</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">neurons</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a>            <span class="n">kernel_init</span><span class="o">=</span><span class="n">kernel_init</span><span class="p">,</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a>            <span class="c1"># precision=jax.lax.Precision.HIGH,</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a>        <span class="p">)(</span><span class="n">x</span><span class="p">)</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">squeeze</span> <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a>        <span class="c1">############################</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a>            <span class="n">output_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_key</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_key</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a>            <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="n">output_key</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span> <span class="k">if</span> <span class="n">output_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">x</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a>        <span class="k">return</span> <span class="n">x</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a><span class="k">class</span> <span class="nc">ResMLP</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Residual neural network as defined in SpookyNet paper</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a><span class="sd">    Parameters:</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a><span class="sd">        use_bias (bool): Whether to include bias in the linear layers. Default is True.</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a><span class="sd">        input_key (Optional[str]): Key to access the input data from a dictionary. If None, assumes inputs are not a dictionary. Default is None.</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a><span class="sd">        output_key (Optional[str]): Key to store the output data in the dictionary. If None, uses the name of the module. Default is None.</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a><span class="sd">        kernel_init (Union[str, Callable]): Initialization method for the kernel weights. Can be a string representing a built-in initializer or a custom initialization function. Default is scaled_orthogonal(mode=&quot;fan_avg&quot;).</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a><span class="sd">        res_only (bool): Whether to only apply the residual connection without additional linear layers. Default is False.</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a>    <span class="n">use_bias</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a>    <span class="n">input_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a>    <span class="n">output_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a>    <span class="n">kernel_init</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaled_orthogonal</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;fan_avg&quot;</span><span class="p">)</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a>    <span class="n">res_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a>    <span class="n">FID</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;RES_MLP&quot;</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a>    <span class="nd">@nn</span><span class="o">.</span><span class="n">compact</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">]:</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>            <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a>                <span class="n">inputs</span><span class="p">,</span> <span class="nb">dict</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>            <span class="p">),</span> <span class="s2">&quot;input key must be provided if inputs is a dictionary&quot;</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">inputs</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">input_key</span><span class="p">]</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a>        <span class="n">kernel_init</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a>            <span class="n">initializer_from_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_init</span><span class="p">)</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_init</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a>            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel_init</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a>        <span class="p">)</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a>        <span class="c1">############################</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a>        <span class="n">out</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">use_bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_bias</span><span class="p">,</span> <span class="n">kernel_init</span><span class="o">=</span><span class="n">kernel_init</span><span class="p">)(</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a>            <span class="n">TrainableSiLU</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a>        <span class="p">)</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a>        <span class="n">out</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a>            <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">use_bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_bias</span><span class="p">,</span> <span class="n">kernel_init</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">initializers</span><span class="o">.</span><span class="n">zeros</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a>        <span class="p">)(</span><span class="n">TrainableSiLU</span><span class="p">()(</span><span class="n">out</span><span class="p">))</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">res_only</span><span class="p">:</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a>            <span class="n">out</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a>                <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">use_bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_bias</span><span class="p">,</span> <span class="n">kernel_init</span><span class="o">=</span><span class="n">kernel_init</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a>            <span class="p">)(</span><span class="n">TrainableSiLU</span><span class="p">()(</span><span class="n">out</span><span class="p">))</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a>        <span class="c1">############################</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a>            <span class="n">output_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_key</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_key</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a>            <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="n">output_key</span><span class="p">:</span> <span class="n">out</span><span class="p">}</span> <span class="k">if</span> <span class="n">output_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">out</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a>        <span class="k">return</span> <span class="n">out</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a><span class="k">class</span> <span class="nc">FullyResidualNet</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;A neural network with skip connections at each layer.</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a><span class="sd">    Parameters:</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a><span class="sd">        dim (int): The dimension of the hidden layers.</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a><span class="sd">        output_dim (int): The dimension of the output layer.</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a><span class="sd">        nlayers (int): The number of layers in the network.</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a><span class="sd">        activation (Union[Callable, str]): The activation function to use. Can be a callable or a string representing the name of the activation function.</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a><span class="sd">        use_bias (bool): Whether to include bias terms in the linear layers.</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a><span class="sd">        input_key (Optional[str]): The key to access the input data from a dictionary, if the input is a dictionary.</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a><span class="sd">        output_key (Optional[str]): The key to store the output data in a dictionary, if the output is a dictionary.</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a><span class="sd">        squeeze (bool): Whether to squeeze the output if it has shape (..., 1).</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a><span class="sd">        kernel_init (Union[str, Callable]): The initializer for the linear layer weights. Can be a callable or a string representing the name of the initializer.</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a>    <span class="n">dim</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a>    <span class="n">output_dim</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a>    <span class="n">nlayers</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a>    <span class="n">activation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">silu</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a>    <span class="n">use_bias</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a>    <span class="n">input_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a>    <span class="n">output_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a>    <span class="n">squeeze</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a>    <span class="n">kernel_init</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">default_kernel_init</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a>    <span class="n">FID</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;SKIP_NET&quot;</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a>    <span class="nd">@nn</span><span class="o">.</span><span class="n">compact</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">]:</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a>            <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a>                <span class="n">inputs</span><span class="p">,</span> <span class="nb">dict</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a>            <span class="p">),</span> <span class="s2">&quot;input key must be provided if inputs is a dictionary&quot;</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">inputs</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">input_key</span><span class="p">]</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a>        <span class="n">activation</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a>            <span class="n">activation_from_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">)</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a>            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">activation</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a>        <span class="p">)</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a>        <span class="n">kernel_init</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a>            <span class="n">initializer_from_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_init</span><span class="p">)</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_init</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a>            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel_init</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a>        <span class="p">)</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a>        <span class="c1">############################</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a>        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">:</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">,</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a>                <span class="n">use_bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_bias</span><span class="p">,</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a>                <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Reshape&quot;</span><span class="p">,</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a>                <span class="n">kernel_init</span><span class="o">=</span><span class="n">kernel_init</span><span class="p">,</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a>            <span class="p">)(</span><span class="n">x</span><span class="p">)</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nlayers</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">activation</span><span class="p">(</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a>                <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">,</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a>                    <span class="n">use_bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_bias</span><span class="p">,</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a>                    <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Layer_</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a>                    <span class="n">kernel_init</span><span class="o">=</span><span class="n">kernel_init</span><span class="p">,</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a>                <span class="p">)(</span><span class="n">x</span><span class="p">)</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a>            <span class="p">)</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">output_dim</span><span class="p">,</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a>            <span class="n">use_bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_bias</span><span class="p">,</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a>            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Layer_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nlayers</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a>            <span class="n">kernel_init</span><span class="o">=</span><span class="n">kernel_init</span><span class="p">,</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a>        <span class="p">)(</span><span class="n">x</span><span class="p">)</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">squeeze</span> <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a>        <span class="c1">############################</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a>            <span class="n">output_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_key</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_key</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a>            <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="n">output_key</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span> <span class="k">if</span> <span class="n">output_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">x</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>        <span class="k">return</span> <span class="n">x</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a><span class="k">class</span> <span class="nc">HierarchicalNet</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Neural network for a sequence of inputs (in axis=-2) with a decay factor</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a><span class="sd">    Parameters:</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a><span class="sd">        neurons (Sequence[int]): A sequence of integers representing the number of neurons in each layer.</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a><span class="sd">        activation (Union[Callable, str], optional): Activation function to use. Defaults to nn.silu.</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a><span class="sd">        use_bias (bool, optional): Whether to include bias terms in the linear layers. Defaults to True.</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a><span class="sd">        input_key (Optional[str], optional): Key to access the input data if it is a dictionary. Defaults to None.</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a><span class="sd">        output_key (Optional[str], optional): Key to store the output data if it is a dictionary. Defaults to None.</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a><span class="sd">        decay (float, optional): Decay factor to scale each layer. Defaults to 0.01.</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a><span class="sd">        squeeze (bool, optional): Whether to squeeze the output if it has shape (..., 1). Defaults to False.</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a><span class="sd">        kernel_init (Union[str, Callable], optional): Initialization method for the linear layers. Defaults to nn.linear.default_kernel_init.</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a>    <span class="n">neurons</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a>    <span class="n">activation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">silu</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a>    <span class="n">use_bias</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a>    <span class="n">input_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a>    <span class="n">output_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a>    <span class="n">decay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a>    <span class="n">squeeze</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a>    <span class="n">kernel_init</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">default_kernel_init</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a>    <span class="n">FID</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;HIERARCHICAL_NET&quot;</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a>    <span class="nd">@nn</span><span class="o">.</span><span class="n">compact</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">]:</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>            <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a>                <span class="n">inputs</span><span class="p">,</span> <span class="nb">dict</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a>            <span class="p">),</span> <span class="s2">&quot;input key must be provided if inputs is a dictionary&quot;</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">inputs</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">input_key</span><span class="p">]</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a>        <span class="c1">############################</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a>        <span class="n">networks</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a>            <span class="n">FullyConnectedNet</span><span class="p">,</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a>            <span class="n">variable_axes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a>            <span class="n">split_rngs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a>            <span class="n">in_axes</span><span class="o">=-</span><span class="mi">2</span><span class="p">,</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a>            <span class="n">out_axes</span><span class="o">=-</span><span class="mi">2</span><span class="p">,</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a>            <span class="n">kenel_init</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_init</span><span class="p">,</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a>        <span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">neurons</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_bias</span><span class="p">)</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a>        <span class="n">out</span> <span class="o">=</span> <span class="n">networks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a>        <span class="c1"># scale each layer by a decay factor</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a>        <span class="n">decay</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">decay</span><span class="o">**</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])])</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a>        <span class="n">out</span> <span class="o">=</span> <span class="n">out</span> <span class="o">*</span> <span class="n">decay</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">squeeze</span> <span class="ow">and</span> <span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a>            <span class="n">out</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a>        <span class="c1">############################</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a>            <span class="n">output_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_key</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_key</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a>            <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="n">output_key</span><span class="p">:</span> <span class="n">out</span><span class="p">}</span> <span class="k">if</span> <span class="n">output_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">out</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a>        <span class="k">return</span> <span class="n">out</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a><span class="k">class</span> <span class="nc">SpeciesIndexNet</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Chemical-species-specific neural network using precomputed species index.</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a><span class="sd">    A neural network that applies a species-specific fully connected network to each atom embedding.</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a><span class="sd">    A species index must be provided to filter the embeddings for each species and apply the corresponding network.</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a><span class="sd">    This index can be obtained using the SPECIES_INDEXER preprocessing module.</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a><span class="sd">    Parameters:</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a><span class="sd">        output_dim (int): The dimension of the output of the fully connected networks. It is the same for all species.</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a><span class="sd">        hidden_neurons (Union[dict, Sequence[int]]): The hidden dimensions of the fully connected networks for each species.</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a><span class="sd">            If a dictionary is provided, it should map species names to dimensions.</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a><span class="sd">            If a sequence is provided, the same dimensions will be used for all species.</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a><span class="sd">        species_order (Sequence[str]): The species for which to build a network. Only required if neurons is not a dictionary.</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a><span class="sd">        activation (Callable, optional): The activation function to use in the fully connected networks. Defaults to nn.silu.</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a><span class="sd">        use_bias (bool, optional): Whether to include bias terms in the fully connected networks. Defaults to True.</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a><span class="sd">        input_key (str, optional): The key in the input dictionary that corresponds to the embeddings of the atoms.</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a><span class="sd">            If None, the input is assumed to be a tuple (species,embeddings). Defaults to None.</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a><span class="sd">        species_index_key str: The key in the input dictionary that corresponds to the species index of the atoms.</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a><span class="sd">            This index can be obtained via the SPECIES_INDEXER preprocessing module. Defaults to &quot;species_index&quot;.</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a><span class="sd">        output_key (str, optional): The key in the output dictionary that corresponds to the network&#39;s output.</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a><span class="sd">            If None, the output is returned directly. Defaults to None.</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a><span class="sd">        squeeze (bool, optional): Whether to squeeze the output if it has shape (batch_size, 1). Defaults to False.</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a><span class="sd">        kernel_init (Union[str, Callable], optional): The kernel initialization method for the fully connected networks. Defaults to nn.linear.default_kernel_init.</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a>    <span class="n">output_dim</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a>    <span class="n">hidden_neurons</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">FrozenDict</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a>    <span class="n">species_order</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a>    <span class="n">activation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">silu</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a>    <span class="n">use_bias</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>    <span class="n">input_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a>    <span class="n">species_index_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;species_index&quot;</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a>    <span class="n">output_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a>    <span class="n">squeeze</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a>    <span class="n">kernel_init</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">default_kernel_init</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>    <span class="n">FID</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;SPECIES_INDEX_NET&quot;</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>            <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_neurons</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>            <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_neurons</span><span class="p">,</span> <span class="n">FrozenDict</span><span class="p">)</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>        <span class="p">):</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a>            <span class="k">assert</span> <span class="p">(</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">species_order</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a>            <span class="p">),</span> <span class="s2">&quot;species_order must be provided if hidden_neurons is not a dictionary&quot;</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_order</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a>                <span class="n">species_order</span> <span class="o">=</span> <span class="p">[</span><span class="n">el</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_order</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a>                <span class="n">species_order</span> <span class="o">=</span> <span class="p">[</span><span class="n">el</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_order</span><span class="p">]</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>            <span class="n">neurons</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_neurons</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">species_order</span><span class="p">}</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a>            <span class="n">neurons</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_neurons</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a>            <span class="n">species_order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">neurons</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a>        <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="n">species_order</span><span class="p">:</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a>            <span class="k">assert</span> <span class="p">(</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>                <span class="n">species</span> <span class="ow">in</span> <span class="n">PERIODIC_TABLE</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a>            <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;species </span><span class="si">{</span><span class="n">species</span><span class="si">}</span><span class="s2"> not found in periodic table&quot;</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">networks</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a>            <span class="n">k</span><span class="p">:</span> <span class="n">FullyConnectedNet</span><span class="p">(</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a>                <span class="p">[</span><span class="o">*</span><span class="n">neurons</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dim</span><span class="p">],</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">,</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">use_bias</span><span class="p">,</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a>                <span class="n">name</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a>                <span class="n">kernel_init</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_init</span><span class="p">,</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a>            <span class="p">)</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a>            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">species_order</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a>        <span class="p">}</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">]]</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">]:</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a>            <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a>                <span class="n">inputs</span><span class="p">,</span> <span class="nb">dict</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a>            <span class="p">),</span> <span class="s2">&quot;input key must be provided if inputs is a dictionary&quot;</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a>            <span class="n">species</span><span class="p">,</span> <span class="n">embedding</span><span class="p">,</span> <span class="n">species_index</span> <span class="o">=</span> <span class="n">inputs</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a>            <span class="n">species</span><span class="p">,</span> <span class="n">embedding</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">],</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">input_key</span><span class="p">]</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a>            <span class="n">species_index</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">species_index_key</span><span class="p">]</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a>            <span class="n">species_index</span><span class="p">,</span> <span class="nb">dict</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a>        <span class="p">),</span> <span class="s2">&quot;species_index must be a dictionary for SpeciesIndexNetHet&quot;</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a>        <span class="c1">############################</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a>        <span class="c1"># initialization =&gt; instantiate all networks</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_initializing</span><span class="p">():</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">embedding</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">embedding</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a>            <span class="p">[</span><span class="n">net</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">net</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a>        <span class="c1">############################</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a>        <span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a>        <span class="n">indices</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a>        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">net</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a>            <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">species_index</span><span class="p">:</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a>                <span class="k">continue</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a>            <span class="n">idx</span> <span class="o">=</span> <span class="n">species_index</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a>            <span class="n">o</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">embedding</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a>            <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a>            <span class="n">indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a>        <span class="n">o</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a>        <span class="n">idx</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a>        <span class="n">out</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a>            <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">species</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">*</span><span class="n">o</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">o</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a>            <span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a>            <span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;drop&quot;</span><span class="p">)</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a>        <span class="p">)</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">squeeze</span> <span class="ow">and</span> <span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a>            <span class="n">out</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a>        <span class="c1">############################</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a>            <span class="n">output_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_key</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_key</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a>            <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="n">output_key</span><span class="p">:</span> <span class="n">out</span><span class="p">}</span> <span class="k">if</span> <span class="n">output_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">out</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a>        <span class="k">return</span> <span class="n">out</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a><span class="k">class</span> <span class="nc">ChemicalNet</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;optimized Chemical-species-specific neural network.</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a><span class="sd">    A neural network that applies a fully connected network to each atom embedding in a chemical system and selects the output corresponding to the atom&#39;s species.</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a><span class="sd">    This is an optimized version of ChemicalNetHet that uses vmap to apply the networks to all atoms at once.</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a><span class="sd">    The optimization is allowed because all networks have the same shape.</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a><span class="sd">    Parameters:</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a><span class="sd">        species_order (Sequence[str]): The species for which to build a network.</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a><span class="sd">        neurons (Sequence[int]): The dimensions of the fully connected networks.</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a><span class="sd">        activation (Callable, optional): The activation function to use in the fully connected networks. Defaults to nn.silu.</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a><span class="sd">        use_bias (bool, optional): Whether to include bias terms in the fully connected networks. Defaults to True.</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a><span class="sd">        input_key (str, optional): The key in the input dictionary that corresponds to the embeddings of the atoms.</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a><span class="sd">            If None, the input is assumed to be a tuple (species,embeddings). Defaults to None.</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a><span class="sd">        output_key (str, optional): The key in the output dictionary that corresponds to the network&#39;s output.</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a><span class="sd">            If None, the output is returned directly. Defaults to None.</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a><span class="sd">        squeeze (bool, optional): Whether to squeeze the output if it has shape (batch_size, 1). Defaults to False.</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a><span class="sd">        kernel_init (Union[str, Callable], optional): The kernel initialization method for the fully connected networks. Defaults to nn.linear.default_kernel_init.</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a>    <span class="n">species_order</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a>    <span class="n">neurons</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a>    <span class="n">activation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">silu</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a>    <span class="n">use_bias</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a>    <span class="n">input_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a>    <span class="n">output_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a>    <span class="n">squeeze</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a>    <span class="n">kernel_init</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">default_kernel_init</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a>    <span class="n">FID</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;CHEMICAL_NET&quot;</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a>    <span class="nd">@nn</span><span class="o">.</span><span class="n">compact</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">]]</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">]:</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a>            <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a>                <span class="n">inputs</span><span class="p">,</span> <span class="nb">dict</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a>            <span class="p">),</span> <span class="s2">&quot;input key must be provided if inputs is a dictionary&quot;</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a>            <span class="n">species</span><span class="p">,</span> <span class="n">embedding</span> <span class="o">=</span> <span class="n">inputs</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a>            <span class="n">species</span><span class="p">,</span> <span class="n">embedding</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">],</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">input_key</span><span class="p">]</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a>        <span class="c1">############################</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a>        <span class="c1"># build species to network index mapping (static =&gt; fixed when jitted)</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a>        <span class="n">rev_idx</span> <span class="o">=</span> <span class="n">PERIODIC_TABLE_REV_IDX</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a>        <span class="n">maxidx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">rev_idx</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_order</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a>            <span class="n">species_order</span> <span class="o">=</span> <span class="p">[</span><span class="n">el</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_order</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a>            <span class="n">species_order</span> <span class="o">=</span> <span class="p">[</span><span class="n">el</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_order</span><span class="p">]</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a>        <span class="n">nspecies</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">species_order</span><span class="p">)</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a>        <span class="n">conv_tensor_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">maxidx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">species_order</span><span class="p">):</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a>            <span class="n">conv_tensor_</span><span class="p">[</span><span class="n">rev_idx</span><span class="p">[</span><span class="n">s</span><span class="p">]]</span> <span class="o">=</span> <span class="n">i</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a>        <span class="n">conv_tensor</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">conv_tensor_</span><span class="p">)</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a>        <span class="n">indices</span> <span class="o">=</span> <span class="n">conv_tensor</span><span class="p">[</span><span class="n">species</span><span class="p">]</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a>        <span class="c1">############################</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a>        <span class="c1"># build shape-sharing networks using vmap</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a>        <span class="n">networks</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a>            <span class="n">FullyConnectedNet</span><span class="p">,</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a>            <span class="n">variable_axes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a>            <span class="n">split_rngs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a>            <span class="n">in_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a>        <span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">neurons</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_bias</span><span class="p">,</span> <span class="n">kernel_init</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_init</span><span class="p">)</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a>        <span class="c1"># repeat input along a new axis to compute for all species at once</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a>            <span class="n">embedding</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="p">(</span><span class="n">nspecies</span><span class="p">,</span> <span class="o">*</span><span class="n">embedding</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a>        <span class="p">)</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos">484</span></a>
</span><span id="L-485"><a href="#L-485"><span class="linenos">485</span></a>        <span class="c1"># apply networks to input and select the output corresponding to the species</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos">486</span></a>        <span class="n">out</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos">487</span></a>            <span class="n">jnp</span><span class="o">.</span><span class="n">take_along_axis</span><span class="p">(</span><span class="n">networks</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">indices</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos">488</span></a>        <span class="p">)</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos">489</span></a>
</span><span id="L-490"><a href="#L-490"><span class="linenos">490</span></a>        <span class="n">out</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">indices</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">out</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos">491</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">squeeze</span> <span class="ow">and</span> <span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos">492</span></a>            <span class="n">out</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos">493</span></a>        <span class="c1">############################</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos">494</span></a>
</span><span id="L-495"><a href="#L-495"><span class="linenos">495</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos">496</span></a>            <span class="n">output_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_key</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_key</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos">497</span></a>            <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="n">output_key</span><span class="p">:</span> <span class="n">out</span><span class="p">}</span> <span class="k">if</span> <span class="n">output_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">out</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos">498</span></a>        <span class="k">return</span> <span class="n">out</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos">499</span></a>
</span><span id="L-500"><a href="#L-500"><span class="linenos">500</span></a>
</span><span id="L-501"><a href="#L-501"><span class="linenos">501</span></a><span class="k">class</span> <span class="nc">MOENet</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos">502</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Mixture of Experts neural network.</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos">503</span></a>
</span><span id="L-504"><a href="#L-504"><span class="linenos">504</span></a><span class="sd">    This class represents a Mixture of Experts neural network. It takes in an input and applies a set of shape-sharing networks</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos">505</span></a><span class="sd">    to the input based on a router. The outputs of the shape-sharing networks are then combined using weights computed by the router.</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos">506</span></a>
</span><span id="L-507"><a href="#L-507"><span class="linenos">507</span></a><span class="sd">    Parameters:</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos">508</span></a><span class="sd">        neurons (Sequence[int]): A sequence of integers representing the number of neurons in each shape-sharing network.</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos">509</span></a><span class="sd">        num_networks (int): The number of shape-sharing networks to create.</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos">510</span></a><span class="sd">        activation (Union[Callable, str], optional): The activation function to use in the shape-sharing networks. Defaults to nn.silu.</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos">511</span></a><span class="sd">        use_bias (bool, optional): Whether to include bias in the shape-sharing networks. Defaults to True.</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos">512</span></a><span class="sd">        input_key (Optional[str], optional): The key to access the input from the inputs dictionary. If None, the input is assumed to be the same as the router. Defaults to None.</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos">513</span></a><span class="sd">        output_key (Optional[str], optional): The key to store the output in the outputs dictionary. If None, the output is stored with the name of the MOENet instance. Defaults to None.</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos">514</span></a><span class="sd">        squeeze (bool, optional): Whether to squeeze the output if it has a shape of (batch_size, 1). Defaults to False.</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos">515</span></a><span class="sd">        kernel_init (Union[str, Callable], optional): The kernel initialization function to use in the shape-sharing networks. Defaults to nn.linear.default_kernel_init.</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos">516</span></a><span class="sd">        router_key (Optional[str], optional): The key to access the router from the inputs dictionary. If None, the router is assumed to be the same as the input. Defaults to None.</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos">517</span></a>
</span><span id="L-518"><a href="#L-518"><span class="linenos">518</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos">519</span></a>
</span><span id="L-520"><a href="#L-520"><span class="linenos">520</span></a>    <span class="n">neurons</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos">521</span></a>    <span class="n">num_networks</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos">522</span></a>    <span class="n">activation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">silu</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos">523</span></a>    <span class="n">use_bias</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos">524</span></a>    <span class="n">input_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos">525</span></a>    <span class="n">output_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos">526</span></a>    <span class="n">squeeze</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos">527</span></a>    <span class="n">kernel_init</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">default_kernel_init</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos">528</span></a>    <span class="n">router_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos">529</span></a>
</span><span id="L-530"><a href="#L-530"><span class="linenos">530</span></a>    <span class="n">FID</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;MOE_NET&quot;</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos">531</span></a>
</span><span id="L-532"><a href="#L-532"><span class="linenos">532</span></a>    <span class="nd">@nn</span><span class="o">.</span><span class="n">compact</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos">533</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos">534</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">]]</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos">535</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">]:</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos">536</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos">537</span></a>            <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos">538</span></a>                <span class="n">inputs</span><span class="p">,</span> <span class="nb">dict</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos">539</span></a>            <span class="p">),</span> <span class="s2">&quot;input key must be provided if inputs is a dictionary&quot;</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos">540</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos">541</span></a>                <span class="n">embedding</span><span class="p">,</span> <span class="n">router</span> <span class="o">=</span> <span class="n">inputs</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos">542</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos">543</span></a>                <span class="n">embedding</span> <span class="o">=</span> <span class="n">router</span> <span class="o">=</span> <span class="n">inputs</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos">544</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos">545</span></a>            <span class="n">embedding</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">input_key</span><span class="p">]</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos">546</span></a>            <span class="n">router</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos">547</span></a>                <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">router_key</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">router_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">embedding</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos">548</span></a>            <span class="p">)</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos">549</span></a>
</span><span id="L-550"><a href="#L-550"><span class="linenos">550</span></a>        <span class="c1">############################</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos">551</span></a>        <span class="c1"># build shape-sharing networks using vmap</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos">552</span></a>        <span class="n">networks</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos">553</span></a>            <span class="n">FullyConnectedNet</span><span class="p">,</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos">554</span></a>            <span class="n">variable_axes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos">555</span></a>            <span class="n">split_rngs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos">556</span></a>            <span class="n">in_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos">557</span></a>            <span class="n">out_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos">558</span></a>        <span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">neurons</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_bias</span><span class="p">,</span> <span class="n">kernel_init</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_init</span><span class="p">)</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos">559</span></a>        <span class="c1"># repeat input along a new axis to compute for all networks at once</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos">560</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">embedding</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_networks</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos">561</span></a>
</span><span id="L-562"><a href="#L-562"><span class="linenos">562</span></a>        <span class="n">w</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_networks</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;router&quot;</span><span class="p">)(</span><span class="n">router</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos">563</span></a>
</span><span id="L-564"><a href="#L-564"><span class="linenos">564</span></a>        <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">networks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">w</span><span class="o">.</span><span class="n">T</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos">565</span></a>
</span><span id="L-566"><a href="#L-566"><span class="linenos">566</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">squeeze</span> <span class="ow">and</span> <span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos">567</span></a>            <span class="n">out</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos">568</span></a>        <span class="c1">############################</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos">569</span></a>
</span><span id="L-570"><a href="#L-570"><span class="linenos">570</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos">571</span></a>            <span class="n">output_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_key</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_key</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos">572</span></a>            <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="n">output_key</span><span class="p">:</span> <span class="n">out</span><span class="p">}</span> <span class="k">if</span> <span class="n">output_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">out</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos">573</span></a>        <span class="k">return</span> <span class="n">out</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos">574</span></a>
</span><span id="L-575"><a href="#L-575"><span class="linenos">575</span></a><span class="k">class</span> <span class="nc">ChannelNet</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos">576</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply a neural network to each channel.</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos">577</span></a>
</span><span id="L-578"><a href="#L-578"><span class="linenos">578</span></a><span class="sd">    Parameters:</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos">579</span></a><span class="sd">        neurons (Sequence[int]): A sequence of integers representing the number of neurons in each shape-sharing network.</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos">580</span></a><span class="sd">        num_networks (int): The number of shape-sharing networks to create.</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos">581</span></a><span class="sd">        activation (Union[Callable, str], optional): The activation function to use in the shape-sharing networks. Defaults to nn.silu.</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos">582</span></a><span class="sd">        use_bias (bool, optional): Whether to include bias in the shape-sharing networks. Defaults to True.</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos">583</span></a><span class="sd">        input_key (Optional[str], optional): The key to access the input from the inputs dictionary. If None, the input is assumed to be the same as the router. Defaults to None.</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos">584</span></a><span class="sd">        output_key (Optional[str], optional): The key to store the output in the outputs dictionary. If None, the output is stored with the name of the MOENet instance. Defaults to None.</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos">585</span></a><span class="sd">        squeeze (bool, optional): Whether to squeeze the output if it has a shape of (batch_size, 1). Defaults to False.</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos">586</span></a><span class="sd">        kernel_init (Union[str, Callable], optional): The kernel initialization function to use in the shape-sharing networks. Defaults to nn.linear.default_kernel_init.</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos">587</span></a><span class="sd">        router_key (Optional[str], optional): The key to access the router from the inputs dictionary. If None, the router is assumed to be the same as the input. Defaults to None.</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos">588</span></a>
</span><span id="L-589"><a href="#L-589"><span class="linenos">589</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos">590</span></a>
</span><span id="L-591"><a href="#L-591"><span class="linenos">591</span></a>    <span class="n">neurons</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos">592</span></a>    <span class="n">activation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">silu</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos">593</span></a>    <span class="n">use_bias</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos">594</span></a>    <span class="n">input_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos">595</span></a>    <span class="n">output_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos">596</span></a>    <span class="n">squeeze</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos">597</span></a>    <span class="n">kernel_init</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">default_kernel_init</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos">598</span></a>    <span class="n">channel_axis</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos">599</span></a>
</span><span id="L-600"><a href="#L-600"><span class="linenos">600</span></a>    <span class="n">FID</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;CHANNEL_NET&quot;</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos">601</span></a>
</span><span id="L-602"><a href="#L-602"><span class="linenos">602</span></a>    <span class="nd">@nn</span><span class="o">.</span><span class="n">compact</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos">603</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos">604</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">]]</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos">605</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">]:</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos">606</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos">607</span></a>            <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos">608</span></a>                <span class="n">inputs</span><span class="p">,</span> <span class="nb">dict</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos">609</span></a>            <span class="p">),</span> <span class="s2">&quot;input key must be provided if inputs is a dictionary&quot;</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos">610</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">inputs</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos">611</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos">612</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">input_key</span><span class="p">]</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos">613</span></a>
</span><span id="L-614"><a href="#L-614"><span class="linenos">614</span></a>        <span class="c1">############################</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos">615</span></a>        <span class="c1"># build shape-sharing networks using vmap</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos">616</span></a>        <span class="n">networks</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos">617</span></a>            <span class="n">FullyConnectedNet</span><span class="p">,</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos">618</span></a>            <span class="n">variable_axes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos">619</span></a>            <span class="n">split_rngs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos">620</span></a>            <span class="n">in_axes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_axis</span><span class="p">,</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos">621</span></a>            <span class="n">out_axes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_axis</span><span class="p">,</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos">622</span></a>        <span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">neurons</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_bias</span><span class="p">,</span> <span class="n">kernel_init</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_init</span><span class="p">)</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos">623</span></a>        <span class="c1"># repeat input along a new axis to compute for all networks at once</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos">624</span></a>
</span><span id="L-625"><a href="#L-625"><span class="linenos">625</span></a>        <span class="n">out</span> <span class="o">=</span> <span class="n">networks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos">626</span></a>
</span><span id="L-627"><a href="#L-627"><span class="linenos">627</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">squeeze</span> <span class="ow">and</span> <span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos">628</span></a>            <span class="n">out</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos">629</span></a>        <span class="c1">############################</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos">630</span></a>
</span><span id="L-631"><a href="#L-631"><span class="linenos">631</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos">632</span></a>            <span class="n">output_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_key</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_key</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos">633</span></a>            <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="n">output_key</span><span class="p">:</span> <span class="n">out</span><span class="p">}</span> <span class="k">if</span> <span class="n">output_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">out</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos">634</span></a>        <span class="k">return</span> <span class="n">out</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos">635</span></a>
</span><span id="L-636"><a href="#L-636"><span class="linenos">636</span></a>
</span><span id="L-637"><a href="#L-637"><span class="linenos">637</span></a><span class="k">class</span> <span class="nc">GatedPerceptron</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos">638</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Gated Perceptron neural network.</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos">639</span></a>
</span><span id="L-640"><a href="#L-640"><span class="linenos">640</span></a><span class="sd">    This class represents a Gated Perceptron neural network model. It applies a gating mechanism</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos">641</span></a><span class="sd">    to the input data and performs linear transformation using a dense layer followed by an activation function.</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos">642</span></a>
</span><span id="L-643"><a href="#L-643"><span class="linenos">643</span></a><span class="sd">    Parameters:</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos">644</span></a><span class="sd">        dim (int): The dimensionality of the output space.</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos">645</span></a><span class="sd">        use_bias (bool, optional): Whether to include a bias term in the dense layer. Defaults to True.</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos">646</span></a><span class="sd">        kernel_init (Union[str, Callable], optional): The initializer for the kernel weights of the dense layer.</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos">647</span></a><span class="sd">            It can be a string representing a predefined initializer or a custom initializer function.</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos">648</span></a><span class="sd">            Defaults to nn.linear.default_kernel_init.</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos">649</span></a><span class="sd">        activation (Union[Callable, str], optional): The activation function to be applied after the dense layer.</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos">650</span></a><span class="sd">            It can be a string representing a predefined activation function or a custom activation function.</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos">651</span></a><span class="sd">            Defaults to nn.silu.</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos">652</span></a><span class="sd">        input_key (Optional[str], optional): The key to access the input data if it is a dictionary.</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos">653</span></a><span class="sd">            If None, assumes the input data is not a dictionary. Defaults to None.</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos">654</span></a><span class="sd">        output_key (Optional[str], optional): The key to store the output data in the dictionary if input_key is not None.</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos">655</span></a><span class="sd">            If None, uses the name of the module as the output key. Defaults to None.</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos">656</span></a><span class="sd">        squeeze (bool, optional): Whether to squeeze the output tensor if its last dimension is 1. Defaults to False.</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos">657</span></a>
</span><span id="L-658"><a href="#L-658"><span class="linenos">658</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos">659</span></a>
</span><span id="L-660"><a href="#L-660"><span class="linenos">660</span></a>    <span class="n">dim</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos">661</span></a>    <span class="n">use_bias</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos">662</span></a>    <span class="n">kernel_init</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">default_kernel_init</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos">663</span></a>    <span class="n">activation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">silu</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos">664</span></a>    <span class="n">input_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos">665</span></a>    <span class="n">output_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos">666</span></a>    <span class="n">squeeze</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos">667</span></a>
</span><span id="L-668"><a href="#L-668"><span class="linenos">668</span></a>    <span class="n">FID</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;GATED_PERCEPTRON&quot;</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos">669</span></a>
</span><span id="L-670"><a href="#L-670"><span class="linenos">670</span></a>    <span class="nd">@nn</span><span class="o">.</span><span class="n">compact</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos">671</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos">672</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos">673</span></a>            <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos">674</span></a>                <span class="n">inputs</span><span class="p">,</span> <span class="nb">dict</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos">675</span></a>            <span class="p">),</span> <span class="s2">&quot;input key must be provided if inputs is a dictionary&quot;</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos">676</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">inputs</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos">677</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos">678</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">input_key</span><span class="p">]</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos">679</span></a>
</span><span id="L-680"><a href="#L-680"><span class="linenos">680</span></a>        <span class="n">activation</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos">681</span></a>            <span class="n">activation_from_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">)</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos">682</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos">683</span></a>            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">activation</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos">684</span></a>        <span class="p">)</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos">685</span></a>        <span class="n">kernel_init</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos">686</span></a>            <span class="n">initializer_from_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_init</span><span class="p">)</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos">687</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_init</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos">688</span></a>            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel_init</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos">689</span></a>        <span class="p">)</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos">690</span></a>        <span class="c1">############################</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos">691</span></a>        <span class="n">gate</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos">692</span></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">,</span> <span class="n">use_bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_bias</span><span class="p">,</span> <span class="n">kernel_init</span><span class="o">=</span><span class="n">kernel_init</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos">693</span></a>        <span class="p">)</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos">694</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">gate</span> <span class="o">*</span> <span class="n">activation</span><span class="p">(</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos">695</span></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">,</span> <span class="n">use_bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_bias</span><span class="p">,</span> <span class="n">kernel_init</span><span class="o">=</span><span class="n">kernel_init</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos">696</span></a>        <span class="p">)</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos">697</span></a>
</span><span id="L-698"><a href="#L-698"><span class="linenos">698</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">squeeze</span> <span class="ow">and</span> <span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos">699</span></a>            <span class="n">out</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos">700</span></a>        <span class="c1">############################</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos">701</span></a>
</span><span id="L-702"><a href="#L-702"><span class="linenos">702</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos">703</span></a>            <span class="n">output_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_key</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_key</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos">704</span></a>            <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="n">output_key</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span> <span class="k">if</span> <span class="n">output_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">x</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos">705</span></a>        <span class="k">return</span> <span class="n">x</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos">706</span></a>
</span><span id="L-707"><a href="#L-707"><span class="linenos">707</span></a>
</span><span id="L-708"><a href="#L-708"><span class="linenos">708</span></a><span class="k">class</span> <span class="nc">ZAcNet</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos">709</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos">710</span></a><span class="sd">    A fully connected neural network module with affine Z-dependent adjustments of activations.</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos">711</span></a>
</span><span id="L-712"><a href="#L-712"><span class="linenos">712</span></a><span class="sd">    Parameters:</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos">713</span></a><span class="sd">        neurons (Sequence[int]): A sequence of integers representing the dimensions of the network.</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos">714</span></a><span class="sd">        zmax (int): The maximum atomic number to consider.</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos">715</span></a><span class="sd">        activation (Union[Callable, str], optional): The activation function to use. Defaults to nn.silu.</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos">716</span></a><span class="sd">        use_bias (bool, optional): Whether to use bias in the dense layers. Defaults to True.</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos">717</span></a><span class="sd">        input_key (Optional[str], optional): The key to use to access the input tensor. Defaults to None.</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos">718</span></a><span class="sd">        output_key (Optional[str], optional): The key to use to access the output tensor. Defaults to None.</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos">719</span></a><span class="sd">        squeeze (bool, optional): Whether to squeeze the output tensor if its shape is (..., 1). Defaults to False.</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos">720</span></a><span class="sd">        kernel_init (Union[str, Callable], optional): The kernel initialization method to use. Defaults to nn.linear.default_kernel_init.</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos">721</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos">722</span></a>
</span><span id="L-723"><a href="#L-723"><span class="linenos">723</span></a>    <span class="n">neurons</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos">724</span></a>    <span class="n">zmax</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">86</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos">725</span></a>    <span class="n">activation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">silu</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos">726</span></a>    <span class="n">use_bias</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos">727</span></a>    <span class="n">input_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos">728</span></a>    <span class="n">output_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos">729</span></a>    <span class="n">squeeze</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos">730</span></a>    <span class="n">kernel_init</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">default_kernel_init</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos">731</span></a>
</span><span id="L-732"><a href="#L-732"><span class="linenos">732</span></a>    <span class="n">FID</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;ZACNET&quot;</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos">733</span></a>
</span><span id="L-734"><a href="#L-734"><span class="linenos">734</span></a>    <span class="nd">@nn</span><span class="o">.</span><span class="n">compact</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos">735</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">]:</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos">736</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos">737</span></a>            <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos">738</span></a>                <span class="n">inputs</span><span class="p">,</span> <span class="nb">dict</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos">739</span></a>            <span class="p">),</span> <span class="s2">&quot;input key must be provided if inputs is a dictionary&quot;</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos">740</span></a>            <span class="n">species</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">inputs</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos">741</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos">742</span></a>            <span class="n">species</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">],</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">input_key</span><span class="p">]</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos">743</span></a>
</span><span id="L-744"><a href="#L-744"><span class="linenos">744</span></a>        <span class="n">activation</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos">745</span></a>            <span class="n">activation_from_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">)</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos">746</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos">747</span></a>            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">activation</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos">748</span></a>        <span class="p">)</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos">749</span></a>        <span class="n">kernel_init</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos">750</span></a>            <span class="n">initializer_from_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_init</span><span class="p">)</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos">751</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_init</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos">752</span></a>            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel_init</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos">753</span></a>        <span class="p">)</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos">754</span></a>        <span class="c1">############################</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos">755</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">neurons</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos">756</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos">757</span></a>                <span class="n">d</span><span class="p">,</span> <span class="n">use_bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_bias</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Layer_</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">kernel_init</span><span class="o">=</span><span class="n">kernel_init</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos">758</span></a>            <span class="p">)(</span><span class="n">x</span><span class="p">)</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos">759</span></a>            <span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">(</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos">760</span></a>                <span class="sa">f</span><span class="s2">&quot;sig_</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos">761</span></a>                <span class="k">lambda</span> <span class="n">key</span><span class="p">,</span> <span class="n">shape</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos">762</span></a>                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zmax</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">d</span><span class="p">),</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos">763</span></a>            <span class="p">)[</span><span class="n">species</span><span class="p">]</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos">764</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_bias</span><span class="p">:</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos">765</span></a>                <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">(</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos">766</span></a>                    <span class="sa">f</span><span class="s2">&quot;b_</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-767"><a href="#L-767"><span class="linenos">767</span></a>                    <span class="k">lambda</span> <span class="n">key</span><span class="p">,</span> <span class="n">shape</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos">768</span></a>                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zmax</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">d</span><span class="p">),</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos">769</span></a>                <span class="p">)[</span><span class="n">species</span><span class="p">]</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos">770</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos">771</span></a>                <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos">772</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">activation</span><span class="p">(</span><span class="n">sig</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos">773</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos">774</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">neurons</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
</span><span id="L-775"><a href="#L-775"><span class="linenos">775</span></a>            <span class="n">use_bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_bias</span><span class="p">,</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos">776</span></a>            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Layer_</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">neurons</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos">777</span></a>            <span class="n">kernel_init</span><span class="o">=</span><span class="n">kernel_init</span><span class="p">,</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos">778</span></a>        <span class="p">)(</span><span class="n">x</span><span class="p">)</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos">779</span></a>        <span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">(</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos">780</span></a>            <span class="sa">f</span><span class="s2">&quot;sig_</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">neurons</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos">781</span></a>            <span class="k">lambda</span> <span class="n">key</span><span class="p">,</span> <span class="n">shape</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos">782</span></a>            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zmax</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">neurons</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos">783</span></a>        <span class="p">)[</span><span class="n">species</span><span class="p">]</span>
</span><span id="L-784"><a href="#L-784"><span class="linenos">784</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_bias</span><span class="p">:</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos">785</span></a>            <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">(</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos">786</span></a>                <span class="sa">f</span><span class="s2">&quot;b_</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">neurons</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-787"><a href="#L-787"><span class="linenos">787</span></a>                <span class="k">lambda</span> <span class="n">key</span><span class="p">,</span> <span class="n">shape</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos">788</span></a>                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zmax</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">neurons</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos">789</span></a>            <span class="p">)[</span><span class="n">species</span><span class="p">]</span>
</span><span id="L-790"><a href="#L-790"><span class="linenos">790</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos">791</span></a>            <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos">792</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">sig</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">b</span>
</span><span id="L-793"><a href="#L-793"><span class="linenos">793</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">squeeze</span> <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos">794</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-795"><a href="#L-795"><span class="linenos">795</span></a>        <span class="c1">############################</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos">796</span></a>
</span><span id="L-797"><a href="#L-797"><span class="linenos">797</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos">798</span></a>            <span class="n">output_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_key</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_key</span>
</span><span id="L-799"><a href="#L-799"><span class="linenos">799</span></a>            <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="n">output_key</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span> <span class="k">if</span> <span class="n">output_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">x</span>
</span><span id="L-800"><a href="#L-800"><span class="linenos">800</span></a>        <span class="k">return</span> <span class="n">x</span>
</span><span id="L-801"><a href="#L-801"><span class="linenos">801</span></a>
</span><span id="L-802"><a href="#L-802"><span class="linenos">802</span></a>
</span><span id="L-803"><a href="#L-803"><span class="linenos">803</span></a><span class="k">class</span> <span class="nc">ZLoRANet</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="L-804"><a href="#L-804"><span class="linenos">804</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos">805</span></a><span class="sd">    A fully connected neural network module with Z-dependent low-rank adaptation.</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos">806</span></a>
</span><span id="L-807"><a href="#L-807"><span class="linenos">807</span></a><span class="sd">    Parameters:</span>
</span><span id="L-808"><a href="#L-808"><span class="linenos">808</span></a><span class="sd">        neurons (Sequence[int]): A sequence of integers representing the dimensions of the network.</span>
</span><span id="L-809"><a href="#L-809"><span class="linenos">809</span></a><span class="sd">        ranks (Sequence[int]): A sequence of integers representing the ranks of the low-rank adaptation matrices.</span>
</span><span id="L-810"><a href="#L-810"><span class="linenos">810</span></a><span class="sd">        zmax (int): The maximum atomic number to consider.</span>
</span><span id="L-811"><a href="#L-811"><span class="linenos">811</span></a><span class="sd">        activation (Union[Callable, str], optional): The activation function to use. Defaults to nn.silu.</span>
</span><span id="L-812"><a href="#L-812"><span class="linenos">812</span></a><span class="sd">        use_bias (bool, optional): Whether to use bias in the dense layers. Defaults to True.</span>
</span><span id="L-813"><a href="#L-813"><span class="linenos">813</span></a><span class="sd">        input_key (Optional[str], optional): The key to use to access the input tensor. Defaults to None.</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos">814</span></a><span class="sd">        output_key (Optional[str], optional): The key to use to access the output tensor. Defaults to None.</span>
</span><span id="L-815"><a href="#L-815"><span class="linenos">815</span></a><span class="sd">        squeeze (bool, optional): Whether to squeeze the output tensor if its shape is (..., 1). Defaults to False.</span>
</span><span id="L-816"><a href="#L-816"><span class="linenos">816</span></a><span class="sd">        kernel_init (Union[str, Callable], optional): The kernel initialization method to use. Defaults to nn.linear.default_kernel_init.</span>
</span><span id="L-817"><a href="#L-817"><span class="linenos">817</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-818"><a href="#L-818"><span class="linenos">818</span></a>
</span><span id="L-819"><a href="#L-819"><span class="linenos">819</span></a>    <span class="n">neurons</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos">820</span></a>    <span class="n">ranks</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
</span><span id="L-821"><a href="#L-821"><span class="linenos">821</span></a>    <span class="n">zmax</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">86</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos">822</span></a>    <span class="n">activation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">silu</span>
</span><span id="L-823"><a href="#L-823"><span class="linenos">823</span></a>    <span class="n">use_bias</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos">824</span></a>    <span class="n">input_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-825"><a href="#L-825"><span class="linenos">825</span></a>    <span class="n">output_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-826"><a href="#L-826"><span class="linenos">826</span></a>    <span class="n">squeeze</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos">827</span></a>    <span class="n">kernel_init</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">default_kernel_init</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos">828</span></a>
</span><span id="L-829"><a href="#L-829"><span class="linenos">829</span></a>    <span class="n">FID</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;ZLORANET&quot;</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos">830</span></a>
</span><span id="L-831"><a href="#L-831"><span class="linenos">831</span></a>    <span class="nd">@nn</span><span class="o">.</span><span class="n">compact</span>
</span><span id="L-832"><a href="#L-832"><span class="linenos">832</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">]:</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos">833</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-834"><a href="#L-834"><span class="linenos">834</span></a>            <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos">835</span></a>                <span class="n">inputs</span><span class="p">,</span> <span class="nb">dict</span>
</span><span id="L-836"><a href="#L-836"><span class="linenos">836</span></a>            <span class="p">),</span> <span class="s2">&quot;input key must be provided if inputs is a dictionary&quot;</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos">837</span></a>            <span class="n">species</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">inputs</span>
</span><span id="L-838"><a href="#L-838"><span class="linenos">838</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos">839</span></a>            <span class="n">species</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">],</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">input_key</span><span class="p">]</span>
</span><span id="L-840"><a href="#L-840"><span class="linenos">840</span></a>
</span><span id="L-841"><a href="#L-841"><span class="linenos">841</span></a>        <span class="n">activation</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos">842</span></a>            <span class="n">activation_from_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">)</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos">843</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
</span><span id="L-844"><a href="#L-844"><span class="linenos">844</span></a>            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">activation</span>
</span><span id="L-845"><a href="#L-845"><span class="linenos">845</span></a>        <span class="p">)</span>
</span><span id="L-846"><a href="#L-846"><span class="linenos">846</span></a>        <span class="n">kernel_init</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-847"><a href="#L-847"><span class="linenos">847</span></a>            <span class="n">initializer_from_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_init</span><span class="p">)</span>
</span><span id="L-848"><a href="#L-848"><span class="linenos">848</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_init</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos">849</span></a>            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel_init</span>
</span><span id="L-850"><a href="#L-850"><span class="linenos">850</span></a>        <span class="p">)</span>
</span><span id="L-851"><a href="#L-851"><span class="linenos">851</span></a>        <span class="c1">############################</span>
</span><span id="L-852"><a href="#L-852"><span class="linenos">852</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">neurons</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
</span><span id="L-853"><a href="#L-853"><span class="linenos">853</span></a>            <span class="n">xi</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span>
</span><span id="L-854"><a href="#L-854"><span class="linenos">854</span></a>                <span class="n">d</span><span class="p">,</span> <span class="n">use_bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_bias</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Layer_</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">kernel_init</span><span class="o">=</span><span class="n">kernel_init</span>
</span><span id="L-855"><a href="#L-855"><span class="linenos">855</span></a>            <span class="p">)(</span><span class="n">x</span><span class="p">)</span>
</span><span id="L-856"><a href="#L-856"><span class="linenos">856</span></a>            <span class="n">A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">(</span>
</span><span id="L-857"><a href="#L-857"><span class="linenos">857</span></a>                <span class="sa">f</span><span class="s2">&quot;A_</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-858"><a href="#L-858"><span class="linenos">858</span></a>                <span class="k">lambda</span> <span class="n">key</span><span class="p">,</span> <span class="n">shape</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
</span><span id="L-859"><a href="#L-859"><span class="linenos">859</span></a>                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zmax</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ranks</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos">860</span></a>            <span class="p">)[</span><span class="n">species</span><span class="p">]</span>
</span><span id="L-861"><a href="#L-861"><span class="linenos">861</span></a>            <span class="n">B</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">(</span>
</span><span id="L-862"><a href="#L-862"><span class="linenos">862</span></a>                <span class="sa">f</span><span class="s2">&quot;B_</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-863"><a href="#L-863"><span class="linenos">863</span></a>                <span class="k">lambda</span> <span class="n">key</span><span class="p">,</span> <span class="n">shape</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
</span><span id="L-864"><a href="#L-864"><span class="linenos">864</span></a>                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zmax</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ranks</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
</span><span id="L-865"><a href="#L-865"><span class="linenos">865</span></a>            <span class="p">)[</span><span class="n">species</span><span class="p">]</span>
</span><span id="L-866"><a href="#L-866"><span class="linenos">866</span></a>            <span class="n">Ax</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;zrd,zd-&gt;zr&quot;</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span><span id="L-867"><a href="#L-867"><span class="linenos">867</span></a>            <span class="n">BAx</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;zrd,zd-&gt;zr&quot;</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">Ax</span><span class="p">)</span>
</span><span id="L-868"><a href="#L-868"><span class="linenos">868</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">activation</span><span class="p">(</span><span class="n">xi</span> <span class="o">+</span> <span class="n">BAx</span><span class="p">)</span>
</span><span id="L-869"><a href="#L-869"><span class="linenos">869</span></a>        <span class="n">xi</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span>
</span><span id="L-870"><a href="#L-870"><span class="linenos">870</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">neurons</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
</span><span id="L-871"><a href="#L-871"><span class="linenos">871</span></a>            <span class="n">use_bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_bias</span><span class="p">,</span>
</span><span id="L-872"><a href="#L-872"><span class="linenos">872</span></a>            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Layer_</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">neurons</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-873"><a href="#L-873"><span class="linenos">873</span></a>            <span class="n">kernel_init</span><span class="o">=</span><span class="n">kernel_init</span><span class="p">,</span>
</span><span id="L-874"><a href="#L-874"><span class="linenos">874</span></a>        <span class="p">)(</span><span class="n">x</span><span class="p">)</span>
</span><span id="L-875"><a href="#L-875"><span class="linenos">875</span></a>        <span class="n">A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">(</span>
</span><span id="L-876"><a href="#L-876"><span class="linenos">876</span></a>            <span class="sa">f</span><span class="s2">&quot;A_</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">neurons</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-877"><a href="#L-877"><span class="linenos">877</span></a>            <span class="k">lambda</span> <span class="n">key</span><span class="p">,</span> <span class="n">shape</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
</span><span id="L-878"><a href="#L-878"><span class="linenos">878</span></a>            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zmax</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ranks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="L-879"><a href="#L-879"><span class="linenos">879</span></a>        <span class="p">)[</span><span class="n">species</span><span class="p">]</span>
</span><span id="L-880"><a href="#L-880"><span class="linenos">880</span></a>        <span class="n">B</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">(</span>
</span><span id="L-881"><a href="#L-881"><span class="linenos">881</span></a>            <span class="sa">f</span><span class="s2">&quot;B_</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">neurons</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-882"><a href="#L-882"><span class="linenos">882</span></a>            <span class="k">lambda</span> <span class="n">key</span><span class="p">,</span> <span class="n">shape</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
</span><span id="L-883"><a href="#L-883"><span class="linenos">883</span></a>            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zmax</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">neurons</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">ranks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="L-884"><a href="#L-884"><span class="linenos">884</span></a>        <span class="p">)[</span><span class="n">species</span><span class="p">]</span>
</span><span id="L-885"><a href="#L-885"><span class="linenos">885</span></a>        <span class="n">Ax</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;zrd,zd-&gt;zr&quot;</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span><span id="L-886"><a href="#L-886"><span class="linenos">886</span></a>        <span class="n">BAx</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;zrd,zd-&gt;zr&quot;</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">Ax</span><span class="p">)</span>
</span><span id="L-887"><a href="#L-887"><span class="linenos">887</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">xi</span> <span class="o">+</span> <span class="n">BAx</span>
</span><span id="L-888"><a href="#L-888"><span class="linenos">888</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">squeeze</span> <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-889"><a href="#L-889"><span class="linenos">889</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-890"><a href="#L-890"><span class="linenos">890</span></a>        <span class="c1">############################</span>
</span><span id="L-891"><a href="#L-891"><span class="linenos">891</span></a>
</span><span id="L-892"><a href="#L-892"><span class="linenos">892</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-893"><a href="#L-893"><span class="linenos">893</span></a>            <span class="n">output_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_key</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_key</span>
</span><span id="L-894"><a href="#L-894"><span class="linenos">894</span></a>            <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="n">output_key</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span> <span class="k">if</span> <span class="n">output_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">x</span>
</span><span id="L-895"><a href="#L-895"><span class="linenos">895</span></a>        <span class="k">return</span> <span class="n">x</span>
</span></pre></div>


            </section>
                <section id="FullyConnectedNet">
                            <input id="FullyConnectedNet-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">FullyConnectedNet</span><wbr>(<span class="base">flax.linen.module.Module</span>):

                <label class="view-source-button" for="FullyConnectedNet-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#FullyConnectedNet"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="FullyConnectedNet-15"><a href="#FullyConnectedNet-15"><span class="linenos">15</span></a><span class="k">class</span> <span class="nc">FullyConnectedNet</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="FullyConnectedNet-16"><a href="#FullyConnectedNet-16"><span class="linenos">16</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;A fully connected neural network module.</span>
</span><span id="FullyConnectedNet-17"><a href="#FullyConnectedNet-17"><span class="linenos">17</span></a>
</span><span id="FullyConnectedNet-18"><a href="#FullyConnectedNet-18"><span class="linenos">18</span></a><span class="sd">    Parameters:</span>
</span><span id="FullyConnectedNet-19"><a href="#FullyConnectedNet-19"><span class="linenos">19</span></a><span class="sd">        neurons (Sequence[int]): A sequence of integers representing the dimensions of the network.</span>
</span><span id="FullyConnectedNet-20"><a href="#FullyConnectedNet-20"><span class="linenos">20</span></a><span class="sd">        activation (Union[Callable, str], optional): The activation function to use. Defaults to nn.silu.</span>
</span><span id="FullyConnectedNet-21"><a href="#FullyConnectedNet-21"><span class="linenos">21</span></a><span class="sd">        use_bias (bool, optional): Whether to use bias in the dense layers. Defaults to True.</span>
</span><span id="FullyConnectedNet-22"><a href="#FullyConnectedNet-22"><span class="linenos">22</span></a><span class="sd">        input_key (Optional[str], optional): The key to use to access the input tensor. Defaults to None.</span>
</span><span id="FullyConnectedNet-23"><a href="#FullyConnectedNet-23"><span class="linenos">23</span></a><span class="sd">        output_key (Optional[str], optional): The key to use to access the output tensor. Defaults to None.</span>
</span><span id="FullyConnectedNet-24"><a href="#FullyConnectedNet-24"><span class="linenos">24</span></a><span class="sd">        squeeze (bool, optional): Whether to squeeze the output tensor if its shape is (..., 1). Defaults to False.</span>
</span><span id="FullyConnectedNet-25"><a href="#FullyConnectedNet-25"><span class="linenos">25</span></a><span class="sd">        kernel_init (Union[str, Callable], optional): The kernel initialization method to use. Defaults to nn.linear.default_kernel_init.</span>
</span><span id="FullyConnectedNet-26"><a href="#FullyConnectedNet-26"><span class="linenos">26</span></a>
</span><span id="FullyConnectedNet-27"><a href="#FullyConnectedNet-27"><span class="linenos">27</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="FullyConnectedNet-28"><a href="#FullyConnectedNet-28"><span class="linenos">28</span></a>
</span><span id="FullyConnectedNet-29"><a href="#FullyConnectedNet-29"><span class="linenos">29</span></a>    <span class="n">neurons</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
</span><span id="FullyConnectedNet-30"><a href="#FullyConnectedNet-30"><span class="linenos">30</span></a>    <span class="n">activation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">silu</span>
</span><span id="FullyConnectedNet-31"><a href="#FullyConnectedNet-31"><span class="linenos">31</span></a>    <span class="n">use_bias</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="FullyConnectedNet-32"><a href="#FullyConnectedNet-32"><span class="linenos">32</span></a>    <span class="n">input_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="FullyConnectedNet-33"><a href="#FullyConnectedNet-33"><span class="linenos">33</span></a>    <span class="n">output_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="FullyConnectedNet-34"><a href="#FullyConnectedNet-34"><span class="linenos">34</span></a>    <span class="n">squeeze</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="FullyConnectedNet-35"><a href="#FullyConnectedNet-35"><span class="linenos">35</span></a>    <span class="n">kernel_init</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">default_kernel_init</span>
</span><span id="FullyConnectedNet-36"><a href="#FullyConnectedNet-36"><span class="linenos">36</span></a>
</span><span id="FullyConnectedNet-37"><a href="#FullyConnectedNet-37"><span class="linenos">37</span></a>    <span class="n">FID</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;NEURAL_NET&quot;</span>
</span><span id="FullyConnectedNet-38"><a href="#FullyConnectedNet-38"><span class="linenos">38</span></a>
</span><span id="FullyConnectedNet-39"><a href="#FullyConnectedNet-39"><span class="linenos">39</span></a>    <span class="nd">@nn</span><span class="o">.</span><span class="n">compact</span>
</span><span id="FullyConnectedNet-40"><a href="#FullyConnectedNet-40"><span class="linenos">40</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">]:</span>
</span><span id="FullyConnectedNet-41"><a href="#FullyConnectedNet-41"><span class="linenos">41</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Applies the neural network to the given inputs.</span>
</span><span id="FullyConnectedNet-42"><a href="#FullyConnectedNet-42"><span class="linenos">42</span></a>
</span><span id="FullyConnectedNet-43"><a href="#FullyConnectedNet-43"><span class="linenos">43</span></a><span class="sd">        Args:</span>
</span><span id="FullyConnectedNet-44"><a href="#FullyConnectedNet-44"><span class="linenos">44</span></a><span class="sd">            inputs (Union[dict, jax.Array]): If input_key is None, a JAX array containing the inputs to the neural network. Else, a dictionary containing the inputs at the key input_key.</span>
</span><span id="FullyConnectedNet-45"><a href="#FullyConnectedNet-45"><span class="linenos">45</span></a>
</span><span id="FullyConnectedNet-46"><a href="#FullyConnectedNet-46"><span class="linenos">46</span></a><span class="sd">        Returns:</span>
</span><span id="FullyConnectedNet-47"><a href="#FullyConnectedNet-47"><span class="linenos">47</span></a><span class="sd">            Union[dict, jax.Array]: If output_key is None, the output tensor of the neural network. Else, a dictionary containing the original inputs and the output tensor at the key output_key.</span>
</span><span id="FullyConnectedNet-48"><a href="#FullyConnectedNet-48"><span class="linenos">48</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="FullyConnectedNet-49"><a href="#FullyConnectedNet-49"><span class="linenos">49</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="FullyConnectedNet-50"><a href="#FullyConnectedNet-50"><span class="linenos">50</span></a>            <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
</span><span id="FullyConnectedNet-51"><a href="#FullyConnectedNet-51"><span class="linenos">51</span></a>                <span class="n">inputs</span><span class="p">,</span> <span class="nb">dict</span>
</span><span id="FullyConnectedNet-52"><a href="#FullyConnectedNet-52"><span class="linenos">52</span></a>            <span class="p">),</span> <span class="s2">&quot;input key must be provided if inputs is a dictionary&quot;</span>
</span><span id="FullyConnectedNet-53"><a href="#FullyConnectedNet-53"><span class="linenos">53</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">inputs</span>
</span><span id="FullyConnectedNet-54"><a href="#FullyConnectedNet-54"><span class="linenos">54</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="FullyConnectedNet-55"><a href="#FullyConnectedNet-55"><span class="linenos">55</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">input_key</span><span class="p">]</span>
</span><span id="FullyConnectedNet-56"><a href="#FullyConnectedNet-56"><span class="linenos">56</span></a>
</span><span id="FullyConnectedNet-57"><a href="#FullyConnectedNet-57"><span class="linenos">57</span></a>        <span class="n">activation</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="FullyConnectedNet-58"><a href="#FullyConnectedNet-58"><span class="linenos">58</span></a>            <span class="n">activation_from_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">)</span>
</span><span id="FullyConnectedNet-59"><a href="#FullyConnectedNet-59"><span class="linenos">59</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
</span><span id="FullyConnectedNet-60"><a href="#FullyConnectedNet-60"><span class="linenos">60</span></a>            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">activation</span>
</span><span id="FullyConnectedNet-61"><a href="#FullyConnectedNet-61"><span class="linenos">61</span></a>        <span class="p">)</span>
</span><span id="FullyConnectedNet-62"><a href="#FullyConnectedNet-62"><span class="linenos">62</span></a>        <span class="n">kernel_init</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="FullyConnectedNet-63"><a href="#FullyConnectedNet-63"><span class="linenos">63</span></a>            <span class="n">initializer_from_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_init</span><span class="p">)</span>
</span><span id="FullyConnectedNet-64"><a href="#FullyConnectedNet-64"><span class="linenos">64</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_init</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
</span><span id="FullyConnectedNet-65"><a href="#FullyConnectedNet-65"><span class="linenos">65</span></a>            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel_init</span>
</span><span id="FullyConnectedNet-66"><a href="#FullyConnectedNet-66"><span class="linenos">66</span></a>        <span class="p">)</span>
</span><span id="FullyConnectedNet-67"><a href="#FullyConnectedNet-67"><span class="linenos">67</span></a>        <span class="c1">############################</span>
</span><span id="FullyConnectedNet-68"><a href="#FullyConnectedNet-68"><span class="linenos">68</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">neurons</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
</span><span id="FullyConnectedNet-69"><a href="#FullyConnectedNet-69"><span class="linenos">69</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span>
</span><span id="FullyConnectedNet-70"><a href="#FullyConnectedNet-70"><span class="linenos">70</span></a>                <span class="n">d</span><span class="p">,</span>
</span><span id="FullyConnectedNet-71"><a href="#FullyConnectedNet-71"><span class="linenos">71</span></a>                <span class="n">use_bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_bias</span><span class="p">,</span>
</span><span id="FullyConnectedNet-72"><a href="#FullyConnectedNet-72"><span class="linenos">72</span></a>                <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Layer_</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="FullyConnectedNet-73"><a href="#FullyConnectedNet-73"><span class="linenos">73</span></a>                <span class="n">kernel_init</span><span class="o">=</span><span class="n">kernel_init</span><span class="p">,</span>
</span><span id="FullyConnectedNet-74"><a href="#FullyConnectedNet-74"><span class="linenos">74</span></a>                <span class="c1"># precision=jax.lax.Precision.HIGH,</span>
</span><span id="FullyConnectedNet-75"><a href="#FullyConnectedNet-75"><span class="linenos">75</span></a>            <span class="p">)(</span><span class="n">x</span><span class="p">)</span>
</span><span id="FullyConnectedNet-76"><a href="#FullyConnectedNet-76"><span class="linenos">76</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">activation</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="FullyConnectedNet-77"><a href="#FullyConnectedNet-77"><span class="linenos">77</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span>
</span><span id="FullyConnectedNet-78"><a href="#FullyConnectedNet-78"><span class="linenos">78</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">neurons</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
</span><span id="FullyConnectedNet-79"><a href="#FullyConnectedNet-79"><span class="linenos">79</span></a>            <span class="n">use_bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_bias</span><span class="p">,</span>
</span><span id="FullyConnectedNet-80"><a href="#FullyConnectedNet-80"><span class="linenos">80</span></a>            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Layer_</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">neurons</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="FullyConnectedNet-81"><a href="#FullyConnectedNet-81"><span class="linenos">81</span></a>            <span class="n">kernel_init</span><span class="o">=</span><span class="n">kernel_init</span><span class="p">,</span>
</span><span id="FullyConnectedNet-82"><a href="#FullyConnectedNet-82"><span class="linenos">82</span></a>            <span class="c1"># precision=jax.lax.Precision.HIGH,</span>
</span><span id="FullyConnectedNet-83"><a href="#FullyConnectedNet-83"><span class="linenos">83</span></a>        <span class="p">)(</span><span class="n">x</span><span class="p">)</span>
</span><span id="FullyConnectedNet-84"><a href="#FullyConnectedNet-84"><span class="linenos">84</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">squeeze</span> <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="FullyConnectedNet-85"><a href="#FullyConnectedNet-85"><span class="linenos">85</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="FullyConnectedNet-86"><a href="#FullyConnectedNet-86"><span class="linenos">86</span></a>        <span class="c1">############################</span>
</span><span id="FullyConnectedNet-87"><a href="#FullyConnectedNet-87"><span class="linenos">87</span></a>
</span><span id="FullyConnectedNet-88"><a href="#FullyConnectedNet-88"><span class="linenos">88</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="FullyConnectedNet-89"><a href="#FullyConnectedNet-89"><span class="linenos">89</span></a>            <span class="n">output_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_key</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_key</span>
</span><span id="FullyConnectedNet-90"><a href="#FullyConnectedNet-90"><span class="linenos">90</span></a>            <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="n">output_key</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span> <span class="k">if</span> <span class="n">output_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">x</span>
</span><span id="FullyConnectedNet-91"><a href="#FullyConnectedNet-91"><span class="linenos">91</span></a>        <span class="k">return</span> <span class="n">x</span>
</span></pre></div>


            <div class="docstring"><p>A fully connected neural network module.</p>

<p>Parameters:
    neurons (Sequence[int]): A sequence of integers representing the dimensions of the network.
    activation (Union[Callable, str], optional): The activation function to use. Defaults to nn.silu.
    use_bias (bool, optional): Whether to use bias in the dense layers. Defaults to True.
    input_key (Optional[str], optional): The key to use to access the input tensor. Defaults to None.
    output_key (Optional[str], optional): The key to use to access the output tensor. Defaults to None.
    squeeze (bool, optional): Whether to squeeze the output tensor if its shape is (..., 1). Defaults to False.
    kernel_init (Union[str, Callable], optional): The kernel initialization method to use. Defaults to nn.linear.default_kernel_init.</p>
</div>


                            <div id="FullyConnectedNet.__init__" class="classattr">
                                <div class="attr function">
            
        <span class="name">FullyConnectedNet</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">neurons</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>,</span><span class="param">	<span class="n">activation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">PjitFunction</span> <span class="n">of</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">silu</span><span class="o">&gt;&gt;</span>,</span><span class="param">	<span class="n">use_bias</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">input_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">output_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">squeeze</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">kernel_init</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">variance_scaling</span><span class="o">.&lt;</span><span class="nb">locals</span><span class="o">&gt;.</span><span class="n">init</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">FID</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;NEURAL_NET&#39;</span>,</span><span class="param">	<span class="n">parent</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">flax</span><span class="o">.</span><span class="n">linen</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">Module</span><span class="p">],</span> <span class="n">flax</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">Scope</span><span class="p">,</span> <span class="n">Type</span><span class="p">[</span><span class="n">flax</span><span class="o">.</span><span class="n">linen</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">_Sentinel</span><span class="p">],</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">flax</span><span class="o">.</span><span class="n">linen</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">_Sentinel</span> <span class="nb">object</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

        
    </div>
    <a class="headerlink" href="#FullyConnectedNet.__init__"></a>
    
    

                            </div>
                            <div id="FullyConnectedNet.neurons" class="classattr">
                                <div class="attr variable">
            <span class="name">neurons</span><span class="annotation">: Sequence[int]</span>

        
    </div>
    <a class="headerlink" href="#FullyConnectedNet.neurons"></a>
    
    

                            </div>
                            <div id="FullyConnectedNet.activation" class="classattr">
                                        <input id="FullyConnectedNet.activation-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@jax.jit</div>

        <span class="def">def</span>
        <span class="name">activation</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">x</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">bool_</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span>:</span></span>

                <label class="view-source-button" for="FullyConnectedNet.activation-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#FullyConnectedNet.activation"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="FullyConnectedNet.activation-151"><a href="#FullyConnectedNet.activation-151"><span class="linenos">151</span></a><span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
</span><span id="FullyConnectedNet.activation-152"><a href="#FullyConnectedNet.activation-152"><span class="linenos">152</span></a><span class="k">def</span> <span class="nf">silu</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="p">:</span>
</span><span id="FullyConnectedNet.activation-153"><a href="#FullyConnectedNet.activation-153"><span class="linenos">153</span></a><span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;SiLU (a.k.a. swish) activation function.</span>
</span><span id="FullyConnectedNet.activation-154"><a href="#FullyConnectedNet.activation-154"><span class="linenos">154</span></a>
</span><span id="FullyConnectedNet.activation-155"><a href="#FullyConnectedNet.activation-155"><span class="linenos">155</span></a><span class="sd">  Computes the element-wise function:</span>
</span><span id="FullyConnectedNet.activation-156"><a href="#FullyConnectedNet.activation-156"><span class="linenos">156</span></a>
</span><span id="FullyConnectedNet.activation-157"><a href="#FullyConnectedNet.activation-157"><span class="linenos">157</span></a><span class="sd">  .. math::</span>
</span><span id="FullyConnectedNet.activation-158"><a href="#FullyConnectedNet.activation-158"><span class="linenos">158</span></a><span class="sd">    \mathrm{silu}(x) = x \cdot \mathrm{sigmoid}(x) = \frac{x}{1 + e^{-x}}</span>
</span><span id="FullyConnectedNet.activation-159"><a href="#FullyConnectedNet.activation-159"><span class="linenos">159</span></a>
</span><span id="FullyConnectedNet.activation-160"><a href="#FullyConnectedNet.activation-160"><span class="linenos">160</span></a><span class="sd">  :func:`swish` and :func:`silu` are both aliases for the same function.</span>
</span><span id="FullyConnectedNet.activation-161"><a href="#FullyConnectedNet.activation-161"><span class="linenos">161</span></a>
</span><span id="FullyConnectedNet.activation-162"><a href="#FullyConnectedNet.activation-162"><span class="linenos">162</span></a><span class="sd">  Args:</span>
</span><span id="FullyConnectedNet.activation-163"><a href="#FullyConnectedNet.activation-163"><span class="linenos">163</span></a><span class="sd">    x : input array</span>
</span><span id="FullyConnectedNet.activation-164"><a href="#FullyConnectedNet.activation-164"><span class="linenos">164</span></a>
</span><span id="FullyConnectedNet.activation-165"><a href="#FullyConnectedNet.activation-165"><span class="linenos">165</span></a><span class="sd">  Returns:</span>
</span><span id="FullyConnectedNet.activation-166"><a href="#FullyConnectedNet.activation-166"><span class="linenos">166</span></a><span class="sd">    An array.</span>
</span><span id="FullyConnectedNet.activation-167"><a href="#FullyConnectedNet.activation-167"><span class="linenos">167</span></a>
</span><span id="FullyConnectedNet.activation-168"><a href="#FullyConnectedNet.activation-168"><span class="linenos">168</span></a><span class="sd">  See also:</span>
</span><span id="FullyConnectedNet.activation-169"><a href="#FullyConnectedNet.activation-169"><span class="linenos">169</span></a><span class="sd">    :func:`sigmoid`</span>
</span><span id="FullyConnectedNet.activation-170"><a href="#FullyConnectedNet.activation-170"><span class="linenos">170</span></a><span class="sd">  &quot;&quot;&quot;</span>
</span><span id="FullyConnectedNet.activation-171"><a href="#FullyConnectedNet.activation-171"><span class="linenos">171</span></a>  <span class="n">numpy_util</span><span class="o">.</span><span class="n">check_arraylike</span><span class="p">(</span><span class="s2">&quot;silu&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span><span id="FullyConnectedNet.activation-172"><a href="#FullyConnectedNet.activation-172"><span class="linenos">172</span></a>  <span class="n">x_arr</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="FullyConnectedNet.activation-173"><a href="#FullyConnectedNet.activation-173"><span class="linenos">173</span></a>  <span class="k">return</span> <span class="n">x_arr</span> <span class="o">*</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">x_arr</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>SiLU (a.k.a. swish) activation function.</p>

<p>Computes the element-wise function:</p>

<p>$$\mathrm{silu}(x) = x \cdot \mathrm{sigmoid}(x) = \frac{x}{1 + e^{-x}}$$</p>

<p><code>swish()</code> and <code>silu()</code> are both aliases for the same function.</p>

<p>Args:
  x : input array</p>

<p>Returns:
  An array.</p>

<p>See also:
  <code>sigmoid()</code></p>
</div>


                            </div>
                            <div id="FullyConnectedNet.use_bias" class="classattr">
                                <div class="attr variable">
            <span class="name">use_bias</span><span class="annotation">: bool</span>        =
<span class="default_value">True</span>

        
    </div>
    <a class="headerlink" href="#FullyConnectedNet.use_bias"></a>
    
    

                            </div>
                            <div id="FullyConnectedNet.input_key" class="classattr">
                                <div class="attr variable">
            <span class="name">input_key</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#FullyConnectedNet.input_key"></a>
    
    

                            </div>
                            <div id="FullyConnectedNet.output_key" class="classattr">
                                <div class="attr variable">
            <span class="name">output_key</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#FullyConnectedNet.output_key"></a>
    
    

                            </div>
                            <div id="FullyConnectedNet.squeeze" class="classattr">
                                <div class="attr variable">
            <span class="name">squeeze</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#FullyConnectedNet.squeeze"></a>
    
    

                            </div>
                            <div id="FullyConnectedNet.kernel_init" class="classattr">
                                        <input id="FullyConnectedNet.kernel_init-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">kernel_init</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">key</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span>,</span><span class="param">	<span class="n">shape</span><span class="p">:</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]]</span>,</span><span class="param">	dtype: Any = &lt;class &#x27;jax.numpy.float64&#x27;&gt;</span><span class="return-annotation">) -> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span>:</span></span>

                <label class="view-source-button" for="FullyConnectedNet.kernel_init-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#FullyConnectedNet.kernel_init"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="FullyConnectedNet.kernel_init-317"><a href="#FullyConnectedNet.kernel_init-317"><span class="linenos">317</span></a>  <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">KeyArray</span><span class="p">,</span>
</span><span id="FullyConnectedNet.kernel_init-318"><a href="#FullyConnectedNet.kernel_init-318"><span class="linenos">318</span></a>           <span class="n">shape</span><span class="p">:</span> <span class="n">core</span><span class="o">.</span><span class="n">Shape</span><span class="p">,</span>
</span><span id="FullyConnectedNet.kernel_init-319"><a href="#FullyConnectedNet.kernel_init-319"><span class="linenos">319</span></a>           <span class="n">dtype</span><span class="p">:</span> <span class="n">DTypeLikeInexact</span> <span class="o">=</span> <span class="n">dtype</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="p">:</span>
</span><span id="FullyConnectedNet.kernel_init-320"><a href="#FullyConnectedNet.kernel_init-320"><span class="linenos">320</span></a>    <span class="n">dtype</span> <span class="o">=</span> <span class="n">dtypes</span><span class="o">.</span><span class="n">canonicalize_dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="FullyConnectedNet.kernel_init-321"><a href="#FullyConnectedNet.kernel_init-321"><span class="linenos">321</span></a>    <span class="n">named_shape</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">as_named_shape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
</span><span id="FullyConnectedNet.kernel_init-322"><a href="#FullyConnectedNet.kernel_init-322"><span class="linenos">322</span></a>    <span class="n">fan_in</span><span class="p">,</span> <span class="n">fan_out</span> <span class="o">=</span> <span class="n">_compute_fans</span><span class="p">(</span><span class="n">named_shape</span><span class="p">,</span> <span class="n">in_axis</span><span class="p">,</span> <span class="n">out_axis</span><span class="p">,</span> <span class="n">batch_axis</span><span class="p">)</span>
</span><span id="FullyConnectedNet.kernel_init-323"><a href="#FullyConnectedNet.kernel_init-323"><span class="linenos">323</span></a>    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;fan_in&quot;</span><span class="p">:</span> <span class="n">denominator</span> <span class="o">=</span> <span class="n">fan_in</span>
</span><span id="FullyConnectedNet.kernel_init-324"><a href="#FullyConnectedNet.kernel_init-324"><span class="linenos">324</span></a>    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;fan_out&quot;</span><span class="p">:</span> <span class="n">denominator</span> <span class="o">=</span> <span class="n">fan_out</span>
</span><span id="FullyConnectedNet.kernel_init-325"><a href="#FullyConnectedNet.kernel_init-325"><span class="linenos">325</span></a>    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;fan_avg&quot;</span><span class="p">:</span> <span class="n">denominator</span> <span class="o">=</span> <span class="p">(</span><span class="n">fan_in</span> <span class="o">+</span> <span class="n">fan_out</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="FullyConnectedNet.kernel_init-326"><a href="#FullyConnectedNet.kernel_init-326"><span class="linenos">326</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="FullyConnectedNet.kernel_init-327"><a href="#FullyConnectedNet.kernel_init-327"><span class="linenos">327</span></a>      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="FullyConnectedNet.kernel_init-328"><a href="#FullyConnectedNet.kernel_init-328"><span class="linenos">328</span></a>        <span class="sa">f</span><span class="s2">&quot;invalid mode for variance scaling initializer: </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="FullyConnectedNet.kernel_init-329"><a href="#FullyConnectedNet.kernel_init-329"><span class="linenos">329</span></a>    <span class="n">variance</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">scale</span> <span class="o">/</span> <span class="n">denominator</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="FullyConnectedNet.kernel_init-330"><a href="#FullyConnectedNet.kernel_init-330"><span class="linenos">330</span></a>
</span><span id="FullyConnectedNet.kernel_init-331"><a href="#FullyConnectedNet.kernel_init-331"><span class="linenos">331</span></a>    <span class="k">if</span> <span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;truncated_normal&quot;</span><span class="p">:</span>
</span><span id="FullyConnectedNet.kernel_init-332"><a href="#FullyConnectedNet.kernel_init-332"><span class="linenos">332</span></a>      <span class="k">if</span> <span class="n">jnp</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">floating</span><span class="p">):</span>
</span><span id="FullyConnectedNet.kernel_init-333"><a href="#FullyConnectedNet.kernel_init-333"><span class="linenos">333</span></a>        <span class="c1"># constant is stddev of standard normal truncated to (-2, 2)</span>
</span><span id="FullyConnectedNet.kernel_init-334"><a href="#FullyConnectedNet.kernel_init-334"><span class="linenos">334</span></a>        <span class="n">stddev</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">.87962566103423978</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
</span><span id="FullyConnectedNet.kernel_init-335"><a href="#FullyConnectedNet.kernel_init-335"><span class="linenos">335</span></a>        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">truncated_normal</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">named_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="n">stddev</span>
</span><span id="FullyConnectedNet.kernel_init-336"><a href="#FullyConnectedNet.kernel_init-336"><span class="linenos">336</span></a>      <span class="k">else</span><span class="p">:</span>
</span><span id="FullyConnectedNet.kernel_init-337"><a href="#FullyConnectedNet.kernel_init-337"><span class="linenos">337</span></a>        <span class="c1"># constant is stddev of complex standard normal truncated to 2</span>
</span><span id="FullyConnectedNet.kernel_init-338"><a href="#FullyConnectedNet.kernel_init-338"><span class="linenos">338</span></a>        <span class="n">stddev</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">.95311164380491208</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
</span><span id="FullyConnectedNet.kernel_init-339"><a href="#FullyConnectedNet.kernel_init-339"><span class="linenos">339</span></a>        <span class="k">return</span> <span class="n">_complex_truncated_normal</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">named_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="n">stddev</span>
</span><span id="FullyConnectedNet.kernel_init-340"><a href="#FullyConnectedNet.kernel_init-340"><span class="linenos">340</span></a>    <span class="k">elif</span> <span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;normal&quot;</span><span class="p">:</span>
</span><span id="FullyConnectedNet.kernel_init-341"><a href="#FullyConnectedNet.kernel_init-341"><span class="linenos">341</span></a>      <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">named_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span>
</span><span id="FullyConnectedNet.kernel_init-342"><a href="#FullyConnectedNet.kernel_init-342"><span class="linenos">342</span></a>    <span class="k">elif</span> <span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;uniform&quot;</span><span class="p">:</span>
</span><span id="FullyConnectedNet.kernel_init-343"><a href="#FullyConnectedNet.kernel_init-343"><span class="linenos">343</span></a>      <span class="k">if</span> <span class="n">jnp</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">floating</span><span class="p">):</span>
</span><span id="FullyConnectedNet.kernel_init-344"><a href="#FullyConnectedNet.kernel_init-344"><span class="linenos">344</span></a>        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">named_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">variance</span><span class="p">)</span>
</span><span id="FullyConnectedNet.kernel_init-345"><a href="#FullyConnectedNet.kernel_init-345"><span class="linenos">345</span></a>      <span class="k">else</span><span class="p">:</span>
</span><span id="FullyConnectedNet.kernel_init-346"><a href="#FullyConnectedNet.kernel_init-346"><span class="linenos">346</span></a>        <span class="k">return</span> <span class="n">_complex_uniform</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">named_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span>
</span><span id="FullyConnectedNet.kernel_init-347"><a href="#FullyConnectedNet.kernel_init-347"><span class="linenos">347</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="FullyConnectedNet.kernel_init-348"><a href="#FullyConnectedNet.kernel_init-348"><span class="linenos">348</span></a>      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;invalid distribution for variance scaling initializer: </span><span class="si">{</span><span class="n">distribution</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="FullyConnectedNet.FID" class="classattr">
                                <div class="attr variable">
            <span class="name">FID</span><span class="annotation">: str</span>        =
<span class="default_value">&#39;NEURAL_NET&#39;</span>

        
    </div>
    <a class="headerlink" href="#FullyConnectedNet.FID"></a>
    
    

                            </div>
                            <div id="FullyConnectedNet.parent" class="classattr">
                                <div class="attr variable">
            <span class="name">parent</span><span class="annotation">: Union[Type[flax.linen.module.Module], flax.core.scope.Scope, Type[flax.linen.module._Sentinel], NoneType]</span>

        
    </div>
    <a class="headerlink" href="#FullyConnectedNet.parent"></a>
    
            <div class="docstring"><p>Wraps parent module references in weak refs.</p>

<p>This prevents reference cycles from forming via parent links which can lead
to accidental OOMs in eager mode due to slow garbage collection as well as
spurious tracer leaks during jit compilation.</p>

<p>Note: "descriptors" are the underlying python mechanism for implementing
dynamic @property decorators.  We need to use a raw descriptor instead of the
more common decorator in order to force that the appropriate getter/setter
logic applies in subclasses even after various dataclass transforms.</p>
</div>


                            </div>
                            <div id="FullyConnectedNet.name" class="classattr">
                                <div class="attr variable">
            <span class="name">name</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#FullyConnectedNet.name"></a>
    
    

                            </div>
                            <div id="FullyConnectedNet.scope" class="classattr">
                                <div class="attr variable">
            <span class="name">scope</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#FullyConnectedNet.scope"></a>
    
    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>flax.linen.module.Module</dt>
                                <dd id="FullyConnectedNet.setup" class="function">setup</dd>
                <dd id="FullyConnectedNet.path" class="variable">path</dd>
                <dd id="FullyConnectedNet.clone" class="function">clone</dd>
                <dd id="FullyConnectedNet.copy" class="function">copy</dd>
                <dd id="FullyConnectedNet.variable" class="function">variable</dd>
                <dd id="FullyConnectedNet.param" class="function">param</dd>
                <dd id="FullyConnectedNet.has_variable" class="function">has_variable</dd>
                <dd id="FullyConnectedNet.is_mutable_collection" class="function">is_mutable_collection</dd>
                <dd id="FullyConnectedNet.has_rng" class="function">has_rng</dd>
                <dd id="FullyConnectedNet.make_rng" class="function">make_rng</dd>
                <dd id="FullyConnectedNet.is_initializing" class="function">is_initializing</dd>
                <dd id="FullyConnectedNet.bind" class="function">bind</dd>
                <dd id="FullyConnectedNet.unbind" class="function">unbind</dd>
                <dd id="FullyConnectedNet.apply" class="function">apply</dd>
                <dd id="FullyConnectedNet.init_with_output" class="function">init_with_output</dd>
                <dd id="FullyConnectedNet.init" class="function">init</dd>
                <dd id="FullyConnectedNet.lazy_init" class="function">lazy_init</dd>
                <dd id="FullyConnectedNet.variables" class="variable">variables</dd>
                <dd id="FullyConnectedNet.get_variable" class="function">get_variable</dd>
                <dd id="FullyConnectedNet.put_variable" class="function">put_variable</dd>
                <dd id="FullyConnectedNet.sow" class="function">sow</dd>
                <dd id="FullyConnectedNet.perturb" class="function">perturb</dd>
                <dd id="FullyConnectedNet.tabulate" class="function">tabulate</dd>
                <dd id="FullyConnectedNet.module_paths" class="function">module_paths</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="ResMLP">
                            <input id="ResMLP-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">ResMLP</span><wbr>(<span class="base">flax.linen.module.Module</span>):

                <label class="view-source-button" for="ResMLP-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ResMLP"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ResMLP-94"><a href="#ResMLP-94"><span class="linenos"> 94</span></a><span class="k">class</span> <span class="nc">ResMLP</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="ResMLP-95"><a href="#ResMLP-95"><span class="linenos"> 95</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Residual neural network as defined in SpookyNet paper</span>
</span><span id="ResMLP-96"><a href="#ResMLP-96"><span class="linenos"> 96</span></a>
</span><span id="ResMLP-97"><a href="#ResMLP-97"><span class="linenos"> 97</span></a><span class="sd">    Parameters:</span>
</span><span id="ResMLP-98"><a href="#ResMLP-98"><span class="linenos"> 98</span></a><span class="sd">        use_bias (bool): Whether to include bias in the linear layers. Default is True.</span>
</span><span id="ResMLP-99"><a href="#ResMLP-99"><span class="linenos"> 99</span></a><span class="sd">        input_key (Optional[str]): Key to access the input data from a dictionary. If None, assumes inputs are not a dictionary. Default is None.</span>
</span><span id="ResMLP-100"><a href="#ResMLP-100"><span class="linenos">100</span></a><span class="sd">        output_key (Optional[str]): Key to store the output data in the dictionary. If None, uses the name of the module. Default is None.</span>
</span><span id="ResMLP-101"><a href="#ResMLP-101"><span class="linenos">101</span></a><span class="sd">        kernel_init (Union[str, Callable]): Initialization method for the kernel weights. Can be a string representing a built-in initializer or a custom initialization function. Default is scaled_orthogonal(mode=&quot;fan_avg&quot;).</span>
</span><span id="ResMLP-102"><a href="#ResMLP-102"><span class="linenos">102</span></a><span class="sd">        res_only (bool): Whether to only apply the residual connection without additional linear layers. Default is False.</span>
</span><span id="ResMLP-103"><a href="#ResMLP-103"><span class="linenos">103</span></a>
</span><span id="ResMLP-104"><a href="#ResMLP-104"><span class="linenos">104</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="ResMLP-105"><a href="#ResMLP-105"><span class="linenos">105</span></a>
</span><span id="ResMLP-106"><a href="#ResMLP-106"><span class="linenos">106</span></a>    <span class="n">use_bias</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ResMLP-107"><a href="#ResMLP-107"><span class="linenos">107</span></a>    <span class="n">input_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ResMLP-108"><a href="#ResMLP-108"><span class="linenos">108</span></a>    <span class="n">output_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ResMLP-109"><a href="#ResMLP-109"><span class="linenos">109</span></a>    <span class="n">kernel_init</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaled_orthogonal</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;fan_avg&quot;</span><span class="p">)</span>
</span><span id="ResMLP-110"><a href="#ResMLP-110"><span class="linenos">110</span></a>    <span class="n">res_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ResMLP-111"><a href="#ResMLP-111"><span class="linenos">111</span></a>
</span><span id="ResMLP-112"><a href="#ResMLP-112"><span class="linenos">112</span></a>    <span class="n">FID</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;RES_MLP&quot;</span>
</span><span id="ResMLP-113"><a href="#ResMLP-113"><span class="linenos">113</span></a>
</span><span id="ResMLP-114"><a href="#ResMLP-114"><span class="linenos">114</span></a>    <span class="nd">@nn</span><span class="o">.</span><span class="n">compact</span>
</span><span id="ResMLP-115"><a href="#ResMLP-115"><span class="linenos">115</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">]:</span>
</span><span id="ResMLP-116"><a href="#ResMLP-116"><span class="linenos">116</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ResMLP-117"><a href="#ResMLP-117"><span class="linenos">117</span></a>            <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
</span><span id="ResMLP-118"><a href="#ResMLP-118"><span class="linenos">118</span></a>                <span class="n">inputs</span><span class="p">,</span> <span class="nb">dict</span>
</span><span id="ResMLP-119"><a href="#ResMLP-119"><span class="linenos">119</span></a>            <span class="p">),</span> <span class="s2">&quot;input key must be provided if inputs is a dictionary&quot;</span>
</span><span id="ResMLP-120"><a href="#ResMLP-120"><span class="linenos">120</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">inputs</span>
</span><span id="ResMLP-121"><a href="#ResMLP-121"><span class="linenos">121</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ResMLP-122"><a href="#ResMLP-122"><span class="linenos">122</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">input_key</span><span class="p">]</span>
</span><span id="ResMLP-123"><a href="#ResMLP-123"><span class="linenos">123</span></a>
</span><span id="ResMLP-124"><a href="#ResMLP-124"><span class="linenos">124</span></a>        <span class="n">kernel_init</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="ResMLP-125"><a href="#ResMLP-125"><span class="linenos">125</span></a>            <span class="n">initializer_from_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_init</span><span class="p">)</span>
</span><span id="ResMLP-126"><a href="#ResMLP-126"><span class="linenos">126</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_init</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
</span><span id="ResMLP-127"><a href="#ResMLP-127"><span class="linenos">127</span></a>            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel_init</span>
</span><span id="ResMLP-128"><a href="#ResMLP-128"><span class="linenos">128</span></a>        <span class="p">)</span>
</span><span id="ResMLP-129"><a href="#ResMLP-129"><span class="linenos">129</span></a>        <span class="c1">############################</span>
</span><span id="ResMLP-130"><a href="#ResMLP-130"><span class="linenos">130</span></a>        <span class="n">out</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">use_bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_bias</span><span class="p">,</span> <span class="n">kernel_init</span><span class="o">=</span><span class="n">kernel_init</span><span class="p">)(</span>
</span><span id="ResMLP-131"><a href="#ResMLP-131"><span class="linenos">131</span></a>            <span class="n">TrainableSiLU</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
</span><span id="ResMLP-132"><a href="#ResMLP-132"><span class="linenos">132</span></a>        <span class="p">)</span>
</span><span id="ResMLP-133"><a href="#ResMLP-133"><span class="linenos">133</span></a>        <span class="n">out</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span>
</span><span id="ResMLP-134"><a href="#ResMLP-134"><span class="linenos">134</span></a>            <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">use_bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_bias</span><span class="p">,</span> <span class="n">kernel_init</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">initializers</span><span class="o">.</span><span class="n">zeros</span>
</span><span id="ResMLP-135"><a href="#ResMLP-135"><span class="linenos">135</span></a>        <span class="p">)(</span><span class="n">TrainableSiLU</span><span class="p">()(</span><span class="n">out</span><span class="p">))</span>
</span><span id="ResMLP-136"><a href="#ResMLP-136"><span class="linenos">136</span></a>
</span><span id="ResMLP-137"><a href="#ResMLP-137"><span class="linenos">137</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">res_only</span><span class="p">:</span>
</span><span id="ResMLP-138"><a href="#ResMLP-138"><span class="linenos">138</span></a>            <span class="n">out</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span>
</span><span id="ResMLP-139"><a href="#ResMLP-139"><span class="linenos">139</span></a>                <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">use_bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_bias</span><span class="p">,</span> <span class="n">kernel_init</span><span class="o">=</span><span class="n">kernel_init</span>
</span><span id="ResMLP-140"><a href="#ResMLP-140"><span class="linenos">140</span></a>            <span class="p">)(</span><span class="n">TrainableSiLU</span><span class="p">()(</span><span class="n">out</span><span class="p">))</span>
</span><span id="ResMLP-141"><a href="#ResMLP-141"><span class="linenos">141</span></a>        <span class="c1">############################</span>
</span><span id="ResMLP-142"><a href="#ResMLP-142"><span class="linenos">142</span></a>
</span><span id="ResMLP-143"><a href="#ResMLP-143"><span class="linenos">143</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ResMLP-144"><a href="#ResMLP-144"><span class="linenos">144</span></a>            <span class="n">output_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_key</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_key</span>
</span><span id="ResMLP-145"><a href="#ResMLP-145"><span class="linenos">145</span></a>            <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="n">output_key</span><span class="p">:</span> <span class="n">out</span><span class="p">}</span> <span class="k">if</span> <span class="n">output_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">out</span>
</span><span id="ResMLP-146"><a href="#ResMLP-146"><span class="linenos">146</span></a>        <span class="k">return</span> <span class="n">out</span>
</span></pre></div>


            <div class="docstring"><p>Residual neural network as defined in SpookyNet paper</p>

<p>Parameters:
    use_bias (bool): Whether to include bias in the linear layers. Default is True.
    input_key (Optional[str]): Key to access the input data from a dictionary. If None, assumes inputs are not a dictionary. Default is None.
    output_key (Optional[str]): Key to store the output data in the dictionary. If None, uses the name of the module. Default is None.
    kernel_init (Union[str, Callable]): Initialization method for the kernel weights. Can be a string representing a built-in initializer or a custom initialization function. Default is scaled_orthogonal(mode="fan_avg").
    res_only (bool): Whether to only apply the residual connection without additional linear layers. Default is False.</p>
</div>


                            <div id="ResMLP.__init__" class="classattr">
                                <div class="attr function">
            
        <span class="name">ResMLP</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">use_bias</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">input_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">output_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">kernel_init</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">scaled_orthogonal</span><span class="o">.&lt;</span><span class="nb">locals</span><span class="o">&gt;.</span><span class="n">init</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">res_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">FID</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;RES_MLP&#39;</span>,</span><span class="param">	<span class="n">parent</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">flax</span><span class="o">.</span><span class="n">linen</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">Module</span><span class="p">],</span> <span class="n">flax</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">Scope</span><span class="p">,</span> <span class="n">Type</span><span class="p">[</span><span class="n">flax</span><span class="o">.</span><span class="n">linen</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">_Sentinel</span><span class="p">],</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">flax</span><span class="o">.</span><span class="n">linen</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">_Sentinel</span> <span class="nb">object</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

        
    </div>
    <a class="headerlink" href="#ResMLP.__init__"></a>
    
    

                            </div>
                            <div id="ResMLP.use_bias" class="classattr">
                                <div class="attr variable">
            <span class="name">use_bias</span><span class="annotation">: bool</span>        =
<span class="default_value">True</span>

        
    </div>
    <a class="headerlink" href="#ResMLP.use_bias"></a>
    
    

                            </div>
                            <div id="ResMLP.input_key" class="classattr">
                                <div class="attr variable">
            <span class="name">input_key</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ResMLP.input_key"></a>
    
    

                            </div>
                            <div id="ResMLP.output_key" class="classattr">
                                <div class="attr variable">
            <span class="name">output_key</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ResMLP.output_key"></a>
    
    

                            </div>
                            <div id="ResMLP.kernel_init" class="classattr">
                                        <input id="ResMLP.kernel_init-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">kernel_init</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">key</span>, </span><span class="param"><span class="n">shape</span>, </span><span class="param">dtype=&lt;class &#x27;jax.numpy.float32&#x27;&gt;</span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ResMLP.kernel_init-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ResMLP.kernel_init"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ResMLP.kernel_init-17"><a href="#ResMLP.kernel_init-17"><span class="linenos">17</span></a>        <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">):</span>
</span><span id="ResMLP.kernel_init-18"><a href="#ResMLP.kernel_init-18"><span class="linenos">18</span></a>            <span class="k">return</span> <span class="n">init_ortho</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">shape</span><span class="p">[</span><span class="n">in_axis</span><span class="p">]</span> <span class="o">+</span> <span class="n">shape</span><span class="p">[</span><span class="n">out_axis</span><span class="p">])</span> <span class="o">**</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="ResMLP.res_only" class="classattr">
                                <div class="attr variable">
            <span class="name">res_only</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ResMLP.res_only"></a>
    
    

                            </div>
                            <div id="ResMLP.FID" class="classattr">
                                <div class="attr variable">
            <span class="name">FID</span><span class="annotation">: str</span>        =
<span class="default_value">&#39;RES_MLP&#39;</span>

        
    </div>
    <a class="headerlink" href="#ResMLP.FID"></a>
    
    

                            </div>
                            <div id="ResMLP.parent" class="classattr">
                                <div class="attr variable">
            <span class="name">parent</span><span class="annotation">: Union[Type[flax.linen.module.Module], flax.core.scope.Scope, Type[flax.linen.module._Sentinel], NoneType]</span>

        
    </div>
    <a class="headerlink" href="#ResMLP.parent"></a>
    
            <div class="docstring"><p>Wraps parent module references in weak refs.</p>

<p>This prevents reference cycles from forming via parent links which can lead
to accidental OOMs in eager mode due to slow garbage collection as well as
spurious tracer leaks during jit compilation.</p>

<p>Note: "descriptors" are the underlying python mechanism for implementing
dynamic @property decorators.  We need to use a raw descriptor instead of the
more common decorator in order to force that the appropriate getter/setter
logic applies in subclasses even after various dataclass transforms.</p>
</div>


                            </div>
                            <div id="ResMLP.name" class="classattr">
                                <div class="attr variable">
            <span class="name">name</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ResMLP.name"></a>
    
    

                            </div>
                            <div id="ResMLP.scope" class="classattr">
                                <div class="attr variable">
            <span class="name">scope</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ResMLP.scope"></a>
    
    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>flax.linen.module.Module</dt>
                                <dd id="ResMLP.setup" class="function">setup</dd>
                <dd id="ResMLP.path" class="variable">path</dd>
                <dd id="ResMLP.clone" class="function">clone</dd>
                <dd id="ResMLP.copy" class="function">copy</dd>
                <dd id="ResMLP.variable" class="function">variable</dd>
                <dd id="ResMLP.param" class="function">param</dd>
                <dd id="ResMLP.has_variable" class="function">has_variable</dd>
                <dd id="ResMLP.is_mutable_collection" class="function">is_mutable_collection</dd>
                <dd id="ResMLP.has_rng" class="function">has_rng</dd>
                <dd id="ResMLP.make_rng" class="function">make_rng</dd>
                <dd id="ResMLP.is_initializing" class="function">is_initializing</dd>
                <dd id="ResMLP.bind" class="function">bind</dd>
                <dd id="ResMLP.unbind" class="function">unbind</dd>
                <dd id="ResMLP.apply" class="function">apply</dd>
                <dd id="ResMLP.init_with_output" class="function">init_with_output</dd>
                <dd id="ResMLP.init" class="function">init</dd>
                <dd id="ResMLP.lazy_init" class="function">lazy_init</dd>
                <dd id="ResMLP.variables" class="variable">variables</dd>
                <dd id="ResMLP.get_variable" class="function">get_variable</dd>
                <dd id="ResMLP.put_variable" class="function">put_variable</dd>
                <dd id="ResMLP.sow" class="function">sow</dd>
                <dd id="ResMLP.perturb" class="function">perturb</dd>
                <dd id="ResMLP.tabulate" class="function">tabulate</dd>
                <dd id="ResMLP.module_paths" class="function">module_paths</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="FullyResidualNet">
                            <input id="FullyResidualNet-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">FullyResidualNet</span><wbr>(<span class="base">flax.linen.module.Module</span>):

                <label class="view-source-button" for="FullyResidualNet-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#FullyResidualNet"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="FullyResidualNet-149"><a href="#FullyResidualNet-149"><span class="linenos">149</span></a><span class="k">class</span> <span class="nc">FullyResidualNet</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="FullyResidualNet-150"><a href="#FullyResidualNet-150"><span class="linenos">150</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;A neural network with skip connections at each layer.</span>
</span><span id="FullyResidualNet-151"><a href="#FullyResidualNet-151"><span class="linenos">151</span></a>
</span><span id="FullyResidualNet-152"><a href="#FullyResidualNet-152"><span class="linenos">152</span></a><span class="sd">    Parameters:</span>
</span><span id="FullyResidualNet-153"><a href="#FullyResidualNet-153"><span class="linenos">153</span></a><span class="sd">        dim (int): The dimension of the hidden layers.</span>
</span><span id="FullyResidualNet-154"><a href="#FullyResidualNet-154"><span class="linenos">154</span></a><span class="sd">        output_dim (int): The dimension of the output layer.</span>
</span><span id="FullyResidualNet-155"><a href="#FullyResidualNet-155"><span class="linenos">155</span></a><span class="sd">        nlayers (int): The number of layers in the network.</span>
</span><span id="FullyResidualNet-156"><a href="#FullyResidualNet-156"><span class="linenos">156</span></a><span class="sd">        activation (Union[Callable, str]): The activation function to use. Can be a callable or a string representing the name of the activation function.</span>
</span><span id="FullyResidualNet-157"><a href="#FullyResidualNet-157"><span class="linenos">157</span></a><span class="sd">        use_bias (bool): Whether to include bias terms in the linear layers.</span>
</span><span id="FullyResidualNet-158"><a href="#FullyResidualNet-158"><span class="linenos">158</span></a><span class="sd">        input_key (Optional[str]): The key to access the input data from a dictionary, if the input is a dictionary.</span>
</span><span id="FullyResidualNet-159"><a href="#FullyResidualNet-159"><span class="linenos">159</span></a><span class="sd">        output_key (Optional[str]): The key to store the output data in a dictionary, if the output is a dictionary.</span>
</span><span id="FullyResidualNet-160"><a href="#FullyResidualNet-160"><span class="linenos">160</span></a><span class="sd">        squeeze (bool): Whether to squeeze the output if it has shape (..., 1).</span>
</span><span id="FullyResidualNet-161"><a href="#FullyResidualNet-161"><span class="linenos">161</span></a><span class="sd">        kernel_init (Union[str, Callable]): The initializer for the linear layer weights. Can be a callable or a string representing the name of the initializer.</span>
</span><span id="FullyResidualNet-162"><a href="#FullyResidualNet-162"><span class="linenos">162</span></a>
</span><span id="FullyResidualNet-163"><a href="#FullyResidualNet-163"><span class="linenos">163</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="FullyResidualNet-164"><a href="#FullyResidualNet-164"><span class="linenos">164</span></a>
</span><span id="FullyResidualNet-165"><a href="#FullyResidualNet-165"><span class="linenos">165</span></a>    <span class="n">dim</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="FullyResidualNet-166"><a href="#FullyResidualNet-166"><span class="linenos">166</span></a>    <span class="n">output_dim</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="FullyResidualNet-167"><a href="#FullyResidualNet-167"><span class="linenos">167</span></a>    <span class="n">nlayers</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="FullyResidualNet-168"><a href="#FullyResidualNet-168"><span class="linenos">168</span></a>    <span class="n">activation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">silu</span>
</span><span id="FullyResidualNet-169"><a href="#FullyResidualNet-169"><span class="linenos">169</span></a>    <span class="n">use_bias</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="FullyResidualNet-170"><a href="#FullyResidualNet-170"><span class="linenos">170</span></a>    <span class="n">input_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="FullyResidualNet-171"><a href="#FullyResidualNet-171"><span class="linenos">171</span></a>    <span class="n">output_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="FullyResidualNet-172"><a href="#FullyResidualNet-172"><span class="linenos">172</span></a>    <span class="n">squeeze</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="FullyResidualNet-173"><a href="#FullyResidualNet-173"><span class="linenos">173</span></a>    <span class="n">kernel_init</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">default_kernel_init</span>
</span><span id="FullyResidualNet-174"><a href="#FullyResidualNet-174"><span class="linenos">174</span></a>
</span><span id="FullyResidualNet-175"><a href="#FullyResidualNet-175"><span class="linenos">175</span></a>    <span class="n">FID</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;SKIP_NET&quot;</span>
</span><span id="FullyResidualNet-176"><a href="#FullyResidualNet-176"><span class="linenos">176</span></a>
</span><span id="FullyResidualNet-177"><a href="#FullyResidualNet-177"><span class="linenos">177</span></a>    <span class="nd">@nn</span><span class="o">.</span><span class="n">compact</span>
</span><span id="FullyResidualNet-178"><a href="#FullyResidualNet-178"><span class="linenos">178</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">]:</span>
</span><span id="FullyResidualNet-179"><a href="#FullyResidualNet-179"><span class="linenos">179</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="FullyResidualNet-180"><a href="#FullyResidualNet-180"><span class="linenos">180</span></a>            <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
</span><span id="FullyResidualNet-181"><a href="#FullyResidualNet-181"><span class="linenos">181</span></a>                <span class="n">inputs</span><span class="p">,</span> <span class="nb">dict</span>
</span><span id="FullyResidualNet-182"><a href="#FullyResidualNet-182"><span class="linenos">182</span></a>            <span class="p">),</span> <span class="s2">&quot;input key must be provided if inputs is a dictionary&quot;</span>
</span><span id="FullyResidualNet-183"><a href="#FullyResidualNet-183"><span class="linenos">183</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">inputs</span>
</span><span id="FullyResidualNet-184"><a href="#FullyResidualNet-184"><span class="linenos">184</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="FullyResidualNet-185"><a href="#FullyResidualNet-185"><span class="linenos">185</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">input_key</span><span class="p">]</span>
</span><span id="FullyResidualNet-186"><a href="#FullyResidualNet-186"><span class="linenos">186</span></a>
</span><span id="FullyResidualNet-187"><a href="#FullyResidualNet-187"><span class="linenos">187</span></a>        <span class="n">activation</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="FullyResidualNet-188"><a href="#FullyResidualNet-188"><span class="linenos">188</span></a>            <span class="n">activation_from_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">)</span>
</span><span id="FullyResidualNet-189"><a href="#FullyResidualNet-189"><span class="linenos">189</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
</span><span id="FullyResidualNet-190"><a href="#FullyResidualNet-190"><span class="linenos">190</span></a>            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">activation</span>
</span><span id="FullyResidualNet-191"><a href="#FullyResidualNet-191"><span class="linenos">191</span></a>        <span class="p">)</span>
</span><span id="FullyResidualNet-192"><a href="#FullyResidualNet-192"><span class="linenos">192</span></a>        <span class="n">kernel_init</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="FullyResidualNet-193"><a href="#FullyResidualNet-193"><span class="linenos">193</span></a>            <span class="n">initializer_from_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_init</span><span class="p">)</span>
</span><span id="FullyResidualNet-194"><a href="#FullyResidualNet-194"><span class="linenos">194</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_init</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
</span><span id="FullyResidualNet-195"><a href="#FullyResidualNet-195"><span class="linenos">195</span></a>            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel_init</span>
</span><span id="FullyResidualNet-196"><a href="#FullyResidualNet-196"><span class="linenos">196</span></a>        <span class="p">)</span>
</span><span id="FullyResidualNet-197"><a href="#FullyResidualNet-197"><span class="linenos">197</span></a>        <span class="c1">############################</span>
</span><span id="FullyResidualNet-198"><a href="#FullyResidualNet-198"><span class="linenos">198</span></a>        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">:</span>
</span><span id="FullyResidualNet-199"><a href="#FullyResidualNet-199"><span class="linenos">199</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span>
</span><span id="FullyResidualNet-200"><a href="#FullyResidualNet-200"><span class="linenos">200</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">,</span>
</span><span id="FullyResidualNet-201"><a href="#FullyResidualNet-201"><span class="linenos">201</span></a>                <span class="n">use_bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_bias</span><span class="p">,</span>
</span><span id="FullyResidualNet-202"><a href="#FullyResidualNet-202"><span class="linenos">202</span></a>                <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Reshape&quot;</span><span class="p">,</span>
</span><span id="FullyResidualNet-203"><a href="#FullyResidualNet-203"><span class="linenos">203</span></a>                <span class="n">kernel_init</span><span class="o">=</span><span class="n">kernel_init</span><span class="p">,</span>
</span><span id="FullyResidualNet-204"><a href="#FullyResidualNet-204"><span class="linenos">204</span></a>            <span class="p">)(</span><span class="n">x</span><span class="p">)</span>
</span><span id="FullyResidualNet-205"><a href="#FullyResidualNet-205"><span class="linenos">205</span></a>
</span><span id="FullyResidualNet-206"><a href="#FullyResidualNet-206"><span class="linenos">206</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nlayers</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="FullyResidualNet-207"><a href="#FullyResidualNet-207"><span class="linenos">207</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">activation</span><span class="p">(</span>
</span><span id="FullyResidualNet-208"><a href="#FullyResidualNet-208"><span class="linenos">208</span></a>                <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span>
</span><span id="FullyResidualNet-209"><a href="#FullyResidualNet-209"><span class="linenos">209</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">,</span>
</span><span id="FullyResidualNet-210"><a href="#FullyResidualNet-210"><span class="linenos">210</span></a>                    <span class="n">use_bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_bias</span><span class="p">,</span>
</span><span id="FullyResidualNet-211"><a href="#FullyResidualNet-211"><span class="linenos">211</span></a>                    <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Layer_</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="FullyResidualNet-212"><a href="#FullyResidualNet-212"><span class="linenos">212</span></a>                    <span class="n">kernel_init</span><span class="o">=</span><span class="n">kernel_init</span><span class="p">,</span>
</span><span id="FullyResidualNet-213"><a href="#FullyResidualNet-213"><span class="linenos">213</span></a>                <span class="p">)(</span><span class="n">x</span><span class="p">)</span>
</span><span id="FullyResidualNet-214"><a href="#FullyResidualNet-214"><span class="linenos">214</span></a>            <span class="p">)</span>
</span><span id="FullyResidualNet-215"><a href="#FullyResidualNet-215"><span class="linenos">215</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span>
</span><span id="FullyResidualNet-216"><a href="#FullyResidualNet-216"><span class="linenos">216</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">output_dim</span><span class="p">,</span>
</span><span id="FullyResidualNet-217"><a href="#FullyResidualNet-217"><span class="linenos">217</span></a>            <span class="n">use_bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_bias</span><span class="p">,</span>
</span><span id="FullyResidualNet-218"><a href="#FullyResidualNet-218"><span class="linenos">218</span></a>            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Layer_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nlayers</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="FullyResidualNet-219"><a href="#FullyResidualNet-219"><span class="linenos">219</span></a>            <span class="n">kernel_init</span><span class="o">=</span><span class="n">kernel_init</span><span class="p">,</span>
</span><span id="FullyResidualNet-220"><a href="#FullyResidualNet-220"><span class="linenos">220</span></a>        <span class="p">)(</span><span class="n">x</span><span class="p">)</span>
</span><span id="FullyResidualNet-221"><a href="#FullyResidualNet-221"><span class="linenos">221</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">squeeze</span> <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="FullyResidualNet-222"><a href="#FullyResidualNet-222"><span class="linenos">222</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="FullyResidualNet-223"><a href="#FullyResidualNet-223"><span class="linenos">223</span></a>        <span class="c1">############################</span>
</span><span id="FullyResidualNet-224"><a href="#FullyResidualNet-224"><span class="linenos">224</span></a>
</span><span id="FullyResidualNet-225"><a href="#FullyResidualNet-225"><span class="linenos">225</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="FullyResidualNet-226"><a href="#FullyResidualNet-226"><span class="linenos">226</span></a>            <span class="n">output_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_key</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_key</span>
</span><span id="FullyResidualNet-227"><a href="#FullyResidualNet-227"><span class="linenos">227</span></a>            <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="n">output_key</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span> <span class="k">if</span> <span class="n">output_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">x</span>
</span><span id="FullyResidualNet-228"><a href="#FullyResidualNet-228"><span class="linenos">228</span></a>        <span class="k">return</span> <span class="n">x</span>
</span></pre></div>


            <div class="docstring"><p>A neural network with skip connections at each layer.</p>

<p>Parameters:
    dim (int): The dimension of the hidden layers.
    output_dim (int): The dimension of the output layer.
    nlayers (int): The number of layers in the network.
    activation (Union[Callable, str]): The activation function to use. Can be a callable or a string representing the name of the activation function.
    use_bias (bool): Whether to include bias terms in the linear layers.
    input_key (Optional[str]): The key to access the input data from a dictionary, if the input is a dictionary.
    output_key (Optional[str]): The key to store the output data in a dictionary, if the output is a dictionary.
    squeeze (bool): Whether to squeeze the output if it has shape (..., 1).
    kernel_init (Union[str, Callable]): The initializer for the linear layer weights. Can be a callable or a string representing the name of the initializer.</p>
</div>


                            <div id="FullyResidualNet.__init__" class="classattr">
                                <div class="attr function">
            
        <span class="name">FullyResidualNet</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">dim</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">output_dim</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">nlayers</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">activation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">PjitFunction</span> <span class="n">of</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">silu</span><span class="o">&gt;&gt;</span>,</span><span class="param">	<span class="n">use_bias</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">input_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">output_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">squeeze</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">kernel_init</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">variance_scaling</span><span class="o">.&lt;</span><span class="nb">locals</span><span class="o">&gt;.</span><span class="n">init</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">FID</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;SKIP_NET&#39;</span>,</span><span class="param">	<span class="n">parent</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">flax</span><span class="o">.</span><span class="n">linen</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">Module</span><span class="p">],</span> <span class="n">flax</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">Scope</span><span class="p">,</span> <span class="n">Type</span><span class="p">[</span><span class="n">flax</span><span class="o">.</span><span class="n">linen</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">_Sentinel</span><span class="p">],</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">flax</span><span class="o">.</span><span class="n">linen</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">_Sentinel</span> <span class="nb">object</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

        
    </div>
    <a class="headerlink" href="#FullyResidualNet.__init__"></a>
    
    

                            </div>
                            <div id="FullyResidualNet.dim" class="classattr">
                                <div class="attr variable">
            <span class="name">dim</span><span class="annotation">: int</span>

        
    </div>
    <a class="headerlink" href="#FullyResidualNet.dim"></a>
    
    

                            </div>
                            <div id="FullyResidualNet.output_dim" class="classattr">
                                <div class="attr variable">
            <span class="name">output_dim</span><span class="annotation">: int</span>

        
    </div>
    <a class="headerlink" href="#FullyResidualNet.output_dim"></a>
    
    

                            </div>
                            <div id="FullyResidualNet.nlayers" class="classattr">
                                <div class="attr variable">
            <span class="name">nlayers</span><span class="annotation">: int</span>

        
    </div>
    <a class="headerlink" href="#FullyResidualNet.nlayers"></a>
    
    

                            </div>
                            <div id="FullyResidualNet.activation" class="classattr">
                                        <input id="FullyResidualNet.activation-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@jax.jit</div>

        <span class="def">def</span>
        <span class="name">activation</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">x</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">bool_</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span>:</span></span>

                <label class="view-source-button" for="FullyResidualNet.activation-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#FullyResidualNet.activation"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="FullyResidualNet.activation-151"><a href="#FullyResidualNet.activation-151"><span class="linenos">151</span></a><span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
</span><span id="FullyResidualNet.activation-152"><a href="#FullyResidualNet.activation-152"><span class="linenos">152</span></a><span class="k">def</span> <span class="nf">silu</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="p">:</span>
</span><span id="FullyResidualNet.activation-153"><a href="#FullyResidualNet.activation-153"><span class="linenos">153</span></a><span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;SiLU (a.k.a. swish) activation function.</span>
</span><span id="FullyResidualNet.activation-154"><a href="#FullyResidualNet.activation-154"><span class="linenos">154</span></a>
</span><span id="FullyResidualNet.activation-155"><a href="#FullyResidualNet.activation-155"><span class="linenos">155</span></a><span class="sd">  Computes the element-wise function:</span>
</span><span id="FullyResidualNet.activation-156"><a href="#FullyResidualNet.activation-156"><span class="linenos">156</span></a>
</span><span id="FullyResidualNet.activation-157"><a href="#FullyResidualNet.activation-157"><span class="linenos">157</span></a><span class="sd">  .. math::</span>
</span><span id="FullyResidualNet.activation-158"><a href="#FullyResidualNet.activation-158"><span class="linenos">158</span></a><span class="sd">    \mathrm{silu}(x) = x \cdot \mathrm{sigmoid}(x) = \frac{x}{1 + e^{-x}}</span>
</span><span id="FullyResidualNet.activation-159"><a href="#FullyResidualNet.activation-159"><span class="linenos">159</span></a>
</span><span id="FullyResidualNet.activation-160"><a href="#FullyResidualNet.activation-160"><span class="linenos">160</span></a><span class="sd">  :func:`swish` and :func:`silu` are both aliases for the same function.</span>
</span><span id="FullyResidualNet.activation-161"><a href="#FullyResidualNet.activation-161"><span class="linenos">161</span></a>
</span><span id="FullyResidualNet.activation-162"><a href="#FullyResidualNet.activation-162"><span class="linenos">162</span></a><span class="sd">  Args:</span>
</span><span id="FullyResidualNet.activation-163"><a href="#FullyResidualNet.activation-163"><span class="linenos">163</span></a><span class="sd">    x : input array</span>
</span><span id="FullyResidualNet.activation-164"><a href="#FullyResidualNet.activation-164"><span class="linenos">164</span></a>
</span><span id="FullyResidualNet.activation-165"><a href="#FullyResidualNet.activation-165"><span class="linenos">165</span></a><span class="sd">  Returns:</span>
</span><span id="FullyResidualNet.activation-166"><a href="#FullyResidualNet.activation-166"><span class="linenos">166</span></a><span class="sd">    An array.</span>
</span><span id="FullyResidualNet.activation-167"><a href="#FullyResidualNet.activation-167"><span class="linenos">167</span></a>
</span><span id="FullyResidualNet.activation-168"><a href="#FullyResidualNet.activation-168"><span class="linenos">168</span></a><span class="sd">  See also:</span>
</span><span id="FullyResidualNet.activation-169"><a href="#FullyResidualNet.activation-169"><span class="linenos">169</span></a><span class="sd">    :func:`sigmoid`</span>
</span><span id="FullyResidualNet.activation-170"><a href="#FullyResidualNet.activation-170"><span class="linenos">170</span></a><span class="sd">  &quot;&quot;&quot;</span>
</span><span id="FullyResidualNet.activation-171"><a href="#FullyResidualNet.activation-171"><span class="linenos">171</span></a>  <span class="n">numpy_util</span><span class="o">.</span><span class="n">check_arraylike</span><span class="p">(</span><span class="s2">&quot;silu&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span><span id="FullyResidualNet.activation-172"><a href="#FullyResidualNet.activation-172"><span class="linenos">172</span></a>  <span class="n">x_arr</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="FullyResidualNet.activation-173"><a href="#FullyResidualNet.activation-173"><span class="linenos">173</span></a>  <span class="k">return</span> <span class="n">x_arr</span> <span class="o">*</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">x_arr</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>SiLU (a.k.a. swish) activation function.</p>

<p>Computes the element-wise function:</p>

<p>$$\mathrm{silu}(x) = x \cdot \mathrm{sigmoid}(x) = \frac{x}{1 + e^{-x}}$$</p>

<p><code>swish()</code> and <code>silu()</code> are both aliases for the same function.</p>

<p>Args:
  x : input array</p>

<p>Returns:
  An array.</p>

<p>See also:
  <code>sigmoid()</code></p>
</div>


                            </div>
                            <div id="FullyResidualNet.use_bias" class="classattr">
                                <div class="attr variable">
            <span class="name">use_bias</span><span class="annotation">: bool</span>        =
<span class="default_value">True</span>

        
    </div>
    <a class="headerlink" href="#FullyResidualNet.use_bias"></a>
    
    

                            </div>
                            <div id="FullyResidualNet.input_key" class="classattr">
                                <div class="attr variable">
            <span class="name">input_key</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#FullyResidualNet.input_key"></a>
    
    

                            </div>
                            <div id="FullyResidualNet.output_key" class="classattr">
                                <div class="attr variable">
            <span class="name">output_key</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#FullyResidualNet.output_key"></a>
    
    

                            </div>
                            <div id="FullyResidualNet.squeeze" class="classattr">
                                <div class="attr variable">
            <span class="name">squeeze</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#FullyResidualNet.squeeze"></a>
    
    

                            </div>
                            <div id="FullyResidualNet.kernel_init" class="classattr">
                                        <input id="FullyResidualNet.kernel_init-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">kernel_init</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">key</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span>,</span><span class="param">	<span class="n">shape</span><span class="p">:</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]]</span>,</span><span class="param">	dtype: Any = &lt;class &#x27;jax.numpy.float64&#x27;&gt;</span><span class="return-annotation">) -> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span>:</span></span>

                <label class="view-source-button" for="FullyResidualNet.kernel_init-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#FullyResidualNet.kernel_init"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="FullyResidualNet.kernel_init-317"><a href="#FullyResidualNet.kernel_init-317"><span class="linenos">317</span></a>  <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">KeyArray</span><span class="p">,</span>
</span><span id="FullyResidualNet.kernel_init-318"><a href="#FullyResidualNet.kernel_init-318"><span class="linenos">318</span></a>           <span class="n">shape</span><span class="p">:</span> <span class="n">core</span><span class="o">.</span><span class="n">Shape</span><span class="p">,</span>
</span><span id="FullyResidualNet.kernel_init-319"><a href="#FullyResidualNet.kernel_init-319"><span class="linenos">319</span></a>           <span class="n">dtype</span><span class="p">:</span> <span class="n">DTypeLikeInexact</span> <span class="o">=</span> <span class="n">dtype</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="p">:</span>
</span><span id="FullyResidualNet.kernel_init-320"><a href="#FullyResidualNet.kernel_init-320"><span class="linenos">320</span></a>    <span class="n">dtype</span> <span class="o">=</span> <span class="n">dtypes</span><span class="o">.</span><span class="n">canonicalize_dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="FullyResidualNet.kernel_init-321"><a href="#FullyResidualNet.kernel_init-321"><span class="linenos">321</span></a>    <span class="n">named_shape</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">as_named_shape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
</span><span id="FullyResidualNet.kernel_init-322"><a href="#FullyResidualNet.kernel_init-322"><span class="linenos">322</span></a>    <span class="n">fan_in</span><span class="p">,</span> <span class="n">fan_out</span> <span class="o">=</span> <span class="n">_compute_fans</span><span class="p">(</span><span class="n">named_shape</span><span class="p">,</span> <span class="n">in_axis</span><span class="p">,</span> <span class="n">out_axis</span><span class="p">,</span> <span class="n">batch_axis</span><span class="p">)</span>
</span><span id="FullyResidualNet.kernel_init-323"><a href="#FullyResidualNet.kernel_init-323"><span class="linenos">323</span></a>    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;fan_in&quot;</span><span class="p">:</span> <span class="n">denominator</span> <span class="o">=</span> <span class="n">fan_in</span>
</span><span id="FullyResidualNet.kernel_init-324"><a href="#FullyResidualNet.kernel_init-324"><span class="linenos">324</span></a>    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;fan_out&quot;</span><span class="p">:</span> <span class="n">denominator</span> <span class="o">=</span> <span class="n">fan_out</span>
</span><span id="FullyResidualNet.kernel_init-325"><a href="#FullyResidualNet.kernel_init-325"><span class="linenos">325</span></a>    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;fan_avg&quot;</span><span class="p">:</span> <span class="n">denominator</span> <span class="o">=</span> <span class="p">(</span><span class="n">fan_in</span> <span class="o">+</span> <span class="n">fan_out</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="FullyResidualNet.kernel_init-326"><a href="#FullyResidualNet.kernel_init-326"><span class="linenos">326</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="FullyResidualNet.kernel_init-327"><a href="#FullyResidualNet.kernel_init-327"><span class="linenos">327</span></a>      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="FullyResidualNet.kernel_init-328"><a href="#FullyResidualNet.kernel_init-328"><span class="linenos">328</span></a>        <span class="sa">f</span><span class="s2">&quot;invalid mode for variance scaling initializer: </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="FullyResidualNet.kernel_init-329"><a href="#FullyResidualNet.kernel_init-329"><span class="linenos">329</span></a>    <span class="n">variance</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">scale</span> <span class="o">/</span> <span class="n">denominator</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="FullyResidualNet.kernel_init-330"><a href="#FullyResidualNet.kernel_init-330"><span class="linenos">330</span></a>
</span><span id="FullyResidualNet.kernel_init-331"><a href="#FullyResidualNet.kernel_init-331"><span class="linenos">331</span></a>    <span class="k">if</span> <span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;truncated_normal&quot;</span><span class="p">:</span>
</span><span id="FullyResidualNet.kernel_init-332"><a href="#FullyResidualNet.kernel_init-332"><span class="linenos">332</span></a>      <span class="k">if</span> <span class="n">jnp</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">floating</span><span class="p">):</span>
</span><span id="FullyResidualNet.kernel_init-333"><a href="#FullyResidualNet.kernel_init-333"><span class="linenos">333</span></a>        <span class="c1"># constant is stddev of standard normal truncated to (-2, 2)</span>
</span><span id="FullyResidualNet.kernel_init-334"><a href="#FullyResidualNet.kernel_init-334"><span class="linenos">334</span></a>        <span class="n">stddev</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">.87962566103423978</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
</span><span id="FullyResidualNet.kernel_init-335"><a href="#FullyResidualNet.kernel_init-335"><span class="linenos">335</span></a>        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">truncated_normal</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">named_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="n">stddev</span>
</span><span id="FullyResidualNet.kernel_init-336"><a href="#FullyResidualNet.kernel_init-336"><span class="linenos">336</span></a>      <span class="k">else</span><span class="p">:</span>
</span><span id="FullyResidualNet.kernel_init-337"><a href="#FullyResidualNet.kernel_init-337"><span class="linenos">337</span></a>        <span class="c1"># constant is stddev of complex standard normal truncated to 2</span>
</span><span id="FullyResidualNet.kernel_init-338"><a href="#FullyResidualNet.kernel_init-338"><span class="linenos">338</span></a>        <span class="n">stddev</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">.95311164380491208</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
</span><span id="FullyResidualNet.kernel_init-339"><a href="#FullyResidualNet.kernel_init-339"><span class="linenos">339</span></a>        <span class="k">return</span> <span class="n">_complex_truncated_normal</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">named_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="n">stddev</span>
</span><span id="FullyResidualNet.kernel_init-340"><a href="#FullyResidualNet.kernel_init-340"><span class="linenos">340</span></a>    <span class="k">elif</span> <span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;normal&quot;</span><span class="p">:</span>
</span><span id="FullyResidualNet.kernel_init-341"><a href="#FullyResidualNet.kernel_init-341"><span class="linenos">341</span></a>      <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">named_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span>
</span><span id="FullyResidualNet.kernel_init-342"><a href="#FullyResidualNet.kernel_init-342"><span class="linenos">342</span></a>    <span class="k">elif</span> <span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;uniform&quot;</span><span class="p">:</span>
</span><span id="FullyResidualNet.kernel_init-343"><a href="#FullyResidualNet.kernel_init-343"><span class="linenos">343</span></a>      <span class="k">if</span> <span class="n">jnp</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">floating</span><span class="p">):</span>
</span><span id="FullyResidualNet.kernel_init-344"><a href="#FullyResidualNet.kernel_init-344"><span class="linenos">344</span></a>        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">named_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">variance</span><span class="p">)</span>
</span><span id="FullyResidualNet.kernel_init-345"><a href="#FullyResidualNet.kernel_init-345"><span class="linenos">345</span></a>      <span class="k">else</span><span class="p">:</span>
</span><span id="FullyResidualNet.kernel_init-346"><a href="#FullyResidualNet.kernel_init-346"><span class="linenos">346</span></a>        <span class="k">return</span> <span class="n">_complex_uniform</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">named_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span>
</span><span id="FullyResidualNet.kernel_init-347"><a href="#FullyResidualNet.kernel_init-347"><span class="linenos">347</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="FullyResidualNet.kernel_init-348"><a href="#FullyResidualNet.kernel_init-348"><span class="linenos">348</span></a>      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;invalid distribution for variance scaling initializer: </span><span class="si">{</span><span class="n">distribution</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="FullyResidualNet.FID" class="classattr">
                                <div class="attr variable">
            <span class="name">FID</span><span class="annotation">: str</span>        =
<span class="default_value">&#39;SKIP_NET&#39;</span>

        
    </div>
    <a class="headerlink" href="#FullyResidualNet.FID"></a>
    
    

                            </div>
                            <div id="FullyResidualNet.parent" class="classattr">
                                <div class="attr variable">
            <span class="name">parent</span><span class="annotation">: Union[Type[flax.linen.module.Module], flax.core.scope.Scope, Type[flax.linen.module._Sentinel], NoneType]</span>

        
    </div>
    <a class="headerlink" href="#FullyResidualNet.parent"></a>
    
            <div class="docstring"><p>Wraps parent module references in weak refs.</p>

<p>This prevents reference cycles from forming via parent links which can lead
to accidental OOMs in eager mode due to slow garbage collection as well as
spurious tracer leaks during jit compilation.</p>

<p>Note: "descriptors" are the underlying python mechanism for implementing
dynamic @property decorators.  We need to use a raw descriptor instead of the
more common decorator in order to force that the appropriate getter/setter
logic applies in subclasses even after various dataclass transforms.</p>
</div>


                            </div>
                            <div id="FullyResidualNet.name" class="classattr">
                                <div class="attr variable">
            <span class="name">name</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#FullyResidualNet.name"></a>
    
    

                            </div>
                            <div id="FullyResidualNet.scope" class="classattr">
                                <div class="attr variable">
            <span class="name">scope</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#FullyResidualNet.scope"></a>
    
    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>flax.linen.module.Module</dt>
                                <dd id="FullyResidualNet.setup" class="function">setup</dd>
                <dd id="FullyResidualNet.path" class="variable">path</dd>
                <dd id="FullyResidualNet.clone" class="function">clone</dd>
                <dd id="FullyResidualNet.copy" class="function">copy</dd>
                <dd id="FullyResidualNet.variable" class="function">variable</dd>
                <dd id="FullyResidualNet.param" class="function">param</dd>
                <dd id="FullyResidualNet.has_variable" class="function">has_variable</dd>
                <dd id="FullyResidualNet.is_mutable_collection" class="function">is_mutable_collection</dd>
                <dd id="FullyResidualNet.has_rng" class="function">has_rng</dd>
                <dd id="FullyResidualNet.make_rng" class="function">make_rng</dd>
                <dd id="FullyResidualNet.is_initializing" class="function">is_initializing</dd>
                <dd id="FullyResidualNet.bind" class="function">bind</dd>
                <dd id="FullyResidualNet.unbind" class="function">unbind</dd>
                <dd id="FullyResidualNet.apply" class="function">apply</dd>
                <dd id="FullyResidualNet.init_with_output" class="function">init_with_output</dd>
                <dd id="FullyResidualNet.init" class="function">init</dd>
                <dd id="FullyResidualNet.lazy_init" class="function">lazy_init</dd>
                <dd id="FullyResidualNet.variables" class="variable">variables</dd>
                <dd id="FullyResidualNet.get_variable" class="function">get_variable</dd>
                <dd id="FullyResidualNet.put_variable" class="function">put_variable</dd>
                <dd id="FullyResidualNet.sow" class="function">sow</dd>
                <dd id="FullyResidualNet.perturb" class="function">perturb</dd>
                <dd id="FullyResidualNet.tabulate" class="function">tabulate</dd>
                <dd id="FullyResidualNet.module_paths" class="function">module_paths</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="HierarchicalNet">
                            <input id="HierarchicalNet-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">HierarchicalNet</span><wbr>(<span class="base">flax.linen.module.Module</span>):

                <label class="view-source-button" for="HierarchicalNet-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#HierarchicalNet"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="HierarchicalNet-231"><a href="#HierarchicalNet-231"><span class="linenos">231</span></a><span class="k">class</span> <span class="nc">HierarchicalNet</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="HierarchicalNet-232"><a href="#HierarchicalNet-232"><span class="linenos">232</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Neural network for a sequence of inputs (in axis=-2) with a decay factor</span>
</span><span id="HierarchicalNet-233"><a href="#HierarchicalNet-233"><span class="linenos">233</span></a>
</span><span id="HierarchicalNet-234"><a href="#HierarchicalNet-234"><span class="linenos">234</span></a><span class="sd">    Parameters:</span>
</span><span id="HierarchicalNet-235"><a href="#HierarchicalNet-235"><span class="linenos">235</span></a><span class="sd">        neurons (Sequence[int]): A sequence of integers representing the number of neurons in each layer.</span>
</span><span id="HierarchicalNet-236"><a href="#HierarchicalNet-236"><span class="linenos">236</span></a><span class="sd">        activation (Union[Callable, str], optional): Activation function to use. Defaults to nn.silu.</span>
</span><span id="HierarchicalNet-237"><a href="#HierarchicalNet-237"><span class="linenos">237</span></a><span class="sd">        use_bias (bool, optional): Whether to include bias terms in the linear layers. Defaults to True.</span>
</span><span id="HierarchicalNet-238"><a href="#HierarchicalNet-238"><span class="linenos">238</span></a><span class="sd">        input_key (Optional[str], optional): Key to access the input data if it is a dictionary. Defaults to None.</span>
</span><span id="HierarchicalNet-239"><a href="#HierarchicalNet-239"><span class="linenos">239</span></a><span class="sd">        output_key (Optional[str], optional): Key to store the output data if it is a dictionary. Defaults to None.</span>
</span><span id="HierarchicalNet-240"><a href="#HierarchicalNet-240"><span class="linenos">240</span></a><span class="sd">        decay (float, optional): Decay factor to scale each layer. Defaults to 0.01.</span>
</span><span id="HierarchicalNet-241"><a href="#HierarchicalNet-241"><span class="linenos">241</span></a><span class="sd">        squeeze (bool, optional): Whether to squeeze the output if it has shape (..., 1). Defaults to False.</span>
</span><span id="HierarchicalNet-242"><a href="#HierarchicalNet-242"><span class="linenos">242</span></a><span class="sd">        kernel_init (Union[str, Callable], optional): Initialization method for the linear layers. Defaults to nn.linear.default_kernel_init.</span>
</span><span id="HierarchicalNet-243"><a href="#HierarchicalNet-243"><span class="linenos">243</span></a>
</span><span id="HierarchicalNet-244"><a href="#HierarchicalNet-244"><span class="linenos">244</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="HierarchicalNet-245"><a href="#HierarchicalNet-245"><span class="linenos">245</span></a>
</span><span id="HierarchicalNet-246"><a href="#HierarchicalNet-246"><span class="linenos">246</span></a>    <span class="n">neurons</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
</span><span id="HierarchicalNet-247"><a href="#HierarchicalNet-247"><span class="linenos">247</span></a>    <span class="n">activation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">silu</span>
</span><span id="HierarchicalNet-248"><a href="#HierarchicalNet-248"><span class="linenos">248</span></a>    <span class="n">use_bias</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="HierarchicalNet-249"><a href="#HierarchicalNet-249"><span class="linenos">249</span></a>    <span class="n">input_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="HierarchicalNet-250"><a href="#HierarchicalNet-250"><span class="linenos">250</span></a>    <span class="n">output_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="HierarchicalNet-251"><a href="#HierarchicalNet-251"><span class="linenos">251</span></a>    <span class="n">decay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span>
</span><span id="HierarchicalNet-252"><a href="#HierarchicalNet-252"><span class="linenos">252</span></a>    <span class="n">squeeze</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="HierarchicalNet-253"><a href="#HierarchicalNet-253"><span class="linenos">253</span></a>    <span class="n">kernel_init</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">default_kernel_init</span>
</span><span id="HierarchicalNet-254"><a href="#HierarchicalNet-254"><span class="linenos">254</span></a>
</span><span id="HierarchicalNet-255"><a href="#HierarchicalNet-255"><span class="linenos">255</span></a>    <span class="n">FID</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;HIERARCHICAL_NET&quot;</span>
</span><span id="HierarchicalNet-256"><a href="#HierarchicalNet-256"><span class="linenos">256</span></a>
</span><span id="HierarchicalNet-257"><a href="#HierarchicalNet-257"><span class="linenos">257</span></a>    <span class="nd">@nn</span><span class="o">.</span><span class="n">compact</span>
</span><span id="HierarchicalNet-258"><a href="#HierarchicalNet-258"><span class="linenos">258</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">]:</span>
</span><span id="HierarchicalNet-259"><a href="#HierarchicalNet-259"><span class="linenos">259</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HierarchicalNet-260"><a href="#HierarchicalNet-260"><span class="linenos">260</span></a>            <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
</span><span id="HierarchicalNet-261"><a href="#HierarchicalNet-261"><span class="linenos">261</span></a>                <span class="n">inputs</span><span class="p">,</span> <span class="nb">dict</span>
</span><span id="HierarchicalNet-262"><a href="#HierarchicalNet-262"><span class="linenos">262</span></a>            <span class="p">),</span> <span class="s2">&quot;input key must be provided if inputs is a dictionary&quot;</span>
</span><span id="HierarchicalNet-263"><a href="#HierarchicalNet-263"><span class="linenos">263</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">inputs</span>
</span><span id="HierarchicalNet-264"><a href="#HierarchicalNet-264"><span class="linenos">264</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="HierarchicalNet-265"><a href="#HierarchicalNet-265"><span class="linenos">265</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">input_key</span><span class="p">]</span>
</span><span id="HierarchicalNet-266"><a href="#HierarchicalNet-266"><span class="linenos">266</span></a>
</span><span id="HierarchicalNet-267"><a href="#HierarchicalNet-267"><span class="linenos">267</span></a>        <span class="c1">############################</span>
</span><span id="HierarchicalNet-268"><a href="#HierarchicalNet-268"><span class="linenos">268</span></a>        <span class="n">networks</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span>
</span><span id="HierarchicalNet-269"><a href="#HierarchicalNet-269"><span class="linenos">269</span></a>            <span class="n">FullyConnectedNet</span><span class="p">,</span>
</span><span id="HierarchicalNet-270"><a href="#HierarchicalNet-270"><span class="linenos">270</span></a>            <span class="n">variable_axes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
</span><span id="HierarchicalNet-271"><a href="#HierarchicalNet-271"><span class="linenos">271</span></a>            <span class="n">split_rngs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
</span><span id="HierarchicalNet-272"><a href="#HierarchicalNet-272"><span class="linenos">272</span></a>            <span class="n">in_axes</span><span class="o">=-</span><span class="mi">2</span><span class="p">,</span>
</span><span id="HierarchicalNet-273"><a href="#HierarchicalNet-273"><span class="linenos">273</span></a>            <span class="n">out_axes</span><span class="o">=-</span><span class="mi">2</span><span class="p">,</span>
</span><span id="HierarchicalNet-274"><a href="#HierarchicalNet-274"><span class="linenos">274</span></a>            <span class="n">kenel_init</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_init</span><span class="p">,</span>
</span><span id="HierarchicalNet-275"><a href="#HierarchicalNet-275"><span class="linenos">275</span></a>        <span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">neurons</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_bias</span><span class="p">)</span>
</span><span id="HierarchicalNet-276"><a href="#HierarchicalNet-276"><span class="linenos">276</span></a>
</span><span id="HierarchicalNet-277"><a href="#HierarchicalNet-277"><span class="linenos">277</span></a>        <span class="n">out</span> <span class="o">=</span> <span class="n">networks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="HierarchicalNet-278"><a href="#HierarchicalNet-278"><span class="linenos">278</span></a>        <span class="c1"># scale each layer by a decay factor</span>
</span><span id="HierarchicalNet-279"><a href="#HierarchicalNet-279"><span class="linenos">279</span></a>        <span class="n">decay</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">decay</span><span class="o">**</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])])</span>
</span><span id="HierarchicalNet-280"><a href="#HierarchicalNet-280"><span class="linenos">280</span></a>        <span class="n">out</span> <span class="o">=</span> <span class="n">out</span> <span class="o">*</span> <span class="n">decay</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="HierarchicalNet-281"><a href="#HierarchicalNet-281"><span class="linenos">281</span></a>
</span><span id="HierarchicalNet-282"><a href="#HierarchicalNet-282"><span class="linenos">282</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">squeeze</span> <span class="ow">and</span> <span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="HierarchicalNet-283"><a href="#HierarchicalNet-283"><span class="linenos">283</span></a>            <span class="n">out</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="HierarchicalNet-284"><a href="#HierarchicalNet-284"><span class="linenos">284</span></a>        <span class="c1">############################</span>
</span><span id="HierarchicalNet-285"><a href="#HierarchicalNet-285"><span class="linenos">285</span></a>
</span><span id="HierarchicalNet-286"><a href="#HierarchicalNet-286"><span class="linenos">286</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HierarchicalNet-287"><a href="#HierarchicalNet-287"><span class="linenos">287</span></a>            <span class="n">output_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_key</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_key</span>
</span><span id="HierarchicalNet-288"><a href="#HierarchicalNet-288"><span class="linenos">288</span></a>            <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="n">output_key</span><span class="p">:</span> <span class="n">out</span><span class="p">}</span> <span class="k">if</span> <span class="n">output_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">out</span>
</span><span id="HierarchicalNet-289"><a href="#HierarchicalNet-289"><span class="linenos">289</span></a>        <span class="k">return</span> <span class="n">out</span>
</span></pre></div>


            <div class="docstring"><p>Neural network for a sequence of inputs (in axis=-2) with a decay factor</p>

<p>Parameters:
    neurons (Sequence[int]): A sequence of integers representing the number of neurons in each layer.
    activation (Union[Callable, str], optional): Activation function to use. Defaults to nn.silu.
    use_bias (bool, optional): Whether to include bias terms in the linear layers. Defaults to True.
    input_key (Optional[str], optional): Key to access the input data if it is a dictionary. Defaults to None.
    output_key (Optional[str], optional): Key to store the output data if it is a dictionary. Defaults to None.
    decay (float, optional): Decay factor to scale each layer. Defaults to 0.01.
    squeeze (bool, optional): Whether to squeeze the output if it has shape (..., 1). Defaults to False.
    kernel_init (Union[str, Callable], optional): Initialization method for the linear layers. Defaults to nn.linear.default_kernel_init.</p>
</div>


                            <div id="HierarchicalNet.__init__" class="classattr">
                                <div class="attr function">
            
        <span class="name">HierarchicalNet</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">neurons</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>,</span><span class="param">	<span class="n">activation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">PjitFunction</span> <span class="n">of</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">silu</span><span class="o">&gt;&gt;</span>,</span><span class="param">	<span class="n">use_bias</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">input_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">output_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">decay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span>,</span><span class="param">	<span class="n">squeeze</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">kernel_init</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">variance_scaling</span><span class="o">.&lt;</span><span class="nb">locals</span><span class="o">&gt;.</span><span class="n">init</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">FID</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;HIERARCHICAL_NET&#39;</span>,</span><span class="param">	<span class="n">parent</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">flax</span><span class="o">.</span><span class="n">linen</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">Module</span><span class="p">],</span> <span class="n">flax</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">Scope</span><span class="p">,</span> <span class="n">Type</span><span class="p">[</span><span class="n">flax</span><span class="o">.</span><span class="n">linen</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">_Sentinel</span><span class="p">],</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">flax</span><span class="o">.</span><span class="n">linen</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">_Sentinel</span> <span class="nb">object</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

        
    </div>
    <a class="headerlink" href="#HierarchicalNet.__init__"></a>
    
    

                            </div>
                            <div id="HierarchicalNet.neurons" class="classattr">
                                <div class="attr variable">
            <span class="name">neurons</span><span class="annotation">: Sequence[int]</span>

        
    </div>
    <a class="headerlink" href="#HierarchicalNet.neurons"></a>
    
    

                            </div>
                            <div id="HierarchicalNet.activation" class="classattr">
                                        <input id="HierarchicalNet.activation-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@jax.jit</div>

        <span class="def">def</span>
        <span class="name">activation</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">x</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">bool_</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span>:</span></span>

                <label class="view-source-button" for="HierarchicalNet.activation-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#HierarchicalNet.activation"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="HierarchicalNet.activation-151"><a href="#HierarchicalNet.activation-151"><span class="linenos">151</span></a><span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
</span><span id="HierarchicalNet.activation-152"><a href="#HierarchicalNet.activation-152"><span class="linenos">152</span></a><span class="k">def</span> <span class="nf">silu</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="p">:</span>
</span><span id="HierarchicalNet.activation-153"><a href="#HierarchicalNet.activation-153"><span class="linenos">153</span></a><span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;SiLU (a.k.a. swish) activation function.</span>
</span><span id="HierarchicalNet.activation-154"><a href="#HierarchicalNet.activation-154"><span class="linenos">154</span></a>
</span><span id="HierarchicalNet.activation-155"><a href="#HierarchicalNet.activation-155"><span class="linenos">155</span></a><span class="sd">  Computes the element-wise function:</span>
</span><span id="HierarchicalNet.activation-156"><a href="#HierarchicalNet.activation-156"><span class="linenos">156</span></a>
</span><span id="HierarchicalNet.activation-157"><a href="#HierarchicalNet.activation-157"><span class="linenos">157</span></a><span class="sd">  .. math::</span>
</span><span id="HierarchicalNet.activation-158"><a href="#HierarchicalNet.activation-158"><span class="linenos">158</span></a><span class="sd">    \mathrm{silu}(x) = x \cdot \mathrm{sigmoid}(x) = \frac{x}{1 + e^{-x}}</span>
</span><span id="HierarchicalNet.activation-159"><a href="#HierarchicalNet.activation-159"><span class="linenos">159</span></a>
</span><span id="HierarchicalNet.activation-160"><a href="#HierarchicalNet.activation-160"><span class="linenos">160</span></a><span class="sd">  :func:`swish` and :func:`silu` are both aliases for the same function.</span>
</span><span id="HierarchicalNet.activation-161"><a href="#HierarchicalNet.activation-161"><span class="linenos">161</span></a>
</span><span id="HierarchicalNet.activation-162"><a href="#HierarchicalNet.activation-162"><span class="linenos">162</span></a><span class="sd">  Args:</span>
</span><span id="HierarchicalNet.activation-163"><a href="#HierarchicalNet.activation-163"><span class="linenos">163</span></a><span class="sd">    x : input array</span>
</span><span id="HierarchicalNet.activation-164"><a href="#HierarchicalNet.activation-164"><span class="linenos">164</span></a>
</span><span id="HierarchicalNet.activation-165"><a href="#HierarchicalNet.activation-165"><span class="linenos">165</span></a><span class="sd">  Returns:</span>
</span><span id="HierarchicalNet.activation-166"><a href="#HierarchicalNet.activation-166"><span class="linenos">166</span></a><span class="sd">    An array.</span>
</span><span id="HierarchicalNet.activation-167"><a href="#HierarchicalNet.activation-167"><span class="linenos">167</span></a>
</span><span id="HierarchicalNet.activation-168"><a href="#HierarchicalNet.activation-168"><span class="linenos">168</span></a><span class="sd">  See also:</span>
</span><span id="HierarchicalNet.activation-169"><a href="#HierarchicalNet.activation-169"><span class="linenos">169</span></a><span class="sd">    :func:`sigmoid`</span>
</span><span id="HierarchicalNet.activation-170"><a href="#HierarchicalNet.activation-170"><span class="linenos">170</span></a><span class="sd">  &quot;&quot;&quot;</span>
</span><span id="HierarchicalNet.activation-171"><a href="#HierarchicalNet.activation-171"><span class="linenos">171</span></a>  <span class="n">numpy_util</span><span class="o">.</span><span class="n">check_arraylike</span><span class="p">(</span><span class="s2">&quot;silu&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span><span id="HierarchicalNet.activation-172"><a href="#HierarchicalNet.activation-172"><span class="linenos">172</span></a>  <span class="n">x_arr</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="HierarchicalNet.activation-173"><a href="#HierarchicalNet.activation-173"><span class="linenos">173</span></a>  <span class="k">return</span> <span class="n">x_arr</span> <span class="o">*</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">x_arr</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>SiLU (a.k.a. swish) activation function.</p>

<p>Computes the element-wise function:</p>

<p>$$\mathrm{silu}(x) = x \cdot \mathrm{sigmoid}(x) = \frac{x}{1 + e^{-x}}$$</p>

<p><code>swish()</code> and <code>silu()</code> are both aliases for the same function.</p>

<p>Args:
  x : input array</p>

<p>Returns:
  An array.</p>

<p>See also:
  <code>sigmoid()</code></p>
</div>


                            </div>
                            <div id="HierarchicalNet.use_bias" class="classattr">
                                <div class="attr variable">
            <span class="name">use_bias</span><span class="annotation">: bool</span>        =
<span class="default_value">True</span>

        
    </div>
    <a class="headerlink" href="#HierarchicalNet.use_bias"></a>
    
    

                            </div>
                            <div id="HierarchicalNet.input_key" class="classattr">
                                <div class="attr variable">
            <span class="name">input_key</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#HierarchicalNet.input_key"></a>
    
    

                            </div>
                            <div id="HierarchicalNet.output_key" class="classattr">
                                <div class="attr variable">
            <span class="name">output_key</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#HierarchicalNet.output_key"></a>
    
    

                            </div>
                            <div id="HierarchicalNet.decay" class="classattr">
                                <div class="attr variable">
            <span class="name">decay</span><span class="annotation">: float</span>        =
<span class="default_value">0.01</span>

        
    </div>
    <a class="headerlink" href="#HierarchicalNet.decay"></a>
    
    

                            </div>
                            <div id="HierarchicalNet.squeeze" class="classattr">
                                <div class="attr variable">
            <span class="name">squeeze</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#HierarchicalNet.squeeze"></a>
    
    

                            </div>
                            <div id="HierarchicalNet.kernel_init" class="classattr">
                                        <input id="HierarchicalNet.kernel_init-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">kernel_init</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">key</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span>,</span><span class="param">	<span class="n">shape</span><span class="p">:</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]]</span>,</span><span class="param">	dtype: Any = &lt;class &#x27;jax.numpy.float64&#x27;&gt;</span><span class="return-annotation">) -> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span>:</span></span>

                <label class="view-source-button" for="HierarchicalNet.kernel_init-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#HierarchicalNet.kernel_init"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="HierarchicalNet.kernel_init-317"><a href="#HierarchicalNet.kernel_init-317"><span class="linenos">317</span></a>  <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">KeyArray</span><span class="p">,</span>
</span><span id="HierarchicalNet.kernel_init-318"><a href="#HierarchicalNet.kernel_init-318"><span class="linenos">318</span></a>           <span class="n">shape</span><span class="p">:</span> <span class="n">core</span><span class="o">.</span><span class="n">Shape</span><span class="p">,</span>
</span><span id="HierarchicalNet.kernel_init-319"><a href="#HierarchicalNet.kernel_init-319"><span class="linenos">319</span></a>           <span class="n">dtype</span><span class="p">:</span> <span class="n">DTypeLikeInexact</span> <span class="o">=</span> <span class="n">dtype</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="p">:</span>
</span><span id="HierarchicalNet.kernel_init-320"><a href="#HierarchicalNet.kernel_init-320"><span class="linenos">320</span></a>    <span class="n">dtype</span> <span class="o">=</span> <span class="n">dtypes</span><span class="o">.</span><span class="n">canonicalize_dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="HierarchicalNet.kernel_init-321"><a href="#HierarchicalNet.kernel_init-321"><span class="linenos">321</span></a>    <span class="n">named_shape</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">as_named_shape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
</span><span id="HierarchicalNet.kernel_init-322"><a href="#HierarchicalNet.kernel_init-322"><span class="linenos">322</span></a>    <span class="n">fan_in</span><span class="p">,</span> <span class="n">fan_out</span> <span class="o">=</span> <span class="n">_compute_fans</span><span class="p">(</span><span class="n">named_shape</span><span class="p">,</span> <span class="n">in_axis</span><span class="p">,</span> <span class="n">out_axis</span><span class="p">,</span> <span class="n">batch_axis</span><span class="p">)</span>
</span><span id="HierarchicalNet.kernel_init-323"><a href="#HierarchicalNet.kernel_init-323"><span class="linenos">323</span></a>    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;fan_in&quot;</span><span class="p">:</span> <span class="n">denominator</span> <span class="o">=</span> <span class="n">fan_in</span>
</span><span id="HierarchicalNet.kernel_init-324"><a href="#HierarchicalNet.kernel_init-324"><span class="linenos">324</span></a>    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;fan_out&quot;</span><span class="p">:</span> <span class="n">denominator</span> <span class="o">=</span> <span class="n">fan_out</span>
</span><span id="HierarchicalNet.kernel_init-325"><a href="#HierarchicalNet.kernel_init-325"><span class="linenos">325</span></a>    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;fan_avg&quot;</span><span class="p">:</span> <span class="n">denominator</span> <span class="o">=</span> <span class="p">(</span><span class="n">fan_in</span> <span class="o">+</span> <span class="n">fan_out</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="HierarchicalNet.kernel_init-326"><a href="#HierarchicalNet.kernel_init-326"><span class="linenos">326</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="HierarchicalNet.kernel_init-327"><a href="#HierarchicalNet.kernel_init-327"><span class="linenos">327</span></a>      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="HierarchicalNet.kernel_init-328"><a href="#HierarchicalNet.kernel_init-328"><span class="linenos">328</span></a>        <span class="sa">f</span><span class="s2">&quot;invalid mode for variance scaling initializer: </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="HierarchicalNet.kernel_init-329"><a href="#HierarchicalNet.kernel_init-329"><span class="linenos">329</span></a>    <span class="n">variance</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">scale</span> <span class="o">/</span> <span class="n">denominator</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="HierarchicalNet.kernel_init-330"><a href="#HierarchicalNet.kernel_init-330"><span class="linenos">330</span></a>
</span><span id="HierarchicalNet.kernel_init-331"><a href="#HierarchicalNet.kernel_init-331"><span class="linenos">331</span></a>    <span class="k">if</span> <span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;truncated_normal&quot;</span><span class="p">:</span>
</span><span id="HierarchicalNet.kernel_init-332"><a href="#HierarchicalNet.kernel_init-332"><span class="linenos">332</span></a>      <span class="k">if</span> <span class="n">jnp</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">floating</span><span class="p">):</span>
</span><span id="HierarchicalNet.kernel_init-333"><a href="#HierarchicalNet.kernel_init-333"><span class="linenos">333</span></a>        <span class="c1"># constant is stddev of standard normal truncated to (-2, 2)</span>
</span><span id="HierarchicalNet.kernel_init-334"><a href="#HierarchicalNet.kernel_init-334"><span class="linenos">334</span></a>        <span class="n">stddev</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">.87962566103423978</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
</span><span id="HierarchicalNet.kernel_init-335"><a href="#HierarchicalNet.kernel_init-335"><span class="linenos">335</span></a>        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">truncated_normal</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">named_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="n">stddev</span>
</span><span id="HierarchicalNet.kernel_init-336"><a href="#HierarchicalNet.kernel_init-336"><span class="linenos">336</span></a>      <span class="k">else</span><span class="p">:</span>
</span><span id="HierarchicalNet.kernel_init-337"><a href="#HierarchicalNet.kernel_init-337"><span class="linenos">337</span></a>        <span class="c1"># constant is stddev of complex standard normal truncated to 2</span>
</span><span id="HierarchicalNet.kernel_init-338"><a href="#HierarchicalNet.kernel_init-338"><span class="linenos">338</span></a>        <span class="n">stddev</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">.95311164380491208</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
</span><span id="HierarchicalNet.kernel_init-339"><a href="#HierarchicalNet.kernel_init-339"><span class="linenos">339</span></a>        <span class="k">return</span> <span class="n">_complex_truncated_normal</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">named_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="n">stddev</span>
</span><span id="HierarchicalNet.kernel_init-340"><a href="#HierarchicalNet.kernel_init-340"><span class="linenos">340</span></a>    <span class="k">elif</span> <span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;normal&quot;</span><span class="p">:</span>
</span><span id="HierarchicalNet.kernel_init-341"><a href="#HierarchicalNet.kernel_init-341"><span class="linenos">341</span></a>      <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">named_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span>
</span><span id="HierarchicalNet.kernel_init-342"><a href="#HierarchicalNet.kernel_init-342"><span class="linenos">342</span></a>    <span class="k">elif</span> <span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;uniform&quot;</span><span class="p">:</span>
</span><span id="HierarchicalNet.kernel_init-343"><a href="#HierarchicalNet.kernel_init-343"><span class="linenos">343</span></a>      <span class="k">if</span> <span class="n">jnp</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">floating</span><span class="p">):</span>
</span><span id="HierarchicalNet.kernel_init-344"><a href="#HierarchicalNet.kernel_init-344"><span class="linenos">344</span></a>        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">named_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">variance</span><span class="p">)</span>
</span><span id="HierarchicalNet.kernel_init-345"><a href="#HierarchicalNet.kernel_init-345"><span class="linenos">345</span></a>      <span class="k">else</span><span class="p">:</span>
</span><span id="HierarchicalNet.kernel_init-346"><a href="#HierarchicalNet.kernel_init-346"><span class="linenos">346</span></a>        <span class="k">return</span> <span class="n">_complex_uniform</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">named_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span>
</span><span id="HierarchicalNet.kernel_init-347"><a href="#HierarchicalNet.kernel_init-347"><span class="linenos">347</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="HierarchicalNet.kernel_init-348"><a href="#HierarchicalNet.kernel_init-348"><span class="linenos">348</span></a>      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;invalid distribution for variance scaling initializer: </span><span class="si">{</span><span class="n">distribution</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="HierarchicalNet.FID" class="classattr">
                                <div class="attr variable">
            <span class="name">FID</span><span class="annotation">: str</span>        =
<span class="default_value">&#39;HIERARCHICAL_NET&#39;</span>

        
    </div>
    <a class="headerlink" href="#HierarchicalNet.FID"></a>
    
    

                            </div>
                            <div id="HierarchicalNet.parent" class="classattr">
                                <div class="attr variable">
            <span class="name">parent</span><span class="annotation">: Union[Type[flax.linen.module.Module], flax.core.scope.Scope, Type[flax.linen.module._Sentinel], NoneType]</span>

        
    </div>
    <a class="headerlink" href="#HierarchicalNet.parent"></a>
    
            <div class="docstring"><p>Wraps parent module references in weak refs.</p>

<p>This prevents reference cycles from forming via parent links which can lead
to accidental OOMs in eager mode due to slow garbage collection as well as
spurious tracer leaks during jit compilation.</p>

<p>Note: "descriptors" are the underlying python mechanism for implementing
dynamic @property decorators.  We need to use a raw descriptor instead of the
more common decorator in order to force that the appropriate getter/setter
logic applies in subclasses even after various dataclass transforms.</p>
</div>


                            </div>
                            <div id="HierarchicalNet.name" class="classattr">
                                <div class="attr variable">
            <span class="name">name</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#HierarchicalNet.name"></a>
    
    

                            </div>
                            <div id="HierarchicalNet.scope" class="classattr">
                                <div class="attr variable">
            <span class="name">scope</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#HierarchicalNet.scope"></a>
    
    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>flax.linen.module.Module</dt>
                                <dd id="HierarchicalNet.setup" class="function">setup</dd>
                <dd id="HierarchicalNet.path" class="variable">path</dd>
                <dd id="HierarchicalNet.clone" class="function">clone</dd>
                <dd id="HierarchicalNet.copy" class="function">copy</dd>
                <dd id="HierarchicalNet.variable" class="function">variable</dd>
                <dd id="HierarchicalNet.param" class="function">param</dd>
                <dd id="HierarchicalNet.has_variable" class="function">has_variable</dd>
                <dd id="HierarchicalNet.is_mutable_collection" class="function">is_mutable_collection</dd>
                <dd id="HierarchicalNet.has_rng" class="function">has_rng</dd>
                <dd id="HierarchicalNet.make_rng" class="function">make_rng</dd>
                <dd id="HierarchicalNet.is_initializing" class="function">is_initializing</dd>
                <dd id="HierarchicalNet.bind" class="function">bind</dd>
                <dd id="HierarchicalNet.unbind" class="function">unbind</dd>
                <dd id="HierarchicalNet.apply" class="function">apply</dd>
                <dd id="HierarchicalNet.init_with_output" class="function">init_with_output</dd>
                <dd id="HierarchicalNet.init" class="function">init</dd>
                <dd id="HierarchicalNet.lazy_init" class="function">lazy_init</dd>
                <dd id="HierarchicalNet.variables" class="variable">variables</dd>
                <dd id="HierarchicalNet.get_variable" class="function">get_variable</dd>
                <dd id="HierarchicalNet.put_variable" class="function">put_variable</dd>
                <dd id="HierarchicalNet.sow" class="function">sow</dd>
                <dd id="HierarchicalNet.perturb" class="function">perturb</dd>
                <dd id="HierarchicalNet.tabulate" class="function">tabulate</dd>
                <dd id="HierarchicalNet.module_paths" class="function">module_paths</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="SpeciesIndexNet">
                            <input id="SpeciesIndexNet-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">SpeciesIndexNet</span><wbr>(<span class="base">flax.linen.module.Module</span>):

                <label class="view-source-button" for="SpeciesIndexNet-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SpeciesIndexNet"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SpeciesIndexNet-292"><a href="#SpeciesIndexNet-292"><span class="linenos">292</span></a><span class="k">class</span> <span class="nc">SpeciesIndexNet</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="SpeciesIndexNet-293"><a href="#SpeciesIndexNet-293"><span class="linenos">293</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Chemical-species-specific neural network using precomputed species index.</span>
</span><span id="SpeciesIndexNet-294"><a href="#SpeciesIndexNet-294"><span class="linenos">294</span></a>
</span><span id="SpeciesIndexNet-295"><a href="#SpeciesIndexNet-295"><span class="linenos">295</span></a><span class="sd">    A neural network that applies a species-specific fully connected network to each atom embedding.</span>
</span><span id="SpeciesIndexNet-296"><a href="#SpeciesIndexNet-296"><span class="linenos">296</span></a><span class="sd">    A species index must be provided to filter the embeddings for each species and apply the corresponding network.</span>
</span><span id="SpeciesIndexNet-297"><a href="#SpeciesIndexNet-297"><span class="linenos">297</span></a><span class="sd">    This index can be obtained using the SPECIES_INDEXER preprocessing module.</span>
</span><span id="SpeciesIndexNet-298"><a href="#SpeciesIndexNet-298"><span class="linenos">298</span></a>
</span><span id="SpeciesIndexNet-299"><a href="#SpeciesIndexNet-299"><span class="linenos">299</span></a><span class="sd">    Parameters:</span>
</span><span id="SpeciesIndexNet-300"><a href="#SpeciesIndexNet-300"><span class="linenos">300</span></a><span class="sd">        output_dim (int): The dimension of the output of the fully connected networks. It is the same for all species.</span>
</span><span id="SpeciesIndexNet-301"><a href="#SpeciesIndexNet-301"><span class="linenos">301</span></a><span class="sd">        hidden_neurons (Union[dict, Sequence[int]]): The hidden dimensions of the fully connected networks for each species.</span>
</span><span id="SpeciesIndexNet-302"><a href="#SpeciesIndexNet-302"><span class="linenos">302</span></a><span class="sd">            If a dictionary is provided, it should map species names to dimensions.</span>
</span><span id="SpeciesIndexNet-303"><a href="#SpeciesIndexNet-303"><span class="linenos">303</span></a><span class="sd">            If a sequence is provided, the same dimensions will be used for all species.</span>
</span><span id="SpeciesIndexNet-304"><a href="#SpeciesIndexNet-304"><span class="linenos">304</span></a><span class="sd">        species_order (Sequence[str]): The species for which to build a network. Only required if neurons is not a dictionary.</span>
</span><span id="SpeciesIndexNet-305"><a href="#SpeciesIndexNet-305"><span class="linenos">305</span></a><span class="sd">        activation (Callable, optional): The activation function to use in the fully connected networks. Defaults to nn.silu.</span>
</span><span id="SpeciesIndexNet-306"><a href="#SpeciesIndexNet-306"><span class="linenos">306</span></a><span class="sd">        use_bias (bool, optional): Whether to include bias terms in the fully connected networks. Defaults to True.</span>
</span><span id="SpeciesIndexNet-307"><a href="#SpeciesIndexNet-307"><span class="linenos">307</span></a><span class="sd">        input_key (str, optional): The key in the input dictionary that corresponds to the embeddings of the atoms.</span>
</span><span id="SpeciesIndexNet-308"><a href="#SpeciesIndexNet-308"><span class="linenos">308</span></a><span class="sd">            If None, the input is assumed to be a tuple (species,embeddings). Defaults to None.</span>
</span><span id="SpeciesIndexNet-309"><a href="#SpeciesIndexNet-309"><span class="linenos">309</span></a><span class="sd">        species_index_key str: The key in the input dictionary that corresponds to the species index of the atoms.</span>
</span><span id="SpeciesIndexNet-310"><a href="#SpeciesIndexNet-310"><span class="linenos">310</span></a><span class="sd">            This index can be obtained via the SPECIES_INDEXER preprocessing module. Defaults to &quot;species_index&quot;.</span>
</span><span id="SpeciesIndexNet-311"><a href="#SpeciesIndexNet-311"><span class="linenos">311</span></a><span class="sd">        output_key (str, optional): The key in the output dictionary that corresponds to the network&#39;s output.</span>
</span><span id="SpeciesIndexNet-312"><a href="#SpeciesIndexNet-312"><span class="linenos">312</span></a><span class="sd">            If None, the output is returned directly. Defaults to None.</span>
</span><span id="SpeciesIndexNet-313"><a href="#SpeciesIndexNet-313"><span class="linenos">313</span></a><span class="sd">        squeeze (bool, optional): Whether to squeeze the output if it has shape (batch_size, 1). Defaults to False.</span>
</span><span id="SpeciesIndexNet-314"><a href="#SpeciesIndexNet-314"><span class="linenos">314</span></a><span class="sd">        kernel_init (Union[str, Callable], optional): The kernel initialization method for the fully connected networks. Defaults to nn.linear.default_kernel_init.</span>
</span><span id="SpeciesIndexNet-315"><a href="#SpeciesIndexNet-315"><span class="linenos">315</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="SpeciesIndexNet-316"><a href="#SpeciesIndexNet-316"><span class="linenos">316</span></a>
</span><span id="SpeciesIndexNet-317"><a href="#SpeciesIndexNet-317"><span class="linenos">317</span></a>    <span class="n">output_dim</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="SpeciesIndexNet-318"><a href="#SpeciesIndexNet-318"><span class="linenos">318</span></a>    <span class="n">hidden_neurons</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">FrozenDict</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span>
</span><span id="SpeciesIndexNet-319"><a href="#SpeciesIndexNet-319"><span class="linenos">319</span></a>    <span class="n">species_order</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SpeciesIndexNet-320"><a href="#SpeciesIndexNet-320"><span class="linenos">320</span></a>    <span class="n">activation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">silu</span>
</span><span id="SpeciesIndexNet-321"><a href="#SpeciesIndexNet-321"><span class="linenos">321</span></a>    <span class="n">use_bias</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="SpeciesIndexNet-322"><a href="#SpeciesIndexNet-322"><span class="linenos">322</span></a>    <span class="n">input_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SpeciesIndexNet-323"><a href="#SpeciesIndexNet-323"><span class="linenos">323</span></a>    <span class="n">species_index_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;species_index&quot;</span>
</span><span id="SpeciesIndexNet-324"><a href="#SpeciesIndexNet-324"><span class="linenos">324</span></a>    <span class="n">output_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SpeciesIndexNet-325"><a href="#SpeciesIndexNet-325"><span class="linenos">325</span></a>    <span class="n">squeeze</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="SpeciesIndexNet-326"><a href="#SpeciesIndexNet-326"><span class="linenos">326</span></a>    <span class="n">kernel_init</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">default_kernel_init</span>
</span><span id="SpeciesIndexNet-327"><a href="#SpeciesIndexNet-327"><span class="linenos">327</span></a>
</span><span id="SpeciesIndexNet-328"><a href="#SpeciesIndexNet-328"><span class="linenos">328</span></a>    <span class="n">FID</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;SPECIES_INDEX_NET&quot;</span>
</span><span id="SpeciesIndexNet-329"><a href="#SpeciesIndexNet-329"><span class="linenos">329</span></a>
</span><span id="SpeciesIndexNet-330"><a href="#SpeciesIndexNet-330"><span class="linenos">330</span></a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="SpeciesIndexNet-331"><a href="#SpeciesIndexNet-331"><span class="linenos">331</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
</span><span id="SpeciesIndexNet-332"><a href="#SpeciesIndexNet-332"><span class="linenos">332</span></a>            <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_neurons</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
</span><span id="SpeciesIndexNet-333"><a href="#SpeciesIndexNet-333"><span class="linenos">333</span></a>            <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_neurons</span><span class="p">,</span> <span class="n">FrozenDict</span><span class="p">)</span>
</span><span id="SpeciesIndexNet-334"><a href="#SpeciesIndexNet-334"><span class="linenos">334</span></a>        <span class="p">):</span>
</span><span id="SpeciesIndexNet-335"><a href="#SpeciesIndexNet-335"><span class="linenos">335</span></a>            <span class="k">assert</span> <span class="p">(</span>
</span><span id="SpeciesIndexNet-336"><a href="#SpeciesIndexNet-336"><span class="linenos">336</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">species_order</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="SpeciesIndexNet-337"><a href="#SpeciesIndexNet-337"><span class="linenos">337</span></a>            <span class="p">),</span> <span class="s2">&quot;species_order must be provided if hidden_neurons is not a dictionary&quot;</span>
</span><span id="SpeciesIndexNet-338"><a href="#SpeciesIndexNet-338"><span class="linenos">338</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_order</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="SpeciesIndexNet-339"><a href="#SpeciesIndexNet-339"><span class="linenos">339</span></a>                <span class="n">species_order</span> <span class="o">=</span> <span class="p">[</span><span class="n">el</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_order</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>
</span><span id="SpeciesIndexNet-340"><a href="#SpeciesIndexNet-340"><span class="linenos">340</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SpeciesIndexNet-341"><a href="#SpeciesIndexNet-341"><span class="linenos">341</span></a>                <span class="n">species_order</span> <span class="o">=</span> <span class="p">[</span><span class="n">el</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_order</span><span class="p">]</span>
</span><span id="SpeciesIndexNet-342"><a href="#SpeciesIndexNet-342"><span class="linenos">342</span></a>            <span class="n">neurons</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_neurons</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">species_order</span><span class="p">}</span>
</span><span id="SpeciesIndexNet-343"><a href="#SpeciesIndexNet-343"><span class="linenos">343</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SpeciesIndexNet-344"><a href="#SpeciesIndexNet-344"><span class="linenos">344</span></a>            <span class="n">neurons</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_neurons</span>
</span><span id="SpeciesIndexNet-345"><a href="#SpeciesIndexNet-345"><span class="linenos">345</span></a>            <span class="n">species_order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">neurons</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="SpeciesIndexNet-346"><a href="#SpeciesIndexNet-346"><span class="linenos">346</span></a>        <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="n">species_order</span><span class="p">:</span>
</span><span id="SpeciesIndexNet-347"><a href="#SpeciesIndexNet-347"><span class="linenos">347</span></a>            <span class="k">assert</span> <span class="p">(</span>
</span><span id="SpeciesIndexNet-348"><a href="#SpeciesIndexNet-348"><span class="linenos">348</span></a>                <span class="n">species</span> <span class="ow">in</span> <span class="n">PERIODIC_TABLE</span>
</span><span id="SpeciesIndexNet-349"><a href="#SpeciesIndexNet-349"><span class="linenos">349</span></a>            <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;species </span><span class="si">{</span><span class="n">species</span><span class="si">}</span><span class="s2"> not found in periodic table&quot;</span>
</span><span id="SpeciesIndexNet-350"><a href="#SpeciesIndexNet-350"><span class="linenos">350</span></a>
</span><span id="SpeciesIndexNet-351"><a href="#SpeciesIndexNet-351"><span class="linenos">351</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">networks</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="SpeciesIndexNet-352"><a href="#SpeciesIndexNet-352"><span class="linenos">352</span></a>            <span class="n">k</span><span class="p">:</span> <span class="n">FullyConnectedNet</span><span class="p">(</span>
</span><span id="SpeciesIndexNet-353"><a href="#SpeciesIndexNet-353"><span class="linenos">353</span></a>                <span class="p">[</span><span class="o">*</span><span class="n">neurons</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dim</span><span class="p">],</span>
</span><span id="SpeciesIndexNet-354"><a href="#SpeciesIndexNet-354"><span class="linenos">354</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">,</span>
</span><span id="SpeciesIndexNet-355"><a href="#SpeciesIndexNet-355"><span class="linenos">355</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">use_bias</span><span class="p">,</span>
</span><span id="SpeciesIndexNet-356"><a href="#SpeciesIndexNet-356"><span class="linenos">356</span></a>                <span class="n">name</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
</span><span id="SpeciesIndexNet-357"><a href="#SpeciesIndexNet-357"><span class="linenos">357</span></a>                <span class="n">kernel_init</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_init</span><span class="p">,</span>
</span><span id="SpeciesIndexNet-358"><a href="#SpeciesIndexNet-358"><span class="linenos">358</span></a>            <span class="p">)</span>
</span><span id="SpeciesIndexNet-359"><a href="#SpeciesIndexNet-359"><span class="linenos">359</span></a>            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">species_order</span>
</span><span id="SpeciesIndexNet-360"><a href="#SpeciesIndexNet-360"><span class="linenos">360</span></a>        <span class="p">}</span>
</span><span id="SpeciesIndexNet-361"><a href="#SpeciesIndexNet-361"><span class="linenos">361</span></a>
</span><span id="SpeciesIndexNet-362"><a href="#SpeciesIndexNet-362"><span class="linenos">362</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span>
</span><span id="SpeciesIndexNet-363"><a href="#SpeciesIndexNet-363"><span class="linenos">363</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">]]</span>
</span><span id="SpeciesIndexNet-364"><a href="#SpeciesIndexNet-364"><span class="linenos">364</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">]:</span>
</span><span id="SpeciesIndexNet-365"><a href="#SpeciesIndexNet-365"><span class="linenos">365</span></a>
</span><span id="SpeciesIndexNet-366"><a href="#SpeciesIndexNet-366"><span class="linenos">366</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SpeciesIndexNet-367"><a href="#SpeciesIndexNet-367"><span class="linenos">367</span></a>            <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
</span><span id="SpeciesIndexNet-368"><a href="#SpeciesIndexNet-368"><span class="linenos">368</span></a>                <span class="n">inputs</span><span class="p">,</span> <span class="nb">dict</span>
</span><span id="SpeciesIndexNet-369"><a href="#SpeciesIndexNet-369"><span class="linenos">369</span></a>            <span class="p">),</span> <span class="s2">&quot;input key must be provided if inputs is a dictionary&quot;</span>
</span><span id="SpeciesIndexNet-370"><a href="#SpeciesIndexNet-370"><span class="linenos">370</span></a>            <span class="n">species</span><span class="p">,</span> <span class="n">embedding</span><span class="p">,</span> <span class="n">species_index</span> <span class="o">=</span> <span class="n">inputs</span>
</span><span id="SpeciesIndexNet-371"><a href="#SpeciesIndexNet-371"><span class="linenos">371</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SpeciesIndexNet-372"><a href="#SpeciesIndexNet-372"><span class="linenos">372</span></a>            <span class="n">species</span><span class="p">,</span> <span class="n">embedding</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">],</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">input_key</span><span class="p">]</span>
</span><span id="SpeciesIndexNet-373"><a href="#SpeciesIndexNet-373"><span class="linenos">373</span></a>            <span class="n">species_index</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">species_index_key</span><span class="p">]</span>
</span><span id="SpeciesIndexNet-374"><a href="#SpeciesIndexNet-374"><span class="linenos">374</span></a>
</span><span id="SpeciesIndexNet-375"><a href="#SpeciesIndexNet-375"><span class="linenos">375</span></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span>
</span><span id="SpeciesIndexNet-376"><a href="#SpeciesIndexNet-376"><span class="linenos">376</span></a>            <span class="n">species_index</span><span class="p">,</span> <span class="nb">dict</span>
</span><span id="SpeciesIndexNet-377"><a href="#SpeciesIndexNet-377"><span class="linenos">377</span></a>        <span class="p">),</span> <span class="s2">&quot;species_index must be a dictionary for SpeciesIndexNetHet&quot;</span>
</span><span id="SpeciesIndexNet-378"><a href="#SpeciesIndexNet-378"><span class="linenos">378</span></a>
</span><span id="SpeciesIndexNet-379"><a href="#SpeciesIndexNet-379"><span class="linenos">379</span></a>        <span class="c1">############################</span>
</span><span id="SpeciesIndexNet-380"><a href="#SpeciesIndexNet-380"><span class="linenos">380</span></a>        <span class="c1"># initialization =&gt; instantiate all networks</span>
</span><span id="SpeciesIndexNet-381"><a href="#SpeciesIndexNet-381"><span class="linenos">381</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_initializing</span><span class="p">():</span>
</span><span id="SpeciesIndexNet-382"><a href="#SpeciesIndexNet-382"><span class="linenos">382</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">embedding</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">embedding</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="SpeciesIndexNet-383"><a href="#SpeciesIndexNet-383"><span class="linenos">383</span></a>            <span class="p">[</span><span class="n">net</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">net</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
</span><span id="SpeciesIndexNet-384"><a href="#SpeciesIndexNet-384"><span class="linenos">384</span></a>
</span><span id="SpeciesIndexNet-385"><a href="#SpeciesIndexNet-385"><span class="linenos">385</span></a>        <span class="c1">############################</span>
</span><span id="SpeciesIndexNet-386"><a href="#SpeciesIndexNet-386"><span class="linenos">386</span></a>        <span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SpeciesIndexNet-387"><a href="#SpeciesIndexNet-387"><span class="linenos">387</span></a>        <span class="n">indices</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SpeciesIndexNet-388"><a href="#SpeciesIndexNet-388"><span class="linenos">388</span></a>        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">net</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="SpeciesIndexNet-389"><a href="#SpeciesIndexNet-389"><span class="linenos">389</span></a>            <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">species_index</span><span class="p">:</span>
</span><span id="SpeciesIndexNet-390"><a href="#SpeciesIndexNet-390"><span class="linenos">390</span></a>                <span class="k">continue</span>
</span><span id="SpeciesIndexNet-391"><a href="#SpeciesIndexNet-391"><span class="linenos">391</span></a>            <span class="n">idx</span> <span class="o">=</span> <span class="n">species_index</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
</span><span id="SpeciesIndexNet-392"><a href="#SpeciesIndexNet-392"><span class="linenos">392</span></a>            <span class="n">o</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">embedding</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
</span><span id="SpeciesIndexNet-393"><a href="#SpeciesIndexNet-393"><span class="linenos">393</span></a>            <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
</span><span id="SpeciesIndexNet-394"><a href="#SpeciesIndexNet-394"><span class="linenos">394</span></a>            <span class="n">indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
</span><span id="SpeciesIndexNet-395"><a href="#SpeciesIndexNet-395"><span class="linenos">395</span></a>
</span><span id="SpeciesIndexNet-396"><a href="#SpeciesIndexNet-396"><span class="linenos">396</span></a>        <span class="n">o</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="SpeciesIndexNet-397"><a href="#SpeciesIndexNet-397"><span class="linenos">397</span></a>        <span class="n">idx</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="SpeciesIndexNet-398"><a href="#SpeciesIndexNet-398"><span class="linenos">398</span></a>
</span><span id="SpeciesIndexNet-399"><a href="#SpeciesIndexNet-399"><span class="linenos">399</span></a>        <span class="n">out</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="SpeciesIndexNet-400"><a href="#SpeciesIndexNet-400"><span class="linenos">400</span></a>            <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">species</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">*</span><span class="n">o</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">o</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="SpeciesIndexNet-401"><a href="#SpeciesIndexNet-401"><span class="linenos">401</span></a>            <span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="SpeciesIndexNet-402"><a href="#SpeciesIndexNet-402"><span class="linenos">402</span></a>            <span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;drop&quot;</span><span class="p">)</span>
</span><span id="SpeciesIndexNet-403"><a href="#SpeciesIndexNet-403"><span class="linenos">403</span></a>        <span class="p">)</span>
</span><span id="SpeciesIndexNet-404"><a href="#SpeciesIndexNet-404"><span class="linenos">404</span></a>
</span><span id="SpeciesIndexNet-405"><a href="#SpeciesIndexNet-405"><span class="linenos">405</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">squeeze</span> <span class="ow">and</span> <span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="SpeciesIndexNet-406"><a href="#SpeciesIndexNet-406"><span class="linenos">406</span></a>            <span class="n">out</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="SpeciesIndexNet-407"><a href="#SpeciesIndexNet-407"><span class="linenos">407</span></a>        <span class="c1">############################</span>
</span><span id="SpeciesIndexNet-408"><a href="#SpeciesIndexNet-408"><span class="linenos">408</span></a>
</span><span id="SpeciesIndexNet-409"><a href="#SpeciesIndexNet-409"><span class="linenos">409</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SpeciesIndexNet-410"><a href="#SpeciesIndexNet-410"><span class="linenos">410</span></a>            <span class="n">output_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_key</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_key</span>
</span><span id="SpeciesIndexNet-411"><a href="#SpeciesIndexNet-411"><span class="linenos">411</span></a>            <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="n">output_key</span><span class="p">:</span> <span class="n">out</span><span class="p">}</span> <span class="k">if</span> <span class="n">output_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">out</span>
</span><span id="SpeciesIndexNet-412"><a href="#SpeciesIndexNet-412"><span class="linenos">412</span></a>        <span class="k">return</span> <span class="n">out</span>
</span></pre></div>


            <div class="docstring"><p>Chemical-species-specific neural network using precomputed species index.</p>

<p>A neural network that applies a species-specific fully connected network to each atom embedding.
A species index must be provided to filter the embeddings for each species and apply the corresponding network.
This index can be obtained using the SPECIES_INDEXER preprocessing module.</p>

<p>Parameters:
    output_dim (int): The dimension of the output of the fully connected networks. It is the same for all species.
    hidden_neurons (Union[dict, Sequence[int]]): The hidden dimensions of the fully connected networks for each species.
        If a dictionary is provided, it should map species names to dimensions.
        If a sequence is provided, the same dimensions will be used for all species.
    species_order (Sequence[str]): The species for which to build a network. Only required if neurons is not a dictionary.
    activation (Callable, optional): The activation function to use in the fully connected networks. Defaults to nn.silu.
    use_bias (bool, optional): Whether to include bias terms in the fully connected networks. Defaults to True.
    input_key (str, optional): The key in the input dictionary that corresponds to the embeddings of the atoms.
        If None, the input is assumed to be a tuple (species,embeddings). Defaults to None.
    species_index_key str: The key in the input dictionary that corresponds to the species index of the atoms.
        This index can be obtained via the SPECIES_INDEXER preprocessing module. Defaults to "species_index".
    output_key (str, optional): The key in the output dictionary that corresponds to the network's output.
        If None, the output is returned directly. Defaults to None.
    squeeze (bool, optional): Whether to squeeze the output if it has shape (batch_size, 1). Defaults to False.
    kernel_init (Union[str, Callable], optional): The kernel initialization method for the fully connected networks. Defaults to nn.linear.default_kernel_init.</p>
</div>


                            <div id="SpeciesIndexNet.__init__" class="classattr">
                                <div class="attr function">
            
        <span class="name">SpeciesIndexNet</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">output_dim</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">hidden_neurons</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">flax</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frozen_dict</span><span class="o">.</span><span class="n">FrozenDict</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span>,</span><span class="param">	<span class="n">species_order</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">NoneType</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">activation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">PjitFunction</span> <span class="n">of</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">silu</span><span class="o">&gt;&gt;</span>,</span><span class="param">	<span class="n">use_bias</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">input_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">species_index_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;species_index&#39;</span>,</span><span class="param">	<span class="n">output_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">squeeze</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">kernel_init</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">variance_scaling</span><span class="o">.&lt;</span><span class="nb">locals</span><span class="o">&gt;.</span><span class="n">init</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">FID</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;SPECIES_INDEX_NET&#39;</span>,</span><span class="param">	<span class="n">parent</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">flax</span><span class="o">.</span><span class="n">linen</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">Module</span><span class="p">],</span> <span class="n">flax</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">Scope</span><span class="p">,</span> <span class="n">Type</span><span class="p">[</span><span class="n">flax</span><span class="o">.</span><span class="n">linen</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">_Sentinel</span><span class="p">],</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">flax</span><span class="o">.</span><span class="n">linen</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">_Sentinel</span> <span class="nb">object</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

        
    </div>
    <a class="headerlink" href="#SpeciesIndexNet.__init__"></a>
    
    

                            </div>
                            <div id="SpeciesIndexNet.output_dim" class="classattr">
                                <div class="attr variable">
            <span class="name">output_dim</span><span class="annotation">: int</span>

        
    </div>
    <a class="headerlink" href="#SpeciesIndexNet.output_dim"></a>
    
    

                            </div>
                            <div id="SpeciesIndexNet.hidden_neurons" class="classattr">
                                <div class="attr variable">
            <span class="name">hidden_neurons</span><span class="annotation">: Union[dict, flax.core.frozen_dict.FrozenDict, Sequence[int]]</span>

        
    </div>
    <a class="headerlink" href="#SpeciesIndexNet.hidden_neurons"></a>
    
    

                            </div>
                            <div id="SpeciesIndexNet.species_order" class="classattr">
                                <div class="attr variable">
            <span class="name">species_order</span><span class="annotation">: Union[NoneType, str, Sequence[str]]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#SpeciesIndexNet.species_order"></a>
    
    

                            </div>
                            <div id="SpeciesIndexNet.activation" class="classattr">
                                        <input id="SpeciesIndexNet.activation-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@jax.jit</div>

        <span class="def">def</span>
        <span class="name">activation</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">x</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">bool_</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span>:</span></span>

                <label class="view-source-button" for="SpeciesIndexNet.activation-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SpeciesIndexNet.activation"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SpeciesIndexNet.activation-151"><a href="#SpeciesIndexNet.activation-151"><span class="linenos">151</span></a><span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
</span><span id="SpeciesIndexNet.activation-152"><a href="#SpeciesIndexNet.activation-152"><span class="linenos">152</span></a><span class="k">def</span> <span class="nf">silu</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="p">:</span>
</span><span id="SpeciesIndexNet.activation-153"><a href="#SpeciesIndexNet.activation-153"><span class="linenos">153</span></a><span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;SiLU (a.k.a. swish) activation function.</span>
</span><span id="SpeciesIndexNet.activation-154"><a href="#SpeciesIndexNet.activation-154"><span class="linenos">154</span></a>
</span><span id="SpeciesIndexNet.activation-155"><a href="#SpeciesIndexNet.activation-155"><span class="linenos">155</span></a><span class="sd">  Computes the element-wise function:</span>
</span><span id="SpeciesIndexNet.activation-156"><a href="#SpeciesIndexNet.activation-156"><span class="linenos">156</span></a>
</span><span id="SpeciesIndexNet.activation-157"><a href="#SpeciesIndexNet.activation-157"><span class="linenos">157</span></a><span class="sd">  .. math::</span>
</span><span id="SpeciesIndexNet.activation-158"><a href="#SpeciesIndexNet.activation-158"><span class="linenos">158</span></a><span class="sd">    \mathrm{silu}(x) = x \cdot \mathrm{sigmoid}(x) = \frac{x}{1 + e^{-x}}</span>
</span><span id="SpeciesIndexNet.activation-159"><a href="#SpeciesIndexNet.activation-159"><span class="linenos">159</span></a>
</span><span id="SpeciesIndexNet.activation-160"><a href="#SpeciesIndexNet.activation-160"><span class="linenos">160</span></a><span class="sd">  :func:`swish` and :func:`silu` are both aliases for the same function.</span>
</span><span id="SpeciesIndexNet.activation-161"><a href="#SpeciesIndexNet.activation-161"><span class="linenos">161</span></a>
</span><span id="SpeciesIndexNet.activation-162"><a href="#SpeciesIndexNet.activation-162"><span class="linenos">162</span></a><span class="sd">  Args:</span>
</span><span id="SpeciesIndexNet.activation-163"><a href="#SpeciesIndexNet.activation-163"><span class="linenos">163</span></a><span class="sd">    x : input array</span>
</span><span id="SpeciesIndexNet.activation-164"><a href="#SpeciesIndexNet.activation-164"><span class="linenos">164</span></a>
</span><span id="SpeciesIndexNet.activation-165"><a href="#SpeciesIndexNet.activation-165"><span class="linenos">165</span></a><span class="sd">  Returns:</span>
</span><span id="SpeciesIndexNet.activation-166"><a href="#SpeciesIndexNet.activation-166"><span class="linenos">166</span></a><span class="sd">    An array.</span>
</span><span id="SpeciesIndexNet.activation-167"><a href="#SpeciesIndexNet.activation-167"><span class="linenos">167</span></a>
</span><span id="SpeciesIndexNet.activation-168"><a href="#SpeciesIndexNet.activation-168"><span class="linenos">168</span></a><span class="sd">  See also:</span>
</span><span id="SpeciesIndexNet.activation-169"><a href="#SpeciesIndexNet.activation-169"><span class="linenos">169</span></a><span class="sd">    :func:`sigmoid`</span>
</span><span id="SpeciesIndexNet.activation-170"><a href="#SpeciesIndexNet.activation-170"><span class="linenos">170</span></a><span class="sd">  &quot;&quot;&quot;</span>
</span><span id="SpeciesIndexNet.activation-171"><a href="#SpeciesIndexNet.activation-171"><span class="linenos">171</span></a>  <span class="n">numpy_util</span><span class="o">.</span><span class="n">check_arraylike</span><span class="p">(</span><span class="s2">&quot;silu&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span><span id="SpeciesIndexNet.activation-172"><a href="#SpeciesIndexNet.activation-172"><span class="linenos">172</span></a>  <span class="n">x_arr</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="SpeciesIndexNet.activation-173"><a href="#SpeciesIndexNet.activation-173"><span class="linenos">173</span></a>  <span class="k">return</span> <span class="n">x_arr</span> <span class="o">*</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">x_arr</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>SiLU (a.k.a. swish) activation function.</p>

<p>Computes the element-wise function:</p>

<p>$$\mathrm{silu}(x) = x \cdot \mathrm{sigmoid}(x) = \frac{x}{1 + e^{-x}}$$</p>

<p><code>swish()</code> and <code>silu()</code> are both aliases for the same function.</p>

<p>Args:
  x : input array</p>

<p>Returns:
  An array.</p>

<p>See also:
  <code>sigmoid()</code></p>
</div>


                            </div>
                            <div id="SpeciesIndexNet.use_bias" class="classattr">
                                <div class="attr variable">
            <span class="name">use_bias</span><span class="annotation">: bool</span>        =
<span class="default_value">True</span>

        
    </div>
    <a class="headerlink" href="#SpeciesIndexNet.use_bias"></a>
    
    

                            </div>
                            <div id="SpeciesIndexNet.input_key" class="classattr">
                                <div class="attr variable">
            <span class="name">input_key</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#SpeciesIndexNet.input_key"></a>
    
    

                            </div>
                            <div id="SpeciesIndexNet.species_index_key" class="classattr">
                                <div class="attr variable">
            <span class="name">species_index_key</span><span class="annotation">: str</span>        =
<span class="default_value">&#39;species_index&#39;</span>

        
    </div>
    <a class="headerlink" href="#SpeciesIndexNet.species_index_key"></a>
    
    

                            </div>
                            <div id="SpeciesIndexNet.output_key" class="classattr">
                                <div class="attr variable">
            <span class="name">output_key</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#SpeciesIndexNet.output_key"></a>
    
    

                            </div>
                            <div id="SpeciesIndexNet.squeeze" class="classattr">
                                <div class="attr variable">
            <span class="name">squeeze</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#SpeciesIndexNet.squeeze"></a>
    
    

                            </div>
                            <div id="SpeciesIndexNet.kernel_init" class="classattr">
                                        <input id="SpeciesIndexNet.kernel_init-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">kernel_init</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">key</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span>,</span><span class="param">	<span class="n">shape</span><span class="p">:</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]]</span>,</span><span class="param">	dtype: Any = &lt;class &#x27;jax.numpy.float64&#x27;&gt;</span><span class="return-annotation">) -> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span>:</span></span>

                <label class="view-source-button" for="SpeciesIndexNet.kernel_init-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SpeciesIndexNet.kernel_init"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SpeciesIndexNet.kernel_init-317"><a href="#SpeciesIndexNet.kernel_init-317"><span class="linenos">317</span></a>  <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">KeyArray</span><span class="p">,</span>
</span><span id="SpeciesIndexNet.kernel_init-318"><a href="#SpeciesIndexNet.kernel_init-318"><span class="linenos">318</span></a>           <span class="n">shape</span><span class="p">:</span> <span class="n">core</span><span class="o">.</span><span class="n">Shape</span><span class="p">,</span>
</span><span id="SpeciesIndexNet.kernel_init-319"><a href="#SpeciesIndexNet.kernel_init-319"><span class="linenos">319</span></a>           <span class="n">dtype</span><span class="p">:</span> <span class="n">DTypeLikeInexact</span> <span class="o">=</span> <span class="n">dtype</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="p">:</span>
</span><span id="SpeciesIndexNet.kernel_init-320"><a href="#SpeciesIndexNet.kernel_init-320"><span class="linenos">320</span></a>    <span class="n">dtype</span> <span class="o">=</span> <span class="n">dtypes</span><span class="o">.</span><span class="n">canonicalize_dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="SpeciesIndexNet.kernel_init-321"><a href="#SpeciesIndexNet.kernel_init-321"><span class="linenos">321</span></a>    <span class="n">named_shape</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">as_named_shape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
</span><span id="SpeciesIndexNet.kernel_init-322"><a href="#SpeciesIndexNet.kernel_init-322"><span class="linenos">322</span></a>    <span class="n">fan_in</span><span class="p">,</span> <span class="n">fan_out</span> <span class="o">=</span> <span class="n">_compute_fans</span><span class="p">(</span><span class="n">named_shape</span><span class="p">,</span> <span class="n">in_axis</span><span class="p">,</span> <span class="n">out_axis</span><span class="p">,</span> <span class="n">batch_axis</span><span class="p">)</span>
</span><span id="SpeciesIndexNet.kernel_init-323"><a href="#SpeciesIndexNet.kernel_init-323"><span class="linenos">323</span></a>    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;fan_in&quot;</span><span class="p">:</span> <span class="n">denominator</span> <span class="o">=</span> <span class="n">fan_in</span>
</span><span id="SpeciesIndexNet.kernel_init-324"><a href="#SpeciesIndexNet.kernel_init-324"><span class="linenos">324</span></a>    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;fan_out&quot;</span><span class="p">:</span> <span class="n">denominator</span> <span class="o">=</span> <span class="n">fan_out</span>
</span><span id="SpeciesIndexNet.kernel_init-325"><a href="#SpeciesIndexNet.kernel_init-325"><span class="linenos">325</span></a>    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;fan_avg&quot;</span><span class="p">:</span> <span class="n">denominator</span> <span class="o">=</span> <span class="p">(</span><span class="n">fan_in</span> <span class="o">+</span> <span class="n">fan_out</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="SpeciesIndexNet.kernel_init-326"><a href="#SpeciesIndexNet.kernel_init-326"><span class="linenos">326</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="SpeciesIndexNet.kernel_init-327"><a href="#SpeciesIndexNet.kernel_init-327"><span class="linenos">327</span></a>      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="SpeciesIndexNet.kernel_init-328"><a href="#SpeciesIndexNet.kernel_init-328"><span class="linenos">328</span></a>        <span class="sa">f</span><span class="s2">&quot;invalid mode for variance scaling initializer: </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="SpeciesIndexNet.kernel_init-329"><a href="#SpeciesIndexNet.kernel_init-329"><span class="linenos">329</span></a>    <span class="n">variance</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">scale</span> <span class="o">/</span> <span class="n">denominator</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="SpeciesIndexNet.kernel_init-330"><a href="#SpeciesIndexNet.kernel_init-330"><span class="linenos">330</span></a>
</span><span id="SpeciesIndexNet.kernel_init-331"><a href="#SpeciesIndexNet.kernel_init-331"><span class="linenos">331</span></a>    <span class="k">if</span> <span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;truncated_normal&quot;</span><span class="p">:</span>
</span><span id="SpeciesIndexNet.kernel_init-332"><a href="#SpeciesIndexNet.kernel_init-332"><span class="linenos">332</span></a>      <span class="k">if</span> <span class="n">jnp</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">floating</span><span class="p">):</span>
</span><span id="SpeciesIndexNet.kernel_init-333"><a href="#SpeciesIndexNet.kernel_init-333"><span class="linenos">333</span></a>        <span class="c1"># constant is stddev of standard normal truncated to (-2, 2)</span>
</span><span id="SpeciesIndexNet.kernel_init-334"><a href="#SpeciesIndexNet.kernel_init-334"><span class="linenos">334</span></a>        <span class="n">stddev</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">.87962566103423978</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
</span><span id="SpeciesIndexNet.kernel_init-335"><a href="#SpeciesIndexNet.kernel_init-335"><span class="linenos">335</span></a>        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">truncated_normal</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">named_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="n">stddev</span>
</span><span id="SpeciesIndexNet.kernel_init-336"><a href="#SpeciesIndexNet.kernel_init-336"><span class="linenos">336</span></a>      <span class="k">else</span><span class="p">:</span>
</span><span id="SpeciesIndexNet.kernel_init-337"><a href="#SpeciesIndexNet.kernel_init-337"><span class="linenos">337</span></a>        <span class="c1"># constant is stddev of complex standard normal truncated to 2</span>
</span><span id="SpeciesIndexNet.kernel_init-338"><a href="#SpeciesIndexNet.kernel_init-338"><span class="linenos">338</span></a>        <span class="n">stddev</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">.95311164380491208</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
</span><span id="SpeciesIndexNet.kernel_init-339"><a href="#SpeciesIndexNet.kernel_init-339"><span class="linenos">339</span></a>        <span class="k">return</span> <span class="n">_complex_truncated_normal</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">named_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="n">stddev</span>
</span><span id="SpeciesIndexNet.kernel_init-340"><a href="#SpeciesIndexNet.kernel_init-340"><span class="linenos">340</span></a>    <span class="k">elif</span> <span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;normal&quot;</span><span class="p">:</span>
</span><span id="SpeciesIndexNet.kernel_init-341"><a href="#SpeciesIndexNet.kernel_init-341"><span class="linenos">341</span></a>      <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">named_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span>
</span><span id="SpeciesIndexNet.kernel_init-342"><a href="#SpeciesIndexNet.kernel_init-342"><span class="linenos">342</span></a>    <span class="k">elif</span> <span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;uniform&quot;</span><span class="p">:</span>
</span><span id="SpeciesIndexNet.kernel_init-343"><a href="#SpeciesIndexNet.kernel_init-343"><span class="linenos">343</span></a>      <span class="k">if</span> <span class="n">jnp</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">floating</span><span class="p">):</span>
</span><span id="SpeciesIndexNet.kernel_init-344"><a href="#SpeciesIndexNet.kernel_init-344"><span class="linenos">344</span></a>        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">named_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">variance</span><span class="p">)</span>
</span><span id="SpeciesIndexNet.kernel_init-345"><a href="#SpeciesIndexNet.kernel_init-345"><span class="linenos">345</span></a>      <span class="k">else</span><span class="p">:</span>
</span><span id="SpeciesIndexNet.kernel_init-346"><a href="#SpeciesIndexNet.kernel_init-346"><span class="linenos">346</span></a>        <span class="k">return</span> <span class="n">_complex_uniform</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">named_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span>
</span><span id="SpeciesIndexNet.kernel_init-347"><a href="#SpeciesIndexNet.kernel_init-347"><span class="linenos">347</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="SpeciesIndexNet.kernel_init-348"><a href="#SpeciesIndexNet.kernel_init-348"><span class="linenos">348</span></a>      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;invalid distribution for variance scaling initializer: </span><span class="si">{</span><span class="n">distribution</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="SpeciesIndexNet.FID" class="classattr">
                                <div class="attr variable">
            <span class="name">FID</span><span class="annotation">: str</span>        =
<span class="default_value">&#39;SPECIES_INDEX_NET&#39;</span>

        
    </div>
    <a class="headerlink" href="#SpeciesIndexNet.FID"></a>
    
    

                            </div>
                            <div id="SpeciesIndexNet.setup" class="classattr">
                                        <input id="SpeciesIndexNet.setup-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">setup</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SpeciesIndexNet.setup-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SpeciesIndexNet.setup"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SpeciesIndexNet.setup-330"><a href="#SpeciesIndexNet.setup-330"><span class="linenos">330</span></a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="SpeciesIndexNet.setup-331"><a href="#SpeciesIndexNet.setup-331"><span class="linenos">331</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
</span><span id="SpeciesIndexNet.setup-332"><a href="#SpeciesIndexNet.setup-332"><span class="linenos">332</span></a>            <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_neurons</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
</span><span id="SpeciesIndexNet.setup-333"><a href="#SpeciesIndexNet.setup-333"><span class="linenos">333</span></a>            <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_neurons</span><span class="p">,</span> <span class="n">FrozenDict</span><span class="p">)</span>
</span><span id="SpeciesIndexNet.setup-334"><a href="#SpeciesIndexNet.setup-334"><span class="linenos">334</span></a>        <span class="p">):</span>
</span><span id="SpeciesIndexNet.setup-335"><a href="#SpeciesIndexNet.setup-335"><span class="linenos">335</span></a>            <span class="k">assert</span> <span class="p">(</span>
</span><span id="SpeciesIndexNet.setup-336"><a href="#SpeciesIndexNet.setup-336"><span class="linenos">336</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">species_order</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="SpeciesIndexNet.setup-337"><a href="#SpeciesIndexNet.setup-337"><span class="linenos">337</span></a>            <span class="p">),</span> <span class="s2">&quot;species_order must be provided if hidden_neurons is not a dictionary&quot;</span>
</span><span id="SpeciesIndexNet.setup-338"><a href="#SpeciesIndexNet.setup-338"><span class="linenos">338</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_order</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="SpeciesIndexNet.setup-339"><a href="#SpeciesIndexNet.setup-339"><span class="linenos">339</span></a>                <span class="n">species_order</span> <span class="o">=</span> <span class="p">[</span><span class="n">el</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_order</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>
</span><span id="SpeciesIndexNet.setup-340"><a href="#SpeciesIndexNet.setup-340"><span class="linenos">340</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SpeciesIndexNet.setup-341"><a href="#SpeciesIndexNet.setup-341"><span class="linenos">341</span></a>                <span class="n">species_order</span> <span class="o">=</span> <span class="p">[</span><span class="n">el</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_order</span><span class="p">]</span>
</span><span id="SpeciesIndexNet.setup-342"><a href="#SpeciesIndexNet.setup-342"><span class="linenos">342</span></a>            <span class="n">neurons</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_neurons</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">species_order</span><span class="p">}</span>
</span><span id="SpeciesIndexNet.setup-343"><a href="#SpeciesIndexNet.setup-343"><span class="linenos">343</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SpeciesIndexNet.setup-344"><a href="#SpeciesIndexNet.setup-344"><span class="linenos">344</span></a>            <span class="n">neurons</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_neurons</span>
</span><span id="SpeciesIndexNet.setup-345"><a href="#SpeciesIndexNet.setup-345"><span class="linenos">345</span></a>            <span class="n">species_order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">neurons</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="SpeciesIndexNet.setup-346"><a href="#SpeciesIndexNet.setup-346"><span class="linenos">346</span></a>        <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="n">species_order</span><span class="p">:</span>
</span><span id="SpeciesIndexNet.setup-347"><a href="#SpeciesIndexNet.setup-347"><span class="linenos">347</span></a>            <span class="k">assert</span> <span class="p">(</span>
</span><span id="SpeciesIndexNet.setup-348"><a href="#SpeciesIndexNet.setup-348"><span class="linenos">348</span></a>                <span class="n">species</span> <span class="ow">in</span> <span class="n">PERIODIC_TABLE</span>
</span><span id="SpeciesIndexNet.setup-349"><a href="#SpeciesIndexNet.setup-349"><span class="linenos">349</span></a>            <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;species </span><span class="si">{</span><span class="n">species</span><span class="si">}</span><span class="s2"> not found in periodic table&quot;</span>
</span><span id="SpeciesIndexNet.setup-350"><a href="#SpeciesIndexNet.setup-350"><span class="linenos">350</span></a>
</span><span id="SpeciesIndexNet.setup-351"><a href="#SpeciesIndexNet.setup-351"><span class="linenos">351</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">networks</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="SpeciesIndexNet.setup-352"><a href="#SpeciesIndexNet.setup-352"><span class="linenos">352</span></a>            <span class="n">k</span><span class="p">:</span> <span class="n">FullyConnectedNet</span><span class="p">(</span>
</span><span id="SpeciesIndexNet.setup-353"><a href="#SpeciesIndexNet.setup-353"><span class="linenos">353</span></a>                <span class="p">[</span><span class="o">*</span><span class="n">neurons</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dim</span><span class="p">],</span>
</span><span id="SpeciesIndexNet.setup-354"><a href="#SpeciesIndexNet.setup-354"><span class="linenos">354</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">,</span>
</span><span id="SpeciesIndexNet.setup-355"><a href="#SpeciesIndexNet.setup-355"><span class="linenos">355</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">use_bias</span><span class="p">,</span>
</span><span id="SpeciesIndexNet.setup-356"><a href="#SpeciesIndexNet.setup-356"><span class="linenos">356</span></a>                <span class="n">name</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
</span><span id="SpeciesIndexNet.setup-357"><a href="#SpeciesIndexNet.setup-357"><span class="linenos">357</span></a>                <span class="n">kernel_init</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_init</span><span class="p">,</span>
</span><span id="SpeciesIndexNet.setup-358"><a href="#SpeciesIndexNet.setup-358"><span class="linenos">358</span></a>            <span class="p">)</span>
</span><span id="SpeciesIndexNet.setup-359"><a href="#SpeciesIndexNet.setup-359"><span class="linenos">359</span></a>            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">species_order</span>
</span><span id="SpeciesIndexNet.setup-360"><a href="#SpeciesIndexNet.setup-360"><span class="linenos">360</span></a>        <span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>Initializes a Module lazily (similar to a lazy <code><a href="#SpeciesIndexNet.__init__">__init__</a></code>).</p>

<p><code><a href="#SpeciesIndexNet.setup">setup</a></code> is called once lazily on a module instance when a module
is bound, immediately before any other methods like <code>__call__</code> are
invoked, or before a <code><a href="#SpeciesIndexNet.setup">setup</a></code>-defined attribute on <code>self</code> is accessed.</p>

<p>This can happen in three cases:</p>

<ol>
<li><p>Immediately when invoking <code><a href="#SpeciesIndexNet.apply">apply()</a></code>, <code><a href="#SpeciesIndexNet.init">init()</a></code> or
 <code>init_and_output()</code>.</p></li>
<li><p>Once the module is given a name by being assigned to an attribute of
 another module inside the other module's <code><a href="#SpeciesIndexNet.setup">setup</a></code> method
 (see <code>__setattr__()</code>)::</p>

<pre><code>&gt;&gt;&gt; class MyModule(nn.Module):
...   def setup(self):
...     submodule = nn.Conv(...)

...     # Accessing `submodule` attributes does not yet work here.

...     # The following line invokes `self.__setattr__`, which gives
...     # `submodule` the name "conv1".
...     self.conv1 = submodule

...     # Accessing `submodule` attributes or methods is now safe and
...     # either causes setup() to be called once.
</code></pre></li>
<li><p>Once a module is constructed inside a method wrapped with
 <code>compact()</code>, immediately before another method is called or
 <code><a href="#SpeciesIndexNet.setup">setup</a></code> defined attribute is accessed.</p></li>
</ol>
</div>


                            </div>
                            <div id="SpeciesIndexNet.parent" class="classattr">
                                <div class="attr variable">
            <span class="name">parent</span><span class="annotation">: Union[Type[flax.linen.module.Module], flax.core.scope.Scope, Type[flax.linen.module._Sentinel], NoneType]</span>

        
    </div>
    <a class="headerlink" href="#SpeciesIndexNet.parent"></a>
    
            <div class="docstring"><p>Wraps parent module references in weak refs.</p>

<p>This prevents reference cycles from forming via parent links which can lead
to accidental OOMs in eager mode due to slow garbage collection as well as
spurious tracer leaks during jit compilation.</p>

<p>Note: "descriptors" are the underlying python mechanism for implementing
dynamic @property decorators.  We need to use a raw descriptor instead of the
more common decorator in order to force that the appropriate getter/setter
logic applies in subclasses even after various dataclass transforms.</p>
</div>


                            </div>
                            <div id="SpeciesIndexNet.name" class="classattr">
                                <div class="attr variable">
            <span class="name">name</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#SpeciesIndexNet.name"></a>
    
    

                            </div>
                            <div id="SpeciesIndexNet.scope" class="classattr">
                                <div class="attr variable">
            <span class="name">scope</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#SpeciesIndexNet.scope"></a>
    
    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>flax.linen.module.Module</dt>
                                <dd id="SpeciesIndexNet.path" class="variable">path</dd>
                <dd id="SpeciesIndexNet.clone" class="function">clone</dd>
                <dd id="SpeciesIndexNet.copy" class="function">copy</dd>
                <dd id="SpeciesIndexNet.variable" class="function">variable</dd>
                <dd id="SpeciesIndexNet.param" class="function">param</dd>
                <dd id="SpeciesIndexNet.has_variable" class="function">has_variable</dd>
                <dd id="SpeciesIndexNet.is_mutable_collection" class="function">is_mutable_collection</dd>
                <dd id="SpeciesIndexNet.has_rng" class="function">has_rng</dd>
                <dd id="SpeciesIndexNet.make_rng" class="function">make_rng</dd>
                <dd id="SpeciesIndexNet.is_initializing" class="function">is_initializing</dd>
                <dd id="SpeciesIndexNet.bind" class="function">bind</dd>
                <dd id="SpeciesIndexNet.unbind" class="function">unbind</dd>
                <dd id="SpeciesIndexNet.apply" class="function">apply</dd>
                <dd id="SpeciesIndexNet.init_with_output" class="function">init_with_output</dd>
                <dd id="SpeciesIndexNet.init" class="function">init</dd>
                <dd id="SpeciesIndexNet.lazy_init" class="function">lazy_init</dd>
                <dd id="SpeciesIndexNet.variables" class="variable">variables</dd>
                <dd id="SpeciesIndexNet.get_variable" class="function">get_variable</dd>
                <dd id="SpeciesIndexNet.put_variable" class="function">put_variable</dd>
                <dd id="SpeciesIndexNet.sow" class="function">sow</dd>
                <dd id="SpeciesIndexNet.perturb" class="function">perturb</dd>
                <dd id="SpeciesIndexNet.tabulate" class="function">tabulate</dd>
                <dd id="SpeciesIndexNet.module_paths" class="function">module_paths</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="ChemicalNet">
                            <input id="ChemicalNet-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">ChemicalNet</span><wbr>(<span class="base">flax.linen.module.Module</span>):

                <label class="view-source-button" for="ChemicalNet-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ChemicalNet"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ChemicalNet-415"><a href="#ChemicalNet-415"><span class="linenos">415</span></a><span class="k">class</span> <span class="nc">ChemicalNet</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="ChemicalNet-416"><a href="#ChemicalNet-416"><span class="linenos">416</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;optimized Chemical-species-specific neural network.</span>
</span><span id="ChemicalNet-417"><a href="#ChemicalNet-417"><span class="linenos">417</span></a>
</span><span id="ChemicalNet-418"><a href="#ChemicalNet-418"><span class="linenos">418</span></a><span class="sd">    A neural network that applies a fully connected network to each atom embedding in a chemical system and selects the output corresponding to the atom&#39;s species.</span>
</span><span id="ChemicalNet-419"><a href="#ChemicalNet-419"><span class="linenos">419</span></a><span class="sd">    This is an optimized version of ChemicalNetHet that uses vmap to apply the networks to all atoms at once.</span>
</span><span id="ChemicalNet-420"><a href="#ChemicalNet-420"><span class="linenos">420</span></a><span class="sd">    The optimization is allowed because all networks have the same shape.</span>
</span><span id="ChemicalNet-421"><a href="#ChemicalNet-421"><span class="linenos">421</span></a>
</span><span id="ChemicalNet-422"><a href="#ChemicalNet-422"><span class="linenos">422</span></a><span class="sd">    Parameters:</span>
</span><span id="ChemicalNet-423"><a href="#ChemicalNet-423"><span class="linenos">423</span></a><span class="sd">        species_order (Sequence[str]): The species for which to build a network.</span>
</span><span id="ChemicalNet-424"><a href="#ChemicalNet-424"><span class="linenos">424</span></a><span class="sd">        neurons (Sequence[int]): The dimensions of the fully connected networks.</span>
</span><span id="ChemicalNet-425"><a href="#ChemicalNet-425"><span class="linenos">425</span></a><span class="sd">        activation (Callable, optional): The activation function to use in the fully connected networks. Defaults to nn.silu.</span>
</span><span id="ChemicalNet-426"><a href="#ChemicalNet-426"><span class="linenos">426</span></a><span class="sd">        use_bias (bool, optional): Whether to include bias terms in the fully connected networks. Defaults to True.</span>
</span><span id="ChemicalNet-427"><a href="#ChemicalNet-427"><span class="linenos">427</span></a><span class="sd">        input_key (str, optional): The key in the input dictionary that corresponds to the embeddings of the atoms.</span>
</span><span id="ChemicalNet-428"><a href="#ChemicalNet-428"><span class="linenos">428</span></a><span class="sd">            If None, the input is assumed to be a tuple (species,embeddings). Defaults to None.</span>
</span><span id="ChemicalNet-429"><a href="#ChemicalNet-429"><span class="linenos">429</span></a><span class="sd">        output_key (str, optional): The key in the output dictionary that corresponds to the network&#39;s output.</span>
</span><span id="ChemicalNet-430"><a href="#ChemicalNet-430"><span class="linenos">430</span></a><span class="sd">            If None, the output is returned directly. Defaults to None.</span>
</span><span id="ChemicalNet-431"><a href="#ChemicalNet-431"><span class="linenos">431</span></a><span class="sd">        squeeze (bool, optional): Whether to squeeze the output if it has shape (batch_size, 1). Defaults to False.</span>
</span><span id="ChemicalNet-432"><a href="#ChemicalNet-432"><span class="linenos">432</span></a><span class="sd">        kernel_init (Union[str, Callable], optional): The kernel initialization method for the fully connected networks. Defaults to nn.linear.default_kernel_init.</span>
</span><span id="ChemicalNet-433"><a href="#ChemicalNet-433"><span class="linenos">433</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="ChemicalNet-434"><a href="#ChemicalNet-434"><span class="linenos">434</span></a>
</span><span id="ChemicalNet-435"><a href="#ChemicalNet-435"><span class="linenos">435</span></a>    <span class="n">species_order</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span><span id="ChemicalNet-436"><a href="#ChemicalNet-436"><span class="linenos">436</span></a>    <span class="n">neurons</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
</span><span id="ChemicalNet-437"><a href="#ChemicalNet-437"><span class="linenos">437</span></a>    <span class="n">activation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">silu</span>
</span><span id="ChemicalNet-438"><a href="#ChemicalNet-438"><span class="linenos">438</span></a>    <span class="n">use_bias</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ChemicalNet-439"><a href="#ChemicalNet-439"><span class="linenos">439</span></a>    <span class="n">input_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ChemicalNet-440"><a href="#ChemicalNet-440"><span class="linenos">440</span></a>    <span class="n">output_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ChemicalNet-441"><a href="#ChemicalNet-441"><span class="linenos">441</span></a>    <span class="n">squeeze</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ChemicalNet-442"><a href="#ChemicalNet-442"><span class="linenos">442</span></a>    <span class="n">kernel_init</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">default_kernel_init</span>
</span><span id="ChemicalNet-443"><a href="#ChemicalNet-443"><span class="linenos">443</span></a>
</span><span id="ChemicalNet-444"><a href="#ChemicalNet-444"><span class="linenos">444</span></a>    <span class="n">FID</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;CHEMICAL_NET&quot;</span>
</span><span id="ChemicalNet-445"><a href="#ChemicalNet-445"><span class="linenos">445</span></a>
</span><span id="ChemicalNet-446"><a href="#ChemicalNet-446"><span class="linenos">446</span></a>    <span class="nd">@nn</span><span class="o">.</span><span class="n">compact</span>
</span><span id="ChemicalNet-447"><a href="#ChemicalNet-447"><span class="linenos">447</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span>
</span><span id="ChemicalNet-448"><a href="#ChemicalNet-448"><span class="linenos">448</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">]]</span>
</span><span id="ChemicalNet-449"><a href="#ChemicalNet-449"><span class="linenos">449</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">]:</span>
</span><span id="ChemicalNet-450"><a href="#ChemicalNet-450"><span class="linenos">450</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ChemicalNet-451"><a href="#ChemicalNet-451"><span class="linenos">451</span></a>            <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
</span><span id="ChemicalNet-452"><a href="#ChemicalNet-452"><span class="linenos">452</span></a>                <span class="n">inputs</span><span class="p">,</span> <span class="nb">dict</span>
</span><span id="ChemicalNet-453"><a href="#ChemicalNet-453"><span class="linenos">453</span></a>            <span class="p">),</span> <span class="s2">&quot;input key must be provided if inputs is a dictionary&quot;</span>
</span><span id="ChemicalNet-454"><a href="#ChemicalNet-454"><span class="linenos">454</span></a>            <span class="n">species</span><span class="p">,</span> <span class="n">embedding</span> <span class="o">=</span> <span class="n">inputs</span>
</span><span id="ChemicalNet-455"><a href="#ChemicalNet-455"><span class="linenos">455</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ChemicalNet-456"><a href="#ChemicalNet-456"><span class="linenos">456</span></a>            <span class="n">species</span><span class="p">,</span> <span class="n">embedding</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">],</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">input_key</span><span class="p">]</span>
</span><span id="ChemicalNet-457"><a href="#ChemicalNet-457"><span class="linenos">457</span></a>
</span><span id="ChemicalNet-458"><a href="#ChemicalNet-458"><span class="linenos">458</span></a>        <span class="c1">############################</span>
</span><span id="ChemicalNet-459"><a href="#ChemicalNet-459"><span class="linenos">459</span></a>        <span class="c1"># build species to network index mapping (static =&gt; fixed when jitted)</span>
</span><span id="ChemicalNet-460"><a href="#ChemicalNet-460"><span class="linenos">460</span></a>        <span class="n">rev_idx</span> <span class="o">=</span> <span class="n">PERIODIC_TABLE_REV_IDX</span>
</span><span id="ChemicalNet-461"><a href="#ChemicalNet-461"><span class="linenos">461</span></a>        <span class="n">maxidx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">rev_idx</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span><span id="ChemicalNet-462"><a href="#ChemicalNet-462"><span class="linenos">462</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_order</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="ChemicalNet-463"><a href="#ChemicalNet-463"><span class="linenos">463</span></a>            <span class="n">species_order</span> <span class="o">=</span> <span class="p">[</span><span class="n">el</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_order</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>
</span><span id="ChemicalNet-464"><a href="#ChemicalNet-464"><span class="linenos">464</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ChemicalNet-465"><a href="#ChemicalNet-465"><span class="linenos">465</span></a>            <span class="n">species_order</span> <span class="o">=</span> <span class="p">[</span><span class="n">el</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_order</span><span class="p">]</span>
</span><span id="ChemicalNet-466"><a href="#ChemicalNet-466"><span class="linenos">466</span></a>        <span class="n">nspecies</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">species_order</span><span class="p">)</span>
</span><span id="ChemicalNet-467"><a href="#ChemicalNet-467"><span class="linenos">467</span></a>        <span class="n">conv_tensor_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">maxidx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="ChemicalNet-468"><a href="#ChemicalNet-468"><span class="linenos">468</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">species_order</span><span class="p">):</span>
</span><span id="ChemicalNet-469"><a href="#ChemicalNet-469"><span class="linenos">469</span></a>            <span class="n">conv_tensor_</span><span class="p">[</span><span class="n">rev_idx</span><span class="p">[</span><span class="n">s</span><span class="p">]]</span> <span class="o">=</span> <span class="n">i</span>
</span><span id="ChemicalNet-470"><a href="#ChemicalNet-470"><span class="linenos">470</span></a>        <span class="n">conv_tensor</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">conv_tensor_</span><span class="p">)</span>
</span><span id="ChemicalNet-471"><a href="#ChemicalNet-471"><span class="linenos">471</span></a>        <span class="n">indices</span> <span class="o">=</span> <span class="n">conv_tensor</span><span class="p">[</span><span class="n">species</span><span class="p">]</span>
</span><span id="ChemicalNet-472"><a href="#ChemicalNet-472"><span class="linenos">472</span></a>
</span><span id="ChemicalNet-473"><a href="#ChemicalNet-473"><span class="linenos">473</span></a>        <span class="c1">############################</span>
</span><span id="ChemicalNet-474"><a href="#ChemicalNet-474"><span class="linenos">474</span></a>        <span class="c1"># build shape-sharing networks using vmap</span>
</span><span id="ChemicalNet-475"><a href="#ChemicalNet-475"><span class="linenos">475</span></a>        <span class="n">networks</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span>
</span><span id="ChemicalNet-476"><a href="#ChemicalNet-476"><span class="linenos">476</span></a>            <span class="n">FullyConnectedNet</span><span class="p">,</span>
</span><span id="ChemicalNet-477"><a href="#ChemicalNet-477"><span class="linenos">477</span></a>            <span class="n">variable_axes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
</span><span id="ChemicalNet-478"><a href="#ChemicalNet-478"><span class="linenos">478</span></a>            <span class="n">split_rngs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
</span><span id="ChemicalNet-479"><a href="#ChemicalNet-479"><span class="linenos">479</span></a>            <span class="n">in_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="ChemicalNet-480"><a href="#ChemicalNet-480"><span class="linenos">480</span></a>        <span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">neurons</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_bias</span><span class="p">,</span> <span class="n">kernel_init</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_init</span><span class="p">)</span>
</span><span id="ChemicalNet-481"><a href="#ChemicalNet-481"><span class="linenos">481</span></a>        <span class="c1"># repeat input along a new axis to compute for all species at once</span>
</span><span id="ChemicalNet-482"><a href="#ChemicalNet-482"><span class="linenos">482</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span>
</span><span id="ChemicalNet-483"><a href="#ChemicalNet-483"><span class="linenos">483</span></a>            <span class="n">embedding</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="p">(</span><span class="n">nspecies</span><span class="p">,</span> <span class="o">*</span><span class="n">embedding</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="ChemicalNet-484"><a href="#ChemicalNet-484"><span class="linenos">484</span></a>        <span class="p">)</span>
</span><span id="ChemicalNet-485"><a href="#ChemicalNet-485"><span class="linenos">485</span></a>
</span><span id="ChemicalNet-486"><a href="#ChemicalNet-486"><span class="linenos">486</span></a>        <span class="c1"># apply networks to input and select the output corresponding to the species</span>
</span><span id="ChemicalNet-487"><a href="#ChemicalNet-487"><span class="linenos">487</span></a>        <span class="n">out</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span>
</span><span id="ChemicalNet-488"><a href="#ChemicalNet-488"><span class="linenos">488</span></a>            <span class="n">jnp</span><span class="o">.</span><span class="n">take_along_axis</span><span class="p">(</span><span class="n">networks</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">indices</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
</span><span id="ChemicalNet-489"><a href="#ChemicalNet-489"><span class="linenos">489</span></a>        <span class="p">)</span>
</span><span id="ChemicalNet-490"><a href="#ChemicalNet-490"><span class="linenos">490</span></a>
</span><span id="ChemicalNet-491"><a href="#ChemicalNet-491"><span class="linenos">491</span></a>        <span class="n">out</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">indices</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">out</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
</span><span id="ChemicalNet-492"><a href="#ChemicalNet-492"><span class="linenos">492</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">squeeze</span> <span class="ow">and</span> <span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ChemicalNet-493"><a href="#ChemicalNet-493"><span class="linenos">493</span></a>            <span class="n">out</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="ChemicalNet-494"><a href="#ChemicalNet-494"><span class="linenos">494</span></a>        <span class="c1">############################</span>
</span><span id="ChemicalNet-495"><a href="#ChemicalNet-495"><span class="linenos">495</span></a>
</span><span id="ChemicalNet-496"><a href="#ChemicalNet-496"><span class="linenos">496</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ChemicalNet-497"><a href="#ChemicalNet-497"><span class="linenos">497</span></a>            <span class="n">output_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_key</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_key</span>
</span><span id="ChemicalNet-498"><a href="#ChemicalNet-498"><span class="linenos">498</span></a>            <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="n">output_key</span><span class="p">:</span> <span class="n">out</span><span class="p">}</span> <span class="k">if</span> <span class="n">output_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">out</span>
</span><span id="ChemicalNet-499"><a href="#ChemicalNet-499"><span class="linenos">499</span></a>        <span class="k">return</span> <span class="n">out</span>
</span></pre></div>


            <div class="docstring"><p>optimized Chemical-species-specific neural network.</p>

<p>A neural network that applies a fully connected network to each atom embedding in a chemical system and selects the output corresponding to the atom's species.
This is an optimized version of ChemicalNetHet that uses vmap to apply the networks to all atoms at once.
The optimization is allowed because all networks have the same shape.</p>

<p>Parameters:
    species_order (Sequence[str]): The species for which to build a network.
    neurons (Sequence[int]): The dimensions of the fully connected networks.
    activation (Callable, optional): The activation function to use in the fully connected networks. Defaults to nn.silu.
    use_bias (bool, optional): Whether to include bias terms in the fully connected networks. Defaults to True.
    input_key (str, optional): The key in the input dictionary that corresponds to the embeddings of the atoms.
        If None, the input is assumed to be a tuple (species,embeddings). Defaults to None.
    output_key (str, optional): The key in the output dictionary that corresponds to the network's output.
        If None, the output is returned directly. Defaults to None.
    squeeze (bool, optional): Whether to squeeze the output if it has shape (batch_size, 1). Defaults to False.
    kernel_init (Union[str, Callable], optional): The kernel initialization method for the fully connected networks. Defaults to nn.linear.default_kernel_init.</p>
</div>


                            <div id="ChemicalNet.__init__" class="classattr">
                                <div class="attr function">
            
        <span class="name">ChemicalNet</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">species_order</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>,</span><span class="param">	<span class="n">neurons</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>,</span><span class="param">	<span class="n">activation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">PjitFunction</span> <span class="n">of</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">silu</span><span class="o">&gt;&gt;</span>,</span><span class="param">	<span class="n">use_bias</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">input_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">output_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">squeeze</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">kernel_init</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">variance_scaling</span><span class="o">.&lt;</span><span class="nb">locals</span><span class="o">&gt;.</span><span class="n">init</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">FID</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;CHEMICAL_NET&#39;</span>,</span><span class="param">	<span class="n">parent</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">flax</span><span class="o">.</span><span class="n">linen</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">Module</span><span class="p">],</span> <span class="n">flax</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">Scope</span><span class="p">,</span> <span class="n">Type</span><span class="p">[</span><span class="n">flax</span><span class="o">.</span><span class="n">linen</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">_Sentinel</span><span class="p">],</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">flax</span><span class="o">.</span><span class="n">linen</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">_Sentinel</span> <span class="nb">object</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

        
    </div>
    <a class="headerlink" href="#ChemicalNet.__init__"></a>
    
    

                            </div>
                            <div id="ChemicalNet.species_order" class="classattr">
                                <div class="attr variable">
            <span class="name">species_order</span><span class="annotation">: Union[str, Sequence[str]]</span>

        
    </div>
    <a class="headerlink" href="#ChemicalNet.species_order"></a>
    
    

                            </div>
                            <div id="ChemicalNet.neurons" class="classattr">
                                <div class="attr variable">
            <span class="name">neurons</span><span class="annotation">: Sequence[int]</span>

        
    </div>
    <a class="headerlink" href="#ChemicalNet.neurons"></a>
    
    

                            </div>
                            <div id="ChemicalNet.activation" class="classattr">
                                        <input id="ChemicalNet.activation-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@jax.jit</div>

        <span class="def">def</span>
        <span class="name">activation</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">x</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">bool_</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span>:</span></span>

                <label class="view-source-button" for="ChemicalNet.activation-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ChemicalNet.activation"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ChemicalNet.activation-151"><a href="#ChemicalNet.activation-151"><span class="linenos">151</span></a><span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
</span><span id="ChemicalNet.activation-152"><a href="#ChemicalNet.activation-152"><span class="linenos">152</span></a><span class="k">def</span> <span class="nf">silu</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="p">:</span>
</span><span id="ChemicalNet.activation-153"><a href="#ChemicalNet.activation-153"><span class="linenos">153</span></a><span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;SiLU (a.k.a. swish) activation function.</span>
</span><span id="ChemicalNet.activation-154"><a href="#ChemicalNet.activation-154"><span class="linenos">154</span></a>
</span><span id="ChemicalNet.activation-155"><a href="#ChemicalNet.activation-155"><span class="linenos">155</span></a><span class="sd">  Computes the element-wise function:</span>
</span><span id="ChemicalNet.activation-156"><a href="#ChemicalNet.activation-156"><span class="linenos">156</span></a>
</span><span id="ChemicalNet.activation-157"><a href="#ChemicalNet.activation-157"><span class="linenos">157</span></a><span class="sd">  .. math::</span>
</span><span id="ChemicalNet.activation-158"><a href="#ChemicalNet.activation-158"><span class="linenos">158</span></a><span class="sd">    \mathrm{silu}(x) = x \cdot \mathrm{sigmoid}(x) = \frac{x}{1 + e^{-x}}</span>
</span><span id="ChemicalNet.activation-159"><a href="#ChemicalNet.activation-159"><span class="linenos">159</span></a>
</span><span id="ChemicalNet.activation-160"><a href="#ChemicalNet.activation-160"><span class="linenos">160</span></a><span class="sd">  :func:`swish` and :func:`silu` are both aliases for the same function.</span>
</span><span id="ChemicalNet.activation-161"><a href="#ChemicalNet.activation-161"><span class="linenos">161</span></a>
</span><span id="ChemicalNet.activation-162"><a href="#ChemicalNet.activation-162"><span class="linenos">162</span></a><span class="sd">  Args:</span>
</span><span id="ChemicalNet.activation-163"><a href="#ChemicalNet.activation-163"><span class="linenos">163</span></a><span class="sd">    x : input array</span>
</span><span id="ChemicalNet.activation-164"><a href="#ChemicalNet.activation-164"><span class="linenos">164</span></a>
</span><span id="ChemicalNet.activation-165"><a href="#ChemicalNet.activation-165"><span class="linenos">165</span></a><span class="sd">  Returns:</span>
</span><span id="ChemicalNet.activation-166"><a href="#ChemicalNet.activation-166"><span class="linenos">166</span></a><span class="sd">    An array.</span>
</span><span id="ChemicalNet.activation-167"><a href="#ChemicalNet.activation-167"><span class="linenos">167</span></a>
</span><span id="ChemicalNet.activation-168"><a href="#ChemicalNet.activation-168"><span class="linenos">168</span></a><span class="sd">  See also:</span>
</span><span id="ChemicalNet.activation-169"><a href="#ChemicalNet.activation-169"><span class="linenos">169</span></a><span class="sd">    :func:`sigmoid`</span>
</span><span id="ChemicalNet.activation-170"><a href="#ChemicalNet.activation-170"><span class="linenos">170</span></a><span class="sd">  &quot;&quot;&quot;</span>
</span><span id="ChemicalNet.activation-171"><a href="#ChemicalNet.activation-171"><span class="linenos">171</span></a>  <span class="n">numpy_util</span><span class="o">.</span><span class="n">check_arraylike</span><span class="p">(</span><span class="s2">&quot;silu&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span><span id="ChemicalNet.activation-172"><a href="#ChemicalNet.activation-172"><span class="linenos">172</span></a>  <span class="n">x_arr</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="ChemicalNet.activation-173"><a href="#ChemicalNet.activation-173"><span class="linenos">173</span></a>  <span class="k">return</span> <span class="n">x_arr</span> <span class="o">*</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">x_arr</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>SiLU (a.k.a. swish) activation function.</p>

<p>Computes the element-wise function:</p>

<p>$$\mathrm{silu}(x) = x \cdot \mathrm{sigmoid}(x) = \frac{x}{1 + e^{-x}}$$</p>

<p><code>swish()</code> and <code>silu()</code> are both aliases for the same function.</p>

<p>Args:
  x : input array</p>

<p>Returns:
  An array.</p>

<p>See also:
  <code>sigmoid()</code></p>
</div>


                            </div>
                            <div id="ChemicalNet.use_bias" class="classattr">
                                <div class="attr variable">
            <span class="name">use_bias</span><span class="annotation">: bool</span>        =
<span class="default_value">True</span>

        
    </div>
    <a class="headerlink" href="#ChemicalNet.use_bias"></a>
    
    

                            </div>
                            <div id="ChemicalNet.input_key" class="classattr">
                                <div class="attr variable">
            <span class="name">input_key</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ChemicalNet.input_key"></a>
    
    

                            </div>
                            <div id="ChemicalNet.output_key" class="classattr">
                                <div class="attr variable">
            <span class="name">output_key</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ChemicalNet.output_key"></a>
    
    

                            </div>
                            <div id="ChemicalNet.squeeze" class="classattr">
                                <div class="attr variable">
            <span class="name">squeeze</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ChemicalNet.squeeze"></a>
    
    

                            </div>
                            <div id="ChemicalNet.kernel_init" class="classattr">
                                        <input id="ChemicalNet.kernel_init-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">kernel_init</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">key</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span>,</span><span class="param">	<span class="n">shape</span><span class="p">:</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]]</span>,</span><span class="param">	dtype: Any = &lt;class &#x27;jax.numpy.float64&#x27;&gt;</span><span class="return-annotation">) -> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span>:</span></span>

                <label class="view-source-button" for="ChemicalNet.kernel_init-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ChemicalNet.kernel_init"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ChemicalNet.kernel_init-317"><a href="#ChemicalNet.kernel_init-317"><span class="linenos">317</span></a>  <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">KeyArray</span><span class="p">,</span>
</span><span id="ChemicalNet.kernel_init-318"><a href="#ChemicalNet.kernel_init-318"><span class="linenos">318</span></a>           <span class="n">shape</span><span class="p">:</span> <span class="n">core</span><span class="o">.</span><span class="n">Shape</span><span class="p">,</span>
</span><span id="ChemicalNet.kernel_init-319"><a href="#ChemicalNet.kernel_init-319"><span class="linenos">319</span></a>           <span class="n">dtype</span><span class="p">:</span> <span class="n">DTypeLikeInexact</span> <span class="o">=</span> <span class="n">dtype</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="p">:</span>
</span><span id="ChemicalNet.kernel_init-320"><a href="#ChemicalNet.kernel_init-320"><span class="linenos">320</span></a>    <span class="n">dtype</span> <span class="o">=</span> <span class="n">dtypes</span><span class="o">.</span><span class="n">canonicalize_dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="ChemicalNet.kernel_init-321"><a href="#ChemicalNet.kernel_init-321"><span class="linenos">321</span></a>    <span class="n">named_shape</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">as_named_shape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
</span><span id="ChemicalNet.kernel_init-322"><a href="#ChemicalNet.kernel_init-322"><span class="linenos">322</span></a>    <span class="n">fan_in</span><span class="p">,</span> <span class="n">fan_out</span> <span class="o">=</span> <span class="n">_compute_fans</span><span class="p">(</span><span class="n">named_shape</span><span class="p">,</span> <span class="n">in_axis</span><span class="p">,</span> <span class="n">out_axis</span><span class="p">,</span> <span class="n">batch_axis</span><span class="p">)</span>
</span><span id="ChemicalNet.kernel_init-323"><a href="#ChemicalNet.kernel_init-323"><span class="linenos">323</span></a>    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;fan_in&quot;</span><span class="p">:</span> <span class="n">denominator</span> <span class="o">=</span> <span class="n">fan_in</span>
</span><span id="ChemicalNet.kernel_init-324"><a href="#ChemicalNet.kernel_init-324"><span class="linenos">324</span></a>    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;fan_out&quot;</span><span class="p">:</span> <span class="n">denominator</span> <span class="o">=</span> <span class="n">fan_out</span>
</span><span id="ChemicalNet.kernel_init-325"><a href="#ChemicalNet.kernel_init-325"><span class="linenos">325</span></a>    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;fan_avg&quot;</span><span class="p">:</span> <span class="n">denominator</span> <span class="o">=</span> <span class="p">(</span><span class="n">fan_in</span> <span class="o">+</span> <span class="n">fan_out</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="ChemicalNet.kernel_init-326"><a href="#ChemicalNet.kernel_init-326"><span class="linenos">326</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="ChemicalNet.kernel_init-327"><a href="#ChemicalNet.kernel_init-327"><span class="linenos">327</span></a>      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="ChemicalNet.kernel_init-328"><a href="#ChemicalNet.kernel_init-328"><span class="linenos">328</span></a>        <span class="sa">f</span><span class="s2">&quot;invalid mode for variance scaling initializer: </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ChemicalNet.kernel_init-329"><a href="#ChemicalNet.kernel_init-329"><span class="linenos">329</span></a>    <span class="n">variance</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">scale</span> <span class="o">/</span> <span class="n">denominator</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="ChemicalNet.kernel_init-330"><a href="#ChemicalNet.kernel_init-330"><span class="linenos">330</span></a>
</span><span id="ChemicalNet.kernel_init-331"><a href="#ChemicalNet.kernel_init-331"><span class="linenos">331</span></a>    <span class="k">if</span> <span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;truncated_normal&quot;</span><span class="p">:</span>
</span><span id="ChemicalNet.kernel_init-332"><a href="#ChemicalNet.kernel_init-332"><span class="linenos">332</span></a>      <span class="k">if</span> <span class="n">jnp</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">floating</span><span class="p">):</span>
</span><span id="ChemicalNet.kernel_init-333"><a href="#ChemicalNet.kernel_init-333"><span class="linenos">333</span></a>        <span class="c1"># constant is stddev of standard normal truncated to (-2, 2)</span>
</span><span id="ChemicalNet.kernel_init-334"><a href="#ChemicalNet.kernel_init-334"><span class="linenos">334</span></a>        <span class="n">stddev</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">.87962566103423978</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
</span><span id="ChemicalNet.kernel_init-335"><a href="#ChemicalNet.kernel_init-335"><span class="linenos">335</span></a>        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">truncated_normal</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">named_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="n">stddev</span>
</span><span id="ChemicalNet.kernel_init-336"><a href="#ChemicalNet.kernel_init-336"><span class="linenos">336</span></a>      <span class="k">else</span><span class="p">:</span>
</span><span id="ChemicalNet.kernel_init-337"><a href="#ChemicalNet.kernel_init-337"><span class="linenos">337</span></a>        <span class="c1"># constant is stddev of complex standard normal truncated to 2</span>
</span><span id="ChemicalNet.kernel_init-338"><a href="#ChemicalNet.kernel_init-338"><span class="linenos">338</span></a>        <span class="n">stddev</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">.95311164380491208</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
</span><span id="ChemicalNet.kernel_init-339"><a href="#ChemicalNet.kernel_init-339"><span class="linenos">339</span></a>        <span class="k">return</span> <span class="n">_complex_truncated_normal</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">named_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="n">stddev</span>
</span><span id="ChemicalNet.kernel_init-340"><a href="#ChemicalNet.kernel_init-340"><span class="linenos">340</span></a>    <span class="k">elif</span> <span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;normal&quot;</span><span class="p">:</span>
</span><span id="ChemicalNet.kernel_init-341"><a href="#ChemicalNet.kernel_init-341"><span class="linenos">341</span></a>      <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">named_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span>
</span><span id="ChemicalNet.kernel_init-342"><a href="#ChemicalNet.kernel_init-342"><span class="linenos">342</span></a>    <span class="k">elif</span> <span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;uniform&quot;</span><span class="p">:</span>
</span><span id="ChemicalNet.kernel_init-343"><a href="#ChemicalNet.kernel_init-343"><span class="linenos">343</span></a>      <span class="k">if</span> <span class="n">jnp</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">floating</span><span class="p">):</span>
</span><span id="ChemicalNet.kernel_init-344"><a href="#ChemicalNet.kernel_init-344"><span class="linenos">344</span></a>        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">named_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">variance</span><span class="p">)</span>
</span><span id="ChemicalNet.kernel_init-345"><a href="#ChemicalNet.kernel_init-345"><span class="linenos">345</span></a>      <span class="k">else</span><span class="p">:</span>
</span><span id="ChemicalNet.kernel_init-346"><a href="#ChemicalNet.kernel_init-346"><span class="linenos">346</span></a>        <span class="k">return</span> <span class="n">_complex_uniform</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">named_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span>
</span><span id="ChemicalNet.kernel_init-347"><a href="#ChemicalNet.kernel_init-347"><span class="linenos">347</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="ChemicalNet.kernel_init-348"><a href="#ChemicalNet.kernel_init-348"><span class="linenos">348</span></a>      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;invalid distribution for variance scaling initializer: </span><span class="si">{</span><span class="n">distribution</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="ChemicalNet.FID" class="classattr">
                                <div class="attr variable">
            <span class="name">FID</span><span class="annotation">: str</span>        =
<span class="default_value">&#39;CHEMICAL_NET&#39;</span>

        
    </div>
    <a class="headerlink" href="#ChemicalNet.FID"></a>
    
    

                            </div>
                            <div id="ChemicalNet.parent" class="classattr">
                                <div class="attr variable">
            <span class="name">parent</span><span class="annotation">: Union[Type[flax.linen.module.Module], flax.core.scope.Scope, Type[flax.linen.module._Sentinel], NoneType]</span>

        
    </div>
    <a class="headerlink" href="#ChemicalNet.parent"></a>
    
            <div class="docstring"><p>Wraps parent module references in weak refs.</p>

<p>This prevents reference cycles from forming via parent links which can lead
to accidental OOMs in eager mode due to slow garbage collection as well as
spurious tracer leaks during jit compilation.</p>

<p>Note: "descriptors" are the underlying python mechanism for implementing
dynamic @property decorators.  We need to use a raw descriptor instead of the
more common decorator in order to force that the appropriate getter/setter
logic applies in subclasses even after various dataclass transforms.</p>
</div>


                            </div>
                            <div id="ChemicalNet.name" class="classattr">
                                <div class="attr variable">
            <span class="name">name</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ChemicalNet.name"></a>
    
    

                            </div>
                            <div id="ChemicalNet.scope" class="classattr">
                                <div class="attr variable">
            <span class="name">scope</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ChemicalNet.scope"></a>
    
    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>flax.linen.module.Module</dt>
                                <dd id="ChemicalNet.setup" class="function">setup</dd>
                <dd id="ChemicalNet.path" class="variable">path</dd>
                <dd id="ChemicalNet.clone" class="function">clone</dd>
                <dd id="ChemicalNet.copy" class="function">copy</dd>
                <dd id="ChemicalNet.variable" class="function">variable</dd>
                <dd id="ChemicalNet.param" class="function">param</dd>
                <dd id="ChemicalNet.has_variable" class="function">has_variable</dd>
                <dd id="ChemicalNet.is_mutable_collection" class="function">is_mutable_collection</dd>
                <dd id="ChemicalNet.has_rng" class="function">has_rng</dd>
                <dd id="ChemicalNet.make_rng" class="function">make_rng</dd>
                <dd id="ChemicalNet.is_initializing" class="function">is_initializing</dd>
                <dd id="ChemicalNet.bind" class="function">bind</dd>
                <dd id="ChemicalNet.unbind" class="function">unbind</dd>
                <dd id="ChemicalNet.apply" class="function">apply</dd>
                <dd id="ChemicalNet.init_with_output" class="function">init_with_output</dd>
                <dd id="ChemicalNet.init" class="function">init</dd>
                <dd id="ChemicalNet.lazy_init" class="function">lazy_init</dd>
                <dd id="ChemicalNet.variables" class="variable">variables</dd>
                <dd id="ChemicalNet.get_variable" class="function">get_variable</dd>
                <dd id="ChemicalNet.put_variable" class="function">put_variable</dd>
                <dd id="ChemicalNet.sow" class="function">sow</dd>
                <dd id="ChemicalNet.perturb" class="function">perturb</dd>
                <dd id="ChemicalNet.tabulate" class="function">tabulate</dd>
                <dd id="ChemicalNet.module_paths" class="function">module_paths</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="MOENet">
                            <input id="MOENet-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">MOENet</span><wbr>(<span class="base">flax.linen.module.Module</span>):

                <label class="view-source-button" for="MOENet-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MOENet"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MOENet-502"><a href="#MOENet-502"><span class="linenos">502</span></a><span class="k">class</span> <span class="nc">MOENet</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="MOENet-503"><a href="#MOENet-503"><span class="linenos">503</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Mixture of Experts neural network.</span>
</span><span id="MOENet-504"><a href="#MOENet-504"><span class="linenos">504</span></a>
</span><span id="MOENet-505"><a href="#MOENet-505"><span class="linenos">505</span></a><span class="sd">    This class represents a Mixture of Experts neural network. It takes in an input and applies a set of shape-sharing networks</span>
</span><span id="MOENet-506"><a href="#MOENet-506"><span class="linenos">506</span></a><span class="sd">    to the input based on a router. The outputs of the shape-sharing networks are then combined using weights computed by the router.</span>
</span><span id="MOENet-507"><a href="#MOENet-507"><span class="linenos">507</span></a>
</span><span id="MOENet-508"><a href="#MOENet-508"><span class="linenos">508</span></a><span class="sd">    Parameters:</span>
</span><span id="MOENet-509"><a href="#MOENet-509"><span class="linenos">509</span></a><span class="sd">        neurons (Sequence[int]): A sequence of integers representing the number of neurons in each shape-sharing network.</span>
</span><span id="MOENet-510"><a href="#MOENet-510"><span class="linenos">510</span></a><span class="sd">        num_networks (int): The number of shape-sharing networks to create.</span>
</span><span id="MOENet-511"><a href="#MOENet-511"><span class="linenos">511</span></a><span class="sd">        activation (Union[Callable, str], optional): The activation function to use in the shape-sharing networks. Defaults to nn.silu.</span>
</span><span id="MOENet-512"><a href="#MOENet-512"><span class="linenos">512</span></a><span class="sd">        use_bias (bool, optional): Whether to include bias in the shape-sharing networks. Defaults to True.</span>
</span><span id="MOENet-513"><a href="#MOENet-513"><span class="linenos">513</span></a><span class="sd">        input_key (Optional[str], optional): The key to access the input from the inputs dictionary. If None, the input is assumed to be the same as the router. Defaults to None.</span>
</span><span id="MOENet-514"><a href="#MOENet-514"><span class="linenos">514</span></a><span class="sd">        output_key (Optional[str], optional): The key to store the output in the outputs dictionary. If None, the output is stored with the name of the MOENet instance. Defaults to None.</span>
</span><span id="MOENet-515"><a href="#MOENet-515"><span class="linenos">515</span></a><span class="sd">        squeeze (bool, optional): Whether to squeeze the output if it has a shape of (batch_size, 1). Defaults to False.</span>
</span><span id="MOENet-516"><a href="#MOENet-516"><span class="linenos">516</span></a><span class="sd">        kernel_init (Union[str, Callable], optional): The kernel initialization function to use in the shape-sharing networks. Defaults to nn.linear.default_kernel_init.</span>
</span><span id="MOENet-517"><a href="#MOENet-517"><span class="linenos">517</span></a><span class="sd">        router_key (Optional[str], optional): The key to access the router from the inputs dictionary. If None, the router is assumed to be the same as the input. Defaults to None.</span>
</span><span id="MOENet-518"><a href="#MOENet-518"><span class="linenos">518</span></a>
</span><span id="MOENet-519"><a href="#MOENet-519"><span class="linenos">519</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="MOENet-520"><a href="#MOENet-520"><span class="linenos">520</span></a>
</span><span id="MOENet-521"><a href="#MOENet-521"><span class="linenos">521</span></a>    <span class="n">neurons</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
</span><span id="MOENet-522"><a href="#MOENet-522"><span class="linenos">522</span></a>    <span class="n">num_networks</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="MOENet-523"><a href="#MOENet-523"><span class="linenos">523</span></a>    <span class="n">activation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">silu</span>
</span><span id="MOENet-524"><a href="#MOENet-524"><span class="linenos">524</span></a>    <span class="n">use_bias</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="MOENet-525"><a href="#MOENet-525"><span class="linenos">525</span></a>    <span class="n">input_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="MOENet-526"><a href="#MOENet-526"><span class="linenos">526</span></a>    <span class="n">output_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="MOENet-527"><a href="#MOENet-527"><span class="linenos">527</span></a>    <span class="n">squeeze</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="MOENet-528"><a href="#MOENet-528"><span class="linenos">528</span></a>    <span class="n">kernel_init</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">default_kernel_init</span>
</span><span id="MOENet-529"><a href="#MOENet-529"><span class="linenos">529</span></a>    <span class="n">router_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="MOENet-530"><a href="#MOENet-530"><span class="linenos">530</span></a>
</span><span id="MOENet-531"><a href="#MOENet-531"><span class="linenos">531</span></a>    <span class="n">FID</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;MOE_NET&quot;</span>
</span><span id="MOENet-532"><a href="#MOENet-532"><span class="linenos">532</span></a>
</span><span id="MOENet-533"><a href="#MOENet-533"><span class="linenos">533</span></a>    <span class="nd">@nn</span><span class="o">.</span><span class="n">compact</span>
</span><span id="MOENet-534"><a href="#MOENet-534"><span class="linenos">534</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span>
</span><span id="MOENet-535"><a href="#MOENet-535"><span class="linenos">535</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">]]</span>
</span><span id="MOENet-536"><a href="#MOENet-536"><span class="linenos">536</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">]:</span>
</span><span id="MOENet-537"><a href="#MOENet-537"><span class="linenos">537</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MOENet-538"><a href="#MOENet-538"><span class="linenos">538</span></a>            <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
</span><span id="MOENet-539"><a href="#MOENet-539"><span class="linenos">539</span></a>                <span class="n">inputs</span><span class="p">,</span> <span class="nb">dict</span>
</span><span id="MOENet-540"><a href="#MOENet-540"><span class="linenos">540</span></a>            <span class="p">),</span> <span class="s2">&quot;input key must be provided if inputs is a dictionary&quot;</span>
</span><span id="MOENet-541"><a href="#MOENet-541"><span class="linenos">541</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
</span><span id="MOENet-542"><a href="#MOENet-542"><span class="linenos">542</span></a>                <span class="n">embedding</span><span class="p">,</span> <span class="n">router</span> <span class="o">=</span> <span class="n">inputs</span>
</span><span id="MOENet-543"><a href="#MOENet-543"><span class="linenos">543</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MOENet-544"><a href="#MOENet-544"><span class="linenos">544</span></a>                <span class="n">embedding</span> <span class="o">=</span> <span class="n">router</span> <span class="o">=</span> <span class="n">inputs</span>
</span><span id="MOENet-545"><a href="#MOENet-545"><span class="linenos">545</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MOENet-546"><a href="#MOENet-546"><span class="linenos">546</span></a>            <span class="n">embedding</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">input_key</span><span class="p">]</span>
</span><span id="MOENet-547"><a href="#MOENet-547"><span class="linenos">547</span></a>            <span class="n">router</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="MOENet-548"><a href="#MOENet-548"><span class="linenos">548</span></a>                <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">router_key</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">router_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">embedding</span>
</span><span id="MOENet-549"><a href="#MOENet-549"><span class="linenos">549</span></a>            <span class="p">)</span>
</span><span id="MOENet-550"><a href="#MOENet-550"><span class="linenos">550</span></a>
</span><span id="MOENet-551"><a href="#MOENet-551"><span class="linenos">551</span></a>        <span class="c1">############################</span>
</span><span id="MOENet-552"><a href="#MOENet-552"><span class="linenos">552</span></a>        <span class="c1"># build shape-sharing networks using vmap</span>
</span><span id="MOENet-553"><a href="#MOENet-553"><span class="linenos">553</span></a>        <span class="n">networks</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span>
</span><span id="MOENet-554"><a href="#MOENet-554"><span class="linenos">554</span></a>            <span class="n">FullyConnectedNet</span><span class="p">,</span>
</span><span id="MOENet-555"><a href="#MOENet-555"><span class="linenos">555</span></a>            <span class="n">variable_axes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
</span><span id="MOENet-556"><a href="#MOENet-556"><span class="linenos">556</span></a>            <span class="n">split_rngs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
</span><span id="MOENet-557"><a href="#MOENet-557"><span class="linenos">557</span></a>            <span class="n">in_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="MOENet-558"><a href="#MOENet-558"><span class="linenos">558</span></a>            <span class="n">out_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="MOENet-559"><a href="#MOENet-559"><span class="linenos">559</span></a>        <span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">neurons</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_bias</span><span class="p">,</span> <span class="n">kernel_init</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_init</span><span class="p">)</span>
</span><span id="MOENet-560"><a href="#MOENet-560"><span class="linenos">560</span></a>        <span class="c1"># repeat input along a new axis to compute for all networks at once</span>
</span><span id="MOENet-561"><a href="#MOENet-561"><span class="linenos">561</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">embedding</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_networks</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="MOENet-562"><a href="#MOENet-562"><span class="linenos">562</span></a>
</span><span id="MOENet-563"><a href="#MOENet-563"><span class="linenos">563</span></a>        <span class="n">w</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_networks</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;router&quot;</span><span class="p">)(</span><span class="n">router</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="MOENet-564"><a href="#MOENet-564"><span class="linenos">564</span></a>
</span><span id="MOENet-565"><a href="#MOENet-565"><span class="linenos">565</span></a>        <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">networks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">w</span><span class="o">.</span><span class="n">T</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="MOENet-566"><a href="#MOENet-566"><span class="linenos">566</span></a>
</span><span id="MOENet-567"><a href="#MOENet-567"><span class="linenos">567</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">squeeze</span> <span class="ow">and</span> <span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="MOENet-568"><a href="#MOENet-568"><span class="linenos">568</span></a>            <span class="n">out</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="MOENet-569"><a href="#MOENet-569"><span class="linenos">569</span></a>        <span class="c1">############################</span>
</span><span id="MOENet-570"><a href="#MOENet-570"><span class="linenos">570</span></a>
</span><span id="MOENet-571"><a href="#MOENet-571"><span class="linenos">571</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MOENet-572"><a href="#MOENet-572"><span class="linenos">572</span></a>            <span class="n">output_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_key</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_key</span>
</span><span id="MOENet-573"><a href="#MOENet-573"><span class="linenos">573</span></a>            <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="n">output_key</span><span class="p">:</span> <span class="n">out</span><span class="p">}</span> <span class="k">if</span> <span class="n">output_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">out</span>
</span><span id="MOENet-574"><a href="#MOENet-574"><span class="linenos">574</span></a>        <span class="k">return</span> <span class="n">out</span>
</span></pre></div>


            <div class="docstring"><p>Mixture of Experts neural network.</p>

<p>This class represents a Mixture of Experts neural network. It takes in an input and applies a set of shape-sharing networks
to the input based on a router. The outputs of the shape-sharing networks are then combined using weights computed by the router.</p>

<p>Parameters:
    neurons (Sequence[int]): A sequence of integers representing the number of neurons in each shape-sharing network.
    num_networks (int): The number of shape-sharing networks to create.
    activation (Union[Callable, str], optional): The activation function to use in the shape-sharing networks. Defaults to nn.silu.
    use_bias (bool, optional): Whether to include bias in the shape-sharing networks. Defaults to True.
    input_key (Optional[str], optional): The key to access the input from the inputs dictionary. If None, the input is assumed to be the same as the router. Defaults to None.
    output_key (Optional[str], optional): The key to store the output in the outputs dictionary. If None, the output is stored with the name of the MOENet instance. Defaults to None.
    squeeze (bool, optional): Whether to squeeze the output if it has a shape of (batch_size, 1). Defaults to False.
    kernel_init (Union[str, Callable], optional): The kernel initialization function to use in the shape-sharing networks. Defaults to nn.linear.default_kernel_init.
    router_key (Optional[str], optional): The key to access the router from the inputs dictionary. If None, the router is assumed to be the same as the input. Defaults to None.</p>
</div>


                            <div id="MOENet.__init__" class="classattr">
                                <div class="attr function">
            
        <span class="name">MOENet</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">neurons</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>,</span><span class="param">	<span class="n">num_networks</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">activation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">PjitFunction</span> <span class="n">of</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">silu</span><span class="o">&gt;&gt;</span>,</span><span class="param">	<span class="n">use_bias</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">input_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">output_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">squeeze</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">kernel_init</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">variance_scaling</span><span class="o">.&lt;</span><span class="nb">locals</span><span class="o">&gt;.</span><span class="n">init</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">router_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">FID</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;MOE_NET&#39;</span>,</span><span class="param">	<span class="n">parent</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">flax</span><span class="o">.</span><span class="n">linen</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">Module</span><span class="p">],</span> <span class="n">flax</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">Scope</span><span class="p">,</span> <span class="n">Type</span><span class="p">[</span><span class="n">flax</span><span class="o">.</span><span class="n">linen</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">_Sentinel</span><span class="p">],</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">flax</span><span class="o">.</span><span class="n">linen</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">_Sentinel</span> <span class="nb">object</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

        
    </div>
    <a class="headerlink" href="#MOENet.__init__"></a>
    
    

                            </div>
                            <div id="MOENet.neurons" class="classattr">
                                <div class="attr variable">
            <span class="name">neurons</span><span class="annotation">: Sequence[int]</span>

        
    </div>
    <a class="headerlink" href="#MOENet.neurons"></a>
    
    

                            </div>
                            <div id="MOENet.num_networks" class="classattr">
                                <div class="attr variable">
            <span class="name">num_networks</span><span class="annotation">: int</span>

        
    </div>
    <a class="headerlink" href="#MOENet.num_networks"></a>
    
    

                            </div>
                            <div id="MOENet.activation" class="classattr">
                                        <input id="MOENet.activation-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@jax.jit</div>

        <span class="def">def</span>
        <span class="name">activation</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">x</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">bool_</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span>:</span></span>

                <label class="view-source-button" for="MOENet.activation-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MOENet.activation"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MOENet.activation-151"><a href="#MOENet.activation-151"><span class="linenos">151</span></a><span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
</span><span id="MOENet.activation-152"><a href="#MOENet.activation-152"><span class="linenos">152</span></a><span class="k">def</span> <span class="nf">silu</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="p">:</span>
</span><span id="MOENet.activation-153"><a href="#MOENet.activation-153"><span class="linenos">153</span></a><span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;SiLU (a.k.a. swish) activation function.</span>
</span><span id="MOENet.activation-154"><a href="#MOENet.activation-154"><span class="linenos">154</span></a>
</span><span id="MOENet.activation-155"><a href="#MOENet.activation-155"><span class="linenos">155</span></a><span class="sd">  Computes the element-wise function:</span>
</span><span id="MOENet.activation-156"><a href="#MOENet.activation-156"><span class="linenos">156</span></a>
</span><span id="MOENet.activation-157"><a href="#MOENet.activation-157"><span class="linenos">157</span></a><span class="sd">  .. math::</span>
</span><span id="MOENet.activation-158"><a href="#MOENet.activation-158"><span class="linenos">158</span></a><span class="sd">    \mathrm{silu}(x) = x \cdot \mathrm{sigmoid}(x) = \frac{x}{1 + e^{-x}}</span>
</span><span id="MOENet.activation-159"><a href="#MOENet.activation-159"><span class="linenos">159</span></a>
</span><span id="MOENet.activation-160"><a href="#MOENet.activation-160"><span class="linenos">160</span></a><span class="sd">  :func:`swish` and :func:`silu` are both aliases for the same function.</span>
</span><span id="MOENet.activation-161"><a href="#MOENet.activation-161"><span class="linenos">161</span></a>
</span><span id="MOENet.activation-162"><a href="#MOENet.activation-162"><span class="linenos">162</span></a><span class="sd">  Args:</span>
</span><span id="MOENet.activation-163"><a href="#MOENet.activation-163"><span class="linenos">163</span></a><span class="sd">    x : input array</span>
</span><span id="MOENet.activation-164"><a href="#MOENet.activation-164"><span class="linenos">164</span></a>
</span><span id="MOENet.activation-165"><a href="#MOENet.activation-165"><span class="linenos">165</span></a><span class="sd">  Returns:</span>
</span><span id="MOENet.activation-166"><a href="#MOENet.activation-166"><span class="linenos">166</span></a><span class="sd">    An array.</span>
</span><span id="MOENet.activation-167"><a href="#MOENet.activation-167"><span class="linenos">167</span></a>
</span><span id="MOENet.activation-168"><a href="#MOENet.activation-168"><span class="linenos">168</span></a><span class="sd">  See also:</span>
</span><span id="MOENet.activation-169"><a href="#MOENet.activation-169"><span class="linenos">169</span></a><span class="sd">    :func:`sigmoid`</span>
</span><span id="MOENet.activation-170"><a href="#MOENet.activation-170"><span class="linenos">170</span></a><span class="sd">  &quot;&quot;&quot;</span>
</span><span id="MOENet.activation-171"><a href="#MOENet.activation-171"><span class="linenos">171</span></a>  <span class="n">numpy_util</span><span class="o">.</span><span class="n">check_arraylike</span><span class="p">(</span><span class="s2">&quot;silu&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span><span id="MOENet.activation-172"><a href="#MOENet.activation-172"><span class="linenos">172</span></a>  <span class="n">x_arr</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="MOENet.activation-173"><a href="#MOENet.activation-173"><span class="linenos">173</span></a>  <span class="k">return</span> <span class="n">x_arr</span> <span class="o">*</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">x_arr</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>SiLU (a.k.a. swish) activation function.</p>

<p>Computes the element-wise function:</p>

<p>$$\mathrm{silu}(x) = x \cdot \mathrm{sigmoid}(x) = \frac{x}{1 + e^{-x}}$$</p>

<p><code>swish()</code> and <code>silu()</code> are both aliases for the same function.</p>

<p>Args:
  x : input array</p>

<p>Returns:
  An array.</p>

<p>See also:
  <code>sigmoid()</code></p>
</div>


                            </div>
                            <div id="MOENet.use_bias" class="classattr">
                                <div class="attr variable">
            <span class="name">use_bias</span><span class="annotation">: bool</span>        =
<span class="default_value">True</span>

        
    </div>
    <a class="headerlink" href="#MOENet.use_bias"></a>
    
    

                            </div>
                            <div id="MOENet.input_key" class="classattr">
                                <div class="attr variable">
            <span class="name">input_key</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#MOENet.input_key"></a>
    
    

                            </div>
                            <div id="MOENet.output_key" class="classattr">
                                <div class="attr variable">
            <span class="name">output_key</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#MOENet.output_key"></a>
    
    

                            </div>
                            <div id="MOENet.squeeze" class="classattr">
                                <div class="attr variable">
            <span class="name">squeeze</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#MOENet.squeeze"></a>
    
    

                            </div>
                            <div id="MOENet.kernel_init" class="classattr">
                                        <input id="MOENet.kernel_init-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">kernel_init</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">key</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span>,</span><span class="param">	<span class="n">shape</span><span class="p">:</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]]</span>,</span><span class="param">	dtype: Any = &lt;class &#x27;jax.numpy.float64&#x27;&gt;</span><span class="return-annotation">) -> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span>:</span></span>

                <label class="view-source-button" for="MOENet.kernel_init-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MOENet.kernel_init"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MOENet.kernel_init-317"><a href="#MOENet.kernel_init-317"><span class="linenos">317</span></a>  <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">KeyArray</span><span class="p">,</span>
</span><span id="MOENet.kernel_init-318"><a href="#MOENet.kernel_init-318"><span class="linenos">318</span></a>           <span class="n">shape</span><span class="p">:</span> <span class="n">core</span><span class="o">.</span><span class="n">Shape</span><span class="p">,</span>
</span><span id="MOENet.kernel_init-319"><a href="#MOENet.kernel_init-319"><span class="linenos">319</span></a>           <span class="n">dtype</span><span class="p">:</span> <span class="n">DTypeLikeInexact</span> <span class="o">=</span> <span class="n">dtype</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="p">:</span>
</span><span id="MOENet.kernel_init-320"><a href="#MOENet.kernel_init-320"><span class="linenos">320</span></a>    <span class="n">dtype</span> <span class="o">=</span> <span class="n">dtypes</span><span class="o">.</span><span class="n">canonicalize_dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="MOENet.kernel_init-321"><a href="#MOENet.kernel_init-321"><span class="linenos">321</span></a>    <span class="n">named_shape</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">as_named_shape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
</span><span id="MOENet.kernel_init-322"><a href="#MOENet.kernel_init-322"><span class="linenos">322</span></a>    <span class="n">fan_in</span><span class="p">,</span> <span class="n">fan_out</span> <span class="o">=</span> <span class="n">_compute_fans</span><span class="p">(</span><span class="n">named_shape</span><span class="p">,</span> <span class="n">in_axis</span><span class="p">,</span> <span class="n">out_axis</span><span class="p">,</span> <span class="n">batch_axis</span><span class="p">)</span>
</span><span id="MOENet.kernel_init-323"><a href="#MOENet.kernel_init-323"><span class="linenos">323</span></a>    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;fan_in&quot;</span><span class="p">:</span> <span class="n">denominator</span> <span class="o">=</span> <span class="n">fan_in</span>
</span><span id="MOENet.kernel_init-324"><a href="#MOENet.kernel_init-324"><span class="linenos">324</span></a>    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;fan_out&quot;</span><span class="p">:</span> <span class="n">denominator</span> <span class="o">=</span> <span class="n">fan_out</span>
</span><span id="MOENet.kernel_init-325"><a href="#MOENet.kernel_init-325"><span class="linenos">325</span></a>    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;fan_avg&quot;</span><span class="p">:</span> <span class="n">denominator</span> <span class="o">=</span> <span class="p">(</span><span class="n">fan_in</span> <span class="o">+</span> <span class="n">fan_out</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="MOENet.kernel_init-326"><a href="#MOENet.kernel_init-326"><span class="linenos">326</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="MOENet.kernel_init-327"><a href="#MOENet.kernel_init-327"><span class="linenos">327</span></a>      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="MOENet.kernel_init-328"><a href="#MOENet.kernel_init-328"><span class="linenos">328</span></a>        <span class="sa">f</span><span class="s2">&quot;invalid mode for variance scaling initializer: </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="MOENet.kernel_init-329"><a href="#MOENet.kernel_init-329"><span class="linenos">329</span></a>    <span class="n">variance</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">scale</span> <span class="o">/</span> <span class="n">denominator</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="MOENet.kernel_init-330"><a href="#MOENet.kernel_init-330"><span class="linenos">330</span></a>
</span><span id="MOENet.kernel_init-331"><a href="#MOENet.kernel_init-331"><span class="linenos">331</span></a>    <span class="k">if</span> <span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;truncated_normal&quot;</span><span class="p">:</span>
</span><span id="MOENet.kernel_init-332"><a href="#MOENet.kernel_init-332"><span class="linenos">332</span></a>      <span class="k">if</span> <span class="n">jnp</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">floating</span><span class="p">):</span>
</span><span id="MOENet.kernel_init-333"><a href="#MOENet.kernel_init-333"><span class="linenos">333</span></a>        <span class="c1"># constant is stddev of standard normal truncated to (-2, 2)</span>
</span><span id="MOENet.kernel_init-334"><a href="#MOENet.kernel_init-334"><span class="linenos">334</span></a>        <span class="n">stddev</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">.87962566103423978</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
</span><span id="MOENet.kernel_init-335"><a href="#MOENet.kernel_init-335"><span class="linenos">335</span></a>        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">truncated_normal</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">named_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="n">stddev</span>
</span><span id="MOENet.kernel_init-336"><a href="#MOENet.kernel_init-336"><span class="linenos">336</span></a>      <span class="k">else</span><span class="p">:</span>
</span><span id="MOENet.kernel_init-337"><a href="#MOENet.kernel_init-337"><span class="linenos">337</span></a>        <span class="c1"># constant is stddev of complex standard normal truncated to 2</span>
</span><span id="MOENet.kernel_init-338"><a href="#MOENet.kernel_init-338"><span class="linenos">338</span></a>        <span class="n">stddev</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">.95311164380491208</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
</span><span id="MOENet.kernel_init-339"><a href="#MOENet.kernel_init-339"><span class="linenos">339</span></a>        <span class="k">return</span> <span class="n">_complex_truncated_normal</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">named_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="n">stddev</span>
</span><span id="MOENet.kernel_init-340"><a href="#MOENet.kernel_init-340"><span class="linenos">340</span></a>    <span class="k">elif</span> <span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;normal&quot;</span><span class="p">:</span>
</span><span id="MOENet.kernel_init-341"><a href="#MOENet.kernel_init-341"><span class="linenos">341</span></a>      <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">named_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span>
</span><span id="MOENet.kernel_init-342"><a href="#MOENet.kernel_init-342"><span class="linenos">342</span></a>    <span class="k">elif</span> <span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;uniform&quot;</span><span class="p">:</span>
</span><span id="MOENet.kernel_init-343"><a href="#MOENet.kernel_init-343"><span class="linenos">343</span></a>      <span class="k">if</span> <span class="n">jnp</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">floating</span><span class="p">):</span>
</span><span id="MOENet.kernel_init-344"><a href="#MOENet.kernel_init-344"><span class="linenos">344</span></a>        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">named_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">variance</span><span class="p">)</span>
</span><span id="MOENet.kernel_init-345"><a href="#MOENet.kernel_init-345"><span class="linenos">345</span></a>      <span class="k">else</span><span class="p">:</span>
</span><span id="MOENet.kernel_init-346"><a href="#MOENet.kernel_init-346"><span class="linenos">346</span></a>        <span class="k">return</span> <span class="n">_complex_uniform</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">named_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span>
</span><span id="MOENet.kernel_init-347"><a href="#MOENet.kernel_init-347"><span class="linenos">347</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="MOENet.kernel_init-348"><a href="#MOENet.kernel_init-348"><span class="linenos">348</span></a>      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;invalid distribution for variance scaling initializer: </span><span class="si">{</span><span class="n">distribution</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="MOENet.router_key" class="classattr">
                                <div class="attr variable">
            <span class="name">router_key</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#MOENet.router_key"></a>
    
    

                            </div>
                            <div id="MOENet.FID" class="classattr">
                                <div class="attr variable">
            <span class="name">FID</span><span class="annotation">: str</span>        =
<span class="default_value">&#39;MOE_NET&#39;</span>

        
    </div>
    <a class="headerlink" href="#MOENet.FID"></a>
    
    

                            </div>
                            <div id="MOENet.parent" class="classattr">
                                <div class="attr variable">
            <span class="name">parent</span><span class="annotation">: Union[Type[flax.linen.module.Module], flax.core.scope.Scope, Type[flax.linen.module._Sentinel], NoneType]</span>

        
    </div>
    <a class="headerlink" href="#MOENet.parent"></a>
    
            <div class="docstring"><p>Wraps parent module references in weak refs.</p>

<p>This prevents reference cycles from forming via parent links which can lead
to accidental OOMs in eager mode due to slow garbage collection as well as
spurious tracer leaks during jit compilation.</p>

<p>Note: "descriptors" are the underlying python mechanism for implementing
dynamic @property decorators.  We need to use a raw descriptor instead of the
more common decorator in order to force that the appropriate getter/setter
logic applies in subclasses even after various dataclass transforms.</p>
</div>


                            </div>
                            <div id="MOENet.name" class="classattr">
                                <div class="attr variable">
            <span class="name">name</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#MOENet.name"></a>
    
    

                            </div>
                            <div id="MOENet.scope" class="classattr">
                                <div class="attr variable">
            <span class="name">scope</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#MOENet.scope"></a>
    
    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>flax.linen.module.Module</dt>
                                <dd id="MOENet.setup" class="function">setup</dd>
                <dd id="MOENet.path" class="variable">path</dd>
                <dd id="MOENet.clone" class="function">clone</dd>
                <dd id="MOENet.copy" class="function">copy</dd>
                <dd id="MOENet.variable" class="function">variable</dd>
                <dd id="MOENet.param" class="function">param</dd>
                <dd id="MOENet.has_variable" class="function">has_variable</dd>
                <dd id="MOENet.is_mutable_collection" class="function">is_mutable_collection</dd>
                <dd id="MOENet.has_rng" class="function">has_rng</dd>
                <dd id="MOENet.make_rng" class="function">make_rng</dd>
                <dd id="MOENet.is_initializing" class="function">is_initializing</dd>
                <dd id="MOENet.bind" class="function">bind</dd>
                <dd id="MOENet.unbind" class="function">unbind</dd>
                <dd id="MOENet.apply" class="function">apply</dd>
                <dd id="MOENet.init_with_output" class="function">init_with_output</dd>
                <dd id="MOENet.init" class="function">init</dd>
                <dd id="MOENet.lazy_init" class="function">lazy_init</dd>
                <dd id="MOENet.variables" class="variable">variables</dd>
                <dd id="MOENet.get_variable" class="function">get_variable</dd>
                <dd id="MOENet.put_variable" class="function">put_variable</dd>
                <dd id="MOENet.sow" class="function">sow</dd>
                <dd id="MOENet.perturb" class="function">perturb</dd>
                <dd id="MOENet.tabulate" class="function">tabulate</dd>
                <dd id="MOENet.module_paths" class="function">module_paths</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="ChannelNet">
                            <input id="ChannelNet-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">ChannelNet</span><wbr>(<span class="base">flax.linen.module.Module</span>):

                <label class="view-source-button" for="ChannelNet-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ChannelNet"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ChannelNet-576"><a href="#ChannelNet-576"><span class="linenos">576</span></a><span class="k">class</span> <span class="nc">ChannelNet</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="ChannelNet-577"><a href="#ChannelNet-577"><span class="linenos">577</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply a neural network to each channel.</span>
</span><span id="ChannelNet-578"><a href="#ChannelNet-578"><span class="linenos">578</span></a>
</span><span id="ChannelNet-579"><a href="#ChannelNet-579"><span class="linenos">579</span></a><span class="sd">    Parameters:</span>
</span><span id="ChannelNet-580"><a href="#ChannelNet-580"><span class="linenos">580</span></a><span class="sd">        neurons (Sequence[int]): A sequence of integers representing the number of neurons in each shape-sharing network.</span>
</span><span id="ChannelNet-581"><a href="#ChannelNet-581"><span class="linenos">581</span></a><span class="sd">        num_networks (int): The number of shape-sharing networks to create.</span>
</span><span id="ChannelNet-582"><a href="#ChannelNet-582"><span class="linenos">582</span></a><span class="sd">        activation (Union[Callable, str], optional): The activation function to use in the shape-sharing networks. Defaults to nn.silu.</span>
</span><span id="ChannelNet-583"><a href="#ChannelNet-583"><span class="linenos">583</span></a><span class="sd">        use_bias (bool, optional): Whether to include bias in the shape-sharing networks. Defaults to True.</span>
</span><span id="ChannelNet-584"><a href="#ChannelNet-584"><span class="linenos">584</span></a><span class="sd">        input_key (Optional[str], optional): The key to access the input from the inputs dictionary. If None, the input is assumed to be the same as the router. Defaults to None.</span>
</span><span id="ChannelNet-585"><a href="#ChannelNet-585"><span class="linenos">585</span></a><span class="sd">        output_key (Optional[str], optional): The key to store the output in the outputs dictionary. If None, the output is stored with the name of the MOENet instance. Defaults to None.</span>
</span><span id="ChannelNet-586"><a href="#ChannelNet-586"><span class="linenos">586</span></a><span class="sd">        squeeze (bool, optional): Whether to squeeze the output if it has a shape of (batch_size, 1). Defaults to False.</span>
</span><span id="ChannelNet-587"><a href="#ChannelNet-587"><span class="linenos">587</span></a><span class="sd">        kernel_init (Union[str, Callable], optional): The kernel initialization function to use in the shape-sharing networks. Defaults to nn.linear.default_kernel_init.</span>
</span><span id="ChannelNet-588"><a href="#ChannelNet-588"><span class="linenos">588</span></a><span class="sd">        router_key (Optional[str], optional): The key to access the router from the inputs dictionary. If None, the router is assumed to be the same as the input. Defaults to None.</span>
</span><span id="ChannelNet-589"><a href="#ChannelNet-589"><span class="linenos">589</span></a>
</span><span id="ChannelNet-590"><a href="#ChannelNet-590"><span class="linenos">590</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="ChannelNet-591"><a href="#ChannelNet-591"><span class="linenos">591</span></a>
</span><span id="ChannelNet-592"><a href="#ChannelNet-592"><span class="linenos">592</span></a>    <span class="n">neurons</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
</span><span id="ChannelNet-593"><a href="#ChannelNet-593"><span class="linenos">593</span></a>    <span class="n">activation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">silu</span>
</span><span id="ChannelNet-594"><a href="#ChannelNet-594"><span class="linenos">594</span></a>    <span class="n">use_bias</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ChannelNet-595"><a href="#ChannelNet-595"><span class="linenos">595</span></a>    <span class="n">input_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ChannelNet-596"><a href="#ChannelNet-596"><span class="linenos">596</span></a>    <span class="n">output_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ChannelNet-597"><a href="#ChannelNet-597"><span class="linenos">597</span></a>    <span class="n">squeeze</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ChannelNet-598"><a href="#ChannelNet-598"><span class="linenos">598</span></a>    <span class="n">kernel_init</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">default_kernel_init</span>
</span><span id="ChannelNet-599"><a href="#ChannelNet-599"><span class="linenos">599</span></a>    <span class="n">channel_axis</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>
</span><span id="ChannelNet-600"><a href="#ChannelNet-600"><span class="linenos">600</span></a>
</span><span id="ChannelNet-601"><a href="#ChannelNet-601"><span class="linenos">601</span></a>    <span class="n">FID</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;CHANNEL_NET&quot;</span>
</span><span id="ChannelNet-602"><a href="#ChannelNet-602"><span class="linenos">602</span></a>
</span><span id="ChannelNet-603"><a href="#ChannelNet-603"><span class="linenos">603</span></a>    <span class="nd">@nn</span><span class="o">.</span><span class="n">compact</span>
</span><span id="ChannelNet-604"><a href="#ChannelNet-604"><span class="linenos">604</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span>
</span><span id="ChannelNet-605"><a href="#ChannelNet-605"><span class="linenos">605</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">]]</span>
</span><span id="ChannelNet-606"><a href="#ChannelNet-606"><span class="linenos">606</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">]:</span>
</span><span id="ChannelNet-607"><a href="#ChannelNet-607"><span class="linenos">607</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ChannelNet-608"><a href="#ChannelNet-608"><span class="linenos">608</span></a>            <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
</span><span id="ChannelNet-609"><a href="#ChannelNet-609"><span class="linenos">609</span></a>                <span class="n">inputs</span><span class="p">,</span> <span class="nb">dict</span>
</span><span id="ChannelNet-610"><a href="#ChannelNet-610"><span class="linenos">610</span></a>            <span class="p">),</span> <span class="s2">&quot;input key must be provided if inputs is a dictionary&quot;</span>
</span><span id="ChannelNet-611"><a href="#ChannelNet-611"><span class="linenos">611</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">inputs</span>
</span><span id="ChannelNet-612"><a href="#ChannelNet-612"><span class="linenos">612</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ChannelNet-613"><a href="#ChannelNet-613"><span class="linenos">613</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">input_key</span><span class="p">]</span>
</span><span id="ChannelNet-614"><a href="#ChannelNet-614"><span class="linenos">614</span></a>
</span><span id="ChannelNet-615"><a href="#ChannelNet-615"><span class="linenos">615</span></a>        <span class="c1">############################</span>
</span><span id="ChannelNet-616"><a href="#ChannelNet-616"><span class="linenos">616</span></a>        <span class="c1"># build shape-sharing networks using vmap</span>
</span><span id="ChannelNet-617"><a href="#ChannelNet-617"><span class="linenos">617</span></a>        <span class="n">networks</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span>
</span><span id="ChannelNet-618"><a href="#ChannelNet-618"><span class="linenos">618</span></a>            <span class="n">FullyConnectedNet</span><span class="p">,</span>
</span><span id="ChannelNet-619"><a href="#ChannelNet-619"><span class="linenos">619</span></a>            <span class="n">variable_axes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
</span><span id="ChannelNet-620"><a href="#ChannelNet-620"><span class="linenos">620</span></a>            <span class="n">split_rngs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
</span><span id="ChannelNet-621"><a href="#ChannelNet-621"><span class="linenos">621</span></a>            <span class="n">in_axes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_axis</span><span class="p">,</span>
</span><span id="ChannelNet-622"><a href="#ChannelNet-622"><span class="linenos">622</span></a>            <span class="n">out_axes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_axis</span><span class="p">,</span>
</span><span id="ChannelNet-623"><a href="#ChannelNet-623"><span class="linenos">623</span></a>        <span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">neurons</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_bias</span><span class="p">,</span> <span class="n">kernel_init</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_init</span><span class="p">)</span>
</span><span id="ChannelNet-624"><a href="#ChannelNet-624"><span class="linenos">624</span></a>        <span class="c1"># repeat input along a new axis to compute for all networks at once</span>
</span><span id="ChannelNet-625"><a href="#ChannelNet-625"><span class="linenos">625</span></a>
</span><span id="ChannelNet-626"><a href="#ChannelNet-626"><span class="linenos">626</span></a>        <span class="n">out</span> <span class="o">=</span> <span class="n">networks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="ChannelNet-627"><a href="#ChannelNet-627"><span class="linenos">627</span></a>
</span><span id="ChannelNet-628"><a href="#ChannelNet-628"><span class="linenos">628</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">squeeze</span> <span class="ow">and</span> <span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ChannelNet-629"><a href="#ChannelNet-629"><span class="linenos">629</span></a>            <span class="n">out</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="ChannelNet-630"><a href="#ChannelNet-630"><span class="linenos">630</span></a>        <span class="c1">############################</span>
</span><span id="ChannelNet-631"><a href="#ChannelNet-631"><span class="linenos">631</span></a>
</span><span id="ChannelNet-632"><a href="#ChannelNet-632"><span class="linenos">632</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ChannelNet-633"><a href="#ChannelNet-633"><span class="linenos">633</span></a>            <span class="n">output_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_key</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_key</span>
</span><span id="ChannelNet-634"><a href="#ChannelNet-634"><span class="linenos">634</span></a>            <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="n">output_key</span><span class="p">:</span> <span class="n">out</span><span class="p">}</span> <span class="k">if</span> <span class="n">output_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">out</span>
</span><span id="ChannelNet-635"><a href="#ChannelNet-635"><span class="linenos">635</span></a>        <span class="k">return</span> <span class="n">out</span>
</span></pre></div>


            <div class="docstring"><p>Apply a neural network to each channel.</p>

<p>Parameters:
    neurons (Sequence[int]): A sequence of integers representing the number of neurons in each shape-sharing network.
    num_networks (int): The number of shape-sharing networks to create.
    activation (Union[Callable, str], optional): The activation function to use in the shape-sharing networks. Defaults to nn.silu.
    use_bias (bool, optional): Whether to include bias in the shape-sharing networks. Defaults to True.
    input_key (Optional[str], optional): The key to access the input from the inputs dictionary. If None, the input is assumed to be the same as the router. Defaults to None.
    output_key (Optional[str], optional): The key to store the output in the outputs dictionary. If None, the output is stored with the name of the MOENet instance. Defaults to None.
    squeeze (bool, optional): Whether to squeeze the output if it has a shape of (batch_size, 1). Defaults to False.
    kernel_init (Union[str, Callable], optional): The kernel initialization function to use in the shape-sharing networks. Defaults to nn.linear.default_kernel_init.
    router_key (Optional[str], optional): The key to access the router from the inputs dictionary. If None, the router is assumed to be the same as the input. Defaults to None.</p>
</div>


                            <div id="ChannelNet.__init__" class="classattr">
                                <div class="attr function">
            
        <span class="name">ChannelNet</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">neurons</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>,</span><span class="param">	<span class="n">activation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">PjitFunction</span> <span class="n">of</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">silu</span><span class="o">&gt;&gt;</span>,</span><span class="param">	<span class="n">use_bias</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">input_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">output_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">squeeze</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">kernel_init</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">variance_scaling</span><span class="o">.&lt;</span><span class="nb">locals</span><span class="o">&gt;.</span><span class="n">init</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">channel_axis</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>,</span><span class="param">	<span class="n">FID</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;CHANNEL_NET&#39;</span>,</span><span class="param">	<span class="n">parent</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">flax</span><span class="o">.</span><span class="n">linen</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">Module</span><span class="p">],</span> <span class="n">flax</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">Scope</span><span class="p">,</span> <span class="n">Type</span><span class="p">[</span><span class="n">flax</span><span class="o">.</span><span class="n">linen</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">_Sentinel</span><span class="p">],</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">flax</span><span class="o">.</span><span class="n">linen</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">_Sentinel</span> <span class="nb">object</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

        
    </div>
    <a class="headerlink" href="#ChannelNet.__init__"></a>
    
    

                            </div>
                            <div id="ChannelNet.neurons" class="classattr">
                                <div class="attr variable">
            <span class="name">neurons</span><span class="annotation">: Sequence[int]</span>

        
    </div>
    <a class="headerlink" href="#ChannelNet.neurons"></a>
    
    

                            </div>
                            <div id="ChannelNet.activation" class="classattr">
                                        <input id="ChannelNet.activation-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@jax.jit</div>

        <span class="def">def</span>
        <span class="name">activation</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">x</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">bool_</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span>:</span></span>

                <label class="view-source-button" for="ChannelNet.activation-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ChannelNet.activation"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ChannelNet.activation-151"><a href="#ChannelNet.activation-151"><span class="linenos">151</span></a><span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
</span><span id="ChannelNet.activation-152"><a href="#ChannelNet.activation-152"><span class="linenos">152</span></a><span class="k">def</span> <span class="nf">silu</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="p">:</span>
</span><span id="ChannelNet.activation-153"><a href="#ChannelNet.activation-153"><span class="linenos">153</span></a><span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;SiLU (a.k.a. swish) activation function.</span>
</span><span id="ChannelNet.activation-154"><a href="#ChannelNet.activation-154"><span class="linenos">154</span></a>
</span><span id="ChannelNet.activation-155"><a href="#ChannelNet.activation-155"><span class="linenos">155</span></a><span class="sd">  Computes the element-wise function:</span>
</span><span id="ChannelNet.activation-156"><a href="#ChannelNet.activation-156"><span class="linenos">156</span></a>
</span><span id="ChannelNet.activation-157"><a href="#ChannelNet.activation-157"><span class="linenos">157</span></a><span class="sd">  .. math::</span>
</span><span id="ChannelNet.activation-158"><a href="#ChannelNet.activation-158"><span class="linenos">158</span></a><span class="sd">    \mathrm{silu}(x) = x \cdot \mathrm{sigmoid}(x) = \frac{x}{1 + e^{-x}}</span>
</span><span id="ChannelNet.activation-159"><a href="#ChannelNet.activation-159"><span class="linenos">159</span></a>
</span><span id="ChannelNet.activation-160"><a href="#ChannelNet.activation-160"><span class="linenos">160</span></a><span class="sd">  :func:`swish` and :func:`silu` are both aliases for the same function.</span>
</span><span id="ChannelNet.activation-161"><a href="#ChannelNet.activation-161"><span class="linenos">161</span></a>
</span><span id="ChannelNet.activation-162"><a href="#ChannelNet.activation-162"><span class="linenos">162</span></a><span class="sd">  Args:</span>
</span><span id="ChannelNet.activation-163"><a href="#ChannelNet.activation-163"><span class="linenos">163</span></a><span class="sd">    x : input array</span>
</span><span id="ChannelNet.activation-164"><a href="#ChannelNet.activation-164"><span class="linenos">164</span></a>
</span><span id="ChannelNet.activation-165"><a href="#ChannelNet.activation-165"><span class="linenos">165</span></a><span class="sd">  Returns:</span>
</span><span id="ChannelNet.activation-166"><a href="#ChannelNet.activation-166"><span class="linenos">166</span></a><span class="sd">    An array.</span>
</span><span id="ChannelNet.activation-167"><a href="#ChannelNet.activation-167"><span class="linenos">167</span></a>
</span><span id="ChannelNet.activation-168"><a href="#ChannelNet.activation-168"><span class="linenos">168</span></a><span class="sd">  See also:</span>
</span><span id="ChannelNet.activation-169"><a href="#ChannelNet.activation-169"><span class="linenos">169</span></a><span class="sd">    :func:`sigmoid`</span>
</span><span id="ChannelNet.activation-170"><a href="#ChannelNet.activation-170"><span class="linenos">170</span></a><span class="sd">  &quot;&quot;&quot;</span>
</span><span id="ChannelNet.activation-171"><a href="#ChannelNet.activation-171"><span class="linenos">171</span></a>  <span class="n">numpy_util</span><span class="o">.</span><span class="n">check_arraylike</span><span class="p">(</span><span class="s2">&quot;silu&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span><span id="ChannelNet.activation-172"><a href="#ChannelNet.activation-172"><span class="linenos">172</span></a>  <span class="n">x_arr</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="ChannelNet.activation-173"><a href="#ChannelNet.activation-173"><span class="linenos">173</span></a>  <span class="k">return</span> <span class="n">x_arr</span> <span class="o">*</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">x_arr</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>SiLU (a.k.a. swish) activation function.</p>

<p>Computes the element-wise function:</p>

<p>$$\mathrm{silu}(x) = x \cdot \mathrm{sigmoid}(x) = \frac{x}{1 + e^{-x}}$$</p>

<p><code>swish()</code> and <code>silu()</code> are both aliases for the same function.</p>

<p>Args:
  x : input array</p>

<p>Returns:
  An array.</p>

<p>See also:
  <code>sigmoid()</code></p>
</div>


                            </div>
                            <div id="ChannelNet.use_bias" class="classattr">
                                <div class="attr variable">
            <span class="name">use_bias</span><span class="annotation">: bool</span>        =
<span class="default_value">True</span>

        
    </div>
    <a class="headerlink" href="#ChannelNet.use_bias"></a>
    
    

                            </div>
                            <div id="ChannelNet.input_key" class="classattr">
                                <div class="attr variable">
            <span class="name">input_key</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ChannelNet.input_key"></a>
    
    

                            </div>
                            <div id="ChannelNet.output_key" class="classattr">
                                <div class="attr variable">
            <span class="name">output_key</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ChannelNet.output_key"></a>
    
    

                            </div>
                            <div id="ChannelNet.squeeze" class="classattr">
                                <div class="attr variable">
            <span class="name">squeeze</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ChannelNet.squeeze"></a>
    
    

                            </div>
                            <div id="ChannelNet.kernel_init" class="classattr">
                                        <input id="ChannelNet.kernel_init-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">kernel_init</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">key</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span>,</span><span class="param">	<span class="n">shape</span><span class="p">:</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]]</span>,</span><span class="param">	dtype: Any = &lt;class &#x27;jax.numpy.float64&#x27;&gt;</span><span class="return-annotation">) -> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span>:</span></span>

                <label class="view-source-button" for="ChannelNet.kernel_init-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ChannelNet.kernel_init"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ChannelNet.kernel_init-317"><a href="#ChannelNet.kernel_init-317"><span class="linenos">317</span></a>  <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">KeyArray</span><span class="p">,</span>
</span><span id="ChannelNet.kernel_init-318"><a href="#ChannelNet.kernel_init-318"><span class="linenos">318</span></a>           <span class="n">shape</span><span class="p">:</span> <span class="n">core</span><span class="o">.</span><span class="n">Shape</span><span class="p">,</span>
</span><span id="ChannelNet.kernel_init-319"><a href="#ChannelNet.kernel_init-319"><span class="linenos">319</span></a>           <span class="n">dtype</span><span class="p">:</span> <span class="n">DTypeLikeInexact</span> <span class="o">=</span> <span class="n">dtype</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="p">:</span>
</span><span id="ChannelNet.kernel_init-320"><a href="#ChannelNet.kernel_init-320"><span class="linenos">320</span></a>    <span class="n">dtype</span> <span class="o">=</span> <span class="n">dtypes</span><span class="o">.</span><span class="n">canonicalize_dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="ChannelNet.kernel_init-321"><a href="#ChannelNet.kernel_init-321"><span class="linenos">321</span></a>    <span class="n">named_shape</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">as_named_shape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
</span><span id="ChannelNet.kernel_init-322"><a href="#ChannelNet.kernel_init-322"><span class="linenos">322</span></a>    <span class="n">fan_in</span><span class="p">,</span> <span class="n">fan_out</span> <span class="o">=</span> <span class="n">_compute_fans</span><span class="p">(</span><span class="n">named_shape</span><span class="p">,</span> <span class="n">in_axis</span><span class="p">,</span> <span class="n">out_axis</span><span class="p">,</span> <span class="n">batch_axis</span><span class="p">)</span>
</span><span id="ChannelNet.kernel_init-323"><a href="#ChannelNet.kernel_init-323"><span class="linenos">323</span></a>    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;fan_in&quot;</span><span class="p">:</span> <span class="n">denominator</span> <span class="o">=</span> <span class="n">fan_in</span>
</span><span id="ChannelNet.kernel_init-324"><a href="#ChannelNet.kernel_init-324"><span class="linenos">324</span></a>    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;fan_out&quot;</span><span class="p">:</span> <span class="n">denominator</span> <span class="o">=</span> <span class="n">fan_out</span>
</span><span id="ChannelNet.kernel_init-325"><a href="#ChannelNet.kernel_init-325"><span class="linenos">325</span></a>    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;fan_avg&quot;</span><span class="p">:</span> <span class="n">denominator</span> <span class="o">=</span> <span class="p">(</span><span class="n">fan_in</span> <span class="o">+</span> <span class="n">fan_out</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="ChannelNet.kernel_init-326"><a href="#ChannelNet.kernel_init-326"><span class="linenos">326</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="ChannelNet.kernel_init-327"><a href="#ChannelNet.kernel_init-327"><span class="linenos">327</span></a>      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="ChannelNet.kernel_init-328"><a href="#ChannelNet.kernel_init-328"><span class="linenos">328</span></a>        <span class="sa">f</span><span class="s2">&quot;invalid mode for variance scaling initializer: </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ChannelNet.kernel_init-329"><a href="#ChannelNet.kernel_init-329"><span class="linenos">329</span></a>    <span class="n">variance</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">scale</span> <span class="o">/</span> <span class="n">denominator</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="ChannelNet.kernel_init-330"><a href="#ChannelNet.kernel_init-330"><span class="linenos">330</span></a>
</span><span id="ChannelNet.kernel_init-331"><a href="#ChannelNet.kernel_init-331"><span class="linenos">331</span></a>    <span class="k">if</span> <span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;truncated_normal&quot;</span><span class="p">:</span>
</span><span id="ChannelNet.kernel_init-332"><a href="#ChannelNet.kernel_init-332"><span class="linenos">332</span></a>      <span class="k">if</span> <span class="n">jnp</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">floating</span><span class="p">):</span>
</span><span id="ChannelNet.kernel_init-333"><a href="#ChannelNet.kernel_init-333"><span class="linenos">333</span></a>        <span class="c1"># constant is stddev of standard normal truncated to (-2, 2)</span>
</span><span id="ChannelNet.kernel_init-334"><a href="#ChannelNet.kernel_init-334"><span class="linenos">334</span></a>        <span class="n">stddev</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">.87962566103423978</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
</span><span id="ChannelNet.kernel_init-335"><a href="#ChannelNet.kernel_init-335"><span class="linenos">335</span></a>        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">truncated_normal</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">named_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="n">stddev</span>
</span><span id="ChannelNet.kernel_init-336"><a href="#ChannelNet.kernel_init-336"><span class="linenos">336</span></a>      <span class="k">else</span><span class="p">:</span>
</span><span id="ChannelNet.kernel_init-337"><a href="#ChannelNet.kernel_init-337"><span class="linenos">337</span></a>        <span class="c1"># constant is stddev of complex standard normal truncated to 2</span>
</span><span id="ChannelNet.kernel_init-338"><a href="#ChannelNet.kernel_init-338"><span class="linenos">338</span></a>        <span class="n">stddev</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">.95311164380491208</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
</span><span id="ChannelNet.kernel_init-339"><a href="#ChannelNet.kernel_init-339"><span class="linenos">339</span></a>        <span class="k">return</span> <span class="n">_complex_truncated_normal</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">named_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="n">stddev</span>
</span><span id="ChannelNet.kernel_init-340"><a href="#ChannelNet.kernel_init-340"><span class="linenos">340</span></a>    <span class="k">elif</span> <span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;normal&quot;</span><span class="p">:</span>
</span><span id="ChannelNet.kernel_init-341"><a href="#ChannelNet.kernel_init-341"><span class="linenos">341</span></a>      <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">named_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span>
</span><span id="ChannelNet.kernel_init-342"><a href="#ChannelNet.kernel_init-342"><span class="linenos">342</span></a>    <span class="k">elif</span> <span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;uniform&quot;</span><span class="p">:</span>
</span><span id="ChannelNet.kernel_init-343"><a href="#ChannelNet.kernel_init-343"><span class="linenos">343</span></a>      <span class="k">if</span> <span class="n">jnp</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">floating</span><span class="p">):</span>
</span><span id="ChannelNet.kernel_init-344"><a href="#ChannelNet.kernel_init-344"><span class="linenos">344</span></a>        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">named_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">variance</span><span class="p">)</span>
</span><span id="ChannelNet.kernel_init-345"><a href="#ChannelNet.kernel_init-345"><span class="linenos">345</span></a>      <span class="k">else</span><span class="p">:</span>
</span><span id="ChannelNet.kernel_init-346"><a href="#ChannelNet.kernel_init-346"><span class="linenos">346</span></a>        <span class="k">return</span> <span class="n">_complex_uniform</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">named_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span>
</span><span id="ChannelNet.kernel_init-347"><a href="#ChannelNet.kernel_init-347"><span class="linenos">347</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="ChannelNet.kernel_init-348"><a href="#ChannelNet.kernel_init-348"><span class="linenos">348</span></a>      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;invalid distribution for variance scaling initializer: </span><span class="si">{</span><span class="n">distribution</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="ChannelNet.channel_axis" class="classattr">
                                <div class="attr variable">
            <span class="name">channel_axis</span><span class="annotation">: int</span>        =
<span class="default_value">-2</span>

        
    </div>
    <a class="headerlink" href="#ChannelNet.channel_axis"></a>
    
    

                            </div>
                            <div id="ChannelNet.FID" class="classattr">
                                <div class="attr variable">
            <span class="name">FID</span><span class="annotation">: str</span>        =
<span class="default_value">&#39;CHANNEL_NET&#39;</span>

        
    </div>
    <a class="headerlink" href="#ChannelNet.FID"></a>
    
    

                            </div>
                            <div id="ChannelNet.parent" class="classattr">
                                <div class="attr variable">
            <span class="name">parent</span><span class="annotation">: Union[Type[flax.linen.module.Module], flax.core.scope.Scope, Type[flax.linen.module._Sentinel], NoneType]</span>

        
    </div>
    <a class="headerlink" href="#ChannelNet.parent"></a>
    
            <div class="docstring"><p>Wraps parent module references in weak refs.</p>

<p>This prevents reference cycles from forming via parent links which can lead
to accidental OOMs in eager mode due to slow garbage collection as well as
spurious tracer leaks during jit compilation.</p>

<p>Note: "descriptors" are the underlying python mechanism for implementing
dynamic @property decorators.  We need to use a raw descriptor instead of the
more common decorator in order to force that the appropriate getter/setter
logic applies in subclasses even after various dataclass transforms.</p>
</div>


                            </div>
                            <div id="ChannelNet.name" class="classattr">
                                <div class="attr variable">
            <span class="name">name</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ChannelNet.name"></a>
    
    

                            </div>
                            <div id="ChannelNet.scope" class="classattr">
                                <div class="attr variable">
            <span class="name">scope</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ChannelNet.scope"></a>
    
    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>flax.linen.module.Module</dt>
                                <dd id="ChannelNet.setup" class="function">setup</dd>
                <dd id="ChannelNet.path" class="variable">path</dd>
                <dd id="ChannelNet.clone" class="function">clone</dd>
                <dd id="ChannelNet.copy" class="function">copy</dd>
                <dd id="ChannelNet.variable" class="function">variable</dd>
                <dd id="ChannelNet.param" class="function">param</dd>
                <dd id="ChannelNet.has_variable" class="function">has_variable</dd>
                <dd id="ChannelNet.is_mutable_collection" class="function">is_mutable_collection</dd>
                <dd id="ChannelNet.has_rng" class="function">has_rng</dd>
                <dd id="ChannelNet.make_rng" class="function">make_rng</dd>
                <dd id="ChannelNet.is_initializing" class="function">is_initializing</dd>
                <dd id="ChannelNet.bind" class="function">bind</dd>
                <dd id="ChannelNet.unbind" class="function">unbind</dd>
                <dd id="ChannelNet.apply" class="function">apply</dd>
                <dd id="ChannelNet.init_with_output" class="function">init_with_output</dd>
                <dd id="ChannelNet.init" class="function">init</dd>
                <dd id="ChannelNet.lazy_init" class="function">lazy_init</dd>
                <dd id="ChannelNet.variables" class="variable">variables</dd>
                <dd id="ChannelNet.get_variable" class="function">get_variable</dd>
                <dd id="ChannelNet.put_variable" class="function">put_variable</dd>
                <dd id="ChannelNet.sow" class="function">sow</dd>
                <dd id="ChannelNet.perturb" class="function">perturb</dd>
                <dd id="ChannelNet.tabulate" class="function">tabulate</dd>
                <dd id="ChannelNet.module_paths" class="function">module_paths</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="GatedPerceptron">
                            <input id="GatedPerceptron-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">GatedPerceptron</span><wbr>(<span class="base">flax.linen.module.Module</span>):

                <label class="view-source-button" for="GatedPerceptron-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GatedPerceptron"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GatedPerceptron-638"><a href="#GatedPerceptron-638"><span class="linenos">638</span></a><span class="k">class</span> <span class="nc">GatedPerceptron</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="GatedPerceptron-639"><a href="#GatedPerceptron-639"><span class="linenos">639</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Gated Perceptron neural network.</span>
</span><span id="GatedPerceptron-640"><a href="#GatedPerceptron-640"><span class="linenos">640</span></a>
</span><span id="GatedPerceptron-641"><a href="#GatedPerceptron-641"><span class="linenos">641</span></a><span class="sd">    This class represents a Gated Perceptron neural network model. It applies a gating mechanism</span>
</span><span id="GatedPerceptron-642"><a href="#GatedPerceptron-642"><span class="linenos">642</span></a><span class="sd">    to the input data and performs linear transformation using a dense layer followed by an activation function.</span>
</span><span id="GatedPerceptron-643"><a href="#GatedPerceptron-643"><span class="linenos">643</span></a>
</span><span id="GatedPerceptron-644"><a href="#GatedPerceptron-644"><span class="linenos">644</span></a><span class="sd">    Parameters:</span>
</span><span id="GatedPerceptron-645"><a href="#GatedPerceptron-645"><span class="linenos">645</span></a><span class="sd">        dim (int): The dimensionality of the output space.</span>
</span><span id="GatedPerceptron-646"><a href="#GatedPerceptron-646"><span class="linenos">646</span></a><span class="sd">        use_bias (bool, optional): Whether to include a bias term in the dense layer. Defaults to True.</span>
</span><span id="GatedPerceptron-647"><a href="#GatedPerceptron-647"><span class="linenos">647</span></a><span class="sd">        kernel_init (Union[str, Callable], optional): The initializer for the kernel weights of the dense layer.</span>
</span><span id="GatedPerceptron-648"><a href="#GatedPerceptron-648"><span class="linenos">648</span></a><span class="sd">            It can be a string representing a predefined initializer or a custom initializer function.</span>
</span><span id="GatedPerceptron-649"><a href="#GatedPerceptron-649"><span class="linenos">649</span></a><span class="sd">            Defaults to nn.linear.default_kernel_init.</span>
</span><span id="GatedPerceptron-650"><a href="#GatedPerceptron-650"><span class="linenos">650</span></a><span class="sd">        activation (Union[Callable, str], optional): The activation function to be applied after the dense layer.</span>
</span><span id="GatedPerceptron-651"><a href="#GatedPerceptron-651"><span class="linenos">651</span></a><span class="sd">            It can be a string representing a predefined activation function or a custom activation function.</span>
</span><span id="GatedPerceptron-652"><a href="#GatedPerceptron-652"><span class="linenos">652</span></a><span class="sd">            Defaults to nn.silu.</span>
</span><span id="GatedPerceptron-653"><a href="#GatedPerceptron-653"><span class="linenos">653</span></a><span class="sd">        input_key (Optional[str], optional): The key to access the input data if it is a dictionary.</span>
</span><span id="GatedPerceptron-654"><a href="#GatedPerceptron-654"><span class="linenos">654</span></a><span class="sd">            If None, assumes the input data is not a dictionary. Defaults to None.</span>
</span><span id="GatedPerceptron-655"><a href="#GatedPerceptron-655"><span class="linenos">655</span></a><span class="sd">        output_key (Optional[str], optional): The key to store the output data in the dictionary if input_key is not None.</span>
</span><span id="GatedPerceptron-656"><a href="#GatedPerceptron-656"><span class="linenos">656</span></a><span class="sd">            If None, uses the name of the module as the output key. Defaults to None.</span>
</span><span id="GatedPerceptron-657"><a href="#GatedPerceptron-657"><span class="linenos">657</span></a><span class="sd">        squeeze (bool, optional): Whether to squeeze the output tensor if its last dimension is 1. Defaults to False.</span>
</span><span id="GatedPerceptron-658"><a href="#GatedPerceptron-658"><span class="linenos">658</span></a>
</span><span id="GatedPerceptron-659"><a href="#GatedPerceptron-659"><span class="linenos">659</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="GatedPerceptron-660"><a href="#GatedPerceptron-660"><span class="linenos">660</span></a>
</span><span id="GatedPerceptron-661"><a href="#GatedPerceptron-661"><span class="linenos">661</span></a>    <span class="n">dim</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="GatedPerceptron-662"><a href="#GatedPerceptron-662"><span class="linenos">662</span></a>    <span class="n">use_bias</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="GatedPerceptron-663"><a href="#GatedPerceptron-663"><span class="linenos">663</span></a>    <span class="n">kernel_init</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">default_kernel_init</span>
</span><span id="GatedPerceptron-664"><a href="#GatedPerceptron-664"><span class="linenos">664</span></a>    <span class="n">activation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">silu</span>
</span><span id="GatedPerceptron-665"><a href="#GatedPerceptron-665"><span class="linenos">665</span></a>    <span class="n">input_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="GatedPerceptron-666"><a href="#GatedPerceptron-666"><span class="linenos">666</span></a>    <span class="n">output_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="GatedPerceptron-667"><a href="#GatedPerceptron-667"><span class="linenos">667</span></a>    <span class="n">squeeze</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="GatedPerceptron-668"><a href="#GatedPerceptron-668"><span class="linenos">668</span></a>
</span><span id="GatedPerceptron-669"><a href="#GatedPerceptron-669"><span class="linenos">669</span></a>    <span class="n">FID</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;GATED_PERCEPTRON&quot;</span>
</span><span id="GatedPerceptron-670"><a href="#GatedPerceptron-670"><span class="linenos">670</span></a>
</span><span id="GatedPerceptron-671"><a href="#GatedPerceptron-671"><span class="linenos">671</span></a>    <span class="nd">@nn</span><span class="o">.</span><span class="n">compact</span>
</span><span id="GatedPerceptron-672"><a href="#GatedPerceptron-672"><span class="linenos">672</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
</span><span id="GatedPerceptron-673"><a href="#GatedPerceptron-673"><span class="linenos">673</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="GatedPerceptron-674"><a href="#GatedPerceptron-674"><span class="linenos">674</span></a>            <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
</span><span id="GatedPerceptron-675"><a href="#GatedPerceptron-675"><span class="linenos">675</span></a>                <span class="n">inputs</span><span class="p">,</span> <span class="nb">dict</span>
</span><span id="GatedPerceptron-676"><a href="#GatedPerceptron-676"><span class="linenos">676</span></a>            <span class="p">),</span> <span class="s2">&quot;input key must be provided if inputs is a dictionary&quot;</span>
</span><span id="GatedPerceptron-677"><a href="#GatedPerceptron-677"><span class="linenos">677</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">inputs</span>
</span><span id="GatedPerceptron-678"><a href="#GatedPerceptron-678"><span class="linenos">678</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="GatedPerceptron-679"><a href="#GatedPerceptron-679"><span class="linenos">679</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">input_key</span><span class="p">]</span>
</span><span id="GatedPerceptron-680"><a href="#GatedPerceptron-680"><span class="linenos">680</span></a>
</span><span id="GatedPerceptron-681"><a href="#GatedPerceptron-681"><span class="linenos">681</span></a>        <span class="n">activation</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="GatedPerceptron-682"><a href="#GatedPerceptron-682"><span class="linenos">682</span></a>            <span class="n">activation_from_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">)</span>
</span><span id="GatedPerceptron-683"><a href="#GatedPerceptron-683"><span class="linenos">683</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
</span><span id="GatedPerceptron-684"><a href="#GatedPerceptron-684"><span class="linenos">684</span></a>            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">activation</span>
</span><span id="GatedPerceptron-685"><a href="#GatedPerceptron-685"><span class="linenos">685</span></a>        <span class="p">)</span>
</span><span id="GatedPerceptron-686"><a href="#GatedPerceptron-686"><span class="linenos">686</span></a>        <span class="n">kernel_init</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="GatedPerceptron-687"><a href="#GatedPerceptron-687"><span class="linenos">687</span></a>            <span class="n">initializer_from_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_init</span><span class="p">)</span>
</span><span id="GatedPerceptron-688"><a href="#GatedPerceptron-688"><span class="linenos">688</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_init</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
</span><span id="GatedPerceptron-689"><a href="#GatedPerceptron-689"><span class="linenos">689</span></a>            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel_init</span>
</span><span id="GatedPerceptron-690"><a href="#GatedPerceptron-690"><span class="linenos">690</span></a>        <span class="p">)</span>
</span><span id="GatedPerceptron-691"><a href="#GatedPerceptron-691"><span class="linenos">691</span></a>        <span class="c1">############################</span>
</span><span id="GatedPerceptron-692"><a href="#GatedPerceptron-692"><span class="linenos">692</span></a>        <span class="n">gate</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span>
</span><span id="GatedPerceptron-693"><a href="#GatedPerceptron-693"><span class="linenos">693</span></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">,</span> <span class="n">use_bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_bias</span><span class="p">,</span> <span class="n">kernel_init</span><span class="o">=</span><span class="n">kernel_init</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
</span><span id="GatedPerceptron-694"><a href="#GatedPerceptron-694"><span class="linenos">694</span></a>        <span class="p">)</span>
</span><span id="GatedPerceptron-695"><a href="#GatedPerceptron-695"><span class="linenos">695</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">gate</span> <span class="o">*</span> <span class="n">activation</span><span class="p">(</span>
</span><span id="GatedPerceptron-696"><a href="#GatedPerceptron-696"><span class="linenos">696</span></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">,</span> <span class="n">use_bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_bias</span><span class="p">,</span> <span class="n">kernel_init</span><span class="o">=</span><span class="n">kernel_init</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
</span><span id="GatedPerceptron-697"><a href="#GatedPerceptron-697"><span class="linenos">697</span></a>        <span class="p">)</span>
</span><span id="GatedPerceptron-698"><a href="#GatedPerceptron-698"><span class="linenos">698</span></a>
</span><span id="GatedPerceptron-699"><a href="#GatedPerceptron-699"><span class="linenos">699</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">squeeze</span> <span class="ow">and</span> <span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="GatedPerceptron-700"><a href="#GatedPerceptron-700"><span class="linenos">700</span></a>            <span class="n">out</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="GatedPerceptron-701"><a href="#GatedPerceptron-701"><span class="linenos">701</span></a>        <span class="c1">############################</span>
</span><span id="GatedPerceptron-702"><a href="#GatedPerceptron-702"><span class="linenos">702</span></a>
</span><span id="GatedPerceptron-703"><a href="#GatedPerceptron-703"><span class="linenos">703</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="GatedPerceptron-704"><a href="#GatedPerceptron-704"><span class="linenos">704</span></a>            <span class="n">output_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_key</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_key</span>
</span><span id="GatedPerceptron-705"><a href="#GatedPerceptron-705"><span class="linenos">705</span></a>            <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="n">output_key</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span> <span class="k">if</span> <span class="n">output_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">x</span>
</span><span id="GatedPerceptron-706"><a href="#GatedPerceptron-706"><span class="linenos">706</span></a>        <span class="k">return</span> <span class="n">x</span>
</span></pre></div>


            <div class="docstring"><p>Gated Perceptron neural network.</p>

<p>This class represents a Gated Perceptron neural network model. It applies a gating mechanism
to the input data and performs linear transformation using a dense layer followed by an activation function.</p>

<p>Parameters:
    dim (int): The dimensionality of the output space.
    use_bias (bool, optional): Whether to include a bias term in the dense layer. Defaults to True.
    kernel_init (Union[str, Callable], optional): The initializer for the kernel weights of the dense layer.
        It can be a string representing a predefined initializer or a custom initializer function.
        Defaults to nn.linear.default_kernel_init.
    activation (Union[Callable, str], optional): The activation function to be applied after the dense layer.
        It can be a string representing a predefined activation function or a custom activation function.
        Defaults to nn.silu.
    input_key (Optional[str], optional): The key to access the input data if it is a dictionary.
        If None, assumes the input data is not a dictionary. Defaults to None.
    output_key (Optional[str], optional): The key to store the output data in the dictionary if input_key is not None.
        If None, uses the name of the module as the output key. Defaults to None.
    squeeze (bool, optional): Whether to squeeze the output tensor if its last dimension is 1. Defaults to False.</p>
</div>


                            <div id="GatedPerceptron.__init__" class="classattr">
                                <div class="attr function">
            
        <span class="name">GatedPerceptron</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">dim</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">use_bias</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">kernel_init</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">variance_scaling</span><span class="o">.&lt;</span><span class="nb">locals</span><span class="o">&gt;.</span><span class="n">init</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">activation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">PjitFunction</span> <span class="n">of</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">silu</span><span class="o">&gt;&gt;</span>,</span><span class="param">	<span class="n">input_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">output_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">squeeze</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">FID</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;GATED_PERCEPTRON&#39;</span>,</span><span class="param">	<span class="n">parent</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">flax</span><span class="o">.</span><span class="n">linen</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">Module</span><span class="p">],</span> <span class="n">flax</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">Scope</span><span class="p">,</span> <span class="n">Type</span><span class="p">[</span><span class="n">flax</span><span class="o">.</span><span class="n">linen</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">_Sentinel</span><span class="p">],</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">flax</span><span class="o">.</span><span class="n">linen</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">_Sentinel</span> <span class="nb">object</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

        
    </div>
    <a class="headerlink" href="#GatedPerceptron.__init__"></a>
    
    

                            </div>
                            <div id="GatedPerceptron.dim" class="classattr">
                                <div class="attr variable">
            <span class="name">dim</span><span class="annotation">: int</span>

        
    </div>
    <a class="headerlink" href="#GatedPerceptron.dim"></a>
    
    

                            </div>
                            <div id="GatedPerceptron.use_bias" class="classattr">
                                <div class="attr variable">
            <span class="name">use_bias</span><span class="annotation">: bool</span>        =
<span class="default_value">True</span>

        
    </div>
    <a class="headerlink" href="#GatedPerceptron.use_bias"></a>
    
    

                            </div>
                            <div id="GatedPerceptron.kernel_init" class="classattr">
                                        <input id="GatedPerceptron.kernel_init-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">kernel_init</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">key</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span>,</span><span class="param">	<span class="n">shape</span><span class="p">:</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]]</span>,</span><span class="param">	dtype: Any = &lt;class &#x27;jax.numpy.float64&#x27;&gt;</span><span class="return-annotation">) -> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span>:</span></span>

                <label class="view-source-button" for="GatedPerceptron.kernel_init-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GatedPerceptron.kernel_init"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GatedPerceptron.kernel_init-317"><a href="#GatedPerceptron.kernel_init-317"><span class="linenos">317</span></a>  <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">KeyArray</span><span class="p">,</span>
</span><span id="GatedPerceptron.kernel_init-318"><a href="#GatedPerceptron.kernel_init-318"><span class="linenos">318</span></a>           <span class="n">shape</span><span class="p">:</span> <span class="n">core</span><span class="o">.</span><span class="n">Shape</span><span class="p">,</span>
</span><span id="GatedPerceptron.kernel_init-319"><a href="#GatedPerceptron.kernel_init-319"><span class="linenos">319</span></a>           <span class="n">dtype</span><span class="p">:</span> <span class="n">DTypeLikeInexact</span> <span class="o">=</span> <span class="n">dtype</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="p">:</span>
</span><span id="GatedPerceptron.kernel_init-320"><a href="#GatedPerceptron.kernel_init-320"><span class="linenos">320</span></a>    <span class="n">dtype</span> <span class="o">=</span> <span class="n">dtypes</span><span class="o">.</span><span class="n">canonicalize_dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="GatedPerceptron.kernel_init-321"><a href="#GatedPerceptron.kernel_init-321"><span class="linenos">321</span></a>    <span class="n">named_shape</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">as_named_shape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
</span><span id="GatedPerceptron.kernel_init-322"><a href="#GatedPerceptron.kernel_init-322"><span class="linenos">322</span></a>    <span class="n">fan_in</span><span class="p">,</span> <span class="n">fan_out</span> <span class="o">=</span> <span class="n">_compute_fans</span><span class="p">(</span><span class="n">named_shape</span><span class="p">,</span> <span class="n">in_axis</span><span class="p">,</span> <span class="n">out_axis</span><span class="p">,</span> <span class="n">batch_axis</span><span class="p">)</span>
</span><span id="GatedPerceptron.kernel_init-323"><a href="#GatedPerceptron.kernel_init-323"><span class="linenos">323</span></a>    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;fan_in&quot;</span><span class="p">:</span> <span class="n">denominator</span> <span class="o">=</span> <span class="n">fan_in</span>
</span><span id="GatedPerceptron.kernel_init-324"><a href="#GatedPerceptron.kernel_init-324"><span class="linenos">324</span></a>    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;fan_out&quot;</span><span class="p">:</span> <span class="n">denominator</span> <span class="o">=</span> <span class="n">fan_out</span>
</span><span id="GatedPerceptron.kernel_init-325"><a href="#GatedPerceptron.kernel_init-325"><span class="linenos">325</span></a>    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;fan_avg&quot;</span><span class="p">:</span> <span class="n">denominator</span> <span class="o">=</span> <span class="p">(</span><span class="n">fan_in</span> <span class="o">+</span> <span class="n">fan_out</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="GatedPerceptron.kernel_init-326"><a href="#GatedPerceptron.kernel_init-326"><span class="linenos">326</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="GatedPerceptron.kernel_init-327"><a href="#GatedPerceptron.kernel_init-327"><span class="linenos">327</span></a>      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="GatedPerceptron.kernel_init-328"><a href="#GatedPerceptron.kernel_init-328"><span class="linenos">328</span></a>        <span class="sa">f</span><span class="s2">&quot;invalid mode for variance scaling initializer: </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="GatedPerceptron.kernel_init-329"><a href="#GatedPerceptron.kernel_init-329"><span class="linenos">329</span></a>    <span class="n">variance</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">scale</span> <span class="o">/</span> <span class="n">denominator</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="GatedPerceptron.kernel_init-330"><a href="#GatedPerceptron.kernel_init-330"><span class="linenos">330</span></a>
</span><span id="GatedPerceptron.kernel_init-331"><a href="#GatedPerceptron.kernel_init-331"><span class="linenos">331</span></a>    <span class="k">if</span> <span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;truncated_normal&quot;</span><span class="p">:</span>
</span><span id="GatedPerceptron.kernel_init-332"><a href="#GatedPerceptron.kernel_init-332"><span class="linenos">332</span></a>      <span class="k">if</span> <span class="n">jnp</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">floating</span><span class="p">):</span>
</span><span id="GatedPerceptron.kernel_init-333"><a href="#GatedPerceptron.kernel_init-333"><span class="linenos">333</span></a>        <span class="c1"># constant is stddev of standard normal truncated to (-2, 2)</span>
</span><span id="GatedPerceptron.kernel_init-334"><a href="#GatedPerceptron.kernel_init-334"><span class="linenos">334</span></a>        <span class="n">stddev</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">.87962566103423978</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
</span><span id="GatedPerceptron.kernel_init-335"><a href="#GatedPerceptron.kernel_init-335"><span class="linenos">335</span></a>        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">truncated_normal</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">named_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="n">stddev</span>
</span><span id="GatedPerceptron.kernel_init-336"><a href="#GatedPerceptron.kernel_init-336"><span class="linenos">336</span></a>      <span class="k">else</span><span class="p">:</span>
</span><span id="GatedPerceptron.kernel_init-337"><a href="#GatedPerceptron.kernel_init-337"><span class="linenos">337</span></a>        <span class="c1"># constant is stddev of complex standard normal truncated to 2</span>
</span><span id="GatedPerceptron.kernel_init-338"><a href="#GatedPerceptron.kernel_init-338"><span class="linenos">338</span></a>        <span class="n">stddev</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">.95311164380491208</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
</span><span id="GatedPerceptron.kernel_init-339"><a href="#GatedPerceptron.kernel_init-339"><span class="linenos">339</span></a>        <span class="k">return</span> <span class="n">_complex_truncated_normal</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">named_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="n">stddev</span>
</span><span id="GatedPerceptron.kernel_init-340"><a href="#GatedPerceptron.kernel_init-340"><span class="linenos">340</span></a>    <span class="k">elif</span> <span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;normal&quot;</span><span class="p">:</span>
</span><span id="GatedPerceptron.kernel_init-341"><a href="#GatedPerceptron.kernel_init-341"><span class="linenos">341</span></a>      <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">named_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span>
</span><span id="GatedPerceptron.kernel_init-342"><a href="#GatedPerceptron.kernel_init-342"><span class="linenos">342</span></a>    <span class="k">elif</span> <span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;uniform&quot;</span><span class="p">:</span>
</span><span id="GatedPerceptron.kernel_init-343"><a href="#GatedPerceptron.kernel_init-343"><span class="linenos">343</span></a>      <span class="k">if</span> <span class="n">jnp</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">floating</span><span class="p">):</span>
</span><span id="GatedPerceptron.kernel_init-344"><a href="#GatedPerceptron.kernel_init-344"><span class="linenos">344</span></a>        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">named_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">variance</span><span class="p">)</span>
</span><span id="GatedPerceptron.kernel_init-345"><a href="#GatedPerceptron.kernel_init-345"><span class="linenos">345</span></a>      <span class="k">else</span><span class="p">:</span>
</span><span id="GatedPerceptron.kernel_init-346"><a href="#GatedPerceptron.kernel_init-346"><span class="linenos">346</span></a>        <span class="k">return</span> <span class="n">_complex_uniform</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">named_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span>
</span><span id="GatedPerceptron.kernel_init-347"><a href="#GatedPerceptron.kernel_init-347"><span class="linenos">347</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="GatedPerceptron.kernel_init-348"><a href="#GatedPerceptron.kernel_init-348"><span class="linenos">348</span></a>      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;invalid distribution for variance scaling initializer: </span><span class="si">{</span><span class="n">distribution</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="GatedPerceptron.activation" class="classattr">
                                        <input id="GatedPerceptron.activation-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@jax.jit</div>

        <span class="def">def</span>
        <span class="name">activation</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">x</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">bool_</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span>:</span></span>

                <label class="view-source-button" for="GatedPerceptron.activation-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GatedPerceptron.activation"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GatedPerceptron.activation-151"><a href="#GatedPerceptron.activation-151"><span class="linenos">151</span></a><span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
</span><span id="GatedPerceptron.activation-152"><a href="#GatedPerceptron.activation-152"><span class="linenos">152</span></a><span class="k">def</span> <span class="nf">silu</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="p">:</span>
</span><span id="GatedPerceptron.activation-153"><a href="#GatedPerceptron.activation-153"><span class="linenos">153</span></a><span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;SiLU (a.k.a. swish) activation function.</span>
</span><span id="GatedPerceptron.activation-154"><a href="#GatedPerceptron.activation-154"><span class="linenos">154</span></a>
</span><span id="GatedPerceptron.activation-155"><a href="#GatedPerceptron.activation-155"><span class="linenos">155</span></a><span class="sd">  Computes the element-wise function:</span>
</span><span id="GatedPerceptron.activation-156"><a href="#GatedPerceptron.activation-156"><span class="linenos">156</span></a>
</span><span id="GatedPerceptron.activation-157"><a href="#GatedPerceptron.activation-157"><span class="linenos">157</span></a><span class="sd">  .. math::</span>
</span><span id="GatedPerceptron.activation-158"><a href="#GatedPerceptron.activation-158"><span class="linenos">158</span></a><span class="sd">    \mathrm{silu}(x) = x \cdot \mathrm{sigmoid}(x) = \frac{x}{1 + e^{-x}}</span>
</span><span id="GatedPerceptron.activation-159"><a href="#GatedPerceptron.activation-159"><span class="linenos">159</span></a>
</span><span id="GatedPerceptron.activation-160"><a href="#GatedPerceptron.activation-160"><span class="linenos">160</span></a><span class="sd">  :func:`swish` and :func:`silu` are both aliases for the same function.</span>
</span><span id="GatedPerceptron.activation-161"><a href="#GatedPerceptron.activation-161"><span class="linenos">161</span></a>
</span><span id="GatedPerceptron.activation-162"><a href="#GatedPerceptron.activation-162"><span class="linenos">162</span></a><span class="sd">  Args:</span>
</span><span id="GatedPerceptron.activation-163"><a href="#GatedPerceptron.activation-163"><span class="linenos">163</span></a><span class="sd">    x : input array</span>
</span><span id="GatedPerceptron.activation-164"><a href="#GatedPerceptron.activation-164"><span class="linenos">164</span></a>
</span><span id="GatedPerceptron.activation-165"><a href="#GatedPerceptron.activation-165"><span class="linenos">165</span></a><span class="sd">  Returns:</span>
</span><span id="GatedPerceptron.activation-166"><a href="#GatedPerceptron.activation-166"><span class="linenos">166</span></a><span class="sd">    An array.</span>
</span><span id="GatedPerceptron.activation-167"><a href="#GatedPerceptron.activation-167"><span class="linenos">167</span></a>
</span><span id="GatedPerceptron.activation-168"><a href="#GatedPerceptron.activation-168"><span class="linenos">168</span></a><span class="sd">  See also:</span>
</span><span id="GatedPerceptron.activation-169"><a href="#GatedPerceptron.activation-169"><span class="linenos">169</span></a><span class="sd">    :func:`sigmoid`</span>
</span><span id="GatedPerceptron.activation-170"><a href="#GatedPerceptron.activation-170"><span class="linenos">170</span></a><span class="sd">  &quot;&quot;&quot;</span>
</span><span id="GatedPerceptron.activation-171"><a href="#GatedPerceptron.activation-171"><span class="linenos">171</span></a>  <span class="n">numpy_util</span><span class="o">.</span><span class="n">check_arraylike</span><span class="p">(</span><span class="s2">&quot;silu&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span><span id="GatedPerceptron.activation-172"><a href="#GatedPerceptron.activation-172"><span class="linenos">172</span></a>  <span class="n">x_arr</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="GatedPerceptron.activation-173"><a href="#GatedPerceptron.activation-173"><span class="linenos">173</span></a>  <span class="k">return</span> <span class="n">x_arr</span> <span class="o">*</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">x_arr</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>SiLU (a.k.a. swish) activation function.</p>

<p>Computes the element-wise function:</p>

<p>$$\mathrm{silu}(x) = x \cdot \mathrm{sigmoid}(x) = \frac{x}{1 + e^{-x}}$$</p>

<p><code>swish()</code> and <code>silu()</code> are both aliases for the same function.</p>

<p>Args:
  x : input array</p>

<p>Returns:
  An array.</p>

<p>See also:
  <code>sigmoid()</code></p>
</div>


                            </div>
                            <div id="GatedPerceptron.input_key" class="classattr">
                                <div class="attr variable">
            <span class="name">input_key</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#GatedPerceptron.input_key"></a>
    
    

                            </div>
                            <div id="GatedPerceptron.output_key" class="classattr">
                                <div class="attr variable">
            <span class="name">output_key</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#GatedPerceptron.output_key"></a>
    
    

                            </div>
                            <div id="GatedPerceptron.squeeze" class="classattr">
                                <div class="attr variable">
            <span class="name">squeeze</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#GatedPerceptron.squeeze"></a>
    
    

                            </div>
                            <div id="GatedPerceptron.FID" class="classattr">
                                <div class="attr variable">
            <span class="name">FID</span><span class="annotation">: str</span>        =
<span class="default_value">&#39;GATED_PERCEPTRON&#39;</span>

        
    </div>
    <a class="headerlink" href="#GatedPerceptron.FID"></a>
    
    

                            </div>
                            <div id="GatedPerceptron.parent" class="classattr">
                                <div class="attr variable">
            <span class="name">parent</span><span class="annotation">: Union[Type[flax.linen.module.Module], flax.core.scope.Scope, Type[flax.linen.module._Sentinel], NoneType]</span>

        
    </div>
    <a class="headerlink" href="#GatedPerceptron.parent"></a>
    
            <div class="docstring"><p>Wraps parent module references in weak refs.</p>

<p>This prevents reference cycles from forming via parent links which can lead
to accidental OOMs in eager mode due to slow garbage collection as well as
spurious tracer leaks during jit compilation.</p>

<p>Note: "descriptors" are the underlying python mechanism for implementing
dynamic @property decorators.  We need to use a raw descriptor instead of the
more common decorator in order to force that the appropriate getter/setter
logic applies in subclasses even after various dataclass transforms.</p>
</div>


                            </div>
                            <div id="GatedPerceptron.name" class="classattr">
                                <div class="attr variable">
            <span class="name">name</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#GatedPerceptron.name"></a>
    
    

                            </div>
                            <div id="GatedPerceptron.scope" class="classattr">
                                <div class="attr variable">
            <span class="name">scope</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#GatedPerceptron.scope"></a>
    
    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>flax.linen.module.Module</dt>
                                <dd id="GatedPerceptron.setup" class="function">setup</dd>
                <dd id="GatedPerceptron.path" class="variable">path</dd>
                <dd id="GatedPerceptron.clone" class="function">clone</dd>
                <dd id="GatedPerceptron.copy" class="function">copy</dd>
                <dd id="GatedPerceptron.variable" class="function">variable</dd>
                <dd id="GatedPerceptron.param" class="function">param</dd>
                <dd id="GatedPerceptron.has_variable" class="function">has_variable</dd>
                <dd id="GatedPerceptron.is_mutable_collection" class="function">is_mutable_collection</dd>
                <dd id="GatedPerceptron.has_rng" class="function">has_rng</dd>
                <dd id="GatedPerceptron.make_rng" class="function">make_rng</dd>
                <dd id="GatedPerceptron.is_initializing" class="function">is_initializing</dd>
                <dd id="GatedPerceptron.bind" class="function">bind</dd>
                <dd id="GatedPerceptron.unbind" class="function">unbind</dd>
                <dd id="GatedPerceptron.apply" class="function">apply</dd>
                <dd id="GatedPerceptron.init_with_output" class="function">init_with_output</dd>
                <dd id="GatedPerceptron.init" class="function">init</dd>
                <dd id="GatedPerceptron.lazy_init" class="function">lazy_init</dd>
                <dd id="GatedPerceptron.variables" class="variable">variables</dd>
                <dd id="GatedPerceptron.get_variable" class="function">get_variable</dd>
                <dd id="GatedPerceptron.put_variable" class="function">put_variable</dd>
                <dd id="GatedPerceptron.sow" class="function">sow</dd>
                <dd id="GatedPerceptron.perturb" class="function">perturb</dd>
                <dd id="GatedPerceptron.tabulate" class="function">tabulate</dd>
                <dd id="GatedPerceptron.module_paths" class="function">module_paths</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="ZAcNet">
                            <input id="ZAcNet-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">ZAcNet</span><wbr>(<span class="base">flax.linen.module.Module</span>):

                <label class="view-source-button" for="ZAcNet-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ZAcNet"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ZAcNet-709"><a href="#ZAcNet-709"><span class="linenos">709</span></a><span class="k">class</span> <span class="nc">ZAcNet</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="ZAcNet-710"><a href="#ZAcNet-710"><span class="linenos">710</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ZAcNet-711"><a href="#ZAcNet-711"><span class="linenos">711</span></a><span class="sd">    A fully connected neural network module with affine Z-dependent adjustments of activations.</span>
</span><span id="ZAcNet-712"><a href="#ZAcNet-712"><span class="linenos">712</span></a>
</span><span id="ZAcNet-713"><a href="#ZAcNet-713"><span class="linenos">713</span></a><span class="sd">    Parameters:</span>
</span><span id="ZAcNet-714"><a href="#ZAcNet-714"><span class="linenos">714</span></a><span class="sd">        neurons (Sequence[int]): A sequence of integers representing the dimensions of the network.</span>
</span><span id="ZAcNet-715"><a href="#ZAcNet-715"><span class="linenos">715</span></a><span class="sd">        zmax (int): The maximum atomic number to consider.</span>
</span><span id="ZAcNet-716"><a href="#ZAcNet-716"><span class="linenos">716</span></a><span class="sd">        activation (Union[Callable, str], optional): The activation function to use. Defaults to nn.silu.</span>
</span><span id="ZAcNet-717"><a href="#ZAcNet-717"><span class="linenos">717</span></a><span class="sd">        use_bias (bool, optional): Whether to use bias in the dense layers. Defaults to True.</span>
</span><span id="ZAcNet-718"><a href="#ZAcNet-718"><span class="linenos">718</span></a><span class="sd">        input_key (Optional[str], optional): The key to use to access the input tensor. Defaults to None.</span>
</span><span id="ZAcNet-719"><a href="#ZAcNet-719"><span class="linenos">719</span></a><span class="sd">        output_key (Optional[str], optional): The key to use to access the output tensor. Defaults to None.</span>
</span><span id="ZAcNet-720"><a href="#ZAcNet-720"><span class="linenos">720</span></a><span class="sd">        squeeze (bool, optional): Whether to squeeze the output tensor if its shape is (..., 1). Defaults to False.</span>
</span><span id="ZAcNet-721"><a href="#ZAcNet-721"><span class="linenos">721</span></a><span class="sd">        kernel_init (Union[str, Callable], optional): The kernel initialization method to use. Defaults to nn.linear.default_kernel_init.</span>
</span><span id="ZAcNet-722"><a href="#ZAcNet-722"><span class="linenos">722</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="ZAcNet-723"><a href="#ZAcNet-723"><span class="linenos">723</span></a>
</span><span id="ZAcNet-724"><a href="#ZAcNet-724"><span class="linenos">724</span></a>    <span class="n">neurons</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
</span><span id="ZAcNet-725"><a href="#ZAcNet-725"><span class="linenos">725</span></a>    <span class="n">zmax</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">86</span>
</span><span id="ZAcNet-726"><a href="#ZAcNet-726"><span class="linenos">726</span></a>    <span class="n">activation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">silu</span>
</span><span id="ZAcNet-727"><a href="#ZAcNet-727"><span class="linenos">727</span></a>    <span class="n">use_bias</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ZAcNet-728"><a href="#ZAcNet-728"><span class="linenos">728</span></a>    <span class="n">input_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ZAcNet-729"><a href="#ZAcNet-729"><span class="linenos">729</span></a>    <span class="n">output_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ZAcNet-730"><a href="#ZAcNet-730"><span class="linenos">730</span></a>    <span class="n">squeeze</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ZAcNet-731"><a href="#ZAcNet-731"><span class="linenos">731</span></a>    <span class="n">kernel_init</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">default_kernel_init</span>
</span><span id="ZAcNet-732"><a href="#ZAcNet-732"><span class="linenos">732</span></a>
</span><span id="ZAcNet-733"><a href="#ZAcNet-733"><span class="linenos">733</span></a>    <span class="n">FID</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;ZACNET&quot;</span>
</span><span id="ZAcNet-734"><a href="#ZAcNet-734"><span class="linenos">734</span></a>
</span><span id="ZAcNet-735"><a href="#ZAcNet-735"><span class="linenos">735</span></a>    <span class="nd">@nn</span><span class="o">.</span><span class="n">compact</span>
</span><span id="ZAcNet-736"><a href="#ZAcNet-736"><span class="linenos">736</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">]:</span>
</span><span id="ZAcNet-737"><a href="#ZAcNet-737"><span class="linenos">737</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ZAcNet-738"><a href="#ZAcNet-738"><span class="linenos">738</span></a>            <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
</span><span id="ZAcNet-739"><a href="#ZAcNet-739"><span class="linenos">739</span></a>                <span class="n">inputs</span><span class="p">,</span> <span class="nb">dict</span>
</span><span id="ZAcNet-740"><a href="#ZAcNet-740"><span class="linenos">740</span></a>            <span class="p">),</span> <span class="s2">&quot;input key must be provided if inputs is a dictionary&quot;</span>
</span><span id="ZAcNet-741"><a href="#ZAcNet-741"><span class="linenos">741</span></a>            <span class="n">species</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">inputs</span>
</span><span id="ZAcNet-742"><a href="#ZAcNet-742"><span class="linenos">742</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ZAcNet-743"><a href="#ZAcNet-743"><span class="linenos">743</span></a>            <span class="n">species</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">],</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">input_key</span><span class="p">]</span>
</span><span id="ZAcNet-744"><a href="#ZAcNet-744"><span class="linenos">744</span></a>
</span><span id="ZAcNet-745"><a href="#ZAcNet-745"><span class="linenos">745</span></a>        <span class="n">activation</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="ZAcNet-746"><a href="#ZAcNet-746"><span class="linenos">746</span></a>            <span class="n">activation_from_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">)</span>
</span><span id="ZAcNet-747"><a href="#ZAcNet-747"><span class="linenos">747</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
</span><span id="ZAcNet-748"><a href="#ZAcNet-748"><span class="linenos">748</span></a>            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">activation</span>
</span><span id="ZAcNet-749"><a href="#ZAcNet-749"><span class="linenos">749</span></a>        <span class="p">)</span>
</span><span id="ZAcNet-750"><a href="#ZAcNet-750"><span class="linenos">750</span></a>        <span class="n">kernel_init</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="ZAcNet-751"><a href="#ZAcNet-751"><span class="linenos">751</span></a>            <span class="n">initializer_from_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_init</span><span class="p">)</span>
</span><span id="ZAcNet-752"><a href="#ZAcNet-752"><span class="linenos">752</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_init</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
</span><span id="ZAcNet-753"><a href="#ZAcNet-753"><span class="linenos">753</span></a>            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel_init</span>
</span><span id="ZAcNet-754"><a href="#ZAcNet-754"><span class="linenos">754</span></a>        <span class="p">)</span>
</span><span id="ZAcNet-755"><a href="#ZAcNet-755"><span class="linenos">755</span></a>        <span class="c1">############################</span>
</span><span id="ZAcNet-756"><a href="#ZAcNet-756"><span class="linenos">756</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">neurons</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
</span><span id="ZAcNet-757"><a href="#ZAcNet-757"><span class="linenos">757</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span>
</span><span id="ZAcNet-758"><a href="#ZAcNet-758"><span class="linenos">758</span></a>                <span class="n">d</span><span class="p">,</span> <span class="n">use_bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_bias</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Layer_</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">kernel_init</span><span class="o">=</span><span class="n">kernel_init</span>
</span><span id="ZAcNet-759"><a href="#ZAcNet-759"><span class="linenos">759</span></a>            <span class="p">)(</span><span class="n">x</span><span class="p">)</span>
</span><span id="ZAcNet-760"><a href="#ZAcNet-760"><span class="linenos">760</span></a>            <span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">(</span>
</span><span id="ZAcNet-761"><a href="#ZAcNet-761"><span class="linenos">761</span></a>                <span class="sa">f</span><span class="s2">&quot;sig_</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="ZAcNet-762"><a href="#ZAcNet-762"><span class="linenos">762</span></a>                <span class="k">lambda</span> <span class="n">key</span><span class="p">,</span> <span class="n">shape</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
</span><span id="ZAcNet-763"><a href="#ZAcNet-763"><span class="linenos">763</span></a>                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zmax</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">d</span><span class="p">),</span>
</span><span id="ZAcNet-764"><a href="#ZAcNet-764"><span class="linenos">764</span></a>            <span class="p">)[</span><span class="n">species</span><span class="p">]</span>
</span><span id="ZAcNet-765"><a href="#ZAcNet-765"><span class="linenos">765</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_bias</span><span class="p">:</span>
</span><span id="ZAcNet-766"><a href="#ZAcNet-766"><span class="linenos">766</span></a>                <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">(</span>
</span><span id="ZAcNet-767"><a href="#ZAcNet-767"><span class="linenos">767</span></a>                    <span class="sa">f</span><span class="s2">&quot;b_</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="ZAcNet-768"><a href="#ZAcNet-768"><span class="linenos">768</span></a>                    <span class="k">lambda</span> <span class="n">key</span><span class="p">,</span> <span class="n">shape</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
</span><span id="ZAcNet-769"><a href="#ZAcNet-769"><span class="linenos">769</span></a>                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zmax</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">d</span><span class="p">),</span>
</span><span id="ZAcNet-770"><a href="#ZAcNet-770"><span class="linenos">770</span></a>                <span class="p">)[</span><span class="n">species</span><span class="p">]</span>
</span><span id="ZAcNet-771"><a href="#ZAcNet-771"><span class="linenos">771</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ZAcNet-772"><a href="#ZAcNet-772"><span class="linenos">772</span></a>                <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="ZAcNet-773"><a href="#ZAcNet-773"><span class="linenos">773</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">activation</span><span class="p">(</span><span class="n">sig</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span>
</span><span id="ZAcNet-774"><a href="#ZAcNet-774"><span class="linenos">774</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span>
</span><span id="ZAcNet-775"><a href="#ZAcNet-775"><span class="linenos">775</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">neurons</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
</span><span id="ZAcNet-776"><a href="#ZAcNet-776"><span class="linenos">776</span></a>            <span class="n">use_bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_bias</span><span class="p">,</span>
</span><span id="ZAcNet-777"><a href="#ZAcNet-777"><span class="linenos">777</span></a>            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Layer_</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">neurons</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="ZAcNet-778"><a href="#ZAcNet-778"><span class="linenos">778</span></a>            <span class="n">kernel_init</span><span class="o">=</span><span class="n">kernel_init</span><span class="p">,</span>
</span><span id="ZAcNet-779"><a href="#ZAcNet-779"><span class="linenos">779</span></a>        <span class="p">)(</span><span class="n">x</span><span class="p">)</span>
</span><span id="ZAcNet-780"><a href="#ZAcNet-780"><span class="linenos">780</span></a>        <span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">(</span>
</span><span id="ZAcNet-781"><a href="#ZAcNet-781"><span class="linenos">781</span></a>            <span class="sa">f</span><span class="s2">&quot;sig_</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">neurons</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="ZAcNet-782"><a href="#ZAcNet-782"><span class="linenos">782</span></a>            <span class="k">lambda</span> <span class="n">key</span><span class="p">,</span> <span class="n">shape</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
</span><span id="ZAcNet-783"><a href="#ZAcNet-783"><span class="linenos">783</span></a>            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zmax</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">neurons</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="ZAcNet-784"><a href="#ZAcNet-784"><span class="linenos">784</span></a>        <span class="p">)[</span><span class="n">species</span><span class="p">]</span>
</span><span id="ZAcNet-785"><a href="#ZAcNet-785"><span class="linenos">785</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_bias</span><span class="p">:</span>
</span><span id="ZAcNet-786"><a href="#ZAcNet-786"><span class="linenos">786</span></a>            <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">(</span>
</span><span id="ZAcNet-787"><a href="#ZAcNet-787"><span class="linenos">787</span></a>                <span class="sa">f</span><span class="s2">&quot;b_</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">neurons</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="ZAcNet-788"><a href="#ZAcNet-788"><span class="linenos">788</span></a>                <span class="k">lambda</span> <span class="n">key</span><span class="p">,</span> <span class="n">shape</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
</span><span id="ZAcNet-789"><a href="#ZAcNet-789"><span class="linenos">789</span></a>                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zmax</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">neurons</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="ZAcNet-790"><a href="#ZAcNet-790"><span class="linenos">790</span></a>            <span class="p">)[</span><span class="n">species</span><span class="p">]</span>
</span><span id="ZAcNet-791"><a href="#ZAcNet-791"><span class="linenos">791</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ZAcNet-792"><a href="#ZAcNet-792"><span class="linenos">792</span></a>            <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="ZAcNet-793"><a href="#ZAcNet-793"><span class="linenos">793</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">sig</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">b</span>
</span><span id="ZAcNet-794"><a href="#ZAcNet-794"><span class="linenos">794</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">squeeze</span> <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ZAcNet-795"><a href="#ZAcNet-795"><span class="linenos">795</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="ZAcNet-796"><a href="#ZAcNet-796"><span class="linenos">796</span></a>        <span class="c1">############################</span>
</span><span id="ZAcNet-797"><a href="#ZAcNet-797"><span class="linenos">797</span></a>
</span><span id="ZAcNet-798"><a href="#ZAcNet-798"><span class="linenos">798</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ZAcNet-799"><a href="#ZAcNet-799"><span class="linenos">799</span></a>            <span class="n">output_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_key</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_key</span>
</span><span id="ZAcNet-800"><a href="#ZAcNet-800"><span class="linenos">800</span></a>            <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="n">output_key</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span> <span class="k">if</span> <span class="n">output_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">x</span>
</span><span id="ZAcNet-801"><a href="#ZAcNet-801"><span class="linenos">801</span></a>        <span class="k">return</span> <span class="n">x</span>
</span></pre></div>


            <div class="docstring"><p>A fully connected neural network module with affine Z-dependent adjustments of activations.</p>

<p>Parameters:
    neurons (Sequence[int]): A sequence of integers representing the dimensions of the network.
    zmax (int): The maximum atomic number to consider.
    activation (Union[Callable, str], optional): The activation function to use. Defaults to nn.silu.
    use_bias (bool, optional): Whether to use bias in the dense layers. Defaults to True.
    input_key (Optional[str], optional): The key to use to access the input tensor. Defaults to None.
    output_key (Optional[str], optional): The key to use to access the output tensor. Defaults to None.
    squeeze (bool, optional): Whether to squeeze the output tensor if its shape is (..., 1). Defaults to False.
    kernel_init (Union[str, Callable], optional): The kernel initialization method to use. Defaults to nn.linear.default_kernel_init.</p>
</div>


                            <div id="ZAcNet.__init__" class="classattr">
                                <div class="attr function">
            
        <span class="name">ZAcNet</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">neurons</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>,</span><span class="param">	<span class="n">zmax</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">86</span>,</span><span class="param">	<span class="n">activation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">PjitFunction</span> <span class="n">of</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">silu</span><span class="o">&gt;&gt;</span>,</span><span class="param">	<span class="n">use_bias</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">input_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">output_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">squeeze</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">kernel_init</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">variance_scaling</span><span class="o">.&lt;</span><span class="nb">locals</span><span class="o">&gt;.</span><span class="n">init</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">FID</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;ZACNET&#39;</span>,</span><span class="param">	<span class="n">parent</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">flax</span><span class="o">.</span><span class="n">linen</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">Module</span><span class="p">],</span> <span class="n">flax</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">Scope</span><span class="p">,</span> <span class="n">Type</span><span class="p">[</span><span class="n">flax</span><span class="o">.</span><span class="n">linen</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">_Sentinel</span><span class="p">],</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">flax</span><span class="o">.</span><span class="n">linen</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">_Sentinel</span> <span class="nb">object</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

        
    </div>
    <a class="headerlink" href="#ZAcNet.__init__"></a>
    
    

                            </div>
                            <div id="ZAcNet.neurons" class="classattr">
                                <div class="attr variable">
            <span class="name">neurons</span><span class="annotation">: Sequence[int]</span>

        
    </div>
    <a class="headerlink" href="#ZAcNet.neurons"></a>
    
    

                            </div>
                            <div id="ZAcNet.zmax" class="classattr">
                                <div class="attr variable">
            <span class="name">zmax</span><span class="annotation">: int</span>        =
<span class="default_value">86</span>

        
    </div>
    <a class="headerlink" href="#ZAcNet.zmax"></a>
    
    

                            </div>
                            <div id="ZAcNet.activation" class="classattr">
                                        <input id="ZAcNet.activation-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@jax.jit</div>

        <span class="def">def</span>
        <span class="name">activation</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">x</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">bool_</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span>:</span></span>

                <label class="view-source-button" for="ZAcNet.activation-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ZAcNet.activation"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ZAcNet.activation-151"><a href="#ZAcNet.activation-151"><span class="linenos">151</span></a><span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
</span><span id="ZAcNet.activation-152"><a href="#ZAcNet.activation-152"><span class="linenos">152</span></a><span class="k">def</span> <span class="nf">silu</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="p">:</span>
</span><span id="ZAcNet.activation-153"><a href="#ZAcNet.activation-153"><span class="linenos">153</span></a><span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;SiLU (a.k.a. swish) activation function.</span>
</span><span id="ZAcNet.activation-154"><a href="#ZAcNet.activation-154"><span class="linenos">154</span></a>
</span><span id="ZAcNet.activation-155"><a href="#ZAcNet.activation-155"><span class="linenos">155</span></a><span class="sd">  Computes the element-wise function:</span>
</span><span id="ZAcNet.activation-156"><a href="#ZAcNet.activation-156"><span class="linenos">156</span></a>
</span><span id="ZAcNet.activation-157"><a href="#ZAcNet.activation-157"><span class="linenos">157</span></a><span class="sd">  .. math::</span>
</span><span id="ZAcNet.activation-158"><a href="#ZAcNet.activation-158"><span class="linenos">158</span></a><span class="sd">    \mathrm{silu}(x) = x \cdot \mathrm{sigmoid}(x) = \frac{x}{1 + e^{-x}}</span>
</span><span id="ZAcNet.activation-159"><a href="#ZAcNet.activation-159"><span class="linenos">159</span></a>
</span><span id="ZAcNet.activation-160"><a href="#ZAcNet.activation-160"><span class="linenos">160</span></a><span class="sd">  :func:`swish` and :func:`silu` are both aliases for the same function.</span>
</span><span id="ZAcNet.activation-161"><a href="#ZAcNet.activation-161"><span class="linenos">161</span></a>
</span><span id="ZAcNet.activation-162"><a href="#ZAcNet.activation-162"><span class="linenos">162</span></a><span class="sd">  Args:</span>
</span><span id="ZAcNet.activation-163"><a href="#ZAcNet.activation-163"><span class="linenos">163</span></a><span class="sd">    x : input array</span>
</span><span id="ZAcNet.activation-164"><a href="#ZAcNet.activation-164"><span class="linenos">164</span></a>
</span><span id="ZAcNet.activation-165"><a href="#ZAcNet.activation-165"><span class="linenos">165</span></a><span class="sd">  Returns:</span>
</span><span id="ZAcNet.activation-166"><a href="#ZAcNet.activation-166"><span class="linenos">166</span></a><span class="sd">    An array.</span>
</span><span id="ZAcNet.activation-167"><a href="#ZAcNet.activation-167"><span class="linenos">167</span></a>
</span><span id="ZAcNet.activation-168"><a href="#ZAcNet.activation-168"><span class="linenos">168</span></a><span class="sd">  See also:</span>
</span><span id="ZAcNet.activation-169"><a href="#ZAcNet.activation-169"><span class="linenos">169</span></a><span class="sd">    :func:`sigmoid`</span>
</span><span id="ZAcNet.activation-170"><a href="#ZAcNet.activation-170"><span class="linenos">170</span></a><span class="sd">  &quot;&quot;&quot;</span>
</span><span id="ZAcNet.activation-171"><a href="#ZAcNet.activation-171"><span class="linenos">171</span></a>  <span class="n">numpy_util</span><span class="o">.</span><span class="n">check_arraylike</span><span class="p">(</span><span class="s2">&quot;silu&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span><span id="ZAcNet.activation-172"><a href="#ZAcNet.activation-172"><span class="linenos">172</span></a>  <span class="n">x_arr</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="ZAcNet.activation-173"><a href="#ZAcNet.activation-173"><span class="linenos">173</span></a>  <span class="k">return</span> <span class="n">x_arr</span> <span class="o">*</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">x_arr</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>SiLU (a.k.a. swish) activation function.</p>

<p>Computes the element-wise function:</p>

<p>$$\mathrm{silu}(x) = x \cdot \mathrm{sigmoid}(x) = \frac{x}{1 + e^{-x}}$$</p>

<p><code>swish()</code> and <code>silu()</code> are both aliases for the same function.</p>

<p>Args:
  x : input array</p>

<p>Returns:
  An array.</p>

<p>See also:
  <code>sigmoid()</code></p>
</div>


                            </div>
                            <div id="ZAcNet.use_bias" class="classattr">
                                <div class="attr variable">
            <span class="name">use_bias</span><span class="annotation">: bool</span>        =
<span class="default_value">True</span>

        
    </div>
    <a class="headerlink" href="#ZAcNet.use_bias"></a>
    
    

                            </div>
                            <div id="ZAcNet.input_key" class="classattr">
                                <div class="attr variable">
            <span class="name">input_key</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ZAcNet.input_key"></a>
    
    

                            </div>
                            <div id="ZAcNet.output_key" class="classattr">
                                <div class="attr variable">
            <span class="name">output_key</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ZAcNet.output_key"></a>
    
    

                            </div>
                            <div id="ZAcNet.squeeze" class="classattr">
                                <div class="attr variable">
            <span class="name">squeeze</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ZAcNet.squeeze"></a>
    
    

                            </div>
                            <div id="ZAcNet.kernel_init" class="classattr">
                                        <input id="ZAcNet.kernel_init-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">kernel_init</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">key</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span>,</span><span class="param">	<span class="n">shape</span><span class="p">:</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]]</span>,</span><span class="param">	dtype: Any = &lt;class &#x27;jax.numpy.float64&#x27;&gt;</span><span class="return-annotation">) -> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span>:</span></span>

                <label class="view-source-button" for="ZAcNet.kernel_init-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ZAcNet.kernel_init"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ZAcNet.kernel_init-317"><a href="#ZAcNet.kernel_init-317"><span class="linenos">317</span></a>  <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">KeyArray</span><span class="p">,</span>
</span><span id="ZAcNet.kernel_init-318"><a href="#ZAcNet.kernel_init-318"><span class="linenos">318</span></a>           <span class="n">shape</span><span class="p">:</span> <span class="n">core</span><span class="o">.</span><span class="n">Shape</span><span class="p">,</span>
</span><span id="ZAcNet.kernel_init-319"><a href="#ZAcNet.kernel_init-319"><span class="linenos">319</span></a>           <span class="n">dtype</span><span class="p">:</span> <span class="n">DTypeLikeInexact</span> <span class="o">=</span> <span class="n">dtype</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="p">:</span>
</span><span id="ZAcNet.kernel_init-320"><a href="#ZAcNet.kernel_init-320"><span class="linenos">320</span></a>    <span class="n">dtype</span> <span class="o">=</span> <span class="n">dtypes</span><span class="o">.</span><span class="n">canonicalize_dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="ZAcNet.kernel_init-321"><a href="#ZAcNet.kernel_init-321"><span class="linenos">321</span></a>    <span class="n">named_shape</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">as_named_shape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
</span><span id="ZAcNet.kernel_init-322"><a href="#ZAcNet.kernel_init-322"><span class="linenos">322</span></a>    <span class="n">fan_in</span><span class="p">,</span> <span class="n">fan_out</span> <span class="o">=</span> <span class="n">_compute_fans</span><span class="p">(</span><span class="n">named_shape</span><span class="p">,</span> <span class="n">in_axis</span><span class="p">,</span> <span class="n">out_axis</span><span class="p">,</span> <span class="n">batch_axis</span><span class="p">)</span>
</span><span id="ZAcNet.kernel_init-323"><a href="#ZAcNet.kernel_init-323"><span class="linenos">323</span></a>    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;fan_in&quot;</span><span class="p">:</span> <span class="n">denominator</span> <span class="o">=</span> <span class="n">fan_in</span>
</span><span id="ZAcNet.kernel_init-324"><a href="#ZAcNet.kernel_init-324"><span class="linenos">324</span></a>    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;fan_out&quot;</span><span class="p">:</span> <span class="n">denominator</span> <span class="o">=</span> <span class="n">fan_out</span>
</span><span id="ZAcNet.kernel_init-325"><a href="#ZAcNet.kernel_init-325"><span class="linenos">325</span></a>    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;fan_avg&quot;</span><span class="p">:</span> <span class="n">denominator</span> <span class="o">=</span> <span class="p">(</span><span class="n">fan_in</span> <span class="o">+</span> <span class="n">fan_out</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="ZAcNet.kernel_init-326"><a href="#ZAcNet.kernel_init-326"><span class="linenos">326</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="ZAcNet.kernel_init-327"><a href="#ZAcNet.kernel_init-327"><span class="linenos">327</span></a>      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="ZAcNet.kernel_init-328"><a href="#ZAcNet.kernel_init-328"><span class="linenos">328</span></a>        <span class="sa">f</span><span class="s2">&quot;invalid mode for variance scaling initializer: </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ZAcNet.kernel_init-329"><a href="#ZAcNet.kernel_init-329"><span class="linenos">329</span></a>    <span class="n">variance</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">scale</span> <span class="o">/</span> <span class="n">denominator</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="ZAcNet.kernel_init-330"><a href="#ZAcNet.kernel_init-330"><span class="linenos">330</span></a>
</span><span id="ZAcNet.kernel_init-331"><a href="#ZAcNet.kernel_init-331"><span class="linenos">331</span></a>    <span class="k">if</span> <span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;truncated_normal&quot;</span><span class="p">:</span>
</span><span id="ZAcNet.kernel_init-332"><a href="#ZAcNet.kernel_init-332"><span class="linenos">332</span></a>      <span class="k">if</span> <span class="n">jnp</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">floating</span><span class="p">):</span>
</span><span id="ZAcNet.kernel_init-333"><a href="#ZAcNet.kernel_init-333"><span class="linenos">333</span></a>        <span class="c1"># constant is stddev of standard normal truncated to (-2, 2)</span>
</span><span id="ZAcNet.kernel_init-334"><a href="#ZAcNet.kernel_init-334"><span class="linenos">334</span></a>        <span class="n">stddev</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">.87962566103423978</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
</span><span id="ZAcNet.kernel_init-335"><a href="#ZAcNet.kernel_init-335"><span class="linenos">335</span></a>        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">truncated_normal</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">named_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="n">stddev</span>
</span><span id="ZAcNet.kernel_init-336"><a href="#ZAcNet.kernel_init-336"><span class="linenos">336</span></a>      <span class="k">else</span><span class="p">:</span>
</span><span id="ZAcNet.kernel_init-337"><a href="#ZAcNet.kernel_init-337"><span class="linenos">337</span></a>        <span class="c1"># constant is stddev of complex standard normal truncated to 2</span>
</span><span id="ZAcNet.kernel_init-338"><a href="#ZAcNet.kernel_init-338"><span class="linenos">338</span></a>        <span class="n">stddev</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">.95311164380491208</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
</span><span id="ZAcNet.kernel_init-339"><a href="#ZAcNet.kernel_init-339"><span class="linenos">339</span></a>        <span class="k">return</span> <span class="n">_complex_truncated_normal</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">named_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="n">stddev</span>
</span><span id="ZAcNet.kernel_init-340"><a href="#ZAcNet.kernel_init-340"><span class="linenos">340</span></a>    <span class="k">elif</span> <span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;normal&quot;</span><span class="p">:</span>
</span><span id="ZAcNet.kernel_init-341"><a href="#ZAcNet.kernel_init-341"><span class="linenos">341</span></a>      <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">named_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span>
</span><span id="ZAcNet.kernel_init-342"><a href="#ZAcNet.kernel_init-342"><span class="linenos">342</span></a>    <span class="k">elif</span> <span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;uniform&quot;</span><span class="p">:</span>
</span><span id="ZAcNet.kernel_init-343"><a href="#ZAcNet.kernel_init-343"><span class="linenos">343</span></a>      <span class="k">if</span> <span class="n">jnp</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">floating</span><span class="p">):</span>
</span><span id="ZAcNet.kernel_init-344"><a href="#ZAcNet.kernel_init-344"><span class="linenos">344</span></a>        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">named_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">variance</span><span class="p">)</span>
</span><span id="ZAcNet.kernel_init-345"><a href="#ZAcNet.kernel_init-345"><span class="linenos">345</span></a>      <span class="k">else</span><span class="p">:</span>
</span><span id="ZAcNet.kernel_init-346"><a href="#ZAcNet.kernel_init-346"><span class="linenos">346</span></a>        <span class="k">return</span> <span class="n">_complex_uniform</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">named_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span>
</span><span id="ZAcNet.kernel_init-347"><a href="#ZAcNet.kernel_init-347"><span class="linenos">347</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="ZAcNet.kernel_init-348"><a href="#ZAcNet.kernel_init-348"><span class="linenos">348</span></a>      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;invalid distribution for variance scaling initializer: </span><span class="si">{</span><span class="n">distribution</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="ZAcNet.FID" class="classattr">
                                <div class="attr variable">
            <span class="name">FID</span><span class="annotation">: str</span>        =
<span class="default_value">&#39;ZACNET&#39;</span>

        
    </div>
    <a class="headerlink" href="#ZAcNet.FID"></a>
    
    

                            </div>
                            <div id="ZAcNet.parent" class="classattr">
                                <div class="attr variable">
            <span class="name">parent</span><span class="annotation">: Union[Type[flax.linen.module.Module], flax.core.scope.Scope, Type[flax.linen.module._Sentinel], NoneType]</span>

        
    </div>
    <a class="headerlink" href="#ZAcNet.parent"></a>
    
            <div class="docstring"><p>Wraps parent module references in weak refs.</p>

<p>This prevents reference cycles from forming via parent links which can lead
to accidental OOMs in eager mode due to slow garbage collection as well as
spurious tracer leaks during jit compilation.</p>

<p>Note: "descriptors" are the underlying python mechanism for implementing
dynamic @property decorators.  We need to use a raw descriptor instead of the
more common decorator in order to force that the appropriate getter/setter
logic applies in subclasses even after various dataclass transforms.</p>
</div>


                            </div>
                            <div id="ZAcNet.name" class="classattr">
                                <div class="attr variable">
            <span class="name">name</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ZAcNet.name"></a>
    
    

                            </div>
                            <div id="ZAcNet.scope" class="classattr">
                                <div class="attr variable">
            <span class="name">scope</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ZAcNet.scope"></a>
    
    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>flax.linen.module.Module</dt>
                                <dd id="ZAcNet.setup" class="function">setup</dd>
                <dd id="ZAcNet.path" class="variable">path</dd>
                <dd id="ZAcNet.clone" class="function">clone</dd>
                <dd id="ZAcNet.copy" class="function">copy</dd>
                <dd id="ZAcNet.variable" class="function">variable</dd>
                <dd id="ZAcNet.param" class="function">param</dd>
                <dd id="ZAcNet.has_variable" class="function">has_variable</dd>
                <dd id="ZAcNet.is_mutable_collection" class="function">is_mutable_collection</dd>
                <dd id="ZAcNet.has_rng" class="function">has_rng</dd>
                <dd id="ZAcNet.make_rng" class="function">make_rng</dd>
                <dd id="ZAcNet.is_initializing" class="function">is_initializing</dd>
                <dd id="ZAcNet.bind" class="function">bind</dd>
                <dd id="ZAcNet.unbind" class="function">unbind</dd>
                <dd id="ZAcNet.apply" class="function">apply</dd>
                <dd id="ZAcNet.init_with_output" class="function">init_with_output</dd>
                <dd id="ZAcNet.init" class="function">init</dd>
                <dd id="ZAcNet.lazy_init" class="function">lazy_init</dd>
                <dd id="ZAcNet.variables" class="variable">variables</dd>
                <dd id="ZAcNet.get_variable" class="function">get_variable</dd>
                <dd id="ZAcNet.put_variable" class="function">put_variable</dd>
                <dd id="ZAcNet.sow" class="function">sow</dd>
                <dd id="ZAcNet.perturb" class="function">perturb</dd>
                <dd id="ZAcNet.tabulate" class="function">tabulate</dd>
                <dd id="ZAcNet.module_paths" class="function">module_paths</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="ZLoRANet">
                            <input id="ZLoRANet-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">ZLoRANet</span><wbr>(<span class="base">flax.linen.module.Module</span>):

                <label class="view-source-button" for="ZLoRANet-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ZLoRANet"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ZLoRANet-804"><a href="#ZLoRANet-804"><span class="linenos">804</span></a><span class="k">class</span> <span class="nc">ZLoRANet</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="ZLoRANet-805"><a href="#ZLoRANet-805"><span class="linenos">805</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ZLoRANet-806"><a href="#ZLoRANet-806"><span class="linenos">806</span></a><span class="sd">    A fully connected neural network module with Z-dependent low-rank adaptation.</span>
</span><span id="ZLoRANet-807"><a href="#ZLoRANet-807"><span class="linenos">807</span></a>
</span><span id="ZLoRANet-808"><a href="#ZLoRANet-808"><span class="linenos">808</span></a><span class="sd">    Parameters:</span>
</span><span id="ZLoRANet-809"><a href="#ZLoRANet-809"><span class="linenos">809</span></a><span class="sd">        neurons (Sequence[int]): A sequence of integers representing the dimensions of the network.</span>
</span><span id="ZLoRANet-810"><a href="#ZLoRANet-810"><span class="linenos">810</span></a><span class="sd">        ranks (Sequence[int]): A sequence of integers representing the ranks of the low-rank adaptation matrices.</span>
</span><span id="ZLoRANet-811"><a href="#ZLoRANet-811"><span class="linenos">811</span></a><span class="sd">        zmax (int): The maximum atomic number to consider.</span>
</span><span id="ZLoRANet-812"><a href="#ZLoRANet-812"><span class="linenos">812</span></a><span class="sd">        activation (Union[Callable, str], optional): The activation function to use. Defaults to nn.silu.</span>
</span><span id="ZLoRANet-813"><a href="#ZLoRANet-813"><span class="linenos">813</span></a><span class="sd">        use_bias (bool, optional): Whether to use bias in the dense layers. Defaults to True.</span>
</span><span id="ZLoRANet-814"><a href="#ZLoRANet-814"><span class="linenos">814</span></a><span class="sd">        input_key (Optional[str], optional): The key to use to access the input tensor. Defaults to None.</span>
</span><span id="ZLoRANet-815"><a href="#ZLoRANet-815"><span class="linenos">815</span></a><span class="sd">        output_key (Optional[str], optional): The key to use to access the output tensor. Defaults to None.</span>
</span><span id="ZLoRANet-816"><a href="#ZLoRANet-816"><span class="linenos">816</span></a><span class="sd">        squeeze (bool, optional): Whether to squeeze the output tensor if its shape is (..., 1). Defaults to False.</span>
</span><span id="ZLoRANet-817"><a href="#ZLoRANet-817"><span class="linenos">817</span></a><span class="sd">        kernel_init (Union[str, Callable], optional): The kernel initialization method to use. Defaults to nn.linear.default_kernel_init.</span>
</span><span id="ZLoRANet-818"><a href="#ZLoRANet-818"><span class="linenos">818</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="ZLoRANet-819"><a href="#ZLoRANet-819"><span class="linenos">819</span></a>
</span><span id="ZLoRANet-820"><a href="#ZLoRANet-820"><span class="linenos">820</span></a>    <span class="n">neurons</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
</span><span id="ZLoRANet-821"><a href="#ZLoRANet-821"><span class="linenos">821</span></a>    <span class="n">ranks</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
</span><span id="ZLoRANet-822"><a href="#ZLoRANet-822"><span class="linenos">822</span></a>    <span class="n">zmax</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">86</span>
</span><span id="ZLoRANet-823"><a href="#ZLoRANet-823"><span class="linenos">823</span></a>    <span class="n">activation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">silu</span>
</span><span id="ZLoRANet-824"><a href="#ZLoRANet-824"><span class="linenos">824</span></a>    <span class="n">use_bias</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ZLoRANet-825"><a href="#ZLoRANet-825"><span class="linenos">825</span></a>    <span class="n">input_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ZLoRANet-826"><a href="#ZLoRANet-826"><span class="linenos">826</span></a>    <span class="n">output_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ZLoRANet-827"><a href="#ZLoRANet-827"><span class="linenos">827</span></a>    <span class="n">squeeze</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ZLoRANet-828"><a href="#ZLoRANet-828"><span class="linenos">828</span></a>    <span class="n">kernel_init</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">default_kernel_init</span>
</span><span id="ZLoRANet-829"><a href="#ZLoRANet-829"><span class="linenos">829</span></a>
</span><span id="ZLoRANet-830"><a href="#ZLoRANet-830"><span class="linenos">830</span></a>    <span class="n">FID</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;ZLORANET&quot;</span>
</span><span id="ZLoRANet-831"><a href="#ZLoRANet-831"><span class="linenos">831</span></a>
</span><span id="ZLoRANet-832"><a href="#ZLoRANet-832"><span class="linenos">832</span></a>    <span class="nd">@nn</span><span class="o">.</span><span class="n">compact</span>
</span><span id="ZLoRANet-833"><a href="#ZLoRANet-833"><span class="linenos">833</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">]:</span>
</span><span id="ZLoRANet-834"><a href="#ZLoRANet-834"><span class="linenos">834</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ZLoRANet-835"><a href="#ZLoRANet-835"><span class="linenos">835</span></a>            <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
</span><span id="ZLoRANet-836"><a href="#ZLoRANet-836"><span class="linenos">836</span></a>                <span class="n">inputs</span><span class="p">,</span> <span class="nb">dict</span>
</span><span id="ZLoRANet-837"><a href="#ZLoRANet-837"><span class="linenos">837</span></a>            <span class="p">),</span> <span class="s2">&quot;input key must be provided if inputs is a dictionary&quot;</span>
</span><span id="ZLoRANet-838"><a href="#ZLoRANet-838"><span class="linenos">838</span></a>            <span class="n">species</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">inputs</span>
</span><span id="ZLoRANet-839"><a href="#ZLoRANet-839"><span class="linenos">839</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ZLoRANet-840"><a href="#ZLoRANet-840"><span class="linenos">840</span></a>            <span class="n">species</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">],</span> <span class="n">inputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">input_key</span><span class="p">]</span>
</span><span id="ZLoRANet-841"><a href="#ZLoRANet-841"><span class="linenos">841</span></a>
</span><span id="ZLoRANet-842"><a href="#ZLoRANet-842"><span class="linenos">842</span></a>        <span class="n">activation</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="ZLoRANet-843"><a href="#ZLoRANet-843"><span class="linenos">843</span></a>            <span class="n">activation_from_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">)</span>
</span><span id="ZLoRANet-844"><a href="#ZLoRANet-844"><span class="linenos">844</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
</span><span id="ZLoRANet-845"><a href="#ZLoRANet-845"><span class="linenos">845</span></a>            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">activation</span>
</span><span id="ZLoRANet-846"><a href="#ZLoRANet-846"><span class="linenos">846</span></a>        <span class="p">)</span>
</span><span id="ZLoRANet-847"><a href="#ZLoRANet-847"><span class="linenos">847</span></a>        <span class="n">kernel_init</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="ZLoRANet-848"><a href="#ZLoRANet-848"><span class="linenos">848</span></a>            <span class="n">initializer_from_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_init</span><span class="p">)</span>
</span><span id="ZLoRANet-849"><a href="#ZLoRANet-849"><span class="linenos">849</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_init</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
</span><span id="ZLoRANet-850"><a href="#ZLoRANet-850"><span class="linenos">850</span></a>            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel_init</span>
</span><span id="ZLoRANet-851"><a href="#ZLoRANet-851"><span class="linenos">851</span></a>        <span class="p">)</span>
</span><span id="ZLoRANet-852"><a href="#ZLoRANet-852"><span class="linenos">852</span></a>        <span class="c1">############################</span>
</span><span id="ZLoRANet-853"><a href="#ZLoRANet-853"><span class="linenos">853</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">neurons</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
</span><span id="ZLoRANet-854"><a href="#ZLoRANet-854"><span class="linenos">854</span></a>            <span class="n">xi</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span>
</span><span id="ZLoRANet-855"><a href="#ZLoRANet-855"><span class="linenos">855</span></a>                <span class="n">d</span><span class="p">,</span> <span class="n">use_bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_bias</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Layer_</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">kernel_init</span><span class="o">=</span><span class="n">kernel_init</span>
</span><span id="ZLoRANet-856"><a href="#ZLoRANet-856"><span class="linenos">856</span></a>            <span class="p">)(</span><span class="n">x</span><span class="p">)</span>
</span><span id="ZLoRANet-857"><a href="#ZLoRANet-857"><span class="linenos">857</span></a>            <span class="n">A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">(</span>
</span><span id="ZLoRANet-858"><a href="#ZLoRANet-858"><span class="linenos">858</span></a>                <span class="sa">f</span><span class="s2">&quot;A_</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="ZLoRANet-859"><a href="#ZLoRANet-859"><span class="linenos">859</span></a>                <span class="k">lambda</span> <span class="n">key</span><span class="p">,</span> <span class="n">shape</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
</span><span id="ZLoRANet-860"><a href="#ZLoRANet-860"><span class="linenos">860</span></a>                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zmax</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ranks</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="ZLoRANet-861"><a href="#ZLoRANet-861"><span class="linenos">861</span></a>            <span class="p">)[</span><span class="n">species</span><span class="p">]</span>
</span><span id="ZLoRANet-862"><a href="#ZLoRANet-862"><span class="linenos">862</span></a>            <span class="n">B</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">(</span>
</span><span id="ZLoRANet-863"><a href="#ZLoRANet-863"><span class="linenos">863</span></a>                <span class="sa">f</span><span class="s2">&quot;B_</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="ZLoRANet-864"><a href="#ZLoRANet-864"><span class="linenos">864</span></a>                <span class="k">lambda</span> <span class="n">key</span><span class="p">,</span> <span class="n">shape</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
</span><span id="ZLoRANet-865"><a href="#ZLoRANet-865"><span class="linenos">865</span></a>                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zmax</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ranks</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
</span><span id="ZLoRANet-866"><a href="#ZLoRANet-866"><span class="linenos">866</span></a>            <span class="p">)[</span><span class="n">species</span><span class="p">]</span>
</span><span id="ZLoRANet-867"><a href="#ZLoRANet-867"><span class="linenos">867</span></a>            <span class="n">Ax</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;zrd,zd-&gt;zr&quot;</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span><span id="ZLoRANet-868"><a href="#ZLoRANet-868"><span class="linenos">868</span></a>            <span class="n">BAx</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;zrd,zd-&gt;zr&quot;</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">Ax</span><span class="p">)</span>
</span><span id="ZLoRANet-869"><a href="#ZLoRANet-869"><span class="linenos">869</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">activation</span><span class="p">(</span><span class="n">xi</span> <span class="o">+</span> <span class="n">BAx</span><span class="p">)</span>
</span><span id="ZLoRANet-870"><a href="#ZLoRANet-870"><span class="linenos">870</span></a>        <span class="n">xi</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span>
</span><span id="ZLoRANet-871"><a href="#ZLoRANet-871"><span class="linenos">871</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">neurons</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
</span><span id="ZLoRANet-872"><a href="#ZLoRANet-872"><span class="linenos">872</span></a>            <span class="n">use_bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_bias</span><span class="p">,</span>
</span><span id="ZLoRANet-873"><a href="#ZLoRANet-873"><span class="linenos">873</span></a>            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Layer_</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">neurons</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="ZLoRANet-874"><a href="#ZLoRANet-874"><span class="linenos">874</span></a>            <span class="n">kernel_init</span><span class="o">=</span><span class="n">kernel_init</span><span class="p">,</span>
</span><span id="ZLoRANet-875"><a href="#ZLoRANet-875"><span class="linenos">875</span></a>        <span class="p">)(</span><span class="n">x</span><span class="p">)</span>
</span><span id="ZLoRANet-876"><a href="#ZLoRANet-876"><span class="linenos">876</span></a>        <span class="n">A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">(</span>
</span><span id="ZLoRANet-877"><a href="#ZLoRANet-877"><span class="linenos">877</span></a>            <span class="sa">f</span><span class="s2">&quot;A_</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">neurons</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="ZLoRANet-878"><a href="#ZLoRANet-878"><span class="linenos">878</span></a>            <span class="k">lambda</span> <span class="n">key</span><span class="p">,</span> <span class="n">shape</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
</span><span id="ZLoRANet-879"><a href="#ZLoRANet-879"><span class="linenos">879</span></a>            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zmax</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ranks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="ZLoRANet-880"><a href="#ZLoRANet-880"><span class="linenos">880</span></a>        <span class="p">)[</span><span class="n">species</span><span class="p">]</span>
</span><span id="ZLoRANet-881"><a href="#ZLoRANet-881"><span class="linenos">881</span></a>        <span class="n">B</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">(</span>
</span><span id="ZLoRANet-882"><a href="#ZLoRANet-882"><span class="linenos">882</span></a>            <span class="sa">f</span><span class="s2">&quot;B_</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">neurons</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="ZLoRANet-883"><a href="#ZLoRANet-883"><span class="linenos">883</span></a>            <span class="k">lambda</span> <span class="n">key</span><span class="p">,</span> <span class="n">shape</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
</span><span id="ZLoRANet-884"><a href="#ZLoRANet-884"><span class="linenos">884</span></a>            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zmax</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">neurons</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">ranks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="ZLoRANet-885"><a href="#ZLoRANet-885"><span class="linenos">885</span></a>        <span class="p">)[</span><span class="n">species</span><span class="p">]</span>
</span><span id="ZLoRANet-886"><a href="#ZLoRANet-886"><span class="linenos">886</span></a>        <span class="n">Ax</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;zrd,zd-&gt;zr&quot;</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span><span id="ZLoRANet-887"><a href="#ZLoRANet-887"><span class="linenos">887</span></a>        <span class="n">BAx</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;zrd,zd-&gt;zr&quot;</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">Ax</span><span class="p">)</span>
</span><span id="ZLoRANet-888"><a href="#ZLoRANet-888"><span class="linenos">888</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">xi</span> <span class="o">+</span> <span class="n">BAx</span>
</span><span id="ZLoRANet-889"><a href="#ZLoRANet-889"><span class="linenos">889</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">squeeze</span> <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ZLoRANet-890"><a href="#ZLoRANet-890"><span class="linenos">890</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="ZLoRANet-891"><a href="#ZLoRANet-891"><span class="linenos">891</span></a>        <span class="c1">############################</span>
</span><span id="ZLoRANet-892"><a href="#ZLoRANet-892"><span class="linenos">892</span></a>
</span><span id="ZLoRANet-893"><a href="#ZLoRANet-893"><span class="linenos">893</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ZLoRANet-894"><a href="#ZLoRANet-894"><span class="linenos">894</span></a>            <span class="n">output_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_key</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_key</span>
</span><span id="ZLoRANet-895"><a href="#ZLoRANet-895"><span class="linenos">895</span></a>            <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="n">output_key</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span> <span class="k">if</span> <span class="n">output_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">x</span>
</span><span id="ZLoRANet-896"><a href="#ZLoRANet-896"><span class="linenos">896</span></a>        <span class="k">return</span> <span class="n">x</span>
</span></pre></div>


            <div class="docstring"><p>A fully connected neural network module with Z-dependent low-rank adaptation.</p>

<p>Parameters:
    neurons (Sequence[int]): A sequence of integers representing the dimensions of the network.
    ranks (Sequence[int]): A sequence of integers representing the ranks of the low-rank adaptation matrices.
    zmax (int): The maximum atomic number to consider.
    activation (Union[Callable, str], optional): The activation function to use. Defaults to nn.silu.
    use_bias (bool, optional): Whether to use bias in the dense layers. Defaults to True.
    input_key (Optional[str], optional): The key to use to access the input tensor. Defaults to None.
    output_key (Optional[str], optional): The key to use to access the output tensor. Defaults to None.
    squeeze (bool, optional): Whether to squeeze the output tensor if its shape is (..., 1). Defaults to False.
    kernel_init (Union[str, Callable], optional): The kernel initialization method to use. Defaults to nn.linear.default_kernel_init.</p>
</div>


                            <div id="ZLoRANet.__init__" class="classattr">
                                <div class="attr function">
            
        <span class="name">ZLoRANet</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">neurons</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>,</span><span class="param">	<span class="n">ranks</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>,</span><span class="param">	<span class="n">zmax</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">86</span>,</span><span class="param">	<span class="n">activation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">PjitFunction</span> <span class="n">of</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">silu</span><span class="o">&gt;&gt;</span>,</span><span class="param">	<span class="n">use_bias</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">input_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">output_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">squeeze</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">kernel_init</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">variance_scaling</span><span class="o">.&lt;</span><span class="nb">locals</span><span class="o">&gt;.</span><span class="n">init</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">FID</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;ZLORANET&#39;</span>,</span><span class="param">	<span class="n">parent</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">flax</span><span class="o">.</span><span class="n">linen</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">Module</span><span class="p">],</span> <span class="n">flax</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">Scope</span><span class="p">,</span> <span class="n">Type</span><span class="p">[</span><span class="n">flax</span><span class="o">.</span><span class="n">linen</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">_Sentinel</span><span class="p">],</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">flax</span><span class="o">.</span><span class="n">linen</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">_Sentinel</span> <span class="nb">object</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

        
    </div>
    <a class="headerlink" href="#ZLoRANet.__init__"></a>
    
    

                            </div>
                            <div id="ZLoRANet.neurons" class="classattr">
                                <div class="attr variable">
            <span class="name">neurons</span><span class="annotation">: Sequence[int]</span>

        
    </div>
    <a class="headerlink" href="#ZLoRANet.neurons"></a>
    
    

                            </div>
                            <div id="ZLoRANet.ranks" class="classattr">
                                <div class="attr variable">
            <span class="name">ranks</span><span class="annotation">: Sequence[int]</span>

        
    </div>
    <a class="headerlink" href="#ZLoRANet.ranks"></a>
    
    

                            </div>
                            <div id="ZLoRANet.zmax" class="classattr">
                                <div class="attr variable">
            <span class="name">zmax</span><span class="annotation">: int</span>        =
<span class="default_value">86</span>

        
    </div>
    <a class="headerlink" href="#ZLoRANet.zmax"></a>
    
    

                            </div>
                            <div id="ZLoRANet.activation" class="classattr">
                                        <input id="ZLoRANet.activation-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@jax.jit</div>

        <span class="def">def</span>
        <span class="name">activation</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">x</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">bool_</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span>:</span></span>

                <label class="view-source-button" for="ZLoRANet.activation-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ZLoRANet.activation"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ZLoRANet.activation-151"><a href="#ZLoRANet.activation-151"><span class="linenos">151</span></a><span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
</span><span id="ZLoRANet.activation-152"><a href="#ZLoRANet.activation-152"><span class="linenos">152</span></a><span class="k">def</span> <span class="nf">silu</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="p">:</span>
</span><span id="ZLoRANet.activation-153"><a href="#ZLoRANet.activation-153"><span class="linenos">153</span></a><span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;SiLU (a.k.a. swish) activation function.</span>
</span><span id="ZLoRANet.activation-154"><a href="#ZLoRANet.activation-154"><span class="linenos">154</span></a>
</span><span id="ZLoRANet.activation-155"><a href="#ZLoRANet.activation-155"><span class="linenos">155</span></a><span class="sd">  Computes the element-wise function:</span>
</span><span id="ZLoRANet.activation-156"><a href="#ZLoRANet.activation-156"><span class="linenos">156</span></a>
</span><span id="ZLoRANet.activation-157"><a href="#ZLoRANet.activation-157"><span class="linenos">157</span></a><span class="sd">  .. math::</span>
</span><span id="ZLoRANet.activation-158"><a href="#ZLoRANet.activation-158"><span class="linenos">158</span></a><span class="sd">    \mathrm{silu}(x) = x \cdot \mathrm{sigmoid}(x) = \frac{x}{1 + e^{-x}}</span>
</span><span id="ZLoRANet.activation-159"><a href="#ZLoRANet.activation-159"><span class="linenos">159</span></a>
</span><span id="ZLoRANet.activation-160"><a href="#ZLoRANet.activation-160"><span class="linenos">160</span></a><span class="sd">  :func:`swish` and :func:`silu` are both aliases for the same function.</span>
</span><span id="ZLoRANet.activation-161"><a href="#ZLoRANet.activation-161"><span class="linenos">161</span></a>
</span><span id="ZLoRANet.activation-162"><a href="#ZLoRANet.activation-162"><span class="linenos">162</span></a><span class="sd">  Args:</span>
</span><span id="ZLoRANet.activation-163"><a href="#ZLoRANet.activation-163"><span class="linenos">163</span></a><span class="sd">    x : input array</span>
</span><span id="ZLoRANet.activation-164"><a href="#ZLoRANet.activation-164"><span class="linenos">164</span></a>
</span><span id="ZLoRANet.activation-165"><a href="#ZLoRANet.activation-165"><span class="linenos">165</span></a><span class="sd">  Returns:</span>
</span><span id="ZLoRANet.activation-166"><a href="#ZLoRANet.activation-166"><span class="linenos">166</span></a><span class="sd">    An array.</span>
</span><span id="ZLoRANet.activation-167"><a href="#ZLoRANet.activation-167"><span class="linenos">167</span></a>
</span><span id="ZLoRANet.activation-168"><a href="#ZLoRANet.activation-168"><span class="linenos">168</span></a><span class="sd">  See also:</span>
</span><span id="ZLoRANet.activation-169"><a href="#ZLoRANet.activation-169"><span class="linenos">169</span></a><span class="sd">    :func:`sigmoid`</span>
</span><span id="ZLoRANet.activation-170"><a href="#ZLoRANet.activation-170"><span class="linenos">170</span></a><span class="sd">  &quot;&quot;&quot;</span>
</span><span id="ZLoRANet.activation-171"><a href="#ZLoRANet.activation-171"><span class="linenos">171</span></a>  <span class="n">numpy_util</span><span class="o">.</span><span class="n">check_arraylike</span><span class="p">(</span><span class="s2">&quot;silu&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span><span id="ZLoRANet.activation-172"><a href="#ZLoRANet.activation-172"><span class="linenos">172</span></a>  <span class="n">x_arr</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="ZLoRANet.activation-173"><a href="#ZLoRANet.activation-173"><span class="linenos">173</span></a>  <span class="k">return</span> <span class="n">x_arr</span> <span class="o">*</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">x_arr</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>SiLU (a.k.a. swish) activation function.</p>

<p>Computes the element-wise function:</p>

<p>$$\mathrm{silu}(x) = x \cdot \mathrm{sigmoid}(x) = \frac{x}{1 + e^{-x}}$$</p>

<p><code>swish()</code> and <code>silu()</code> are both aliases for the same function.</p>

<p>Args:
  x : input array</p>

<p>Returns:
  An array.</p>

<p>See also:
  <code>sigmoid()</code></p>
</div>


                            </div>
                            <div id="ZLoRANet.use_bias" class="classattr">
                                <div class="attr variable">
            <span class="name">use_bias</span><span class="annotation">: bool</span>        =
<span class="default_value">True</span>

        
    </div>
    <a class="headerlink" href="#ZLoRANet.use_bias"></a>
    
    

                            </div>
                            <div id="ZLoRANet.input_key" class="classattr">
                                <div class="attr variable">
            <span class="name">input_key</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ZLoRANet.input_key"></a>
    
    

                            </div>
                            <div id="ZLoRANet.output_key" class="classattr">
                                <div class="attr variable">
            <span class="name">output_key</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ZLoRANet.output_key"></a>
    
    

                            </div>
                            <div id="ZLoRANet.squeeze" class="classattr">
                                <div class="attr variable">
            <span class="name">squeeze</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ZLoRANet.squeeze"></a>
    
    

                            </div>
                            <div id="ZLoRANet.kernel_init" class="classattr">
                                        <input id="ZLoRANet.kernel_init-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">kernel_init</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">key</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span>,</span><span class="param">	<span class="n">shape</span><span class="p">:</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]]</span>,</span><span class="param">	dtype: Any = &lt;class &#x27;jax.numpy.float64&#x27;&gt;</span><span class="return-annotation">) -> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span>:</span></span>

                <label class="view-source-button" for="ZLoRANet.kernel_init-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ZLoRANet.kernel_init"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ZLoRANet.kernel_init-317"><a href="#ZLoRANet.kernel_init-317"><span class="linenos">317</span></a>  <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">KeyArray</span><span class="p">,</span>
</span><span id="ZLoRANet.kernel_init-318"><a href="#ZLoRANet.kernel_init-318"><span class="linenos">318</span></a>           <span class="n">shape</span><span class="p">:</span> <span class="n">core</span><span class="o">.</span><span class="n">Shape</span><span class="p">,</span>
</span><span id="ZLoRANet.kernel_init-319"><a href="#ZLoRANet.kernel_init-319"><span class="linenos">319</span></a>           <span class="n">dtype</span><span class="p">:</span> <span class="n">DTypeLikeInexact</span> <span class="o">=</span> <span class="n">dtype</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="p">:</span>
</span><span id="ZLoRANet.kernel_init-320"><a href="#ZLoRANet.kernel_init-320"><span class="linenos">320</span></a>    <span class="n">dtype</span> <span class="o">=</span> <span class="n">dtypes</span><span class="o">.</span><span class="n">canonicalize_dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="ZLoRANet.kernel_init-321"><a href="#ZLoRANet.kernel_init-321"><span class="linenos">321</span></a>    <span class="n">named_shape</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">as_named_shape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
</span><span id="ZLoRANet.kernel_init-322"><a href="#ZLoRANet.kernel_init-322"><span class="linenos">322</span></a>    <span class="n">fan_in</span><span class="p">,</span> <span class="n">fan_out</span> <span class="o">=</span> <span class="n">_compute_fans</span><span class="p">(</span><span class="n">named_shape</span><span class="p">,</span> <span class="n">in_axis</span><span class="p">,</span> <span class="n">out_axis</span><span class="p">,</span> <span class="n">batch_axis</span><span class="p">)</span>
</span><span id="ZLoRANet.kernel_init-323"><a href="#ZLoRANet.kernel_init-323"><span class="linenos">323</span></a>    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;fan_in&quot;</span><span class="p">:</span> <span class="n">denominator</span> <span class="o">=</span> <span class="n">fan_in</span>
</span><span id="ZLoRANet.kernel_init-324"><a href="#ZLoRANet.kernel_init-324"><span class="linenos">324</span></a>    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;fan_out&quot;</span><span class="p">:</span> <span class="n">denominator</span> <span class="o">=</span> <span class="n">fan_out</span>
</span><span id="ZLoRANet.kernel_init-325"><a href="#ZLoRANet.kernel_init-325"><span class="linenos">325</span></a>    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;fan_avg&quot;</span><span class="p">:</span> <span class="n">denominator</span> <span class="o">=</span> <span class="p">(</span><span class="n">fan_in</span> <span class="o">+</span> <span class="n">fan_out</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="ZLoRANet.kernel_init-326"><a href="#ZLoRANet.kernel_init-326"><span class="linenos">326</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="ZLoRANet.kernel_init-327"><a href="#ZLoRANet.kernel_init-327"><span class="linenos">327</span></a>      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="ZLoRANet.kernel_init-328"><a href="#ZLoRANet.kernel_init-328"><span class="linenos">328</span></a>        <span class="sa">f</span><span class="s2">&quot;invalid mode for variance scaling initializer: </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ZLoRANet.kernel_init-329"><a href="#ZLoRANet.kernel_init-329"><span class="linenos">329</span></a>    <span class="n">variance</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">scale</span> <span class="o">/</span> <span class="n">denominator</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="ZLoRANet.kernel_init-330"><a href="#ZLoRANet.kernel_init-330"><span class="linenos">330</span></a>
</span><span id="ZLoRANet.kernel_init-331"><a href="#ZLoRANet.kernel_init-331"><span class="linenos">331</span></a>    <span class="k">if</span> <span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;truncated_normal&quot;</span><span class="p">:</span>
</span><span id="ZLoRANet.kernel_init-332"><a href="#ZLoRANet.kernel_init-332"><span class="linenos">332</span></a>      <span class="k">if</span> <span class="n">jnp</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">floating</span><span class="p">):</span>
</span><span id="ZLoRANet.kernel_init-333"><a href="#ZLoRANet.kernel_init-333"><span class="linenos">333</span></a>        <span class="c1"># constant is stddev of standard normal truncated to (-2, 2)</span>
</span><span id="ZLoRANet.kernel_init-334"><a href="#ZLoRANet.kernel_init-334"><span class="linenos">334</span></a>        <span class="n">stddev</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">.87962566103423978</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
</span><span id="ZLoRANet.kernel_init-335"><a href="#ZLoRANet.kernel_init-335"><span class="linenos">335</span></a>        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">truncated_normal</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">named_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="n">stddev</span>
</span><span id="ZLoRANet.kernel_init-336"><a href="#ZLoRANet.kernel_init-336"><span class="linenos">336</span></a>      <span class="k">else</span><span class="p">:</span>
</span><span id="ZLoRANet.kernel_init-337"><a href="#ZLoRANet.kernel_init-337"><span class="linenos">337</span></a>        <span class="c1"># constant is stddev of complex standard normal truncated to 2</span>
</span><span id="ZLoRANet.kernel_init-338"><a href="#ZLoRANet.kernel_init-338"><span class="linenos">338</span></a>        <span class="n">stddev</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">.95311164380491208</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
</span><span id="ZLoRANet.kernel_init-339"><a href="#ZLoRANet.kernel_init-339"><span class="linenos">339</span></a>        <span class="k">return</span> <span class="n">_complex_truncated_normal</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">named_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="n">stddev</span>
</span><span id="ZLoRANet.kernel_init-340"><a href="#ZLoRANet.kernel_init-340"><span class="linenos">340</span></a>    <span class="k">elif</span> <span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;normal&quot;</span><span class="p">:</span>
</span><span id="ZLoRANet.kernel_init-341"><a href="#ZLoRANet.kernel_init-341"><span class="linenos">341</span></a>      <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">named_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span>
</span><span id="ZLoRANet.kernel_init-342"><a href="#ZLoRANet.kernel_init-342"><span class="linenos">342</span></a>    <span class="k">elif</span> <span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;uniform&quot;</span><span class="p">:</span>
</span><span id="ZLoRANet.kernel_init-343"><a href="#ZLoRANet.kernel_init-343"><span class="linenos">343</span></a>      <span class="k">if</span> <span class="n">jnp</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">floating</span><span class="p">):</span>
</span><span id="ZLoRANet.kernel_init-344"><a href="#ZLoRANet.kernel_init-344"><span class="linenos">344</span></a>        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">named_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">variance</span><span class="p">)</span>
</span><span id="ZLoRANet.kernel_init-345"><a href="#ZLoRANet.kernel_init-345"><span class="linenos">345</span></a>      <span class="k">else</span><span class="p">:</span>
</span><span id="ZLoRANet.kernel_init-346"><a href="#ZLoRANet.kernel_init-346"><span class="linenos">346</span></a>        <span class="k">return</span> <span class="n">_complex_uniform</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">named_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span>
</span><span id="ZLoRANet.kernel_init-347"><a href="#ZLoRANet.kernel_init-347"><span class="linenos">347</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="ZLoRANet.kernel_init-348"><a href="#ZLoRANet.kernel_init-348"><span class="linenos">348</span></a>      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;invalid distribution for variance scaling initializer: </span><span class="si">{</span><span class="n">distribution</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="ZLoRANet.FID" class="classattr">
                                <div class="attr variable">
            <span class="name">FID</span><span class="annotation">: str</span>        =
<span class="default_value">&#39;ZLORANET&#39;</span>

        
    </div>
    <a class="headerlink" href="#ZLoRANet.FID"></a>
    
    

                            </div>
                            <div id="ZLoRANet.parent" class="classattr">
                                <div class="attr variable">
            <span class="name">parent</span><span class="annotation">: Union[Type[flax.linen.module.Module], flax.core.scope.Scope, Type[flax.linen.module._Sentinel], NoneType]</span>

        
    </div>
    <a class="headerlink" href="#ZLoRANet.parent"></a>
    
            <div class="docstring"><p>Wraps parent module references in weak refs.</p>

<p>This prevents reference cycles from forming via parent links which can lead
to accidental OOMs in eager mode due to slow garbage collection as well as
spurious tracer leaks during jit compilation.</p>

<p>Note: "descriptors" are the underlying python mechanism for implementing
dynamic @property decorators.  We need to use a raw descriptor instead of the
more common decorator in order to force that the appropriate getter/setter
logic applies in subclasses even after various dataclass transforms.</p>
</div>


                            </div>
                            <div id="ZLoRANet.name" class="classattr">
                                <div class="attr variable">
            <span class="name">name</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ZLoRANet.name"></a>
    
    

                            </div>
                            <div id="ZLoRANet.scope" class="classattr">
                                <div class="attr variable">
            <span class="name">scope</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ZLoRANet.scope"></a>
    
    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>flax.linen.module.Module</dt>
                                <dd id="ZLoRANet.setup" class="function">setup</dd>
                <dd id="ZLoRANet.path" class="variable">path</dd>
                <dd id="ZLoRANet.clone" class="function">clone</dd>
                <dd id="ZLoRANet.copy" class="function">copy</dd>
                <dd id="ZLoRANet.variable" class="function">variable</dd>
                <dd id="ZLoRANet.param" class="function">param</dd>
                <dd id="ZLoRANet.has_variable" class="function">has_variable</dd>
                <dd id="ZLoRANet.is_mutable_collection" class="function">is_mutable_collection</dd>
                <dd id="ZLoRANet.has_rng" class="function">has_rng</dd>
                <dd id="ZLoRANet.make_rng" class="function">make_rng</dd>
                <dd id="ZLoRANet.is_initializing" class="function">is_initializing</dd>
                <dd id="ZLoRANet.bind" class="function">bind</dd>
                <dd id="ZLoRANet.unbind" class="function">unbind</dd>
                <dd id="ZLoRANet.apply" class="function">apply</dd>
                <dd id="ZLoRANet.init_with_output" class="function">init_with_output</dd>
                <dd id="ZLoRANet.init" class="function">init</dd>
                <dd id="ZLoRANet.lazy_init" class="function">lazy_init</dd>
                <dd id="ZLoRANet.variables" class="variable">variables</dd>
                <dd id="ZLoRANet.get_variable" class="function">get_variable</dd>
                <dd id="ZLoRANet.put_variable" class="function">put_variable</dd>
                <dd id="ZLoRANet.sow" class="function">sow</dd>
                <dd id="ZLoRANet.perturb" class="function">perturb</dd>
                <dd id="ZLoRANet.tabulate" class="function">tabulate</dd>
                <dd id="ZLoRANet.module_paths" class="function">module_paths</dd>

            </div>
                                </dl>
                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../../../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../../../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>